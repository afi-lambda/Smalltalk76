<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN">
<html>
  <head>
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
    <title>Smalltalk76/IFS-File-System.st</title>
  </head>
  <body>
    <div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">&rsquo;From Smalltalk 5.5k XM November 24 on 5 February 2037 at 11:07:24 pm.&rsquo;&#771;</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">"ILFile"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;ILFile&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: File<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sharing: ILFilePool;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows&#771;</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>An IFS file accessed through the Leaf protocol, 12/79</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Dictionary</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">entryClass </span><span style="font: 10pt serif">[⇑ILFilePage]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>File</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit </span><span style="font: 10pt serif">| i sym names ["ILFile classInit."<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ILFilePool declare: ↪NotFound as: &rsquo;207&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">names &larr; ↪(<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">1011 (BadLeafHandle)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">02000 (AnswerBit)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">0176000 (RequestBits)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">0260 (LeafType)<br>"5-bit operations for left field command block word"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">0 (Error Open Close Delete)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">6 (Read Write Reset)<br><br>"read/write modes"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">0140 (SetEof "no holes, set eof")<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">0200 (NoExtend "don&rsquo;t extend file on read or write")<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">0100 (NoHoles "for writing past end")<br><br>"open file modes"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">0163400 (WriteOld "read, write, extend, any explicit, highest")<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">0103400 (ReadOld "read, any explicit, highest")<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">0167600 (CreateNew "read, write, extend, create, any explicit, next")<br><br>"control codes for left half of pupID1 field"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">0 (Data Ack Noop)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">5 (OpenConnection "if Reset")<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">9 (DestroyConnection Dally Quit BrokenConnection)) asStream.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: names do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ sym from: names next do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">ILFilePool declare: sym as: i.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; i+1]]]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">close </span><span style="font: 10pt serif">["ignore errors if file was readonly" self close: [type = read⇒ [false] &rsquo;close&rsquo;]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">close: e </span><span style="font: 10pt serif">| p ["close file, possibly ignoring errors"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"for next open"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">type &larr; read.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"shorten header block to first 2 words: command&length,  file handle"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">p &larr; self newPage.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">p length: ¬6.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self doCommand: Close page: p error: e]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">doCommand: com page: page error: e </span><span style="font: 10pt serif">| in ecode [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">page command: com.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ true do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"make sure connection is open"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">directory open.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">error &larr; nullString.<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[in &larr; directory socket sendPacket: page packet⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">in◦11 = BrokenConnection⇒ [ecode &larr; ¬1]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"turn packet into a ILFilePage"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">in &larr; [(self entryClass new) dictionary: self; page: in].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"check if answer is of same type as request"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">((page header: 1) land: RequestBits) + AnswerBit =<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">((in header: 1) land: RequestBits)⇒ [⇑in]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">ecode &larr; in header: 2]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"no response?"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">ecode &larr; false].<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"some kind of problem"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">com = Quit⇒ ["ignore" ⇑false]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ecode ≡ false or⦂ ecode = ¬1⇒ ["make new connection" directory release]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">ecode = ¬1 or⦂ ecode = 1011⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"try again after some reinitializing"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"reopen file"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self reopen.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"init page with new handle only -- don&rsquo;t lose mode, length, etc."<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">page serialNumber: serialNumber]<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">error &larr; [ecode⇒ [e⇒ [self errorString: ecode] ecode asString]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">directory directory + &rsquo; not responding&rsquo;].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">e⇒ [self error: e "proceeding tries again"]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">endFile: page </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"make sure we can write"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self writeMode: page.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"update length. this will end file with this page"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">lastpn &larr; page pageNumber.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self Write: page]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">errorString: errorCode </span><span style="font: 10pt serif">| ef ename errorString notfound dollar cr [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[errorCode is: String⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">errorString &larr; errorCode.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">errorCode &larr; [(errorString◦1) isdigit⇒ [errorString asInteger] 0]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">errorString &larr; errorCode asString].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ename &larr; &rsquo;&lt;System&gt;Ifs.Errors&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(self name compare: ename) = 2⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"recursion" ⇑errorString + &rsquo; (cannot access Ifs.Errors !!!)&rsquo;]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">notfound &larr; errorString + &rsquo;</span><span class="tab" val="79"></span><span style="font: 10pt serif">(error code not found)&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">errorCode ≤ 0⇒ [⇑notfound]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dollar &larr; &rsquo;$&rsquo;◦1. cr &larr; 015.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ef &larr; directory oldFile: ename.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ef readonly.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">errorString &larr; false.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"scan through the errors file looking for lines of the form:<br>$$nn</span><span class="tab" val="79"></span><span style="font: 10pt serif">some message<br>"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ errorString do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">ef skipTo: dollar⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">ef next = dollar⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"valid line"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">ef integerScan<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&gt; errorCode⇒ ["since errors are ordered" errorString &larr; notfound];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">= errorCode⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">errorString &larr; (String new: 200) asStream.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">errorString print: errorCode.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ (ef peek = dollar or⦂ ef peek = cr) do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">errorString append: (ef upto: cr); space].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">errorString &larr; errorString contents]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"end of file"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">errorString &larr; notfound].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ef close.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑errorString]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">findLastPage </span><span style="font: 10pt serif">["already known from open" ⇑lastpn]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">open </span><span style="font: 10pt serif">"do nothing. lastpn set by </span><span style="font: bold 10pt serif">ILFileDirectory Find:</span><span style="font: 10pt serif">"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">Read: page </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">page pageNumber &gt; lastpn⇒ ["no page" ⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"don&rsquo;t extend beyond eof. length of page is 0, but request is for 512 bytes"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">page mode: NoExtend; header: 5 &larr; 512 "self dataLength".<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self doCommand: Read page: page error: &rsquo;Read:&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">release </span><span style="font: 10pt serif">[self close: false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">Write: page </span><span style="font: 10pt serif">| pn [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(pn &larr; page pageNumber) &gt; (lastpn+1)⇒ [self error: &rsquo;illegal page number&rsquo;]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"make sure we can write"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self writeMode: page.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">page mode: [pn ≥ lastpn⇒ [SetEof] NoHoles].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self doCommand: Write page: page error: &rsquo;Write:&rsquo;.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"file possibly extended"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pn = (lastpn+1)⇒ [lastpn &larr; pn]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑page]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">writeMode: page </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"make sure we can write on file"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">type = write⇒ []<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"turn on writing by closing and reopening file. eventually there might be<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">a simpler way to change file mode"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self close.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">type &larr; write.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">directory Find: self⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"file handle changed"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">page serialNumber: serialNumber]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self error: &rsquo;file failed to reopen&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>IFS</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">allocatePage </span><span style="font: 10pt serif">[⇑directory allocatePage]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">&#771;</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪ILFile under: &rsquo;IFS File System&rsquo;.&#771;</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">ILFile classInit&#771;</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"ILFileDirectory"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;ILFileDirectory&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: FileDirectory<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;userName userPassword isocket&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sharing: ILFilePool;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows&#771;</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>IFS directory, 12/79</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Dictionary</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">Delete: file </span><span style="font: 10pt serif">["delete a file (highest version)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">shorten header block to 2 words: command&length,  file handle"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(file newPage) length: ¬6; doCommand: Delete error: &rsquo;Delete:&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">entryClass </span><span style="font: 10pt serif">[⇑ILFile]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">Find: file </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"since there can be many readers but only one writer, default mode is for<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">read only. writing will cause file to be closed and reopened for writing"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self openFile: file mode: [file type = write⇒ [WriteOld] ReadOld]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">Insert: file </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">file type: write.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self openFile: file mode: CreateNew⇒ [⇑file]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">file error: &rsquo;Insert: cannot create&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">obsolete </span><span style="font: 10pt serif">[⇑isocket ≡ nil]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">open </span><span style="font: 10pt serif">| page [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">isocket ≡ nil "self obsolete"⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[isocket &larr; ILSocket new hostName: directory "name of IFS/Leaf server"⇒ []<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">isocket &larr; nil.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: directory + &rsquo; (name not found)&rsquo;].<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">super open.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">page &larr; self newPage.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"treat packet in page as a parameter block"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(ILParameterBlock new)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">packet &larr; page packet;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextword &larr; 0; "host number (0 = this, ¬1 = all)"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextString &larr; self userName;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextString  &larr; self userPassword.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">page doCommand: Reset error: false⇒ []<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">isocket &larr; nil.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: &rsquo;open (reset)&rsquo;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">release </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self obsolete⇒ []<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"shorten header block to 0 words.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DestroyConnection. after this the connection is gone"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(self newPage) length: ¬10; doCommand: Quit error: false.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">isocket close.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">isocket &larr; nil]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">versionNumbers </span><span style="font: 10pt serif">[⇑true]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>IFS</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">allocatePage </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[isocket≡nil⇒ [self open]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"return a packet to be used by ILFilePage"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑isocket freePacket]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">name: userName password: userPassword</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">noAck </span><span style="font: 10pt serif">["an optimization for intense ether activity" isocket noAck]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">openFile: file mode: m </span><span style="font: 10pt serif">| page [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"open bit modes<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">read<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">write<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">extend<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">multiple (0)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">create name<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">explicit version in name (2b)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">no, old, next or old, any<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">default (if no version specified) (2b)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">no, lowest, highest, next<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">unused (7b)"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self open.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">page &larr; file newPage.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"treat packet in page as a parameter block"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(ILParameterBlock new)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">packet &larr; page packet;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextword &larr; 0; "file handle"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextword &larr; m; "modes"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextString &larr; self userName;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextString  &larr; self userPassword;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextString &larr; &rsquo;&rsquo;; "connect name"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextString &larr; &rsquo;&rsquo;; "connect password"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextString &larr; self checkName: file name.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"answer bits (in page header: 5)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">same (5b)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">version (4b)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">bad, default lowest, default highest, default next, !*, !L, !H, !N, explicit old, explicit lowest, explicit highest, explicit next, explicit new, explicit-less, explicit between, explicit greater"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">page &larr; file doCommand: Open page: page error: false⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">file serialNumber: page serialNumber.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"open returns file length"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">file lastPage: (page pageNumber - [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">((page header: 4) land: 0777) =0⇒ ["full last page" 1] 0] max: 1)]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">file error = NotFound⇒ [⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑file error: &rsquo;open &rsquo; + (file errorString: file error)<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">socket </span><span style="font: 10pt serif">[⇑isocket]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">userName </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">userName ≡ nil or⦂ userName empty⇒ [⇑super userName]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑userName]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">userPassword </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">userPassword ≡ nil or⦂ userPassword empty⇒ [⇑super userPassword]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑userPassword]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">&#771;</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪ILFileDirectory under: &rsquo;IFS File System&rsquo;.&#771;</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"ILFilePage"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;ILFilePage&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: EtherFilePage<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sharing: ILFilePool;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows&#771;</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>12/79, SAW.<br>Format of header is generally (for read/write)<br>1 operation (5 bits opcode, 1 bits request/answer, 10 bits inclusive byte length of block<br>2 file handle<br>3&4 byte address (mode in high 5 bits)<br>5 byte length</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>FilePage</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">headerLength </span><span style="font: 10pt serif">[⇑34 "4+20+10"]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">length </span><span style="font: 10pt serif">["valid for read or write" ⇑self header: 5]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">length: len </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"10 bytes in a normal header block. ILParameterBlock can change things.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">also negative lengths can shorten it and change pupLength"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"length of command block, including data"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self header: 1 &larr; 10 + len.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"number of data bytes to read/write"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self header: 5 &larr; len.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"set pupLength"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">super length: len]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pageNumber </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"extract page number from 27-bit byte address. ignore high 5 mode bits.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dividing byte adress (which may be a LargeInteger) by self dataLength (512)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">is the correct but slow way to do this. byte address 0 = page 1"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑(((self header: 3) land: 03777) * 0200 "lshift: 7, maybe large") +<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">((self header: 4) lshift: ¬9) + 1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pageNumber: pn </span><span style="font: 10pt serif">["inverse of </span><span style="font: bold 10pt serif">pageNumber</span><span style="font: 10pt serif">. set 5 mode bits to 0"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pn &larr; pn-1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self header: 3 &larr; pn / 0200 "lshift: ¬7, except for large pn".<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self header: 4 &larr; pn lshift: 9]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">serialNumber </span><span style="font: 10pt serif">| sn [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sn &larr; String new: 4.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sn◦1 &larr; sn◦2 &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sn word: 2 &larr; self header: 2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑sn]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">serialNumber: sn </span><span style="font: 10pt serif">[self header: 2 &larr; sn word: 2]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>IFS</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">command: com </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"operation word (header 1)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">0-4<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">opcode<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">5<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">0 request<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">1 answer<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">6-15<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">inclusive byte length of operation block"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">page pupType &larr; LeafType.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"make operation a request, preserve length set earlier"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">page◦25 &larr; (page◦25 land: 3) + (com lshift: 3).<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"left half pupID1"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">page◦11 &larr; [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">com = Reset⇒ [OpenConnection]; = Quit⇒ [DestroyConnection] Data]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">mode: m </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">current meaning of 5 read/write bits (from high to low):<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">0-1<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">0 read or write anywhere<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">1 no holes (read or write) zeros past end<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">2 don&rsquo;t extend on read or write<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">3 check extend (Error)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">2<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">1 set eof<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">3-4<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">0 undefined</span><span style="font: 10pt serif">"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"m is a byte which is already shifted"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">page◦29 &larr; (page◦29 land: 7) + m]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">&#771;</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪ILFilePage under: &rsquo;IFS File System&rsquo;.&#771;</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"ILParameterBlock"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;ILParameterBlock&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;packet position&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sharing: ILFilePool;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows&#771;</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>for passing parameters to IFS. primarily used by ILFileDirectory open & openFile:</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">packet &larr; packet </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"default is an empty (data) packet, except first header word"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self position: 26]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Changing values</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">nextString &larr; s </span><span style="font: 10pt serif">| strm [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm &larr; packet pupString asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm skip: position; nextword &larr; s length; append: s; padNext &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self position: strm position]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">nextword &larr; w </span><span style="font: 10pt serif">| strm [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm &larr; packet pupString asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm skip: position; nextword &larr; w.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self position: strm position]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">position: position </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"changing length of data in packet"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">packet pupLength &larr; position - 2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"set inclusive byte length in first command word; rest set later"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">packet word: 13 &larr; position - 24]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">&#771;</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪ILParameterBlock under: &rsquo;IFS File System&rsquo;.&#771;</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"ILSocket"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;ILSocket&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: RetransmitSocket<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;seqNum outPac result abortTransfer outAck&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sharing: ILFilePool;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows&#771;</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>for communicating with a Leaf socket on an IFS server, 12/79</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Socket</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">net: n host: h </span><span style="font: 10pt serif">["usually called by </span><span style="font: bold 10pt serif">hostName:</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">seqNum &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">super net: n host: h soc: 043 asInt32.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self retransmit: 8 every: [n = NETNUM⇒ ["same net" 400] 1800].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self setAck]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">noAck </span><span style="font: 10pt serif">["if acknowledgements are not needed" outAck &larr; false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sendPacket: outPac </span><span style="font: 10pt serif">| nseq [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"send a packet, wait for result, and acknowledge.<br></span><span class="tab" val="79"></span><span style="font: bold 10pt serif">RetransmitSocket setAddressesAndComplete:</span><span style="font: 10pt serif"> sets timer<br></span><span class="tab" val="79"></span><span style="font: bold 10pt serif">ILSocket socProcess:</span><span style="font: 10pt serif"> receives answers<br></span><span class="tab" val="79"></span><span style="font: bold 10pt serif">ILSocket timerFired</span><span style="font: 10pt serif"> handles retransmissions"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">result &larr; abortTransfer &larr; false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"alloc, receiver seq"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outPac pupID0 &larr; <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"command, send seq"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outPac◦12 &larr; "pupID1 &larr; (outPac pupID1 land: 0177400) +" seqNum.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self setAddressesAndComplete: outPac.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"while waiting for packet to arrive, set up ack"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nseq &larr; (seqNum +1) \ 256.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[outPac◦11 = DestroyConnection⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"assume reply will be Dally. send Quit to shut down connection a little faster"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[outAck⇒ []<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"create ack"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self setAck.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">outAck pupID0 &larr; outAck◦12 &larr; seqNum].<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">outAck◦11 &larr; Quit.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">retransMax &larr; 0.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"same sequence numbers as previous"]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outAck⇒ ["acknowledgement for Open & Data"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">outAck pupID0 &larr; outAck◦12 &larr; nseq]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"in rapid interchanges, the next request is an implicit ack, so it&rsquo;s faster not to send one. however, packets unacknowledged for ~5 secs. at the server end can cause degraded performance"].<br> <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"now wait for </span><span style="font: bold 10pt serif">socProcess:</span><span style="font: 10pt serif"> to set result, or </span><span style="font: bold 10pt serif">timerFired</span><span style="font: 10pt serif"> to set abortTransfer"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ (result or⦂ abortTransfer) do⦂ [].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[result⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">seqNum &larr; nseq.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">outAck⇒ ["send ack" self completePup: outAck]]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑result]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">setAck </span><span style="font: 10pt serif">["create acknowledgement packet"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outAck &larr; self freePacket.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outAck pupType &larr; LeafType.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outAck dataString &larr; &rsquo;&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"control code"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outAck◦11 &larr; Ack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self setAddresses: outAck]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">socProcess: Ipac </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt s
