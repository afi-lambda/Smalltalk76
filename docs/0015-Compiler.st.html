<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN">
<html>
  <head>
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
    <title>Smalltalk76/Compiler.st</title>
  </head>
  <body>
    <div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">&rsquo;From Smalltalk 5.5k XM November 24 on 5 February 2037 at 11:15:28 pm.&rsquo;<br></span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">"Decompiler"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;Decompiler&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;method temps instvars literals stack isReference literalNames&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;breakPC highlight &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sharing: ByteCodes;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>This class has not yet been commented</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">decompile: sel class: class </span><span style="font: 10pt serif">| strm block ignore p<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[method &larr; class method: sel.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">method length&lt;8⇒[⇑self quickCode: sel class: class]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self initSymbols: class.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">stack &larr; (Vector new: (method◦3)-(method◦5)) asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">block &larr; self block: method◦6+1 to: method length<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pc⦂ ignore hasValue⦂ ignore.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">stack empty≡false⇒[user notify: &rsquo;stack not empty&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self convertMacros: block sel: sel.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm &larr; Stream default.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self printPattern: sel on: strm.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm crtab: 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">block printon: strm indent: 1 precedence: 0 forValue: false decompiler: self.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(p&larr;method word: 1)≠0⇒[strm append: &rsquo; primitive: &rsquo;; print: p]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑strm contents asParagraph makeBoldPattern]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">findPC: x </span><span style="font: 10pt serif">[breakPC&larr; x. highlight&larr; 1 to: 1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">highlight </span><span style="font: 10pt serif">[⇑highlight]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">highlight: x </span><span style="font: 10pt serif">[⇑highlight&larr; x]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Symbols</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">initSymbols: class </span><span style="font: 10pt serif">| i lit env<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">Init temps with made-up names</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">temps &larr; Vector new: method◦5.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: temps length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[temps◦i &larr; &rsquo;t&rsquo; + i asString].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">instvars &larr; class instvars.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">literals &larr; MessageDict new literalsIn: method.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">literalNames &larr; Vector new: literals length.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">env &larr; class wholeEnvironment, Smalltalk, Undeclared.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: literals length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[lit &larr; literals◦i.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">literalNames◦i &larr;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[lit is: UniqueString⇒[lit]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">lit is: ObjectReference⇒[self invertRef: lit environment: env]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">lit≡FieldReference⇒[&rsquo;&rsquo;]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">lit asString]]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">instvar: i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑instvars◦(i-codeLoadField+1)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">invertRef: ref environment: env </span><span style="font: 10pt serif">| table n<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ table from: env do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[n&larr;table invertRef: ref⇒[⇑n]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑&rsquo;unknown&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">literal: i </span><span style="font: 10pt serif">| index lit str<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[index &larr; i-codeLoadLit+1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">lit &larr; literals◦index.  str &larr; literalNames◦index.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">lit is: ObjectReference⇒[⇑str]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(lit is: UniqueString) or⦂ (lit is: Vector)⇒[⇑&rsquo;↪&rsquo; + str]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑str]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">literalIndirect: i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑literalNames◦(i-codeLoadLitInd+1)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">selector: i <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[i&gt;166 and⦂ i&lt;208⇒[⇑SpecialOops◦(i-166)]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑literalNames◦(i-codeSendLit+1)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">temp: i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑temps◦(i-codeLoadTemp+1)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Byte Interpretation</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">block: start to: end pc⦂ pc hasValue⦂ v<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| block code byte j stackPos t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["Decompile the method from start to end into a ParsedBlock and return the<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">instance of ParsedBlock.  Assign to pc the value of the pc after leaving<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">the block.  If at run time this block will leave a value on the stack,<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">set hasValue to true."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">block &larr; ParsedBlock default. pc value&larr; end+1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">stackPos &larr; stack position.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">code &larr; Stream new of: method from: start to: end.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ byte from: code do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[byte&lt;0200⇒[self loadByte: byte code: code]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">byte&lt;0210⇒[self controlByte: byte code: code block: block]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">byte&lt;0214⇒[self loadByte: byte code: code  "extended loads"]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">byte=0214⇒[self selectorByte: byte code: code at: code position  "extended selector"]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">byte&lt;0260⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[j&larr;self jumpByte: byte code: code block: block.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">code end⇒[pc value&larr;j]]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self selectorByte: byte code: code at: code position]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"If there is an additional item on the stack, it will be the value<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">of this block"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">stack position&gt;stackPos⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t&larr;stack pop.  v value&larr;true.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">block empty and⦂ (t is: ParsedBlock)⇒[⇑t]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">block next&larr; t.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑block]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">v value&larr;false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[block empty⇒[block next&larr; nil]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"pretend that returns jump to end of method"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[block returns or⦂ (block◦block position) returns⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pc value&larr; method length+1]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑block]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">checkForRemoteCode: jump code: code block: block </span><span style="font: 10pt serif">| m ignore t j b<br>"</span><span style="font: italic 10pt serif">Check if this is a jump around remote code.</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[jump&gt;code limit⇒[⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">remote code should terminate with a </span><span style="font: italic 10pt serif; text-decoration: underline">toEnd</span><span style="font: italic 10pt serif">, and then a jump back</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">method◦(jump-3)≠toEnd⇒[⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">t &larr; method◦(jump-2).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">t&lt;0240 or⦂ t&gt;0243⇒[⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">j &larr; t-0244*256+(method◦(jump-1)).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">jump+j ≠ (code position+1) ⇒[⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">m &larr; stack pop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">((m isnt: ParsedMessage) or⦂ m rcvr≡toLoadThisCtxt≡false) or⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(self selector: m op)≠↪remoteCopy⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[stack next&larr; m.  ⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">it&rsquo;s a piece of remote code</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">b &larr; self block: code position+1 to: jump-4<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pc⦂ ignore hasValue⦂ ignore.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">stack next&larr; ParsedRemote new expr: b.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">code position&larr; jump-1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">conditionalJump: elseStart code: code block: block<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| cond ifExpr thenExpr elseExpr thenJump elseJump ignore newBlock<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">hasValue last<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ifExpr &larr; stack pop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">thenExpr &larr; self block: code position+1 to: elseStart-1<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pc⦂ thenJump hasValue⦂ hasValue.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">ensure jump is within block (in case thenExpr returns)</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">thenJump &larr; thenJump min: code limit+1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">if jump goes back, then it&rsquo;s a loop</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">thenJump&lt;elseStart⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self loop: thenJump whileExpr: ifExpr doExpr: thenExpr<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">code: code block: block doSize: elseStart-code position-1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">code position&larr; elseStart-1]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">elseExpr &larr; self block: elseStart to: thenJump-1<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pc⦂ elseJump hasValue⦂ ignore.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">if </span><span style="font: italic 10pt serif; text-decoration: underline">elseJump</span><span style="font: italic 10pt serif"> is backwards, it is not part of the elseExpr</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[elseJump&lt;code position⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[code position&larr; thenJump-3.  last&larr;true] <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">code position&larr; thenJump-1].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[thenJump+1=code limit  "</span><span style="font: italic 10pt serif">still might be last</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">and⦂ (method◦thenJump≥0240 and⦂ method◦thenJump≤0247)⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[last&larr;true]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[thenJump=code limit<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">and⦂ (method◦thenJump≥0220 and⦂ method◦thenJump≤0227)⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[last&larr;true]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">check for and⦂ or or⦂</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">hasValue and⦂ (thenExpr position=1 and⦂ thenExpr◦1≡toLoadTrue)⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[stack next&larr; ParsedDisjunct new left: ifExpr right:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[elseExpr position=1⇒[elseExpr◦1] elseExpr] ]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">hasValue and⦂ (elseExpr position=1 and⦂ elseExpr◦1≡toLoadFalse)⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[stack next&larr; ParsedConjunct new left: ifExpr right:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[thenExpr position=1⇒[thenExpr◦1] thenExpr] ]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">it&rsquo;s an if statement</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">cond &larr; ParsedConditional new<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">ifExpr: ifExpr thenExpr: thenExpr elseExpr: elseExpr.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">If the then part has a value, put the conditional in a block, and put the<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">block on the stack.  (If the compiler is working right the else part will<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">leave a value, too ... this is not checked).</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">hasValue⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[newBlock&larr;ParsedBlock default.  newBlock next&larr; cond.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">stack next&larr; newBlock]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">If the thenExpr jumps to the end of the current block,<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">or to a jump backwards at the end of the current block,<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">or to a ⇑self at the end of the method,<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">append the cond<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">to the current block.  Otherwise, embed it in a new block.</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(code end or⦂ last≡true) or⦂<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(thenJump+1=method length and⦂ method◦thenJump=toLoadSelf)⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[block next&larr; cond]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">newBlock&larr;ParsedBlock default.  newBlock next&larr; cond.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">block next&larr; newBlock]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">controlByte: byte code: code block: block </span><span style="font: 10pt serif">| var t strm<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[byte=toSmashPop⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[var &larr; self makeLoad: code next code: code.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">block next&larr; ParsedAssignment new var: var expr: stack pop]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">byte=toSmash⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">smash no pop at the end of a block will require the next byte<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">to be fetched from after the limit of the block</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">code end⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strm &larr; Stream new of: method from: code limit+1 to: method length.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">var &larr; self makeLoad: strm next code: strm.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">block next&larr; ParsedAssignment new var: var expr: stack pop]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">var &larr; self makeLoad: code next code: code.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">block next&larr; ParsedAssignment new var: var expr: stack pop.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">uncascade assignment statements</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">stack next&larr; var]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">byte=toPop⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[block next&larr; stack pop]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">byte=toReturn⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t &larr; stack pop.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">stack empty≡false⇒[user notify: &rsquo;stack not empty&rsquo;]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">elide final ⇑self</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">t≡toLoadSelf and⦂ code position=method length⇒[]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">block doesReturn.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">block next&larr; t]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">byte=toEnd⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user notify: &rsquo;unexpected&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">byte=toLoadThisCtxt⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[stack next&larr; byte]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">byte=toSuper⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[stack pop.  "</span><span style="font: italic 10pt serif">delete ref to self</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">stack next&larr; byte]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: &rsquo;unknown control byte&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">jumpByte: byte code: code block: block </span><span style="font: 10pt serif">| offset j<br>"</span><span style="font: italic 10pt serif">If this is an unconditional jump, return the position in the method to which it jumps.  If this is a conditional jump forward, parse a conditional statement.  Conditional jumps backward are not produced by the current compiler.</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[byte&lt;0230⇒["</span><span style="font: italic 10pt serif">short unconditional jump forward</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑byte-0220+code position+2]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">byte&lt;0240⇒["</span><span style="font: italic 10pt serif">short conditional jump forward</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self conditionalJump: byte-0230+code position+2 code: code block: block.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑code position+1]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">byte&lt;0250⇒["</span><span style="font: italic 10pt serif">long unconditional jump</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">offset &larr;  code next.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">j &larr; byte-0244*256+offset+code position+1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self checkForRemoteCode: j code: code block: block.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑j]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">byte&lt;0254⇒[code skip: 1.  "long conditional jump backward"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: &rsquo;conditional jump backward not expected&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">byte&lt;0260⇒["</span><span style="font: italic 10pt serif">long conditional jump forward</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">offset &larr; code next.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self conditionalJump: byte-0254*256+offset+code position+1<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">code: code block: block.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑code position+1]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: &rsquo;not a jump byte&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">loadByte: byte code: code </span><span style="font: 10pt serif">| t lit<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t &larr; self makeLoad: byte code: code.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">t≥codeLoadLit and⦂ t&lt;codeLoadLitInd⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[lit &larr; literals◦(t-codeLoadLit+1).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">lit≡FieldReference⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self remoteReference: code]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">lit is: ObjectReference⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[stack next&larr; ParsedObjectReference new var: t]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">stack next&larr; t]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">stack next&larr; t]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">loop: jumpBack whileExpr: whileExpr doExpr: doExpr code: code block: block<br>doSize: doSize<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| n b ignore<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">jumpBack will jump to the beginning of whileExpr.  In the case of for statements or while&rsquo;s with a block in the condition, the whileExpr should include more than just the last expression.  Kludge: find all the statements needed by re-decompiling.</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">n &larr; code position-doSize jmpSize.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">b &larr; self block: jumpBack to: n pc⦂ ignore hasValue⦂ ignore.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">discard unwanted statements from block</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">block skip: 1-b position.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">block next&larr; ParsedLoop new <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">whileExpr: [b position=1⇒[whileExpr] b] doExpr: doExpr]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">makeLoad: byte code: code </span><span style="font: 10pt serif">| offset<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">check for extended loads</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">byte≥0210 and⦂ byte≤0213⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">extended reference codes:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">0210 - extended inst<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">0211 - extended temp<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">0212 - extended literal<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">0213 - extended literal indirect"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">offset&larr;256*(byte-0207).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑code next+offset]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ⇑byte asCompilerCode]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">remoteReference: code </span><span style="font: 10pt serif">| i obj offset var<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[i &larr; stack pop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">offset &larr; [i≤124⇒[↪(0 1 2 10)◦(i-120)] literals◦(i-codeLoadLit+1)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">obj &larr; stack pop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">code skip: 2.  "</span><span style="font: italic 10pt serif">skip </span><span style="font: italic 10pt serif; text-decoration: underline">new</span><span style="font: italic 10pt serif"> </span><span style="font: italic 10pt serif; text-decoration: underline">object:offset:</span><span style="font: italic 10pt serif"> </span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">var &larr; [obj=toLoadTempframe⇒[codeLoadTemp+offset-1]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">obj=toLoadSelf⇒[codeLoadField+offset-1]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: &rsquo;bad remote reference&rsquo;].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">stack next&larr; ParsedFieldReference new var: var]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">selectorByte: byte code: code at: p </span><span style="font: 10pt serif">| op sel i nArgs args rcvr<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["check for extended selector codes"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">op &larr; [byte=toSendLitLong⇒[code next+codeSendLit] byte asCompilerCode].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"find the corresponding selector and the number of args it expects"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sel &larr; self selector: op.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nArgs &larr; sel numArgs.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rcvr &larr; stack pop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[nArgs=0⇒[args&larr;false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> nArgs=1⇒[args&larr;stack pop]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> args &larr; Vector new: nArgs.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> for⦂ i from: nArgs to: 1 by: ¬1 do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[args◦i &larr; stack pop]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">stack next&larr; ParsedMessage new rcvr: rcvr op: op args: args.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">p=breakPC⇒[stack last hasPC]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Macros</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">convertMacros: block sel: sel </span><span style="font: 10pt serif">| macros compilerTemps vec loc i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">replace statement patterns with corresponding macros when possible</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">macros &larr; (Vector new: 10) asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">for each temp, compilerTemps is false if it is a user temp, true if it is a<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">compiler temp, and nil if not yet known</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">compilerTemps &larr; Vector new: temps length.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: sel numArgs do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[compilerTemps◦i &larr; false].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">block findMacros: macros compilerTemps: compilerTemps.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">insert macros in reverse order to keep indices from being messed up</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">vec &larr; macros contents.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: vec length-1 to: 1 by: ¬2 do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[vec◦i≡nil⇒[]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">vec◦i insertMacro: vec◦(i+1) decompiler: self].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">set names of compiler temps to empty string</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: temps length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[compilerTemps◦i≡true⇒[temps◦i &larr; &rsquo;&rsquo;]]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Printing</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printPattern: sel on: strm </span><span style="font: 10pt serif">| i n keywords<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[n&larr;sel numArgs.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[n=0⇒[strm append: sel; space  "</span><span style="font: italic 10pt serif">unary</span><span style="font: 10pt serif">"]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> keywords&larr;sel keywords.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> for⦂ i to: keywords length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strm append: keywords◦i; space; append: temps◦i; space]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">n=(method◦5)⇒[]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm append: &rsquo;| &rsquo;.   "</span><span style="font: italic 10pt serif">temps beyond args</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: n+1 to: method◦5 do⦂ [strm append: temps◦i; space]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">quickCode: sel class: class </span><span style="font: 10pt serif">| t strm<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[method length=2⇒[⇑sel asParagraph makeBoldPattern]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">method length=5⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t &larr; method◦5.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm &larr; Stream default.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm append: sel; append: &rsquo; [⇑&rsquo;; append: class instvars◦(t+1); append: &rsquo;]&rsquo;.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑strm contents asParagraph makeBoldPattern]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑&rsquo;undeciperable method&rsquo; asParagraph]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪Decompiler under: &rsquo;Compiler&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"Generator"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;Generator&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;literals nTemps maxTemp local environment parser supered root requestor sourceStream sourceParagraph&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sharing: ByteCodes;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I generate code parsed by parser.  The symbol tables I use are local and environment.  The run-time needs of the code are recorded in literals, nTemps, and maxTemp.  If a message was passed to super, then supered is true.  I remember my root context to abort in case of error.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Services</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">compile: sourceParagraph in: class under: category notifying: requestor </span><span style="font: 10pt serif">| selector<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user displayoffwhile⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[sourceStream &larr; sourceParagraph asStream.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">selector &larr; self compileIn: class⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[class organization classify: selector under: category]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑selector]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">evaluate: sourceStream in: context to: receiver notifying: requestor<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| method nvars value tframe<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[method &larr; user displayoffwhile⦂ [self evaluateIn: context to: receiver].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">root≡true≡false⇒ [⇑method] </span><span style="font: italic 10pt serif">"compilation failed, return false or corrected value"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nvars &larr; nTemps.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">context⇒ </span><span style="font: italic 10pt serif">"frame copy here because interpret loses control"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[tframe &larr; context tempframe◦(1 to: nvars) copyto: (Vector new: method◦3).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">value &larr; context interpret: method with: tframe.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">tframe◦(1 to: nvars) copyto: context tempframe.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑value]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑Context new have: receiver interpret: method]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Errors</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">abortWith: errorString </span><span style="font: 10pt serif">| mySender<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[WhatFlag⇒ [user notify: errorString]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">mySender &larr; thisContext swapSender: root sender.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">root sender &larr; nil. root &larr; nil. parser terminate.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">mySender release. mySender &larr; nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user restoredisplay.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑requestor notify: errorString at: sourceStream position in: sourceStream]<br></span><span style="font: italic 10pt serif">"Parser notify"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">notify: errorString<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[parser notify: errorString]<br></span><span style="font: italic 10pt serif">"ParsedObjectReference remote"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">terminate<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[root &larr; nil]<br></span><span style="font: italic 10pt serif">"Parser terminate"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Code generation</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">compileIn: class<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| block method nargs selector primitive<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[parser &larr; Parser new. root &larr; thisContext. parser from: sourceStream to: self.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self initSymbols: class.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">block &larr; ParsedBlock default.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">selector &larr; parser pattern: block. nargs &larr; nTemps.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">parser temporaries: block. primitive &larr; parser body: block.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">parser mustBeDone. parser &larr; nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">block mustReturn: true </span><span style="font: italic 10pt serif">"defaults to ⇑self"</span><span style="font: 10pt serif">.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[method &larr; [primitive=0 and⦂ nargs=0⇒ [block quickCode] false]⇒ []<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">method &larr; self generate: block in: class.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">method◦2 &larr; primitive; ◦4 &larr; nargs].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">class install: selector method: method literals: literals<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">code: [sourceParagraph is: Paragraph⇒ [sourceParagraph]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">sourceStream asArray] backpointers: nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[HuhFlag⇒ [Huh&larr;nil. Huh &larr; (self decompile: method onto: Stream default) contents. HuhFlag&larr;false]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑selector]<br></span><span style="font: italic 10pt serif">"compile"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">decompile: method onto: s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[method length&lt;6⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s append: &rsquo;Quick code: &rsquo;; append: method asBytes. ⇑s]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s print: method◦4; append: &rsquo; args; &rsquo;;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">print: method◦5; append: &rsquo; temps; &rsquo;;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">print: (method◦3) - (method◦5); append: &rsquo; stack; &rsquo;;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">print: (method◦6) -6 /2; append: &rsquo; literals; &rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(method◦2) &gt; 0⇒ [s append: &rsquo; primitive: &rsquo;; print: method◦2; append: &rsquo;;&rsquo;]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s print: method length; append: &rsquo; bytes total.&rsquo;; cr.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">method◦2 = 40⇒ [⇑s]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self decompileBytes: method onto: s]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">decompileBytes: method onto: s<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| dict x i c m t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[dict &larr; Dictionary new init: 64.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dict insertall: ((128 to: 131) copy, 125 concat: (144 to: 175) copy)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">with: ↪(<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;&larr;&uarr;&rsquo; &rsquo;&larr;&rsquo; &rsquo;&uarr;&rsquo; &rsquo;⇑&rsquo; &rsquo;end&rsquo;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;jmp1&rsquo; &rsquo;jmp2&rsquo; &rsquo;jmp3 &rsquo; &rsquo;jmp4&rsquo; &rsquo;jmp5&rsquo; &rsquo;jmp6&rsquo; &rsquo;jmp7&rsquo; &rsquo;jmp8&rsquo;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;bfp1&rsquo; &rsquo;bfp2&rsquo; &rsquo;bfp3 &rsquo; &rsquo;bfp4&rsquo; &rsquo;bfp5&rsquo; &rsquo;bfp6&rsquo; &rsquo;bfp7&rsquo; &rsquo;bfp8&rsquo;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;jmp&rsquo; &rsquo;jmp&rsquo; &rsquo;jmp&rsquo; &rsquo;jmp&rsquo; &rsquo;jmp&rsquo; &rsquo;jmp&rsquo; &rsquo;jmp&rsquo; &rsquo;jmp&rsquo;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;bfp&rsquo; &rsquo;bfp&rsquo; &rsquo;bfp&rsquo; &rsquo;bfp&rsquo; &rsquo;bfp&rsquo; &rsquo;bfp&rsquo; &rsquo;bfp&rsquo; &rsquo;bfp&rsquo;).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ x from: local contents do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[i&larr;local◦x. t &larr; i land: 255.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[i&gt;255 and⦂ t&lt;16⇒ [i&larr;((i lshift: ¬8)-1 lshift: 4) + t]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">dict insert: i with: x].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ x from: stdSelectors contents do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[dict insert: stdSelectors◦x with: [x is: Integer⇒ [x inString] x]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: 5 do⦂ [dict insert: toLoadConst+i-1 with: ↪(&rsquo;¬1&rsquo; &rsquo;0&rsquo; &rsquo;1&rsquo; &rsquo;2&rsquo; &rsquo;10&rsquo;)◦i].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ t from: (m &larr; (method◦(method◦6 +1 to: method length)) asStream) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[t≥toLoadFieldLong and⦂ t≤toSendLitLong⇒ [t&larr;((t-0207) lshift: 8)+ m next]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> [c &larr; dict lookup: t⇒ [s append: c] s append: &rsquo;#&rsquo;. s append: t base8].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> s space.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> t &lt; toLongJmp⇒ [] t ≥ 0260⇒ []<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> s print: t\8 -4 *256 + m next; space].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s cr.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑s]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">evaluateIn: context to: receiver<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| block method class nvars<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ </span><span style="font: italic 10pt serif">"If context is false, receiver will evaluate in top level"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">block &larr; ParsedBlock default.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">parser &larr; Parser new. root &larr; thisContext.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">parser from: sourceStream to: self.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[context⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self initSymbols: (class &larr; context mclass).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">context variableNamesInto: self with: ParsedBlock default.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nvars &larr; nTemps.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">root &larr; thisContext. </span><span style="font: italic 10pt serif">"because variableNamesInto nil&rsquo;ed it"</span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self initSymbols: (class &larr; receiver class)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">parser temporaries: block; statements: block; mustBeDone. parser &larr; nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">block mustReturn: false </span><span style="font: italic 10pt serif">"returns last value"</span><span style="font: 10pt serif">.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">method &larr; self generate: block in: class.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[HuhFlag⇒ [Huh&larr;nil. Huh &larr; (self decompile: method onto: Stream default) contents. HuhFlag&larr;false]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">root &larr; true. </span><span style="font: italic 10pt serif">"to signify success"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nTemps &larr; nvars.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑method]<br></span><span style="font: italic 10pt serif">"evaluate"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">generate: block in: class<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| header method code lit stack<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[(lit &larr; literals find: nil)&gt;0⇒ [literals &larr; (literals◦(1 to: lit-1)) copy]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[supered⇒ [literals &larr; literals, (Smalltalk ref: class title unique)]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">header &larr; 6 + (2* literals length).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">code &larr; (method &larr; String new: header + block sizeForValue) asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">code<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">next &larr; 0; next &larr; 0; next &larr; 0;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">next &larr; 0; next &larr; maxTemp; next &larr; header.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ lit from: literals do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[code next &larr; lit PTR lshift: ¬8; next &larr; lit PTR land: 0377].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">stack &larr; ParseStack init.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">block emitForValue: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[stack position≠1⇒ [user notify: &rsquo;Compiler stack discrepancy&rsquo;]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[code position≠method length⇒ [user notify: &rsquo;Compiler code size discrepancy&rsquo;]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">method◦3 &larr; maxTemp + stack length.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑method] </span><span style="font: italic 10pt serif">"compile|evaluate"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Parse tree</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">assignment: var expr: expr<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑ParsedAssignment new var: var expr: expr]<br></span><span style="font: italic 10pt serif">"Parser expression"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">block<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑ParsedBlock default]<br></span><span style="font: italic 10pt serif">"Parser primary|Parser alternatives"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">evalKeyword: arg<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑arg]<br></span><span style="font: italic 10pt serif">"Parser keywordMessage"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">ifExpr: ifExpr thenExpr: thenExpr elseExpr: elseExpr<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑ParsedConditional new ifExpr: ifExpr thenExpr: thenExpr elseExpr: elseExpr]<br></span><span style="font: italic 10pt serif">"ifthen...|Parser alternatives"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">keywordMessage: rcvr selector: sel args: args<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[sel=&rsquo;and⦂&rsquo;⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑ParsedConjunct new left: rcvr right: args local];<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">  = &rsquo;or⦂&rsquo;⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑ParsedDisjunct new left: rcvr right: args local]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self rcvr: rcvr selector: sel args: (args remote: self)]<br></span><span style="font: italic 10pt serif">"Parser keywordMessage"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">noEvalKeyword: arg<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑arg asRemoteCode: self]<br></span><span style="font: italic 10pt serif">"Parser keywordMessage"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">nullStatement: block<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[block next &larr; toLoadNil. ⇑block]<br></span><span style="font: italic 10pt serif">"ifthen|Parser statements"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">rcvr: rcvr selector: sel args: args<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[rcvr≡toSuper⇒ [supered&larr;true]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ParsedMessage new rcvr: rcvr op: (self encodeSel: sel) args: args]<br></span><span style="font: italic 10pt serif">"loop|keywordMessage|Parser binaryMessage|Parser unaryMessage"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">receivingVar: expr </span><span style="font: 10pt serif">| rcvr var </span><span style="font: italic 10pt serif">"who in expr is cascade recipient"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[rcvr &larr; expr emittedReceiver⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[var &larr; rcvr emittedVariable⇒ [⇑var]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">var &larr; self newTemp. </span><span style="font: italic 10pt serif">"if a non-variable, compute it just once"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">expr emittedReceiver &larr; ParsedAssignment new var: var expr: rcvr.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑var]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">parser notify: &rsquo;MAY ONLY FOLLOW A MESSAGE&rsquo;]<br></span><span style="font: italic 10pt serif">"Parser cascade"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">variable: name<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| var global ref unq<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[var &larr; local lookup: name⇒ [⇑var]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[unq &larr; name hasBeenUniqued⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ global from: environment do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ref &larr; global lookupRef: unq⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑codeLoadLitInd + (self litIndex: ref)]]]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">requestor interactive⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[parser notify: &rsquo;➲Smalltalk declare: ↪&rsquo; + name + &rsquo; as: nil➲TO DECLARE GLOBAL&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user show: &rsquo; (&rsquo; + name + &rsquo; is Undeclared) &rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">unq &larr; name unique.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Undeclared declare: unq.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑codeLoadLitInd + (self litIndex: (Undeclared ref: unq))]<br></span><span style="font: italic 10pt serif">"Parser expression|Parser primary"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Macros</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">for: var from: startMinus1 to: stop do: ritual on: block </span><span style="font: 10pt serif">| temp<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[temp &larr; self newTempForMacro.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"temp&larr;stop. var&larr;startMinus1. while⦂ temp≥(var &larr; 1+var) do⦂ ritual"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">block next &larr; ParsedAssignment new var: temp expr: stop;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">next &larr; ParsedAssignment new var: var expr: startMinus1;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">next &larr; ParsedLoop new<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">whileExpr:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(ParsedMessage new rcvr: temp op: toGeq args:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(ParsedAssignment new var: var<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">expr: (ParsedMessage new rcvr: toLoad1 op: toPlus args: var)))<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">doExpr: ritual]<br></span><span style="font: italic 10pt serif">"for...todoargs"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">forfromdo: block args: args </span><span style="font: 10pt serif">| var sequence ritual strm<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[var &larr; (args◦1) local. sequence &larr; args◦2. ritual &larr; (args◦3) local.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm &larr; self newTempForMacro.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"strm &larr; sequence asStream. while⦂ (var &larr; strm next) do⦂ ritual"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">block next &larr; ParsedAssignment new var: strm<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">expr: (ParsedMessage new rcvr: sequence op: toAsStream args: false);<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">next &larr; ParsedLoop new<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">whileExpr:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(ParsedAssignment new var: var<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">expr: (ParsedMessage new rcvr: strm op: toNext args: false))<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">doExpr: ritual]<br></span><span style="font: italic 10pt serif">"macro (perform)"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">forfromtobydo: block args: args<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"for⦂ var from: (start to: stop by: step) do⦂ ritual"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">args◦2 &larr; self rcvr: args◦2 selector: &rsquo;to:by:&rsquo; args: (args◦(3 to: 4)) copy.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self forfromdo: block args: (args◦↪(1 2 5)) copy]<br></span><span style="font: italic 10pt serif">"macro (perform)"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">forfromtodo: block args: args<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self for: (args◦1) local<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">from: (ParsedMessage new rcvr: args◦2 op: toMinus args: toLoad1)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">to: args◦3<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">do: (args◦4) local<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">on: block]<br></span><span style="font: italic 10pt serif">"macro (perform)"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fortodo: block args: args<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self for: (args◦1) local<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">from: toLoad0<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">to: args◦2<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">do: (args◦3) local<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">on: block]<br></span><span style="font: italic 10pt serif">"macro (perform)"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">ifthen: block args: args<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[block next &larr; self ifExpr: (args◦1) local thenExpr: (args◦2) local elseExpr: (self nullStatement: ParsedBlock default)]<br></span><span style="font: italic 10pt serif">"macro (perform)"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">ifthenelse: block args: args<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[block next &larr; self ifExpr: (args◦1) local thenExpr: (args◦2) local elseExpr: (args◦3) local]<br></span><span style="font: italic 10pt serif">"macro (perform)"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">macro: block selector: sel args: args<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| special<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[special &larr; inLineMsgs lookup: sel⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self perform: special with: block with: args]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Context canunderstand: sel unique⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[block next &larr; self rcvr: toLoadThisCtxt selector: sel args: (args remote: self)]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]<br></span><span style="font: italic 10pt serif">"Parser keywordMessage"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">untildo: block args: args<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[block next &larr; ParsedLoop new whileExpr: (ParsedNegation new rcvr: (args◦1) local op: toEq args: toLoadFalse) doExpr: (args◦2) local]<br></span><span style="font: italic 10pt serif">"macro (perform)"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">whiledo: block args: args<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[block next &larr; ParsedLoop new whileExpr: (args◦1) local doExpr: (args◦2) local]<br></span><span style="font: italic 10pt serif">"macro (perform)"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Table maintenance</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">balance<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑nTemps]<br></span><span style="font: italic 10pt serif">"Parser cascade"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">comment: s<br></span><span style="font: italic 10pt serif">"Class fieldNamesInto"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">contents<br></span><span style="font: italic 10pt serif">"Class fieldNamesInto"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">declaration: block name: name asArg: asArg<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| permVar tempVar<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[tempVar &larr; self newTemp.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">permVar &larr; local lookup: name ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[asArg and⦂ permVar isField⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[block next &larr; ParsedAssignment new var: permVar expr: tempVar]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">parser notify: &rsquo;NAME ALREADY IN USE&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">local insert: name with: tempVar]<br></span><span style="font: italic 10pt serif">"Parser declaration|temporaries"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">encodeSel: sel<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| code<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[code &larr; stdSelectors lookup: sel⇒ [⇑code]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑codeSendLit+ (self litIndex: [sel class≡Integer⇒ [UST1◦(sel+1)] sel unique])]<br></span><span style="font: italic 10pt serif">"rcvr|ParsedFieldReference remote|ParsedRemote remote"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">identifier: s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[local insert: s with: (nTemps &larr; nTemps + 1)]<br></span><span style="font: italic 10pt serif">"Class fieldNamesInto"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">initSymbols: class | s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[environment &larr; class wholeEnvironment, Smalltalk.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">local &larr; Dictionary new copyfrom: stdPrimaries.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nTemps &larr; codeLoadField-1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ s from: class instvars do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[local insert: s with: (nTemps &larr; nTemps + 1)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nTemps &larr; maxTemp &larr; 0. literals &larr; Vector new: 123. supered &larr; false]<br></span><span style="font: italic 10pt serif">"compile|evaluate"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">juggle </span><span style="font: 10pt serif">| oldTemps<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[oldTemps &larr; maxTemp. maxTemp &larr; nTemps. ⇑oldTemps]<br></span><span style="font: italic 10pt serif">"Parser macro"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">literal: x  </span><span style="font: 10pt serif">| i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[x class≡Integer⇒ [0≠(i&larr;↪(¬1 0 1 2 10) find: x)⇒ [⇑toLoadConst+i-1]]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑codeLoadLit + (self litIndex: x)]<br></span><span style="font: italic 10pt serif">"Parser primary|ParsedFieldReference remote"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">litIndex: oop  </span><span style="font: 10pt serif">| i t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ i to: 123 do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(t &larr; literals◦i)≡nil⇒ [literals◦i&larr;oop. ⇑i-1]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">t class≡oop class⇒ [t sameAs: oop⇒ [⇑i-1]]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">parser notify: &rsquo;MORE THAN 123 LITERALS REFERENCED&rsquo;]<br></span><span style="font: italic 10pt serif">"encodeSel|literal"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">newTemp<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(nTemps &larr; nTemps+1) &gt; maxTemp and⦂ (maxTemp &larr; nTemps) &gt; 256⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[parser notify: &rsquo;MORE THAN 256 TEMPS REQUIRED&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑codeLoadTemp + nTemps-1]<br></span><span style="font: italic 10pt serif">"receivingVar|declaration"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">newTempForMacro </span><span style="font: italic 10pt serif">"juggle arranged that maxTemp are needed by args of macro"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[nTemps &larr; maxTemp. ⇑self newTemp]<br></span><span style="font: italic 10pt serif">"forfromdo|forfromtodo"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">separator: c<br></span><span style="font: italic 10pt serif">"Class fieldNamesInto"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">trailer: s<br></span><span style="font: italic 10pt serif">"Class fieldNamesInto"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">unbalance: nTemps<br></span><span style="font: italic 10pt serif">"Parser cascade"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">unjuggle: oldTemps<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[maxTemp &larr; oldTemps max: maxTemp]<br></span><span style="font: italic 10pt serif">"Parser macro"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪Generator under: &rsquo;Compiler&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"ParsedAssignment"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;ParsedAssignment&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;var expr elide&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sharing: ByteCodes;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I am a node in a compiler parse tree.  I represent an assignment of an expression to a variable.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">var: var expr: expr</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Code generation</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emitForEffect: code on: stack<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[expr emitForValue: code on: stack. stack pop: 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">elide⇒ [</span><span style="font: italic 10pt serif">"var begins the next statement"</span><span style="font: 10pt serif"> code next &larr; toSmash]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">code next &larr; toSmashPop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">var emitBytes: code]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emitForValue: code on: stack<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[expr emitForValue: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">code next &larr; toSmash.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">var emitBytes: code]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emittedVariable<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑var]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">firstPush<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑expr firstPush]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sizeForEffect: nextPush<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑expr sizeForValue + 1 + [elide &larr; nextPush≡var⇒ [0] var sizeForValue]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sizeForValue<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑expr sizeForValue + 1 + var sizeForValue]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Miscellaneous</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s append: &rsquo;(&rsquo;; print: var; append: &rsquo;&larr;&rsquo;; print: expr; append: &rsquo;)&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Decompiling</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">expr </span><span style="font: 10pt serif">[⇑expr]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">findMacros: macros compilerTemps: compilerTemps<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[var findMacros: macros compilerTemps: compilerTemps.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">expr findMacros: macros compilerTemps: compilerTemps]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">isForFromInit: loop </span><span style="font: 10pt serif">| cond b nextMess<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">return true if I could be the first initialization statement for a <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif; text-decoration: underline">for⦂ from:</span><span style="font: italic 10pt serif"> loop.</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(expr isnt: ParsedMessage) or⦂ expr op≠toAsStream⇒[⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">loop isnt: ParsedLoop⇒[⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">b &larr; loop whileExpr.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(b isnt: ParsedBlock) or⦂ b position≠2⇒[⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">b◦1 isnt: ParsedAssignment⇒[⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextMess &larr; (b◦1) expr.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextMess isnt: ParsedMessage⇒[⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextMess rcvr≠var or⦂ nextMess op≠toNext⇒[⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑true]</span><span class="tab" val="79"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">isForFromToInit: start loop: loop </span><span style="font: 10pt serif">| b incr test<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">return true if I could be the first initialization statement for a <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif; text-decoration: underline">for⦂ to: do⦂</span><span style="font: italic 10pt serif"> or a </span><span style="font: italic 10pt serif; text-decoration: underline">for⦂ from: to: do⦂</span><span style="font: italic 10pt serif"> loop</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">I should set the upper bound, start should set the var to start-1</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(start isnt: ParsedAssignment) or⦂ (loop isnt: ParsedLoop)⇒[⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> [start expr≡toLoad0⇒[]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">start expr isnt: ParsedMessage⇒[⇑false]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">start expr op≠toMinus or⦂ start expr args≠toLoad1⇒[⇑false]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">the loop condition should increment the var and compare it with the <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">upper bound</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">b &larr; loop whileExpr.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(b isnt: ParsedBlock) or⦂ b position≠2⇒[⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">incr &larr; b◦1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">incr isnt: ParsedAssignment⇒[⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">incr var≠start var⇒[⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(incr expr isnt: ParsedMessage) or⦂ incr expr op≠toPlus⇒[⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">incr expr rcvr≠toLoad1 or⦂ incr expr args≠start var⇒[⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">test &larr; b◦2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">test isnt: ParsedMessage⇒[⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(test rcvr≠var or⦂ test op≠toGeq) or⦂ test args≠incr var⇒[⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑true]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm indent: level precedence: p forValue: v decompiler: decompiler<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ [p&gt;1⇒[strm append: &rsquo;(&rsquo;]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">var printon: strm indent: level precedence: 1<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">forValue: true decompiler: decompiler.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm append: &rsquo; &larr; &rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">expr printon: strm indent: level+2 precedence: 1<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">forValue: true decompiler: decompiler.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">p&gt;1⇒[strm append: &rsquo;)&rsquo;]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">var </span><span style="font: 10pt serif">[⇑var]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪ParsedAssignment under: &rsquo;Compiler&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"ParsedBlock"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;ParsedBlock&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Stream<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;returns&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sharing: ByteCodes;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I am a stream to collect the statements of a block and then to become a node in a compiler parse tree.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">default<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[limit &larr; 1. array &larr; Vector new: 1. position &larr; 0. returns &larr; false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">doesReturn<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[returns &larr; true]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">mustReturn: fromMethod<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[returns⇒ []<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[fromMethod⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[position&gt;0 and⦂ (array◦position) emitsLoad⇒ [array◦position &larr; toLoadSelf] self next &larr; toLoadSelf]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self doesReturn]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Code generation</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emitForEffect: code on: stack<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[returns⇒ [self emitForValue: code on: stack. stack pop: 1]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self emitExceptLast: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(array◦position) emitForEffect: code on: stack]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emitForValue: code on: stack<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self emitExceptLast: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(array◦position) emitForValue: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">returns⇒ [code next &larr; toReturn]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">firstPush<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑(array◦1) firstPush]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sizeForEffect: nextPush<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[returns⇒ [⇑self sizeForValue]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self sizeExceptLast + ((array◦position) sizeForEffect: nextPush)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sizeForTruth: trueSkip falsity: falseSkip<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[returns⇒ [⇑self sizeForValue]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self sizeExceptLast + (array◦position sizeForTruth: trueSkip falsity: falseSkip)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sizeForValue<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self sizeExceptLast + (array◦position) sizeForValue + [returns⇒ [1] 0]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Miscellaneous</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: s </span><span style="font: 10pt serif">| i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s append: &rsquo;[&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: position-1 do⦂ [s print: (array◦i); append: &rsquo;. &rsquo;].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[returns⇒ [s append: &rsquo;⇑&rsquo;]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[position&gt;0⇒ [s print: (array◦position)]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s append: &rsquo;]&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">quickCode </span><span style="font: 10pt serif">| t v<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[position=1 and⦂ (returns and⦂ (v&larr;array◦1) emitsLoad)⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[v=toLoadSelf⇒ [t &larr; String new: 2. t◦1&larr;0; ◦2&larr;1. ⇑t]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">v isField⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t &larr; String new: 5. t◦1&larr;0; ◦2&larr;40; ◦3&larr;0; ◦4&larr;0; ◦5&larr;v. ⇑t]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">returns<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑returns]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Private</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emitExceptLast: code on: stack<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ i to: position-1 do⦂ [(array◦i) emitForEffect: code on: stack]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sizeExceptLast<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| i next nextPush size<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[size &larr; 0. next &larr; array◦position.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: position-1 do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[nextPush &larr; next firstPush. next &larr; array◦(position-i).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">size &larr; size + (next sizeForEffect: nextPush)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑size]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Decompiling</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">findMacros: macros compilerTemps: compilerTemps </span><span style="font: 10pt serif">| i s t<br>"</span><span style="font: italic 10pt serif">Look for </span><span style="font: italic 10pt serif; text-decoration: underline">for</span><span style="font: italic 10pt serif"> statements.  If one of my statements is the init statement for a </span><span style="font: italic 10pt serif; text-decoration: underline">for</span><span style="font: italic 10pt serif">, append myself and the index of that statement to the stream </span><span style="font: italic 10pt serif; text-decoration: underline">macros</span><span style="font: italic 10pt serif">.  Mark its compiler-generated temp.  If the temp is subsequently used before being re-assigned, the pattern can&rsquo;t be a </span><span style="font: italic 10pt serif; text-decoration: underline">for</span><span style="font: italic 10pt serif"> after all, and will be deleted from </span><span style="font: italic 10pt serif; text-decoration: underline">macros</span><span style="font: italic 10pt serif">.</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ i to: position do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s &larr; array◦i.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(s isnt: ParsedAssignment) or⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(s var&lt;codeLoadTemp or⦂ s var&gt;(codeLoadTemp+255))⇒  "</span><span style="font: italic 10pt serif">not a </span><span style="font: italic 10pt serif; text-decoration: underline">for</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s findMacros: macros compilerTemps: compilerTemps]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">t &larr; s var-codeLoadTemp+1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">i≤(position-2) and⦂ (s isForFromToInit: array◦(i+1) loop: array◦(i+2))⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[macros next&larr; self; next&larr; i.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">compilerTemps◦t &larr; true.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">check other parts of the for</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s expr findMacros: macros compilerTemps: compilerTemps.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">array◦(i+1) findMacros: macros compilerTemps: compilerTemps.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(array◦(i+2)) doExpr findMacros: macros compilerTemps: compilerTemps.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; i+2]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">i≤(position-1) and⦂ (array◦i isForFromInit: array◦(i+1))⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[macros next&larr; self; next&larr; i.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">compilerTemps◦t &larr; true.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s expr findMacros: macros compilerTemps: compilerTemps.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(array◦(i+1)) doExpr findMacros: macros compilerTemps: compilerTemps.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; i+1]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s findMacros: macros compilerTemps: compilerTemps]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">insertMacro: loc decompiler: decompiler </span><span style="font: 10pt serif">| macro n i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">create a parsed for loop, and replace the old statements by it</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">macro &larr; ParsedForLoop new block: self loc: loc decompiler: decompiler.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">array◦loc &larr; macro.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">n &larr; macro nStatements.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: loc+n to: position do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[array◦(i-n+1) &larr; array◦i].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">position &larr; position-n+1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm indent: level precedence: p forValue: v decompiler: decompiler </span><span style="font: 10pt serif">| i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">ignore precedence, since the block is enclosed in brackets</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">position=0⇒[strm append: &rsquo;[]&rsquo; ]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm append: &rsquo;[&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: position-1 do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[array◦i printon: strm indent: level precedence: 0<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">forValue: false decompiler: decompiler.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm append: &rsquo;.&rsquo;; crtab: level].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> [returns⇒[strm append: &rsquo;⇑&rsquo;]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">array◦position printon: strm indent: level precedence: 0<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">forValue: (returns or⦂ v) decompiler: decompiler.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm append: &rsquo;]&rsquo; ]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>As yet unclassified</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emitForTruth: trueSkip falsity: falseSkip into: code on: stack<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[returns⇒ [self emitForValue: code on: stack]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self emitExceptLast: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(array◦position) emitForTruth: trueSkip falsity: falseSkip into: code on: stack]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪ParsedBlock under: &rsquo;Compiler&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"ParsedConditional"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;ParsedConditional&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;ifExpr thenExpr elseExpr thenSize elseSize jmpSize&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I am a node in a compiler parse tree.  I represent a condition and two alternatives.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">ifExpr: ifExpr thenExpr: thenExpr elseExpr: elseExpr</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Code generation</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emitForEffect: code on: stack<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ifExpr emitForValue: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">thenSize emitBfp: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">thenExpr emitForEffect: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[jmpSize&gt;0⇒ [elseSize emitJmp: code on: stack]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">elseExpr emitForEffect: code on: stack]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emitForValue: code on: stack<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ifExpr emitForValue: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">thenSize emitBfp: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">thenExpr emitForValue: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">stack pop: 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[jmpSize&gt;0⇒ [elseSize emitJmp: code on: stack]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">elseExpr emitForValue: code on: stack]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">firstPush<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑ifExpr firstPush]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sizeForEffect: nextPush<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[elseSize &larr; elseExpr sizeForEffect: nextPush.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">jmpSize &larr; [thenExpr returns⇒ [0] elseSize jmpSize].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">thenSize &larr; (thenExpr sizeForEffect: ¬1) + jmpSize.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ifExpr sizeForValue + thenSize bfpSize + thenSize + elseSize]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sizeForValue<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[elseSize &larr; elseExpr sizeForValue.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">jmpSize &larr; [thenExpr returns⇒ [0] elseSize jmpSize].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">thenSize &larr; thenExpr sizeForValue + jmpSize.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ifExpr sizeForValue + thenSize bfpSize + thenSize + elseSize]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Miscellaneous</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s append: &rsquo;if⦂ &rsquo;; print: ifExpr; append: &rsquo;then⦂ &rsquo;; print: thenExpr; append: &rsquo;else⦂ &rsquo;; print: elseExpr]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">returns<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑thenExpr returns and⦂ elseExpr returns]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Decompiling</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">findMacros: macros compilerTemps: compilerTemps<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ifExpr findMacros: macros compilerTemps: compilerTemps.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">thenExpr findMacros: macros compilerTemps: compilerTemps.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">elseExpr findMacros: macros compilerTemps: compilerTemps]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm indent: level precedence: p forValue: v decompiler: decompiler<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| pos char<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ifExpr printon: strm indent: level precedence: 0 <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">forValue: true decompiler: decompiler.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm append: &rsquo; ⇒&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[thenExpr position&gt;1 or⦂ (thenExpr◦1 is: ParsedConditional)⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strm crtab: level+1] strm space].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">thenExpr printon: strm indent: level+1 precedence: 0 <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">forValue: v decompiler: decompiler.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">elseExpr position=1 and⦂ elseExpr last≡nil⇒[]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm crtab: level.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">Kludge!! Delete brackets around else block</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pos&larr;strm position.  char&larr;strm pop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">elseExpr printon: strm indent: level precedence: 0 <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">forValue: v decompiler: decompiler.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm skip: ¬1.  strm◦pos&larr;char]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪ParsedConditional under: &rsquo;Compiler&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"ParsedConjunct"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;ParsedConjunct&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;left right rightSize&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sharing: ByteCodes;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I am a node in a compiler parse tree.  I represent (left and⦂ right) and try to optimize the code generation thereof.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">left: left right: right</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Code generation</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emitForEffect: code on: stack<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[left emitForValue: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rightSize emitBfp: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">right emitForEffect: code on: stack]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emitForTruth: trueSkip falsity: falseSkip into: code on: stack<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[left emitForTruth: 0 falsity: rightSize+falseSkip into: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">right emitForTruth: trueSkip falsity: falseSkip into: code on: stack]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emitForValue: code on: stack<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[left emitForValue: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rightSize emitBfp: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">right emitForValue: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">1 emitJmp: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">code next &larr; toLoadFalse]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">firstPush<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑left firstPush]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sizeForEffect: nextPush<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[rightSize &larr; right sizeForEffect: ¬1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑left sizeForValue + rightSize bfpSize + rightSize]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sizeForTruth: trueSkip falsity: falseSkip<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[rightSize &larr; right sizeForTruth: trueSkip falsity: falseSkip.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑(left sizeForTruth: 0 falsity: rightSize+falseSkip) + rightSize]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sizeForValue<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[rightSize &larr; right sizeForValue + 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑left sizeForValue + rightSize bfpSize + rightSize + 1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Miscellaneous</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emittedReceiver<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑left]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emittedReceiver &larr; left</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s append: &rsquo;(&rsquo;; print: left; append:  &rsquo; and⦂ &rsquo;; print: right; append: &rsquo;)&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Decompiling</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">findMacros: macros compilerTemps: compilerTemps<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[left findMacros: macros compilerTemps: compilerTemps.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">right findMacros: macros compilerTemps: compilerTemps]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm indent: level precedence: p forValue: v decompiler: decompiler<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ [p≥2⇒[strm append: &rsquo;(&rsquo;]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">left printon: strm indent: level precedence: 2<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">forValue: true decompiler: decompiler.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm append: &rsquo; and⦂ &rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">right printon: strm indent: level precedence: 2<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">forValue: v decompiler: decompiler.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">p≥2⇒[strm append: &rsquo;)&rsquo;]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪ParsedConjunct under: &rsquo;Compiler&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"ParsedDisjunct"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;ParsedDisjunct&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;left right rightSize&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sharing: ByteCodes;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I am a node in a compiler parse tree.  I represent (left or⦂ right) and try to optimize the code generation thereof.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">left: left right: right</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Code generation</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emitForEffect: code on: stack<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[left emitForValue: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rightSize jmpSize emitBfp: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rightSize emitJmp: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">right emitForEffect: code on: stack]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emitForTruth: trueSkip falsity: falseSkip into: code on: stack<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[left emitForTruth: rightSize+trueSkip falsity: 0 into: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">right emitForTruth: trueSkip falsity: falseSkip into: code on: stack]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emitForValue: code on: stack<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[left emitForValue: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(1 + rightSize jmpSize) emitBfp: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">code next &larr; toLoadTrue.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rightSize emitJmp: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">right emitForValue: code on: stack]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">firstPush<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑left firstPush]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sizeForEffect: nextPush<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[rightSize &larr; right sizeForEffect: ¬1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑left sizeForValue + 1 + rightSize jmpSize + rightSize]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sizeForTruth: trueSkip falsity: falseSkip<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[rightSize &larr; right sizeForTruth: trueSkip falsity: falseSkip.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑(left sizeForTruth: rightSize+trueSkip falsity: 0) + rightSize]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sizeForValue<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[rightSize &larr; right sizeForValue.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑left sizeForValue + 2 + rightSize jmpSize + rightSize]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Miscellaneous</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emittedReceiver<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑left]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emittedReceiver &larr; left</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s append: &rsquo;(&rsquo;; print: left; append: &rsquo; or⦂ &rsquo;; print: right; append: &rsquo;)&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Decompiling</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">findMacros: macros compilerTemps: compilerTemps<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[left findMacros: macros compilerTemps: compilerTemps.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">right findMacros: macros compilerTemps: compilerTemps]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm indent: level precedence: p forValue: v decompiler: decompiler<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ [p≥2⇒[strm append: &rsquo;(&rsquo;]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">left printon: strm indent: level precedence: 2<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">forValue: true decompiler: decompiler.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm append: &rsquo; or⦂ &rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">right printon: strm indent: level precedence: 2<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">forValue: v decompiler: decompiler.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">p≥2⇒[strm append: &rsquo;)&rsquo;]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪ParsedDisjunct under: &rsquo;Compiler&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"ParsedFieldReference"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;ParsedFieldReference&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;var toLoadVar toLoadFieldReference toObjectOffset&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sharing: ByteCodes;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I am a node in a compiler parse tree.  I represent a remote argument which is a reference to a method or instance variable.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">var: var</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Code generation</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emitForValue: code on: stack<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[([var isField⇒ [toLoadSelf] toLoadTempframe]) emitForValue: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">toLoadVar emitForValue: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">toLoadFieldReference emitForValue: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">code next &larr; toNew. toObjectOffset emitBytes: code..<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">stack pop: 2]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">local<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑var]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">remote: generator<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[toLoadVar &larr; generator literal: (var land: 0177)+1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">toLoadFieldReference &larr; generator literal: FieldReference.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">toObjectOffset &larr; generator encodeSel: ↪object:offset:]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sizeForValue<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑ 2 + toLoadVar sizeForValue +<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">toLoadFieldReference sizeForValue + toObjectOffset sizeForValue]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Miscellaneous</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s append: &rsquo;FLD=&gt; &rsquo;; print: var]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Decompiling</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">findMacros: macros compilerTemps: compilerTemps<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[var findMacros: macros compilerTemps: compilerTemps]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm indent: level precedence: p forValue: v decompiler: decompiler<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[var printon: strm indent: level precedence: p<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">forValue: true decompiler: decompiler]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪ParsedFieldReference under: &rsquo;Compiler&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"ParsedForLoop"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;ParsedForLoop&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;var source start stop step doExpr nStatements&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sharing: ByteCodes;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I represent a for loop.  I am used only by the decompiler, not the compiler.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Decompiling</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">block: block loc: loc decompiler: decompiler </span><span style="font: 10pt serif">| init1 init2 loop s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">loc should point to the initialization statement for a </span><span style="font: italic 10pt serif; text-decoration: underline">for</span><span style="font: italic 10pt serif"> loop in block</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">init1 &larr; block◦loc.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">block◦(loc+1) is: ParsedLoop⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[nStatements &larr; 2.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">loop &larr; block◦(loc+1).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">var &larr; loop whileExpr◦2.  doExpr &larr; loop doExpr.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">init statement creates a stream ... see if its an interval</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s &larr; init1 expr rcvr.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(s is: ParsedMessage) and⦂ (decompiler selector: s op)≡↪to:by: ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[start &larr; s rcvr.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">stop &larr; s args◦1.  step &larr; s args◦2]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">source &larr; s]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">must be a for⦂from:to:do⦂.  </span><span style="font: italic 10pt serif; text-decoration: underline">init1</span><span style="font: italic 10pt serif"> will set up the limit, and </span><span style="font: italic 10pt serif; text-decoration: underline">init2</span><span style="font: italic 10pt serif"> will<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">initialize </span><span style="font: italic 10pt serif; text-decoration: underline">var</span><span style="font: italic 10pt serif"> to start-1</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nStatements &larr; 3.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">init2 &larr; block◦(loc+1).  loop &larr; block◦(loc+2).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">var &larr; init2 var.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">start &larr; [init2 expr≡toLoad0</span><span class="tab" val="79"></span><span style="font: 10pt serif">⇒[toLoad1] init2 expr rcvr].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">stop &larr; init1 expr.  step &larr; toLoad1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">doExpr &larr; loop doExpr]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">nStatements<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">return the number of statements in my expanded form</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑nStatements]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm indent: level precedence: p forValue: v decompiler: decompiler<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[source≡nil⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strm append: &rsquo;for⦂ &rsquo;.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">var printon: strm indent: level precedence: 2<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">forValue: true decompiler: decompiler.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> [start≡toLoad1⇒[] strm append: &rsquo; from: &rsquo;.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">start printon: strm indent: level precedence: 2<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">forValue: true decompiler: decompiler].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm append: &rsquo; to: &rsquo;.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">stop printon: strm indent: level precedence: 2<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">forValue: true decompiler: decompiler.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> [step≡toLoad1⇒[] strm append: &rsquo; by: &rsquo;.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">step printon: strm indent: level precedence: 2<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">forValue: true decompiler: decompiler].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm append: &rsquo; do⦂&rsquo;; crtab: level+1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">doExpr printon: strm indent: level+1 precedence: 0 <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">forValue: false decompiler: decompiler]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">source is a stream</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm append: &rsquo;for⦂ &rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">var printon: strm indent: level precedence: 2<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">forValue: true decompiler: decompiler.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm append: &rsquo; from: &rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">source printon: strm indent: level precedence: 2<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">forValue: true decompiler: decompiler.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm append: &rsquo; do⦂&rsquo;; crtab: level+1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">doExpr printon: strm indent: level+1 precedence: 0 <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">forValue: false decompiler: decompiler]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪ParsedForLoop under: &rsquo;Compiler&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"ParsedLoop"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;ParsedLoop&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;whileExpr doExpr whileSize doSize&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sharing: ByteCodes;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I am a node in a compiler parse tree.  I represent that part of an in-line loop statement that can be expressed in the while-do form.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">whileExpr: whileExpr doExpr: doExpr</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Code generation</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emitForEffect: code on: stack<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">optimization removed to make things easier for decompiler --<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">whileExpr emitForTruth: 0 falsity: doSize into: code on: stack.</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">whileExpr emitForValue: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">doSize emitBfp: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">doExpr emitForEffect: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">0 - doSize - whileSize - doSize jmpSize emitJmp: code on: stack]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emitForValue: code on: stack<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self emitForEffect: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">toLoadNil emitForValue: code on: stack]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">firstPush<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑whileExpr firstPush]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sizeForEffect: nextPush<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[doSize &larr; (doExpr sizeForEffect: ¬1) + 2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">whileSize &larr; whileExpr sizeForTruth: 0 falsity: doSize.</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">whileSize &larr; whileExpr  sizeForValue.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑whileSize + doSize + doSize jmpSize]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sizeForValue<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑(self sizeForEffect: ¬1) + 1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Miscellaneous</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s append: &rsquo;while⦂ &rsquo;; print: whileExpr; append: &rsquo;do⦂ &rsquo;; print: doExpr]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Decompiling</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">doExpr </span><span style="font: 10pt serif">[⇑doExpr]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">findMacros: macros compilerTemps: compilerTemps<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[whileExpr findMacros: macros compilerTemps: compilerTemps.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">doExpr findMacros: macros compilerTemps: compilerTemps]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm indent: level precedence: p forValue: v decompiler: decompiler<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[whileExpr is: ParsedNegation⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strm append: &rsquo;until⦂ &rsquo;.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">whileExpr negated printon: strm indent: level precedence: 2<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">forValue: true decompiler: decompiler]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> strm append: &rsquo;while⦂ &rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> whileExpr printon: strm indent: level precedence: 2<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">forValue: true decompiler: decompiler].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm append: &rsquo; do⦂&rsquo;; crtab: level+1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">doExpr printon: strm indent: level+1 precedence: 0 <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">forValue: false decompiler: decompiler]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">whileExpr </span><span style="font: 10pt serif">[⇑whileExpr]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪ParsedLoop under: &rsquo;Compiler&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"ParsedMessage"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;ParsedMessage&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;rcvr op args "false if no args, Vector if many args" hasPC&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sharing: ByteCodes;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I am a node in a compiler parse tree.  I represent an expression consisting of a receiver (rcvr), a selector byte code (op), and an argument list (args) which is false for no arguments, a vector of parse trees for 2 or more arguments, or the argument parse tree for one argument.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hasPC </span><span style="font: 10pt serif">[hasPC&larr; true]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">rcvr: rcvr op: op args: args<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[hasPC&larr; false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">op=toEq and⦂ ((toLoadFalse≡rcvr) or⦂ (toLoadFalse≡args))⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑ParsedNegation new rcvr: rcvr op: op args: args]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Code generation</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emitForEffect: code on: stack<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self emitForValue: code on: stack. code next &larr; toPop. stack pop: 1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emitForValue: code on: stack<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[args emitForValue: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rcvr emitForValue: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[rcvr≡toSuper⇒ [code next&larr;rcvr]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">op emitBytes: code. args argsOff: stack]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">firstPush<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑([args⇒ [args] rcvr]) firstPush]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sizeForEffect: nextPush<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self sizeForValue+1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sizeForValue<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑args sizeForValue + rcvr sizeForValue + op sizeForValue + [rcvr≡toSuper⇒ [1] 0]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Miscellaneous</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">args </span><span style="font: 10pt serif">[⇑args]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">args&larr;args</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emittedReceiver<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑rcvr]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emittedReceiver &larr; rcvr</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">op </span><span style="font: 10pt serif">[⇑op]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s append: &rsquo;(&rsquo;; print: rcvr; space; print: op.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[args⇒ [s space; print: args]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s append: &rsquo;)&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">rcvr </span><span style="font: 10pt serif">[⇑rcvr]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Decompiling</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">findMacros: macros compilerTemps: compilerTemps </span><span style="font: 10pt serif">| vec a<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[vec &larr; [args≡nil⇒[↪()] args is: Vector⇒[args] args inVector].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ a from: vec do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[a findMacros: macros compilerTemps: compilerTemps].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rcvr findMacros: macros compilerTemps: compilerTemps]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm indent: level precedence: p forValue: v decompiler: decompiler<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| sel keywords i parens myP vec char1<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[sel &larr; decompiler selector: op.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">myP &larr; [sel isinfix⇒[3]; iskeyword⇒[2]; isarrow⇒[1] 4].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"check if parens are needed"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">parens &larr; [myP&lt;p or⦂ (p=2 and⦂ myP=2)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> [parens⇒[strm append: &rsquo;(&rsquo;]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">char1&larr; strm position.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rcvr printon: strm indent: level precedence: myP<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">forValue: true decompiler: decompiler.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> [myP=4⇒[strm space; append: sel  "unary selector"]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> keywords &larr; sel keywords.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">vec &larr; [args≡nil⇒[↪()] args is: Vector⇒[args] args inVector].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> for⦂ i to: keywords length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strm space; append: keywords◦i; space.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">vec◦i printon: strm indent: level <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">precedence: [myP=3⇒[4] myP]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">forValue: true decompiler: decompiler]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[hasPC⇒[decompiler highlight: (char1+1 to: strm position+1)]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">parens⇒[strm append: &rsquo;)&rsquo;]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪ParsedMessage under: &rsquo;Compiler&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"ParsedNegation"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;ParsedNegation&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: ParsedMessage<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sharing: ByteCodes;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I am a node in a compiler parse tree.  I am a parsed messsage in which the selector is ≡ and one of the participants is false.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">rcvr: rcvr op: op args: args</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Code generation</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emitForTruth: trueSkip falsity: falseSkip into: code on: stack<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[([toLoadFalse≡rcvr⇒ [args] rcvr]) emitForTruth: falseSkip falsity: trueSkip into: code on: stack]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sizeForTruth: trueSkip falsity: falseSkip<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑([toLoadFalse≡rcvr⇒ [args] rcvr]) sizeForTruth: falseSkip falsity: trueSkip]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Miscellaneous</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">negated </span><span style="font: 10pt serif">[toLoadFalse≡rcvr⇒[⇑args] ⇑rcvr]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s append: &rsquo;(negation)&rsquo;. super printon: s]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪ParsedNegation under: &rsquo;Compiler&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"ParsedObjectReference"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;ParsedObjectReference&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;var&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sharing: ByteCodes;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I am a node in a compiler parse tree.  I represent a remote argument which is a reference to a class or pool variable.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">var: var</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Code generation</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emitForValue: code on: stack  </span><span style="font: italic 10pt serif">"Turn literal indirect into literal direct"</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(var-256) emitForValue: code on: stack]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">local<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑var]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">remote: generator</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sizeForValue<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑(var-256) sizeForValue]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Miscellaneous</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s append: &rsquo;OBJ=&gt; &rsquo;; print: var]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Decompiling</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">findMacros: macros compilerTemps: compilerTemps<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[var findMacros: macros compilerTemps: compilerTemps]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm indent: level precedence: p forValue: v decompiler: decompiler<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strm append: (decompiler literal: var)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪ParsedObjectReference under: &rsquo;Compiler&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"ParsedRemote"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;ParsedRemote&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;expr esize toRemoteCopy&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sharing: ByteCodes;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I am a node in a compiler parse tree.  I represent an argument that is to be passed unevaluated.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">expr: expr</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Code generation</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emitForValue: code on: stack<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[toLoadThisCtxt emitForValue: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">toRemoteCopy emitBytes: code.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">code emitLong: toLongJmp by: esize.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">expr emitForValue: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">code next &larr; toEnd. stack pop: 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(0-esize) emitJmp: code on: stack]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">local<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑expr]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">remote: generator<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[toRemoteCopy &larr; generator encodeSel: ↪remoteCopy]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sizeForValue<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[esize &larr; expr sizeForValue + 3.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑esize + toRemoteCopy sizeForValue + 3]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Miscellaneous</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s append: &rsquo;⦂&rsquo;; print: expr]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Decompiling</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">findMacros: macros compilerTemps: compilerTemps<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[expr findMacros: macros compilerTemps: compilerTemps]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm indent: level precedence: p forValue: v decompiler: decompiler<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[(expr is: ParsedBlock) and⦂ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(expr position&gt;1 or⦂ (expr◦1 is: ParsedConditional))⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strm crtab: level+1]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">expr printon: strm indent: level+1 precedence: p<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">forValue: true decompiler: decompiler]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪ParsedRemote under: &rsquo;Compiler&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"Parser"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;Parser&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;source dest oppositeCourt type token mark keep&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sharing: TokenCodes;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I parse tokens from source (a stream).  I report each parse node to dest (e.g., a code generator).  When an error occurs, I back up source to mark and notify dest.  I have two kinds of methods, token suppliers and token consumers, which coroutine with each other.  The coroutine that is not in control is suspended in the context, oppositeCourt.  Token suppliers are driven by an instance of class Reader that scans source and classifies each token by type.  Token consumers analyze the syntax and report it to dest.  The variable "keep" is no longer used.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">from: source to: dest<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[oppositeCourt &larr; thisContext.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">mark &larr; source position. type &larr; 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(Reader new of: source) readInto: self]<br></span><span style="font: italic 10pt serif">"Generator compile|Generator evaluate"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Token suppliers</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">comment: s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[mark &larr; source position]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">contents<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[type &larr; 0. mark &larr; source position + 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">thisContext sender &larr; nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ true do⦂ [self resume. self notify: &rsquo;MORE EXPECTED&rsquo;]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">float: i fraction: f exp: e<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[token &larr; (i+&rsquo;.&rsquo;+f+&rsquo;e&rsquo;+e) asFloat.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">type &larr; aNumber. self resume]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">identifier: token<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[type &larr; aWord. self resume]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">integer: s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[token &larr; s asInteger.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">type &larr; aNumber. self resume]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">keyword: token<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[type &larr; aKeyword. self resume]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">leftparen<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[type &larr; aLeftPar. self resume]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">onechar: token<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[type &larr;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[token=056⇒ [aPeriod];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=0133⇒ [aLeftBrack];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=0135⇒ [aRightBrack];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=033⇒ [aCondArrow];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=0137⇒ [aLeftArrow];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=021⇒ [aReturnArrow];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=073⇒ [aSemicolon];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=017⇒ [aHand]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">aBinary].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self resume]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">otheratom: token<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[type &larr; aGibberish. self resume]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">rightparen<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[type &larr; aRightPar. self resume]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">separator: c</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">string: token<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[type &larr; aString. self resume]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">trailer: s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[mark &larr; source position]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Method syntax</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">body: block  </span><span style="font: 10pt serif">| p  </span><span style="font: italic 10pt serif">"return the primitive number, or 0"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[type=aLeftBrack⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self block: block.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">type=aKeyword and⦂ token=&rsquo;primitive:&rsquo;⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self advance. type=aNumber⇒ [p &larr; token. self advance. ⇑p]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self notify: &rsquo;EXPECTED A NUMBER&rsquo;]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑0]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑0]<br></span><span style="font: italic 10pt serif">"Generator compile"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">declaration: block<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[type≠aWord⇒ [self notify: &rsquo;EXPECTED AN ARGUMENT NAME&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dest declaration: block name: token asArg: true.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self advance]<br></span><span style="font: italic 10pt serif">"pattern"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pattern: block<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| selector<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[selector &larr; Stream default.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[type=aWord⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[selector append: token. self advance];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=aBinary⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[selector append: (UST1◦(token+1)). self advance; declaration: block]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ type = aKeyword do⦂ [selector append: token. self advance; declaration: block].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">selector empty⇒ [self notify: &rsquo;EXPECTED A SELECTOR&rsquo;]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[type=aLeftArrow⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[selector append: &rsquo;&larr;&rsquo;. self advance; declaration: block]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑selector contents unique]<br></span><span style="font: italic 10pt serif">"Generator compile|Context variableNamesInto"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">temporaries: block<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[type=aBinary and⦂ token=0174⇒ </span><span style="font: italic 10pt serif">"|"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self advance.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ type=aWord do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[dest declaration: block name: token asArg: false. self advance]]]<br></span><span style="font: italic 10pt serif">"Generator compile|Context variableNamesInto"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Statement syntax</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">alternatives: ifExpr </span><span style="font: italic 10pt serif">"⇒ [..] ..."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| thenExpr elseExpr<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self advance.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">type≠aLeftBrack⇒ [self notify: &rsquo;EXPECTED A [BLOCK]&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">thenExpr &larr; self block: dest block. elseExpr &larr; dest block.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[type=aSemicolon⇒ [self cascade: elseExpr after: ifExpr] self statements: elseExpr].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑dest ifExpr: ifExpr thenExpr: thenExpr elseExpr: elseExpr]<br></span><span style="font: italic 10pt serif">"cascade"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">block: block<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self advance; statements: block.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">type=aRightBrack⇒ [self advance. ⇑block]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self notify: &rsquo;PERIOD OR RIGHT BRACKET WAS EXPECTED&rsquo;]<br></span><span style="font: italic 10pt serif">"body|alternatives|expression|keywordMessage|binaryMessage"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">cascade: block after: expr  </span><span style="font: 10pt serif">| val var oldTemps<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[var &larr; dest receivingVar: expr.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">oldTemps &larr; dest balance.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ type=aSemicolon do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self advance.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(val &larr; self messageChain: var)≡var⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self notify: &rsquo;MESSAGE EXPECTED&rsquo;].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">type=aCondArrow⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[block next &larr; self alternatives: val. dest unbalance: oldTemps. ⇑self]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">block next &larr; val].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dest unbalance: oldTemps]<br></span><span style="font: italic 10pt serif">"statement|alternatives"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">loopStmt: block  </span><span style="font: 10pt serif">| oldMark<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[oldMark &larr; mark. self keywordMessage: false loop: block⇒ [⇑self]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">mark &larr; oldMark. self notify: &rsquo;UNKNOWN CONTROL MESSAGE&rsquo;]<br></span><span style="font: italic 10pt serif">"statement"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">macro: block  </span><span style="font: 10pt serif">| oldMark oldTemps val<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[oldMark &larr; mark. oldTemps &larr; dest juggle.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">val &larr; self keywordMessage: false macro: block.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dest unjuggle: oldTemps.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">val⇒ [⇑block]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">mark &larr; oldMark. self notify: &rsquo;UNKNOWN CONTROL MESSAGE&rsquo;]<br></span><span style="font: italic 10pt serif">"statement"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">statement: block </span><span style="font: 10pt serif">| expr<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[type=aReturnArrow⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self advance. block next &larr; self expression. block doesReturn.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[type=aPeriod⇒ [self advance]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">type≠aRightBrack⇒ [self notify:&rsquo;SHOULDN&rsquo;&rsquo;T FOLLOW RETURN&rsquo;]];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">= aKeyword⇒ [self macro: block. type&gt;aPeriod⇒ [self statement: block]];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">≤aPeriod⇒ [dest nullStatement: block] </span><span style="font: italic 10pt serif">"doit eof aRightBrack aPeriod"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">expr &larr; self expression.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">type=aCondArrow⇒ [block next &larr; self alternatives: expr]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">block next &larr; expr.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">type=aSemicolon⇒ [self cascade: block after: expr]]<br></span><span style="font: italic 10pt serif">"statements"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">statements: block<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self statement: block.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ type=aPeriod do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self advance. self statement: block]]<br></span><span style="font: italic 10pt serif">"alternatives|block|Generator evaluate"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Expression syntax</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">binaryMessage: rcvr assign: assign </span><span style="font: italic 10pt serif">"binarySelector ..."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| sel args<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[sel &larr; token. self advance.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">args &larr; [type=aLeftBrack⇒ [self block: dest block] self factor].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[assign and⦂ type=aLeftArrow⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self advance.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">args &larr; [(Vector new: 2)◦1&larr;args; ◦2&larr;self expression; itself].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">sel &larr; [(String new: 2)◦1&larr;sel; ◦2&larr;0137</span><span style="font: italic 10pt serif">"&larr;"</span><span style="font: 10pt serif">; itself]]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑dest rcvr: rcvr selector: sel args: args]<br></span><span style="font: italic 10pt serif">"term|messageChain"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">expression<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| var<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[type=aLeftBrack⇒ [⇑self block: dest block];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=aKeyword⇒ [⇑self macro: dest block];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">≠aWord⇒ [⇑self messageChain: self primary]<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"It begins with a variable name"</span><span style="font: 10pt serif"> var &larr; dest variable: token. self advance.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">type≠aLeftArrow⇒ [⇑self messageChain: var]<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"It is a variable assignment"</span><span style="font: 10pt serif"> self advance.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑dest assignment: var expr: self expression]<br></span><span style="font: italic 10pt serif">"unaryMessage|binaryMessage|keywordMessage|statement|subExpression"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">factor<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| expr<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[expr &larr; self primary.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ type=aWord do⦂ [expr &larr; self unaryMessage: expr assign: false].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑expr]<br></span><span style="font: italic 10pt serif">"term|binaryMessage"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">keywordMessage: rcvr macro: block </span><span style="font: italic 10pt serif">"keyword ..."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| sel args arg<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[sel &larr; Stream default. args &larr; (Vector new: 4) asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ type = aKeyword do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[sel append: token. self advance.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">arg &larr; [type=aLeftBrack⇒ [self block: dest block] self term].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">args next &larr; [sel last=03⇒ [dest noEvalKeyword: arg] dest evalKeyword: arg]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[type=aLeftArrow⇒ [sel append: &rsquo;&larr;&rsquo;. args next &larr; [self advance; expression]]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sel &larr; sel contents. args &larr; [args position=1⇒ [args last] args contents].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">block⇒ [⇑dest macro: block selector: sel args: args]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑dest keywordMessage: rcvr selector: sel args: args]<br></span><span style="font: italic 10pt serif">"macro|messageChain"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">messageChain: rcvr<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[while⦂ type=aWord do⦂ [rcvr &larr; self unaryMessage: rcvr assign: true].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ type=aBinary do⦂ [rcvr &larr; self binaryMessage: rcvr assign: true].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[type = aKeyword⇒ [rcvr &larr; self keywordMessage: rcvr macro: false]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑rcvr]<br></span><span style="font: italic 10pt serif">"cascade|expression"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">term  </span><span style="font: 10pt serif">| rcvr<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[rcvr &larr; self factor.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ type=aBinary do⦂ [rcvr &larr; self binaryMessage: rcvr assign: false].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑rcvr]<br></span><span style="font: italic 10pt serif">"keywordMessage"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">unaryMessage: rcvr assign: assign </span><span style="font: italic 10pt serif">"word ..."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| sel args<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[sel &larr; token. self advance.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">args &larr;</span><span class="tab" val="79"></span><span style="font: 10pt serif">[assign and⦂ type=aLeftArrow⇒ [sel &larr; sel + &rsquo;&larr;&rsquo;. self advance; expression] false].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑dest rcvr: rcvr selector: sel args: args]<br></span><span style="font: italic 10pt serif">"factor|messageChain"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Primary syntax</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">literal </span><span style="font: italic 10pt serif">"A Vector, UniqueString, String, or Number"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| t oldMark<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[type<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=aLeftPar⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[oldMark &larr; mark. self advance.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">t &larr; self read. type=aRightPar⇒ [self advance. ⇑t]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">mark &larr; oldMark. self notify: &rsquo;UNMATCHED&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">t &larr; [type≥aKeyword⇒ [token unique]; ≤aBinary⇒ [UST1◦(token+1)] token].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self advance. ⇑t]<br></span><span style="font: italic 10pt serif">"primary|read"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">primary<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[type<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=aWord⇒ [t &larr; dest variable: token. self advance. ⇑t];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=aLeftPar⇒ [⇑self subExpression];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=aNumber⇒ [t &larr; dest literal: token. self advance. ⇑t];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=aString⇒ [t &larr; dest literal: token. self advance. ⇑t];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=aHand⇒ [self advance.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">type=aRightPar or⦂ type=0⇒ [self notify: &rsquo;EXPECTED LITERAL&rsquo;]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑dest literal: self literal]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self notify: &rsquo;OBJECT EXPECTED&rsquo;]<br></span><span style="font: italic 10pt serif">"factor|expression"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">read </span><span style="font: italic 10pt serif">"A sequence of literals"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s &larr; (Vector new: 10) asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ (type=aRightPar or⦂ type=0) do⦂ [s next &larr; self literal].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑s contents]<br></span><span style="font: italic 10pt serif">"literal"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">subExpression </span><span style="font: italic 10pt serif">"(...)"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| expr<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self advance. expr &larr; self expression.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">type=aRightPar⇒ [self advance. ⇑expr]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self notify: &rsquo;NOT EXPECTED IN A (SUBEXPRESSION)&rsquo;]<br></span><span style="font: italic 10pt serif">"primary"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Suspension</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">advance </span><span style="font: italic 10pt serif">"Switch from the parser to the reader to obtain another token."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[mark &larr; source position- [type&gt;aBinary⇒ [1] 0].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">oppositeCourt &larr; thisContext swapSender: oppositeCourt]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">mustBeDone<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[type=0⇒ [self terminate] self notify: &rsquo;UNEXPECTED CONSTRUCT&rsquo;]<br></span><span style="font: italic 10pt serif">"Generator compile|Generator evaluate"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">notify: errorString </span><span style="font: 10pt serif">| delims<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[source skip: mark - source position.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">delims &larr; ↪(011 012  014 015 040).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ (delims has: source peek) do⦂ [source next].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[source myend≡false⇒ [source skip: 1]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dest abortWith: errorString]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">resume </span><span style="font: italic 10pt serif">"The reader has supplied another token; resume the parser."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[oppositeCourt &larr; thisContext swapSender: oppositeCourt]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">terminate<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[dest≡nil⇒ [] dest terminate. dest &larr; nil].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[oppositeCourt≡nil⇒ [] oppositeCourt release. oppositeCourt &larr; nil]]<br></span><span style="font: italic 10pt serif">"mustBeDone|Generator abortWith|Context variableNamesInto"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪Parser under: &rsquo;Compiler&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"ParseStack"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;ParseStack&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;position length&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I keep track of the current and high position of the stack that will be needed by code being compiled.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[length &larr; position &larr; 0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Changes</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pop: n<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(position &larr; position - n) &lt; 0⇒ [user notify: &rsquo;Parse stack underflow&rsquo;]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">push: n<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(position &larr; position + n) &gt; length⇒ [length &larr; position]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Results</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">length<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑length]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">position<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑position]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪ParseStack under: &rsquo;Compiler&rsquo;.</span></div>
<script>function do_tabs() { // unit = px
  var tabs = document.getElementsByClassName("tab");
  for (var i = 0; i < tabs.length; ++i) {
    var span = tabs[i];
    var val = span.getAttribute("val");
    if (val == null) console.log("Couldn't get val");
    var rect = span.getBoundingClientRect();
    var tabstop;
    if (val > 0) tabstop = Math.ceil(rect.left / val) * val;
    else tabstop = -val;
    console.log("do_tabs", val, tabstop)
    if (tabstop > 0) {
      var width = tabstop - rect.left;
      span.style.display = "inline-block";
      span.style.width = width + "px";
    }
  }
}
do_tabs();
</script>
  </body>
</html>
