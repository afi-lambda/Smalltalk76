<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN">
<html>
  <head>
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
    <title>Smalltalk76/Ethernet-Control.st</title>
  </head>
  <body>
    <div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">&rsquo;From Smalltalk 5.5k XM November 24 on 22 November 1980 at 2:57:08 am.&rsquo;<br></span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">"Etherworld"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;Etherworld&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sharing: EtherPool;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>This is, of course, the class that controls all of the basic ethernet operations.  There should not be more than one EtherWorld, and one, E, has to be defined for the system to work.    <br><br>In this implementation, and due to timing considerations, it is expected that the transmitter will post quite quickly;  thus, we disable interrupts and busy wait for its completion.<br><br>In general, the interrupt is only armed when we have started the receiver.  The Etherworld currently uses these input processes in the PrioityScheduler: <br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">IntProc, at IntProcLevel (14)  -- awakened when the device interrupts<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">InputProc, at InputProcLevel (13) -- distributes packets to sockets, <br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">allowing each  socket to then run.<br><br>Note that some of the timers may be on other levels.<br><br>The ethernet can be in one of several states:<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">if E ≡ nil, there is nothing<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">if E ~≡ nil, etherState can be ethAwake, ethAsleep, ethDead.<br><br>ethDead means E created, and classInit done, but nothing else.<br>ethAsleep means all data structures created, but no attempt to start.<br>ethAwake means it is up and running.<br><br>The messages wakeup,  sleep and kill move to one of those states.<br>Other messages are used for single transitions from adjacent states.<br><br>If you just want to temporarily prevent the device from running use etherStop and etherStart.<br>Should go to ethAsleep (use E sleep) if you quit, since may come up on a different machine.<br><br>The lights on the right side of the screen are Etherworld signals.  They mean  Etherworld awakened; packet addressed to the Alto received; packet being processed; output being sent; and input rejected.<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization/Termination</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit <br></span><span style="font: 10pt serif">[<br>"if this needs to be filed in again, execute this first<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Smalltalk declare: ↪EtherPool as: (SymbolTable new init: 32).<br><br>access variables from outside with (for example) with EtherPool◦↪ethAwake"<br><br>Smalltalk declare: ↪(E).<br><br>EtherPool declare: ↪( ethInPacNext checkIncomingCS  <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">IntProcLevel InputProcLevel ethIntBits<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">etherState ethAwake ethAsleep ethDead)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">as: (false,false,14,13,020,0,3,1,0).<br><br>EtherPool declare: ↪(  <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">NETNUM ALTONUM <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">freeQ justArrivedQ   <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sockeTable routingTable routingHopCount routingUpdateUser<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">IntProc InputProc broadcastFilter <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">IntLight InputLight OutputLight )]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">etherStart </span><span style="font: 10pt serif">"allows ether to start running again"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"makes sure the interrupt is on, and kicks the device"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">etherState=ethAwake ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[mem◦0601=0⇒ [mem◦0601&larr;ethIntBits]]. <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self SIO: 3.   "forces it to wake up again"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self notify: &rsquo;Attempt to etherStart when not awake!!.&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">etherStop </span><span style="font: 10pt serif">"temporarily shuts off the ether stuff"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">Top critical⦂ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">mem◦0601&larr;0.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self SIO: 3.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">mem◦0600 &larr; 0.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">Init </span><span style="font: 10pt serif">| i "</span><span style="font: italic 10pt serif">move from state ethDead to ethAsleep</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">if we were already running, bring it all down, just in case!!</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[etherState=ethDead ⇒ [] self kill]. "</span><span style="font: italic 10pt serif">now sure we are ethDead</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">NETNUM &larr; ALTONUM&larr;0.  "may get reset later"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self setLights.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(justArrivedQ&larr;(SafeQ new) of: (Vector new: 20)) enable.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[freeQ⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(freeQ&larr; (SafeQ new) of: (Vector new: 20)) enable.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: 10 do⦂ [freeQ next&larr; Pacbuf init]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">justArrivedQ disable].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ethInPacNext&larr; self freePacket.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sockeTable&larr; Dictionary new init: 10. <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">routingTable&larr; String new: 255.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">routingTable all &larr; 0. "1-255, 0 is special"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">routingHopCount &larr; String new: 255.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">routingHopCount all &larr; 8.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">routingUpdateUser &larr; RoutingUpdater init.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self installIntProc.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self installInputProc.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">IntProc enable.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">InputProc enable.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">etherState &larr; ethAsleep.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"we are still asleep, must do a wakeup to get numbers, start, etc."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">kill | socket </span><span style="font: 10pt serif">"shuts down ethernet and PUP world completely"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"Should free up all of the storage, etc.....<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">Would need to wakeup or Init, to get started again.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">Device may have been running"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">etherState=ethDead⇒[] "do nothing"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[etherState=ethAwake ⇒ [self sleep]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"everything now shut down"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ socket from: (sockeTable values) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[socket≡nil⇒[] socket kill]. <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">Top terminate: IntProcLevel; terminate: InputProcLevel.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">ethInPacNext⇒ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">ethInPacNext≡nil⇒ []<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">ethInPacNext locked⇒[ethInPacNext unlock]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">ethInPacNext &larr; false.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"Release the PQueues to avoid circular data structures"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[freeQ and⦂ freeQ≠nil⇒[freeQ release. freeQ &larr; nil]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[justArrivedQ≠nil⇒[justArrivedQ release. justArrivedQ &larr; nil]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[routingUpdateUser≡ nil⇒ [] routingUpdateUser release].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">routingUpdateUser &larr; routingTable &larr; routingHopCount &larr; nil.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">etherState &larr; ethDead.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">setLights<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[IntLight&larr; Rectangle new origin: 576⌾0 extent: 16⌾16.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">InputLight&larr; Rectangle new origin: 592⌾0 extent: 16⌾16.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">OutputLight&larr;Rectangle new origin: 576⌾16 extent: 16⌾16]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sleep </span><span style="font: 10pt serif">| socket "be sure to do this before a user quit" <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">etherState=ethDead ⇒ [self Init] "that is, go from dead to asleep"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">etherState=ethAsleep ⇒ [] "already asleep"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">etherState=ethAwake ⇒ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">["try to shut down gracefully"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ socket from: (sockeTable values) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[socket≡nil⇒[] socket sleep]. "warn the sockets, leaves them in table"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self etherStop.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">etherState&larr;ethAsleep.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"when next we wake up, may be on a new machine/net"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"when next we wake up, may be on a new machine/net"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">wakeup </span><span style="font: 10pt serif">| socket "Try to get everything up and running" <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">etherState=ethAwake ⇒ [self etherStart] "do nothing, kick the receiver".<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[etherState=ethDead ⇒ [self sleep]]. "that is, go from dead to asleep"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">etherState=ethAsleep ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">["this is the tricky one, need to get our machine # and routing table.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">may have come up on a different network and host, assume the worst"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">ALTONUM &larr; self getMachineID.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self setMachineID: ALTONUM.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">NETNUM &larr; 0.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ socket from: sockeTable values do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">socket≡nil⇒ [] socket setOutAddBlock].<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">etherState &larr; ethAwake.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self etherStart.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">routingUpdateUser update.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">NETNUM = 0⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">etherState &larr; ethAsleep.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: &rsquo;no routing tables&rsquo;]<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"tell leftover sockets current net&host, and that we are awake again"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ socket from: (sockeTable values) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[socket≡nil⇒[] socket setOutAddBlock; wakeup]. <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self notify: &rsquo;In wakeup, found Ethernet in some unknown state.&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Input Interrupt Routines</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">copyinput: string </span><span style="font: 10pt serif">[user croak] primitive: 108</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">installInputProc </span><span style="font: 10pt serif">| inBuf destSoc [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">InputProc &larr; Top install⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ [true] do⦂ [  "</span><span style="font: italic 10pt serif">infinite loop for process in scheduler</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">InputLight comp. <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ [inBuf&larr;justArrivedQ next] do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">process each incoming buffer, know it&rsquo;s a PUP</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">verify the incoming checksum</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">checkIncomingCS and⦂ (inBuf checksumOK)≡false⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">reject it, done</span><span style="font: 10pt serif">" self freePacket: inBuf]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">To be honest, we should check the destNet and destHost,<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">but they generally have to be OK.....<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">OK to pass the packet on</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(destSoc &larr; sockeTable lookup: inBuf destSocNum) ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ destSoc acceptPacbuf: inBuf].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">couldn&rsquo;t find a socket for it, done</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self freePacket: inBuf]. <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">InputLight comp. <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">InputProc sleep   "</span><span style="font: italic 10pt serif">last action in the loop</span><span style="font: 10pt serif">"]] <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">at: InputProcLevel]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">installIntProc  </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">IntProc &larr; Top install⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ [true] do⦂ [  "</span><span style="font: italic 10pt serif">infinite loop for process in scheduler.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Interrupt just happened, running at a high level, interface off.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Something just happened, do the common cases first.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Input is wired down below; only comes here if OK.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Note: we can only come here if last action was to start the rec!!</span><span style="font: 10pt serif">"<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">IntLight comp. <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">copy out the packet first</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ethInPacNext ⇒[self copyinput: ethInPacNext pupString]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"user cr; show: &rsquo;warning, no packet pre-fetched. tell John&rsquo;."<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">ethInPacNext &larr; self freePacket⇒ [self copyinput: ethInPacNext pupString]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"user cr; show: &rsquo;input lost&rsquo;"].<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">start the receiver</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self SIO: 2.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ethInPacNext⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">now process this input</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">justArrivedQ next&larr; ethInPacNext. <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">ethInPacNext &larr; self freePacket.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">Top wakeup: InputProcLevel.  "</span><span style="font: italic 10pt serif">all done</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]].<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">IntLight comp. <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">IntProc sleep    "</span><span style="font: italic 10pt serif">last action in the loop</span><span style="font: 10pt serif">"]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">at: IntProcLevel]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Output Routines</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">doOutput: string </span><span style="font: 10pt serif">[] primitive: 100</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sendOutput: ethOutPac </span><span style="font: 10pt serif">| post<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">This is the one and only place from which we  send output.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Only one packet gets passed in to us at a time.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">For performance, we wait here for the transmitter to post!!!!<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Nominally, we are running at level 0;  thus, this must be run<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">at a Top critical, to protect from multiple calls.</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[etherState≠ethAwake ⇒ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self wakeup. user show: &rsquo;starting Ethernet...&rsquo;]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">Top critical⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">OutputLight comp. <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">mem◦0606&larr; (ethOutPac totLengthWords)."EthOutCntLoc"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(post &larr; self doOutput: ethOutPac pupString) ≠ 0777 ⇒ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user cr; show: &rsquo;Warning, bad output post: &rsquo;+ post base8]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">OutputLight comp. <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]. "end of the critical part"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>User messages</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">awake </span><span style="font: 10pt serif">[⇑etherState = ethAwake]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">broadcastFilter: val<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[val ⇒ [broadcastFilter&larr;true. self broadcastFilterSet: 1] <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">broadcastFilter &larr; false.  self broadcastFilterSet: 0.]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">broadcastFilterSet: val<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user croak ] primitive: 107</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">freePacket </span><span style="font: 10pt serif">| p [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">get a packet</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">freeQ⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(p &larr; freeQ next) ⇒ [⇑p]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user show: &rsquo;Warning, empty freeQ, in Etherworld&rsquo;.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑Pacbuf new init]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">freePacket: p </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">put a used packet into free queue</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[freeQ and⦂ p⇒ [freeQ next &larr; p]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Utility messages</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">error: str </span><span style="font: 10pt serif">[user cr. user show: str]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fill </span><span style="font: 10pt serif">| "I want to replenish the freeQ" outstanding [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">freeQ≡false or⦂ freeQ≡nil⇒ []<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outstanding &larr; (Pacbuf howMany) - (freeQ length).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user cr; show: (outstanding asString)+&rsquo; packets outstanding&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ [freeQ length=10] do⦂ [freeQ next &larr; Pacbuf init].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">getMachineID  </span><span style="font: 10pt serif">[⇑ (self SIO: 0) \ 256]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">notify: strng </span><span style="font: 10pt serif">| "turn off the Ethernet before doing a user notify" <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self etherStop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user show: &rsquo; Etherworld stopped&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> [Top currentPriority ≠ 1⇒[user cr; show: &rsquo;priority is &rsquo; + (Top currentPriority) asString.  ]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> user notify: strng]<br></span><span class="tab" val="79"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: s </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">etherState = ethDead ⇒ [s append: &rsquo;Etherworld,  etherState = ethDead.&rsquo;].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s append: &rsquo;Etherworld running on &rsquo;; print: NETNUM;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">append: &rsquo;#&rsquo;+(ALTONUM base8)+&rsquo;#&rsquo; ; cr.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[freeQ⇒ [s print: freeQ length; append: &rsquo; Pacbufs in freeQ&rsquo;]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s append: &rsquo;no freeQ&rsquo;].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s cr; append: &rsquo;etherState = &rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">etherState = ethAsleep ⇒ [s append: &rsquo;etherAsleep&rsquo;].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">etherState = ethAwake ⇒ [s append: &rsquo;etherAwake&rsquo;].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s print: etherState.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printRoutingTable </span><span style="font: 10pt serif">| </span><span style="font: bold 10pt serif">i </span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: 1 to: 255 do⦂ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">routingTable◦i ≠ 0 ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user cr.  user show: &rsquo;To net &rsquo; + i asString + <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo; via host &rsquo; + (routingTable◦i) asString + &rsquo;, hop count = &rsquo; +<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(routingHopCount◦i) asString.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user cr.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">] </span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printSocketTable </span><span style="font: 10pt serif">| i [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sockeTable≡nil⇒[user cr; show: &rsquo;no socketTable&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: sockeTable objects do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">i≡nil⇒[]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user cr; print: i; show: &rsquo;, &rsquo;; print: sockeTable◦i<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">setMachineID: ID </span><span style="font: 10pt serif">[mem◦0610 &larr; ID]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">SIO: sioArg </span><span style="font: 10pt serif">[] primitive: 91</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪Etherworld under: &rsquo;Ethernet Control&rsquo;.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">Etherworld classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"Int32"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;Int32&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Number<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;high low&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>This class should probably be part of Number rather than Etherworld.<br>NOTE THAT + AND - SHOULD BE FIXED TO RETURN TO SMALLTALK IF TYPE OF ARG IS NOT INT32</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asInteger </span><span style="font: 10pt serif">[high = 0 ⇒ [⇑ low] ⇑high*65536 + low]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">high: high low: low</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Info about self</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hash </span><span style="font: 10pt serif">[⇑ low]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">high </span><span style="font: 10pt serif">[⇑ high]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">low </span><span style="font: 10pt serif">[⇑ low]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[high printon: strm base: 8. strm append: &rsquo;|&rsquo;. low printon: strm base: 8 ]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Arithmetic</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">≠ arg </span><span style="font: 10pt serif">[⇑ low ≠ arg low or⦂ high ≠ arg high]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">+ arg </span><span style="font: 10pt serif">[⇑self + arg asInt32] primitive: 93</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">- arg </span><span style="font: 10pt serif">[⇑self - arg asInt32] primitive: 92</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">&lt; arg </span><span style="font: italic 10pt serif">"revised M. Dolbec 6/25/80"</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[high = arg high⇒ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[low &lt; 0 ⇒ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[arg low &lt; 0 ⇒ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑low &gt; arg low]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">arg low &gt; 0 ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑low &lt; arg low] <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑true]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑high &lt; arg high]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">= arg </span><span style="font: 10pt serif">[⇑low = arg low and⦂ high = arg high]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">&gt; arg </span><span style="font: italic 10pt serif">"revised M. Dolbec 6/25/80"</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑arg &lt; self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪Int32 under: &rsquo;Ethernet Control&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"Pacbuf"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;Pacbuf&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;pupString locked&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>This is the basic unit for building and interpreting packets for the ethernet.<br>It contains the messages that allow fields of a packet to be filled and read.<br>Most users will prefer to use the socket mechanisms</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pupString &larr; String new: 558.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">locked &larr; false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Ethernet header</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">ethType </span><span style="font: 10pt serif">[⇑pupString word: 2]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">ethType&larr; eT </span><span style="font: 10pt serif">[pupString word: 2 &larr; eT]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">imEthDestHost </span><span style="font: 10pt serif">[⇑pupString◦1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">imEthDestHost&larr; iEDH </span><span style="font: 10pt serif">[pupString◦1 &larr; iEDH]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">imEthSrcHost </span><span style="font: 10pt serif">[⇑pupString◦2]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">imEthSrcHost&larr; iESH </span><span style="font: 10pt serif">[pupString◦2 &larr; iESH]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>PUP Header</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">addressBlock </span><span style="font: 10pt serif">[⇑pupString◦(13 to: 24) ]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">addressBlock&larr; addBlock </span><span style="font: 10pt serif">"for quickly setting the 6 fields" [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"pupString◦(13 to: 24) &larr; addBlock"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pupString copy: 13 to: 24 with: addBlock from: 1 to: 12]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">destHost </span><span style="font: 10pt serif">[⇑pupString◦14]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">destHost&larr; dH </span><span style="font: 10pt serif">[pupString◦14 &larr; dH]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">destNet </span><span style="font: 10pt serif">[⇑pupString◦13]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">destNet&larr; dN </span><span style="font: 10pt serif">[pupString◦13 &larr;  dN]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">destSoc0 </span><span style="font: 10pt serif">[⇑pupString word: 8]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">destSoc0&larr; i </span><span style="font: 10pt serif">[⇑pupString word: 8&larr;i]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">destSoc1 </span><span style="font: 10pt serif">[⇑pupString word: 9]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">destSoc1&larr; i </span><span style="font: 10pt serif">[⇑pupString word: 9&larr;i]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">destSocNum </span><span style="font: 10pt serif">[⇑Int32 new high: (pupString word: 8) low: (pupString word: 9) ]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">destSocNum&larr; dSN </span><span style="font: 10pt serif">[pupString word: 8 &larr; dSN high.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> pupString word: 9 &larr; dSN low]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pupID </span><span style="font: 10pt serif">[⇑Int32 new high: (pupString word: 5) low: (pupString word: 6) ]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pupID0 </span><span style="font: 10pt serif">[⇑pupString word: 5 ]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pupID0&larr; pID </span><span style="font: 10pt serif">[⇑pupString word: 5 &larr; pID ]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pupID1 </span><span style="font: 10pt serif">[⇑pupString word: 6 ]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pupID1&larr; pID </span><span style="font: 10pt serif">[⇑pupString word: 6 &larr; pID ]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pupID&larr; pID </span><span style="font: 10pt serif">[pupString word: 5 &larr; pID high.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> pupString word: 6 &larr; pID low]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pupLength </span><span style="font: 10pt serif">[⇑pupString word: 3]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pupLength&larr; pL </span><span style="font: 10pt serif">[⇑pupString word: 3 &larr; pL]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pupType </span><span style="font: 10pt serif">[⇑pupString◦8]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pupType&larr; pT </span><span style="font: 10pt serif">[pupString◦8 &larr; pT]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sourceHost </span><span style="font: 10pt serif">[⇑pupString◦20]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sourceHost&larr; sH </span><span style="font: 10pt serif">[pupString◦20 &larr; sH]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sourceNet </span><span style="font: 10pt serif">[⇑pupString◦19]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sourceNet&larr; sN </span><span style="font: 10pt serif">[pupString◦19 &larr; sN]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sourceSoc0 </span><span style="font: 10pt serif">[⇑pupString word: 11]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sourceSoc0&larr; i </span><span style="font: 10pt serif">[⇑pupString word: 11&larr;i]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sourceSoc1 </span><span style="font: 10pt serif">[⇑pupString word: 12]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sourceSoc1&larr; i </span><span style="font: 10pt serif">[⇑pupString word: 12&larr;i]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sourceSocNum </span><span style="font: 10pt serif">[⇑Int32 new high: (pupString word: 11) low: (pupString word: 12)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sourceSocNum&larr; sSN </span><span style="font: 10pt serif">[pupString word: 11 &larr; sSN high.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> pupString word: 12 &larr; sSN low]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">swapPorts </span><span style="font: 10pt serif">| i [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: 13 to: 18 do⦂ [pupString swap: i with: i+6]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">totLengthWords </span><span style="font: 10pt serif">[⇑((self pupLength)+5)/2]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">transportControl </span><span style="font: 10pt serif">[⇑pupString◦7]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">transportControl&larr; tC </span><span style="font: 10pt serif">[pupString◦7 &larr; tC]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>PUP Checksum</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">checksum  </span><span style="font: 10pt serif">[⇑pupString word: ((self pupLength+1)/2)+2]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">checksumOK </span><span style="font: 10pt serif">"Boolean, returns true or false"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["just look at the current packet"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self checksum = self doChecksum]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">checksum&larr;  cs <br></span><span class="tab" val="79"></span><span style="font: bold 10pt serif"> </span><span style="font: 10pt serif">[pupString word: (((self pupLength+1)/2)+2) &larr; </span><span style="font: bold 10pt serif">cs</span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">doChecksum </span><span style="font: 10pt serif">| i cs <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">cs &larr; 0. <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: (3 to: (((self length + 1)/2)+2)) do⦂ "does not work"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[cs&larr;cs+(pupString word: i). </span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">   "for packets with carries"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[cs &lt;0⇒[cs &larr; (cs lshift: 1)+1] cs &larr; cs lshift: 1]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[cs=¬1⇒[cs &larr; 0]]. <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑cs<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">] primitive: 94 </span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Data </span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dataLength </span><span style="font: 10pt serif">[⇑(pupString word: 3) "self pupLength" - 22]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dataLength&larr; len </span><span style="font: 10pt serif">[⇑pupString word: 3 "self pupLength" &larr; len + 22]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dataString </span><span style="font: 10pt serif">[⇑pupString copy: 25 to: 24+self dataLength]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dataString&larr; str </span><span style="font: 10pt serif">| i [</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; str length.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &gt; 532 ⇒ [user notify: &rsquo;Data string too big for single PUP&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pupString copy: 25 to: 24 + i with: str from: 1 to: i.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self dataLength &larr; i.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑str]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dataWord: i </span><span style="font: 10pt serif">[⇑pupString word: i + 12]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dataWord: i &larr; v </span><span style="font: 10pt serif">[⇑pupString word: i + 12 &larr; v]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Etc</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">◦ i </span><span style="font: 10pt serif">[⇑pupString◦i]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">◦ i &larr; v </span><span style="font: 10pt serif">[⇑pupString◦i &larr; v]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">header </span><span style="font: 10pt serif">[⇑pupString◦(1 to: 24) ]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">lock </span><span style="font: 10pt serif">[locked⇒[E notify: &rsquo;trying to lock a buffer already locked&rsquo;]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">locked&larr;true. ⇑pupString lock]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">locked </span><span style="font: 10pt serif">[⇑locked]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">lockwith: string </span><span style="font: 10pt serif">[locked⇒[E notify: &rsquo;trying to lock a buffer already locked&rsquo;]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">locked&larr;string. ⇑pupString lock]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pupString  </span><span style="font: 10pt serif">[⇑pupString]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pupString &larr; pupString </span><span style="font: 10pt serif">[⇑pupString]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">unlock </span><span style="font: 10pt serif">[locked⇒[locked&larr;false.  pupString unlock]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: &rsquo;trying to unlock a buffer not locked&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">word: i </span><span style="font: 10pt serif">[⇑pupString word: i]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">word: i &larr; v </span><span style="font: 10pt serif">[⇑pupString word: i &larr; v]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪Pacbuf under: &rsquo;Ethernet Control&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"SafeQ"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;SafeQ&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: PQueue<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;enabled&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>checks all objects enqueued, to be sure not there already</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>As yet unclassified</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">disable </span><span style="font: 10pt serif">[enabled &larr; false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">enable </span><span style="font: 10pt serif">[enabled &larr; true]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">length </span><span style="font: 10pt serif">[⇑position - readposition]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">next &larr; arg </span><span style="font: 10pt serif">| i "short comment" [[enabled⇒<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: (readposition+1) to: position do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(array◦i)≡arg⇒[E notify: &rsquo;putting same guy on Q twice&rsquo;]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">arg locked⇒[E notify: &rsquo;putting locked Pacbuf on Q&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">super next &larr; arg<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">status </span><span style="font: 10pt serif">[⇑enabled]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪SafeQ under: &rsquo;Ethernet Control&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"Socket"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;Socket&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;socNumber computeOutgoingCS filterInput outAddBlock<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">lclSocNum frnNet frnHost frnSocNum&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sharing: EtherPool;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>Sockets are used to do all communication through the net.  <br>It is expected that a specialized server or process can have<br>its own subclass of Socket with its own definitions of the<br>&rsquo;Overwrite by Subclass&rsquo; operations.  Note that subclasses will<br>have to access some global variables. <br><br>Each socket is identified by a 32-bit lclSocNum, which really<br>defines who we are.<br>In addition, aspects of the lcl and frn addresses are used  to make<br>decisions about accepting<br>incoming packets, addressing outgoing packets, defaulting fields, etc.<br><br>The input distributor assures that an input was destined for our net<br>(not trying to<br>find a gateway) and our host (either explicitly or as broadcast, <br>if not filtered), and found us by socket number.  Input need NOT be<br>filtered by the socket according to source, since the client may want<br>to see error messages from an intermediate address.<br><br>As a convenience, however, the socket can be asked to filterInput,<br>so it only accepts things which match the frnPort.<br>Thus, local and foreign attributes are primarily used to default<br>fields of an outgoing  packet.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">default <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["default local socket number and leave frn port open"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self net: 0 host: 0 soc: (Int32 new high: 0 low: 0)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">from: lclSocNum  <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["set lcl soc number, leave frnPort open -- useful for creating<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">a well-known socket as a listener"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self from: lclSocNum net: 0 host: 0 soc: (Int32 new high: 0 low: 0)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">from: lclSocNum net: frnNet host: frnHost soc: frnSocNum <br></span><span class="tab" val="79"></span><span style="font: bold 10pt serif"> </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"this is the most general initialization, both lcl soc# and frnPort given"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outAddBlock &larr; String new: 12.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self setOutAddBlock.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">computeOutgoingCS &larr; filterInput &larr; false. <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sockeTable insert: lclSocNum with: self.  "put me in socket table"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self doMoreInit<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hostName: name </span><span style="font: 10pt serif">| a nh [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">lookup name, then set net and host numbers (maybe socket?)</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">a &larr; NameUser init.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nh &larr; a getAddressBlock: name.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">since this socket may get many responses,<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">make sure socket is not half deleted from sockeTable after first response</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Top critical⦂ [a close].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nh⇒ [self net: nh◦1 host: nh◦2]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"invalid name?"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">net: frnNet host: frnHost soc: frnSocNum </span><span style="font: 10pt serif">[</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"default the local socket number:<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">use some memory dependent info (space) for the high word so that no two<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">sockets (instances) can be the same, also non-zero.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">use time for low word, so that same instance will not usually have the<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">same socket number (odds = 1/65536)"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">lclSocNum &larr; Int32 new high: self nail low: user ticks.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self unNail; from: lclSocNum net: frnNet host: frnHost soc: frnSocNum<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">setOutAddBlock<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outAddBlock◦1 &larr; frnNet. outAddBlock◦2 &larr; frnHost.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outAddBlock word: 2 &larr; frnSocNum high.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outAddBlock word: 3 &larr; frnSocNum low.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outAddBlock◦7 &larr; NETNUM. outAddBlock◦8 &larr; ALTONUM.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outAddBlock word: 5 &larr; lclSocNum high.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outAddBlock word: 6 &larr; lclSocNum low.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">to: h </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">convenient default if on my net</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self net: NETNUM host: h]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">wakeup </span><span style="font: 10pt serif">| "when E goes from ethAsleep to ethAwak" <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[  ]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Process incoming packet</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">acceptPacbuf: Ipac </span><span style="font: 10pt serif">| temp<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["if we get here, we know that the input distributer has verified the<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">PUP dest as being us (or a broadcast, if broadcast filter is off).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">We do not have responsibility for verifying incoming checksum.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">First, check if we&rsquo;ve been asked to filter by source:"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">filterInput and⦂ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(</span><span class="tab" val="79"></span><span style="font: 10pt serif">(frnNet ≠ Ipac sourceNet) or⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">  ((frnHost ≠ Ipac sourceHost) or⦂ (frnSocNum ≠ Ipac sourceSocNum))<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ⇒ [⇑self socDispose: Ipac]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"It&rsquo;s good, take it..."<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self socProcess: Ipac<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Process outgoing packet</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">broadcast: packet to: socNumber</span><span style="font: 10pt serif">| "I want to broadcast this packet" [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self setAddresses: packet.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">packet<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">destHost&larr;0;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">destNet&larr;0;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">destSoc0&larr;socNumber high;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">destSoc1&larr;socNumber low.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"I assume that the length and type have been done"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self completePup: packet.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">completePup: pac </span><span style="font: 10pt serif">| </span><span style="font: bold 10pt serif">t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"the user must have set all 6 address fields,ID, length, and type"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"Now route the packet appropriately, assuming we have Ethernet..."<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">NETNUM =  pac destNet ⇒  [pac imEthDestHost &larr;pac destHost] <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"most common case"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">0 = pac destNet ⇒ [pac imEthDestHost &larr; 0] "broadcast"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">0 = (t &larr; routingTable◦(pac destNet)) ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user show: &rsquo;<br>Inaccessible destination net: &rsquo; + pac destNet asString+ &rsquo;, packet not sent.&rsquo;.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑pac.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pac imEthDestHost &larr; t.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pac imEthSrcHost &larr; ALTONUM.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pac ethType &larr; 01000.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pac transportControl&larr; 0. <br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"as a socket we have an option about computing outgoing checksums"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pac checksum &larr; [computeOutgoingCS⇒[pac doChecksum] ¬1].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"Fix this up later......"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">E sendOutput: pac.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑pac<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">defaultAddresses: pac   </span><span style="font: 10pt serif">"overwrites any fields which are 0"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pac destNet = 0 ⇒ [pac destNet &larr; frnNet]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pac destHost = 0 ⇒ [pac destHost &larr; frnHost]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(pac destSoc0 = 0) and: (pac destSoc1=0) ⇒ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pac destSocNum &larr; frnSocNum]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pac sourceNet = 0 ⇒ [pac sourceNet &larr; NETNUM]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pac sourceHost = 0 ⇒ [pac sourceHost &larr; ALTONUM]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(pac sourceSoc0 = 0) and: (pac sourceSoc1 = 0) ⇒ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pac sourceSocNum &larr; lclSocNum]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">defaultAndComplete: pac<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self defaultAddresses: pac.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self completePup: pac.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">setAddresses: pac </span><span style="font: 10pt serif">[pac addressBlock &larr; outAddBlock]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">setAddressesAndComplete: pac <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pac addressBlock &larr; outAddBlock.  self completePup: pac]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Access to Parts</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">close </span><span style="font: 10pt serif">[self release.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sockeTable lookup: lclSocNum⇒[sockeTable delete: lclSocNum]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">computeOutgoingCS </span><span style="font: 10pt serif">[⇑</span><span style="font: bold 10pt serif">computeOutgoingCS</span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">computeOutgoingCS&larr; computeOutgoingCS </span><span style="font: 10pt serif">[⇑</span><span style="font: bold 10pt serif">computeOutgoingCS</span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">disable  </span><span class="tab" val="79"></span><span style="font: 10pt serif">["left for compatibility" user show: &rsquo;unnecessary disable&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self close.]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">enable </span><span style="font: 10pt serif">["now a no-op" user show: &rsquo;someone did unnecessary enable&rsquo;. self print]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">filterInput  </span><span style="font: 10pt serif">[⇑filterInput]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">filterInput&larr; filterInput </span><span style="font: 10pt serif">[⇑filterInput ]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">freePacket </span><span style="font: 10pt serif">| p [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">get a packet</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">freeQ⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(p &larr; freeQ next)⇒ [⇑p]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user show: &rsquo;Warning, empty freeQ, in Socket&rsquo;.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑Pacbuf new init]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">freePacket: p </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">put a used packet into free queue</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[freeQ and⦂ p⇒ [freeQ next &larr; p]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">frnHost </span><span style="font: 10pt serif">[⇑frnHost]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">frnHost&larr; frnHost </span><span style="font: 10pt serif">[⇑frnHost]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">frnNet </span><span style="font: 10pt serif">[⇑frnNet]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">frnNet&larr; frnNet </span><span style="font: 10pt serif">[⇑frnNet]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">frnSocNum </span><span style="font: 10pt serif">[⇑frnSocNum]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">frnSocNum&larr; frnSocNum </span><span style="font: 10pt serif">[⇑frnSocNum]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">lclSocNum </span><span style="font: 10pt serif">[⇑lclSocNum]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">lclSocNum&larr; lclSocNum </span><span style="font: 10pt serif">[⇑lclSocNum]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Overwrite by Subclasses</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">doMoreInit</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">kill </span><span style="font: 10pt serif">["whole world about to go.  I don&rsquo;t care, but my subclasses might"]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">release </span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">disable Timers, undo circular structures etc.</span><span style="font: 10pt serif">"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sleep </span><span style="font: 10pt serif">["the user is quitting.  I don&rsquo;t care, but my subclasses might"]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">socDispose: Ipac </span><span style="font: 10pt serif">[self freePacket: Ipac]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">socProcess: Ipac </span><span style="font: 10pt serif">[self freePacket: Ipac]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪Socket under: &rsquo;Ethernet Control&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"RetransmitSocket"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;RetransmitSocket&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Socket<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;retransTimer retransMax retransCount&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>An abstract socket for handling retransmission behavior</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Socket</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">release </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">retransTimer≡nil⇒ []<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">release circular structure</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">retransTimer disable. retransTimer &larr; nil]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">setAddressesAndComplete: pac </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">this may need to be bracketed as critical?</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pac addressBlock &larr; outAddBlock.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">start timer</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">retransCount &larr; 0. retransTimer reset.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self completePup: pac<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"self startTimer.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">super setAddressesAndComplete: pac"]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Timer</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">retransmit: retransMax every: delay </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">retransTimer &larr; Timer new.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">retransTimer for: delay action⦂ [self timerFired]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">startTimer </span><span style="font: 10pt serif">[retransCount &larr; 0. retransTimer reset]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">timerOff </span><span style="font: 10pt serif">[retransTimer≡nil⇒ [] retransTimer disable]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">timerOn </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">turn on timer if retry count has not been reached</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(retransCount &larr; retransCount + 1) ≤ retransMax ⇒ [retransTimer reset]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Subclass</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">timerFired </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">subclass should redefine this</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self timerOn⇒ ["</span><span style="font: italic 10pt serif">again, e.g. self completePup: pac"</span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">done</span><span style="font: 10pt serif">"]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪RetransmitSocket under: &rsquo;Ethernet Control&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"NameUser"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;NameUser&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: RetransmitSocket<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;resultType resultSet result outPac&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>Typical use: <br>   foo &larr; NameUser init.<br>   foo getAddressBlock: string.  --- returns 6-byte string<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">foo getAddressString.  --- returns string like 2#2#0<br>   foo close.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["create a NameUser, to socket 4, from a default local socket number"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">E wakeup.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self net: 0 host: 0 soc: 4 asInt32.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self retransmit: 2 every: 300]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Output requests</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">getAddressBlock: str </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">returns a string, 6 bytes: net/host/socket</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">result &larr; resultSet &larr; false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outPac &larr; self freePacket.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outPac pupType&larr; 0220; dataString&larr; str.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self setAddressesAndComplete: outPac.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ resultSet do⦂ [].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑result]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">getAddressString: str </span><span style="font: 10pt serif">| temp  "return string representation"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">temp &larr; self getAddressBlock: str ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑(temp◦1) base8 + &rsquo;#&rsquo; + (temp◦2) base8 + &rsquo;#&rsquo; +<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(temp word: 2) base8 + &rsquo;|&rsquo; +  (temp word: 3) base8.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">getName: str </span><span style="font: 10pt serif">| "convert string address back to host name"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["not implemented yet"]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Handle input</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">socProcess: Ipac </span><span style="font: 10pt serif">| i j best bestHops "overwrite from Socket"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"called from Ether stuff, running at a very high level"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["dummy block"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">resultSet ⇒ ["we are not waiting!!"]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"must be the answer, or an error"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self timerOff.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">resultSet &larr; true.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">0222 = Ipac pupType ⇒ "error"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">["user show: (Ipac dataString). "].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">0221 ≠ Ipac pupType ⇒ "error"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">["user show: &rsquo;unknown pup received by name user.&rsquo;"].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"an answer arrived"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">result &larr; Ipac dataString. "1 or more 6 byte blocks"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">result length = 6 ⇒ ["all done"].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"more than one, find the nearest address"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">best &larr; 1.  bestHops &larr; 16.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: 1 to: (result length) by: 6 do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">NETNUM = (result◦i) ⇒ [best &larr; i.  bestHops &larr; 0].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">j&larr; routingHopCount◦(result◦i).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">j &lt; bestHops ⇒ [best&larr;i. bestHops&larr;j].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">result &larr; result copy: best to: (best+5).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]"dummy block".<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"all done"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self freePacket: Ipac.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">timerFired  </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self timerOn⇒ [self completePup: outPac]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">resultSet &larr; true]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪NameUser under: &rsquo;Ethernet Control&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"RoutingUpdater"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;RoutingUpdater&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: RetransmitSocket<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;outPac resultSet&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>A specialized sub-class of Socket, designed to send out requests<br>for the current routing info, and update the routing table.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"create a new local soc number, broadcast to socket 2"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">super net: 0 host: 0 soc: 2 asInt32.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outPac &larr; self freePacket.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outPac pupType &larr; 0200.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outPac dataString &larr; &rsquo;&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self retransmit: 3 every: 300.<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Sending</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">update </span><span style="font: 10pt serif">| i <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: 255 do⦂ [routingTable◦i &larr; 0. routingHopCount◦i&larr;8].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">resultSet &larr; false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self setAddressesAndComplete: outPac.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ resultSet do⦂ []]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Overwrite from Socket</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">socProcess: pac </span><span style="font: 10pt serif">| block gateway net count i <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">an input has arrived, we are running at a higher level.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Check the packet type</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">if⦂ pac pupType = 0201 then⦂ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self timerOff.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">resultSet &larr; NETNUM &larr; pac sourceNet.<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">block &larr; pac pupString.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">gateway &larr; pac sourceHost.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: 25 to: 24+pac dataLength by: 4 do⦂ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">net &larr; block◦i. <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">count &larr; block◦(i+3) + 1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">count &lt; (routingHopCount◦net) ⇒ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[routingTable◦net &larr; gateway. routingHopCount◦net &larr; count]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self freePacket: pac<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">timerFired </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self timerOn⇒ [self completePup: outPac]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">resultSet &larr; true]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪RoutingUpdater under: &rsquo;Ethernet Control&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"RPPSocket"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;RPPSocket&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: RetransmitSocket<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;seqNum outPac ackOK abortTransfer inQ ackType transaction myStream eof&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I establish a reliable packet protocol for communication.<br>This is a sub-class of Socket, and uses many of its messages.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Intialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self retransmit: 10 every: 180.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">seqNum &larr; transaction &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outPac &larr; ackOK  &larr; false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">abortTransfer &larr; true. "stop an old timer from perhaps firing"]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Termination</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">release </span><span style="font: 10pt serif">[self reset. inQ &larr; false. super release]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">reset </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outPac &larr; self freePacket: outPac.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self timerOff]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Sending Data</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">send: myStream <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"Sends a whole stream, and an end sequence.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">let the caller hand in a stream, or a file already opened</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[outPac ⇒ [] outPac &larr; self freePacket].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">seqNum &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">abortTransfer &larr; eof &larr; false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ [eof or⦂ abortTransfer] do⦂ [self sendData].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">abortTransfer ⇒ [self reset. ⇑false]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"We hit the end of file, do the end sequence and close the connection"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self sendEndSequence ⇒ [⇑myStream] ⇑false.  "all done!"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sendBlock: str <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"Take the data from a string (1-532 bytes), send it out; uses outPac"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">outPac dataString &larr; str.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self sendPacket.  "tries to do it reliably"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">abortTransfer⇒[⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sendData </span><span style="font: 10pt serif">| i t buf len [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"send one packet of data from myStream"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">buf &larr; outPac pupString.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; 24.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"data bytes are 1-512, 25-536"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[myStream is: FileStream⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"read characters faster (should work especially well for the usual case:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">FileStreams starting on a page boundary, with page sizes of 512)"<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">len &larr; 512 - (myStream readString: buf from: i+1 to: i+512)]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"fill the buffer the slow, careful way"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ (i &lt; 536 and⦂ (t &larr; myStream next)) do⦂ [buf◦(i &larr;i+1) &larr; t]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">len &larr; i-24].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">eof &larr; len &lt; 512.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">len = 0⇒ ["empty packet. don&rsquo;t send"]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outPac pupType &larr; 030. "Data"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"set the packet length"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outPac dataLength &larr; len.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"send packet reliably or abort, then return"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self sendPacket. <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sendEndSequence<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"This will do the 3-way handshake, and close the connection.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">send end, wait for ack"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">outPac pupType &larr; 032. "end"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"set the packet length"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">outPac pupLength &larr; 22.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self sendPacket. "gets sent reliably, we hope"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">abortTransfer⇒[self reset. ⇑false].<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"send the last gratuitous end, do not try to retransmit"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self sendPacketOnce.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self reset.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑true.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sendPacket </span><span style="font: 10pt serif">| <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"general routine to send the outPac packet, maybe retransmit, get ack" <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ackOK &larr; abortTransfer &larr; false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outPac pupID1 &larr; seqNum. <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outPac pupID0 &larr; transaction. "pupID0 can be used by one of my subclasses"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self setAddressesAndComplete: outPac.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ [abortTransfer or⦂ ackOK] do⦂ [].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">seqNum &larr; seqNum + 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sendPacketOnce </span><span style="font: 10pt serif">| <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"special routine to send the outPac packet, no retransmission" <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outPac pupID1 &larr; seqNum. <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outPac pupID0 &larr; transaction. "pupID0 can be used by one of my subclasses"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self setAddressesAndComplete: outPac; timerOff.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Receiving Data</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Handle Input</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">process: packet </span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">my subclasses use this</span><span style="font: 10pt serif">" self freePacket: packet]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">socProcess: Ipac </span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">I have received a packet</span><span style="font: 10pt serif">" [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Ipac pupType = ackType ⇒[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[Ipac pupID1 = seqNum and⦂ Ipac pupID0 = transaction⇒[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">a legal acknowledgement</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self timerOff.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">ackOK &larr; true]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">an old acknowledgement</span><span style="font: 10pt serif">"].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self freePacket: Ipac]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">must be a trasmission started elsewhere</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self process: Ipac.]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Timer Interupts</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">timerFired </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"This piece of code only runs when a Timer fires;  <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Don&rsquo;t do an active return"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ackOK or⦂ abortTransfer⇒ ["This transaction has been terminated"]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self timerOn⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"retransmit"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self completePup: outPac]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user show: &rsquo;Excessive retransmits in RPP retransmit&rsquo; .<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">abortTransfer &larr; true]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪RPPSocket under: &rsquo;Ethernet Control&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"EFTPSender"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;EFTPSender&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: RPPSocket<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo; &rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>A specialized sub-class of RPPSocket, designed to send files to an<br>EFTP receiver.  By convention, the receiver will be on socket 020<br>There can only be one outstanding packet at a time, called outPac.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">net: n host: h<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"Each instance of an EFTPSender has a unique lclSocket, but<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">always goes to socket 020 of the receiver"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">super net: n host: h soc: (Int32 new high: 0 low: 020).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"unlike plain sockets, we only want acks from this dest."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">filterInput &larr; true.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self retransmit: 5 every: 180.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outPac &larr; false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">transaction &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ackType &larr; 031.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Receiving</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">process: packet </span><span style="font: 10pt serif">| error "The printer is trying to tell me something" [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">packet pupType = 033⇒[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"error 33!!!" error &larr; packet dataString.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self freePacket: packet.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user show: &rsquo;remote server aborted: &rsquo;; show: error◦(3 to: error length).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">abortTransfer&larr;true]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪EFTPSender under: &rsquo;Ethernet Control&rsquo;.</span></div>
<script>function do_tabs() { // unit = px
  var tabs = document.getElementsByClassName("tab");
  for (var i = 0; i < tabs.length; ++i) {
    var span = tabs[i];
    var val = span.getAttribute("val");
    if (val == null) console.log("Couldn't get val");
    var rect = span.getBoundingClientRect();
    var tabstop;
    if (val > 0) tabstop = Math.ceil(rect.left / val) * val;
    else tabstop = -val;
    console.log("do_tabs", val, tabstop)
    if (tabstop > 0) {
      var width = tabstop - rect.left;
      span.style.display = "inline-block";
      span.style.width = width + "px";
    }
  }
}
do_tabs();
</script>
  </body>
</html>
