<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN">
<html>
  <head>
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
    <title>Smalltalk.Sources.5.5k</title>
  </head>
  <body>
    <div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">&rsquo;From Smalltalk 5.5k XM November 24 on 22 November 1980 at 2:57:08 am.&rsquo;<br></span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">"Object"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;Object&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: nil<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>Object is the superclass of all classes.  It is an abstract class, meaning that it has no state, and its main function is to provide a foundation message protocol for its subclasses.  Three instances of this class are defined: nil, true, and false.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Comparison</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">≤ x </span><span style="font: 10pt serif">[⇑self&gt;x≡false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">≡ x </span><span style="font: 10pt serif">[⇑self≡x </span><span style="font: italic 10pt serif">"In case this is reached by perform:"</span><span style="font: 10pt serif">] primitive: 4</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">≠ x </span><span style="font: 10pt serif">[⇑self=x≡false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">≥ x </span><span style="font: 10pt serif">[⇑self&lt;x≡false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">= x </span><span style="font: 10pt serif">[⇑self≡x]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">and⦂ x </span><span style="font: 10pt serif">[self⇒[⇑x eval] ⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">and: x </span><span style="font: 10pt serif">[self⇒[⇑x] ⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">empty </span><span style="font: 10pt serif">[⇑self length = 0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">eqv: x </span><span style="font: 10pt serif">[x⇒[⇑self] ⇑self≡false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">or⦂ x </span><span style="font: 10pt serif">[self⇒[⇑true] ⇑x eval]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">or: x </span><span style="font: 10pt serif">[self⇒[⇑true] ⇑x]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sameAs: object<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self≡object]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">xor: x </span><span style="font: 10pt serif">[x⇒[⇑self≡false] ⇑self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Classification</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">class </span><span style="font: 10pt serif">[user croak] primitive: 27</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">is: x </span><span style="font: 10pt serif">[⇑self class≡x]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">Is: x  </span><span style="font: 10pt serif">"Is the class x a superclass or class of self"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self class ≡ x ⇒[⇑true]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self class Isa: x]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">isArray<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">isnt: x </span><span style="font: 10pt serif">[⇑(self class≡x) ≡ false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">Isnt: x<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑(self Is: x)≡false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">isNumber<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Construction</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">, x </span><span style="font: 10pt serif">| v<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[v &larr; Vector new: 2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">v◦1 &larr; self. v◦2 &larr; x.  ⇑v]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asParagraph </span><span style="font: 10pt serif">[⇑self asString asParagraph]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asStream </span><span style="font: 10pt serif">[⇑self asVector asStream]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asVector </span><span style="font: 10pt serif">| v<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self≡nil⇒[⇑Vector new: 0]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">v &larr; Vector new: 1. v◦1 &larr; self. ⇑v]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">copy</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"create new copy of self"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self is: Object⇒[⇑self]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self class copy: self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">inVector </span><span style="font: 10pt serif">| vec<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Return me as the sole element of a new Vector."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">vec &larr; Vector new: 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">vec◦1 &larr; self.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑vec]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">recopy</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"recursively copy whole structure"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self is: Object⇒[⇑self]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self class recopy: self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Aspects</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asOop </span><span style="font: 10pt serif">[user croak] primitive: 46</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">canunderstand: selector<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self class canunderstand: selector]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">error: s </span><span style="font: 10pt serif">[⇑user notify: s]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fields<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Return an Array of all my field names or many of my subscripts."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self class is: VariableLengthClass⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self length ≤ 50⇒ [⇑1 to: self length]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ (1 to: 20) concat: (self length-20 to: self length)]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self class instvars]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hash </span><span style="font: 10pt serif">[user croak] primitive: 46</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">inspect<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user leaveTop; restartup: (InspectWindow new of: self)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">inspectfield: n</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"used by variable panes"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self class is: VariableLengthClass⇒ [⇑self◦(self fields◦n)]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self instfield: n]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">instfield: n </span><span style="font: 10pt serif">[user croak] primitive: 38</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">instfield: n &larr; val </span><span style="font: 10pt serif">[user croak] primitive: 39</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">instfields </span><span style="font: 10pt serif">| vec size  i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Return an Array of all my field values or many of my elements."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self class is: VariableLengthClass⇒ [⇑self◦self fields]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">size &larr; self class instsize.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">vec &larr; Vector new: size.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: size do⦂ [vec◦i &larr; self instfield: i].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑vec]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">itself </span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">ref: index<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑FieldReference new object: self offset: index]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">subError </span><span style="font: 10pt serif">[self error: &rsquo;message not defined by subclass&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">title<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self class title + &rsquo;.&rsquo; + self asOop base8]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Printing</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asFullString </span><span style="font: 10pt serif">| strm<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strm &larr; (String new: 20) asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self fullprinton: strm. ⇑strm contents]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asString </span><span style="font: 10pt serif">| strm<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strm &larr; (String new: 16) asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self printon: strm. ⇑strm contents]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">filout </span><span style="font: 10pt serif">| file<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑user displayoffwhile⦂ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[file &larr; dp0 file: self title asFileName.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self fullprinton: file.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">file close]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fullprint </span><span style="font: 10pt serif">| strm<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strm &larr; Stream default. self fullprinton: strm.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user show: strm contents]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fullprinton: strm<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self≡nil⇒ [strm append: &rsquo;nil&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self≡false⇒ [strm append: &rsquo;false&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self≡true⇒ [strm append: &rsquo;true&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self class print: self on: strm]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">print<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user show: self asString]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm </span><span style="font: 10pt serif">| t [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm append: [self≡nil⇒ [&rsquo;nil&rsquo;]; ≡false⇒ [&rsquo;false&rsquo;]; ≡true⇒ [&rsquo;true&rsquo;]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">t &larr; self class title.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm append: [&rsquo;AEIO&rsquo; has: t◦1⇒ [&rsquo;an &rsquo;] &rsquo;a &rsquo;].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">t]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Compiler Defaults</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">ⓢ code<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑Generator new evaluate: code asStream in: false to: self notifying: self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">argsOff: stack<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self⇒ [stack pop: 1]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asRemoteCode: generator<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑ParsedRemote new expr: self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emitForEffect: code on: stack</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emitForTruth: trueSkip falsity: falseSkip into: code on: stack<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self emitForValue: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(trueSkip jmpSize + falseSkip) emitBfp: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">trueSkip emitJmp: code on: stack]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emitForValue: code on: stack</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emitsLoad<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emittedReceiver<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emittedVariable<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">findMacros: macros compilerTemps: compilerTemps</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">firstPush<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑¬1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">interactive<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">isField<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">notify: errorString at: position in: stream<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self notify: errorString at: position in: stream for: self class]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">notify: errorString at: position in: stream for: class </span><span style="font: 10pt serif">| syntaxWindow<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[NotifyFlag⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[syntaxWindow &larr; SyntaxWindow new of: errorString at: position in: stream for: class from: thisContext sender.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">thisContext sender &larr; nil.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user restartup: syntaxWindow]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> user notify: errorString. ⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm indent: level precedence: p forValue: v decompiler: decompiler</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">remote: generator</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">returns<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sizeForEffect: nextPush <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sizeForTruth: trueSkip falsity: falseSkip<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| jump<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[jump &larr; trueSkip jmpSize.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self sizeForValue + (jump+falseSkip) bfpSize + jump]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sizeForValue<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>System Primitives</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">error </span><span style="font: 10pt serif">| sender op n args i</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"after compiling execute: nil installError.  "<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[sender &larr; thisContext sender.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">op &larr; sender thisop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">n &larr; op numArgs.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">args &larr; Vector new: n.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: (n to: 1 by: ¬1) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[args◦i &larr; sender pop].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self messageNotUnderstood: op withArgs: args from: sender]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">installError </span><span style="font: 10pt serif">| code old<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[code &larr; Object md method: ↪error.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">old &larr; SpecialOops◦1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">old asOop≠(mem◦3)⇒ [user notify: &rsquo;Object installError failed&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Top critical⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[mem◦3 &larr; code asOop.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">SpecialOops◦1 &larr; code]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">messageNotUnderstood: op withArgs: args from: sender<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[thisContext sender &larr; sender.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: &rsquo;Message not understood: &rsquo;+op]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">nail </span><span style="font: 10pt serif">[user croak] primitive: 31</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"Nail me in core and return my core address"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">perform: selector </span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Send the unary message, selector, to self"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[selector mustTake: 0. ⇑self performDangerously: selector]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">perform: selector with: arg1 </span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Send the 1-argument message, selector, to self"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[selector mustTake: 1. ⇑self performDangerously: selector with: arg1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">perform: selector with: arg1 with: arg2 </span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Send the 2-argument message, selector, to self"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[selector mustTake: 2. ⇑self performDangerously: selector with: arg1 with: arg2]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">perform: selector with: arg1 with: arg2 with: arg3 </span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Send the 3-argument message, selector, to self"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[selector mustTake: 3. ⇑self performDangerously: selector with: arg1 with: arg2 with: arg3]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">perform: selector withArgs: vec<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[selector mustTake: vec length.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self performDangerously: selector withArgs: vec]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">performDangerously: selector </span><span style="font: italic 10pt serif">"Send self the message, selector; it had better be unary"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user notify: &rsquo;can&rsquo;&rsquo;t perform: nil&rsquo;] primitive: 102</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">performDangerously: selector with: arg1  </span><span style="font: italic 10pt serif">"selector had better take 1 arg"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user notify: &rsquo;can&rsquo;&rsquo;t perform: nil with:&rsquo;] primitive: 102</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">performDangerously: selector with: arg1 with: arg2  </span><span style="font: italic 10pt serif">"selector had better take 2 args"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user notify: &rsquo;can&rsquo;&rsquo;t perform: nil with:with:&rsquo;] primitive: 102</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">performDangerously: selector with: arg1 with: arg2 with: arg3  </span><span style="font: italic 10pt serif">"selector had better take 3 args"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user notify: &rsquo;can&rsquo;&rsquo;t perform: nil with:with:with:&rsquo;] primitive: 102</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">performDangerously: selector withArgs: vec<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[vec length=0⇒ [⇑self performDangerously: selector];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=1⇒ [⇑self performDangerously: selector with: vec◦1];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=2⇒ [⇑self performDangerously: selector with: vec◦1 with: vec◦2];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=3⇒ [⇑self performDangerously: selector with: vec◦1 with: vec◦2 with: vec◦3]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: &rsquo;More than 3 args for perform:&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">PTR </span><span style="font: 10pt serif">[] primitive: 46</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">refct </span><span style="font: 10pt serif">[user croak] primitive: 45</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">startup</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"loopless scheduling"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self firsttime⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[while⦂ self eachtime do⦂ [].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self lasttime]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">swap⦂ variable </span><span style="font: 10pt serif">| x  </span><span style="font: italic 10pt serif">"assign me to variable and return its old value"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[x &larr; variable value. variable value &larr; self. ⇑x]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">unNail </span><span style="font: 10pt serif">[user croak] primitive: 32</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"Release me from being nailed"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪Object under: &rsquo;Kernel Classes&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"Class"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;Class&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;title</span><span class="tab" val="79"></span><span style="font: bold 12pt serif">"&lt;String&gt; for identification, printing"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">myinstvars "&lt;String&gt; partnames for compiling, printing"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">instsize "&lt;Integer&gt; for storage management"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">messagedict "&lt;MessageDict&gt; for communication, compiling"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">classvars "&lt;Dictionary/nil&gt; compiler checks here"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">superclass "&lt;Class&gt; for execution of inherited behavior"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">environment "&lt;Vector of SymbolTables&gt; for external refs"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fieldtype&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;lastClass lastSelector lastParagraph &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">veryspecial: 1;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>Classes are the molecules of Smalltalk.  The instance fields specify the number and naming of fields for each instance, and the messages define the protocol with which these objects may be communicated.  Classes inherit the fields and message protocol of their superclass.  Locally defined messages will override inherited ones of the same name, and overriden ones may be accessed through the use of super in place of self.  A typical class definition looks like:<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Class new title: &rsquo;CodeEditor&rsquo;;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">subclassof: Window;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">fields: &rsquo;pared class selector&rsquo;;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">declare: &rsquo;editmenu&rsquo;<br>This ordering is required, though the subclassof: and declare: messages are optional.  A class definition may be re-executed but, if the fields: clause has changed, all instances of the old class will become obsolete (they will fail to respond to any messages).</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">abstract<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self fields: nullString]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">bytesize: n</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"non-pointer declaration"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self≠self realself⇒[self realself bytesize: n]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fieldtype &larr; 32+ [n=8⇒ [8] 16]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"gets propagated to a dummy instance"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self new classInit]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">copyof: oldClass subclassof: newSubClass<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[title &larr; oldClass title.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self subclassof: newSubClass.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> classvars &larr; oldClass classvars.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> environment &larr; oldClass environment.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self newFieldsForSubClass: oldClass myinstvars]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">declare: v </span><span style="font: 10pt serif">| var recom</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self≠self realself⇒[self realself declare: v]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> [classvars≡nil⇒[classvars &larr; SymbolTable init]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> v is: String⇒[self declare: v asVector]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> recom &larr; false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> [v is: Vector⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ var from: v do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(Smalltalk has: var) or: (Undeclared has: var)⇒[recom &larr; true]]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">  (Smalltalk has: v) or: (Undeclared has: v)⇒[recom &larr; true]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> [recom⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user notify: &rsquo;Methods recompile if you proceed, global became local&rsquo;]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> [v is: Vector⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ var from: v do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[classvars insert: var with: nil]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">  classvars insert: v with: nil].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> recom⇒[self compileall]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">environment &larr; environment </span><span style="font: 10pt serif">[] </span><span style="font: italic 10pt serif">"for resetting to reread sharing clauses"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fields: myinstvars </span><span style="font: 10pt serif">| r a b s h</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"list of instance variables"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[messagedict &larr; MessageDict init.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> r &larr; self realself.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">a &larr; self instvars.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">h&larr; HashSet init.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ s from: a do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[h has: s⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user notify: s+&rsquo; is used already (maybe in superclass)&rsquo;]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">h insert: s].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self=r⇒[self initClass]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> a=(b&larr; r instvars)⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[r environment&larr; nil; myinstvars&larr; myinstvars; subclassof: superclass]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> [r howMany&gt;0⇒[user notify: &rsquo;All &rsquo;+title+&rsquo;s become obsolete if you proceed...&rsquo;]].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> classvars &larr; r classvars.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> messagedict &larr; r md copy.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> </span><span class="tab" val="79"></span><span style="font: 10pt serif">[a length≤b length or⦂ a◦(1 to: b length)≠b⇒</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"just adding new inst fields"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user notify: title+ &rsquo; methods recompile if you proceed...&rsquo;.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self compileall]].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> r md init.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self fixSubClassesOf: r.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> r obsolete.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> Smalltalk◦title unique &larr; self.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self initClass]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fixSubClassesOf: oldClass </span><span style="font: 10pt serif">| n subClass<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ n from: user classNames do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[subClass &larr; Smalltalk◦n.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> subClass superclass≡oldClass⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[Class new copyof: subClass subclassof: self]]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">initClass<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[fieldtype &larr; 16.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">instsize &larr; self instvars length.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">instsize&gt;256⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user notify: &rsquo;too many instance variables&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self organization]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">myinstvars &larr; myinstvars</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">newFieldsForSubClass: myinstvars </span><span style="font: 10pt serif">| r a b</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"list of instance variables"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[messagedict &larr; MessageDict init.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> r &larr; self realself.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self=r⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user notify: &rsquo;problem in class redefinition. See coment at end of method&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> (a&larr; self instvars)=(b&larr; r instvars)⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user notify: &rsquo;problem in class redefinition. See coment at end of method&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> [r howMany&gt;0⇒[user cr show: &rsquo;All &rsquo;+title+&rsquo;s are obsolete.&rsquo;]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> classvars &larr; r classvars.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> messagedict &larr; r md copy.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> r md init.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> </span><span class="tab" val="79"></span><span style="font: 10pt serif">[a length≤b length or⦂ a◦(1 to: b length)≠b⇒</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"changing inst fields"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user cr show: title+ &rsquo; recompiled.&rsquo;.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self compileall]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self fixSubClassesOf: r.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> r obsolete.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> Smalltalk◦title unique &larr; self.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self initClass]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"Regarding the notifys in this method: It is my understanding<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> that this method will only be invoked when the conditions<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> leading to the notifys are false. If I&rsquo;m available, I&rsquo;d like to see<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> any case that results in notification.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">Dave Robson"<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">obsolete</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"invalidate further communication"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[title &larr; &rsquo;AnObsolete&rsquo;+title.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">classvars &larr; nil.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"recycle class variables"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">messagedict close.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"invalidate and recycle local messages"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">environment &larr; self.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"keep me around for old instances"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">superclass &larr; Object.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"invalidate superclass messages"</span><span style="font: 10pt serif">]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">realself </span><span style="font: 10pt serif">[⇑Smalltalk◦title unique]</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"as opposed to possible filin ghost"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">rename: newtitle<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| name newname oldclass category<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[name &larr; title unique.  newname &larr; newtitle unique.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[Smalltalk has: newname⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[oldclass &larr; Smalltalk◦newname.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: &rsquo;All &rsquo; + newtitle + &rsquo;s will become obsolete if you proceed&rsquo;.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">oldclass obsolete]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">category &larr; SystemOrganization invert: name.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">AllClassNames &larr; AllClassNames insertSorted: newname.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">SystemOrganization classify: newname under: category].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Smalltalk delete: name.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">AllClassNames &larr; AllClassNames delete: name.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">SystemOrganization delete: name.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">title &larr; newtitle.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Smalltalk declare: newname as: self]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sharing: table<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self≠self realself⇒[self realself sharing: table]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">environment &larr; environment asVector , table]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">subclassof: superclass<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(superclass isnt: Class) and⦂ (superclass isnt: VariableLengthClass)⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user notify: &rsquo;Superclass is not yet defined or not a Class&rsquo;]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">title: title<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self title: (title &larr; title unique) insystem: Smalltalk]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">title: name insystem: system </span><span style="font: 10pt serif">| cl<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[superclass &larr; Object.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[system has: name⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[cl &larr; (system◦name) class.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">cl≡self class⇒ [⇑self]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: name + &rsquo; will change from a &rsquo; + cl title + &rsquo; to a &rsquo; + self class title + &rsquo; if you proceed...&rsquo;]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">system declare: name as: self.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">AllClassNames &larr; AllClassNames insertSorted: name.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">SystemOrganization classify: name under: &rsquo;As yet unclassified&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">title: t subclassof: s fields: f declare: d<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t◦1≠((t◦1) asUppercase)⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user notify: &rsquo;Please capitalize each word in class title: &rsquo; + t. ⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self title: t; subclassof: s; fields: f; declare: d]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">veryspecial: n</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"inaccessible fields"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[instsize &larr; self instvars length + n]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Access to parts</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">◦x </span><span style="font: 10pt serif">[⇑classvars◦x]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">◦x &larr; val </span><span style="font: 10pt serif">[⇑classvars◦x &larr; val]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fieldNamesInto: collector<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[superclass≡nil⇒ [] superclass fieldNamesInto: collector].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑(Reader new of: myinstvars) readInto: collector]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">instsize<br></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Return the number of user accessable instance fields (self instvars length)."</span><span style="font: 10pt serif"><br>⇑[fieldtype≥32⇒ [0] <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self≡Class⇒ [instsize-1]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self≡VariableLengthClass ⇒[instsize-20]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">instsize]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">instvars<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self fieldNamesInto: FieldNameCollector default]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">invertRef: refs </span><span style="font: 10pt serif">"Refs may be a vector (to allow batching)" <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| cl env source ref inv sym t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[refs isnt: Vector⇒ [⇑(self invert: refs inVector)◦1]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">env &larr; (self wholeEnvironment concat: (Undeclared, Smalltalk)) asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">source &larr; Dictionary init.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑refs transform⦂ ref to⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[cl &larr; self. env reset.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(sym &larr; env next)≡false⇒ [inv &larr; &rsquo;unknown &rsquo; concat: ref asOop base8]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[cl≠nil and⦂ sym≡cl classvars⇒ [t &larr; cl title. cl &larr; cl superclass] t &larr; false].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(inv &larr; sym invertRef: ref)≡false⇒ [false]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t⇒ []<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> t &larr; source lookup: sym⇒ []<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> source insert: sym with: (t &larr; Smalltalk invert: sym)].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">inv &larr; (t concat: &rsquo; &rsquo;) concat: inv]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> do⦂ [].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">inv]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">Isa: x  </span><span style="font: italic 10pt serif">"is x on my superclass chain?"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[superclass ≡ x ⇒[⇑true]; ≡ nil ⇒[⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑superclass Isa: x]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">md </span><span style="font: 10pt serif">[⇑messagedict]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">myinstvars<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑myinstvars]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">superclass </span><span style="font: 10pt serif">[⇑superclass]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">title </span><span style="font: 10pt serif">[⇑title]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Organization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classvars </span><span style="font: 10pt serif">[⇑classvars]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">clean </span><span style="font: 10pt serif">| name</span><span class="tab" val="79"></span><span style="font: 10pt serif">"release unreferenced classvars"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ name from: classvars do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[name≠↪ClassOrganization and⦂ (classvars ref: name) refct=1⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[classvars delete: name]]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">environment<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑environment]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">organization </span><span style="font: 10pt serif">| o<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span class="tab" val="79"></span><span style="font: 10pt serif">[classvars ≡ nil⇒[self declare: ↪ClassOrganization]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">o &larr; classvars lookup: ↪ClassOrganization.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">o is: ClassOrganizer⇒[⇑o]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">o &larr; ClassOrganizer new init: messagedict contents sort.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">classvars insert: ↪ClassOrganization with: o.  ⇑o]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">wholeEnvironment<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑(classvars asVector concat: environment asVector) concat:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[superclass≡nil⇒ [↪()] superclass wholeEnvironment]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Editing</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">ed: selector </span><span style="font: 10pt serif">| c s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[c&larr; self code: selector. user clearshow: c.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ (s&larr; user request: &rsquo;substitute: &rsquo;) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[c &larr; c subst: s for: (user request: &rsquo;for: &rsquo;).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user clearshow: c]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self understands: c]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">edit: selector </span><span style="font: 10pt serif">| para s v<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[para &larr;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[selector=↪ClassOrganization⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self organization asParagraph]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">messagedict has: selector⇒[self code: selector]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nullString asParagraph].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self edit: selector para: para formerly: false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">edit: selector para: para formerly: oldpara<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user leaveTop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user restartup: (CodeWindow new class: self selector: selector para: para formerly: oldpara)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">execute: code</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"disposable methods"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self understands: &rsquo;doit [⇑&rsquo; + code + &rsquo;]&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self new doit]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Message access</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">archiveOn: file changesOnly: ch </span><span style="font: 10pt serif">| org m [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">this should be called only by the system releaser<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">(via </span><span style="font: bold 10pt serif">UserView file:classes:changesOnly:</span><span style="font: italic 10pt serif">) !!!<br><br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">if you want to archive your own classes (useful only if you have stable code<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">and intend to clean up afterwards with a vmem write), see Steve.<br><br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">write comment and method text on a FileStream for some file.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">ch⇒ [write only changes (non-remote String/Paraagraphs)] write everything</span><span style="font: 10pt serif">"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user cr; show: title.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">org &larr; self organization.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">org globalComment always yields a String, so a small kludge is in order</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ch and⦂ (org globalCommentItself is: RemoteParagraph)⇒ []<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">org globalComment &larr;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(RemoteParagraph new on: file) fromString: org globalComment].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">archive in category&alphabetical rather than hash order (messagedict)</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ m from: org do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">ch and⦂ ((messagedict code: m) is: RemoteParagraph)⇒ []<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">messagedict code: m &larr;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(RemoteParagraph new on: file) fromParagraph: (self code: m).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">ch⇒ [user space; show: m]]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">bytesof: sel<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑(messagedict method: sel) asBytes]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">canUnderstand: selector<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[messagedict has: selector⇒ [⇑self]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">superclass≡nil⇒ [⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑superclass canUnderstand: selector]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">canunderstand: selector<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑messagedict has: selector]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">code: sel </span><span style="font: 10pt serif">[ <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">last paragraph returned is cached (mainly for NotifyWindows)</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[sel ≡ lastSelector and⦂ self ≡ lastClass ⇒ []<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">lastParagraph &larr; ([<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">sel = ↪ClassOrganization ⇒ [self organization]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">if left shift key is down, decompile</span><span style="font: 10pt serif">"</span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user leftShiftKey⇒ [self decompile: sel]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">Paragraph or RemoteParagraph</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">messagedict code: sel]) asParagraph.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">lastClass &larr; self.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">lastSelector &larr; sel].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑lastParagraph]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">compileall </span><span style="font: 10pt serif">| s c "does not modify code, just compiles it"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ s from: messagedict do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[c &larr; messagedict code: s.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self understands: c asParagraph.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> messagedict code: s &larr; c "leave it as a remote paragraph"].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self≡Object⇒[nil installError]]<br></span><span style="font: italic 10pt serif">"to recompile the whole system (check out big changes) execute:<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">| n [for⦂ n from: AllClassNames do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">[user show: n; cr. (Smalltalk◦n) compileall.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Changes init. MessageDict new freeMethods]] "</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">copy: sel from: class<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self copy: sel from: class classified: nil]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">copy: sel from: class classified: cat </span><span style="font: 10pt serif">"Useful when modifying an existing class"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| s code<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[sel is: Vector⇒ [for⦂ s from: sel do⦂ [self copy: s from: class classified: cat]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sel is: String⇒ [self copy: (class organization category: sel) from: class classified: cat]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">code &larr; class code: sel.  code≡nil⇒ []<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[cat≡nil⇒ [cat &larr; class organization invert: sel]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[messagedict has: sel⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[code text=(self code: sel) text⇒ []<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: title+&rsquo; &rsquo;+sel+&rsquo; will be redefined if you proceed.&rsquo;]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self understands: code classified: cat]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">decompile: t1 <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑user displayoffwhile⦂ [Decompiler new decompile: t1 class: self]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">derstands: selector </span><span style="font: 10pt serif">| c</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"overstands?  undersits? - forget it"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[selector is: Vector⇒[for⦂ c from: selector do⦂ [self derstands: c]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(messagedict has: selector)≡false⇒[] <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">messagedict &larr; messagedict delete: selector.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self organization delete: selector.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">lastClass &larr; lastSelector &larr; lastParagraph &larr; nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[Changes has: (c&larr;title+&rsquo; &rsquo;+selector)⇒ [Changes delete: c]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Changes insert: (c&larr;&rsquo;~&rsquo;+c).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑c]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">describe: method on: strm </span><span style="font: 10pt serif">| sel cls  </span><span style="font: italic 10pt serif">"append mclass and selector"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[cls &larr; self.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ [cls≡nil⇒ [cls&larr;self. sel&larr;↪?] sel &larr; cls md invert: method] do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[cls &larr; cls superclass].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm append: cls title; space; append: sel]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">install: name method: method literals: literals<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 10pt serif">code: code backpointers: backpointers | c<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[messagedict &larr; messagedict insert: name method: method<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">literals: literals code: code makeBoldPattern backpointers: backpointers.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">lastClass &larr; self.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">lastSelector &larr; name.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">lastParagraph &larr; code.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Changes insert: (c&larr;title+&rsquo; &rsquo;+name).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Changes has: (c&larr;&rsquo;~&rsquo;+c)⇒[Changes delete: c]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">messages </span><span style="font: 10pt serif">[⇑messagedict contents , ↪ClassOrganization]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">method: sel<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑messagedict methodorfalse: sel]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">notify: errorString at: position in: stream<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self notify: errorString at: position in: stream for: self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">selectors</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Return a Vector of all my selectors."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self messages]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">shrink </span><span style="font: 10pt serif">[messagedict &larr; messagedict shrink]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">space </span><span style="font: 10pt serif">| a s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s &larr; 0. for⦂ a from: messagedict do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s &larr; s + (messagedict method: a) length]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑s]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">textLocal </span><span style="font: 10pt serif">| s [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">makes comment and methods local</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s &larr; self organization.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s globalComment &larr; s globalComment.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ s from: messagedict do⦂ [messagedict code: s &larr; self code: s]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">understands: code </span><span style="font: 10pt serif">| selector old</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"install method"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self understands: code classified: &rsquo;As yet unclassified&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">understands: code classified: heading</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"compile and install method"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑Generator new compile: code asParagraph<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">in: self under: heading notifying: self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">whosends: selector </span><span style="font: 10pt serif">| s l a<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s &larr; Stream default.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ a from: messagedict do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ l from: (messagedict literals: a) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[selector≡l⇒[s append: a; space]]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑s contents]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Instance access</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">allInstances </span><span style="font: 10pt serif">[⇑self allInstancesEver notNil]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">allInstancesEver </span><span style="font: 10pt serif">| indx vec PCLs i </span><span style="font: italic 10pt serif">"returns a vector containing all instances of this class mixed with nils"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Works for all classes.  Some additional instances may be created after the<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">vector is filled but before you get to use it."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">PCLs &larr; Vmem pclassesOf: self.  </span><span style="font: italic 10pt serif">"vector of PCLs"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">vec &larr; Vector new: 128*PCLs length.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: PCLs length do⦂ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(vec◦[i-1*128+1 to: i*128]) all&larr; PCLs◦i].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">thisContext destroyAndReturn: (self fromFreelist: Class instsize fill: vec)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">copy: inst </span><span style="font: 10pt serif">| t i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t &larr; self new.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: self instsize do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t instfield: i &larr; inst instfield: i]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑t]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">default<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self new default]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fromFreelist: i fill: vec </span><span style="font: italic 10pt serif">"i = zero order index of freelist in class instance.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">vec = vector in pclasses of all possible instances."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user croak] primitive: 60</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">howMany </span><span style="font: 10pt serif">| v </span><span style="font: italic 10pt serif">"how many instances of this class are in use now?"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[v &larr; self allInstancesEver.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">thisContext destroyAndReturn: v length-(v count: nil)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"init and default get propagated to instances"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self new init]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init: n</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"init and default get propagated to instances"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self new init: n]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">instfield:</span><span class="tab" val="79"></span><span style="font: bold 10pt serif"> i</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"prevent user from getting freelist"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[i &gt; Class instsize ⇒[user notify: &rsquo;arg too big&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑super instfield: i]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">new </span><span style="font: 10pt serif">[user croak] primitive: 28</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">new: length </span><span style="font: 10pt serif">"To allow fixed-length classes to simulate variable-length ones"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self new init: length] "By convention"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">print: inst on: strm </span><span style="font: 10pt serif">| ivars i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ivars &larr; self instvars.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm append: &rsquo;(&rsquo;; append: title; append: &rsquo; new &rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: instsize do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strm append: ivars◦i; append: &rsquo;: &rsquo;;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">print: (inst instfield: i); space]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm append: &rsquo;)&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strm append: &rsquo;Class &rsquo; + title]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">recopy: inst </span><span style="font: 10pt serif">| t i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t &larr; self new.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: self instsize do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t instfield: i &larr; (inst instfield: i) recopy]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑t]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Filin and Filout</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asFollows </span><span style="font: 10pt serif">| s heading selector p [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self≠self realself⇒[self realself asFollows]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">heading &larr; &rsquo;As yet unclassified&rsquo;.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">handles Bravo or Press (Smalltalk generated) files</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ ((p &larr; FilinSource nextParagraph) and⦂ (s &larr; p text) ≠ &rsquo;&rsquo;) do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s◦1 = 015⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">throw away initial cr before comment and headings</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s &larr; s copy: 2 to: s length]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">p runs◦2<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">= 2 "</span><span style="font: italic 10pt serif">italic</span><span style="font: 10pt serif">"⇒ [self organization globalComment &larr; s];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">= 0121 "</span><span style="font: bold 12pt serif">5, bold</span><span style="font: 10pt serif">"⇒ [heading &larr; s]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self canunderstand: (<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">selector &larr; self understands: p classified: heading)⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user show: selector; space. messagedict purge: selector]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user show: &rsquo;(an uncompiled method) &rsquo;]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">changelist: cat </span><span style="font: 10pt serif">[⇑title unique, (self organization category: cat)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">definition </span><span style="font: 10pt serif">| strm</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"return a string that defines me (Class new title etc.)"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strm &larr; (String new: 50) asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self printdefon: strm.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑strm contents]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">endCategoryOn: pstrm</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">endChangesOn: pstrm<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pstrm print: &rsquo;&rsquo; asParagraph]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">filout </span><span style="font: 10pt serif">[user displayoffwhile⦂ [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(dp1 file: title+&rsquo;.st.&rsquo;) filoutclass: self.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self noChanges]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">filoutCategory: cat<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(dp1 file: (title+&rsquo;-&rsquo;+cat+&rsquo;.st&rsquo;) asFileName) filout: (self changelist: cat)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">filoutOrganization</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"So we can merge separate work on organization"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user show: title; cr.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user displayoffwhile⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(dp0 file: title+&rsquo;.org.&rsquo;)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">append: title+&rsquo; organization fromParagraph:&rsquo;; cr;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">append: self organization asParagraph text asString;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">append: &rsquo;asParagraph&rsquo;; close]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">noChanges </span><span style="font: 10pt serif">| s t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t&larr; title+&rsquo; *&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ s from: Changes contents do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(s◦1=126 "~" and⦂ (t match: s◦(2 to: s length)))<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> or⦂ (t match: s)⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[Changes delete: s]]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">paraprinton: strm</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Strm is actually a ParagraphPrinter"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| para frame s heading org<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[para &larr; (&rsquo;"&rsquo;+title+&rsquo;"&rsquo;) asParagraph.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">para maskrunsunder: 0361 to: 0121.</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Font &larr; 5, Bold"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">frame &larr; strm defaultframe.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm frame &larr; 15000⌾frame origin y rect: 20000⌾frame corner y.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm print: para.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm frame &larr; frame.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm print: ((self definition+&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">asFollows&rsquo;) asParagraph maskrunsunder: 0361 to: 0121).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">org &larr; self organization.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm print: (&rsquo;<br>&rsquo;+org globalComment) asParagraph allItalic.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ heading from: org categories do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self printCategory: heading on: strm]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self endChangesOn: strm.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm print: (&rsquo;SystemOrganization classify: ↪&rsquo;+title+&rsquo; under: &rsquo;&rsquo;&rsquo;+<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(SystemOrganization invert: title unique)+&rsquo;&rsquo;&rsquo;.&rsquo;) asParagraph.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self ≡ Class or: self ≡ VariableLengthClass⇒ [] self canunderstand: ↪classInit⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strm print: (title+&rsquo; classInit&rsquo;) asParagraph]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printCategory: s on: pstrm </span><span style="font: 10pt serif">| sel<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self startCategory: s on: pstrm.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ sel from: (self organization category: s) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self printMethod: sel on: pstrm].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self endCategoryOn: pstrm]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printdefon: strm </span><span style="font: 10pt serif">| s</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"print my definition on strm"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strm append: self class title;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">append: &rsquo; new title: &rsquo;;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"title is probably unique, but make sure. then we want it as a &rsquo;String&rsquo; "<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">print: title unique asString.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm cr; tab; append: &rsquo;subclassof: &rsquo;;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">append: [superclass≡nil⇒[&rsquo;nil&rsquo;] superclass title].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm cr; tab; append: &rsquo;fields: &rsquo;; print: myinstvars.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm cr; tab; append: &rsquo;declare: &rsquo;&rsquo;&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ s from: classvars contents do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s=↪ClassOrganization⇒[]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm append: s; space]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm append: &rsquo;&rsquo;&rsquo;&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[fieldtype=16⇒[]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm semicrtab; append: &rsquo;bytesize: &rsquo;; print: fieldtype-32].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[instsize = (s&larr; self instvars) length⇒[]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm semicrtab; append: &rsquo;veryspecial: &rsquo;; print: instsize-s length].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[environment≡nil⇒[]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ s from: environment do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strm semicrtab; append: &rsquo;sharing: &rsquo;; append: (Smalltalk invert: s)]]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printMethod: sel on: pstrm<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pstrm print: (self code: sel).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">messagedict purge: sel]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printout </span><span style="font: 10pt serif">[user displayoffwhile⦂ [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(dp0 file: title+&rsquo;.press.&rsquo;) printoutclass: self]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printoutCategory: cat<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(dp0 file: (title+&rsquo;-&rsquo;+cat+&rsquo;.press&rsquo;) asFileName) printout: (self changelist: cat)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">readfrom: strm </span><span style="font: 10pt serif">[⇑self readfrom: strm format: nil]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">readfrom: strm format: f </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self new readfrom: strm format: f]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">startCategory: s on: pstrm<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pstrm print: ((&rsquo;<br>&rsquo;+s) asParagraph maskrunsunder: 0361 to: 0121).</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Font 5, Bold"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">startChangesOn: pstrm<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pstrm print: ((&rsquo;<br>&rsquo;+title+&rsquo; asFollows&rsquo;) asParagraph maskrunsunder: 0361 to: 0121).</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Font 5, Bold"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>System Organization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">category </span><span style="font: 10pt serif">[⇑SystemOrganization invert: self title unique]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">category: cat<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[cat is: String ⇒[SystemOrganization add: self title unique under: cat]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: &rsquo;Category name must be a String&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">moveFromCat: cat1 to: cat2<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(cat1 is: String) and⦂ (cat2 is: String) ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[SystemOrganization move: self title unique from: cat1 to: cat2]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: &rsquo;Category name must be a String&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪Class under: &rsquo;Kernel Classes&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"Context"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;Context&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;sender "&lt;Context&gt; from which this message was sent"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">receiver "&lt;Object&gt; to which this message was sent"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">keep "&lt;true, nil&gt; nil means reclaimable"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">method "&lt;String&gt;, the encoded method"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">tempframe "&lt;Vector&gt; to hold temporaries and a stack"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">pc "&lt;Integer&gt; marks progress of execution in method"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">stackptr "&lt;Integer&gt; offset of stack top in tempframe"&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;arrayFld positionFld limitFld &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>A context keeps track of the progress of a method</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">cleancopy<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑Context new<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">sender: sender<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">receiver: receiver<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">method: method<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">tempframe: tempframe copy<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pc: pc<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">stackptr: stackptr]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">copy<br></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ Context new<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">sender: sender<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">receiver: receiver<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">method: method<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">tempframe: tempframe<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pc: pc<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">stackptr: stackptr<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sender: sender receiver: receiver<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 10pt serif">method: method tempframe: tempframe pc: pc stackptr: stackptr</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Access to parts</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">caller </span><span style="font: 10pt serif">[⇑sender]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">getPT: i  </span><span style="font: 10pt serif">[ ⇑ tempframe◦i ]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">mclass </span><span style="font: 10pt serif">| selector mclass</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"return the class in which method was found"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[sender ≡ nil ⇒ [⇑receiver class]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">selector &larr; self selector.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">mclass &larr; receiver class.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ mclass ≡ nil do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(mclass method: selector) ≡ method ⇒ [⇑mclass]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">mclass &larr; mclass superclass].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑receiver class]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">method<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑method]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pc </span><span style="font: 10pt serif">[⇑pc]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">receiver<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑receiver]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">selector </span><span style="font: 10pt serif">| mclass selector</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"return the selector for my method"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[selector &larr; sender thisop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">selector◦(1~19)=&rsquo;performDangerously:&rsquo;⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[mclass &larr; receiver class.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"special work for perform"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ [mclass ≡ nil or⦂ (selector&larr;mclass md invert: method)] do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[mclass &larr; mclass superclass]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">selector≡false⇒[⇑↪confused] ⇑selector]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑selector]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sender </span><span style="font: 10pt serif">[⇑sender]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sender&larr; sender </span><span style="font: 10pt serif">[]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">setPT: i to: n  </span><span style="font: 10pt serif">[ tempframe◦i &larr; n ]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">stackIndex </span><span style="font: italic 10pt serif">"Return the subscript in tempframe of my top of stack."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑stackptr+1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">swapSender: coroutine </span><span style="font: 10pt serif">| oldSender<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[oldSender &larr; sender. sender &larr; coroutine. ⇑oldSender]</span><span class="tab" val="79"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">tempframe<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑tempframe]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">totalPT </span><span style="font: 10pt serif">[⇑ (method◦5)+1 ]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Control structures</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">for⦂ var1 from: expr1 with⦂ var2 from: expr2 do⦂ stmt </span><span style="font: 10pt serif">| s1 s2<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s1 &larr; expr1 asStream. s2 &larr; expr2 asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ [(var1 value &larr; s1 next) and⦂ (var2 value &larr; s2 next)] do⦂ stmt eval]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Debugging</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">debug </span><span style="font: 10pt serif">| t v<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self print.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ [user cr. t &larr; user request: &rsquo;*&rsquo;] do⦂  </span><span style="font: italic 10pt serif">"until ctrl-d"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[v &larr; Generator new evaluate: t asStream in: false to: self notifying: nil.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">↪debugret=v⇒[self print] v print]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑↪debugret]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm </span><span style="font: 10pt serif">| mc<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Print the selector which invoked this Context<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">  and the class in which code was found for that selector"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> mc &larr; self mclass.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> strm append: mc title. sender≡nil⇒ []<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> [receiver is: mc⇒[] strm append: &rsquo;(&rsquo;+receiver class title+&rsquo;)&rsquo;].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> strm append: &rsquo;⇒&rsquo;; print: self selector]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">restartWith: method<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[tempframe &larr; tempframe copy: 1 to: method◦3.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self restart]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">stack </span><span style="font: 10pt serif">| a strm<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Return a Vector of me and all my derivative contexts."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm &larr; (Vector new: 20) asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm next &larr; a &larr; self.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">when user notifty is fixed,</span><span style="font: 10pt serif"> a sender </span><span style="font: italic 10pt serif">can become</span><span style="font: 10pt serif"> a caller"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ (a&larr;a sender)≡nil do⦂ [strm next &larr; a].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑strm contents.]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">thisop </span><span style="font: 10pt serif">| a</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"return the message selector just sent"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[a &larr; method◦pc.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">a≥0320⇒ [⇑self litof: a-0320]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">a≥0260⇒ [⇑SpecialOops◦(10+a-0260)]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">method◦(pc-1)=0214⇒ [⇑self litof: a]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑↪confused]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">trace </span><span style="font: 10pt serif">| strm a<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strm &larr; Stream default. self printon: strm.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">a &larr; sender. until⦂ a≡nil do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strm cr. a printon: strm. a &larr; a sender]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑strm contents]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">variableNamesInto: dest with: block </span><span style="font: 10pt serif">| class selector parser<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"For each method variable name, call<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">dest declaration: block name: string asArg: &lt;true or false&gt;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">If cant find source code, call dest notify: "</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">class &larr; self mclass.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">selector &larr; class md invert: method⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[parser &larr; Parser new from: (class code: selector) asStream to: dest.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">parser pattern: block; temporaries: block; terminate]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dest notify: &rsquo;thisContext is not running a currently defined method&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">verifyFrames  </span><span style="font: 10pt serif">| c </span><span style="font: italic 10pt serif">"be sure frames on stack aren&rsquo;t nil"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[c &larr; self.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> until⦂ c≡nil do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[c tempframe≡nil⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user notify: &rsquo;Sorry, that stack has been released -- proceeding is impossible&rsquo;; restart]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> c &larr; c sender]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Simulation</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">docode: code toclass: class </span><span style="font: 10pt serif">| i v<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[(i&larr;code◦2)≠ 0 ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[i = 1  ⇒ [⇑self];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">= 30 ⇒ [v &larr; self pop. v push: self. ⇑v];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">= 40 ⇒ [v &larr; self pop instfield: code◦5 + 1. ⇑self push: v];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">= 41 ⇒ [user notify: &rsquo;Field&larr; primitive unimplemented&rsquo;];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">= 87 ⇒ [⇑ receiver "PriorityInterrupt run: newContext"];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">= 101 ⇒ [user notify: &rsquo;Doprimitive unimplemented&rsquo;];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">= 102 ⇒ [⇑self performing: code◦4 toclass: tempframe◦(stackptr+1)]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> (v &larr; self doprimitive: code) ≡ ↪failed ⇒[]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> stackptr &larr; stackptr-(code◦4+1). ⇑self push: v]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ⇑self newToRun: code]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dojump: displacement<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pc &larr; pc+displacement]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dopop<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[stackptr &larr; stackptr-1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">doprimitive: code<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑↪failed] primitive: 101</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">doremotereturn </span><span style="font: 10pt serif">| t f<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t &larr; self pop. f &larr; self pop. ⇑f push: t]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">doreturn </span><span style="font: 10pt serif">| t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t &larr; tempframe◦(stackptr+1). tempframe &larr; nil. ⇑sender push: t]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dostore </span><span style="font: 10pt serif">| byte<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[byte &larr; method◦(pc&larr; pc+1).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> byte&lt;020⇒ [self smashField: byte];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&lt;040⇒ [self smashTemp: byte-020];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&lt;0100⇒ [user notify: &rsquo;Store into literal&rsquo;];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&lt;0160⇒ [self smashLitInd: byte-0100];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&lt;0170⇒ [self instfield: (byte-0157) &larr; tempframe◦(stackptr+1)];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=0210⇒ [self smashField: self nextByte];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=0211⇒ [self smashTemp: self nextByte];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=0213⇒ [self smashLitInd: self nextByte]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> user notify: &rsquo;Illegal store&rsquo;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dosuper </span><span style="font: 10pt serif">| byte<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[byte &larr; self nextByte.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[byte=0214⇒ [byte &larr; self nextByte+0320]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">byte&lt;0260⇒ [user notify: &rsquo;non-selector after super&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self sendmess: nil byte: byte toclass: <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(self litof: method◦6-8/2) value superclass]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">doUnique </span><span style="font: 10pt serif">| r e "cause ◦ &larr; to be done for a UniqueString inside str: inside intern:"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[r &larr; tempframe◦(2+stackptr). "receiver"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"already know class is UniqueString"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">e &larr; &rsquo;bad special message in super&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(method ≡ (UniqueString md method: ↪str:)) ≡ false ⇒[user notify: e]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"ours, now put result of str: on the stack"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self push: (r &larr; r str: tempframe◦1 "arg").<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">method◦(method length) ≠ 0203 "return" ⇒[user notify: e]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"trick this method into returning"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pc &larr; method length -1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">help<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["Here is how to use the Smalltalk simulator.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">thisContext runsimulated⦂ [ </span><span style="font: bold 10pt serif">place here the code you to simulate</span><span style="font: 10pt serif"> ].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Some classes in Smalltalk may not be subclassed.  Some messages<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">may not be overridden.  initSimulator tells the details. "]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">initSimulator </span><span style="font: 10pt serif">| i "these class variables of Context are used by instfield: to simulate what the microcode does to objects."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["  Context declare: &rsquo;positionFld arrayFld limitFld&rsquo;.    "<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"Rules:  There may not be a subclass of Integer.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(This is so +, -, &lt;, &gt;, ≤, ≥, =, ≠ may not be overridden).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">The following messages may NOT be redefined by any class.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">≡ (from class Object).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">class (from class Object).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">The following messages may NOT be redefined by any VariableLengthClass.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">length (from Vector, String)"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; Stream instvars.  "We need to peek inside instances of Stream"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">positionFld &larr; i find: &rsquo;position&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">arrayFld &larr; i find: &rsquo;array&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">limitFld &larr; i find: &rsquo;limit&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">litof: a<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑(method word: a+4) asObject]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">newToRun: code </span><span style="font: 10pt serif">| r v i</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[r &larr; self pop. v &larr; Vector new: code◦3.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> for⦂ i from: (code◦4 to: 1 by: ¬1) do⦂ "Move args to new tframe"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[v◦i &larr; tempframe◦(2+(stackptr &larr; stackptr-1)).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">tempframe◦(stackptr+2) &larr; nil</span><span class="tab" val="79"></span><span style="font: 10pt serif">"Nil args on caller&rsquo;s stack"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ⇑self class new sender: self receiver: r method: code<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">tempframe: v pc: code◦6 stackptr: code◦5 - 1. "Allocate a new Context"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">nextByte<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑method◦(pc &larr; pc+1)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">nonEmptyStack<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑(stackptr≠¬1)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">performing: nargs toclass: class </span><span style="font: 10pt serif">| i sel<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[i &larr; stackptr-nargs.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sel &larr; tempframe◦(i+1).</span><span class="tab" val="79"></span><span style="font: 10pt serif">"Selector is first arg"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ i&lt;stackptr do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[tempframe◦(i+1) &larr; tempframe◦(i+2).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; i+1].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">stackptr &larr; stackptr-1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self sendmess: sel byte: 0320 toclass: class]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pop<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑tempframe◦(2+ (stackptr&larr; stackptr-1))]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">push: n </span><span style="font: 10pt serif">"Push n on top of stack"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[tempframe◦(1+(stackptr&larr;stackptr+1)) &larr; n]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pushField: i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[tempframe◦(1+(stackptr&larr;stackptr+1)) &larr; receiver instfield: i+1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pushLit: i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[tempframe◦(1+(stackptr&larr;stackptr+1)) &larr; (method word: i+4) asObject]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pushLitInd: i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[tempframe◦(1+(stackptr&larr;stackptr+1)) &larr; (method word: i+4) asObject value]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pushTemp: i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[tempframe◦(1+(stackptr&larr;stackptr+1)) &larr; tempframe◦(i+1)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">restart<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pc &larr; method◦6. stackptr &larr; method◦5-1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">runsimulated⦂ cntxt </span><span style="font: 10pt serif">| ctx b i "To use the simulator say...<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">thisContext runsimulated⦂ [your code]. "<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["turn off use of BitBlt by Strings"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">b &larr; String◦↪StringBlter.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">String◦↪StringBlter &larr; false.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">cntxt push: self.  ctx &larr; cntxt.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ ctx≡self do⦂ [ctx &larr; ctx step].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"restore state of StringBlter"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">String◦↪StringBlter &larr; b.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self pop]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sendmess: sel byte: byte toclass: class </span><span style="font: 10pt serif">| cl code</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[cl &larr; class.  until⦂ cl≡nil do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[byte&lt;0320⇒ "Is it a special message?"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self specialmess: byte toclass: cl⇒ [⇑self] "Can we perform it?"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> sel &larr; SpecialOops◦(byte-0246)] "Send the special message selector"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">  sel≡nil⇒ [sel &larr; self litof: byte-0320]]. "Send the selector from the literals"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> code &larr; cl md methodorfalse: sel⇒ [⇑self docode: code toclass: cl]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">  </span><span class="tab" val="79"></span><span style="font: 10pt serif"> cl &larr; cl superclass]. "Try up the superclass chain"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> user notify: (&rsquo;Simulated message not understood: &rsquo; concat: sel asString)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">simulate⦂ cntxt<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[cntxt push: thisContext.  ⇑cntxt inspect]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">smashField: i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[receiver instfield: i+1 &larr; tempframe◦(stackptr+1)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">smashLitInd: i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(self litof: i) value &larr; tempframe◦(stackptr+1)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">smashTemp: i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[tempframe◦(i+1) &larr; tempframe◦(stackptr+1)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">specialmess: byte toclass: class </span><span style="font: 10pt serif">| "Return false if cannot do it here, else do exactly what the microcode does."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[byte&lt;0270⇒  "+, -, &lt;, &gt;, ≤, ≥, =, ≠"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self specialmess: byte toclassInteger: class];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&lt;0300⇒[⇑false];  "unused"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&lt;0304⇒   " ◦, ◦&larr;, next, next&larr; "<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self specialmess: byte toclassArray: class];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=0304⇒ "length"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ [class≡String⇒[] class≡Vector⇒[] ⇑false]. self push: (self pop length)];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=0305⇒ "≡"  [self push: self pop≡self pop]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">specialmess: byte toclassArray: class </span><span style="font: 10pt serif">| r n d i s l easy "cause ◦, ◦&larr;, next, next&larr;  to happen"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[d &larr; stackptr.  r &larr; self pop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[byte=0301 or⦂ byte=0303 ⇒[n &larr; self pop]]. " ◦&larr; or next&larr; "<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[byte&lt;0302⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[   " ◦ or ◦&larr; "<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[class≡Vector⇒[] class≡String⇒[] stackptr &larr; d. ⇑false].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; self pop. l &larr; r length]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">class≡Stream⇒ " next or next&larr; "<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s &larr; r. i &larr; (s instfield: positionFld)+1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">l &larr; (s instfield: limitFld). r &larr; (s instfield: arrayFld).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> [r class≡Vector⇒[]; ≡String⇒[]; ≡Interval⇒[] stackptr &larr; d. ⇑false].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">stackptr &larr; d. ⇑false].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">easy &larr; [r class≡Vector⇒[true]; ≡String⇒[true]; ≡Interval⇒[true] false].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(i class ≡ Integer) and⦂ (l class ≡ Integer)⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[1≤i and⦂ i≤l⇒  " bounds check "<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[easy ⇒[byte=0301 or⦂ byte=0303⇒ "in the easy case, we cheat for speed"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[r◦i &larr; n]  " ◦&larr; or next&larr; "<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">n &larr; r◦i]  " ◦ or next "<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"subclass of Vector or String"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">byte=0301 or⦂ byte =0303 ⇒[r instfield: i &larr; n] " ◦&larr; or next&larr; "<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">n &larr; r instfield: i].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self push: n.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> [byte&gt;0301⇒[s instfield: positionFld &larr; i]]. ⇑self]]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">stackptr &larr; d. ⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">specialmess: byte toclassInteger: class </span><span style="font: 10pt serif">| r n "If class is Integer, do arithmetic"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[class ≡ Integer⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[r &larr; self pop. n &larr; self pop.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> r class ≡ Integer⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self push: [byte<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=0260⇒ [r+n];  =0261⇒ [r-n];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=0262⇒ [r&lt;n];  =0263⇒ [r&gt;n]; =0264⇒ [r≤n];  =0265⇒ [r≥n];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=0266⇒ [r=n];  =0267⇒ [r≠n]]]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> stackptr &larr; stackptr+2. ⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">step </span><span style="font: 10pt serif">| byte t "Execute the next byte code and return the current Context"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[byte &larr; method◦(pc &larr; pc+1).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑[byte&lt;0200⇒ "load"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[byte&lt;020⇒ [self pushField: byte];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&lt;040⇒ [self pushTemp: byte-020];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&lt;0100⇒ [self pushLit: byte-040];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&lt;0160⇒ [self pushLitInd: byte-0100];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&lt;0170⇒ [self push: (self instfield: byte-0160+1)]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self push: SpecialOops◦(byte-0170+2)];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&lt;0220⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[byte=0200⇒ [self dostore; dopop];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=0201⇒ [self dostore];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=0202⇒ [self dopop];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=0203⇒ [self doreturn];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=0204⇒ [self doremotereturn];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=0205⇒ [self push: self];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=0206⇒ [self dosuper];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=0210⇒ [self pushField: self nextByte];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=0211⇒ [self pushTemp: self nextByte];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=0212⇒ [self pushLit: self nextByte];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=0213⇒ [self pushLitInd: self nextByte];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=0214⇒ [self sendmess: nil byte: self nextByte+0320<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> toclass: (tempframe◦(stackptr+1)) class]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> user notify: &rsquo;Unimplemented instruction code&rsquo;];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&lt;0260⇒ "jump"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t &larr; [byte&lt;0240⇒[(byte land: 7)+1]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"short, just mask off bfp bit for displacement"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> (byte land: 7)-4*256+self nextByte].</span><span class="tab" val="79"></span><span style="font: 10pt serif">"long, calculate displacement"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(byte land: 010)≠0⇒[self pop≡false⇒[self dojump: t]]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"bfp, do branch if top is false"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self dojump: t].</span><span class="tab" val="79"></span><span style="font: 10pt serif">"unconditional, do the branch"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self sendmess: nil byte: byte toclass: (tempframe◦(stackptr+1)) class]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Remote evaluation</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">eval </span><span style="font: 10pt serif">[user croak] primitive: 30</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">remoteCopy<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">| tResult</span><span style="font: bold 10pt serif"><br></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tResult &larr; RemoteContext new<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">sender: sender<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">receiver: receiver<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">method: method<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">tempframe: tempframe<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pc: pc+2<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">stackptr: stackptr.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tResult initialize.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ tResult<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Interpretation</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">have: receiver interpret: method<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Warning -- someone must be holding methodⓢ literals."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Warning -- do not call as self have:interpret: or cycle will result"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tempframe &larr; (Vector new: method◦3).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self restart. ⇑self interpretFor: thisContext sender]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">interpret: objectCode with: tframe<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"interpret in new context with tempframe tframe"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Warning -- someone must be holding objectCodeⓢ literals."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Warning -- do not call as self interpret:with: or cycle will result"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑(Context new<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">sender: nil receiver: receiver<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">method: objectCode tempframe: tframe<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pc: objectCode◦6 stackptr: objectCode◦5-1)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">  interpretFor: thisContext sender]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">interpretFor: sender  </span><span style="font: italic 10pt serif">"resume execution"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[PriorityInterrupt new run: self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Deallocation</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">destroyAndReturn: value<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[thisContext sender &larr; sender.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tempframe all &larr; nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑value]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">eraseFully<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[tempframe≡nil⇒ []<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tempframe all &larr; nil. tempframe &larr; nil]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">release | s</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"release frames to break cycles"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ [tempframe≡nil⇒[] tempframe all&larr; nil. tempframe &larr; nil].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">receiver&larr; nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sender≡nil⇒[] <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">not sure if this works correctly</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"[sender Isnt: Context⇒[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ (sender Is: Context) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s&larr; sender instfield: 1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">sender instfield: 5&larr; nil.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s≡nil⇒[⇑self] sender&larr; s]]]."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sender release]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">releaseFully </span><span style="font: 10pt serif">| c </span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"nullify frames to break cycles"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[c &larr; self.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> until⦂ c≡nil do⦂ [c eraseFully. c &larr; c sender]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">releaseTo: pContext<br></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sender ≡ pContext ⇒ [ sender &larr; nil. ]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">sender releaseTo: pContext.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">sender &larr; nil.<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪Context under: &rsquo;Kernel Classes&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"RemoteContext"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;RemoteContext&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Context<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo; <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fSavedPC<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fSavedStackptr<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>CONTEXT FOR REMOTE CODE</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>REMOTE CONTEXT</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">caller<br></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ tempframe ◦ (fSavedStackptr+2)<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">cleancopy<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">| tResult<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tResult &larr; RemoteContext new<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">sender: sender<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">receiver: receiver<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">method: method<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">tempframe: tempframe copy<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pc: pc<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">stackptr: stackptr.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tResult initialize.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ tResult<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">initialize<br></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fSavedPC &larr; pc.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fSavedStackptr &larr; stackptr.<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">releaseTo: pContext<br></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tempframe ◦ (fSavedStackptr+2) ≡ pContext ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ tempframe ◦ (fSavedStackptr+2) &larr; nil. ]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">tempframe ◦ (fSavedStackptr+2) releaseTo: pContext.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">tempframe ◦ (fSavedStackptr+2) &larr; nil.<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">restart<br></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pc &larr; fSavedPC.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">stackptr &larr; fSavedStackptr.<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪RemoteContext under: &rsquo;Kernel Classes&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"UserView"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;UserView&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;screenrect "&lt;Rectangle&gt; current screen size"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">vtab "&lt;Integer=0mod2&gt; offset from hardware top"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">htab "&lt;Integer=0mod16&gt; offset from hardware left"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">scale "&lt;Integer=1 or 2&gt; 2 means double bits mode"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">color "&lt;Integer=0 or 1&gt; 1 means reverse field"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">projectWindow "my representative in an overview"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">disp "&lt;dispframe&gt; default message stream"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sched "&lt;Vector&gt; Windows in this view"&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;currentCursor mxoffset myoffset screenMenu &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>This is a melting-pot, incorporating the notions of user interaction (mouse, keyboard), display context (current screen view), and global operations (reading the clock, leaving the system).</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Mouse, Cursor, Keys</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">anybug </span><span style="font: 10pt serif">[⇑self buttons &gt;0 or⦂ (mem◦0177100) &lt; 0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">anykeys </span><span style="font: 10pt serif">[⇑self keyset&gt;0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">bluebug </span><span style="font: 10pt serif">[⇑self buttons=2]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">buttons<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑7-(mem◦0177030 land: 7)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">currentCursor </span><span style="font: 10pt serif">[⇑currentCursor]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">currentCursor: c </span><span style="font: 10pt serif">| coff oldpt [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">oldpt &larr; self mp.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">currentCursor &larr; c.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">coff &larr; c offset.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">mxoffset &larr; coff x - htab.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">myoffset &larr; coff y - vtab.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self cursorloc &larr; oldpt]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">cursorloc &larr; pt <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[mem◦0424 &larr; pt x - mxoffset*scale.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">mem◦0425 &larr; pt y - myoffset*scale]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">kbck </span><span style="font: 10pt serif">| t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t &larr; self rawkbck⇒[⇑kbMap◦t] self purgealittle. ⇑false ]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">kbd </span><span style="font: 10pt serif">[until⦂ self rawkbck do⦂ [self purgealittle]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑kbMap◦self rawkbd]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">kbd: char<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"stuff char into the event queue"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[char is: String ⇒[char &larr; char◦1]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Events next &larr;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">UserEvent new<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">x:</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self x</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"event x"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">y:</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self y</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"event y"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">type:</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">1</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"2=up, 1=down"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">stroke:</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(kbMap find: char)</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"1-336"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">elapsed:</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">Events</span><span class="tab" val="79"></span><span style="font: 10pt serif">elapsedtime</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"1-32767 sixtieths of a sec"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">time:</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">Events time + Events elapsedtime.]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">kbdnext </span><span style="font: 10pt serif">| event</span><span style="font: bold 10pt serif"> </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"returns next character (mapped) if any; otherwise false"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(event &larr; Events dequeue) or⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(event &larr; Events primitiveDequeue)] do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">event isKbdDown⇒ [⇑kbMap◦event stroke]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"self rawkbck⇒ [⇑kbMap◦Events next stroke]"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">keyset<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Fix a bug in sysdefs."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑037 - ((mem◦0177030 lshift: ¬3) land: 037)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">leftShiftKey </span><span style="font: 10pt serif">["left shift key down?" ⇑(mem◦0177036 land: 0100) = 0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">mp<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[scale=2⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑Point new<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">x: mem◦0424 + mxoffset / 2<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">y: mem◦0425 + myoffset / 2]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑Point new<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">x: mem◦0424 + mxoffset<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">y: mem◦0425 + myoffset]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">mpnext </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">return next mouse point if red button or tablet is down; otherwise false</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self redbug⇒ [⇑self mp]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">nobug<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self anybug ≡ false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">rawkbck </span><span style="font: 10pt serif">| event</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"flush event queue until down keyboard event or queue empty."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[while⦂ (event &larr; Events peek) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[event isKbdDown ⇒[⇑event stroke] Events next].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"if queue empty, return false"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">rawkbd </span><span style="font: 10pt serif">| stroke<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[until⦂ (stroke &larr; self rawkbck) do⦂ [].</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"wait for activity"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">Events next.  ⇑stroke</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"if key down, pop queue and return stroke"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">redbug </span><span style="font: 10pt serif">[⇑self buttons=4 or⦂ (mem◦0177100) &lt; 0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">tablet </span><span style="font: 10pt serif">[⇑(mem◦0177100) ≠ 0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">tabletabsolute </span><span style="font: 10pt serif">[mem◦0126 &larr; 1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">tabletbug </span><span style="font: 10pt serif">[⇑(mem◦0177100) &lt; 0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">tabletrelative </span><span style="font: 10pt serif">[mem◦0126 &larr; ¬1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">waitbug<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[until⦂ self anybug do⦂ [] ⇑self mp]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">waitclickbug<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self waitnobug. ⇑self waitbug]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">waitnobug<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[while⦂ self anybug do⦂ [] ⇑self mp]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">waitnokey </span><span style="font: 10pt serif">[until⦂ self keyset=0 do⦂ [self rawkbck]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">x </span><span style="font: 10pt serif">[⇑mem◦0426 - htab</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"cursorx, horiz tab adjusted"</span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">y </span><span style="font: 10pt serif">[⇑mem◦0427 - vtab</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"cursory, vert tab adjusted"</span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">yellowbug </span><span style="font: 10pt serif">[⇑self buttons=1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Screen Views</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">bugScreenMenu<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["see classInit"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">screenMenu bug<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=1⇒[projectWindow≡nil⇒[] projectWindow runParent];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=2⇒[user quit];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=3⇒[self restartup: ProjectWindow init];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=4⇒[self restartup: BrowseWindow default];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=5⇒[self restartup: (CodeWindow new class: UserView selector: ↪workspace<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">para: (UserView code: ↪workspace) formerly: false)];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=6⇒[user displayoffwhile⦂ [self reclaim]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">color: color scale: scale</span><span class="tab" val="79"></span><span style="font: 10pt serif">[self install]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">copyIn: p<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑UserView new<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">screenrect: screenrect copy<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">vtab: vtab htab: htab scale: scale color: color<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">projectWindow: p<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">disp: disp sched: ↪()]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">displayoffwhile⦂ expr </span><span style="font: 10pt serif">| t v<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["t &larr; mem◦0420. mem◦0420 &larr; 0."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">t &larr; mem◦067. mem◦067 &larr; 58 "disp text frame maxY/2 ?".<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">v &larr; expr eval.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">mem◦067 "0420" &larr; t. ⇑v]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">install<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self screenextent: screenrect extent tab: htab⌾vtab]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">projectWindow </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[projectWindow≡nil⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[projectWindow &larr; ProjectWindow new.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">projectWindow userview: self changes: Changes parent: projectWindow]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑projectWindow]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">reconfigure </span><span style="font: 10pt serif">[] primitive: 62</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">restoredisplay<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[mem◦0420 &larr; 060. mem◦067 &larr; screenrect height/2]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">screenextent: extent tab: tab </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">mem◦065 &larr;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(color*040000)+[scale=2⇒[0100000] 0]+(tab x/16*0400)+(extent x/16|2).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">mem◦067 &larr; extent y*scale/2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">mem◦063 &larr; 1 max: tab y/2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">htab &larr; tab x|16.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">vtab &larr; mem◦063*2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">screenrect &larr; 0⌾0 rect: (extent x|32)⌾(extent y|2).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self currentCursor: currentCursor;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">reconfigure; restore]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">screenrect </span><span style="font: 10pt serif">[⇑screenrect]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">screenrect: screenrect vtab: vtab htab: htab scale: scale color: color projectWindow: projectWindow disp: disp sched: sched</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Window Scheduling</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">leaveTop</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">leave the top window if there is one</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[sched length=0⇒[]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(sched◦1) leave]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">promote: window<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[sched promote: window]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">restart </span><span style="font: 10pt serif">| i <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[Events ≡ nil ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[Events &larr; EventQueue init. </span><span style="font: italic 10pt serif">"Top init3.  initialize Event queue and Time interrupt"</span><span style="font: 10pt serif">]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">NormalCursor topage1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self restart⦂ [user run]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">restart⦂ code </span><span style="font: 10pt serif">| u<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[u &larr; code cleancopy. u sender &larr; nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">thisContext sender releaseFully.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">thisContext sender &larr; nil.</span><span class="tab" val="79"></span><span style="font: 10pt serif">code &larr; nil. </span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"release caller chain"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">MessageDict new freeMethods.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"release held code"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">disp frame flash.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ true do⦂ [u eval]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">restartup: window<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ </span><span style="font: italic 10pt serif">"Equivalent to schedule new window, restart, and redbug in window, except firsttime is already done."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">thisContext sender releaseFully. thisContext sender &larr; nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">NormalCursor topage1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self schedule: window.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">thisContext tempframe all &larr; nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self run: true]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">restore </span><span style="font: 10pt serif">| w<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[screenrect clear.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[projectWindow≡nil⇒[] projectWindow putTitle].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ w from: (sched length to: 1 by: ¬1) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(sched◦w) show]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">run<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self run: false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">run: topFlag </span><span style="font: 10pt serif">| i w forward</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"topFlag means sched◦1 already is awake"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[forward &larr; [topFlag⇒ [w&larr;sched◦1. while⦂ w eachtime do⦂ []. w lasttime] true].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ true do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[i&larr;0.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ [(i&larr;i+1)&gt;sched length⇒[]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">w&larr; [forward⇒[sched◦i] sched◦(sched length+1-i)].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">w firsttime] do⦂ []<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">i&gt;sched length⇒</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"check for bug in empty space"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user yellowbug⇒[self bugScreenMenu]]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">sched promote: w.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ w eachtime do⦂ []<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">forward&larr; w lasttime]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sched </span><span style="font: 10pt serif">[⇑sched]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">schedule: window<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[sched≡nil⇒[sched &larr; window inVector]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sched &larr; window inVector concat: sched]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">scheduleOnBottom: window<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[sched≡nil⇒[sched &larr; window asVector]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sched &larr; sched concat: window asVector]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">topWindow </span><span style="font: 10pt serif">[⇑sched◦1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">unschedule: window </span><span style="font: 10pt serif">| t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[0&lt;(t&larr; sched find: window)⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[sched &larr; sched◦(1 to: t-1) concat: sched◦(t+1 to: sched length)]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Notify Window</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">notifier: titleString level: lev interrupt: flag<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Restore the full display.  Schedule a one-paned window to notify the user that errorString happened."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self restoredisplay.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">NotifyFlag≡false⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[disp cr;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">append: &rsquo;NotifyFlag is false...&rsquo;; cr;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">append: &rsquo; top-blank shows stack, user restart aborts,&rsquo;; cr;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">append: &rsquo; tempframe shows args, ctrl-d proceeds&rsquo;; cr;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">append: titleString; cr; show.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(Top◦lev) debug. ⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑NotifyWindow new of: titleString level: lev interrupt: flag]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">notifier: titleString stack: stack interrupt: flag<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Restore the full display.  Schedule a one-paned window to notify the user that errorString happened."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self restoredisplay.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">NotifyFlag≡false⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[disp cr;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">append: &rsquo;NotifyFlag is false...&rsquo;; cr;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">append: &rsquo; sender debug shows stack, user restart aborts,&rsquo;; cr;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">append: &rsquo; tempframe shows args, ctrl-d proceeds&rsquo;; cr;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">append: titleString; cr; show.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">stack debug. ⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑NotifyWindow new of: titleString stack: stack interrupt: flag]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">notify: errorString </span><span style="font: 10pt serif">| notifyWindow<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Create a notify window looking at the Context stack"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">notifyWindow &larr; self notifier: errorString stack: thisContext sender interrupt: false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">notifyWindow⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[thisContext sender &larr; nil.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> Top currentPriority=1⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self restartup: notifyWindow]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self scheduleOnBottom: notifyWindow.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> Top errorReset]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑nil]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Dialog Window</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">clear</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"clear disp of debris and characters"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[disp clear]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">clearshow: str<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[disp clear; append: str; show]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">cr </span><span style="font: 10pt serif">[disp cr]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">croak<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self notify: &rsquo;A primitive has failed.&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">ev<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[disp ev]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">frame</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"return rectangle of dialogue window"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑disp text frame]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">newdisp </span><span style="font: italic 10pt serif">"for when some class associated with running Dispframe  changed"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self unschedule: disp.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">disp &larr; Dispframe new rect: (8⌾0 rect: 150⌾96).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self schedule: disp ; clearshow: &rsquo;New Dialogue window created.<br>&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">newdisploc: origin and: corner </span><span style="font: italic 10pt serif">"for moving disp"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"user newdisploc: 8⌾0 and: 150⌾96"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(disp text frame inset: ¬2⌾¬2) clear.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">disp text frame &larr; origin rect: corner.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">disp show]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">next &larr; x </span><span style="font: 10pt serif">["simulate a Vector Stream"</span><span class="tab" val="79"></span><span style="font: 10pt serif">disp cr; print: x; show]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">print: x </span><span style="font: 10pt serif">[disp print: x; show]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">read </span><span style="font: 10pt serif">[⇑disp read]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">request: s</span><span style="font: 10pt serif">[⇑disp request: s]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">show </span><span style="font: 10pt serif">[disp outline; show]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">show: str<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[disp append: str; show]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">space<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[disp space]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">tab </span><span style="font: 10pt serif">[disp tab]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Time</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">convertTime: s returnSecs: format </span><span style="font: 10pt serif">| d dd t dfirst dlast m570 m571 [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">s is total seconds from midnight Jan 1 1901 GMT (Greenwich mean time).<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">see maxc &lt;AltoDocs&gt;AltoTime.Press for details</span><span style="font: 10pt serif">"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">time zone specific parameters</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">m570 &larr; mem◦0570. m571 &larr; mem◦0571.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">adjust for time zone</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s &larr; s + (([m570 ≥ 0⇒ ["</span><span style="font: italic 10pt serif">west</span><span style="font: 10pt serif">" ¬1] "</span><span style="font: italic 10pt serif">east</span><span style="font: 10pt serif">" 1]) * (<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(3600 * ("</span><span style="font: italic 10pt serif">hours</span><span style="font: 10pt serif">" m570 bits: (1 to: 4))) +<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(60 * ("</span><span style="font: italic 10pt serif">additonal minutes</span><span style="font: 10pt serif">" m571 bits: (1 to: 6))))).<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">t &larr; s intdiv: 86400.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">current day (in local standard time)</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">d &larr; Date new fromDays: t◦1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[format⇒ [] t &larr; Time new fromSeconds: t◦2].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">check for DST. correct DST parameters for nonleap years and<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">round to previous Sunday if necessary</span><span style="font: 10pt serif">"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">day of the year on or before which DST takes effect</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dfirst &larr; m570 land: 0777 "bits: (7 to: 15)".<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[dfirst = 366⇒ ["</span><span style="font: italic 10pt serif">DST not in effect</span><span style="font: 10pt serif">" false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(dd &larr; d day) ≥ (dfirst &larr; dfirst + d leap - 1)⇒ [<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">day of the year on or before which DST ends</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">dlast &larr; (m571 land: 0777 "bits: (7 to: 15)") + d leap - 1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">dd &lt; dlast "</span><span style="font: italic 10pt serif">if false, definitely after</span><span style="font: 10pt serif">" and⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">dd &lt; ((Date new day: dlast year: d year) previous: 6) day]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">possibly earlier than or at beginning of range</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dd ≥ ((Date new day: dfirst year: d year) previous: 6) day]⇒ [<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">daylight savings time in effect. add an hour</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">format⇒ [s &larr; s + 3600]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">t hours = 23⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">d &larr; d+1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">t hours: 0]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">t hours: t hours+1]].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">return either total seconds or Date and Time</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">format⇒ [⇑s] ⇑d,t]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dateAndTime: secs </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">secs is a String of 4 characters representing seconds (in GMT) since Jan 1 1901.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">convert it to a LargeInteger (rawtotalsecs:), then return a Vector (Date, Time),<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">which is corrected for local time zone and daylight savings</span><span style="font: 10pt serif">"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self convertTime: (self rawtotalsecs: secs) returnSecs: false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">now </span><span style="font: 10pt serif">[⇑self dateAndTime: self timewords]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">rawtotalsecs </span><span style="font: 10pt serif">[⇑self rawtotalsecs: self timewords]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">rawtotalsecs: secs </span><span style="font: 10pt serif">| s [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">secs is a String of 4 characters representing seconds (in GMT) since Jan 1 1901.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">copy (in reverse order) to a Natural string, then return a LargeInteger"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s &larr; Natural new: 4.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s◦1 &larr; secs◦4.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s◦2 &larr; secs◦3.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s◦3 &larr; secs◦2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s◦4 &larr; secs◦1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑LargeInteger new bytes: s neg: false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">ticks </span><span style="font: 10pt serif">"Return the 38.08-millisecond interval timer"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑mem◦0430]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">time </span><span style="font: 10pt serif">[⇑self now◦2]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">time⦂ expr </span><span style="font: 10pt serif">| t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t &larr; self ticks.  expr eval.  ⇑self ticks-t]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">timewords </span><span style="font: 10pt serif">| s [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">seconds (in GMT) since Jan 1 1901: as a String</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s &larr; String new: 4.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s word: 1 &larr; mem◦0572; word: 2 &larr; mem◦0573.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑s]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">today </span><span style="font: 10pt serif">[⇑self now◦1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">totalsecs </span><span style="font: 10pt serif">[⇑self totalsecs: self timewords]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">totalsecs: secs </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">convert from GMT to local and correct for Daylight Savings</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self convertTime: (self rawtotalsecs: secs) returnSecs: true]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Changes</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">changedCategories </span><span style="font: 10pt serif">| titles space str<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["return a vector of the names of class categories which have been changed"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">space &larr; &rsquo; &rsquo;◦1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">titles &larr; HashSet new init.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ str from: Changes contents do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[titles insert: (<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">SystemOrganization invert: ((Stream new of: str) upto: space) unique)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑titles contents<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">changedClasses </span><span style="font: 10pt serif">| titles space str<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["return a vector of the names of classes which have been changed"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">space &larr; &rsquo; &rsquo;◦1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">titles &larr; HashSet new init.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ str from: Changes contents do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[titles insert: ((Stream new of: str) upto: space). "class title"].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑titles contents<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">changedMessages </span><span style="font: 10pt serif">[⇑Changes contents sort]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">noChanges </span><span style="font: 10pt serif">[Changes init]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>System quit/resume</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">backup   </span><span style="font: italic 10pt serif">"back up smalltalk on ivy and resume"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ivy open; delete: &rsquo;small.boot&rsquo;; store: &rsquo;small.boot&rsquo;; close]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hasXM<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["return true if this is XM Smalltalk"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑(mem◦0147)≠0 </span><span style="font: italic 10pt serif">"1 for XM, 0 for normal"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">InLd: fileid  "write out the core image, then load in OS"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user notify: &rsquo;file problem&rsquo;] primitive: 85</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">overlay: fileid </span><span style="font: 10pt serif">| t [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dp0 stampBoot.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self releaseExternalViews.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">put the ethernet to sleep</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[E≡nil⇒ [] E sleep].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">turn off display during quit/resume</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">t &larr; mem◦0420. mem◦0420 &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self InLd: fileid.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">we start here after a resume</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">mem◦0420 &larr; t.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ user keyset&gt;0 do⦂ [user show: &rsquo;The keyset is stuck&rsquo;; cr]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">quit <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self quitFrom: self </span><span style="font: italic 10pt serif">"yup"</span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">quitFrom: controller<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self overlay: ↪(0 0 0 0 0).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self hasXM⇒[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">screenrect clear.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">controller restore]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">quitThen: str </span><span style="font: 10pt serif">| rem rest ["</span><span style="font: italic 10pt serif">quit, then have OS execute str</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rem &larr; (dp0 file: &rsquo;rem.cm&rsquo;) readonly.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rest &larr; rem next: rem length.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rem readwrite; reset; append: str; cr; append: rest; close.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self quit]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">quitThen: s continue: r </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">something for O.S. to do</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(dp0 oldFile: &rsquo;rem.cm.&rsquo;) settoend;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">append: s; append: &rsquo;; &rsquo;;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">append: [r⇒ [&rsquo;Resume.~ small.boot&rsquo;] &rsquo;Quit.~; Resume.~ small.boot&rsquo;];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">cr; flush]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self quit]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">releaseExternalViews </span><span style="font: 10pt serif">| t [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">close some things that we know about, everything else gets released</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Sources close. dp0 close. dp1 close.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">release (obsolete) some external views, usually File related</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ t from: externalViews length to: 1 by: ¬1 do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(externalViews◦t) release. externalViews◦t &larr; nil].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">externalViews reset]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">Swat </span><span style="font: 10pt serif">[] primitive: 90</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Misc System Stuff</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">screenMenu &larr; Menu new string:<br>&rsquo;exit to overview<br>quit<br>open a subview<br>open a browser<br>open a workspace<br>reclaim&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classNames</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"an alphabetized Vector of all Smalltalk class titles uniqued"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| classes x c<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">AllClassNames≡nil⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">classes &larr; (Vector new: 20) asStream.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ x from: Smalltalk do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">c &larr; Smalltalk ◦ x.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(c is: Class) or⦂ (c is: VariableLengthClass)⇒ [classes next &larr; x].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">AllClassNames &larr; classes contents sort.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑AllClassNames<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">file: file classes: classes changesOnly: ch </span><span style="font: 10pt serif">| cl [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">called by </span><span style="font: bold 10pt serif">UserView release</span><span style="font: italic 10pt serif"> to write just changes or entire system on a<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">new file.  also, see comment in </span><span style="font: bold 10pt serif">Class archiveOn:changesOnly:</span><span style="font: 10pt serif">.</span><span style="font: italic 10pt serif"><br><br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">write class comment and message text onto a </span><span style="font: bold 10pt serif">FileStream</span><span style="font: italic 10pt serif"> (which could refer<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">to an </span><span style="font: bold 10pt serif">AltoFile, ILFile</span><span style="font: italic 10pt serif">, etc.). either just changes or everything are<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">written and replaced with </span><span style="font: bold 10pt serif">RemoteParagraph</span><span style="font: italic 10pt serif"> references</span><span style="font: 10pt serif">"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ch⇒ [file settoend] file reset].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">file readwriteshorten.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ cl from: classes do⦂ [Smalltalk◦cl archiveOn: file changesOnly: ch].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">file close; readonly]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">growSmalltalk: numberofdiskpages<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">for preemptive growth of Small.boot on disk</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[dp0 growSmalltalkBy: numberofdiskpages]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">initCompiler  </span><span style="font: italic 10pt serif">"Initialize shared variables of parser and generators"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| code sel c t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Smalltalk declare: ↪(TokenCodes ByteCodes).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[TokenCodes≡nil⇒ [TokenCodes&larr;SymbolTable new init: 32]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ByteCodes≡nil⇒ [ByteCodes&larr;SymbolTable new init: 32. Integer sharing: ByteCodes]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">TokenCodes<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">declare:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">↪(aRightBrack aPeriod </span><span style="font: italic 10pt serif">"First 2 in this order"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">aLeftPar aSemicolon aCondArrow aHand aReturnArrow<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">aLeftBrack aRightPar aLeftArrow<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">aBinary </span><span style="font: italic 10pt serif">"All above must be less, all below must be greater"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">aNumber aString </span><span style="font: italic 10pt serif">"All below must be in that order"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">aKeyword aGibberish aColon aDigit aWord)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">as:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">↪(1 2<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">3 4 5 6 7<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">8 9 10<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">20<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">30 31<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">41 42 43 44 45<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ByteCodes<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">declare:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">↪(toLoadField toLoadTemp toLoadLit toLoadLitInd<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">toLoadCtxt toLoadTempframe<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">toLoadConst toLoad0 toLoad1 toLoadSelf toLoadNil toLoadFalse toLoadTrue<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">toSmashPop toSmash toPop toReturn toEnd toLoadThisCtxt toSuper<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">toShortJmp toShortBfp toLongJmp toLongBfp<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">toPlus toMinus toGtr toGeq toNext toEq toNew toAsStream<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">toSendLit)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">as:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">↪(0 16 32 64<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">112 116<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">120 121 122 113 125 126 127<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">128 129 130 131 132 133 134<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">144 152 160 168<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">176 177 179 181 194 197 203 207<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">208).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">c &larr; Dictionary new init: 16.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">c insertall: ↪(&rsquo;self&rsquo; &rsquo;thisContext&rsquo; &rsquo;super&rsquo; &rsquo;nil&rsquo; &rsquo;false&rsquo; &rsquo;true&rsquo;)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">with: ↪(113 133 134 125 126 127).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ByteCodes declare: ↪stdPrimaries as: c.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">c &larr; Dictionary new init: 64.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">code &larr; 175.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ sel from: SpecialOops ◦(10 to: SpecialOops length) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ </span><span style="font: italic 10pt serif">"Atoms not wanted here -- only strings and characters"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">code &larr; code+1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">sel≡nil ⇒ []<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">sel &larr; [sel length=1 and⦂ (sel◦1) isletter ≡ false ⇒ [sel◦1] sel asString].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">c insert: sel with: code.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ByteCodes declare: ↪stdSelectors as: c.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">c &larr; Dictionary new init: 8.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">c insertall: ↪(&rsquo;while⦂do⦂&rsquo; &rsquo;until⦂do⦂&rsquo; &rsquo;for⦂to:do⦂&rsquo; &rsquo;for⦂from:do⦂&rsquo; &rsquo;for⦂from:to:by:do⦂&rsquo; &rsquo;for⦂from:to:do⦂&rsquo; &rsquo;if⦂then⦂else⦂&rsquo; &rsquo;if⦂then⦂&rsquo;)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">with: ↪(whiledo:args: untildo:args: fortodo:args: forfromdo:args: forfromtobydo:args: forfromtodo:args: ifthenelse:args: ifthen:args:).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ByteCodes declare: ↪inLineMsgs as: c.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ t from: ↪((toLoadFieldLong 0210) (toLoadTempLong 0211) (toLoadLitLong 0212)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(toLoadLitIndLong 0213) (toSendLitLong 0214)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(codeLoadField 0400) (codeLoadTemp 01000) (codeLoadLit 01400)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(codeLoadLitInd 02000) (codeSendLit 02400)) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ByteCodes declare: t◦1 as: t◦2]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">oopsToFile </span><span style="font: 10pt serif">| a c i t s cs f ts<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[f &larr; dp0 file: &rsquo;oops&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">cs &larr; user classNames transform⦂ a to⦂ Smalltalk◦a.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">t &larr; cs transform⦂ a to⦂ a asOop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ts &larr; t permutationToSort.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: ts do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[f append: (t◦i) base8; tab; append: (cs◦i) title; cr].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ c from: cs◦ts do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[f cr; append: c title; cr.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s &larr; c md contents.</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"selectors"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">t &larr; s transform⦂ a to⦂ (c md method: a) asOop.  </span><span style="font: italic 10pt serif">"method oops"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: t permutationToSort do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[f tab; append: (t◦i) base8; tab; append: s◦i; cr]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user show: c title; cr]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f close]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printCrossReference: classNames on: f </span><span style="font: 10pt serif">| dict m md frame l each s class<br>"user displayoffwhile⦂ [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user printCrossReference: user classNames<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">on: (dp0 file: &rsquo;CrossReference.Press&rsquo;)].<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user classNames<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(SystemOrganization category: &rsquo;xyz&rsquo;)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">↪(class1 class2)"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[dict &larr; Dictionary init: 200.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ m to: 32 do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[dict insert: SpecialOops◦(9+m) with: ↪((Primitives) ()) copy].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">classNames transform⦂ each to⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user show: each; space.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">md&larr; (Smalltalk◦each) md.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ m from: md do⦂</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Tally all the UniqueString literals"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span class="tab" val="79"></span><span style="font: 10pt serif">[s&larr; dict lookup: m⇒[] dict insert: m with: (s&larr; ↪(()()) copy)].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s◦1 has: each⇒[] s◦1&larr; s◦1, each.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ l from: (md literals: m) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[l is: UniqueString⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span class="tab" val="79"></span><span style="font: 10pt serif">[s&larr; dict lookup: l⇒[] dict insert: l with: (s&larr; ↪(()()) copy)].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s◦2 has: each⇒[] s◦2&larr; s◦2, (each,m)]]]].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f&larr; f asPressPrinter.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f stamp.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">frame&larr; f defaultframe.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Print the messages out sorted"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ m from: dict contents sort do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user show: m; space.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">f frame&larr; frame.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">md&larr; dict◦m.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s&larr; (String new: 200) asStream.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s append: m; append: [(md◦1) length=0⇒[&rsquo; ( - undefined -  &rsquo;] &rsquo; (&rsquo;].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ l from: (md◦1) sort do⦂ [s append: l; append: &rsquo;, &rsquo;].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s skip: ¬2; append: &rsquo;)&rsquo;.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">f print: (s contents asParagraph maskrun: 1 to: m length under: 1 to: 1).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">f frame&larr; (frame minX+500)⌾frame minY rect: frame corner.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s reset.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[md◦1 has: ↪Primitives⇒[s append: &rsquo;untallied.&rsquo;. md◦2&larr; ↪()]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(md◦2) length=0⇒[s append: &rsquo;- unreferenced -&rsquo;]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">class&larr; ↪-.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ l from: (md◦2) sort do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span class="tab" val="79"></span><span style="font: 10pt serif">[l◦1=class⇒[s append: &rsquo;, &rsquo;]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[class≠↪-⇒[s cr]]. s append: &rsquo;(&rsquo;; append: l◦1; append: &rsquo;) &rsquo;.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">class&larr; l◦1].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s append: l◦2].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">f print: s contents asParagraph].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f close; toPrinter]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">purgealittle </span><span style="font: 10pt serif">[] primitive: 89</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">reclaim </span><span style="font: 10pt serif">| c cl cv</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">" Should only be called from bugScreenMenu !! "<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user cr; show: &rsquo;Reclaiming... &rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">cl&larr; CodePane, ScrollBar, PanedWindow, ListPane, Generator, Parser, BitImage, Document, DocumentEditor, Image.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">cv&larr; Context allInstances.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user print: cv length.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ c from: cv do⦂ [cl has: c mclass⇒[c release]]. cv all&larr; nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user show: &rsquo; reduced to &rsquo; + Context howMany asString + &rsquo;.&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">release </span><span style="font: 10pt serif">| m [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">prepare to release this version</span><span style="font: 10pt serif"> (</span><span style="font: bold 10pt serif; text-decoration: underline">after</span><span style="font: 10pt serif"> editing </span><span style="font: bold 10pt serif">UserView version</span><span style="font: 10pt serif">)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">and possibly copying Sources file (see </span><span style="font: bold 10pt serif">writeSources:</span><span style="font: 10pt serif">)"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(m&larr; Undeclared contents) length&gt;0⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user notify: &rsquo;Undeclared contains &rsquo;+ m asString]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user displayoffwhile⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">either create a new Sources file (write all messages) or append only changes</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">m &larr; Sources directory checkName:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;&lt;Smalltalk&gt;Smalltalk.Sources.&rsquo; + user versionName.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"for repeated releases in same version.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">should also work for Sources local (if renamed)"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user writeSources: [m = Sources name⇒ [Sources] Sources directory file: m].<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">make workspace local</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">UserView md code: ↪workspace &larr; UserView code: ↪workspace.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user writeChangedMessages: (phylum file: &rsquo;&lt;Smalltalk&gt;ChangedMessages&rsquo;).].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user noChanges. user releaseMessage.]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">releaseMessage </span><span style="font: 10pt serif">[user clearshow: &rsquo;Welcome to &rsquo; + user version]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">systemStartup </span><span style="font: italic 10pt serif">"To do after system flush and installation of new core image"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[Top top.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Window classInit.<br><br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"The following screen extent seems to really fill the screen in x,<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">the Alto Hardware Manual to the contrary notwithstanding."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self hasXM⇒ ["</span><span style="font: italic 10pt serif">XM</span><span style="font: 10pt serif">" self screenextent: 640⌾800 tab: 0⌾2]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self screenextent: 640⌾480 tab: 0⌾50].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Sources release. dp0 release. dp1 release.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self releaseExternalViews.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[E≡nil⇒ [] "</span><span style="font: italic 10pt serif">ignore broadcasts</span><span style="font: 10pt serif">" E broadcastFilter: true].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(VirtualMemory new) thisvmem.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Vmem afterBirth]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">systemworkspace1</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">for system releasers only!!!<br><br>this has been partitioned into three workspaces for editing convenience:<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">systemworkspace1<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">steps 0-4: general comments, handling Sources, creating a release.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">systemworkspace2<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">steps 5-7: doing a vmem write or surgery, storing finished files on Phylum<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">systemworkspace3<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">step 8: after a release, e.g. updating press files</span><span style="font: 10pt serif"><br><br><br></span><span style="font: bold 10pt serif">0.</span><span style="font: italic 10pt serif"> This boot file should be named small.boot for vmem writing, surgery, and command file purposes.  If you made changes to the Sources disk be sure to update the current versions of (Xm)Smalltalk.Run, (Xm)Smalltalk.Syms, and (Xm)Byterp.mb on [Ivy]&lt;Smalltalk&gt;. This procedure works best on a Dorado for speed and disk space reasons, and it also can be done on an Alto (double disk O.S. required for vmem write).  Microcode changes (including making non-xm versions) must(?) be done on an Alto.  Step 5 (vmem writing) assumes enough space for another boot file.  To turn off display during execution, hold down left shift key while selecting &rsquo;doit&rsquo;.<br><br>For those who want to vmem write their own versions, do not execute steps 4, 7 or 8 without further editing of file and directory names. </span><span style="font: italic 10pt serif; text-decoration: underline">Underlined items</span><span style="font: italic 10pt serif"> are typical values and normally must be edited to be useful.<br><br></span><span style="font: 10pt serif"><br></span><span style="font: bold 10pt serif">1.</span><span style="font: italic 10pt serif"> to create an xm version:  filin changes and selected goodies. Undeclared must be empty for release to work (step 4). copy the categories of classes which have changed to systemworkspace3 (for later printing) and recompile it.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dp0 filin: ↪(&rsquo;</span><span style="font: 10pt serif; text-decoration: underline">changes.st</span><span style="font: 10pt serif">&rsquo;).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">phylum filin: ↪(&rsquo;&lt;Small-goodies&gt;</span><span style="font: 10pt serif; text-decoration: underline">xx.st</span><span style="font: 10pt serif">&rsquo;).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Undeclared contents inVector, user changedCategories<br><br><br></span><span style="font: bold 10pt serif">2.</span><span style="font: italic 10pt serif"> update version number/letter and comments in UserView version<br><br><br></span><span style="font: bold 10pt serif">3.</span><span style="font: italic 10pt serif"> the Sources file will be ordinarily be created in step 4. if only a few changes are involved, it may be somewhat faster to copy the old sources file to the new sources file (this step). then step 4 will only append changes.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">phylum store: Sources reset as: &rsquo;Smalltalk.Sources.&rsquo; + user versionName.<br><br></span><span style="font: italic 10pt serif"><br></span><span style="font: bold 10pt serif">4. </span><span style="font: italic 10pt serif">checks Undeclared, writes all or appends changed messages to Sources file, updates ChangedMessages, inits Changes, puts up greeting, and sets the default user name & password. note: this is only to be executed for releasing the Smalltalk system itself (supply the proper password!!). if you plan to do a vmem write next, better to do this as first line of step 5.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user releaseExternalViews.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">phylum name: &rsquo;Smalltalk&rsquo; password: &rsquo;</span><span style="font: 10pt serif; text-decoration: underline">password</span><span style="font: 10pt serif">&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user release.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">phylum name: &rsquo;Smalltalk-User&rsquo; password: &rsquo;Smalltalk&rsquo;.<br><br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">to write out the sources for a private version, specify which directory to use (don&rsquo;t leave Smalltalk as the default) and which categories and/or classes are to be included.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">| c classes. user releaseExternalViews. classes &larr; (Vector new: 50) asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">phylum name: &rsquo;</span><span style="font: 10pt serif; text-decoration: underline">name</span><span style="font: 10pt serif">&rsquo; password: &rsquo;</span><span style="font: 10pt serif; text-decoration: underline">password</span><span style="font: 10pt serif">&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ c from: ↪(</span><span style="font: 10pt serif; text-decoration: underline">&rsquo;category1&rsquo; class1</span><span style="font: 10pt serif">) do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">c is: String⇒ [classes append: (SystemOrganization category: c)]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">classes next &larr; c].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user file: (phylum file: &rsquo;</span><span style="font: 10pt serif; text-decoration: underline">&lt;ddd&gt;xx</span><span style="font: 10pt serif">.Sources.&rsquo; + user versionName)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">classes: classes contents changesOnly: false.<br>"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">systemworkspace2</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">for system releasers only!!!<br><br><br></span><span style="font: bold 10pt serif">5.</span><span style="font: italic 10pt serif"> if no surgery or vmem write involved, skip to step 7. start here with an xm version to make a non-xm version.  specify option below:<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">1 vmem write (includes xm surgery)<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">2 xm surgery<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">3 non-xm surgery<br>to make things totally automatic, edit in your valid Maxc name and password, otherwise Ftp will ask you later. in the case of surgery only, at the end you will have to hit a key after safing.<br></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">| option prefix dir file.<br>option &larr; </span><span style="font: 10pt serif; text-decoration: underline">1</span><span style="font: 10pt serif">.<br>dir &larr; phylum asFtpDirectory.<br>dir directoryName: &rsquo;Smalltalk-76&rsquo;.<br>prefix &larr; [option=3⇒ [&rsquo;&rsquo;] &rsquo;Xm&rsquo;].<br>for⦂ file from: ↪(&rsquo;Smalltalk.Run&rsquo; &rsquo;Smalltalk.Syms&rsquo; &rsquo;Byterp.Mb&rsquo;) do⦂ [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dir retrieve: prefix + file as: file].<br>dir closeThen: ([option=1⇒ [&rsquo;delete oldsmall.boot;<br>copy newsmall.boot &larr; small.boot; &rsquo;] &rsquo;&rsquo;]) + <br>&rsquo;ftp maxc Login/c </span><span style="font: 10pt serif; text-decoration: underline">yourname yourpassword</span><span style="font: 10pt serif"> directory/c alto retrieve/c packmu.run ramload.run;<br>Resume small.boot;<br>Ramload/N Byterp.mb/F 1000/A;<br>Smalltalk.run&rsquo;.<br><br>option=1⇒ [(VirtualMemory new) giveBirth3. user quit]<br>Vmem ramwrite: (dp0 oldFile: &rsquo;byterp.mb&rsquo;).<br>Vmem surgery: (dp0 oldFile: &rsquo;Smalltalk.run&rsquo;).<br><br><br></span><span style="font: bold 10pt serif">6</span><span style="font: italic 10pt serif">. after a successful vmem write or surgery, execute this (selecting here is tricky or type in a Dispframe)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user systemStartup.<br><br><br></span><span style="font: bold 10pt serif">7</span><span style="font: italic 10pt serif">. edit lastversion (and Smalltalk password) and execute the following, then close this window (clean up screen for non-xm?), and quit. it then renames old versions of files, stores new versions of files, e.g. remote XmSmall.Boot becomes XmSmall.Boot.5.5g and local Small.Boot becomes remote XmSmall.Boot<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">| lastversion dir file remotefile.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">lastversion &larr; &rsquo;</span><span style="font: 10pt serif; text-decoration: underline">5.5j</span><span style="font: 10pt serif">&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dir &larr; phylum asFtpDirectory.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dir login: &rsquo;Smalltalk&rsquo; password: &rsquo;</span><span style="font: 10pt serif; text-decoration: underline">password</span><span style="font: 10pt serif">&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ file from: ↪(&rsquo;Small.Boot&rsquo; &rsquo;Smalltalk.Syms&rsquo;) do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">remotefile &larr; ([user hasXM⇒ [&rsquo;Xm&rsquo;] &rsquo;&rsquo;]) + file.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">dir rename: remotefile newName: remotefile + &rsquo;.&rsquo; + lastversion;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">store: file as: remotefile].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(dp0 file: &rsquo;rem.cm&rsquo;) append: dir commands; cr; close.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user releaseMessage.<br>"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">systemworkspace3</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">for system releasers only!!!<br></span><span style="font: 10pt serif"><br><br></span><span style="font: bold 10pt serif">8.</span><span style="font: italic 10pt serif"> to update press files for system categories or cross reference listing directly on Phylum, browse or spawn this window.  edit pf to specify a list of system categories to print, usually from step 1, e.g. user changedCategories: ↪(&rsquo;Basic Data Structures&rsquo; ...) or SystemOrganization categories (for all); delete toPrinter if you don&rsquo;t want the press files printed. edit xref to be user classNames if you want to generate a cross reference listing.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> | pf xref cat.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pf &larr; </span><span style="font: 10pt serif; text-decoration: underline">↪  (&rsquo;Text Objects&rsquo; &rsquo;Kernel Classes&rsquo; &rsquo;Press File Support&rsquo; &rsquo;IFS File System&rsquo; &rsquo;Alto File System&rsquo; &rsquo;Panes and Menus&rsquo; &rsquo;Files&rsquo; &rsquo;Juniper&rsquo; &rsquo;Windows&rsquo; &rsquo;Graphical Objects&rsquo; &rsquo;Numbers&rsquo; &rsquo;Basic Data Structures&rsquo; )</span><span style="font: 10pt serif">.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">xref &larr; </span><span style="font: 10pt serif; text-decoration: underline">↪()</span><span style="font: 10pt serif">.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user releaseExternalViews.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">phylum name: &rsquo;Smalltalk&rsquo; password: &rsquo;</span><span style="font: 10pt serif; text-decoration: underline">password</span><span style="font: 10pt serif">&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ cat from: pf do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">((phylum file: (cat + &rsquo;.Press&rsquo;) asFileName) asPressPrinter) stamp;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">printclass: (SystemOrganization category: cat); close</span><span style="font: 10pt serif; text-decoration: underline">; toPrinter</span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">xref empty⇒ []<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user printCrossReference: xref on: (phylum file: &rsquo;CrossReference.Press&rsquo;).<br>"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">version </span><span style="font: 10pt serif">[⇑&rsquo;Smalltalk </span><span style="font: bold 10pt serif">5.5k</span><span style="font: 10pt serif"> &rsquo; + [user hasXM⇒ [&rsquo;XM &rsquo;] &rsquo;&rsquo;] + &rsquo;</span><span style="font: bold 10pt serif">November 24</span><span style="font: 10pt serif">&rsquo;]<br>"user version<br><br>low level disk address calculations are more general (necessary for 14-sector Dorado/Dolphin file systems)<br>better error recovery for broken and timed out Leaf connections<br>AltoFileDirectory disk page allocation/deallocation bugs fixed<br>miscellaneous printing fixes<br>Juniper fixes (2)<br>goodie: again-del-forget.st<br>create/write dates on boot file are updated at quit time<br>primitives for reading/writing 3K CRAM<br>Phylum account changes <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">default Leaf connection is logged in to &lt;Smalltalk-User&gt;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">system release uses [Phylum]&lt;Smalltalk-76&gt; instead of [Ivy]&lt;Smalltalk&gt;<br>see UserView workspace for logging into your account on Phylum, changing default printer -- for information on [Phylum]&lt;Smalltalk&gt;Release-5.5k.Bravo, .Press<br><br></span><span style="font: bold 10pt serif">September 3, 5.5j<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">duplicate packet fix<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fixes to ether (routing table, name lookup, phylum, Int32), printer names,<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">files, UserView time messages, context simulation,<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">replace in BitBlt & Paragraph, NotifyWindow cleanup,<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">Class code: always decompiles with left shift key, window printing fixes,<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">SystemOrganization globalComment contains no nulls<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">the following changes files were included:<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[phylum]&lt;small-goodies&gt;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">5.5i.changes.st, notifychange.st, window-print-changes.st<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[phylum]&lt;findit&gt;5.5i.more.changes.st<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[maxc]&lt;dolbec&gt;int32change.st<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[maxc&gt;ingalls&gt;fixes.st<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ivy]&lt;kaehler&gt;context-simulation.st<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ivy]&lt;borning&gt;context-changes.st<br><br></span><span style="font: bold 10pt serif">May 1, 5.5i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">obscure file bugs eliminated; version features added (goody: File-version.st).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Ifs multiple connections fixed; Ifs error numbers looked up in Ifs.Errors.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">duplicate packets eliminated at lowest level.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Int32 primitive fix. Juniper retransmit parameters increased<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Integer compare: LargeInteger now works<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">CodePane/FilePane &rsquo;print&rsquo; (within a CodeWindow) now prints entire Paragraph<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">rather than only part within window<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ScrollBars hide during CodePane </span><span style="font: italic 10pt serif">again & cancel</span><span style="font: 10pt serif">. </span><span style="font: italic 10pt serif">cancel</span><span style="font: 10pt serif"> saves your old text, so<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">an immediate </span><span style="font: italic 10pt serif">undo</span><span style="font: 10pt serif"> will replace the current selection with your previous text.<br><br></span><span style="font: bold 10pt serif">April 11, 5.5h<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Alto file names limited to 39 characters (&rsquo;somestring&rsquo; asFileName will fix<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">name, truncating if necessary). other misc. file, ether, simulator fixes.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">BitBlt fixed so that BitRects don&rsquo;t lose their bits<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">BitBlt used to speedup reading&writing files, sending Press files to printers<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ParagraphScanner puts underlining into Press files<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">printer names updated (PressFile classInit). hashing-changes.st included.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">after font cataclysm, get new version of Fonts.Widths before printing<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">system release procedure modified<br><br></span><span style="font: bold 10pt serif">March 6, 5.5g</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ether, file, vmem writing fixes.  cursor clipping on screen boundary.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">BitBlt used for String growing, copying, replacing<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">goodies included: display-off-after-notify.st, CodePane-doit.st,<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">context-simfix2.st, ILchanges.st, string-changes.st<br><br>see [Phylum]&lt;Smalltalk&gt; for the following files.  () surround an optional prefix or suffix.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Document.Press<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">mini-guide to Smalltalk system and user interface<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">VersionHistory<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">information about versions up to 5.5g<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ChangedMessages<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">a list of  messages which have changed<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">xxx.Press<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">press file for CrossReference or for system category &rsquo;xxx&rsquo; in current version<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">to save paper, consider consulting the LRG alcove copies<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(Xm)Small.Boot(.version)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(Xm)Smalltalk.Syms(.version)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">older versions of .Boot and .Syms are explicitly named.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Smalltalk.Sources.version<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">all Smalltalk.Sources (including the current one) are explicitly named<br><br>[Phylum]&lt;Small-Goodies&gt; contains miscellaneous bug fixes and new features (and even some documentation: goodies.bravo, .press) offered by the community of Smalltalk Users.<br>"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">versionName </span><span style="font: 10pt serif">| s [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s &larr; self version asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"skip Smalltalk"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s skipTo: 040.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"return version identification, e.g. 5.5f"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑s upto: 040]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: center">
<span style="font: bold 10pt serif">workspace<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user notify: &rsquo;Not meant to be executed&rsquo;]<br>"<br></span><span style="font: 18pt monospace">XEROX</span><span style="font: 10pt serif"> - </span><span style="font: bold 10pt serif">Learning Research Group</span><span style="font: 10pt serif"><br> <br>user screenextent: 640⌾580 tab: 0⌾50.<br>NotifyFlag &larr; true.</span><span style="font: italic 10pt serif"><br></span><span style="font: 10pt serif">Changes init.<br>user changedMessages<br>user changedClasses<br>user changedCategories<br>Undeclared contents<br></span><span style="font: italic 10pt serif"><br>to set the default printer</span><span style="font: 10pt serif"><br>PrinterName&larr;&rsquo;Menlo&rsquo;.<br>PrinterName&larr;(PressFile new) selectPrinter: PrinterName.<br><br></span><span style="font: italic 10pt serif">to change phylum to access your account<br></span><span style="font: 10pt serif">user releaseExternalViews. phylum name: &rsquo;name&rsquo; password: &rsquo;password&rsquo;.<br><br>dp0 filin: ↪(&rsquo;Changes.st&rsquo;).<br>(dp0 file: &rsquo;changes.st&rsquo;) filout.<br>(dp0 file: &rsquo;xxx&rsquo;) edit.<br>dp0 pressfilin: ↪(&rsquo;xxx.press&rsquo;).<br>(dp0 filesMatching: &rsquo;*.st&rsquo;) sort<br>dp0 list. dp0 freePages<br>dp0 delete: &rsquo;old&rsquo;<br>dp0 rename: &rsquo;old&rsquo; newName: &rsquo;new&rsquo;<br><br></span><span style="font: italic 10pt serif">for reinitializing Sources and phylum<br></span><span style="font: 10pt serif">Sources release. phylum release. Sources reopen.<br><br></span><span style="font: italic 10pt serif">to make Smalltalk Sources local</span><span style="font: 10pt serif"><br> | s. s &larr; &rsquo;Smalltalk.Sources.&rsquo;.<br>(phylum asFtpDirectory) retrieve: &rsquo;&lt;Smalltalk&gt;&rsquo; + s + user versionName as: s; close.<br>Sources on: (dp0 file: s).<br><br></span><span style="font: italic 10pt serif">to switch back to remote Sources</span><span style="font: 10pt serif"><br>Sources close; on: (phylum file: &rsquo;&lt;Smalltalk&gt;Smalltalk.Sources.&rsquo; + user versionName).<br><br><br></span><span style="font: italic 10pt serif">to filin a remote Smalltalk file</span><span style="font: 10pt serif"><br>phylum filin: ↪(&rsquo;&lt;Small-goodies&gt;xxx.st&rsquo;).<br><br></span><span style="font: italic 10pt serif">to print a remote/local press file</span><span style="font: 10pt serif"><br>(phylum pressfile: &rsquo;&lt;Smalltalk&gt;xxx.press&rsquo;) toPrinter.<br>(dp0 pressfile: &rsquo;xxx.press&rsquo;) toPrinter: &rsquo;Lilac&rsquo;.<br><br>File noChanges.<br>BitRect new fromuser; edit.<br>user schedule: (defaultBitRectEditor newframe).<br><br>DocumentEditor new defaultdocument: &rsquo;test&rsquo;.<br>DocumentEditor new init: (Document new fromPress: &rsquo;test.document&rsquo;).<br><br></span><span style="font: italic 10pt serif"><br></span><span style="font: 10pt serif">user releaseExternalViews.<br>E sleep. E kill. E &larr; nil.<br>E &larr; Etherworld new. E broadcastFilter: true. E wakeup.<br>Sources reopen.<br><br></span><span style="font: italic 10pt serif">for primary Smalltalk access to file servers and printers at other sites.<br>substitute yourserver for phylum above, compile this workspace<br></span><span style="font: 10pt serif">PrinterName &larr; &rsquo;name-of-your-printer&rsquo;.<br>Smalltalk declare: ↪yourserver.<br>yourserver &larr; ILFileDirectory new directory: &rsquo;name-of-your-server&rsquo;.<br>yourserver name: &rsquo;Smalltalk-User&rsquo; password: &rsquo;Smalltalk&rsquo;.<br>Sources on: (yourserver file: &rsquo;&lt;Smalltalk&gt;Smalltalk.Sources.&rsquo; + user versionName).<br>Changes init.<br><br>user Swat.<br>"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">writeChangedMessages: ChangedMessages </span><span style="font: 10pt serif">| class m ms [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"append changed messages to a file (usually on [phylum])"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ChangedMessages settoend; cr; cr; asParagraphPrinter stamp.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">class &larr; &rsquo;&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ m from: user changedMessages do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ms&larr; m asStream.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(ms upto: 040)=class⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ChangedMessages append: &rsquo;, &rsquo;; append: (ms upto: 040)]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">ChangedMessages cr; append: m.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">class&larr; m asStream upto: 040].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ChangedMessages close]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">writeSources: newSources </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"write a new Sources file (usually on [phylum]Smalltalk.Sources.xxx<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(i.e. xxx = user versionName))<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">if it&rsquo;s a new file or empty, write all Sources. otherwise it better be a copy of<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">the previous Sources file (only changes will be appended. do the copy with ftp)"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user file: newSources classes: SystemOrganization<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">changesOnly: (newSources end ≡ false).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Sources close.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Sources &larr; newSources]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪UserView under: &rsquo;Kernel Classes&rsquo;.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">UserView classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"VariableLengthClass"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;VariableLengthClass&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Class<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">veryspecial: 20;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I am a class whose instances have numbered elements instead of named fields.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"gets propagated to a dummy instance"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(self new: 1) classInit]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Instance access</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">allInstances </span><span style="font: 10pt serif">[user notify: &rsquo;use allInstances: instead to specify the length range&rsquo;<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"the length ranges are 0,1,2,3,4,5,6,7,8 individually and groups 9 (to 16), 17 (to 32), 33 (to 64), 65, 129, 257, 513, 1025, 2049, and 4197"</span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">allInstances: len </span><span style="font: 10pt serif">[⇑(self allInstancesEver: len) notNil]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">allInstancesEver: len </span><span style="font: 10pt serif">| indx vec PCLs i </span><span style="font: italic 10pt serif">"returns a vector containing all instances of this class and length mixed with nils"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"for large lengths, instances come in groups with lengths within a single power of 2"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">PCLs &larr; Vmem pclassesOf: self length: len.  </span><span style="font: italic 10pt serif">"vector of PCLs"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">vec &larr; Vector new: 128*PCLs length.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: PCLs length do⦂ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(vec◦[i-1*128+1 to: i*128]) all&larr; PCLs◦i].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">thisContext destroyAndReturn:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(self fromFreelist: (Vmem freelistOffset: len) fill: vec)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">copy: inst </span><span style="font: 10pt serif">| t i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t &larr; self new: inst length.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: inst length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t◦i &larr; inst◦i]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑t]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">howMany: len </span><span style="font: 10pt serif">| v </span><span style="font: italic 10pt serif">"how many instances of this class and length are in use now?"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[v &larr; self allInstancesEver: len.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">thisContext destroyAndReturn: v length - (v count: nil)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">new<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user notify: &rsquo;use new: &lt;Integer=length&gt; here.&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">new: length<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[length&gt;16384 ⇒[user notify: length asString+<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo; is too big a String&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">length&gt;8192 ⇒[user notify: length asString+<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo; is too big a Vector&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">length&lt;0 ⇒[user notify: length asString+<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo; -- negative length is invalid&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self new: length asInteger] primitive: 29</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">recopy: inst </span><span style="font: 10pt serif">| t i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t &larr; self new: inst length.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: inst length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t◦i &larr; (inst◦i) recopy]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑t]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪VariableLengthClass under: &rsquo;Kernel Classes&rsquo;.</span></div>
    <div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">&rsquo;From Smalltalk 5.5k XM November 24 on 22 November 1980 at 2:57:08 am.&rsquo;<br></span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">"Natural"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">VariableLengthClass new title: &rsquo;Natural&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: String<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;Naturalzero &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">bytesize: 8;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>A Natural consists of digits between 0 and 255. Accessing beyond the end gives zeroes. This Class is intended to be used by people who implement nicer numbers such as LargeInteger or Rational, thus some of the messages are hard to use because they smash existing Naturals. These messages are only used on Naturals that were created by the programmer using the message.<br>Since we want to eventually have the result of a LargeInteger operation to return a SmallInteger if possible, Natural numbers do not respond to the same set of arithmetic messages as Integers. All of the messages for Natural numbers are preceeded by "nat".</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Arithmetic</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">natadd: arg </span><span style="font: 10pt serif">| shorter longer i z sum<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["returns a Natural number"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">z &larr; MachineDouble init.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self length &lt; arg length  ⇒ [longer &larr; arg. shorter &larr; self]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">longer &larr; self. shorter &larr; arg].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sum &larr; Natural new: (longer length).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: longer length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[z increaseby: longer ◦ i. z increaseby: shorter ◦ i.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">sum ◦ i &larr; z extract].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[z low ≠ 0 ⇒ [ sum &larr; sum growby: 1. sum last &larr; z low]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑sum]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">natcompare: arg </span><span style="font: 10pt serif">| i len<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"speeded up for Integer args, same speed for LargeInteger (Natural) args"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[len &larr; self length.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">arg length &lt; len⇒ [⇑3]; &gt; len⇒[⇑1]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: len to: 1 by: ¬1 do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(arg◦i) &lt; (self◦i)⇒[⇑3];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&gt; (self◦i)⇒[⇑1]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑2]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">natdiv: arg </span><span style="font: 10pt serif">| quo rem ql d div dh dnh z z2 dl q i j k l carry digit flag<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["returns a vector of (quotient, remainder)"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">l &larr; ((self length) - (arg length) + 1).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[l≤0 ⇒[⇑(Naturalzero, self)]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">d &larr; 8 - (arg last hibit).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rem &larr; self natnormalize: d. "makes a copy and shifts"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">div &larr; arg natnormalize: d. "shifts so high order word is &gt;127"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">quo &larr; Natural new: l.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dl &larr; div length - 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ql &larr; l.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dh &larr; div◦dl.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dnh &larr; [dl=1 ⇒[0](div◦(dl-1))].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">z &larr; MachineDouble init.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">z2 &larr; MachineDouble new.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ k to: ql do⦂</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"maintain quo*arg+rem=self"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[j &larr; rem length + 1 - k.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">z high &larr; rem◦j.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[z high = dh ⇒ [q &larr; ¬1]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">z low &larr; rem◦(j-1).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">q &larr; z mdiv: dh.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">z low &larr; [j&lt;3⇒[0]rem◦(j-2)].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">z2 gets: q mtimes: dnh.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">flag &larr; true.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ ((z &lt; z2) and⦂ flag) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[q &larr; q unsignedadd: ¬1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> z2 decreaseby: dnh.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> [z2 high &lt; dh ⇒ [flag &larr; false]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">z2 high &larr; z2 high - dh]]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">l &larr; j - dl.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">z2 init.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">carry &larr; 0.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: div length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[z gets: q mtimes: (div◦i).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">z2 increaseby: rem◦l.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">z2 decreaseby: carry.  "subtract q * div from rem"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">z2 decreaseby: z low.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">carry &larr; z high.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">rem◦l &larr; z2 extract.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">l &larr; l+1].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[z2 low = 255 ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[q &larr; q unsignedadd: ¬1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">l &larr; j - dl.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">z init.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: div length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[z increaseby: rem◦l.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">z increaseby: (div◦i).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">rem◦l &larr; z extract.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">l &larr; l+1]]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">quo◦(quo length + 1 - k) &larr; q.].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rem &larr; rem natunnormalize: d lookfirst: dl.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[quo last = 0 ⇒ [ql&lt;2⇒[]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">quo &larr; quo growby: ¬1]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑(quo,rem)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">natdivideandCarry: arg extra: pair </span><span style="font: 10pt serif">| i len z<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["arg is an integer &lt; 256 - returns remainder, smashes self to quotient - pair is a 2-vector of len (index of high order non-zero word in self) and a MachineDouble - be careful!!!"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">z &larr; pair ◦ 2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">z high &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">len &larr; pair ◦ 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: len to: 1 by: ¬1 do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[z low &larr; self ◦i.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self ◦ i &larr; (z mdiv: arg)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self ◦ len = 0 ⇒[len &larr; len - 1. len=0⇒[len &larr; 1]]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pair ◦ 1 &larr; len.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑z high]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">natnormalize: n </span><span style="font: 10pt serif">| x i r f digit<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["n is the number of bits to shift by. The Natural number returned will be written over repeatedly, so we must make a new one."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">r &larr; (Natural new: (self length+1)).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">x &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f &larr; n-8.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: r length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[digit &larr; self ◦i.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">r◦i &larr; (digit lshift: n) lor: x.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">x &larr; digit lshift: f.].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑r]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">natsubtract: arg </span><span style="font: 10pt serif">| shorter longer i z sum sl al ng lastdigit<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["returns an Integer that is created by this operation"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> sl &larr; self length. al &larr; arg length.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> z &larr; MachineDouble init.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> [sl = al ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[i &larr; sl.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ (((self ◦i)=(arg◦i)) and⦂ (i&gt;1)) do⦂ [i &larr; i - 1].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">sl &larr; i.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self◦i unsignedlessthan: arg◦i ⇒[longer &larr; arg. ng &larr; true. shorter &larr; self]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">longer &larr; self. shorter &larr; arg. ng &larr; false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">  sl &lt; al  ⇒ [longer &larr; arg. shorter &larr; self. ng &larr; true. sl &larr; al]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">  longer &larr; self. shorter &larr; arg. ng &larr; false].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> sum &larr; Natural new: longer length. lastdigit &larr; 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> for⦂ i to: longer length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[z increaseby: longer ◦ i. z decreaseby: shorter ◦ i.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> (sum ◦ i &larr; z extract)≠0⇒[lastdigit&larr;i]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> [lastdigit=longer length⇒[] z &larr; (Natural new: lastdigit).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: lastdigit do⦂ [z◦i &larr; sum◦i]. sum &larr; z].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ⇑LargeInteger new bytes: sum neg: ng]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">nattimes: arg </span><span style="font: 10pt serif">| prod z pl carry digit i j k<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[((self length) = 1) and⦂ ((self◦1) = 0) ⇒ [⇑Naturalzero]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pl &larr; (self length) + arg length.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">prod &larr; (Natural new: pl).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">z &larr; MachineDouble new.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: pl do⦂ [prod ◦ i &larr; 0].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: self length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[k &larr; i - 1. carry &larr; 0. digit &larr; self ◦ i.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">digit ≠ 0 ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ j to: arg length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[z gets: digit mtimes: (arg ◦ j).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">z increaseby: carry. k &larr; k + 1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">z increaseby: (prod ◦ k).  "k=i+j-1"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">prod◦k&larr; z low.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">carry &larr; z high]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">prod◦(k+1)&larr;carry]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(prod◦pl) = 0 ⇒ [⇑ prod growby: ¬1]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑prod]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">natunnormalize: n lookfirst: a </span><span style="font: 10pt serif">| x i r f digit<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[n &larr; 0 - n.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">x &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f &larr; n+8.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; a.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">digit &larr; self◦i.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ ((((digit lshift: n) lor: x)=0) and⦂ (i≠1)) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[x &larr; digit lshift: f.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; i - 1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">digit &larr; self ◦ i].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">r &larr; (Natural new: i).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">a &larr; i.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">x &larr; (self◦1) lshift: n.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: a do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[digit &larr; self ◦ (i+1).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">r◦i &larr; (digit lshift: f) lor: x.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">x &larr; digit lshift: n.].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑r]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>As yet unclassified</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">◦ n<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[super length &lt; n ⇒ [⇑0]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ⇑(super◦n)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asInteger<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self length=1⇒[⇑self◦1]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ⇑LargeInteger new bytes: self neg: false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[Naturalzero&larr;Natural new: 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> Naturalzero◦1&larr;0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ⇑self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">isLarge<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm </span><span style="font: 10pt serif">[self printon: strm base: 10]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm base: b </span><span style="font: 10pt serif">| p z n b2 x "only works if b≤10"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[p &larr; Stream default.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">z &larr; (self length, MachineDouble new).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">n &larr; Natural new: super length.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">b2 &larr; b*b.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self copyto: n.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ (((z ◦ 1) = 1) and⦂ ((n◦1)&lt;b2)) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[x &larr; (n natdivideandCarry: b2 extra: z).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> p next&larr; (x\b)+060.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> p next&larr; (x/b)+060].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(n◦1) printon: strm base: b.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm append: p contents reverse]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">species<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑Natural]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪Natural under: &rsquo;Numbers&rsquo;.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">Natural classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"Number"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;Number&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>Numbers in general</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Arithmetic</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">≠ arg<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑((self=arg) ≡ false)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">&lt; n </span><span style="font: 10pt serif">[⇑self - n &lt; 0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">= n </span><span style="font: 10pt serif">[⇑self - n = 0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">&gt; n </span><span style="font: 10pt serif">[⇑self - n &gt; 0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">abs </span><span style="font: 10pt serif">[self&lt;0⇒[⇑self * ¬1]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">between: min and: max<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑[min≤self and⦂ self≤max]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">compare: i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self &lt; i⇒ [⇑1]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self = i⇒ [⇑2]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑3]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">factorial  </span><span style="font: italic 10pt serif">"I only work for positive integer values"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self=0⇒[⇑1]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self * (self-1) factorial]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">log2 </span><span style="font: 10pt serif">| i cnt </span><span style="font: italic 10pt serif">"floor of log base 2"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self &lt; 0 ⇒[⇑(self * ¬1) log2]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self &lt; 1 ⇒[⇑((self/self) / self) log2 * ¬1]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; 1. cnt &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ self ≥ i do⦂ [i &larr; i+i. cnt &larr; cnt+1].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑cnt-1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">max: arg<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self&lt;arg⇒[⇑arg]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">min: arg<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self&gt;arg⇒[⇑arg]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sign<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑[self=0⇒ [0]; &lt;0⇒ [¬1] 1]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Conversions</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asPoint<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Return a Point with me as both coordinates."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self ⌾ self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asPtX </span><span style="font: italic 10pt serif">"pretend to be a Point for Point +-*/"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asPtY </span><span style="font: italic 10pt serif">"pretend to be a Point for Point +-*/"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asRectangle<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Return a Rectangle with me as all coordinates."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self ⌾ self rect: self ⌾ self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asRectCorner </span><span style="font: italic 10pt serif">"pretend to be a Rectangle for Rectangle +-*/"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asRectOrigin </span><span style="font: italic 10pt serif">"pretend to be a Rectangle for Rectangle +-*/"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">base8 </span><span style="font: 10pt serif">| s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s &larr; Stream default. s append: &rsquo;0&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self printon: s base: 8. ⇑s contents]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">base: b </span><span style="font: 10pt serif">| s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s &larr; Stream default.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self printon: s base: b. ⇑s contents]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm </span><span style="font: 10pt serif">[self printon: strm base: 10]</span><span class="tab" val="79"></span><span style="font: 10pt serif">"default print radix"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Subscripts</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">cansubscript: a<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self asInteger cansubscript: a]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">subscripts: a<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑a◦self asInteger]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">subscripts: a &larr; val<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑a◦self asInteger &larr; val]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Intervals, Points</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">⌾ y<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑Point new x: self y: y]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">for: n </span><span style="font: 10pt serif">[⇑Interval new from: self to: self+(n-1) by: 1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">to: x<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑Interval new from: self to: x by: 1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">to: x by: y<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑Interval new from: self to: x by: y]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">within: int </span><span style="font: 10pt serif">[⇑int start ≤ self and⦂ self ≤ int stop]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">~ x</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"synonym for </span><span style="font: bold 10pt serif">to:</span><span style="font: 10pt serif"> "</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑Interval new from: self to: x by: 1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Compatibility</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">isLarge<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">isNumber</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪Number under: &rsquo;Numbers&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"Date"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;Date&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Number<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;day year&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;monthnames secsinday &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>Implements dates. (Steve Weyer)</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">monthnames &larr; ↪(<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">January February March April May June<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">July August September October November December).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">secsinday &larr; 24*60*60]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Setting state</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">day: day month: month year: year </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[year &lt; 100⇒ [year &larr; 1900 + year]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(month &larr; self whichmonth: month)≡false⇒ [user notify: &rsquo;illegal month&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">day &lt; 1 or⦂ day &gt; (self daysinmonth: month)⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: &rsquo;illegal day in month&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">day &larr; day + (self monthday: month)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">day: day year: year </span><span style="font: 10pt serif">| d<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[while⦂ day &gt; (d &larr; self daysinyear) do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">year &larr; year + 1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">day &larr; day - d].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ day ≤ 0 do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">year &larr; year - 1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">day &larr; day + self daysinyear].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">default </span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">today</span><span style="font: 10pt serif">" ⇑user now◦1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fromDays: d </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">d = days since Jan 1 1901. There are 1461 days in a 4-year cycle.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">2000 is a leap year, so no extra correction is necessary.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">day:year: will fix things up</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">d &larr; d asInteger intdiv: 1461.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self day: 1+ (d◦2) asSmall year: 1901+ ((d◦1) asSmall *4)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Aspects</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asSeconds </span><span style="font: 10pt serif">"Seconds since the beginning of time (local time)" [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑secsinday * (self - (Date new day: 1 year: 1901))]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">day </span><span style="font: 10pt serif">[⇑day]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dayinmonth </span><span style="font: 10pt serif">[⇑day - (self monthday: self month)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dayinyear </span><span style="font: 10pt serif">[⇑day]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">daysinmonth </span><span style="font: 10pt serif">[⇑self daysinmonth: self month]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">daysinmonth: m </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑↪(31 28 31 30 31 30 31 31 30 31 30 31)◦m + [m=2⇒ [self leap] 0]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">daysinyear </span><span style="font: 10pt serif">[⇑365 + self leap]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">daysleft </span><span style="font: 10pt serif">[⇑self daysinyear - day]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">day&larr; day</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hash </span><span style="font: 10pt serif">[⇑(year lshift: 3) lxor: day]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">leap </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">year \ 4 = 0⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">year \ 100 = 0⇒ [year \ 400 = 0⇒ [⇑1] ⇑0]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑1]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">month </span><span style="font: 10pt serif">| m leap [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">leap &larr; self leap.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ m from: 12 to: 1 by: ¬1 do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(↪(0 31 59 90 120 151 181 212 243 273 304 334)◦m +<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[m &gt; 2⇒ [leap] 0] "self monthday: m") &lt; day⇒ [⇑m]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: &rsquo;illegal month&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">monthday: m </span><span style="font: italic 10pt serif">"Return first day-in-year of m&rsquo;th month"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑↪(0 31 59 90 120 151 181 212 243 273 304 334)◦m +<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[m &gt; 2⇒ [self leap] 0]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">monthname </span><span style="font: 10pt serif">[⇑monthnames◦self month]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">weekday </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑↪(Tuesday Wednesday Thursday Friday Saturday Sunday Monday)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">◦self weekdayIndex]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">weekdayIndex | a d </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[day ≤ (self monthday: 3)⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">a &larr; year-1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">d &larr; 306]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">a &larr; year.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">d &larr; ¬59 - self leap].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"Tuesday=1,..., Monday=7"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑d + day + a + (a/4) + (a/400) - (a/100) \ 7 + 1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">whichmonth: m </span><span style="font: 10pt serif">| a </span><span style="font: italic 10pt serif">"M may be a (partial) month name, or a number.  Return the month number, or false"</span><span style="font: 10pt serif"> [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">m Is: String⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">m &larr; m + &rsquo;*&rsquo;.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ a to: 12 do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"first partial match"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">m match: monthnames◦a⇒ [⇑a]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ⇑m ≥ 1 and⦂ m ≤ 12]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">year </span><span style="font: 10pt serif">[⇑year]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">year&larr; year</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Arithmetic</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">+ days </span><span style="font: 10pt serif">| t [</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">days &larr; day + days.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">t &larr; Date new.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">days &gt; 0 and⦂ days &lt; 366⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">same year</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">t day &larr; days; year &larr; year.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑t]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑t day: days year: year]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">- date<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[date is: Date⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">year = date year⇒ [⇑day - date day]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑(year-1 / 4) - (date year / 4) +<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">day + date daysleft + (year-1 - date year * 365)]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self + (0 - date)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">&lt; date </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">year = date year⇒ [⇑day &lt; date day]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑year &lt; date year]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">= date </span><span style="font: 10pt serif">[⇑day = date day and⦂ year = date year]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">&gt; date </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">year = date year⇒ [⇑day &gt; date day]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑year &gt; date year]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">previous: di </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"e.g. previous: 6 (Sunday) returns Date which is previous closest Sunday.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">note: di=self weekdayIndex returns self+0"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self + (0 - (7 + self weekdayIndex - di \ 7))]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Printing and reading</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">from: s </span><span style="font: 10pt serif">[self readfrom: s asVector "asSet" viewer format: nil]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm </span><span style="font: 10pt serif">[self printon: strm format: ↪(1 2 3 040 3 1)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm format: f </span><span style="font: 10pt serif">| i m [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">f is print format.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">1-3</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">positions to print day,month,year respectively<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">4</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">character separator<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">5</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">month format (1 month #, 2 first 3 chars, 3 entire name)<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">6</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">year format (1 year #, 2 year #\100)</span><span style="font: 10pt serif">"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">m &larr; self month.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: 3 do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[f◦i<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=1⇒ [day - (self monthday: m) printon: strm];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=2⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">f◦5<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=1⇒ [m printon: strm];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=2⇒ [strm append: monthnames◦m◦(1 to: 3)]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm append: monthnames◦m]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">([f◦6=1⇒ [year] year\100]) printon: strm].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">i&lt;3⇒ [strm next &larr; f◦4 "</span><span style="font: italic 10pt serif">separator</span><span style="font: 10pt serif">"]]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">readfrom: strm<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self readfrom: strm format: ↪(1 2 3)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">readfrom: strm format: order </span><span style="font: 10pt serif">| dmy i [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm ∢ ↪today⇒ [⇑self default]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[order ≡ nil⇒ [order &larr; ↪(1 2 3)]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dmy &larr; Vector new: 3.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: 3 "dmy length" do⦂ [dmy◦(order◦i) &larr; strm next].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self day: dmy◦1 month: dmy◦2 year: dmy◦3]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪Date under: &rsquo;Numbers&rsquo;.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">Date classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"Float"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;Float&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Number<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;halfpi sqrt2 twopi fourthpi degreesPerRadian pi radiansPerDegree ln2 &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">bytesize: 16;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">veryspecial: 3;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>These floating-point numbers are good for about 8 or 9 digits of accuracy, and the range is between plus and minus 10&uarr;4000.  Here are some valid floating-point examples:<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">8.0   13.3   0.3   2.5e6   1.27e¬300   ¬12.987654e2412<br>Mainly: use shift-minus, no imbedded blanks, little e for tens power, and a digit on both sides of the decimal point.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Arithmetic</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">≤ arg<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self≤arg asFloat] primitive: 73</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">≠ arg<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self≠arg asFloat] primitive: 76</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">≥ arg<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self≥arg asFloat] primitive: 75</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">* arg<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self*arg asFloat] primitive: 69</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">+ arg<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self+arg asFloat] primitive: 67</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">- arg<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self-arg asFloat] primitive: 68</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">/ arg<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[0.0=arg⇒[user notify: &rsquo;Attempt to divide by 0.0&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self/arg asFloat] primitive: 70</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">&lt; arg<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self&lt;arg asFloat] primitive: 71</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">= arg<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[arg isNumber⇒ [⇑self = arg asFloat] ⇑false] primitive: 72</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">&gt; arg<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self&gt;arg asFloat] primitive: 74</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hash </span><span style="font: 10pt serif">[⇑(self fpart * 100) asInteger lxor: self ipart asInteger]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">near: n </span><span style="font: 10pt serif">[⇑self near: n within: 1.0e¬4]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">near: n within: eps </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"for testing near equality, e.g. error convergence"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑(self - n) abs ≤ eps]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">negated </span><span style="font: 10pt serif">[⇑0.0-self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sameAs: arg  </span><span style="font: italic 10pt serif">"arg assumed to be of same class as self"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self=arg]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">\ arg</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"By analogy with integers"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self&lt;0.0⇒[⇑(self/arg) ipart+1.0*arg+self]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self-((self/arg) ipart*arg)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">| arg</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"By analogy with integers"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑(self/arg) ipart*arg]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Conversion</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asDegrees</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"self assumed to be in radians"</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self / radiansPerDegree]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asDirection </span><span style="font: 10pt serif">[⇑self cos ⌾ self sin]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asFloat</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asInteger</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Return an Integer = self ipart"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self asLarge] primitive: 78</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asLarge </span><span style="font: 10pt serif">| me digits nat i "convert to LargeInteger"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self&lt;0⇒[⇑(0.0-self) asLarge negated]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> digits &larr; Stream default.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> [self=0.0⇒[digits next&larr; 0]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">  me &larr; self ipart.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">  while⦂ me≥1 do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[digits next &larr; (me\256.0) asInteger.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> </span><span class="tab" val="79"></span><span style="font: 10pt serif"> me &larr; me/256.0]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> digits &larr; digits contents.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> nat &larr; Natural new: digits length.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> for⦂ i to: digits length do⦂ [nat◦i &larr; digits◦i].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ⇑LargeInteger new bytes: nat neg: false]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asRadians</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"self assumed to be in degrees"</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self * radiansPerDegree]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">copy </span><span style="font: 10pt serif">[⇑self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fpart </span><span style="font: 10pt serif">[user croak] primitive: 77</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">ipart</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Returns a Float with zero fractional part"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self-self fpart]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">recopy </span><span style="font: 10pt serif">[⇑self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">round<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑(self + [self &lt; 0⇒ [¬0.5] 0.5]) asInteger]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Math functions</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">arctan </span><span style="font: 10pt serif">| theta term y eps i  "return angle in degrees good to .02 degrees."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self = 1.0 ⇒ [⇑ 45.0].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self = ¬1.0 ⇒ [⇑ ¬45.0].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> [self*self &gt;1.0 ⇒[theta &larr; halfpi. y &larr; ¬1.0/(self*self).  term &larr; ¬1.0/(self abs).]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">theta &larr; 0.0. y &larr; 0.0 - (self*self).  term &larr; self abs].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; 1.  eps &larr; 0.0001. <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ term abs &gt; eps do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[theta &larr; theta + term.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> term &larr; term*y*(i asFloat)/((i+2) asFloat).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> i &larr; i+2].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">theta &larr; (self sign asFloat)*theta* 360.0 / twopi.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ theta] </span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">cos  </span><span style="font: italic 10pt serif">"for angles in radians"</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self&lt;0.0⇒[⇑(self+halfpi) sin]</span><span style="font: italic 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑(halfpi-self) sin]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">exp </span><span style="font: 10pt serif">| a n1 x x2 P Q [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"see Computer Approximations, pp. 96-104, p. 205 (EXPB 1065)"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self abs &gt; 9212.0 "1.0e4001 ln"⇒ [user notify: &rsquo;exp overflow&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">x &larr; self / ln2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(n1 &larr; Float new "2.0 ipow: x asInteger")<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">instfield: 1 &larr; x asInteger * 2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(x &larr; x fpart) ≥ 0.5⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">n1 &larr; n1 * sqrt2.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">x &larr; x - 0.5]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">x2 &larr; x*x.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"compute 2.0 power: x"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">P &larr; Q &larr; 0.0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"↪(0.25250428525576241933744e4 0.28875563776168927289e2) reverse copy"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ a from: ↪(28.875564 2525.0429) do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">P &larr; (P*x2) + a].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"↪(0.72857336028361108885189e4 0.375021654220866600213e3 0.1e1) reverse copy"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ a from: ↪(1.0 375.02165 7285.7336) do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">Q &larr; (Q*x2) + a].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑n1 * ((Q + (x*P))/(Q - (x*P)))]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">ipow: x</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"fixed powers in log n steps"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[x=0⇒ [⇑1.0]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">x=1⇒ [⇑self]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">x&gt;1⇒ [⇑((self*self) ipow: x/2)*(self ipow: x\2)]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑1.0/(self ipow: 0-x)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">ln </span><span style="font: 10pt serif">| a x x2 n P [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"see Computer Approximations, pp. 105-111, p. 227 (LOGE 2663)"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self ≤ 0.0⇒ [user notify: &rsquo;ln not valid for &rsquo; + self asString]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">x &larr; self + 0.0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"exponent"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">n &larr; ln2 * (((x instfield: 1) / 2) asFloat - 0.5).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"mantissa between 0.5 and 1.0".<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">x instfield: 1 &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">x &larr; x * sqrt2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">x &larr; (x - 1.0) / (x + 1.0).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">x2 &larr; x*x.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">P &larr; 0.0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"↪(0.2000000000046727e1 0.666666635059382 0.4000059794795<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">0.28525381498 0.2376245609) reverse copy"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ a from: ↪(0.23762456 0.28525381 0.40000598 0.66666664 2.0) do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">P &larr; (P*x2) + a].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑n + (x * P)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">log: base </span><span style="font: 10pt serif">[⇑self ln / base asFloat ln]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">neg</span><span style="font: bold italic 10pt serif"> </span><span style="font: italic 10pt serif">"Obsolete - use </span><span style="font: bold 10pt serif">negated,</span><span style="font: italic 10pt serif"> which is uniform for all Numbers"</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self negated]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sin </span><span style="font: 10pt serif">| x x2 sum const  </span><span style="font: italic 10pt serif">"for angles in radians"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self&lt;0.0⇒[⇑self negated sin negated];</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">" normalize to 0≤self≤(pi/4) "</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&gt;twopi⇒[⇑(self\twopi) sin];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&gt;pi⇒[⇑(self-pi) sin negated];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&gt;halfpi⇒[⇑(pi-self) sin]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sum &larr; x &larr; self.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">x2 &larr; x*x.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ const from:</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Now compute the series"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">↪(¬0.1666666664 0.0083333315 ¬1.98409e¬4 2.7526e¬6 ¬2.39e¬8)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">do⦂ [sum &larr; const*(x &larr; x*x2)+sum]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑sum]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sqrt </span><span style="font: 10pt serif">| guess i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self≤0.0⇒[self=0.0⇒[⇑0.0] user notify: &rsquo;sqrt invalid for x&lt;0.&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">guess &larr; self+0.0.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"copy x"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">guess instfield: 1 &larr; (guess instfield: 1)/4*2.</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"and halve expt for first guess"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: 5 do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[guess &larr; (self-(guess*guess)) / (guess*2.0) + guess]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑guess]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">tan </span><span style="font: 10pt serif">| x x2 sum const  </span><span style="font: italic 10pt serif">"for angles in radians"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self&lt;0.0⇒[⇑self negated tan negated];</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">" normalize to 0≤self≤(pi/4) "</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&gt;pi⇒[⇑(self\pi) tan];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&gt;halfpi⇒[⇑(self-halfpi) tan negated];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&gt;fourthpi⇒[⇑1.0/(halfpi-self) tan]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sum &larr; x &larr; self.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">x2 &larr; x*x.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ const from:</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Now compute the series"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">↪(0.3333314036 0.1333923995 0.0533740603 0.0245650893 0.0029005250 0.0095168091)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">do⦂ [sum &larr; const*(x &larr; x*x2)+sum]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑sum]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Printing</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">absprinton: strm digits: digits   </span><span style="font: italic 10pt serif">"print me using digits significant figures"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| fuzz x exp q i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"x is myself normalized to [1.0, 10.0), exp is my exponent"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">exp &larr; [self&lt;1.0⇒ [0-(10.0/self epart: 10.0)] self epart: 10.0].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">x &larr; self/(10.0 ipow: exp).<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"round the last digit to be printed"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fuzz &larr; 10.0 ipow: 1-digits.  x &larr; 0.5*fuzz+x.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"check if rounding has unnormalized x"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[x≥10.0⇒[x&larr;x/10.0.  exp&larr;exp+1]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[exp&lt;6 and⦂ exp&gt;¬4⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[q &larr; 0.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"decimal notation"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">exp&lt;0⇒ [strm append: &rsquo;0.0000&rsquo;◦(1 to: 1-exp)]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">q &larr; exp. exp &larr; 0].</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"scientific notation"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">use fuzz to track significance"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ x≥fuzz do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[i &larr; x asInteger.  strm next &larr; 060+i.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">x &larr; x-i * 10.0.  fuzz &larr; fuzz*10.0.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">exp &larr; exp-1.  exp=¬1⇒ [strm append: &rsquo;.&rsquo;]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">append additional zeros if necessary</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ exp≥¬1 do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strm next &larr; 060.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">exp &larr; exp-1.  exp=¬1⇒ [strm append: &rsquo;.&rsquo;]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">q≠0⇒[strm append: &rsquo;e&rsquo;; print: q]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">epart: base </span><span style="font: 10pt serif">| x</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"gives floor log.base self"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self&lt;base⇒ [⇑0]</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"self assumed positive"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self&lt;(base*base)⇒ [⇑1]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">x &larr; 2*(self epart: base*base).</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"binary recursion like ipow"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑x + ((self/(base ipow: x)) epart: base)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self printon: strm digits: 8]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm digits: digits   </span><span style="font: italic 10pt serif">"print me using digits significant figures"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self&gt;0.0⇒[self absprinton: strm digits: digits]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self=0.0⇒[strm append: &rsquo;0.0&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm append: &rsquo;¬&rsquo;. (0.0-self) absprinton: strm digits: digits]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">roundTo: d<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑(self/d+[self&lt;0.0⇒[¬0.5] 0.5]) ipart*d]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">constants from Computer Approximations, pp. 182-183</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pi = 3.14159265358979323846264338327950288<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pi/2 = 1.57079632679489661923132169163975144<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pi/4 = 0.78539816339744830961566084581987572<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pi*2 = 6.28318530717958647692528676655900576<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pi/180 = 0.01745329251994329576923690768488612<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">2.0 ln = 0.69314718055994530941723212145817657<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">2.0 sqrt = 1.41421356237309504880168872420969808"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pi &larr; 3.141592654.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">halfpi &larr; pi/2.0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fourthpi &larr; pi/4.0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">twopi &larr; pi*2.0.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">radiansPerDegree &larr; pi/180.0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">degreesPerRadian &larr; 180.0/pi.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ln2 &larr;0.6931471806.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sqrt2 &larr; 1.414213562]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪Float under: &rsquo;Numbers&rsquo;.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">Float classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"Integer"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;Integer&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Number<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;digitbuffer &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">bytesize: 16;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">veryspecial: 1;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sharing: BitMasks;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sharing: ByteCodes;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>Integers are 16-bit numbers, stored in two-s complement form.  The allowable range is from ¬32768 to +32767.  You can type them in octal by typing a leading zero, as in 0377.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Arithmetic</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">≤ arg </span><span style="font: 10pt serif">| t</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t &larr; arg asInteger.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> t isLarge⇒[⇑t neg ≡ false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ⇑self ≤ t]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">≠ arg </span><span style="font: 10pt serif">| t</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[arg isNumber⇒<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> [t &larr; arg asInteger.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">  t isLarge⇒[⇑true]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">  ⇑self ≠ t]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ⇑true]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">≥ arg </span><span style="font: 10pt serif">| t</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t &larr; arg asInteger.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> t isLarge⇒[⇑t neg]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ⇑self ≥ t]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">* arg </span><span style="font: 10pt serif">| t</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[arg is: Integer⇒[⇑self asLarge*arg]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> t &larr; arg asInteger.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> t isLarge⇒[⇑self asLarge*arg]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ⇑self*t] primitive: 21</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">+ arg </span><span style="font: 10pt serif">| t</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[arg is: Integer⇒[⇑self asLarge+arg]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> t &larr; arg asInteger.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> t isLarge⇒[⇑self asLarge+arg]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ⇑self + t]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">- arg </span><span style="font: 10pt serif">| t</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[arg is: Integer⇒[⇑self asLarge-arg]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> t &larr; arg asInteger.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> t isLarge⇒[⇑self asLarge-arg]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ⇑self - t]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">/ arg<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[0=arg⇒[user notify: &rsquo;Attempt to divide by 0&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> arg isLarge⇒[⇑self asLarge/arg]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ⇑self / arg asInteger] primitive: 22</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">&lt; arg </span><span style="font: 10pt serif">| t</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t &larr; arg asInteger.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> t isLarge⇒[t neg ≡ false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ⇑self &lt; t]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">= arg </span><span style="font: 10pt serif">| t</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[arg isNumber⇒<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> [t &larr; arg asInteger.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">  t isLarge⇒[⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">  ⇑self = t]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">&gt; arg </span><span style="font: 10pt serif">| t</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t &larr; arg asInteger.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> t isLarge⇒[⇑t neg]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ⇑self &gt; t]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">compare: arg </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">arg is: Integer⇒ [self &lt; arg⇒ [⇑1]; = arg⇒ [⇑2] ⇑3]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self natcompare: arg bytes "4 - (arg bytes natcompare: self)"]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">even<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑(self land: 1) = 0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">intdiv: arg<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[arg is: Integer ⇒[⇑(self/arg),(self\arg)]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> arg is: LargeInteger ⇒ [⇑self asLarge intdiv: arg]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: &rsquo;I give up&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">negate<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑0-self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">negated </span><span style="font: 10pt serif">[⇑0-self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sameAs: arg  </span><span style="font: italic 10pt serif">"arg assumed to be of same class as self"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self=arg]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">unsignedadd: y<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["treat numbers as unsigned 8-bit quantities."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑((self + y) land: 0377)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">unsignedlessthan: y<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["treat numbers as unsigned 8-bit quantities."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self &lt; y]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">\ arg</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"mod"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[0=arg⇒[user notify: &rsquo;Attempt to divide by 0&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> arg isLarge⇒[⇑self asLarge\arg]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ⇑self \ arg asInteger] primitive: 26</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">| arg</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"truncate"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self/arg*arg]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Bit Manipulation</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">allmask: b </span><span style="font: 10pt serif">[⇑b = (self land: b)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">anymask: b </span><span style="font: 10pt serif">[⇑0 ≠ (self land: b)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">bits: int </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"int is an Interval:  0 is leftmost bit, 15 is rightmost"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self field: (int length "width" * 16) +<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">15 - int stop "displacement from right"]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">field: fld </span><span style="font: 10pt serif">| t</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t &larr; fld asInteger.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> t isLarge⇒[user notify: &rsquo;Field descriptor too large&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ⇑self field: t] primitive: 36</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">field: fld &larr; val </span><span style="font: 10pt serif">| t</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t &larr; fld asInteger.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> t isLarge⇒[user notify: &rsquo;Field descriptor too large&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ⇑self field: t &larr; val asSmall] primitive: 37</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hash </span><span style="font: italic 10pt serif">"used to find large integers in dictionaries"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hibit </span><span style="font: 10pt serif">| i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ i to: 16 do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(self land: (biton◦(17-i)))≠0⇒[⇑17-i]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">land: arg<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self land: arg asSmall] primitive: 23</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">lor: arg<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self lor: arg asSmall] primitive: 24</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">lshift: arg<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self lshift: arg asSmall] primitive: 25</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">lxor: arg<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self lxor: arg asSmall] primitive: 35</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">nomask: b </span><span style="font: 10pt serif">[⇑0 = (self land: b)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Conversion</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asFloat </span><span style="font: 10pt serif">[user croak] primitive: 34</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asInteger </span><span style="font: 10pt serif">[⇑self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asLarge </span><span style="font: 10pt serif">| me digits "convert to LargeInteger"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[me &larr; self bytes.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">digits &larr; Natural new: me length.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">digits◦1 &larr; me◦1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[digits length = 2 ⇒ [digits◦2 &larr; me◦2]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑LargeInteger new bytes: digits neg: self neg]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asNatural </span><span style="font: 10pt serif">| t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t &larr; Natural new: self length.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> t◦1&larr;self◦1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> [t length &gt; 1 ⇒ [t◦2&larr;self◦2]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ⇑t]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asObject </span><span style="font: 10pt serif">[user croak] primitive: 81</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asSmall</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">inString </span><span style="font: 10pt serif">| t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t &larr; String new: 1. t◦1 &larr; self. ⇑t]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">oneToMeAsStream</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"used by for-loops"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑Stream new of: (Interval new from: 1 to: self by: 1)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">unique<br></span><span style="font: 10pt serif">[<br>⇑ self inString unique.<br>]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">unsigned </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self &lt; 0⇒ [⇑65536.0 + self asFloat]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self asFloat]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Subscripts</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">cansubscript: a<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self≥1 and⦂ self≤a length]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">instfield:</span><span class="tab" val="79"></span><span style="font: bold 10pt serif"> i</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"small integer gives trouble"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[i = 1 ⇒[⇑self] user notify: &rsquo;arg too big&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">subscripts: a<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self cansubscript: a⇒[⇑a◦self]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: &rsquo;Subscript out of bounds: &rsquo; + self asString]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">subscripts: a &larr; val </span><span style="font: 10pt serif">| t</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self cansubscript: a⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t &larr; val asInteger.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> (a is: String) and⦂ (t isnt: Integer)⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user notify: &rsquo;Improper store (non-char into String?)&rsquo;]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ⇑a◦self &larr; t]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: &rsquo;Subscript out of bounds: &rsquo; + self asString]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Printing</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">absprinton: strm </span><span style="font: 10pt serif">| rem<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[rem &larr; self\10.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self&gt;9⇒ [self/10 absprinton: strm]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm next &larr; rem+060]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self&lt;0⇒[self=¬32768⇒[strm append: &rsquo;¬32768&rsquo;]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm append:&rsquo;¬&rsquo;. (0-self) printon: strm base: 10]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self printon: strm base: 10]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm base: b </span><span style="font: 10pt serif">| rem i x<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[0&gt;(x&larr;self)⇒[i &larr; 1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">digitbuffer◦1 &larr; 040000\b*2+self-0100000\b. </span><span style="font: italic 10pt serif">"get it?"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">x &larr; (040000/b*2+(self-0100000/b))]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; 0].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ x≥b do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[digitbuffer◦(i&larr;i+1) &larr; x\b.  x &larr; x/b].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm next &larr; 060+x.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ i≠0 do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strm next &larr; 060+(digitbuffer◦i).  i &larr; i-1].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Characters</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asLowercase<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[0101 ≤ self⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self ≤ 0132⇒ [⇑self + 040]]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asUppercase<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[0141 ≤ self⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self ≤ 0172⇒ [⇑self - 040]]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">compareChar: c </span><span style="font: 10pt serif">| a<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"⇑self asLowercase compare: c asLowercase"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">a&larr; self.    </span><span style="font: italic 10pt serif">"written in-line for speed"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[0101≤a⇒[a≤0132⇒[a&larr;a+040]]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[0101≤c⇒[c≤0132⇒[c&larr;c+040]]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">a&lt;c⇒[⇑1] a=c⇒[⇑2] ⇑3]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">isalphanumeric<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self isletter⇒[⇑true]</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"lower-case"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self isdigit]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">isdigit <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self ≥ 060⇒</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">" 0 "</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self ≤ 071]</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">" 9 "</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">isletter<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self ≥ 0141⇒</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">" a "</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self ≤ 0172]</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">" z "</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self ≥ 0101⇒</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">" A "</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self ≤ 0132]</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">" Z "</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">tokenish</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"test for token-chars"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self isletter⇒[⇑true]</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"lower-case"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self isdigit⇒[⇑true]</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"digits"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ⇑&rsquo;¬.:⦂&rsquo; has: self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Copying and Purging</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">copy </span><span style="font: 10pt serif">[⇑self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">purge </span><span style="font: 10pt serif">[user croak] primitive: 44</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">recopy </span><span style="font: 10pt serif">[⇑self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit </span><span style="font: italic 10pt serif">"Initialize the digit buffer"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[digitbuffer &larr; String new: 16]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Compiler Bytecodes</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asCompilerCode  </span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">I am a byte code.  Return the corresponding compiler code</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self&lt;16⇒[⇑self+codeLoadField  "</span><span style="font: italic 10pt serif">inst field</span><span style="font: 10pt serif">"];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&lt;32⇒[⇑self-16+codeLoadTemp  "</span><span style="font: italic 10pt serif">temp</span><span style="font: 10pt serif">"];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&lt;64⇒[⇑self-32+codeLoadLit  "</span><span style="font: italic 10pt serif">literal</span><span style="font: 10pt serif">"];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&lt;111⇒[⇑self-64+codeLoadLitInd  "</span><span style="font: italic 10pt serif">indirect literal</span><span style="font: 10pt serif">"];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&lt;208⇒[⇑self  "</span><span style="font: italic 10pt serif">context relative or constant ... not all values here are legal</span><span style="font: 10pt serif">"];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&lt;256⇒[⇑self-208+codeSendLit  "</span><span style="font: italic 10pt serif">selector</span><span style="font: 10pt serif">"]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: &rsquo;unexpected byte&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asRemoteCode: generator<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self&lt;256⇒ [⇑super asRemoteCode: generator]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(self land: 0177400)≤codeLoadTemp⇒ [⇑ParsedFieldReference new var: self];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=codeLoadLitInd⇒ [⇑ParsedObjectReference new var: self]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑super asRemoteCode: generator]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">bfpSize<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑[self&lt;0⇒ [2]; &gt;8⇒ [2] 1]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emitBfp: code on: stack<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[stack pop: 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">0=self⇒ [code next &larr; toPop]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">1≤self and⦂ self≤8⇒ [code next &larr; self+toShortBfp-1] </span><span style="font: italic 10pt serif">"short bfp"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">code emitLong: toLongBfp by: self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emitBytes: code  </span><span style="font: 10pt serif">| c t</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self&lt;256⇒ [code next &larr; self]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">c &larr; self lshift: ¬8. t &larr; self land: 0377.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">↪(16 16 32 48 48)◦c &gt; t⇒ [code next &larr; ↪(0 16 32 64 208)◦c+t]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">code next &larr; toLoadFieldLong+c-1; next &larr; t]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emitForValue: code on: stack<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[self=toSuper⇒ [code next &larr; toLoadSelf] self emitBytes: code].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">stack push: 1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emitJmp: code on: stack<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[0=self⇒ []<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">1≤self and⦂ self≤8⇒ [code next &larr; self+toShortJmp-1] </span><span style="font: italic 10pt serif">"short jmp"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">code emitLong: toLongJmp by: self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emitsLoad<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self&lt;256⇒ [⇑self&lt;toSmashPop] ⇑self&lt;codeSendLit]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emittedVariable<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[self&lt;256⇒[self≤toSuper] self&lt;codeSendLit]⇒[] ⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">findMacros: macros compilerTemps: compilerTemps </span><span style="font: 10pt serif">| i j assignment<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self&lt;codeLoadTemp or⦂ self&gt;(codeLoadTemp+255)⇒[]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">this temp is not compiler-generated</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">j &larr; self-codeLoadTemp+1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">compilerTemps◦j≡false⇒[]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">compilerTemps◦j≡nil⇒[compilerTemps◦j &larr; false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">The temp isn&rsquo;t compiler-generated after all!!  Nil out the macro</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: macros position to: 2 by: ¬2 do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[assignment &larr; macros◦(i-1) ◦ (macros◦i).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">assignment var=self⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[macros◦i &larr; nil.  macros◦(i-1) &larr; nil.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">compilerTemps◦j &larr; false.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑nil]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: &rsquo;couldnt find bad macro&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">firstPush</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">isField<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self≥codeLoadField and⦂ self&lt;codeLoadTemp]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">jmpSize<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑[self=0⇒ [0]; &lt;0⇒ [2]; &gt;8⇒ [2] 1]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm indent: level precedence: p forValue: v decompiler: decompiler<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[v≡false⇒[]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self&lt;112⇒[user notify: &rsquo;unknown code&rsquo;];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&lt;128⇒[strm append: ↪(&rsquo;sender&rsquo; &rsquo;self&rsquo; &rsquo;?&rsquo; &rsquo;?&rsquo; &rsquo;?&rsquo; &rsquo;?&rsquo; &rsquo;?&rsquo; &rsquo;?&rsquo;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;¬1&rsquo; &rsquo;0&rsquo; &rsquo;1&rsquo; &rsquo;2&rsquo; &rsquo;10&rsquo; &rsquo;nil&rsquo; &rsquo;false&rsquo; &rsquo;true&rsquo;)◦(self-111)];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=133⇒[strm append: &rsquo;thisContext&rsquo;];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=134⇒[strm append: &rsquo;super&rsquo;];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&lt;167⇒[user notify: &rsquo;unknown code&rsquo;];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&lt;208⇒[strm append: SpecialOops◦(self-166)];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&lt;256⇒[user notify: &rsquo;unknown code&rsquo;];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&lt;512⇒[strm append: (decompiler instvar: self)];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&lt;768⇒[strm append: (decompiler temp: self)];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&lt;1024⇒[strm append: (decompiler literal: self)];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&lt;1280⇒[strm append: (decompiler literalIndirect: self)]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm append: (decompiler selector: self)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sizeForValue<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self&lt;256 or⦂</span><span class="tab" val="79"></span><span style="font: 10pt serif">↪(16 16 32 48 48)◦(self lshift: ¬8) &gt; (self land: 0177)⇒ [⇑1]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑2]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>LargeInteger Compatability</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">◦ n | t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["behave like a Natural"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">n = 1 ⇒ [self &lt; 0 ⇒ [⇑((((self land: 0377) lxor: 0377) + 1) land: 0377)]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self land: 0377]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">n = 2 ⇒ [self &lt; 0 ⇒ [t &larr; ((self lshift: ¬8) lxor: 0377).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(self land: 0377) = 0 ⇒[⇑((t+1) land: 0377)]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑t]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ self lshift: ¬8]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">bytes<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["behave like a LargeInteger - negative integers behave like positive naturals"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">isInt<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">last<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self◦self length]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">length<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["behave like a Natural"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(self ≥ 256) or⦂ (self ≤ ¬256) ⇒ [⇑2]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">natcompare: arg </span><span style="font: 10pt serif">| i len [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">len &larr; self length.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">arg length &lt; len⇒[⇑3]; &gt; len⇒[⇑1]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: len to: 1 by: ¬1 do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(self◦i)&gt;(arg◦i)⇒[⇑3];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&lt;(arg◦i)⇒[⇑1]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑2]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">natnormalize: n </span><span style="font: 10pt serif">| x i r f digit<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["n is the number of bits to shift by. The Natural number returned will be written over repeatedly, so we must make a new one."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">r &larr; (Natural new: (self length+1)).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">x &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f &larr; n-8.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: r length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[digit &larr; self ◦i.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">r◦i &larr; (digit lshift: n) lor: x.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">x &larr; digit lshift: f.].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑r]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">neg<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["behave like a LargeInteger"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(self &lt; 0)⇒[⇑true]⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>As yet unclassified</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asInt32 </span><span style="font: 10pt serif">[⇑ Int32 new high: 0 low: self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">between: min and: max<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self≥min and⦂ self≤max]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪Integer under: &rsquo;Numbers&rsquo;.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">Integer classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"LargeInteger"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;LargeInteger&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Number<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;bytes</span><span class="tab" val="79"></span><span style="font: bold 12pt serif">"A Natural number (digits are 0 to 255)"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif"> neg</span><span class="tab" val="79"></span><span style="font: bold 12pt serif">"The sign" &rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>LargeInteger is a class of Numbers with integral values of arbitrary precision. The values are stored as a Natural number that has digits between 0 and 255. The real work is done in Natural, which uses MachineDouble for single digit calculations. The first element of bytes contains the lowest precision digit.<br>All of the Bit Manipulation messages behave like the integer is represented in twos complement and then truncates the number to 16 bits before operating upon it. The value is always a Small integer.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Access</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">bit: index </span><span style="font: 10pt serif">| byte<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"Return bit number i in the binary representation of this number. Bit number 1 is the low order bit"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[byte &larr; bytes◦(1+((index-1)/8)).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ⇑(byte lshift: (0-((index-1)\8))) land: 1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">bytes<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑bytes]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">bytes: bytes neg: neg<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[while⦂ bytes isLarge do⦂ [bytes&larr;bytes bytes]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hibit<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"Return the index of the high order bit of the binary representation of this number"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑bytes last hibit+(8*(bytes length-1))]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">neg<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑neg]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">neg &larr; neg </span><span style="font: 10pt serif">|  "Smashes sign - be careful!"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Arithmetic</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">≤ arg </span><span style="font: 10pt serif">[(self compare: arg)&lt;3⇒[⇑self] ⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">≥ arg </span><span style="font: 10pt serif">[(self compare: arg)&gt;1⇒[⇑self] ⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">* arg </span><span style="font: 10pt serif">| as r<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["take care of sign. Arithmetic is done in Natural numbers. <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">if arg is Small, it behaves as a LargeInteger."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">as &larr; arg neg.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">r &larr; bytes nattimes: arg bytes.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑LargeInteger new bytes: r neg: ((neg≡as)≡false)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">+ arg </span><span style="font: 10pt serif">| as r<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["take care of sign. Arithmetic is done in Natural numbers. <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">if arg is Small, it behaves as a LargeInteger."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">as &larr; arg neg.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">neg ≡ as ⇒[r&larr;bytes natadd: arg bytes. ⇑LargeInteger new bytes: r neg: neg]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">r &larr; bytes natsubtract: arg bytes.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">neg ⇒ [⇑ r negate].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑r]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">- arg </span><span style="font: 10pt serif">| as r<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["take care of sign. Arithmetic is done in Natural numbers. <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">if arg is Small, it behaves as a LargeInteger."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">as &larr; arg neg.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">neg ≡ as ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[r &larr; bytes natsubtract: arg bytes.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">neg ⇒ [⇑ r neg&larr; (r neg ≡ false)].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑r]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">r&larr;bytes natadd: arg bytes.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑LargeInteger new bytes: r neg: neg]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">/ arg<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑(self intdiv: arg)◦1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">&lt; arg </span><span style="font: 10pt serif">[(self compare: arg)=1⇒[⇑self] ⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">= arg<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[arg isNumber⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(self compare: arg)=2⇒[⇑self] ⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">&gt; arg </span><span style="font: 10pt serif">[(self compare: arg)=3⇒[⇑self] ⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">abs </span><span style="font: 10pt serif">"Return the positive magnitude (absolute value) of this LargeInteger"</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑LargeInteger new bytes: bytes neg: false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">compare: arg </span><span style="font: 10pt serif">| i a<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[(((bytes length = 1) and⦂ (bytes◦1=0)) and⦂ (arg bytes length =1)) and⦂ (arg bytes◦1=0)⇒[⇑2]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">neg⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[arg neg⇒[⇑arg bytes natcompare: bytes] ⇑1]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">arg neg⇒[⇑3]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑bytes natcompare: arg bytes]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">even </span><span style="font: 10pt serif">| <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑(((bytes ◦ 1) land: 1) = 0)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">intdiv: arg </span><span style="font: 10pt serif">| quo rem ng qr z<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["returns a vector of (quotient, remainder)"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">qr &larr; bytes natdiv: arg bytes.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">quo &larr; qr◦1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rem &larr; (qr◦2) asInteger.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ng &larr; (neg≡arg neg)≡false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[quo last = 0 ⇒ [quo length&lt;2⇒[]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">quo &larr; quo growby: ¬1]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">qr◦1&larr;(LargeInteger new bytes: quo neg: ng).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">qr◦2 &larr; [ng and⦂ 0≠rem⇒ [arg abs-rem] rem].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑qr]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">negate<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑LargeInteger new bytes: bytes neg: (neg≡false)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">negated<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑LargeInteger new bytes: bytes neg: neg≡false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">\ arg<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑(self intdiv: arg)◦2]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Conversion</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asFloat</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Built for comfort, not for speed"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self asString asFloat]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asInteger<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[bytes length&gt;2⇒[⇑self]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self≤077777 and: self≥0100000⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self asSmall]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ⇑self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asLarge</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asSmall </span><span style="font: 10pt serif">| t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t &larr; (bytes◦1).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> [bytes length &gt; 1 ⇒ [t &larr; (t field: 0210 &larr; (bytes◦2))]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> neg ⇒[t = ¬32768⇒[⇑¬32768] ⇑0-t]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ⇑t]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">isLarge</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Printing</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm base: b<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[neg ⇒ [strm append: &rsquo;¬&rsquo;]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bytes printon: strm base: b]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Bit Manipulation</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">allmask: b </span><span style="font: 10pt serif">[⇑b = (self land: b)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">anymask: b </span><span style="font: 10pt serif">[⇑0 ≠ (self land: b)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">field: n<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self asSmall field: n]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">field: n &larr; val<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self asSmall field: n &larr; val]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hash </span><span style="font: 10pt serif">[⇑bytes hash]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">land: n<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self asSmall land: n]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">lshift: n<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self asSmall lshift: n]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">nomask: b </span><span style="font: 10pt serif">[⇑0 = (self land: b)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪LargeInteger under: &rsquo;Numbers&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"MachineDouble"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;MachineDouble&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Number<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;high low&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;low4 low8 high4 high8 &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>MachineDouble is intended to be used by people who are implementing multiple precision arithmetic. It is hard to use - be careful! These are not ordinary numbers.<br>A MachineDouble behaves like a double precision register on an 8-bit machine. Accessing and setting the high and low words of the register are legitimate. Extract returns the low word and shifts the register right by one word, while propagating the sign. This turns out to be very convenient for addition and subtraction to propagate carries and borrows. Sometimes it does too much, but it is faster than using two other messages. Arithmetic is all unsigned, but decreaseby:, when answer is negative, uses twos complement notation to represent borrows.<br>On the NoteTaker, each half of the MachineDouble will be a complete 15-bit unsigned quantity. Obtaining the low or high half may return a negative number that should be considered to be positive (unsigned). The unsignedadd: and unsignedlessthan: messages to integers allow such numbers to be used without creating large integers.<br>This class will be Nova-coded soon.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Access</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">extract </span><span style="font: 10pt serif">| x<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["returns low, moves high down and propagates sign."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">x &larr; low.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">low &larr; high.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">high &larr; [(low land: 0200)=0 ⇒[0] 0377].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑x]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">high<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑high]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">high &larr; high<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">low<br>   </span><span style="font: 10pt serif">[⇑low]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">low &larr; low<br>   </span><span style="font: 10pt serif">[⇑self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Arithmetic</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">&lt; arg<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[high = arg high⇒[⇑low &lt; arg low]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑high &lt; arg high]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">decreaseby: y </span><span style="font: 10pt serif">| x "y is a positive &lt;256 integer"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[x &larr; low - y.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[x &lt; 0 ⇒[high &larr; (high-1) land: 0377]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">low &larr; x land: 0377.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">gets: x mtimes: y </span><span style="font: 10pt serif">| xh xl yh yl p1 p2<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["x and y are 8-bit positive #&rsquo;s.<br>      Does single precision unsigned multiplication<br>      returning a double precision result."<br>    xh &larr; x field: high4.<br>    xl &larr; x field: low4.<br>    yh &larr; y field: high4.<br>    yl &larr; y field: low4.<br>    low &larr; yl * xl.<br>    high &larr; yh * xh.<br>    p2 &larr; yh * xl.<br>    p1 &larr; (p2 + (yl * xh)).<br>    high &larr; high + (p1 lshift: ¬4).<br>    low &larr; ((p1 land: 017) lshift: 4) + low.<br>    [low ≥ 256 ⇒ [high &larr; high + 1. low &larr; low - 256.]].<br>    ⇑self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">increaseby: y </span><span style="font: 10pt serif">| x "y is a positive &lt;256 integer"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[x &larr; low + y.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[x &gt; 255 ⇒[high &larr; (high+1) land: 0377]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">low &larr; x land: 0377.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">mdiv: y </span><span style="font: 10pt serif">| x<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["Ignores y high (assumes it to be zero. Also assumes that y &gt; x high.<br>      This does a single precision unsigned divide into a double precision dividend<br>      that results in a single precision quotient (returned) and<br>      a single precision remainder(placed in self high)."<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">high &lt; 128 ⇒ [x &larr; (high lshift: 8) + low.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">high &larr; x\y.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑x/y.]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">high &gt; y ⇒ [user notify: &rsquo;illegal MachineDouble division&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">x &larr; ((high lshift: 1) + (low lshift: ¬7)) - y.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">high &larr; x lshift: ¬1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">low &larr; (low field: 027 &larr; x).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑((self mdiv: y) + 128)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>As yet unclassified</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asInt </span><span style="font: 10pt serif">| n i "may return a negative number"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑((high lshift: 8) lor: low)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["low4 is a field description for the low order 4 bits of an Integer<br>      high4 is a field description for the high order 4 bits of an 8-bit Integer"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">low4 &larr; 0100.<br>    high4 &larr; 0104]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[low &larr; 0. high &larr; 0. ⇑self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm </span><span style="font: 10pt serif">| <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strm append: &rsquo;[MachineDouble 0&rsquo;.<br>     high printon: strm base: 8.<br>     strm append: &rsquo; 0&rsquo;.<br>     low printon: strm base: 8.<br>     strm append: &rsquo;]&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪MachineDouble under: &rsquo;Numbers&rsquo;.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">MachineDouble classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"Time"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;Time&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;h m s&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>Implements times of day.  Still needs a lot of work.  (Steve Weyer)</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Setting state</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">default </span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">right now</span><span style="font: 10pt serif">" ⇑user now◦2]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fromSeconds: sec </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"seconds since midnight (adjusted for time zone and DST)"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sec &larr; sec asInteger intdiv: 3600.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">h &larr; (sec◦1) asSmall.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sec &larr; (sec◦2) asSmall.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">m &larr; sec / 60.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s &larr; sec \ 60]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hours: h</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">minutes: m</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">seconds: s</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Printing</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm </span><span style="font: italic 10pt serif">"Format is h:mm:ss am/pm"</span><span style="font: 10pt serif"> [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm print: [h&gt;12⇒[h-12]; &lt;1⇒[12] h];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">append: [m &lt; 10⇒ [&rsquo;:0&rsquo;] &rsquo;:&rsquo;]; print: m;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">append: [s &lt; 10⇒ [&rsquo;:0&rsquo;] &rsquo;:&rsquo;]; print: s;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">space append: [h&lt;12⇒[&rsquo;am&rsquo;] &rsquo;pm&rsquo;]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Aspects</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asSeconds </span><span style="font: 10pt serif">[⇑3600 * h + (60*m+s)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hours </span><span style="font: 10pt serif">[⇑h]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪Time under: &rsquo;Numbers&rsquo;.</span></div>
    <div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">&rsquo;From Smalltalk 5.5k XM November 24 on 22 November 1980 at 2:57:08 am.&rsquo;<br></span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">"Array"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;Array&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>Array is an abstract class in the sense that it has no state, and instantiation is consequently not meaningful.  However it defines the default message set inherited by its subclasses, notably String, Vector, and UniqueString.  Notice that subscripting is not done here, except to handle the exceptional cases such as subscripting by other types as in a◦(1 to: 3).</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Reading and Writing</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">◦ x<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑x subscripts: self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">◦ x &larr; val<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑x subscripts: self &larr; val]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">&lt; v </span><span style="font: italic 10pt serif">"for sorting vectors by first element"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑(self◦1)&lt;(v◦1)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">= arg </span><span style="font: 10pt serif">| x<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[arg isArray⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self length ≠ arg length⇒ [⇑false]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ x to: self length do⦂ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(self◦x) = (arg◦x)⇒ [] ⇑false]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑true]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">&gt; v </span><span style="font: italic 10pt serif">"for sorting vectors by first element"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑(self◦1)&gt;(v◦1)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">all &larr; val </span><span style="font: 10pt serif">| i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ i to: self length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self◦i &larr; val]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">last<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self◦self length]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">last &larr; val<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self◦self length &larr; val]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">length  </span><span style="font: 10pt serif">[user notify: &rsquo;message not understood.&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Copying and Altering</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">+ arg </span><span style="font: 10pt serif">[⇑self concat: arg]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">concat: arg </span><span style="font: 10pt serif">| x s [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">x &larr; self species new: self length + arg length.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self copyto: (s &larr; x asStream).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">arg copyto: s.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑x]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">copy<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self copy: 1 to: self length]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">copy: a to: b<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self copy: a to: b to: (self species new: b-a+1)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">copy: a to: b to: t </span><span style="font: 10pt serif">| i s me<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s &larr; t asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">me &larr; Stream new of: self from: a to: b.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: a to: b do⦂</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"general code wont stop at false"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s next &larr; me next]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑t]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">copyto: t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self copy: 1 to: self length to: t]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">delete: obj </span><span style="font: 10pt serif">| s each<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s &larr; (self species new: self length) asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ each from: self do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[obj=each⇒[] s next&larr; each]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ s contents]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">grow </span><span style="font: 10pt serif">[⇑self growto: (4 max: self length*2)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">growby: n </span><span style="font: 10pt serif">[⇑self growto: self length + n]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">growto: n </span><span style="font: 10pt serif">[⇑self "copyto:" copy: 1 to: self length to: (self species new: n)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">insertNonDescending: x</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"self is assumed to be sorted"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self insertSorted: x]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">insertSorted: x </span><span style="font: 10pt serif">| a c i</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"self is assumed to be sorted"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[i &larr; self findSorted: x.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">c &larr; (a &larr; self species new: self length+1) asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self◦(1 to: i) copyto: c. c next &larr; x. self◦(i+1 to: self length) copyto: c.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑a]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">notNil </span><span style="font: 10pt serif">| t i  </span><span style="font: italic 10pt serif">"copy self (which contains no falses) removing all nils"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t &larr; (self species new: (self length-(self count: nil))) asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: self do⦂ [i≡nil ⇒[] t next&larr; i].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑t asArray]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">replace: a to: b by: s </span><span style="font: 10pt serif">| x xs<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[x &larr; self species new: self length+s length -(1+b-a).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">xs &larr; x asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self copy: 1 to: a-1 to: xs.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s copy: 1 to: s length to: xs.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self copy: b+1 to: self length to: xs.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑x]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">without: index </span><span style="font: 10pt serif">| s me i  </span><span style="font: italic 10pt serif">"if index in range, return self without ◦index"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[index cansubscript: self⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s &larr; (self species new: self length-1) asStream.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">me &larr; self asStream.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: self length do⦂ [i=index⇒ [me next] s next &larr; me next].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑s asArray]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Searching</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">all⦂ variable suchThat⦂ expr </span><span style="font: 10pt serif">| s i x  </span><span style="font: italic 10pt serif">"a copy of some of me"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s &larr; (self species new: self length) asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: self length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[x &larr; self◦i. variable value &larr; x.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">expr eval⇒ [s next &larr; x]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑s contents]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">count: x </span><span style="font: 10pt serif">| i n<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[n&larr;0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: self length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[x=(self◦i)⇒ [n&larr;n+1]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑n]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">find⦂ x suchThat⦂ predicate </span><span style="font: 10pt serif">| i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ i to: self length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[x value &larr; self◦i. predicate eval⇒ [⇑i]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">find: x </span><span style="font: 10pt serif">| i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ i to: self length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self◦i=x⇒ [⇑i]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">findnon: x </span><span style="font: 10pt serif">| i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ i to: self length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self◦i≠x⇒ [⇑i]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">findSorted: x </span><span style="font: 10pt serif">| lo mid hi</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">" returns index of largest element ≤ x "<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[hi &larr; self length+1.  lo &larr; 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ lo &lt; hi do⦂</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"binary search; self must be sorted"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self◦(mid&larr;lo+hi/2) &gt; x⇒[hi &larr; mid]  lo &larr; mid+1].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑hi-1]</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">" 0≤result≤length "</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">first⦂ x suchThat⦂ predicate </span><span style="font: 10pt serif">| i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ i to: self length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[x value &larr; self◦i. predicate eval⇒ [⇑self◦i]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">has: x </span><span style="font: 10pt serif">[⇑(self find: x)≠0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Permutation</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">permutationToSort<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Return a Vector, permutation, such that self◦permutation is sorted nondescending.  Do not alter self."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑((self◦((1 to: self length) copy)) sort: 1 to: self length) map.]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">promote: t </span><span style="font: 10pt serif">| n<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[n &larr; self find: t. n=0⇒ []<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self◦(n to: 2 by: ¬1) &larr; self◦(n-1 to: 1 by: ¬1).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self◦1 &larr; t]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">reverse</span><span class="tab" val="79"></span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑Substring new data: self map: (self length to: 1 by: ¬1)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sort<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Permute my elements so they are sorted nondescending.  Note: if I am a substring, only my map will be permuted.  In certain situations, this may not be what you expect."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self sort: 1 to: self length.]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sort: i to: j </span><span style="font: 10pt serif">| di dij dj tt ij k l n<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Sort elements i through j of self to be nondescending."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"The prefix d means the data at."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(n&larr;j+1-i)≤1⇒ [</span><span style="font: italic 10pt serif">"Nothing to sort."</span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Sort di,dj."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">di &larr; self◦i. dj &larr; self◦j.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[di&gt;dj⇒ [self swap: i with: j. tt&larr;di. di&larr;dj. dj&larr;tt]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">n=2⇒ [</span><span style="font: italic 10pt serif">"They are the only two elements."</span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ij &larr; (i+j) lshift: ¬1. </span><span style="font: italic 10pt serif">"ij is the midpoint of i and j."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Sort di,dij,dj.  Make dij be their median."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dij &larr; self◦ij.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[di&gt;dij⇒ [self swap: i with: ij. dij&larr;di] dj&lt;dij⇒ [self swap: j with: ij. dij&larr;dj]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">n=3⇒ [</span><span style="font: italic 10pt serif">"They are the only three elements."</span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Find k&gt;i and l&lt;j such that dk,dij,dl are in reverse order.  Swap k and l.  Repeat this procedure until j and k pass each other."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">k &larr; i. l &larr; j.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ self◦(l&larr;l-1) &gt; dij do⦂ [].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ self◦(k&larr;k+1) &lt; dij do⦂ [].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">k≤l<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self swap: k with: l].<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Now l&lt;k (either 1 or 2 less), and di through dl are all less than dk through dj.  Sort those two segments."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self sort: i to: l.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self sort: k to: j.]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">swap: i with: j </span><span style="font: 10pt serif">| t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t &larr; self◦i. self◦i &larr; self◦j. self◦j &larr; t]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Conversion</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asSet </span><span style="font: 10pt serif">[⇑Set new of: self to: self length]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asStream<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑Stream new of: self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">frequencies </span><span style="font: 10pt serif">| d x  </span><span style="font: italic 10pt serif">"return a sorted vector ((freq item) (freq item) ...)"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[d &larr; Dictionary new init: 64.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ x from: self do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[d tally: x].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑d asInvertedVector sort]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sum </span><span style="font: 10pt serif">[⇑self sumTo: 0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sumTo: subTotal </span><span style="font: 10pt serif">| x</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"add all my elements to this subTotal (usually 0 or 0.0)"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ x from: self do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[subTotal&larr; subTotal+x].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑subTotal]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">transform⦂ each to⦂ expr </span><span style="font: 10pt serif">| s i  </span><span style="font: italic 10pt serif">"a copy of me with each element transformed"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s &larr; (self species new: self length) asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: self length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[each value &larr; self◦i. s next &larr; expr eval].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑s asArray]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">viewer </span><span style="font: 10pt serif">[⇑SetReader new of: self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Mapping</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">cansubscript: a </span><span style="font: 10pt serif">| i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ i from: self do⦂ [i cansubscript: a⇒ [] ⇑false]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">subscripts: x</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"subarrays"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑Substring new data: x map: self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">subscripts: x &larr; val</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"subrange replacement"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self length≠val length⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user notify: &rsquo;lengths not commensurate&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">val copyto: (Substring new data: x map: self).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑val]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Compatibility</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">isArray</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">isIntervalBy1<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">species<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑Vector]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Comparing</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hash </span><span style="font: italic 10pt serif">"make sure = arrays hash =ly"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self length=0⇒[⇑17171]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑(self◦1) hash + (self◦self length) hash]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪Array under: &rsquo;Basic Data Structures&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"FieldReference"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;FieldReference&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;object offset&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I reference a field of an instance</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">object: object offset: offset</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Indirection</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">eval <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑object instfield: offset]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">value </span><span style="font: 10pt serif">[⇑object instfield: offset]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">value &larr; value<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[object instfield: offset &larr; value. ⇑value]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪FieldReference under: &rsquo;Basic Data Structures&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"Interval"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;Interval&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Array<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;start stop step length&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I am an arithmetic progression from start in steps of step, not exceeding stop</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">from: start to: stop by: step<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[length &larr; 1+(stop-start/step).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">step&lt;0⇒[start&lt;stop⇒[length&larr; 0]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">stop&lt;start⇒[length&larr; 0]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Reading and Writing</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">◦ x<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[x is: Integer⇒[x&lt;1⇒ [⇑nil]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">x&gt;length⇒ [⇑nil]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑start+(step*(x-1))]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑super◦x]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">◦ x &larr; val<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user notify: &rsquo;Intervals are not for writing into&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">length </span><span style="font: 10pt serif">[⇑length]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">start </span><span style="font: 10pt serif">[⇑start]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">stop </span><span style="font: 10pt serif">[⇑stop]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Compatibility</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">= int </span><span style="font: 10pt serif">[⇑start = int start and⦂ (stop = int stop and⦂ length = int length)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">cansubscript: a<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑length≤0 or⦂ ((start cansubscript: a) and⦂ (length-1*step+start cansubscript: a))]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hash </span><span style="font: 10pt serif">[⇑(((start lshift: 2) lxor: stop) lshift: 1) lxor: length]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">isIntervalBy1<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑step=1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Random Numbers</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">random</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"See Lehmers linear congruential method, Knuth Vol. 1:<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">modulus m=2&uarr;16<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">a=27181 odd, and 5 = a mod 8<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">c=13849 odd, and c/m around 0.21132"</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[step&larr; (13849 + (27181*step)) asSmall.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑(start + ((length asFloat*(32768.0+step))/65536.0)) asSmall]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">randomInit </span><span style="font: 10pt serif">[self randomInit: mem◦0430]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">randomInit: x</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Call with const to get repeatable sequence"</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[step&larr; x.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"step holds the current state"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">start is: Float⇒[length&larr;stop-start]</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"for Float intervals"</span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪Interval under: &rsquo;Basic Data Structures&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"ObjectReference"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;ObjectReference&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;object&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I am an indirect reference</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">object: object</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Indirection</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">eval <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑object]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">value </span><span style="font: 10pt serif">[⇑object]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">value &larr; object<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑object]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Conversion</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strm append: &rsquo;-&gt;&rsquo;; print: object]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪ObjectReference under: &rsquo;Basic Data Structures&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"RunVector"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;RunVector&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Array<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo; min max starts values offset&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>RunVectors compactly store data which tends to be constant over much<br>of its domain.  They may have any range of subscript, but must be stored<br>into consecutively.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Reading and writing</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">◦i | index</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[index&larr; starts findSorted: i.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">offset&larr; i-(starts◦index).</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"distance into run"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑values◦index]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">◦i&larr; val<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[offset&larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">min≡nil⇒[min&larr; max&larr; i. starts&larr; i inVector. values&larr; val inVector]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i-1≠max⇒[user notify: &rsquo;RunVectors must be loaded sequentially&rsquo;. ⇑val]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">max&larr; i.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">val=values last⇒[offset&larr; i-starts last. ⇑val]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">starts&larr; starts , i.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">values&larr; values , val. ⇑val]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">length </span><span style="font: 10pt serif">[max≡nil⇒[⇑0]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑max-min+1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">max </span><span style="font: 10pt serif">[⇑max]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">min </span><span style="font: 10pt serif">[⇑min]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪RunVector under: &rsquo;Basic Data Structures&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"Stream"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;Stream&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;array position limit&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>Streams provide fast sequential access to arrays (implemented in microcode for Strings and Vectors).  A subclass can handle end conditions if desired (disk files do this).</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">close<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[limit&larr; position. position&larr; 0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">default<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self of: (String new: 16)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">of: array<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[position &larr; 0. limit &larr; array length]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">of: array from: pos to: lim </span><span style="font: 10pt serif">| len</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[limit &larr; [lim &gt; (len &larr; array length)⇒ [len] lim].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">position &larr; [pos≤1⇒ [0] pos-1]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">release </span><span style="font: 10pt serif">[array &larr; nil]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Sequential reading and writing</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">∢ x </span><span style="font: 10pt serif">| y<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[y&larr; self next⇒</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"peek for matching element"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[x=y⇒ [⇑y]</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"gobble it if found"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">position &larr; position-1. ⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">append: x </span><span style="font: 10pt serif">| i</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Array arg"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ i from: x do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self next &larr; i].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑x]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dequeue</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"use it as a FIFO"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self dequeue: 1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dequeue: n </span><span style="font: 10pt serif">| t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[position&lt;n⇒ [⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">t &larr; (array◦(1 to: n)) copy.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">array◦(1 to: position-n) &larr; array◦(n+1 to: position).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">position &larr; position-n. ⇑t]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">integerScan </span><span style="font: 10pt serif">| sign base maxdigit c val [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"get the next Integer or LargeInteger (Float?) from a Stream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">copied from String asInteger"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sign&larr; [self∢025⇒[¬1] 1].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">base&larr; [self∢060⇒[8] 10].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">maxdigit&larr; 060+base.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">val&larr; 0.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ ((c &larr; self next) and⦂ (c ≥ 060 and⦂ c &lt; maxdigit)) do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">val&larr; val*base+(c-060)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[c⇒ [self skip: ¬1]].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"Some special maneuvering to keep 01ddddd and ¬32768 (and nothing else)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">from overflowing."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">base=8 and⦂ (val&gt;077777 and⦂ (sign=1 and⦂ val&lt;65536))⇒[⇑val asSmall]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑(val*sign) asInteger]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">into: x </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"generate an error if the Stream is exhausted before x is filled"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self into: x endError: true]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: justify">
<span style="font: bold 10pt serif">into: x endError: err </span><span style="font: 10pt serif">| i t len [</span><span style="font: italic 10pt serif">"Array result"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">len &larr; x length.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"read until count or stream is exhausted"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ (i &lt; len and⦂ (t &larr; self next)) do⦂ [x◦(i&larr;i+1) &larr;t].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">err⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">t⇒ [⇑x]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: &rsquo;only read first &rsquo; + i asString]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"return number that were read"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑i]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">next</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"simple result"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self myend⇒ [⇑self pastend]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑array◦(position &larr; position+1)] primitive: 17</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">next: n </span><span style="font: 10pt serif">[⇑self into: (array species new: n) endError: true]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">next: n from: strm </span><span style="font: 10pt serif">[for⦂ n to: n do⦂ [self next &larr; strm next]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">next: n &larr; v </span><span style="font: 10pt serif">[for⦂ n to: n do⦂ [self next &larr; v]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">nextNumber: n </span><span style="font: 10pt serif">| i s t [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">return next n characters s as a positive Integer or LargeInteger</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s &larr; false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">scan for first non-zero byte, then collect rest appropriately</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: n do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">t &larr; self next.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s⇒ ["</span><span style="font: italic 10pt serif">more LargeInteger: reverse order of significance</span><span style="font: 10pt serif">" s◦(n+1-i) &larr; t]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">i=n⇒ [⇑t]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">t=0⇒ []<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">i ≤ (n-2) or⦂ "i=n-1" (t land: 0200) ≠ 0⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">LargeInteger of 2 or more bytes</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s &larr; Natural new: n+1-i.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s last &larr; t]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">positive Integer</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑(t lshift: 8) + self next].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑LargeInteger new bytes: s neg: false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">nextNumber: n &larr; v </span><span style="font: 10pt serif">| vlen [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">write a positive Integer or LargeInteger as n characters</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">v &larr; v bytes.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">vlen &larr; v length.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[n &lt; vlen⇒ [user notify: &rsquo;number too big&rsquo;];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&gt; vlen⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">pad beginning with 0&rsquo;s</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self next: n - vlen &larr; 0]].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">vlen = 1⇒ [self next &larr; v]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">vlen = 2 and⦂ (v is: Integer)⇒ [self nextword &larr; v]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">LargeInteger (assume pos, no negative convention)</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self append: v reverse]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">nextPoint </span><span style="font: 10pt serif">| x [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">x &larr; self nextword.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑Point new x: x y: self nextword]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">nextPoint&larr;p </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self nextword &larr; p x;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextword &larr; p y]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">nextString </span><span style="font: 10pt serif">| len [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self into: (String new: [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(len &larr; self next)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&lt;192⇒[len]</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"up to 191 chars (BCPL compat)"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">len-192*256 + self next]) endError: true]</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"up to 16383 chars"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">nextString&larr; s </span><span style="font: 10pt serif">| len [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(len &larr; s length) &lt; 192⇒[self next&larr; len]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self next&larr; len/256+192; next&larr; len\256].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self append: s.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑s]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">nextword </span><span style="font: 10pt serif">| hi lo<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[hi &larr; self next⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[lo &larr; self next⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑(hi lshift: 8)+lo]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">nextword&larr; val<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self next&larr; val lshift: ¬8.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self next&larr; val land: 0377. ⇑val]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">next &larr; x</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"simple arg"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self myend⇒ [⇑self pastend &larr; x]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑array◦(position &larr; position+1) &larr; x] primitive: 18</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">padNext </span><span style="font: 10pt serif">["make position even (on word boundary), returning padding character if any"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">position even⇒ [⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self next]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">padNext&larr; c </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">position even⇒ [⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self next&larr; c]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">peek </span><span style="font: 10pt serif">| x<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[x&larr; self next⇒ [position &larr; position-1.  ⇑x]</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"peek at next element"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pop</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"use it as a LIFO"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[position&lt;1⇒ [⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">position &larr; position-1. ⇑array◦(position+1)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pop: n </span><span style="font: 10pt serif">| t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[position&lt;n⇒ [⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">t &larr; self last: n.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">position &larr; position-n. ⇑t]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">upto: x </span><span style="font: 10pt serif">| y s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s &larr; (String new: 250) asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ y from: self do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[y=x⇒[⇑s contents]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s next &larr; y].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑s contents]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Test and alter position</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">empty</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"for"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑position=0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">end<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑position≥limit]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">limit<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑limit]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">loc</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"synonym for compiler"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑position]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">myend<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑position≥limit]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pastend<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pastend &larr; x<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[array &larr; array grow. limit &larr; array length.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self next &larr; x]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">position<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑position]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">position&larr; position</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">reset<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[position &larr; 0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">settoend </span><span style="font: 10pt serif">[position&larr; limit]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">skip: x<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[position &larr; position+x]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">skipTo: x </span><span style="font: 10pt serif">| y [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ y from: self do⦂ [y=x⇒[⇑true]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">skipwords: w </span><span style="font: 10pt serif">[self skip: 2*w]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">wordposition </span><span style="font: 10pt serif">[⇑self position/2]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">wordposition&larr; w </span><span style="font: 10pt serif">[self position&larr; w*2]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Static reading and writing</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">◦ x<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑array◦x]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">◦ x &larr; val<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑array◦x &larr; val]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">contents </span><span style="font: 10pt serif">[⇑array copy: 1 to: position]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">first<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[position ≠ 0 ⇒ [⇑array◦1] ⇑nil]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">insert: x </span><span style="font: 10pt serif">| i  </span><span style="font: italic 10pt serif">"treat as LIFO queue, insert in front"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">grow array if necessary</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> [position=limit⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[array&larr;array grow.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">limit&larr;array length]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: position do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[array◦(position-i+2) &larr; array◦(position-i+1)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">array◦1 &larr; x.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">position&larr;position+1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">last<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[position≠ 0 ⇒ [⇑array◦position] ⇑nil]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">last: n<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑(array◦(position-n+1 to: position)) copy]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">rest </span><span style="font: 10pt serif">[⇑array copy: position+1 to: limit]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Character printing</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">cr<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self next &larr; 015]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">crtab: n </span><span style="font: 10pt serif">| i</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self next&larr;13.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: n do⦂ [self next&larr;9]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">print: obj<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[obj printon: self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">semicrtab<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self append: &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">space<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self next &larr; 040]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">tab<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self next &larr; 011]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Coercions</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asArray<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑array]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asReadStream </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"an alternative to Set/SetReader.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">create another Stream which reads the contents of this one"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑Stream new of: array from: 1 to: position]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asStream</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asVector </span><span style="font: italic 10pt serif">"Convert a string to a vector of tokens"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑(Reader new of: self) read]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">viewer </span><span style="font: 10pt serif">[⇑SetReader new of: array from: 1 to: position]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Compiler object code</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emitLong: jmpOrBfp by: dist<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[dist&lt;0⇒ [dist&larr;dist+1024]; &gt;1023⇒ [dist&larr;¬1] jmpOrBfp&larr;jmpOrBfp+4].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dist&lt;0⇒ [user notify: &rsquo;A block compiles more than 1K bytes of code&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self next &larr; dist/256 + jmpOrBfp. self next &larr; dist\256]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪Stream under: &rsquo;Basic Data Structures&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"PQueue"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;PQueue&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Stream<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;readposition&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>A PQueue is a First In First Out list of objects implemented as an array and a read pointer and write pointer. PQueue is a subclass of Stream and uses Streamⓢstandard method for inserting a new item (next&larr;, i.e. Streamⓢposition is the write pointer). A PQueue also has a read pointer which it uses for accessing objects with the messages next or dequeue (which are identical). All messages to a PQueue that change its state are declared as critical sections to avoid race conditions</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>FIFO access</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dequeue: num </span><span style="font: 10pt serif">| n<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[Top critical⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[position-readposition &lt; num ⇒ [n &larr; false]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> n &larr; (array◦(readposition+1 to: readposition + num)) copy.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> readposition &larr; readposition + num].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ⇑n]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">length </span><span style="font: 10pt serif">| l<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[Top critical⦂ [l &larr; position-readposition]. ⇑l]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">myend </span><span style="font: 10pt serif">[⇑true]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">next </span><span style="font: 10pt serif">| n<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[Top critical⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[readposition≥position⇒ [readposition&larr;position&larr;0. n &larr; false]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> n &larr; array◦(readposition &larr; readposition+1)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ⇑n] primitive: 98</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pastend &larr; x</span><span class="tab" val="79"></span><span style="font: bold 10pt serif"> </span><span style="font: 10pt serif">| n i</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"simple arg"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[Top critical⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[position≥limit⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[readposition=0⇒[super pastend &larr; x]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> n &larr; position-readposition.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> for⦂ i to: n do⦂ [array◦i &larr; array◦(readposition+i)].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> readposition &larr; 0. position &larr; n.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self next &larr; x]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> array◦(position &larr; position+1) &larr; x].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ⇑x]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">peek </span><span style="font: 10pt serif">| n<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[Top critical⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[readposition≥position⇒ [readposition&larr;position&larr;0. n &larr; false]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> n &larr; array◦(readposition + 1)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ⇑n]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">skip: x<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[Top critical⦂ [readposition &larr; readposition+x]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>LIFO access</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">push: x</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"treat as LIFO queue"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[Top critical⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[readposition &gt; 0 ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[array◦readposition &larr; x.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> readposition &larr; readposition - 1]</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"readpositon &gt; 0, just jam it in"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self insert: x]]</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"otherwise insert on front"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Stream protocol</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">contents </span><span style="font: 10pt serif">| n<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[Top critical⦂ [n &larr; (array◦(readposition+1 to: position)) copy]. ⇑n]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">empty </span><span style="font: 10pt serif">| l<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[Top critical⦂ [l &larr; readposition≥position]. ⇑l] primitive: 99</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">end </span><span style="font: 10pt serif">| n<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[Top critical⦂ [n &larr; readposition≥position]. ⇑n]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">of: array<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[Top critical⦂ [position &larr; 0. readposition &larr; 0. limit &larr; array length]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">of: array from: position to: limit<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user notify: &rsquo;of:from:to: is not appropriate for PQueues&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">reset<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[Top critical⦂ [readposition &larr; position &larr; 0]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪PQueue under: &rsquo;Basic Data Structures&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"Queue"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;Queue&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Stream<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;readposition&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>A Queue is a First In First Out list of objects implemented as an array and a read pointer and write pointer. Queue is a subclass of Stream and uses Streamⓢstandard method for inserting a new item (next&larr;, i.e. Streamⓢposition is the write pointer). A Queue also has a read pointer which it uses for accessing objects with the messages next or dequeue (which are identical)</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>FIFO access</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">deQ1 </span><span style="font: 10pt serif">| n</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"A noninterruptable dequeue"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[Top critical⦂ [n &larr; self dequeue].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ⇑n]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dequeue<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[readposition≥position⇒ [readposition&larr;position&larr;0. ⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ⇑array◦(readposition &larr; readposition+1)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dequeue: num </span><span style="font: 10pt serif">| n<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[position-readposition &lt; num ⇒ [⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> n &larr; (array◦(readposition+1 to: readposition + num)) copy.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> readposition &larr; readposition + num.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ⇑n]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">enQ1: n</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"A noninterruptable enqueue"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[Top critical⦂ [super next&larr; n].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ⇑n]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">length<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑position-readposition]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">next<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[readposition≥position⇒ [readposition&larr;position&larr;0. ⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ⇑array◦(readposition &larr; readposition+1)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">peek<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[readposition≥position⇒ [readposition&larr;position&larr;0. ⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ⇑array◦(readposition + 1)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">skip: x<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[readposition &larr; readposition+x]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>LIFO access</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">push: x</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"treat as LIFO queue"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[readposition &gt; 0 ⇒<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[array◦readposition &larr; x.  readposition &larr; readposition - 1]</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"readpositon &gt; 0, just jam it in"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self insert: x]</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"otherwise insert on front"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Stream protocol</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">contents<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑(array◦(readposition+1 to: position)) copy]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">empty<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑readposition≥position]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">end<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑readposition≥position]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">of: array<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[position &larr; 0. readposition &larr; 0. limit &larr; array length]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">of: array from: position to: limit<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user notify: &rsquo;of:from:to: is not appropriate for Queues&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pastend &larr; x </span><span style="font: 10pt serif">| n<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[readposition=0⇒[⇑super pastend &larr; x]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> n &larr; position-readposition.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> array◦(1 to: n) &larr; array◦(readposition+1 to: position).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> readposition &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> position &larr; n.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ⇑self next &larr; x]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">reset<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[readposition &larr; position &larr; 0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪Queue under: &rsquo;Basic Data Structures&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"Set"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;Set&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Stream<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;views&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>For storing/collecting, read by a SetReader.<br>Use no messages from Stream except of:, empty, next&larr;, contents, space, nextword&larr;</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">default </span><span style="font: 10pt serif">[self vector: 8]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">of: array to: position </span><span style="font: 10pt serif">[limit &larr; array length]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">string: limit </span><span style="font: 10pt serif">[self of: (String new: limit)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">vector: limit </span><span style="font: 10pt serif">[self of: (Vector new: limit)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Index operations</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">◦i </span><span style="font: 10pt serif">[⇑array◦("self checkIndex:" i)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">◦i &larr; val </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">position+1 = i⇒ [self next &larr; val]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑array◦("self checkIndex:" i) &larr; val]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">deleteI: i </span><span style="font: 10pt serif">| v j<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">v &larr; self◦i.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ j from: i to: position-1 do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[array◦j &larr; array◦(j+1)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">array◦position &larr; nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">position &larr; position-1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑v<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">deleteI: i to: j</span><span style="font: 10pt serif">| n k<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">n &larr; j-i+1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ k from: i to: position-n do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[array◦k &larr; array◦(k+n)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ k from: position-n+1 to: position do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[array◦k &larr; nil<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">position &larr; position-n.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">insertI: i value: v </span><span style="font: 10pt serif">| old j <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[i &gt; position ⇒ [ self next &larr; v ]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">old&larr;array.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[position = limit⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[limit&larr; limit+(10 max: limit/4).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">array &larr; array species new: limit.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ j to: i-1 do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[array◦j &larr; old◦j<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ j from: position  to: i by: ¬1 do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[array◦(j+1) &larr; old◦j<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">array◦i &larr; v.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">position  &larr; position +1<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Value operations</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">add: x  </span><span style="font: 10pt serif">[self next &larr; x]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">append: x  </span><span style="font: 10pt serif">[for⦂ x from: x do⦂ [self next &larr; x]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">delete: x </span><span style="font: 10pt serif">| i [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: position do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">array◦i ≡ x⇒ [⇑self deleteI: i]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">find: v </span><span style="font: 10pt serif">| i [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: position do⦂ [array◦i = v⇒ [⇑i]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">has: x </span><span style="font: 10pt serif">[⇑(self find: x) &gt; 0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">insert: x </span><span style="font: 10pt serif">[(self find: x) = 0⇒ [self next&larr; x]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Viewing</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asSet</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asStream </span><span style="font: 10pt serif">[⇑self viewer]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">copy </span><span style="font: 10pt serif">[⇑self viewer copy]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">initView: v </span><span style="font: 10pt serif">[⇑v of: array to: position]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">length </span><span style="font: 10pt serif">[⇑position]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">notViewed: v </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">views delete: v;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">empty⇒ [views &larr; nil]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm </span><span style="font: 10pt serif">| t [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm append: &rsquo;a Set: &rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">array is: String⇒ [strm append: self]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ t from: self do⦂ [strm space; print: t]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">species </span><span style="font: 10pt serif">[⇑array species]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">viewer </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑SetReader new of: array from: 1 to: position<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"self viewRange: 1 to: position"]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">viewer: v </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[views≡nil⇒ [views &larr; Set default]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">views next &larr; v]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">viewRange: i to: j </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑"self viewer:" (<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">SetReader new of: array from: (i "max: 1") to: (j "min: position"))]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Private</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">checkIndex: i </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i ≥ 1 and⦂ i ≤ position⇒ [⇑i]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑user notify: &rsquo;illegal index&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">grow </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"self grown and reset. returns another Set with old contents"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self growby: (10 max: limit/4)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">growby: n | old </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"grow and reset self. return old Set for copying"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">old &larr; Set new of: array to: position.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self of: (array species new: limit+n) to: 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑old]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">next </span><span style="font: 10pt serif">[user notify: &rsquo;no direct reading of a Set&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pastend &larr; x </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑[self append: self grow; next &larr; x]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Arithmetic operations</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dotproduct: s </span><span style="font: 10pt serif">| i dotproduct<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["dot product of two sets ... sets must be of equal length"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dotproduct &larr; 0.0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self length = s length ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: position do⦂ [dotproduct &larr; dotproduct + ((s◦i)*(self◦i))].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ dotproduct  <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: &rsquo;dot product undefined...sets are not of equal length&rsquo;. <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">product: s </span><span style="font: 10pt serif">| product i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["product of two sets ... sets must be of equal length"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">product &larr; Set new default.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self length = s length ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: position do⦂ [product add: (s◦i)*(self◦i)].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ product<br>  <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: &rsquo;product undefined...sets are not of equal length&rsquo;. <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">summation</span><span style="font: 10pt serif">| i summation<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["sum of the values in the set"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">summation &larr; 0.0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: position do⦂ [summation &larr; summation + (self◦i)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ summation<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪Set under: &rsquo;Basic Data Structures&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"SetReader"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;SetReader&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Stream<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>Read a Set; no edits occur to set. (see Steve for ISetReader (interruptible))<br>Inherit of:from:to:, next, next:, end, pastend, skip:, ∢, asStream, viewer</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">of: array from: position for: n </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">position &larr; position-1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">limit &larr; position+n]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Reading</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asSet </span><span style="font: 10pt serif">[⇑self copy]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">copy </span><span style="font: 10pt serif">"yield contents all at once as a Set" [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑[Set new of: (array species new: limit-position); append: self]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">length </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"how much left"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑limit-position]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪SetReader under: &rsquo;Basic Data Structures&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"String"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">VariableLengthClass new title: &rsquo;String&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Array<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;StringBlter &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">bytesize: 8;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I am an array of bytes, integers between 0 and 255 usually representing ascii characters</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Reading and Writing</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">all&larr; val </span><span style="font: 10pt serif">[self fill: 1 to: self length with: val]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fill: a to: b with: val </span><span style="font: 10pt serif">| i [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"eventually use BitBlt?"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: a to: b do⦂ [self◦i &larr; val]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">length </span><span style="font: 10pt serif">[⇑self length </span><span style="font: italic 10pt serif">"In case this is reached by perform:"</span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">word: x</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"read word in String"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self◦(x+x) + (self◦(x+x-1) lshift: 8)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">word: x &larr; y</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"write word in String"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self◦(x+x-1) &larr; y lshift: ¬8.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self◦(x+x) &larr; y land: 0377. ⇑y]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Copying and Altering</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">concat: s </span><span style="font: 10pt serif">| len [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(len &larr; self length) + s length &gt; 20 and⦂ (s Is: String)⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"this concatenates more quickly if BitBlt is used"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self replace: len+1 to: len by: s from: 1 to: s length]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑super concat: s]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">copy: a to: b </span><span style="font: 10pt serif">[⇑(self species new: 1+b-a) copy: 1 to: 1+b-a with: self from: a to: b]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">copy: a to: b with: s from: c to: d </span><span style="font: 10pt serif">| i [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">like replace, except in place. self◦(a to: b) &larr; s◦(c to: d).<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">use BitBlt unless size too small, StringBlter≡false, or index/sizes too large</span><span style="font: 10pt serif">"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(b-a &gt; 12 and⦂ StringBlter) and⦂ (<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">BitBlt new stringCopy: self from: a to: b with: s from: c to: d)⇒ []<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self ≡ s and⦂ (c &lt; a and⦂ d ≥ a)⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">overlap of second range with below first in same string.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">copy in reverse order: self◦(b to: a by: ¬1) &larr; self◦(d to: c by: ¬1)</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: b-a to: 0 by: ¬1 do⦂ [self◦(a+i) &larr; self◦(c+i)]]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s copy: c to: d to: (Stream new of: self from: a to: b)]</span><span class="tab" val="79"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">findString: str startingAt: start </span><span style="font: 10pt serif">| i t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[str length=0⇒[⇑0] t&larr; str◦1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: start to: self length-str length+1 do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self◦i=t⇒[self◦(i to: i+str length-1)=str⇒[⇑i]]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">growto: n </span><span style="font: 10pt serif">| len [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(len &larr; self length) ≤ n⇒ [] len &larr; n].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑(self species new: n) copy: 1 to: len with: self from: 1 to: len]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">recopy<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self copy]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">replace: a to: b by: s <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s Is: String ⇒[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self replace: a to: b by: s from: 1 to: s length]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self replace: a to: b by: s asArray from: 1 to: s position]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">replace: a to: b by: r from: c to: d </span><span style="font: 10pt serif">| s t [</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s &larr; self species new: self length + (d-c) - (b-a).<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">use BitBlt unless StringBlter≡false or index/sizes too large</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">StringBlter and⦂ (<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">BitBlt new stringReplace: s with: self from: a to: b and: r from: c to: d)⇒ [⇑s]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">see Array concat:</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">t &larr; Stream new of: s.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self copy: 1 to: a-1 to: t.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">r copy: c to: d to: t.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self copy: b+1 to: self length to: t.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑s]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">subst: repl for: key </span><span style="font: 10pt serif">| key1 i nskip result<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[nskip &larr; 0. key1 &larr; key◦1. result &larr; Stream default.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: self length do⦂</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">" the Boyer Slow string replacement "</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[nskip&gt;0⇒ [nskip &larr; nskip-1]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self◦i = key1⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self◦(i to: (self length min: i+key length-1)) = key⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[result append: repl. nskip &larr; key length-1]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">result next&larr; self◦i]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">result next&larr; self◦i]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑result contents]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Comparison</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">- s </span><span style="font: 10pt serif">| i c ldiff</span><span class="tab" val="79"></span><span style="font: 10pt serif"> [<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Return a negative, zero, or positive integer as I compare &lt; = or &gt; s"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"The collation sequence is ascii with case differences ignored."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(ldiff &larr; self length-s length) &lt; 0⇒ [self length] s length] do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(c&larr; UpperCase◦(self◦i + 1) -(UpperCase◦(s◦i + 1)))<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">≠0⇒ [⇑c]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ldiff]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">&lt; s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Return true iff I collate before s.  The collation sequence is ascii with case differences ignored."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑(self compare: s) = 1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">&gt; s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Return true iff I collate after s.  The collation sequence is ascii with case differences ignored."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑(self compare: s) = 3]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">compare: s </span><span style="font: 10pt serif">| i len lcomp u1 u2 [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">lcomp &larr; [self length &lt; (len &larr; s length)⇒ [len &larr; self length. 1]; =len⇒ [2] 3].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: len do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(u1 &larr; UpperCase◦(self◦i + 1)) = (u2 &larr; UpperCase◦(s◦i + 1))⇒ []<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">u1 &lt; u2⇒ [⇑1]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑3]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑lcomp]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hash </span><span style="font: 10pt serif">| l m<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[(l&larr; m&larr; self length)≤2⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[l=2⇒[m&larr;3]; =1⇒[⇑((self◦1) land: 0177)*0152] ⇑052525]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ⇑(self◦1)*060+(self◦(m-1)+l)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">match: text </span><span style="font: 10pt serif">| star pound pattern scanning p t back [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">star &larr; 052 "*".  pound &larr; 043 "#".<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pattern &larr; self asStream.  text &larr; text asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">scanning &larr; false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ true do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(p &larr; pattern next)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=star⇒ [pattern end⇒ [⇑true] scanning &larr; pattern position]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(t &larr; text next)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">≡false⇒ [⇑t≡p]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">p≡false⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">scanning⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">back &larr; scanning - pattern position.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pattern skip: back. text skip: back]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">UpperCase◦(t+1) = (UpperCase◦(p+1)) or⦂ p=pound⇒ []<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">scanning⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">back &larr; scanning - pattern position.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pattern skip: back. text skip: back+1]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">systemRehash </span><span style="font: 10pt serif">| dicts d left loop<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["change the meaning of hash for Strings"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">String understands:</span><span style="font: bold 10pt serif"><br></span><span style="font: 10pt serif">&rsquo;</span><span style="font: bold 10pt serif">hash </span><span style="font: 10pt serif">| l m<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[(l&larr; m&larr; self length)≤2⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[l=2⇒[m&larr;3]; =1⇒[⇑((self◦1) land: 0177)*0152] ⇑052525]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ⇑(self◦1)*060+(self◦(m-1)+l)]&rsquo;.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"rehash the atom table"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ↪a rehash.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"rehash all dictionaries which have strings in them"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> dicts &larr; HashSet allInstances+Dictionary allInstances<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">+SymbolTable allInstances.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> for⦂ d from: dicts do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[left &larr; d objects asStream. loop &larr; left next.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> while⦂ loop do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[loop is: String⇒[d rehash. loop &larr; false]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> loop &larr; left next]]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Conversion</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asBytes </span><span style="font: 10pt serif">| s c<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s &larr; Stream default.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ c from: self do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s append: c base8; space]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑s contents]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asDecimalDigits </span><span style="font: italic 10pt serif">"Not asInteger, because the result may be a Float if it&rsquo;s too big"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| strm sign c val<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strm&larr; Stream new of: self.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sign&larr; strm∢025.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">val&larr; [self length&gt;4⇒[0.0]0].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ c from: strm do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[c&lt;060 or: c&gt;071⇒[user notify: self + &rsquo; isn&rsquo;&rsquo;t a valid integer&rsquo;]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">val&larr; val*10+(c-060)]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sign⇒[⇑val*¬1]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑val]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asFileName </span><span style="font: 10pt serif">[⇑dp0 checkName: self fixing: true]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asFloat </span><span style="font: 10pt serif">| strm int frac exp<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strm&larr; Stream new of: self.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">int&larr; strm upto: 056.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">frac&larr; strm upto: 0145.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">exp&larr; strm rest asInteger - frac length.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">int&larr; (int concat: frac) asDecimalDigits asFloat.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">exp=0⇒[⇑int];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&gt;0⇒[⇑int*(10.0 ipow: exp)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑int/(10.0 ipow: 0-exp)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asInteger </span><span style="font: 10pt serif">| strm sign base maxdigit c val<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strm&larr; Stream new of: self.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sign&larr; [strm∢025⇒[¬1]1].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">base&larr; [strm∢060⇒[8]10]. maxdigit&larr; 060+base.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">val&larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ c from: strm do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[c&lt;060 or: c≥maxdigit⇒[user notify: self + &rsquo; isn&rsquo;&rsquo;t a valid Integer&rsquo;]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">val&larr; val*base+(c-060)]<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Some special maneuvering to keep 01ddddd and ¬32768 (and nothing else) from overflowing."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[val&gt;077777⇒[base=8⇒[sign=1⇒[val&lt;65536⇒[⇑val asSmall]]]]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑(val*sign) asInteger]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asLarge </span><span style="font: 10pt serif">"convert to a LargeInteger"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">| neg i large large10<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[self◦1=025⇒[neg&larr;true] neg&larr;false].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> large &larr; 0 asLarge. large10 &larr; 10 asLarge.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> for⦂ i from: [neg⇒[2]1] to: self length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[large &larr; (large*large10)+(self◦i-060)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> neg⇒[⇑large negated] ⇑large]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asParagraph<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑Paragraph new text: self alignment: 0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asUppercase </span><span style="font: 10pt serif">| s c<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s &larr; Stream default.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ c from: self do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s next &larr; UpperCase◦(c+1)]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑s contents]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asVector<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self asStream asVector]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">base8: i  </span><span style="font: italic 10pt serif">"word: i  in base 8 as a String"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑(self word: i) base8]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hasBeenUniqued<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑↪a hasInterned: self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm </span><span style="font: 10pt serif">| x</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"print inside string quotes"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strm next&larr; 047.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ x from: self do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strm next&larr; x.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">x=047⇒[strm next&larr; x]]</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"imbedded quotes get doubled"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm next&larr; 047]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">unique </span><span style="font: 10pt serif">| u</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"copy and intern"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑↪a intern: self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Compatibility</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">species<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑String]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>System primitives</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">lock </span><span style="font: 10pt serif">[] primitive: 31</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">unlock </span><span style="font: 10pt serif">[] primitive: 32</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪String under: &rsquo;Basic Data Structures&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"Substring"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;Substring&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Array<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;data map&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I am an array that consists of a set of elements (specified by map) of an array (data)</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">data: data map: map</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Reading and Writing</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">◦ x<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑data◦(map◦x)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">◦ x &larr; val<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑data◦(map◦x) &larr; val]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">length<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑map length]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">map<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Return my map."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑map]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Copying and Altering</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">swap: i with: j </span><span style="font: 10pt serif">| t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"By permuting my map (a writable Array), swap elements i and j."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">t &larr; map◦i. map◦i &larr; map◦j. map◦j &larr; t.]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Conversion</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asStream<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[map isIntervalBy1⇒</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"direct stream for simple substrings"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑Stream new of: data from: map start to: map stop]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑Stream new of: self from: 1 to: map length]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Compatability</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">species<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑data species]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪Substring under: &rsquo;Basic Data Structures&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"UniqueString"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">VariableLengthClass new title: &rsquo;UniqueString&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: String<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">bytesize: 8;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I am a string that is unequal to every other instance of my subclass</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit </span><span style="font: 10pt serif">| i a v</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"make up table of 1-char atoms"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[v &larr; Vector new: 128. a &larr; String new: 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: 128 do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[a◦1 &larr; i-1. v◦i &larr; a unique]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">UST1 &larr; v]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hasInterned: s </span><span style="font: 10pt serif">| h i v n<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"⇑false if String s hasnt been interned, else ⇑s unique"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span class="tab" val="79"></span><span style="font: 10pt serif">[s length=1⇒[s◦1&lt;128⇒[⇑UST1◦(s◦1+1)]]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">h&larr; s hash.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">v &larr; USTable◦(h\USTable length+1).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i&larr; h\v length+1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ n to: v length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[v◦i≡nil⇒</span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑false]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s length=(v◦i) length⇒ [s=(v◦i)⇒[⇑v◦i]]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">i&larr; [i=v length⇒[1] i+1]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: &rsquo;USTable is jammed&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">intern: s </span><span style="font: 10pt serif">| h i j v n</span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span class="tab" val="79"></span><span style="font: 10pt serif">[s length=1⇒[s◦1&lt;128⇒[⇑UST1◦(s◦1+1)]]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">h&larr; [s is: String⇒[s hash] s stringhash].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">v &larr; USTable◦(h\USTable length+1).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i&larr; h\v length+1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ n to: v length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[v◦i≡nil⇒</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"empty slot"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[n&larr; ¬4.  for⦂ j from: v do⦂ [j≡nil⇒ [n &larr; n+4]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">n &lt; v length⇒</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"grow bucket if &gt; 3/4 full"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[USTable◦(h\USTable length+1) &larr; Vector new: 2*v length.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ n from: v do⦂</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"rehash all its contents"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[n≡nil⇒ [] self intern: n]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self intern: s]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑v◦i &larr; [s is: UniqueString⇒[s]</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"install new entry"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(UniqueString new: s length) str: s]]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s length=(v◦i) length⇒ [s=(v◦i)⇒[⇑v◦i]]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">i&larr; [i=v length⇒[1] i+1]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: &rsquo;USTable is jammed&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">rehash </span><span style="font: 10pt serif">| oldTable v i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[oldTable &larr; USTable.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> USTable &larr; Vector new: oldTable length.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> for⦂ i to: USTable length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[USTable◦i &larr; Vector new: 4].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> for⦂ v from: oldTable do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ i from: v do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[i≡nil⇒[] self intern: i]]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">str: s </span><span style="font: 10pt serif">| j<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ j to: s length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[super◦j &larr; s◦j]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">unique</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Reading and Writing</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">◦x &larr; val<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user notify: &rsquo;UniqueStrings are not for writing into&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Selectors</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">isarrow</span><span class="tab" val="79"></span><span style="font: bold 10pt serif"> </span><span style="font: italic 10pt serif">"ends with &larr;"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self length≤1⇒ [⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self◦self length=95]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">isinfix </span><span style="font: 10pt serif">| x<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self length≠1⇒ [⇑false]  ⇑(self◦1) isletter≡false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">iskeyword </span><span style="font: 10pt serif">| x</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"ends with colon"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self length≤1⇒ [⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">x &larr; self◦self length.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">x=072⇒[⇑true] ⇑x=03]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">isuneval </span><span style="font: 10pt serif">| x</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"ends with open colon"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self◦self length=03]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">keywords  </span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">return a vector of the keywords that compose me</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| result strm i l char colon ocolon<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[&rsquo;◦&larr;&rsquo;=self⇒[⇑↪(&rsquo;◦&rsquo; &rsquo;&larr;&rsquo;)]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">result&larr;(Vector new: 10) asStream.  strm&larr;Stream default.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">colon&larr;&rsquo;:&rsquo;◦1.  ocolon&larr;&rsquo;⦂&rsquo;◦1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i&larr;1.  l&larr;self length.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ i≤l do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[char&larr;self◦i.  strm append: char.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> [(char=colon or⦂ char=ocolon) or⦂ i=l⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[result next&larr; strm contents.  strm reset]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">i&larr;i+1].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑result contents]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">mustTake: nargs </span><span style="font: italic 10pt serif">"fatal error if I am not a selector that takes nargs arguments"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self numArgs≠nargs⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user notify: self + &rsquo; does not take &rsquo; + nargs asString + &rsquo; arguments&rsquo;]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">numArgs  </span><span style="font: 10pt serif">| len n i </span><span style="font: italic 10pt serif">"the number of arguments I take when I am a selector"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[len &larr; self length.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">len=1⇒ [⇑[(self◦1) isletter⇒ [0] 1]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">n &larr; 0. </span><span style="font: italic 10pt serif">"count colons, dots, and arrows"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: len do⦂ [self◦i=072⇒ [n&larr;n+1]; =03⇒ [n&larr;n+1]; =0137⇒[n&larr;n+1]; =07⇒[n&larr;n+1]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑n]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Comparison</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">= x </span><span style="font: 10pt serif">[⇑self≡x]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hash </span><span style="font: 10pt serif">[] primitive: 46</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">stringhash<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑super hash]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Compatibility</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">copy </span><span style="font: 10pt serif">[⇑self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">recopy </span><span style="font: 10pt serif">[⇑self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">species<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑String]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Conversion</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asString<br></span><span style="font: 10pt serif">[⇑super copy]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strm append: self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪UniqueString under: &rsquo;Basic Data Structures&rsquo;.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">UniqueString classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"Vector"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">VariableLengthClass new title: &rsquo;Vector&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Array<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>Vector is a VariableLengthClass.  The length of a Vector may not be less than 0,<br>nor may it be greater than 8196.  <br>A field of a Vector may contain any other object.<br>A new Vector contains nil in every field.  <br>To create a new Vector of length 8, say:<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Vector new: 8<br><br>Microcode Primitives<br>◦ x   "subscript"<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">[0 &gt; x or: x &gt; self length ⇒[user notify: &rsquo;Subscript out of bounds&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">x class ≡ Integer ⇒[Return the xth element of the Vector]<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">⇑ super ◦ x]<br>◦ x &larr; val  "assign value to element"<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">[0 &gt; x or: x &gt; self length ⇒[user notify: &rsquo;Subscript out of bounds&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">x class ≡ Integer ⇒[Store the value val as the xth element. ⇑val]<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">⇑ super ◦ x &larr; val]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Reading and Writing</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">length </span><span style="font: italic 10pt serif">"This is actually done in microcode"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self length </span><span style="font: italic 10pt serif">"perform: needs this"</span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Copying and Altering</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">, x </span><span style="font: 10pt serif">| v<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[v &larr; self growby: 1.</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"use a stream if youre in a hurry"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">v last &larr; x. ⇑v]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Searching</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">max</span><span style="font: 10pt serif">| biggest i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[biggest &larr; self◦1.</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"return largest value in a vector"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: self length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(self◦i) &gt; biggest ⇒[biggest &larr; self◦i]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ⇑biggest]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Conversion</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asVector</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm </span><span style="font: 10pt serif">| i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strm append: &rsquo;(&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: self length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strm print: self◦i; space]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm append: &rsquo;)&rsquo; ]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>System primitives</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">nail </span><span style="font: 10pt serif">[user croak] primitive: 31</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Nail me in core and return my core address"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">unNail </span><span style="font: 10pt serif">[user croak] primitive: 32</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Release me from being nailed"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Compiler argument list</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">argsOff: stack<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[stack pop: self length]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emitForValue: code on: stack  </span><span style="font: 10pt serif">| x<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ x from: self do⦂ [x emitForValue: code on: stack]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">firstPush<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑(self◦1) firstPush]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">remote: generator  </span><span style="font: 10pt serif">| x<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ x from: self do⦂ [x remote: generator]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sizeForValue  </span><span style="font: 10pt serif">| size x<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[size &larr; 0. for⦂ x from: self do⦂ [size &larr; size+ x sizeForValue]. ⇑size]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪Vector under: &rsquo;Basic Data Structures&rsquo;.</span></div>
    <div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">&rsquo;From Smalltalk 5.5k XM November 24 on 22 November 1980 at 2:57:08 am.&rsquo;<br></span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">"ClassOrganizer"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;ClassOrganizer&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;globalComment commentVector groupVector&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;default &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>ClassOrganizers contain the formatting information for printing classes.  Each String in commentVector describes a category comprising the messages contained in the Vector which is the corresponding entry in groupVector.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[default &larr; &rsquo;As yet unclassified&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init: sortedVec<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self globalComment &larr; &rsquo;This class has not yet been commented&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">commentVector &larr; &rsquo;As yet unclassified&rsquo; inVector.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">groupVector &larr; sortedVec inVector]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Access to parts</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asStream </span><span style="font: 10pt serif">| v t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[v &larr; Stream new of: (Vector new: 200).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ t from: groupVector do⦂ [v append: t].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑v contents asStream]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">categories </span><span style="font: 10pt serif">[⇑commentVector]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">category: str </span><span style="font: 10pt serif">| i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[i &larr; commentVector find: str.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i=0⇒[user notify: &rsquo;No such category: &rsquo;+str]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑groupVector◦i]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classify: selector under: heading </span><span style="font: 10pt serif">| s h n<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[selector is: Vector⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ s from: selector do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self classify: s under: heading]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s &larr; commentVector find: heading.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s&gt;0 and⦂ (groupVector◦s has: selector)⇒[⇑self]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[h &larr; self invert: selector⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[heading=default⇒[⇑self]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> </span><span class="tab" val="79"></span><span style="font: 10pt serif"> n &larr; commentVector find: h.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> groupVector◦n &larr; groupVector◦n delete: selector]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s=0⇒ [s &larr; self insert: heading]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">groupVector◦s &larr; groupVector◦s insertSorted: selector.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">n &larr; commentVector find: default.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">n&gt;0 and⦂ (groupVector◦n) length=0⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self deleteCategory: n]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">delete: selector </span><span style="font: 10pt serif">| i</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"delete this from all categories"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ i to: groupVector length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[groupVector◦i has: selector⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[groupVector◦i &larr; (groupVector◦i) delete: selector.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(groupVector◦i) length=0 and⦂ commentVector◦i=default⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self deleteCategory: i]]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">deleteCategory: index<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[groupVector &larr; groupVector without: index.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">commentVector &larr; commentVector without: index]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">globalComment </span><span style="font: 10pt serif">[⇑globalComment asParagraph text]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">globalCommentItself </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">used only by </span><span style="font: bold 10pt serif">Class archiveOn:changesOnly:</span><span style="font: 10pt serif">" ⇑globalComment]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">globalComment &larr; globalComment </span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">String or RemoteParagraph</span><span style="font: 10pt serif">"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">has: sel </span><span style="font: 10pt serif">| t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ t from: groupVector do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t has: sel⇒[⇑true]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">insert: heading </span><span style="font: 10pt serif">| di dgroup hi  </span><span style="font: italic 10pt serif">"force default category to end, delete if empty"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[(di&larr;commentVector find: default)&gt;0⇒ [dgroup &larr; groupVector◦di]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">commentVector &larr; (commentVector without: di), heading.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">groupVector &larr; (groupVector without: di), (Vector new: 0).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">hi &larr; commentVector length.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">di=0 or⦂ dgroup length=0⇒ [⇑hi]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">commentVector &larr; commentVector, default.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">groupVector &larr; groupVector, dgroup.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑hi]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">invert: selector </span><span style="font: 10pt serif">| i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ i to: groupVector length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[groupVector◦i has: selector⇒[⇑commentVector◦i]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Conversion to text</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asParagraph </span><span style="font: 10pt serif">| s i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s &larr; Stream default.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s print: self globalComment.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: commentVector length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s cr; print: ((commentVector◦i) inVector concat: groupVector◦i)]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑s contents asParagraph]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fromParagraph: para </span><span style="font: 10pt serif">| t i j g<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user displayoffwhile⦂<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t &larr; para asVector.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self globalComment &larr; t◦1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">commentVector &larr; Vector new: t length-1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">groupVector &larr; Vector new: t length-1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: t length-1 do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[g &larr; t◦(i+1).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">commentVector◦i &larr; g◦1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ 0=(j&larr; g find: ↪&larr;) do⦂</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"reconstitute &larr; suffixes"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[g &larr; g replace: j-1 to: j by: (g◦(j-1)+&rsquo;&larr;&rsquo;) unique inVector]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">groupVector◦i &larr; (g copy: 2 to: g length) sort]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪ClassOrganizer under: &rsquo;Sets and Dictionaries&rsquo;.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">ClassOrganizer classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"Dict"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;Dict&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>a model for dictionary-index classes</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialize</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init: initialSize </span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">default is to ignore</span><span style="font: 10pt serif">"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Name-Value Access</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">◦ name </span><span style="font: 10pt serif">| entry ["</span><span style="font: italic 10pt serif">find</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">entry &larr; self find: name⇒ [⇑entry value]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">◦ name &larr; value </span><span style="font: 10pt serif">[ "</span><span style="font: italic 10pt serif">replace or insert</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self write: (self newEntry name: name value: value)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">insert: name with: value </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self insert: (self newEntry name: name value: value)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">lookup: name </span><span style="font: 10pt serif">[⇑self◦name]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">replace: name with: value </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self replace: (self newEntry name: name value: value)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Entry Access</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">contents </span><span style="font: 10pt serif">[⇑self match: &rsquo;*&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">create: entry </span><span style="font: 10pt serif">[⇑self insert: entry]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">delete: entry </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self Find: (entry &larr; self makeEntry: entry)⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self Delete: entry.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑entry]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self error: &rsquo;not deleted (not found)&rsquo; entry: entry]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">exists: entry </span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">doesn&rsquo;t initialize too much</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self Find: (self makeEntry: entry)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">find: entry </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self Find: (entry &larr; self makeEntry: entry)⇒ [⇑self found: entry]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self error: &rsquo;not found&rsquo; entry: entry]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">found: entry </span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">found, fill it in from dictionary</span><span style="font: 10pt serif">" ⇑self nextEntry: entry]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">get: entry </span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">find or insert</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self Find: (entry &larr; self makeEntry: entry)⇒ [⇑self found: entry]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self Insert: entry.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑entry]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">insert: entry </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self Find: (entry &larr; self makeEntry: entry)⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self error: &rsquo;not inserted (already found)&rsquo; entry: entry]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self Insert: entry.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑entry]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">list </span><span style="font: 10pt serif">[self list: &rsquo;*&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">list: entries </span><span style="font: 10pt serif">[self match: entries to: user]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">match: entries </span><span style="font: 10pt serif">| set [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">set &larr; Set new vector: 50.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self match: entries to: set.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑set contents]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">match: entries to: strm </span><span style="font: 10pt serif">| entry nentries [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">return a Set of entries which match those in entries<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">(can include exact values and patterns and ranges)</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(entries is: Vector) or⦂ (entries Is: Set)⇒ [] entries &larr; entries inVector].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nentries &larr; Set new vector: entries length.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ entry from: entries do⦂ [nentries next &larr; self makeEntry: entry].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self Match: nentries to: strm]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">read: entry </span><span style="font: 10pt serif">[⇑self find: entry]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">rename: entry newName: name </span><span style="font: 10pt serif">| nentry ["not tested"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self Find: (nentry &larr; self makeEntry: name)⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self error: &rsquo;already exists&rsquo; error: nentry]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self Find: (entry &larr; self makeEntry: entry)⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self Rename: entry from: nentry.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑entry]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self error: &rsquo;not found&rsquo; entry: entry]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">replace: entry </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self Find: (entry &larr; self makeEntry: entry)⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self Replace: entry.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑entry]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self error: &rsquo;not replaced (not found)&rsquo; entry: entry]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">retrieve: entry </span><span style="font: 10pt serif">[⇑self find: entry "match:?"]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">store: entry </span><span style="font: 10pt serif">[⇑self write: entry]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">write: entry </span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">replace or insert</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self Find: (entry &larr; self makeEntry: entry)⇒ [self Replace: entry]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self Insert: entry].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑entry]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Stream Access</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">append: dict </span><span style="font: 10pt serif">| entry [for⦂ entry from: dict do⦂ [self write: entry]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asStream </span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">leave position where it is</span><span style="font: 10pt serif">"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">next </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">return next entry or false</span><span style="font: 10pt serif">" <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self nextEntry: self newEntry]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">position </span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">current position (name)</span><span style="font: 10pt serif">" self subError]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">position &larr; name </span><span style="font: 10pt serif">[⇑self Position &larr; self makeEntry: name]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">Position &larr; entry </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">position to name, or position to insert place and return false if not found.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">subclass had better define position&larr; or Position&larr; (preferably)<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">otherwise circularity results!!!</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self position &larr; entry name]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">reset </span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">position to beginning</span><span style="font: 10pt serif">" self subError]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Entry Creation</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">entryClass </span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">a subclass of DictionaryEntry</span><span style="font: 10pt serif">" self subError]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">makeEntry: entry </span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">entry or name</span><span style="font: 10pt serif">" | cl [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">cl &larr; self entryClass.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">cl≡false or⦂ (entry Is: cl)⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"entry should not be converted or is the correct type" ⇑entry]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"convert entry from a name to an entry with that name"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self newEntry name: entry]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">newEntry </span><span style="font: 10pt serif">[⇑[(self entryClass new) dictionary: self; init]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">nextEntry: entry </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">return next name and value in entry, or false.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">if insert or delete occurs after previous next, may be problem</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑entry]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Entry Operations</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">Delete: entry </span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">entry found (next), delete it</span><span style="font: 10pt serif">" self subError]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">entrySize: entry </span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">storage size of entry, constant or variable</span><span style="font: 10pt serif">" self subError]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">error: e entry: entry </span><span style="font: 10pt serif">["entry error: e" ⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">Find: entry </span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">is entry in dictionary?</span><span style="font: 10pt serif">" ⇑self Position &larr; entry]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">Insert: entry </span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">entry not found, insert it (next)</span><span style="font: 10pt serif">" self subError]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">Match: entries to: strm </span><span style="font: 10pt serif">| entry pat ents [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">default (unordered) is to compare entire dictionary with entries</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self reset.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ entry from: self do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">ents &larr; entries asStream.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ (ents and⦂ (pat &larr; ents next)) do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pat match: entry⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">ents &larr; false.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm next &larr; entry<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">Rename: entry from: nentry </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self Delete: entry; Insert: (entry name: nentry name)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">Replace: entry </span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">entry found (next), replace it&rsquo;s value</span><span style="font: 10pt serif">" self subError]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>File-Based dictionary</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">close </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self obsolete⇒ []<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">possible cleanup before a release</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self file⇒ [self file close]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self release]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">file </span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">return my file</span><span style="font: 10pt serif">" ⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">obsolete </span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">is my information obsolete (should I regenerate it)?</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self file⇒ [⇑self file obsolete]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">open</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">release </span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">obsolete and deallocate storage, especially if connected to an external view,<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">e.g. a File</span><span style="font: 10pt serif">" [self file⇒ [self file release]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">reopen </span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">reinitialize, especially if a File is involved</span><span style="font: 10pt serif">" self open]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪Dict under: &rsquo;Sets and Dictionaries&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"DictionaryEntry"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;DictionaryEntry&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>a model for entries --what to retrieve with and store in dictionaries</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialize</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dictionary: dict</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">name: name</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Other</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dictionary </span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">what dictionary did I come from?</span><span style="font: 10pt serif">" ⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">match: entry </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">does self (some kind of pattern) match entry?</span><span style="font: 10pt serif">" self subError] </span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Filing</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fileSize </span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">size in characters for filing</span><span style="font: 10pt serif">" self subError]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">readFrom: file </span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">inverse of </span><span style="font: bold 10pt serif">storeOn:</span><span style="font: 10pt serif">" self subError]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">storeOn: file </span><span style="font: 10pt serif">["store </span><span style="font: bold 10pt serif">self</span><span style="font: 10pt serif"> as </span><span style="font: bold 10pt serif">fileSize</span><span style="font: 10pt serif"> characters on </span><span style="font: bold 10pt serif">file</span><span style="font: 10pt serif">" self subError]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪DictionaryEntry under: &rsquo;Sets and Dictionaries&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"HashSet"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;HashSet&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;objects&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>HashSets are pure sets of objects with no associated values.  However, since they allow callers to determine the location of objects in the hash table, subclasses such as Dictionary and MessageDict can provide parallel tables to hold values.  Such subclasses must intercept growto: and reorder their own tables then.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">copy </span><span style="font: italic 10pt serif">"⇑ a copy of me"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self class new copyfrom: self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">copyfrom: hset </span><span style="font: italic 10pt serif">"take on state of hset"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[objects &larr; hset objects copy]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self init: 4]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init: size<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[objects &larr; Vector new: (size max: 2)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Access to parts</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asStream<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self contents asStream]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">contents </span><span style="font: 10pt serif">| obj strm<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strm &larr; (Vector new: objects length) asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ obj from: objects do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[obj≡nil⇒[] strm next&larr; obj]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑strm contents]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">size </span><span style="font: 10pt serif">[⇑objects length]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Searching</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">find: obj </span><span style="font: 10pt serif">| i</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"⇑index if found, else false"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[i &larr; self findornil: obj.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">objects◦i=obj⇒[⇑i] ⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">findorerror: name </span><span style="font: 10pt serif">| i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[i &larr; self findornil: name.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">objects◦i=name⇒ [⇑i]<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"allow the user to put a correct value into i"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: name asString+&rsquo; cannot be found&rsquo;. ⇑i]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">has: obj<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑objects◦(self findornil: obj)=obj]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Insertion and deletion</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">delete: obj </span><span style="font: 10pt serif">| i j l<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[obj is: Vector⇒[for⦂ i from: obj do⦂ [self delete: i]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i&larr; self findorerror: obj.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">objects◦i&larr; nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">l&larr; objects length.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ objects◦(i&larr; [i=l⇒[1] i+1])≡nil do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[i=(j&larr; self findornil: objects◦i)⇒[]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self swap: i with: j]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">insert: obj </span><span style="font: 10pt serif">| i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self findorinsert: obj. ⇑obj]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">insertall: objs </span><span style="font: 10pt serif">| x<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ x from: objs do⦂ [self insert: x]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Growing and shrinking</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">packprobes </span><span style="font: 10pt serif">| tot n l i obj t</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"⇑(fullness, avg #probes)"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[tot &larr; n &larr; 0. l &larr; objects length.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: l do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(obj&larr; objects◦i)≡nil⇒[]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">t &larr; obj hash \ l.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">tot &larr; tot + [i &lt; t⇒ [l - t + i] i - t].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">n&larr; n+1]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">n=0⇒[⇑(1,1)]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑((n asFloat/l) , (tot asFloat/n))]<br></span><span style="font: italic 10pt serif">"Class md packprobes(0.4921875 2.53968255 )"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">shrink </span><span style="font: 10pt serif">| table oldtable<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[oldtable &larr; self.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">table &larr; oldtable growto: (2 max: oldtable size/2).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ table size=oldtable size do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(oldtable size-table size) print.  user show: &rsquo; &rsquo;.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">oldtable &larr; table.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">table &larr; oldtable growto: (2 max: oldtable size/2)]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑table]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Private</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">findorinsert: obj </span><span style="font: 10pt serif">| i</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"insert if not found, "</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[i &larr; self findornil: obj.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">objects◦i=obj⇒[⇑i]  </span><span style="font: italic 10pt serif">"found it"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self sparse⇒[objects◦i &larr; obj. ⇑i]  </span><span style="font: italic 10pt serif">"insert if room"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self growto: objects length*2.</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"grow"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self findorinsert: obj </span><span style="font: italic 10pt serif">"and insert"</span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">findornil: obj </span><span style="font: 10pt serif">| i loc</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"⇑index if found or available slot"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[loc &larr; obj hash\objects length.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: objects length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[loc &larr; [loc=objects length⇒[1] loc+1].</span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">objects◦loc ≡ nil⇒ [⇑loc]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">objects◦loc = obj⇒ [⇑loc]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑1 </span><span style="font: italic 10pt serif">"table full - caller must check for hit"</span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">growto: t1 </span><span style="font: 10pt serif">| t2 t3  "faster insert for growing"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t2 &larr; self class new init: t1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t1 &lt; objects length ⇒[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ t3 from: self do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t2 insert: t3]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ t3 from: self do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t2 rawinsert: t3]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">objects &larr; t2 objects]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">objects </span><span style="font: 10pt serif">[⇑objects]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">objects&larr; objects</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">rawinsert: t1 </span><span style="font: 10pt serif">| t2 "assumes there </span><span style="font: bold 10pt serif">is</span><span style="font: 10pt serif"> room for the new one"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t2 &larr; self findornil: t1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">objects ◦ t2 &larr; t1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑t2]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">rehash </span><span style="font: 10pt serif">| i copy<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[copy &larr; HashSet new init: self size.</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"create a copy"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: objects length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[objects◦i≡nil⇒[]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> copy insert: objects◦i]</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"hash each entry into it"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">objects &larr; copy objects]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sparse </span><span style="font: 10pt serif">| i n<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"⇑true if (1 max: 1/4 of table) is nil"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">n &larr; objects length.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: objects length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[objects◦i≡nil⇒[(n&larr;n-4)≤0⇒[⇑true]]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">swap: i with: j<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[objects swap: i with: j]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪HashSet under: &rsquo;Sets and Dictionaries&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"Dictionary"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;Dictionary&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: HashSet<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;values&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>Dictionaries are sets with associated values.  They are very handy but not terribly efficient.  Most of their work is done by HashSet.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">copyfrom: dict<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self objects &larr; dict objects copy.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">values &larr; dict values copy]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init: size<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[values &larr; Vector new: size. super init: size]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Searching</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">◦ name<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑values◦(self findorerror: name)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">◦ name &larr; val<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑values◦(self findorerror: name) &larr; val]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">lookup: name </span><span style="font: 10pt serif">| x<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[x &larr; self find: name⇒ [⇑values◦x] ⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Inserting and Deleting</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">clean </span><span style="font: 10pt serif">| name</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"release unreferenced entries"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ name from: self do⦂</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"slick, huh"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(self◦name) refct = 1 ⇒ [self delete: name]]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">delete: name<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[name is: Vector⇒[super delete: name]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">values◦(self findorerror: name)&larr; nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">super delete: name]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">insert: name with: value<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self insert: name.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">values◦(self findorerror: name) &larr; value]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">insertall: names</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"default value is nil"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self insertall: names with: (Vector new: names length)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">insertall: names with: vals </span><span style="font: 10pt serif">| i</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"insert many entries"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ i to: names length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self insert: names◦i with: vals◦i]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">tally: name </span><span style="font: 10pt serif">| x<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[x &larr; self find: name⇒ [⇑values◦x&larr; values◦x+1]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self insert: name with: 1. ⇑1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">with: names values: vals </span><span style="font: 10pt serif">| i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ i to: names length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self insert: names◦i with: vals◦i]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Private</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">growto: size </span><span style="font: 10pt serif">| name copy<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[copy &larr; self class new init: size.</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"create a copy of the new size"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ name from: self do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[copy insert: name with: self◦name]</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"hash each entry into it"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self copyfrom: copy]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">rehash </span><span style="font: 10pt serif">| i copy<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[copy &larr; Dictionary new init: self size.</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"create a copy"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: objects length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[objects◦i≡nil⇒[]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> copy insert: objects◦i with: values◦i]</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"hash each entry into it"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self copyfrom: copy]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">swap: i with: j<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[values swap: i with: j.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">super swap: i with: j]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">values </span><span style="font: 10pt serif">[⇑values]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Inversion</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asInvertedVector </span><span style="font: 10pt serif">| s i v  </span><span style="font: italic 10pt serif">"in form ((value, object), ...)"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s &larr; (Vector new: objects length) asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: objects length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[objects◦i≡nil⇒ []<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">v &larr; Vector new: 2. v◦1&larr;values◦i. v◦2&larr;objects◦i.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s next &larr; v].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑s contents]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">invert<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self invertto: (Dictionary new init: objects length)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">invert: obj </span><span style="font: 10pt serif">| i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ i to: values length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[values◦i=obj⇒ [⇑objects◦i]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">invertto: dict </span><span style="font: 10pt serif">| i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ i to: objects length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[objects◦i≡nil⇒ []<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">dict insert: values◦i with: objects◦i].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑dict]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪Dictionary under: &rsquo;Sets and Dictionaries&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"MessageDict"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;MessageDict&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: HashSet<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;methods "&lt;Vector of Strings&gt; which are the compiled methods for each message"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">literals "&lt;Vector of Vectors&gt; which hold pointers to literals used in the methods"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">code "&lt;Vector of Strings&gt; which are the source text for each message"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">backpointers "&lt;Vector of Vectors&gt; which are the tables of text location vs pc for each message"&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>MessageDicts hold the source code and compiled methods for each message to a class.  The source code is a packed paragraph (see Paragraph packIntoString).  The methods contain pointers to literals, and must be specially freed.  If a method is being executed during its redefinition, its release must be delayed (its literals gets held in CodeKeeper).  Finally, MessageDicts must be copied to be grown, so that current use is not disturbed.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">copyfrom: dict<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self objects &larr; dict objects copy.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">methods &larr; dict methods copy.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">code &larr; dict code copy]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init: size<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[methods &larr; Vector new: size.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">code &larr; Vector new: size.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">super init: size]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Inserting and Deleting</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">close </span><span style="font: 10pt serif">| i</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"recycle all code and literals pointed to"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ i to: methods length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[methods◦i≡nil⇒[]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self freeMethod: methods◦i]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self init]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">delete: name </span><span style="font: 10pt serif">| i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[i &larr; self findorerror: name.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self freeMethod: methods◦i.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">methods◦i&larr; code◦i&larr; nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">super delete: name]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">insert: name method: m literals: l<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 10pt serif">code: c backpointers: b </span><span style="font: 10pt serif">| i copy<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[i &larr; self find: name⇒</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"if name is already there"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self freeMethod: methods◦i.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self holdLiterals: l.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">methods◦i &larr; m. code◦i &larr; c]</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"then insert it, and return self"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">copy &larr; [self sparse⇒[self] <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self growto: methods length*2].</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Otherwise, copy if necessary"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">copy objects◦(copy findornil: name) &larr; name.</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"and insert"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑copy insert: name method: m literals: l<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">code: c backpointers: b]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">purge: sel </span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"demand purging invalidates checkpointing"</span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Access to parts</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">code<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑code]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">code: name<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑code◦(self findorerror: name)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">code: name &larr; str<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑code◦(self findorerror: name) &larr; str]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">invert: method </span><span style="font: 10pt serif">| i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ i to: methods length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[methods◦i≡method⇒ [⇑objects◦i]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">literals: name<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self literalsIn: methods◦(self findorerror: name)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">method: name<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑methods◦(self findorerror: name)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">methodorfalse: name </span><span style="font: 10pt serif">| i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[i &larr; self find: name⇒[⇑methods◦i] ⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">methods<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑methods]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Code aspect of Strings</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">freeLiterals: v </span><span style="font: 10pt serif">| m i t</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"lower refct of all literals"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[v length=0⇒[]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">m &larr; v nail.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: v length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t &larr; mem◦(m+i-1). v◦i &larr; nil. mem◦(m+i-1) &larr; t]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">v unNail]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">freeMethod: m </span><span style="font: 10pt serif">| v c i t</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"method pointed to by some vector (dict or keeper)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">and (upon entry) by m.  If any other owners, refct will be &gt;2.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">*Expects Interpreter to nil args on callers stack*"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[m refct&gt;2⇒[MethodKeeper next&larr; m]</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"keep it"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">v&larr; self literalsIn: m.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"free its literals"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">v length=0⇒[]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">c &larr; v nail.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"fasten seat belts"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: v length do⦂</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"lower refct of each literal"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t &larr; mem◦(c+i-1). v◦i &larr; nil. mem◦(c+i-1) &larr; t]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">v unNail]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">freeMethods </span><span style="font: 10pt serif">| v i</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Free kept methods no longer used"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[v&larr; MethodKeeper contents.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">MethodKeeper&larr; (Vector new: 10) asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: v length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self freeMethod: v◦i]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">holdLiterals: v </span><span style="font: 10pt serif">| m i t</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"raise refct of all literals"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[v≡nil⇒[] v length=0⇒[]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">m &larr; v nail.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: v length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t &larr; v◦i. mem◦(m+i-1) &larr; ¬1. v◦i &larr; t]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">v unNail]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">holdMethods: v </span><span style="font: 10pt serif">| i </span><span style="font: italic 10pt serif">"a random insertion just to make it legal form"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ i to: v length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self insert: i method: v◦i literals: nil code: nil backpointers: nil]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">literalsIn: method </span><span style="font: 10pt serif">| i v</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"return the literal vector imbedded in this method"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[method≡nil⇒[⇑Vector new: 0]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">method length&lt;8⇒[⇑Vector new: 0]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">method◦2=41⇒[⇑Vector new: 0]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">v &larr; Vector new: method◦6-6/2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: v length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[v◦i &larr; (method word: 3+i) asObject]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑v]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Private</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">growto: size </span><span style="font: 10pt serif">| name copy i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[copy &larr; MessageDict new init: size.</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"create a copy of the new size"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ name from: self do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[i &larr; self findorerror: name.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"hash each entry into it"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">copy &larr; copy insert: name method: methods◦i<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">literals: [literals≡nil⇒[nil] literals◦i]  code: code◦i backpointers: nil]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑copy]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">swap: i with: j<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[methods swap: i with: j.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">code swap: i with: j.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">super swap: i with: j]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪MessageDict under: &rsquo;Sets and Dictionaries&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"SymbolTable"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;SymbolTable&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Dictionary<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I associate each of my objects with an object reference</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Access to parts</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">ref: name<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑super◦name]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">ref: name &larr; val<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑super◦name &larr; val]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Searching</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">◦ name<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑(super◦name) value]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">allCallsOn: selector from: classNames </span><span style="font: 10pt serif">| className s w cl sel<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[selector is: Vector⇒ [] selector &larr; selector inVector].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s &larr; Stream default.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user displayoffwhile⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ className from: classNames do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[cl &larr; self◦className.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ sel from: selector do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[w &larr; cl whosends: sel. w length=0⇒ []<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s append: className; append: &rsquo;⇒&rsquo;; append: w asString; cr]]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑s contents]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">allRefs  </span><span style="font: italic 10pt serif">"what methods reference my variables (I am probably &rsquo;Undeclared&rsquo;)"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self allRefsTo: self contents from: user classNames]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">allRefsTo: symbol from: classNames </span><span style="font: 10pt serif">| s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[symbol is: Vector⇒ [] symbol &larr; symbol inVector].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑Smalltalk allCallsOn: (symbol transform⦂ s to⦂ (self ref: s)) from: classNames]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">invert: obj </span><span style="font: 10pt serif">| i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ i to: values length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[nil≡(values◦i)⇒[]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">obj ≡ (values◦i) value ⇒[⇑objects◦i]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">invertRef: obj </span><span style="font: 10pt serif">| i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ i to: values length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[obj≡(values◦i)⇒[⇑objects◦i]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">lookup: name </span><span style="font: 10pt serif">| r<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[r&larr;super lookup: name⇒[⇑r value] ⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">lookupRef: name<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑super lookup: name]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Insertion</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">◦ name &larr; x<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑(super◦name) value &larr; x]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">declare: name</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Take ref(s) and value(s) from Undeclared, if name(s) there"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self declare: name from: Undeclared]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">declare: name as: x </span><span style="font: 10pt serif">| a s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[name is: Vector⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s &larr; x asStream. for⦂ a from: name do⦂ [self declare: a as: s next]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self declare: name.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self◦name &larr; x]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">declare: name from: symTab </span><span style="font: 10pt serif">| a </span><span style="font: italic 10pt serif">"take name(s), ref(s) and value(s) from symTab"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[name is: Vector⇒ [for⦂ a from: name do⦂ [self declare: a from: symTab]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self has: name⇒ []<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">symTab has: name⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[super insert: name with: (symTab ref: name).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">symTab delete: name]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self insert: name with: nil]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">define: name as: x</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"synonym"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self declare: name as: x]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">insert: name with: x<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span class="tab" val="79"></span><span style="font: 10pt serif">[self has: name⇒[]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">super insert: name with: ObjectReference new].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self◦name &larr; x]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">insert: name withref: ref<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[super insert: name with: ref]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Growing and shrinking</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">growto: size </span><span style="font: 10pt serif">| name copy<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[copy &larr; self class new init: size.</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"create a copy of the new size"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ name from: self do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[copy insert: name withref: (self ref: name)]</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"hash each entry into it"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self copyfrom: copy]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">rehash </span><span style="font: 10pt serif">| i copy<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[copy &larr; SymbolTable new init: self size.</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"create a copy"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: objects length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[objects◦i≡nil⇒[]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> copy insert: objects◦i withref: values◦i]</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"hash each entry into it"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self copyfrom: copy]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪SymbolTable under: &rsquo;Sets and Dictionaries&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"SystemOrganizer"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;SystemOrganizer&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: ClassOrganizer<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>Provides an organization for the classes in the system just as ClassOrganizer organizes the messages within a class.  (In fact, the only difference is the filout/printing messages.)</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Filout and printing</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">filoutAll </span><span style="font: 10pt serif">| cat<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ cat from: commentVector do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self filoutCategory: cat]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">filoutCategory: cat </span><span style="font: 10pt serif">| all a [user displayoffwhile⦂ [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">all &larr; self superclassOrder: cat.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(dp1 file: (cat+&rsquo;.st.&rsquo;) asFileName) filoutclass: all.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ a from: all do⦂ [(Smalltalk◦a) noChanges]]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printAll </span><span style="font: 10pt serif">| cat<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ cat from: commentVector do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self printCategory: cat]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printCategory: cat </span><span style="font: 10pt serif">[user displayoffwhile⦂ [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(dp0 file: (cat+&rsquo;.press&rsquo;) asFileName) printoutclass: (self superclassOrder: cat)]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">superclassOrder: cat </span><span style="font: 10pt serif">| all lis a i c sup  "Arrange classes in superclass order so they can be filed in"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[lis&larr; (self category: cat) copy. all &larr; (Vector new: lis length) asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ lis length&gt;0 do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[i&larr; 1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[a&larr; lis◦i. sup&larr; c&larr; Smalltalk◦a.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ "Make sure it doesn&rsquo;t have an as yet unprinted superclass"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[sup&larr; sup superclass.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">sup≡nil⇒[true]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">lis has: sup title unique]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">do⦂ [].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">sup≡nil]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">do⦂ [i&larr; i+1].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">all next &larr; a.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">lis&larr; lis delete: a].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑all contents]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪SystemOrganizer under: &rsquo;Sets and Dictionaries&rsquo;.</span></div>
    <div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">&rsquo;From Smalltalk 5.5k XM November 24 on 22 November 1980 at 2:57:08 am.&rsquo;<br></span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">"Cursor"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;Cursor&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;bitstr offset&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I am a 16 x 16 dot matrix suitable for use as the Alto hardware cursor</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fromString: bitstr </span><span style="font: 10pt serif">[self fromString: bitstr offset: 0⌾0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fromString: bitstr offset: offset</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fromtext: str </span><span style="font: 10pt serif">[self fromtext: str offset: 0⌾0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fromtext: str offset: offset </span><span style="font: 10pt serif">| i s n c [<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Not great, but compatible with printon."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitstr &larr; String new: 32.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s &larr; str asStream.  s next.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: 16 do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[n &larr; 0.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ ((c &larr; s next)=060 or⦂ c=061) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[n &larr; (n lshift: 1)+(c-060)].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitstr word: i &larr; n]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">offset: offset</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Hardware cursor</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">frompage1</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"load this cursor from the hardware locations"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[bitstr &larr; String new: 32.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">BitBlt new forCursor; sourcebase&larr; 0431; destbase &larr; bitstr; copy: storing]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Conversion</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hardcopy: pf </span><span style="font: 10pt serif">["use current cursor position"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self hardcopy: pf at: user mp - offset]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hardcopy: pf at: loc </span><span style="font: 10pt serif">| rect [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"print cursor image at some point location into a presssfile"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rect &larr; loc extent: 16⌾16.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pf setp: (pf transrect: rect) origin; bitmap: rect bits: bitstr]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm </span><span style="font: 10pt serif">| i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strm append: &rsquo;Cursor new fromtext: &rsquo;&rsquo;&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: 16 do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strm cr.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(bitstr word: i) printon: strm base: 2]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm append: &rsquo;&rsquo;&rsquo; offset: &rsquo;; print: offset; append: &rsquo;.&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Aspects</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">offset </span><span style="font: 10pt serif">[⇑offset]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Showing</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">show</span><span class="tab" val="79"></span><span style="font: bold 10pt serif"> </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"copy this cursor into the page 1 hardware locations"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">BitBlt new forCursor; destbase&larr; 0431; sourcebase &larr; bitstr; copy: storing.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user currentCursor: self<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"the following statement will copy back if we ever need to"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"BitBlt new forCursor; sourcebase&larr; 0431; destbase &larr; bitstr; copy: storing"]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">showwhile⦂ expr </span><span style="font: 10pt serif">| oldcursor value [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">oldcursor &larr; user currentCursor.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self show.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">value &larr; expr eval.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">oldcursor show.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑value]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Compatibility</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">topage1</span><span class="tab" val="79"></span><span style="font: 10pt serif">[self show]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪Cursor under: &rsquo;Graphical Objects&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"HalfToner"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;HalfToner&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;lines pixelsPerLine black white errorString rect vect inpix outpix nlines npix strm inset&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>This class converts ais image files to screen bits</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>AIS to Bits</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">decode: str using: s </span><span style="font: 10pt serif">| i j k x cascadeRight cascadeDiag val error r msk masks<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">Change 8-bit grey from str filling s"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> masks&larr;↪(128 64 32 16 8 4 2 1).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> cascadeRight&larr;0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> cascadeDiag&larr;errorString◦1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> i&larr;msk&larr;j&larr;k&larr;1. x&larr;0-outpix.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> s◦1&larr;0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> for⦂ i to: pixelsPerLine do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[while⦂ x&lt;0 do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[val&larr;(str◦i)-black.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(error&larr;cascadeRight-val)≥0⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"print Black"</span><span style="font: 10pt serif"> s◦j&larr;masks◦msk+(s◦j). (error&gt;white)⇒[error&larr;white] ]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"print White"</span><span style="font: 10pt serif"> (error&larr;error+white)&lt;0⇒[error&larr;0] ].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">error&larr;error/2.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">val&larr;error/2.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">errorString◦k&larr;cascadeDiag+val.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">cascadeRight&larr;errorString◦(k+1)+error.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">cascadeDiag&larr;val.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(msk&larr;msk+1)&gt;8⇒[msk&larr;1. j&larr;j+1. s◦j&larr;0] ].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">x&larr;x+inpix. k&larr;k+1].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">x&larr;x-outpix].<br></span><span class="tab" val="79"></span><span style="font: bold 10pt serif">⇑s</span><span style="font: 10pt serif">]  primitive: 109</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">doFile </span><span style="font: 10pt serif">| str i s2 r y skipsum<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[str&larr;String new: pixelsPerLine.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">r&larr;0⌾0 rect: (pixelsPerLine*outpix/inpix)⌾1. r moveto: rect origin copy.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s2&larr;String new: 1+((pixelsPerLine*outpix)/(8*inpix)).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">vect&larr;Vector new: lines. strm reset; position&larr;2048+(inset y*npix). </span><span style="font: italic 10pt serif">"crop top"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i&larr;1. y&larr;0-outpix. skipsum&larr;0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ i≤lines do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[skipsum&larr;skipsum+inset x. </span><span style="font: italic 10pt serif">"inset left"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm skip: skipsum. skipsum&larr;0. </span><span style="font: italic 10pt serif">"do all tallied skips prior to next read"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm into: str endError: true.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">r bitsFromString: (self decode: str using: s2).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">skipsum&larr;skipsum+npix-(pixelsPerLine+inset x).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">r origin y&larr;r origin y+1. r corner y&larr;r corner y+1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(y&larr;y+inpix)≥0⇒ </span><span style="font: italic 10pt serif">"next line?"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[i&larr;i+1. y&larr;y-outpix.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ (y≥0 and⦂ i≤lines) do⦂ [i&larr;i+1. y&larr;y-outpix. skipsum&larr;skipsum+npix] ]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">skipsum&larr;skipsum-npix] ]. </span><span style="font: italic 10pt serif">"not next line"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm close]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">intoPress: p file: f </span><span style="font: 10pt serif">| outrect </span><span style="font: italic 10pt serif">"Creates an external file reference"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[outrect&larr;p transrect: rect.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">p setp: (outrect origin); dots⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[p setcoding: 8 </span><span style="font: italic 10pt serif">"byte samples"</span><span style="font: 10pt serif"> dots: npix lines: nlines;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">setmode: 3 </span><span style="font: italic 10pt serif">"to right and to bottom of page"</span><span style="font: 10pt serif">;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">setwindowwidth: pixelsPerLine height: lines<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">skipdots: (inset x) skiplines: (inset y);<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">setsizewidth: (outrect width) height: (outrect height);<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">dotsfromAIS: f] ]<br>"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">|p. p&larr;dp0 pressfile: &rsquo;pix.press&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">p pictureinit. (HalfToner new test) intoPress: p file: &rsquo;Rolfup.AIS&rsquo;. p close.<br>"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">setup | i r1 r2 inset done</span><span style="font: 10pt serif">"set up default paramsHalfToner new doFile."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user print: &rsquo;Black? (0-255)&rsquo;. black &larr; user read asVector◦1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> user print: &rsquo;White? (0-255)&rsquo;. white &larr; user read asVector◦1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> white &larr; white-black max: 255.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> [white&gt;255⇒[white &larr; 255]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> r1 &larr; 0⌾0 rect: pixelsPerLine⌾lines. <br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> user print: &rsquo;Position whole &rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> until⦂ user anybug do⦂ [r1 moveto: user mp. r1 comp. r1 comp].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> user waitnobug. r1 comp. "show whole"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> user print: &rsquo; Show cropping &rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> r2 &larr; Rectangle new fromuser intersect: r1. r1 comp.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> inset &larr; r2 origin - r1 origin. <br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> pixelsPerLine &larr; pixelsPerLine min: r2 width.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> lines &larr; lines min: r2 height.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> done &larr; false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ done do⦂<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> [user print: &rsquo; Position it &rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> rect &larr; Rectangle new fromuser.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> [rect width&gt;r2 width⇒["blowup" inpix &larr; 8. outpix &larr; (8*rect width/r2 width)]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"shrink" outpix &larr; 8. inpix &larr; (8*r2 width/rect width)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> rect extent &larr; r2 extent * outpix / inpix.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> rect comp. user print: &rsquo;ok? (redbug)&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> until⦂ user anybug do⦂ []. [user redbug⇒[done &larr; true]]. user waitnobug.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> rect comp].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> errorString &larr; String new: pixelsPerLine*outpix / inpix+1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> for⦂ i to: errorString length do⦂ [errorString◦i &larr; 0].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ⇑inset "return inset"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Init/Access</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">nlines </span><span style="font: 10pt serif">[</span><span style="font: bold 10pt serif">⇑nlines</span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">npix </span><span style="font: 10pt serif">[</span><span style="font: bold 10pt serif">⇑npix</span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">rect </span><span style="font: 10pt serif">[</span><span style="font: bold 10pt serif">⇑rect</span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">rect&larr;rect</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">setup: strm </span><span style="font: 10pt serif">| inrect croprect<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strm readonly.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(strm word: 2)≠1024 or⦂ (strm word: 9)≠8⇒[user notify: &rsquo;bad file&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nlines&larr;lines&larr;strm word: 4. npix&larr;pixelsPerLine&larr;strm nextword.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">black&larr;0. white&larr;255.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">inrect&larr;0⌾0 rect: pixelsPerLine⌾lines. inrect moveto: rect origin.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">inrect usermove; comp. </span><span style="font: italic 10pt serif">"show whole"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">croprect&larr;rect copy. croprect moveto: inrect origin copy. croprect maxstretch: inrect.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">croprect userstretch: inrect. inrect comp.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">inset&larr;croprect origin-inrect origin.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pixelsPerLine&larr;croprect width. lines&larr;pixelsPerLine*rect height/rect width.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[rect width&gt;pixelsPerLine⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"blowup"</span><span style="font: 10pt serif"> inpix&larr;32. outpix&larr;(32*rect width/pixelsPerLine)]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"shrink"</span><span style="font: 10pt serif"> outpix&larr;32. inpix&larr;(32*pixelsPerLine/rect width)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">errorString&larr;String new: pixelsPerLine*outpix/inpix+2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">errorString all&larr;0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">strm </span><span style="font: 10pt serif">[</span><span style="font: bold 10pt serif">⇑strm</span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">test </span><span style="font: 10pt serif">| files<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[files&larr;(dp0 filesMatching: &rsquo;*.ais.&rsquo;) sort.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">files empty⇒[user notify: &rsquo;no .ais files on disk&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm&larr;dp0 file: (files◦(Menu new stringFromVector: files) zbug). strm readonly.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rect&larr;Rectangle new usersize. self setup: strm; doFile]<br>"<br>HalfToner new test.<br>"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪HalfToner under: &rsquo;Graphical Objects&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"Turtle"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;Turtle&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;pen ink width dir x xf y yf frame&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>Turtles can crawl around the screen drawing and printing at any angle.<br>Dont forget to send them the message init before any drawing commands.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">erase<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[frame clear: white]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">frame </span><span style="font: 10pt serif">[⇑frame]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">frame: frame</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pen &larr; width &larr; 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">x&larr; y&larr; xf&larr; yf&larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">frame &larr; user screenrect.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self black; home]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Pen Control</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">black </span><span style="font: 10pt serif">[ink &larr; black]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">color: ignored  </span><span style="font: 10pt serif">"Only implemented for PressTurtle"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">ink: ink</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pen: pen</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pendn<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pen &larr; 1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">penup<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pen &larr; 0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">white </span><span style="font: 10pt serif">[ink &larr; white]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">width </span><span style="font: 10pt serif">[⇑width]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">width: width</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">xor </span><span style="font: 10pt serif">[ink &larr; 2]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Drawing</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fillIn⦂ expr </span><span style="font: 10pt serif">[⇑expr eval]  "Only implemented for PressTurtle"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">go: length </span><span style="font: 10pt serif">[user croak] primitive: 53</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">goto: pt<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pt x is: Integer⇒[user croak]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self goto: pt x asInteger⌾pt y asInteger] primitive: 54</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">home</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self up; place: frame center-frame origin. xf&larr; yf&larr; 0100000]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">place </span><span style="font: 10pt serif">[⇑x⌾y]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">place: pt </span><span style="font: 10pt serif">| p</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[p&larr; pen. pen&larr; 0. self goto: pt. pen&larr; p]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pointAt: pt </span><span style="font: 10pt serif">| diff "change direction so turtle points at pt."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[diff &larr; (pt - (self place)).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> dir &larr; ((diff theta) asInteger)]<br><br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">stretchto: pt </span><span style="font: 10pt serif">| t old<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t &larr; Turtle init frame: frame. old &larr; x⌾y. <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">t xor; place: old; goto: pt; place: old; goto: pt]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">turn: angle<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[dir&larr; dir+angle\360]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">up</span><span class="tab" val="79"></span><span style="font: bold 10pt serif"> </span><span style="font: 10pt serif">[dir &larr; 270]</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Point toward top of screen"</span><span style="font: bold 10pt serif"><br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Text</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">put: char font: font</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"char=ascii Integer, font=font bits (String)"</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user croak] primitive: 56</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">show: str font: font </span><span style="font: 10pt serif">| a f</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"str=text (String), font=font number (0-9)"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[f&larr; DefaultTextStyle fonts◦(font+1).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ a from: str do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self put: a font: f]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Examples</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dragon: n<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[n=0⇒[self go: 10]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">n&gt;0⇒[self dragon: n-1; turn: 90; dragon: 1-n]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self dragon: ¬1-n; turn: ¬90; dragon: 1+n]<br>"<br>Turtle init dragon: 8<br>"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">filberts: order side: s </span><span style="font: 10pt serif">| i n2<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[n2&larr; 1 lshift: order-1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self penup; go: 0-n2*s; pendn.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: 4 do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self color: i-1*40.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self fillIn⦂ [self hilbert: order side: s; go: s; hilbert: order side: s; go: s].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self black; hilbert: order side: s; go: s; hilbert: order side: s; go: s.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self penup; go: n2-1*s; turn: ¬90; go: n2*s; turn: 180; pendn]]<br>"<br>Turtle init erase filberts: 3 side: 10.<br><br>user displayoffwhile⦂<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[PressTurtle new init: &rsquo;try.press&rsquo;; filberts: 4 side: 10; close].<br>"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hilbert: n side: s </span><span style="font: 10pt serif">| a m<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[n=0⇒[self turn: 180]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[n&gt;0⇒[a&larr;90. m&larr;n-1] a&larr;¬90. m&larr;n+1].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self turn: a; hilbert: 0-m side: s; turn: a.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self go: s; hilbert: m side: s;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">turn: 0-a; go: s; turn: 0-a;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">hilbert: m side: s; go: s.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self turn: a; hilbert: 0-m side: s; turn: a]<br>"<br>Turtle init hilbert: 3 side: 4<br>"<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hilberts: n </span><span style="font: 10pt serif">| i s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self penup; go: 128; pendn.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: n do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s&larr; 256 lshift: 0-i.  self color: n-i*40; width: n-i+1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self penup; go: 0-s/2; turn: ¬90; go: s/2; turn: 90; pendn.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self hilbert: i side: s; go: s; hilbert: i side: s; go: s]]<br>"<br>Turtle init erase hilberts: 5.<br><br>user displayoffwhile⦂<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[PressTurtle new init: &rsquo;try2.press&rsquo;; hilberts: 4; close].<br>"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">mandala: npoints diameter: d </span><span style="font: 10pt serif">| l points i j<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[l&larr; (3.14*d/npoints) asInteger.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self home; penup; turn: ¬90; go: d/2; turn: 90; go: 0-l/2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">points&larr; Vector new: npoints.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: npoints do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[points◦i&larr; self place.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self go: l; turn: 360/npoints].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self pendn.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: npoints/2 to: 1 by: ¬1 do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self color: (npoints/2)-i*20\250.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ j to: npoints do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self place: points◦j; goto: points◦(j+i-1\npoints+1)]]]<br>"<br>Turtle init mandala: 30 diameter: 400<br><br>user displayoffwhile⦂<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[PressTurtle new init: &rsquo;try.press&rsquo;; mandala: 30 diameter: 500; close.]<br>"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">spiral: n angle: a </span><span style="font: 10pt serif">| i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ i to: n do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self color: i*2\256; go: i; turn: a]]<br>"<br> Turtle init spiral: 200 angle: 89; home; spiral: 200 angle: ¬89.<br><br> user displayoffwhile⦂ [(PressTurtle new init: &rsquo;try.press&rsquo;)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">spiral: 403 angle: 89;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">home; spiral: 403 angle: ¬89; close.]<br> "</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪Turtle under: &rsquo;Graphical Objects&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"PressTurtle"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;PressTurtle&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Turtle<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;file fplace fdir filling&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I work with Pressfile to print high resolution pictures.<br>All inputs can be floating point for high resolution.<br>Complexity is limited to about 2k lines until multiple entity lists</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">close </span><span style="font: 10pt serif">[file page. file close]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init: name <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[file &larr; (dp0 pressfile: name).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">filling&larr; false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">file pictureinit. self black.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">super init]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">initwithfile: name <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[file &larr; name.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">filling&larr; false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self black.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">super init]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Pen Control</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">black <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[file brightness: 0. super black]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">blue </span><span style="font: 10pt serif">[self color: 160]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">color: h </span><span style="font: 10pt serif">[file hue: h; brightness: 255; saturation: 255]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">cyan </span><span style="font: 10pt serif">[self color: 120]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">green </span><span style="font: 10pt serif">[self color: 80]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">magenta </span><span style="font: 10pt serif">[self color: 200]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">place </span><span style="font: 10pt serif">[⇑fplace]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">red </span><span style="font: 10pt serif">[self color: 0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">up </span><span style="font: 10pt serif">[dir&larr; 270. fdir&larr; 270.0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">white <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[file brightness: 255.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">file saturation: 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">super white]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">yellow </span><span style="font: 10pt serif">[self color: 40]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Drawing</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fillIn⦂ expr</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Code in expr must describe a closed figure"</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[filling&larr; true.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">file object⦂ expr eval atScreen: fplace.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">filling&larr; false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">go: dist </span><span style="font: 10pt serif">| old</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self goto: fplace + <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(([fdir\90.0=0.0⇒</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"optimize horiz and vert lines"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[fdir/90.0=0⇒[1.0⌾0.0];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=1⇒[0.0⌾1.0];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=2⇒[¬1.0⌾0.0];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=3⇒[0.0⌾¬1.0]]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">fdir asRadians asDirection])*dist)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">goto: p </span><span style="font: 10pt serif">| old</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[old&larr; fplace.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fplace &larr; p x asFloat ⌾ p y asFloat.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">super goto: fplace x round ⌾ fplace y round.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">filling⇒[file objectGotoScreen: fplace pen: pen]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pen=1⇒[file drawlinefromscreen: old to: fplace width: 0.46875*width]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">turn: angle </span><span style="font: 10pt serif">[fdir&larr; fdir+angle\360.0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪PressTurtle under: &rsquo;Graphical Objects&rsquo;.</span></div>
    <div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">&rsquo;From Smalltalk 5.5k XM November 24 on 22 November 1980 at 2:57:08 am.&rsquo;<br></span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">"Dispframe"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;Dispframe&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Stream<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;text&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;prompt doit &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I am a dialog window</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit </span><span style="font: 10pt serif">[prompt &larr; &rsquo;&#64257;&rsquo;◦1. doit &larr; &rsquo;&rsquo;◦1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">frame &larr; r<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[text para: nil frame: r]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[text &larr; Textframe new.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self of: (String new: 16)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">rect: r<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self init; frame &larr; r; clear]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Scheduler</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">eachtime </span><span style="font: 10pt serif">| t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[text window has: user mp⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user kbck⇒[t&larr; self kbd⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ [t≡nil⇒[] self space; print: nilⓢ t].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self prompt]]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> user bluebug⇒ [⇑false]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user anybug⇒[⇑false]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">firsttime<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[text window has: user mp⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self outline; prompt]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">lasttime<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ [self last=prompt⇒[self skip: ¬2; show]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑user bluebug≡false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">leave</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Dialog</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">ev </span><span style="font: 10pt serif">| t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[while⦂ [self cr. t &larr; self request: &rsquo;&rsquo;] do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self space; print: nil ⓢt]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">kbd </span><span style="font: 10pt serif">| n t</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"false if user pauses, nil if ctrl-d, all input since prompt if "</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[while⦂ user kbck do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t &larr; user kbd.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">t=132⇒ [self append: &rsquo;done.&rsquo;; show. ⇑nil]; </span><span style="font: italic 10pt serif">"ctl-d for done"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=8⇒ [self last=prompt⇒[] self skip: ¬1]; </span><span style="font: italic 10pt serif">"backspace"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=30⇒ [n &larr; array◦(position to: 1 by:¬1) find: prompt.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">n=0⇒[self append: &rsquo;lost beginning&rsquo;; prompt]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">t&larr; self last: n-1. self next&larr; doit; show. ⇑t];</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> </span><span style="font: italic 10pt serif">"do-it (LF)"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=145⇒ [self last=prompt⇒[] self skip: ¬1.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"ctl-w for backspace word"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ (position&gt;0 and: self last tokenish) do⦂ [self skip: ¬1]];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=151⇒[self reset; prompt] </span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"ctl-x clears frame"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self next &larr; t]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self show. ⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">prompt </span><span style="font: 10pt serif">[self cr; next&larr; prompt; show]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">read </span><span style="font: 10pt serif">| t</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"false if ctrl-d, all input since prompt if "</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self next&larr; prompt; show.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ [user kbck⇒[t&larr; self kbd] false] do⦂ []<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">t≡nil⇒[⇑false] ⇑t]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">request: s</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"false if ctrl-d, all input since prompt if "</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self append: s. ⇑self read]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Image</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">clear<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self reset. self show]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">moveto: pt<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(text window inset: ¬2⌾¬2) dragto: pt-(¬2⌾¬2)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">outline<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[text window outline: 2]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">show </span><span style="font: 10pt serif">| t [</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">text show: self contents.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ text lastshown≥ position do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">position &lt; (t &larr; text scrolln: 1)⇒ []<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">t &larr; array copy: t+1 to: position.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">text show: t.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">position &larr; 0.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self append: t.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"self dequeue: (text scrolln: 1).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">text show: self contents"]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Access to Parts</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">frame<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑text frame]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">text<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑text]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪Dispframe under: &rsquo;Text Objects&rsquo;.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">Dispframe classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"Paragraph"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;Paragraph&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Array<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;text runs alignment&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>Paragraphs implement pretty text.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">text is a String of the ascii characters.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">alignment specifies how the paragraph should be justified.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">runs is a String of run-coded format information.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">odd byte is run length (≤255)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">following byte is 16*format number +<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">1*bold 2*italic 4*underline 8*strikeout<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">longer runs are made from several of length 255.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization of parts</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">copy </span><span style="font: 10pt serif">[⇑self class new text: text runs: runs alignment: alignment]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">text: text<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[alignment &larr; 0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">text: text alignment: alignment</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">text: text runs: runs alignment: alignment</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Normal access</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">◦x </span><span style="font: 10pt serif">[⇑text◦x]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asParagraph </span><span style="font: 10pt serif">[⇑self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asStream </span><span style="font: 10pt serif">[⇑text asStream]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asVector </span><span style="font: 10pt serif">[⇑text asVector]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">copy: a to: b</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">Return a copied subrange of this paragraph</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self class new<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">text: (text copy: a to: b)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">runs: (self run: a to: b)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">alignment: alignment]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">findString: str startingAt: start<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑text findString: str startingAt: start]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">length </span><span style="font: 10pt serif">[⇑text length]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">replace: a to: b by: c   </span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"alters self - doesnt copy"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[runs≡nil and⦂ (c isnt: self class)⇒[]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">runs &larr; self runcat: (self run: 1 to: a-1)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">and: [c is: self class⇒ [c runs]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self makerun: c length val: [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">runs empty⇒[0]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">runs◦((self runfind: b)◦1+1)]]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">and: (self run: b+1 to: text length)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">text &larr; text replace: a to: b by: [c is: self class⇒[c text] c]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">subst: x for: y </span><span style="font: italic 10pt serif">"runs are not supported yet here"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑text subst: x for: y]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">text </span><span style="font: 10pt serif">[⇑text]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">textStyle </span><span style="font: 10pt serif">[⇑DefaultTextStyle]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Text alignment</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">alignment </span><span style="font: 10pt serif">[⇑alignment]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">alignment &larr; alignment</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">center </span><span style="font: 10pt serif">[alignment &larr; 2]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">flushleft </span><span style="font: 10pt serif">[alignment &larr; 0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">flushright </span><span style="font: 10pt serif">[alignment &larr; 4]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">justify </span><span style="font: 10pt serif">[alignment &larr; 1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Manipulation of format runs</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">allBold </span><span style="font: 10pt serif">[self maskrunsunder: 1 to: 1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">allFont: n </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[n is: String⇒ [n &larr; (self textStyle fontnames find: n) - 1]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self maskrunsunder: 0360 to: n*16]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">allItalic </span><span style="font: 10pt serif">[self maskrunsunder: 2 to: 2]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">makeBoldPattern </span><span style="font: 10pt serif">| s i c<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s &larr; text asStream.  i&larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ [c&larr; s next⇒</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">" scan to bracket, bar or comment "</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[c=91⇒[true]; =124⇒[true]; =34⇒[true]; =25⇒[true] false]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">true]</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"end"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">do⦂ [i&larr; i+1].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self maskrun: 1 to: i under: 1 to: 1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">makerun: len val: val</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Make up a solid run of value val"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| str i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[len=0⇒[⇑nullString]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">str &larr; String new: len-1/255+1*2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: 1 to: str length by: 2 do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">str◦i &larr; [len&gt;255⇒[255] len].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">str◦(i+1) &larr; val.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">len &larr; len-255].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑str]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">maskrun: i to: j under: m to: val </span><span style="font: italic 10pt serif">"Alter my runs so that the bits selected by m become val."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| r k</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Maybe merge this with mergestyle"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[r &larr; self run: i to: j.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ k from: 2 to: r length by: 2 do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[r◦k &larr; (r◦k land: 0377-m) + val].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">runs &larr; self runcat: (self run: 1 to: i-1) and: r and: (self run: j+1 to: text length)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">maskrunsunder: m to: val<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self maskrun: 1 to: text length under: m to: val]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">run: a to: b </span><span style="font: 10pt serif">| c</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"subrange of run"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[a&gt;b⇒[⇑nullString]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">runs≡nil⇒[⇑self makerun: 1+b-a val: 0]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">a &larr; self runfind: a.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">b &larr; self runfind: b.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">c &larr; runs copy: a◦1 to: b◦1+1.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"copy the sub-run"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(a◦1)=(b◦1)⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[c◦1 &larr; 1+ (b◦2)-(a◦2)]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">c◦1 &larr; 1+(runs◦(a◦1))- (a◦2).</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"trim the end lengths"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">c◦(c length-1) &larr; b◦2].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑c]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">runcat: r1 and: r2 and: r3 </span><span style="font: 10pt serif">| i r olen len oc c nr [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">concatenate and compact 3 runs</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nr &larr; Stream new of: (String new: 30).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">oc &larr; false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: 3 do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">r &larr; [i=1⇒ [r1]; =2⇒ [r2] r3].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">r length=0⇒ []<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">r &larr; r asStream.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ (len &larr; r next) do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">c &larr; r next.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">len = 0⇒ ["</span><span style="font: italic 10pt serif">ignore empty runs (shouldn&rsquo;t be any)</span><span style="font: 10pt serif">"]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">oc = c⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(olen &larr; olen+len) ≤ 255⇒ []<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nr next &larr; 255; next &larr; oc.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">olen &larr; olen-255]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[oc⇒ [nr next &larr; olen; next &larr; oc] "</span><span style="font: italic 10pt serif">first time thru</span><span style="font: 10pt serif">"].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">olen &larr; len. oc &larr; c]].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[oc⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">leftovers</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nr next &larr; olen; next &larr; oc]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑nr contents]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">runcat: x to: y </span><span style="font: 10pt serif">[⇑self runcat: x and: y and: &rsquo;&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">runfind: index </span><span style="font: 10pt serif">| run</span><span class="tab" val="79"></span><span style="font: 10pt serif">t</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"index into run"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[run&larr;1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ (t &larr; index - (runs◦run)) &gt; 0 do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[index &larr; t. run &larr; run+2].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑run,index]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">runs</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"return runs or default if none"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[runs≡nil⇒[⇑self makerun: text length val: 0]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑runs]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Bravo conversions</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">applyBravo: s at: i to: j</span><span class="tab" val="79"></span><span style="font: 10pt serif">| v ch t bslash cr [<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Alter runs of characters i through j according to trailer.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">see Ibis&lt;Bravo&gt;Trailer.Memo for further info.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">some functions may not be implemented, thus parsed and ignored</span><span style="font: 10pt serif">.<br><br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">paragraph looks.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">implemented: justification (j), centering (c).<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">ignored: left margin (l), first line left margin (d), right margin (z),<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">line leading (x), paragraph leading (e), vertical tab (y), keep (k), profile (q),<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">tab tables ( () )</span><span style="font: 10pt serif">"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s &larr; s asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">cr &larr; 015.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bslash &larr; &rsquo;\&rsquo;◦1.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ (ch &larr; s next) = bslash do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">ch ≡ false or⦂ ch = cr⇒ ["</span><span style="font: italic 10pt serif">no more</span><span style="font: 10pt serif">" ⇑self]<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(t &larr; &rsquo;jcq&rsquo; find: ch) &gt; 0⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">t=1⇒ [self justify]; =2⇒ [self center]]<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(t &larr; &rsquo;(ldzxeyk&rsquo; find: ch) &gt; 0⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">t=1⇒ [s skipTo: &rsquo;)&rsquo;◦1]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s integerScan]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">character looks.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">implemented: font (f), bold (bB), italic (iI), underline (uU).<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">ignored: graphic (g), visible (v), overstrike (s), superscript (o), tabcolor (t)"<br></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ ((ch &larr; s next) and⦂ ch ≠ cr) do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">run length</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ch ≥ 060 and⦂ ch ≤ 071 "isdigit"⇒ [s skip: ¬1] ch = 040]⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; i + s integerScan]<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(t &larr; &rsquo;bBiIuU&rsquo; find: ch) &gt; 0⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self maskrun: i to: j under: ↪(1 1 2 2 4 4)◦t to: ↪(1 0 2 0 4 0)◦t]<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(t &larr; &rsquo;fot&rsquo; find: ch) &gt; 0⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">new value follows</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">v &larr; s integerScan.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">t=1⇒ [self maskrun: i to: j under: 0360 to: (v lshift: 4)]]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">bravoRuns: s </span><span style="font: italic 10pt serif">"Encode the runs in a Bravo paragraph trailer onto a Stream"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| i old len dif new bit bits<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["assume Ctrl-Z is already there"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s append: [alignment=1⇒[&rsquo;j\g&rsquo;]; =2⇒[&rsquo;c\g&rsquo;] &rsquo;\g&rsquo;].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[runs≡nil ⇒ []<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">len &larr; 0. old &larr; 0400.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bits &larr; ↪(1 2 4).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: 1 to: runs length by: 2 do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[dif &larr; old lxor: (new &larr; runs◦(i+1)).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(dif land: 0367)=0 ⇒ </span><span style="font: italic 10pt serif">"No changes"</span><span style="font: 10pt serif"> [len &larr; len+(runs◦i)]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[i=1⇒[] len printon: s].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ bit to: 3 do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(dif land: bits◦bit)=0 ⇒ []<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s next &larr; ([(new land: bits◦bit)≠0 ⇒ [&rsquo;biu&rsquo;] &rsquo;BIU&rsquo;])◦bit].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(dif land: 0360)≠0 ⇒ </span><span style="font: italic 10pt serif">"Font change"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s append: &rsquo;f&rsquo;; print: (new lshift: ¬4); space]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">old &larr; new.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">len &larr; runs◦i.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s cr]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fromBravo </span><span style="font: italic 10pt serif">"Find Bravo trailers and return a copy of self with them applied"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| newpara newtext loc i j<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[newpara &larr; self copy.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">loc &larr; 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ (i &larr; (newtext &larr; newpara text) find: 032)≠0 do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[j &larr; newtext◦(i+1 to: newtext length) find: 015.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">newpara applyBravo: newtext◦(i+1 to: i+j) at: loc to: i-1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">newpara replace: i to: [i+j=newtext length⇒[i+j] i+j-1] by: &rsquo;&rsquo;.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">loc &larr; i+1]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑newpara]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">toBravo </span><span style="font: 10pt serif">| s [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s &larr; (String new: text length*2) asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s append: text; next &larr; 032.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self bravoRuns: s.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑s contents asParagraph]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Press printing</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fromPress: press value: s </span><span style="font: 10pt serif">| len x [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s next=0⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">text is in DL</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">len &larr; s nextword.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">amount to skip from where we are now to end of text</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">x &larr; [s limit &gt; 255⇒ ["</span><span style="font: italic 10pt serif">control info came from DL</span><span style="font: 10pt serif">" s limit] "</span><span style="font: italic 10pt serif">from EL</span><span style="font: 10pt serif">" 0].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">press data skip: 0-x-len.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">text &larr;  press data next: len.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">press data skip: x]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">text &larr; s nextString].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">runs &larr; s nextString.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">alignment &larr; s next.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">runs empty⇒ [runs &larr; nil]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hideData: complete </span><span style="font: 10pt serif">| s [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s &larr; Stream new of: (String new: 150).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s next &larr; complete.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[complete=0⇒ [s nextword &larr; text length] s nextString &larr; text].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s nextString&larr; [runs≡nil⇒ [nullString] runs];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">next&larr; alignment.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑s contents]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hidePress: press complete: c </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">not called by Form-Path-Image, but probably by Class printout</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">press skipcode: self pressCode data: (self hideData: c)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pressCode </span><span style="font: 10pt serif">[⇑99]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">presson: press in: r </span><span style="font: 10pt serif">[⇑self presson: press in: r style: self textStyle]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">presson: press in: r style: style </span><span style="font: 10pt serif">| char pos s3 y chop [<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Output paragraph inside rectangle (page coordinates)"</span><span style="font: 10pt serif"><br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"probably ParagraphScanner should handle this"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">text length &gt; 0 and⦂ text◦1 = 014⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"formfeed --&gt; page break"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self copy: 2 to: text length]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">y &larr; r corner y.</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"We change corner y later"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s3 &larr; ParagraphScanner new of: self to: press style: style.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s3 init in: r.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pos &larr; s3 position.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">chop &larr; [alignment=1⇒ [0] alignment].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ (y and⦂ (char &larr; s3 scan)) do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">char = 011 ⇒ [s3 tab]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">char = 040 or⦂ char = 015 ⇒</span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"carriage return or exceeded max width and backed up to blank"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">y &larr; s3 printfrom: pos aligned: [char=040⇒[alignment] chop] skip: 1⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[r corner y &larr; y. s3 init in: r. pos &larr; s3 position]]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">char ≡ true ⇒[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"exceeded max width with no blanks in line"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s3 backup.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">y &larr; s3 printfrom: pos aligned: 0 skip: 0⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[r corner y &larr; y. s3 init in: r. pos &larr; s3 position]]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"user notify: &rsquo;unimplemented control char&rsquo;"</span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Put out trailing text if any"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">y and⦂ ((pos=s3 position) or⦂ (y &larr; s3 printfrom: pos aligned: chop skip: 0))⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">press append: text.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑y]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">press append: text◦(1 to: pos).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self copy: pos + 1 to: text length]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Filing</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">readFrom: file </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">text &larr; file nextString.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">runs &larr; file nextString.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">alignment &larr; file next.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">runs empty⇒ [runs &larr; nil]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">storeOn: file </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">file nextString &larr; text.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[runs≡nil⇒ [file next &larr; 0] file nextString &larr; runs].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">file next &larr; alignment]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪Paragraph under: &rsquo;Text Objects&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"Reader"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;Reader&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;source collector token nextchar typetbl &rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;typetable &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>Converts a string to tokens.  The collector defines what to do for each kind of token: see TokenCollector and Compressor for examples.  (P. Deutsch)</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit </span><span style="font: 10pt serif">| strm type first last i </span><span style="font: italic 10pt serif">"Initialize the type and mask tables"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[typetable&larr; String new: 256.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm&larr; Stream new of: ↪(<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">5 0 0377  </span><span style="font: italic 10pt serif">"(initialize)"</span><span style="font: 10pt serif"><br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">1 0101 0132  1 0141 0172  </span><span style="font: italic 10pt serif">"upper and lower case letters"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">2 060 071  </span><span style="font: italic 10pt serif">"digits"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">3 072 072  3 03 03  </span><span style="font: italic 10pt serif">"colon, open colon"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">4 011 012  4 014 015  4 040 040  </span><span style="font: italic 10pt serif">"TAB, LF, FF, CR, blank"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"5 is one-char tokens"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">6 042 042  6 031 031  </span><span style="font: italic 10pt serif">"comment quote and ➲"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">7 047 047  </span><span style="font: italic 10pt serif">"string quote"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">8 025 025  </span><span style="font: italic 10pt serif">"high-minus"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">9 032 032  </span><span style="font: italic 10pt serif">"&uarr;Z (format trailer)"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">10 036 036  </span><span style="font: italic 10pt serif">"DOIT"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">11 050 051  </span><span style="font: italic 10pt serif">"open and close paren"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ (type&larr; strm next) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[first&larr; strm next. last&larr; strm next.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: (first+1 to: last+1) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[typetable◦i&larr; type]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">of: s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[typetbl&larr; typetable.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">token&larr; Stream default.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">source&larr; s asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self step]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Main reader</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">read<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self readInto: TokenCollector default]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">readatom: ncolons </span><span style="font: 10pt serif">| type s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[token reset.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ [token next&larr; nextchar.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(nextchar&larr; source next)⇒[(type&larr; typetbl◦(nextchar+1))≤3]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[type=3⇒[ncolons&larr; ncolons+1]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s&larr; token contents.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ncolons=0⇒[collector identifier: s];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&gt;1⇒[collector otheratom: s].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s length=1⇒[collector otheratom: s] </span><span style="font: italic 10pt serif">": or ⦂ alone"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s◦s length=072⇒[collector keyword: s];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=03⇒[collector keyword: s].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">collector otheratom: s. </span><span style="font: italic 10pt serif">"Colon wasn&rsquo;t last character"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">readInto: collector </span><span style="font: 10pt serif">| x <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[while⦂  nextchar  do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[x&larr; typetbl◦(nextchar+1).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"See classInit for the meanings of the type codes"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">x=4⇒ [collector separator: nextchar. nextchar&larr; source next];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=1⇒ [self readatom: 0];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=5⇒ [collector onechar: nextchar. nextchar&larr; source next];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=6⇒ [self upto: nextchar⇒[collector notify: &rsquo;Unmatched comment quote&rsquo;]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">collector comment: token contents];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=2⇒ [self readnum];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=11⇒ [[nextchar=050⇒[collector leftparen] collector rightparen].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextchar&larr; source next];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=7⇒ [self upto: nextchar⇒[collector notify: &rsquo;Unmatched string quote&rsquo;]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">collector string: token contents];</span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=8⇒ [self readnum];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=9⇒ [self upto: 015⇒[collector notify: &rsquo;&uarr;Z without CR&rsquo;]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">collector trailer: token contents];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=10⇒ [⇑collector contents];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=3⇒ [self readatom: 1]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑collector contents]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">readnum </span><span style="font: 10pt serif">| val d e<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[val&larr; self rdint: 025.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextchar=056⇒</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"check for decimal point"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self step.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextchar≡false or⦂ nextchar isdigit≡false⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[collector integer: val.  collector onechar: 056]</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"was &lt;Integer&gt; .  "</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">d&larr; self rdint: ¬1.</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"fraction part"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[nextchar=0145⇒</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"check for e&lt;exponent&gt; "</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self step.  e&larr; self rdint: 025]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">e&larr; &rsquo;&rsquo;].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">collector float: val fraction: d exp: e]<br> </span><span class="tab" val="79"></span><span style="font: 10pt serif">collector integer: val]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Internal readers</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">rdint: char </span><span style="font: italic 10pt serif">"Read an integer, allow char as first char"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[token reset.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[nextchar=char⇒[token next&larr; char. self step]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ nextchar do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[nextchar&lt;060⇒[⇑token contents]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextchar&gt;071⇒[⇑token contents]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">token next&larr; nextchar. nextchar&larr; source next].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑token contents]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">step<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[nextchar&larr; source next]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">upto: char </span><span style="font: 10pt serif">| start </span><span style="font: italic 10pt serif">"Knows about doubled &rsquo; in strings"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[start&larr; source position.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">token reset.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ (nextchar&larr; source next) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[nextchar=char⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self step. char≠047⇒[⇑false] nextchar≠047⇒[⇑false]]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">token next&larr; nextchar].<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Ran off end, back up."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">source skip: start - 1 - source position.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑true]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪Reader under: &rsquo;Text Objects&rsquo;.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">Reader classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"RemoteParagraph"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;RemoteParagraph&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;file hipos lowpos&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>These instances refer to text stored on a file, typically residing on a remote<br>machine and accessed via the ether.  The representation has been chosen for<br>compactness, and the bias of ¬1000 keeps the two parts of the position in the<br>range of small integers (¬1024 to 1022) to reduce allocation and paging of objects.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>As yet unclassified</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asParagraph </span><span style="font: 10pt serif">[</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">file position &larr; self position.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑Paragraph new readFrom: file]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asString </span><span style="font: 10pt serif">[⇑self asParagraph text]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fromParagraph: p </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">write me (only once!) on file</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self position &larr; file position.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">p storeOn: file]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fromString: s </span><span style="font: 10pt serif">[self fromParagraph: s asParagraph]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">on: file</span><span class="tab" val="79"></span><span style="font: 10pt serif">"Refer me to a specific file"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">position </span><span style="font: 10pt serif">[⇑(hipos+1000)*2000 + (lowpos+1000)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">position&larr; p<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[p &larr; p intdiv: 2000.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">hipos&larr; (p◦1) asInteger -1000.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">lowpos&larr; (p◦2) asInteger -1000]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪RemoteParagraph under: &rsquo;Text Objects&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"Textframe"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;Textframe&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;frame para style reply1 reply2 window&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I display a paragraph on the screen in a frame clipped by a window</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">para: para frame: frame<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[window&larr;frame.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">reply1&larr;reply2&larr;0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">style&larr;DefaultTextStyle]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">para: para frame: frame style: style<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[window&larr;frame.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">reply1&larr;reply2&larr;0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">style: style</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Scheduling</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">aboutToFrame<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"My frame is about to change.  I dont care."</span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">takeCursor<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Move the cursor to the center of my window."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user cursorloc &larr; window center]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Image</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asForm: pt </span><span style="font: 10pt serif">| char ul ur f<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"put bits of character into a form -- when Form package in system"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[char &larr; self charofpt: pt. ul &larr; reply1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self ptofchar: char + 1. ur &larr; reply1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f &larr; Form new size: ur x - ul x by: reply2 y - reply1 y.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f translate: ul; scale: 1. ⇑f ]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">comp<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[window comp]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">copyto: path effect: effect </span><span style="font: 10pt serif">| i oldmode</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"show clipped inside rect"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[  <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">path is: Point ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[oldmode &larr; style mode. style mode: effect. window translateto: path. self show. style mode: oldmode.]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">path is: Path ⇒ [for⦂ i to: path length do⦂ [ self copyto: path◦i effect: effect] ]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">corner </span><span style="font: 10pt serif">[⇑frame corner]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">displayat: path effect: effect clippedBy: cliprect</span><span style="font: 10pt serif">| i oldmode </span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"show clipped inside rect"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[  <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">path is: Point ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[oldmode &larr; style mode. style mode: effect. frame translateto: path. window &larr; cliprect. self show. style mode: oldmode.  ]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">path is: Path ⇒ [for⦂ i to: path length do⦂ [ self displayat: path◦i effect: effect] ]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">erase<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(window inset: (¬2⌾¬2)) clear]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">extent </span><span style="font: 10pt serif">[⇑frame extent]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">frame </span><span style="font: 10pt serif">[⇑frame]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">frame &larr; frame<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Change my frame and window."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">window &larr; frame.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">height </span><span style="font: 10pt serif">[⇑frame height]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">origin </span><span style="font: 10pt serif">[⇑frame origin]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">outline<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[window border: 2 color: black]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">para </span><span style="font: 10pt serif">[⇑para]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">showin: rect </span><span style="font: 10pt serif">| old</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"show clipped inside rect"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[old &larr; window. window &larr; rect. self show. window &larr; old]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">size </span><span style="font: 10pt serif">[⇑frame extent]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">style </span><span style="font: 10pt serif">[⇑style]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">width </span><span style="font: 10pt serif">[⇑frame width]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">window </span><span style="font: 10pt serif">[⇑window]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Text</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">charnearpt: pt </span><span style="font: 10pt serif">[user croak] primitive: 58</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">charofpt: pt </span><span style="font: 10pt serif">[user croak] primitive: 58</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dopressjst: pt<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"For building justified lines in Press Format files<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">[reply1 x &larr; trailingbits.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">reply1 y &larr; internalspaces.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">reply2 y &larr; heightofline.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">[reply2 x &lt; 0 ⇒[linenotjustified]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">⇑lastcharinline]<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">user will have to back up in string to find last printing character<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">(at least non-space, cr, or tab)"</span><span style="font: 10pt serif"><br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user croak] primitive: 64</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">findmaxx: char<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[char is: Integer⇒[user croak]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self findmaxx: char asInteger] primitive: 63</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">lastshown<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑reply1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">lineheight<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑style lineheight]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">maxx: char<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self findmaxx: char. ⇑ reply1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">measuretext: startx to: stopx string: string from: first to: last font: font<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["Returns character index of character immediately following character<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">causing exception condition.<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">Reply1</span><span class="tab" val="79"></span><span style="font: 10pt serif">=</span><span class="tab" val="79"></span><span style="font: 10pt serif">Exception code.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=</span><span class="tab" val="79"></span><span style="font: 10pt serif">1</span><span class="tab" val="79"></span><span style="font: 10pt serif">Encountered space, cr, tab, or ascii 0.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=</span><span class="tab" val="79"></span><span style="font: 10pt serif">2</span><span class="tab" val="79"></span><span style="font: 10pt serif">Crossed stopx.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=</span><span class="tab" val="79"></span><span style="font: 10pt serif">3</span><span class="tab" val="79"></span><span style="font: 10pt serif">Both 1 and 2.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=</span><span class="tab" val="79"></span><span style="font: 10pt serif">4</span><span class="tab" val="79"></span><span style="font: 10pt serif">Encountered last before hitting stopx or special character.<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">Reply2</span><span class="tab" val="79"></span><span style="font: 10pt serif">=</span><span class="tab" val="79"></span><span style="font: 10pt serif">Leftx of character causing exception condition."<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user croak] primitive: 103</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">ptofchar: char<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self selectchar: char. ⇑reply1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">ptofpt: pt<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self charnearpt: pt. ⇑reply1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">put: para at: pt<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self put: para at: pt centered: false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">put: para at: pt centered: center<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[para &larr; para asParagraph.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">window &larr; frame &larr; pt rect: 1000⌾1000.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self ptofchar: para length+1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">window growto: reply2 + (4⌾0).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[center⇒ [window moveby: pt-window center]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">window &larr; window inset: ¬3⌾¬2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">window clear: white. self show]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">put: para at: pt maxextent: maxextent<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[para &larr; para asParagraph.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">window &larr; frame &larr; Rectangle new origin: pt extent: maxextent.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self findmaxx: para length+1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">window growto: reply2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">window &larr; window inset: ¬3⌾¬2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">window clear: white. self show]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">put: para centered: pt<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self put: para at: pt centered: true]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">rectofchar: char<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self selectchar: char. ⇑reply1 rect: reply2]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">scrolln: n<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self charofpt: frame corner x ⌾ (frame origin y+(n*style lineheight))]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">selectchar: char<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[char is: Integer⇒[user croak]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self selectchar: char asInteger] primitive: 59</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">show </span><span style="font: 10pt serif">[user croak] primitive: 57</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">show: para<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[para &larr; para asParagraph. self show]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">showline: first to: last lastx: lastx spaces: spaces trailingspaces: trailingspaces startrun: startrun firstrunlength: firstrunlength<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["For use in conjunction with </span><span style="font: bold 10pt serif">measuretext</span><span style="font: 10pt serif"> primitive.<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">Characters </span><span style="font: bold 10pt serif">first</span><span style="font: 10pt serif"> through </span><span style="font: bold 10pt serif">last</span><span style="font: 10pt serif"> will be displayed, clipped by the </span><span style="font: bold 10pt serif">frame</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">and </span><span style="font: bold 10pt serif">window</span><span style="font: 10pt serif">.  The </span><span style="font: bold 10pt serif">lastx</span><span style="font: 10pt serif"> should be the lastx of </span><span style="font: bold 10pt serif">last</span><span style="font: 10pt serif">.  If justification<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">is on in </span><span style="font: bold 10pt serif">para</span><span style="font: 10pt serif"> and </span><span style="font: bold 10pt serif">spaces</span><span style="font: 10pt serif"> is &gt; 0, the line will be justified.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">Passing </span><span style="font: bold 10pt serif">spaces</span><span style="font: 10pt serif"> as 0 causes suppression of justificaton even if<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">justification is turned on in </span><span style="font: bold 10pt serif">para</span><span style="font: 10pt serif">; space characters will be displayed<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">normally even when </span><span style="font: bold 10pt serif">spaces</span><span style="font: 10pt serif"> is 0.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 10pt serif">Trailingspaces</span><span style="font: 10pt serif"> is needed for justification.  </span><span style="font: bold 10pt serif">Startrun</span><span style="font: 10pt serif"> is an integer index<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">into the runs, indicating which run to start on.  </span><span style="font: bold 10pt serif">Firstrunlength</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">is the number of characters remaining in run </span><span style="font: bold 10pt serif">startrun</span><span style="font: 10pt serif">.  Note that<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">while runs in a paragraph are allocated as a string, </span><span style="font: bold 10pt serif">startrun</span><span style="font: 10pt serif"> will<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">be considered a word index.<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 10pt serif">maxascent</span><span style="font: 10pt serif"> and </span><span style="font: bold 10pt serif">maxdescent</span><span style="font: 10pt serif"> in </span><span style="font: bold 10pt serif">style</span><span style="font: 10pt serif"> must be nonnil to avoid a croak."<br><br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user croak] primitive: 104</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Conversion</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">makeParagraph </span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">simulate ListPane for hardcopy</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">para≡nil⇒ [para &larr; &rsquo;NIL !&rsquo; asParagraph]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Printing</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hardcopy </span><span style="font: 10pt serif">| pf [user displayoffwhile⦂ [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pf &larr; dp0 pressfile: &rsquo;frame.press&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">window hardcopy: pf.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self hardcopy: pf.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pf close; toPrinter]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hardcopy: pf </span><span style="font: 10pt serif">| r first last lasty len parag left right top bottom [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[para≡nil⇒ [self makeParagraph]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">parag &larr; para asParagraph.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">frame=window⇒ [parag presson: pf in: (pf transrect: window) style: style]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">left &larr; frame minX max: window minX.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">right &larr; window maxX min: frame maxX.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bottom &larr; window maxY min: frame maxY.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">top &larr; window minY max: frame minY.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">lasty &larr; top + 4. "slop for char finding and making print rect larger"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">first &larr; self charofpt: left+1 ⌾ lasty.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">len &larr; parag length.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">frame minX ≥ left and⦂ frame maxX ≤ right⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"paragraph is inset and may be scrolled"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(parag copy: first to: len) presson: pf in: (<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pf transrect: (left ⌾ top rect: right ⌾ (bottom+4))) style: style]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">yuk, frame extends left or right so do it a line at a time for clipping</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ (first &lt; len and⦂ lasty &lt; bottom) do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">last &larr; (self charofpt: right-1 ⌾ lasty) min: len.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">r &larr; self rectofchar: last.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">lasty &larr; lasty + r height.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(parag copy: first to: last) presson: pf in:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(pf transrect: (left ⌾ (r minY) rect: right ⌾ lasty)) style: style.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">first &larr; last+1]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪Textframe under: &rsquo;Text Objects&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"ParagraphEditor"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;ParagraphEditor&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: TextImage<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;oldEntity sel&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;on off &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>This version of ParagraphEditor (for use in CodePanes) is based on TextImage</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Scheduling</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">enter </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">begintypein &larr; false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self show; select]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">leave </span><span style="font: 10pt serif">[self complement: off]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Editing</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">again  </span><span style="font: 10pt serif">| many<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[many&larr; user leftShiftKey.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self fintype⇒ [Scrap &larr; Scrap text. self select]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">many⇒[while⦂ self againOnce do⦂ []]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self againOnce⇒[] frame flash]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">againOnce  </span><span style="font: 10pt serif">| t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t &larr; para findString: Deletion startingAt: c2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">t=0⇒ [⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self unselect.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">c1 &larr; t.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">c2 &larr; c1 + Deletion length.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self replace: Scrap; selectAndScroll]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">copy </span><span style="font: 10pt serif">[Scrap &larr; self selection]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">cut </span><span style="font: 10pt serif">[self fintype; replace: nullString; complement. Scrap &larr; Deletion]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">paste </span><span style="font: 10pt serif">[self fintype; replace: Scrap; selectAndScroll]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">realign </span><span style="font: 10pt serif">[self align. sel &larr; on]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">undo </span><span style="font: 10pt serif">[self fintype; replace: Deletion; complement]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Public Messages</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">contents </span><span style="font: 10pt serif">[⇑para]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">Deletion &larr; s </span><span style="font: 10pt serif">[Deletion &larr; s]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fixframe: f </span><span style="font: 10pt serif">| dy  [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dy &larr; [frame≡nil⇒ [0] self frameoffset].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">window &larr; f copy.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">frame &larr; Rectangle new origin: window origin + (2⌾dy)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> extent: window width-4 ⌾ 9999.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑window]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">formerly </span><span style="font: 10pt serif">[⇑oldEntity]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">formerly: oldEntity</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">frame&larr; f </span><span style="font: 10pt serif">[self fixframe: f]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">kbd </span><span style="font: 10pt serif">| more char "key struck on the keyboard"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[c1&lt;c2 and⦂ self checklooks⇒[⇑self show complement]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">more &larr; Set new string: 16.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[begintypein⇒[] Deletion &larr; self selection. begintypein &larr; c1].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ (char &larr; user kbdnext) do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">char<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=bs⇒ ["</span><span style="font: italic 10pt serif">backspace</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">more empty⇒ [begintypein &larr; begintypein min: (c1 &larr; 1 max: c1-1)]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">more skip: ¬1];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=cut⇒ [self fintype. [c1=c2⇒[c2&larr; c1+1 min: para length+1]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self replace: nullString; complement. Scrap &larr; Deletion. ⇑self];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=paste⇒ [⇑self paste];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=ctlw⇒ ["</span><span style="font: italic 10pt serif">ctl-w for backspace word</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[more empty⇒ [] self replace: more. more reset. c1 &larr; c2].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">c1 &larr; 1 max: c1-1.</span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ [c1&gt;1 and⦂ (para◦(c1-1)) tokenish] do⦂ [c1 &larr; c1-1].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">begintypein &larr; begintypein min: c1];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=esc⇒ ["</span><span style="font: italic 10pt serif">select previous type-in</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[more empty⇒[self unselect]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self replace: more. c1 &larr; c2].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self fintype.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">c1 &larr; c2-Scrap length.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self complement]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">just a normal character</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">more next&larr; char].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self replace: more.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">c1 &larr; c2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self selectAndScroll]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">keyset</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">Scrap &larr; s </span><span style="font: 10pt serif">[Scrap &larr; s]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">scrollby: n </span><span style="font: 10pt serif">| oldw [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">n &larr; (n * self lineheight) max: self frameoffset.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">frame moveby: 0⌾(0-n).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">n abs ≥ window height⇒ [self show; select]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">need only to reshow part of window</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">oldw &larr; window.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">window &larr; [n &lt; 0⇒ [window inset: 0⌾0 and: 0⌾(0-n)]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">window inset: 0⌾n and: 0⌾0].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">window blt: window origin - (0⌾n) mode: storing.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[n&lt;0⇒ [window corner y &larr; window origin y - n]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">window origin y &larr; window corner y - n].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self show; select.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">window &larr; oldw]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">scrollPos </span><span style="font: 10pt serif">| t [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">t &larr; self height - self lineheight.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">t=0⇒ [⇑0.0]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑0.0 - self frameoffset / t]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">scrollTo: f </span><span style="font: 10pt serif">[self scrollUp: self frameoffset + (f* self height) - 4]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">scrollUp: n </span><span style="font: 10pt serif">[self scrollby: n/self lineheight]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">select: t </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self complement: off.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">c1 &larr; c2 &larr; t.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self selectAndScroll]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">selectAndScroll </span><span style="font: 10pt serif">| l dy c1y [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">l &larr; self lineheight.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self select.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">c1y &larr; (self ptofchar: c1) y.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dy &larr; c1y - window minY.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[dy ≥ 0⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">dy &larr; c1y + l - 1 - window maxY max: 0]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dy≠ 0⇒ [self scrollby: (dy abs+l-1) / l * dy sign]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">selecting </span><span style="font: 10pt serif">| pt t [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">t &larr; self charofpt: (pt &larr; user mp).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self complement: off; fintype.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t=c1 and⦂ c1=c2⇒ [  "bugged hairline - maybe double-bug"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ [user redbug and⦂ t=(self charofpt: user mp)]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">do⦂ [].</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"wait for unclick or drawing selection"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user redbug≡false⇒[self selectword; select. ⇑true]]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sel &larr; on.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑super select: pt]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">selection </span><span style="font: 10pt serif">[para text empty⇒ [⇑para copy] ⇑para copy: c1 to: c2-1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">selectionAsStream </span><span style="font: 10pt serif">[⇑Stream new of: para text from: c1 to: c2-1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">show </span><span style="font: 10pt serif">[self primshow. sel &larr; off]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">typing </span><span style="font: 10pt serif">[self kbd]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">unselect </span><span style="font: 10pt serif">[self complement: off]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Private</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">checklooks </span><span style="font: 10pt serif">| t val mask [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">t &larr; ↪(166 150 137 151   230 214 201 215<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">135 159 144 143 128 127 129 131 180 149<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">199 223 208 207 192 191 240 226) find: user kbck.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">t=0⇒[⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user kbd.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[oldEntity⇒[] oldEntity &larr; para. para &larr; para copy].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">t=25⇒[para &larr; para toBravo]; "ctl-T" <br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> =26⇒[para &larr; para fromBravo]. "ctl-F" <br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">val &larr; ↪(1 2 4 256   ¬1 ¬2 ¬4 256  "ctl-b i - x   B I ¬ X"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">0 16 32 48 64 80 96 112 128 144  "ctl-0 1 ... 9"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">160 176 192 208 224 240)◦t.  "ctl-shift-0 1 ... 5"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[val=256⇒[mask&larr; 0377.  val&larr; 0]</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"reset all"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">val&lt;0⇒[mask&larr; 0-val.  val&larr; 0]</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"reset emphasis"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">val&gt;0 and⦂ val&lt;16⇒[mask&larr; val]</span><span class="tab" val="79"></span><span style="font: 10pt serif">"set emphasis"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">mask&larr; 0360].</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"set font"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">para maskrun: c1 to: c2-1 under: mask to: val]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit </span><span style="font: 10pt serif">[on &larr; 1. off &larr; 0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">complement </span><span style="font: 10pt serif">[self complement: on]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">complement: nsel </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nsel = sel⇒ ["already that way"]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nsel = on and⦂ (user rawkbck or⦂ user redbug)⇒ ["slippage"]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sel &larr; nsel.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self reversefrom: c1 to: c2]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">frameoffset </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"a useful number"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑frame minY - window minY]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">height </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self selectchar: para length+1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑reply2 y - frame minY]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">primshow </span><span style="font: 10pt serif">[user croak] primitive: 57</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">replace: t </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[oldEntity⇒ [] oldEntity &larr; para. para &larr; para copy].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[begintypein⇒ [] Deletion &larr; self selection].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">para replace: c1 to: c2-1 by: t.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">c2 &larr; c1 + t length.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self show]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">select </span><span style="font: 10pt serif">[self selectIn: nil]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">selectIn: w </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sel &larr; off.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[c1≡nil⇒ [c1 &larr; c2 &larr; 1]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self complement: on]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">selectRange </span><span style="font: 10pt serif">[⇑c1 to: c2-1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">selectRange: r </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"self complement: off"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">c1 &larr; r start.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">c2 &larr; r stop<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"self complement: on"]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">selectword </span><span style="font: 10pt serif">| a b dir t level open close s slen<br>[<br>"</span><span style="font: italic 10pt serif">Select bracketed or word range, as a result of double-bug.</span><span style="font: 10pt serif">"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">a&larr; b&larr; dir&larr; ¬1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s &larr; para text.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">slen &larr; s length.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">level &larr; 1.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">open &larr; &rsquo;([{&lt;&rsquo;&rsquo;"<br>&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">close &larr; &rsquo;)]}&gt;&rsquo;&rsquo;"<br>&rsquo;.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[c1≤1⇒[dir&larr;1. t&larr;c1]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">c1&gt; slen⇒[t&larr;c1-1]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">t&larr;open find: (a&larr; para◦(c1-1)). t&gt;0⇒</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">delim on left</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[dir&larr;1. b&larr;close◦t. t&larr;c1-1]</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">match to the right</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">t&larr;close find: (a&larr; para◦c1). t&gt;0⇒</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">delim on right</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[dir&larr;¬1. b&larr;open◦t. t&larr;c1]</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">match to the left</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">a&larr; ¬1. t&larr;c1].</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">no delims - select a token</span><span style="font: 10pt serif">"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ (level=0 or⦂ [dir=1⇒[t≥slen] t≤1]) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s◦(t&larr; t+dir) = b⇒ [level&larr; level-1];</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">leaving nest</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">= a⇒ [level&larr; level+1].</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">entering nest</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">a=¬1⇒[(s◦t) tokenish⇒</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">token check goes left </span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t=1⇒[c1&larr; dir&larr; 1. t&larr; c2]]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">dir=¬1⇒[c1 &larr; t+1. dir&larr;1. t&larr;c2-1]</span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">then right</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">level&larr; 0]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[level≠0⇒[t&larr; t+dir]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dir=1⇒[c2&larr; t min: slen+1] c1&larr; t+1<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪ParagraphEditor under: &rsquo;Text Objects&rsquo;.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">ParagraphEditor classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"TextStyle"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;TextStyle&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;fonts "&lt;Vector of Strings or Integers&gt; which are the fonts.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">An integer entry has a vertical offset in the high 8 bits, a 1 in<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">the 200-bit for descent, and another font number (zero-relative)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">in the bottom 4 bits"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">tabandspace "&lt;Integer&gt; =256*tabwidth + spacewidth"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">maxascent "&lt;Integer&gt; max ascent for this fontset"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">maxdescent "&lt;Integer&gt; max descent for this fontset"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">mode "&lt;Integer&gt; =0 for normal, =4 for white-on-black"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fontnames "&lt;Vector of Strings&gt; corresponding to the fonts"&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I am a specification of how to display a paragraph.  I include a font set, a tab spacing, a space size, etc.  If I do not specify ascent and descent from the baseline, then each line displayed will adjust to its tallest characters.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">default<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[tabandspace &larr; mode &larr; 0. self mode: 0; tab: 20; space: 5.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fonts &larr; Vector new: 16. fontnames &larr; Vector new: 16.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self setfont: 0 name: &rsquo;CREAM10&rsquo;.</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Put default font in font 0"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">mode<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑ mode]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">mode: mode</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">space<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑ (tabandspace land: 0377)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">space: t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[tabandspace &larr; (tabandspace land: 0177400) + (t land: 0377)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">tab<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑ ((tabandspace land: 0177400) lshift: ¬8)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">tab: t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[tabandspace &larr; (tabandspace land: 0377) + (t lshift: 8)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Fonts</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fontfamily: n </span><span style="font: 10pt serif">| s char<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"return the family name taken out of fontnames"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s &larr; Stream default.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ char from: fontnames ◦ n do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[char isletter⇒ [s next &larr; char]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑s contents]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fontnames </span><span style="font: 10pt serif">[⇑fontnames]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fonts </span><span style="font: 10pt serif">[⇑fonts]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fontsize: n </span><span style="font: 10pt serif">| s c size<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"return size from fontname"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">size &larr; 0. s &larr; (fontnames ◦ n) asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ (c &larr; s next) isletter do⦂ [].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ [size &larr; size*10 + (c - 060). c &larr; s next] do⦂ [].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑size]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">setfont: n fromfile: name<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self setfont: n name: name fromstring: (dp0 oldFile: name + &rsquo;.strike.&rsquo;) contents]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">setfont: n name: name </span><span style="font: 10pt serif">| ucn</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[FontDict has: (ucn&larr; name asUppercase)⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self setfont: n name: ucn fromstring: FontDict◦ucn]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self setfont: n fromfile: name]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">setfont: n name: name fromstring: string<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Should update maxascent, maxdescent"</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[fontnames◦(n+1) &larr; name asUppercase.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fonts◦(n+1) &larr; string.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">FontDict insert: fontnames◦(n+1) with: string]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">setoffsetfont: n from: m by: d<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[fonts◦n &larr; m + [d&lt;0⇒ [0200] 0] + (d lshift: 8)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">writeset: styleindex<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self writeset: styleindex as: fontnames◦(styleindex+1)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">writeset: styleindex as: name</span><span class="tab" val="79"></span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"write out a formset on name with strike extention"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">name &larr; name + &rsquo;.strike.&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(dp0 file: name) append: fonts◦ (styleindex+1) ; close.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Access</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">heightofset: styleindex<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Return height of formset in style"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑(fonts◦(styleindex+1) word: 6) +<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(fonts◦(styleindex+1) word: 7)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">lineheight<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[((maxascent ≡ nil) or: (maxdescent ≡ nil)) ⇒<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑((fonts◦1) word: 6) + ((fonts◦1) word: 7)]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑maxascent+maxdescent]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">maxascent<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑ maxascent ]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">maxascent: maxascent</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">maxdescent<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ ⇑ maxdescent ]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">maxdescent: maxdescent</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">maxwidthofset: styleindex<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Return maximum width of formset in style"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑(fonts◦(styleindex+1) word: 4)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">nameofset: styleindex<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Return name of formset in style"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑(fontnames◦(styleindex+1))]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">strikeofset: styleindex<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Return strike of formset in style"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑(fonts◦(styleindex+1))]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪TextStyle under: &rsquo;Text Objects&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"TokenCollector"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;TokenCollector&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;sink parenstack&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>Provides standard token-collecting behavior for Reader .<br>See Reader-readInto: for more insight.  (P. Deutsch)</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">default<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self to: (Vector new: 20)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">to: v </span><span style="font: italic 10pt serif">"Initialize"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[sink&larr; v asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">parenstack&larr; (Vector new: 5) asStream]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Finalization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">contents </span><span style="font: italic 10pt serif">"Close all parentheses first"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[until⦂ parenstack empty do⦂ [self rightparen].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑sink contents]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">next&larr; obj </span><span style="font: 10pt serif">[sink next&larr; obj]</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"subclasses can override easily"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">notify: errorString<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user notify: errorString]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Constructors</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">comment: s</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">float: i fraction: f exp: e<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self next&larr; (i+&rsquo;.&rsquo;+f+&rsquo;e&rsquo;+e) asFloat]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">identifier: s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self next&larr; s unique]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">integer: s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self next&larr; s asInteger]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">keyword: s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self next&larr; s unique]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">leftparen<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[parenstack next&larr; sink.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sink&larr; (Vector new: 10) asStream]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">onechar: c </span><span style="font: 10pt serif">| x<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[x&larr; String new: 1. x◦1&larr; c. self next&larr; x unique]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">otheratom: s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self next&larr; s unique]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">rightparen<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[parenstack empty⇒[] </span><span style="font: italic 10pt serif">"Error will be caught elsewhere"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">parenstack last next&larr; sink contents.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sink&larr; parenstack pop]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">separator: c</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">string: s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self next&larr; s]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">trailer: s</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪TokenCollector under: &rsquo;Text Objects&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"FieldNameCollector"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;FieldNameCollector&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: TokenCollector<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>This class collects identifiers as Strings (not UniqueStrings)<br>for scanning of class field names (Class.instvars)<br>by the compiler(Generator) and debugger(VariablePane)</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Valid fields</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">identifier: s </span><span style="font: 10pt serif">[sink next&larr; s]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Invalid fields</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">leftparen </span><span style="font: 10pt serif">[self next&larr; &rsquo;(&rsquo;] "just for error message"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">next&larr; value<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user notify: &rsquo;Invalid field name: &rsquo;+value asString]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">rightparen </span><span style="font: 10pt serif">[self next&larr; &rsquo;)&rsquo;] "just for error message"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪FieldNameCollector under: &rsquo;Text Objects&rsquo;.</span></div>
    <div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">&rsquo;From Smalltalk 5.5k XM November 24 on 22 November 1980 at 2:57:08 am.&rsquo;<br></span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">"FontWindow"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;FontWindow&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;frame font fontht fontraster fontxtabl bitsetter char charx charwid charstr altostyle fontnumber clearframe scale boxer&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;fontmenu &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I am a window that displays one blown up character at a time of a strike-format font</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Help</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">help<br></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"<br>**sysFontWindow is declared in the Smalltalk dictionary, and bound to the font window displayed on the screen of most system releases -- intended to provide an easy way to play around with the font editor.<br>**to create a window for editing default font 0 at middle-click:<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif"> user schedule: (sysFontWindow &larr; FontWindow new<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">altostyle: DefaultTextStyle<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">fontnumber: 1<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">at: (OriginCursor showwhile⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">[user waitbug ⇒[user mp]])).<br>**to create a new font<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">yourfont &larr; FontWindow new newfont: 16 maxcharwidth: 16 min: 0<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">max: 177 ascent: 12 kern: 0.<br><br>**to edit newly created font<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">yourtextstyle setfont: n name: yourfont.</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">**insert it into a TextStyle<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">**now create a window as above with yourtextstyle and appropriate<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">fontnumber<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif"><br><br>**examples of manual manipulation of yourfontwindow:<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">sysFontWindow setascent: 2.</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">**Deltas -- for entire font**<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">sysFontWindow setascent: ¬3.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">sysFontWindow setdescent: 2.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">sysFontWindow setdescent: ¬2.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">sysFontWindow setchar: 046.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">sysFontWindow setwidth: 5.</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">**Absolute--for char in window. <br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Useful for characters of zero width.**<br>"</span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">altostyle: altostyle fontnumber: fontnumber at: origin<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"set up an instance"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[fontmenu≡nil⇒[self init]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">scale &larr; 9. charstr &larr; String new: 1. char &larr; 65. charstr◦1 &larr; char.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitsetter &larr; BitBlt init.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">boxer &larr; Rectangle new<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">origin: 0 ⌾ 0 extent: (scale-1) ⌾ (scale-1).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">frame &larr; Rectangle  new origin: origin  extent:  scale ⌾ 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">clearframe &larr; Rectangle  new origin: origin  extent:  scale ⌾ 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self setfont: altostyle fonts◦fontnumber.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[fontmenu &larr; Menu new string:<br>&rsquo;strike<br>set width<br>debug<br>move<br>close&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Scheduler</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">eachtime</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"while active"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[clearframe has: user mp⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user redbug ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self setbit: user mp color: black]</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"make dot black"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user yellowbug ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self setbit: user mp color: white]</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"make dot white"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user bluebug ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[fontmenu bug<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=1⇒[self strike];</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"put strike of font in dialogue window"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=2⇒[self setwidth];</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"grow character"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=3⇒[self updateseglength: font raster: fontraster.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self updatemaxwidth.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"clean things up"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: &rsquo;font debugging&rsquo;];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=4⇒[self frame];</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"move fontwindow"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=5⇒[clearframe clear.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self updateseglength: font raster: fontraster.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self updatemaxwidth.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"clean things up"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user unschedule: self. ⇑false]]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user kbck⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[char &larr; user kbd. self setchar: char]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user anybug⇒[⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif"> firsttime</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"upon entry"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">clearframe has: user mp⇒[self show]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">lasttime</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"upon exit"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Editing</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">setascent: ascentdelta </span><span style="font: 10pt serif">| updatedfont ascent<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> </span><span style="font: italic 10pt serif">"ascent delta"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ascent &larr; font word: 6.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ascent + ascentdelta &lt; 0 ⇒[ascentdelta &larr; 0 - ascent]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ascentdelta &gt; 0 ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">updatedfont &larr; String new: (2 * fontraster * ascentdelta).</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"grow"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">updatedfont all &larr;  0.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"fill with white"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">updatedfont &larr;</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"add oldfont header and new space together"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(font◦(1 to: 18) concat: updatedfont◦(1 to: updatedfont length)).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">updatedfont &larr;</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"now add on rest of old font"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(updatedfont concat: font◦(19 to: font length)).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">updatedfont &larr; (font◦(1 to: 18) concat:</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"shrink"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">font◦((19 + (0 - (2 * fontraster * ascentdelta))) to: font length)).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">updatedfont word: 6 &larr; ascent + ascentdelta.</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"reset ascent word in font"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self setfont: updatedfont.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"updatedfont now font of interest"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self updateseglength: font raster: fontraster.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">setbit: bitpoint color: color</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"turn bits on, off"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| x y<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitpoint &larr;  bitpoint - frame origin.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> x &larr; (0 max: (charwid-1)) min: (bitpoint x/scale).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> y &larr; (0 max: (fontht-1)) min: (bitpoint y/scale).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> boxer moveto: frame origin + ((scale*x) ⌾ (scale*y)).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> boxer color: color mode: storing.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"turn bit on/off in blowup"</span><span style="font: 10pt serif"><br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitsetter destraster &larr; fontraster.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"set up bitblt table."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitsetter destx &larr; charx + x.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitsetter desty &larr; y.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitsetter destbase &larr; font; dstrike&larr; true.  </span><span style="font: italic 10pt serif">"lock font and get core ptr"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitsetter fill: storing color: color.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"turn bit on/off in font"</span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">setchar: char<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">charstr◦1 &larr;  char.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[((font word: 2) ≤ char) and: (char ≤ (font word: 3))⇒<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[char &larr; char - (font word: 2)]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">char &larr; ((font word: 3) - (font word: 2)) + 1].</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"char out of range"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">charx &larr; (font word: (fontxtabl+ (char))).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">charwid &larr; (font word: (fontxtabl + char+1)) - charx.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">clearframe clear.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">frame extent &larr; charwid ⌾  fontht.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">clearframe &larr;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">frame inset: ¬2 ⌾ ¬2</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"for clearing everything including outline"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">and: (charwid - (charwid * scale + 2)) ⌾ (fontht - (fontht * scale + 2)).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self show.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">setdescent: descentdelta </span><span style="font: 10pt serif">| updatedfont descent space<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"descent delta"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">descent &larr; font word: 7.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[descent + descentdelta &lt; 0 ⇒ [ descentdelta &larr; 0 - descent]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[descentdelta &gt; 0 ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[space &larr; String new: 2 * fontraster * descentdelta.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">space all &larr; 0.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">updatedfont &larr; (font ◦ (1 to: fontxtabl - 1 * 2) concat: space).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">updatedfont &larr; (self appendxtable: updatedfont).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">updatedfont &larr;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(font ◦ (1 to: ((fontxtabl - 1 * 2) + (fontraster * descentdelta * 2)))).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">updatedfont &larr; (self appendxtable: updatedfont).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">updatedfont word: 7 &larr;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">descent + descentdelta.</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"reset descent word in font"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self setfont: updatedfont.</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"updatedfont now font of interest"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self updateseglength: font raster: fontraster.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">setfont: font<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">altostyle fonts ◦ fontnumber &larr; font.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fontraster &larr; font word: 9.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fontht &larr; (font word: 6) + ( font word: 7).</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"ascent + descent"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fontxtabl &larr; fontraster * fontht + 9 </span><span style="font: italic 10pt serif">"header"</span><span style="font: 10pt serif"> + 1 </span><span style="font: italic 10pt serif">"for 0 addressing"</span><span style="font: 10pt serif">.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitsetter width &larr;  1. bitsetter height &larr; 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self setchar: charstr◦1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">setwidth </span><span style="font: 10pt serif">| newextentx outlineframe<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"get new size"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outlineframe &larr; clearframe inset: 1 ⌾ 1 and: 0 ⌾ 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">OriginCursor showwhile⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user waitbug⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[while⦂ user anybug do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[outlineframe growto:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">((clearframe origin x + 2) +<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(newextentx &larr; (user mp x - clearframe origin x + 2) | scale))<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ⌾ (outlineframe corner y).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">outlineframe border: 2 color: black.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">outlineframe border: 2 color: background<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">outlineframe border: 2 color: black.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self setwidth: newextentx / scale.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">setwidth: delta<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">| fontrightx newraster newxtabl newmaxwidth updatedfont i<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"change in width"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">delta &larr; delta - charwid. delta = 0 ⇒ [self show. ⇑false].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fontrightx &larr;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">font word: (fontxtabl + ((font word: 3) - (font word: 2)) + 2).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">newraster &larr;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(fontrightx + 15 / 16) ≠ (i &larr; (fontrightx + delta + 15 / 16)) ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ i ] fontraster].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">newxtabl &larr; newraster * fontht + 9 </span><span style="font: italic 10pt serif">"header"</span><span style="font: 10pt serif"> + 1 </span><span style="font: italic 10pt serif">"for 0 addressing"</span><span style="font: 10pt serif">.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">XeqCursor showwhile⦂ <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">updatedfont &larr; String new:<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(9 </span><span style="font: italic 10pt serif">"header"</span><span style="font: 10pt serif"> + (newraster * fontht </span><span style="font: italic 10pt serif">"bits"</span><span style="font: 10pt serif">)) * 2.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"grow/shrink the bits"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: 8 do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[updatedfont word: i &larr; font word: i].</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"fill in header of new font"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">updatedfont word: 9 &larr; newraster.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"set raster in new font"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"copy the xtable"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">updatedfont &larr; (self appendxtable: updatedfont).<br><br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"set up to copy up to old bits of char"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitsetter destraster &larr; newraster.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitsetter destx &larr; 0. bitsetter desty &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitsetter sourcex &larr; 0. bitsetter sourcey &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitsetter width &larr; charx + charwid.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitsetter height &larr; fontht.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitsetter sourceraster &larr; fontraster.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitsetter destbase &larr; updatedfont.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitsetter sourcebase &larr; font.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitsetter sstrike&larr; true; dstrike&larr; true.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitsetter copy: storing.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"if char grown, clean out right side of char"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">delta&lt; 0 ⇒[]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitsetter destx &larr; charx + charwid.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitsetter width &larr; delta.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitsetter fill: storing color: 0.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"now copy remainder of font"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitsetter destx &larr; charx + charwid + delta.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitsetter width &larr; fontrightx - charx - charwid.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitsetter sourcex &larr; charx + charwid.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitsetter copy: storing.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"shift x-vals"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: ((char + 1)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">to: (2 + (updatedfont word: 3) - (updatedfont word: 2) </span><span style="font: italic 10pt serif">"max"</span><span style="font: 10pt serif">)) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[updatedfont word: (newxtabl + i) &larr;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">delta + (updatedfont word: (newxtabl +i ))].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">clearframe clear.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"clear out old version of character"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self setfont: updatedfont.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"set up the new copy of the font"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self updateseglength: font raster: fontraster.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self updatemaxwidth.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Image</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">frame<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[clearframe clear.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">frame moveto:<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(OriginCursor showwhile⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user waitbug⇒[user mp]]).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self setchar: char.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">show </span><span style="font: 10pt serif">|</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"refresh window"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">tempframe showrun showpara<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">showrun &larr; String new: 2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">showrun word: 1 &larr;  16 * (fontnumber-1) + 0177400.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">showpara &larr; Paragraph new text: charstr runs: showrun alignment: 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tempframe &larr; Textframe new para: showpara frame: frame style: altostyle.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tempframe show.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">frame blowup: (frame origin) by: scale.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Strike format</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">appendxtable: thefont<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"put fontⓢxtable on end of a grown/shrunk font"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">thefont &larr; thefont concat: font ◦ ((fontxtabl * 2 - 1) to: font length).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑thefont.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">cufixup </span><span style="font: 10pt serif">|  </span><span style="font: italic 10pt serif">"Carnegie-Mellon fixup for scale compatibility"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[boxer extent &larr; (scale-1)⌾(scale-1).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">frame extent &larr; scale⌾0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">clearframe extent &larr; scale⌾0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">makecu: name scale: cuscale  </span><span style="font: italic 10pt serif">"Put out font in Carnegie-Mellon format"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| f svscale svchar  bitwidth i bitmover bits<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[f &larr; dp0 file: name + &rsquo;.cu.&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self updateseglength: font raster: fontraster.  self updatemaxwidth.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">svscale &larr; scale. scale &larr; cuscale.  svchar &larr; char.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self cufixup.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f nextword &larr; fontht*scale.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f nextword &larr; (bitwidth &larr; (font word: 4)) * scale + 15 / 16.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bits &larr; String new: ((fontht * scale) * ((bitwidth * scale + 15)/16)) * 2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover &larr; BitBlt init.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover destbase &larr; bits lock.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover destraster &larr; bitwidth * scale + 15 / 16.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover destx &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover desty &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover sourcebase &larr; mem◦066.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover sourceraster &larr; (user screenrect extent x) + 15/16.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover sourcex &larr; frame origin x.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover sourcey &larr; frame origin y.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: ((font word: 2) to: (font word: 3) by: 1) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self setchar: i.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">f nextword &larr; i. f nextword &larr; charwid*scale.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover width &larr; (frame extent x) * scale.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover height &larr; (frame extent y) * scale.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">bits all &larr; 0.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover copy: storing.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">f append: bits].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f close. scale &larr; svscale. self cufixup. bits unlock. self setchar: svchar]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">newfont: fontht maxcharwidth: maxcharwidth min: min max: max ascent: ascent kern: kern<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">| raster i x<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[XeqCursor showwhile⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[raster &larr; (2 + max - min * maxcharwidth + 15)/16.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">font &larr; String new:  (3 + max - min + (fontht * raster) + 9 * 2).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">font word: 1 &larr; 0100000.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"format: strike, simple, varwidth"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">font word: 2 &larr; min.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"min ascii code"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">font word: 3 &larr; max.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"max ascii code"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">font word: 4 &larr; maxcharwidth.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"max char width"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">font word: 5 &larr; (2+max-min + 5 + (fontht*raster)).</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"segment length"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">font word: 6 &larr; ascent.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"bits above baseline"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">font word: 7 &larr; fontht-ascent.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"bits below baseline"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">font word: 8 &larr; kern.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"kerning offset"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">font word: 9 &larr; raster.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"#words per scan-line in bitmap"</span><span style="font: 10pt serif"><br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(font◦((18 + 1) to: 2 * raster * fontht + 18)) all &larr; 0.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"chars all white"</span><span style="font: 10pt serif"><br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">ascent &larr; ascent min: (fontht-1).</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"keep baseline within char"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(font◦(2 * raster * ascent + 18 + 1 to:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">ascent+1*raster*2 + 18)) all &larr; 0377.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"put in a black baseline"</span><span style="font: 10pt serif"><br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">x &larr; 0.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i  from: (raster * fontht + 9 + 1 to:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">raster * fontht + 9 + 3 + max - min by: 1) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[font word: i &larr; x. x &larr; x+maxcharwidth].</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"table of left x"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑font.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">strike </span><span style="font: 10pt serif">| i</span><span class="tab" val="79"></span><span style="font: 10pt serif">showstr </span><span style="font: italic 10pt serif">"Put a strike of font into dialogue window"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[showstr &larr; String new: 128. for⦂ i to: 128 do⦂ [showstr◦i &larr;i].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user clearshow: showstr]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">updatemaxwidth </span><span style="font: 10pt serif">| newmaxwidth i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"update max width"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">newmaxwidth &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: (fontxtabl to: fontxtabl + ((font word: 3) - (font word: 2) + 1) by: 1) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[newmaxwidth &larr; (newmaxwidth max: ((font word: i+1) - (font word: i)))].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">font word: 4 &larr; newmaxwidth.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">updateseglength: newfont raster: newraster<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"compute new segment length for a font"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">newfont word: 5 &larr;</span><span class="tab" val="79"></span><span style="font: 10pt serif">(5</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"length, ascent, descent, kern, and raster"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">+ (newraster * fontht)</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"bits"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">+ ((font word: 3 </span><span style="font: italic 10pt serif">"max"</span><span style="font: 10pt serif">) -<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(font word: 2</span><span style="font: italic 10pt serif">"min"</span><span style="font: 10pt serif">) + 2)</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"xtabl"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪FontWindow under: &rsquo;Windows&rsquo;.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">FontWindow classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"Window"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;Window&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;frame collapsed titlepara growing exitflag &rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;titlerun border titleloc titleframe windowmenu &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>This is a superclass for presenting windows on the screen.  Besides outlining and scheduling the frame, it includes the distribution of user events which will someday be driven by interrupts.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"Window classInit"</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[border &larr; 2⌾2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">titleframe &larr; Textframe new para: nil frame: nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">titleloc &larr; 3⌾(¬4-titleframe lineheight).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">titlerun &larr; String new: 2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">titlerun word: 1 &larr; 0177401.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">windowmenu &larr; Menu new string:<br>&rsquo;under<br>frame<br>close<br>print<br>printbits<br>&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">reset<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[exitflag&larr;true. growing&larr;false] </span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Scheduling</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">eachtime<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[frame has: user mp⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user kbck⇒[⇑self kbd]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user anybug⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user redbug⇒[⇑self redbug]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user yellowbug⇒[⇑self yellowbug]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user bluebug⇒[⇑self bluebug]]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user anykeys⇒[⇑self keyset]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self outside⇒[]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user anybug⇒[frame has: user mp⇒[] ⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user kbck⇒[user kbd. frame flash] </span><span style="font: italic 10pt serif">"flush typing outside"</span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">firsttime<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[frame has: user mp⇒ [self reset.  ⇑self enter] ⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">lasttime<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self leave. ⇑exitflag]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">schedule </span><span style="font: 10pt serif">[user restartup: self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Framing</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">clearTitle: color<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(titleframe window inset: ¬2⌾¬2) clear: color]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">editTitle </span><span style="font: 10pt serif">| pared w<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pared&larr; ParagraphEditor new para: titlepara frame: nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pared formerly: false; fixframe: titleframe window+(1⌾2).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pared enter.  w&larr; titleframe window.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ (user anybug and⦂ (w has: user mp)≡false) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user kbck⇒[pared typing]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user redbug⇒[w has: user mp⇒[pared selecting]]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user yellowbug⇒[w has: user mp⇒[w flash]]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">titlepara&larr; pared contents.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self showtitle]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">erase<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(frame inset: ¬2⌾¬2) clear.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self clearTitle: background]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fixedwidthfromuser: width </span><span style="font: 10pt serif">| a b oldframe [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user waitnobug.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[frame≡nil⇒[] self aboutToFrame; erase].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">a &larr; OriginCursor showwhile⦂ user waitbug.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">growing &larr; true.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self frame: (frame &larr; self fixframe: (a rect: a+(width⌾32))); show.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">CornerCursor showwhile⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ (a &larr; user mpnext)  do⦂ [ a x &larr; frame corner x.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[oldframe≡nil⇒ [user cursorloc &larr; a max: frame corner]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">oldframe &larr; frame copy.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self frame: (frame &larr; self fixframe: (frame growto: a));<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">moveFrom: oldframe]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">growing &larr; false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self takeCursor]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fixframe: f </span><span style="font: 10pt serif">[⇑Rectangle new origin: f origin extent: (f extent max: 32⌾32)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">frame <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ ⇑ frame ]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">frame: f<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[frame &larr; self fixframe: f]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">moveFrom: oldframe<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(oldframe inset: ¬2) clear. self show]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">newframe<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">| a oldframe<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user waitnobug; restoredisplay.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[frame≡nil<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇒[]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self aboutToFrame; erase].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">a &larr; OriginCursor showwhile⦂ user waitbug.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">growing &larr; true.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">frame &larr; self fixframe: (a rect: a+32).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">frame outline.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">CornerCursor showwhile⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[while⦂ (a &larr; user mpnext) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[oldframe≡nil<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇒ [user cursorloc &larr; a max: frame corner]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">oldframe &larr; frame copy.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">frame &larr; self fixframe: (frame growto: a).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(oldframe inset: ¬2) clear.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">frame outline]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self frame: frame.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">growing &larr; false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self takeCursor]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">outline<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Clear and outline me."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">frame outline]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">show </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self outline.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">growing⇒[]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self showtitle]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">showtitle<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[titlepara≡nil⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[titlepara&larr; Paragraph new text: self title runs: titlerun alignment: 0]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">titleframe put: titlepara at: frame origin+titleloc; outline]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">takeCursor<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Move the cursor to my center."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user cursorloc &larr; frame center]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">title </span><span style="font: 10pt serif">[⇑&rsquo;Untitled&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Default Event responses</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">aboutToFrame<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"My frame is about to change.  I dont care."</span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">bluebug<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[windowmenu bug<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=1⇒[⇑exitflag &larr; false];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=2⇒[self newframe. self enter];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=3⇒[self close. self erase.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user unschedule: self. ⇑false];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=4⇒[self hardcopy];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=5⇒[self print]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">close </span><span style="font: 10pt serif">[]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">enter </span><span style="font: 10pt serif">[self show]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hardcopy </span><span style="font: 10pt serif">[frame flash]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">kbd </span><span style="font: 10pt serif">[user kbd. frame flash]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">keyset </span><span style="font: 10pt serif">[frame flash]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">leave </span><span style="font: 10pt serif">[]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">outside </span><span style="font: 10pt serif">[titleframe window has: user mp⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user anybug⇒[self editTitle] ⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">print<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(dp0 pressfile: (self title + &rsquo;.press.&rsquo;) asFileName)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">screenout: frame scale: PressScale; toPrinter]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">redbug<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[frame flash]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">yellowbug<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[frame flash]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪Window under: &rsquo;Windows&rsquo;.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">Window classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"PanedWindow"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;PanedWindow&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Window<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;panes templates title&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>A paned window is a Window that has subwindows (panes) that are awakened and resized in unison. The instance variable templates is a set of Rectangles for the frames of the panes normalized such that the whole PanedWindow is a frame of 0⌾0 rect: 36⌾36.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">title: title with: panes at: templates </span><span style="font: 10pt serif">| pane<br>"The instance variable templates is a set of Rectangles for the frames of the panes normalized such that the whole PanedWindow is a frame of 0⌾0 rect: 36⌾36."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self reset.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ pane from: panes do⦂ [pane init]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Window protocol</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">close </span><span style="font: 10pt serif">| pane<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ pane from: panes do⦂ [pane close]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">eachtime </span><span style="font: 10pt serif">| pane<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[frame has: user mp⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user bluebug⇒[⇑self bluebug]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ pane from: panes do⦂ [pane startup]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self outside⇒[]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user anybug⇒[frame has: user mp⇒[] ⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user kbck⇒[user kbd. frame flash] </span><span style="font: italic 10pt serif">"flush typing outside"</span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">enter </span><span style="font: 10pt serif">| pane<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[super show.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ pane from: panes do⦂ [pane windowenter]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">erase<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self titlerect clear. super erase]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fixframe: f<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑Rectangle new origin: f origin extent: (f extent max: 160⌾80)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">frame: frame </span><span style="font: italic 10pt serif">"(Re)initialize my frame, and tell my panes their locations."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| templateStream template pane orig ext<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[templateStream &larr; templates asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">orig&larr; frame origin-1. ext&larr; frame extent+2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ pane from: panes do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"It would be nice to have parallel fors as in MLISP."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">template &larr; templateStream next.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pane frame &larr; (template*ext /36 + orig) inset: 1]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hardcopy </span><span style="font: 10pt serif">| p<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user displayoffwhile⦂ [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">p &larr; dp0 pressfile: (self title+&rsquo;.press&rsquo;) asFileName.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self hardcopy: p.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">p close; toPrinter]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hardcopy: pf </span><span style="font: 10pt serif">| pane [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self hardcopyTitle: pf.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"print frame rectangle"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">frame hardcopy: pf.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"print all panes"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ pane from: panes do⦂ [pane hardcopy: pf].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"print cursor if it&rsquo;s inside"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">frame has: user mp⇒ [user currentCursor hardcopy: pf]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hardcopyTitle: pf </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"refresh title (since it&rsquo;s a class var)"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self showtitle.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"draw title rectangle"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">titleframe window hardcopy: pf.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"print title text (make frame larger)"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">titleframe para presson: pf in: (pf transrect: (<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">titleframe frame origin rect: titleframe frame corner + (999 ⌾ 2)))<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">style: titleframe style]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">kbd </span><span style="font: 10pt serif">| pane<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(pane &larr; self pickedpane)⇒ [⇑pane kbd]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">keyset </span><span style="font: 10pt serif">| pane<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(pane &larr; self pickedpane)⇒ [⇑pane keyset]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">leave </span><span style="font: 10pt serif">| pane<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ pane from: panes do⦂ [pane windowleave]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pickedpane </span><span style="font: 10pt serif">| pane<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ pane from: panes do⦂ [pane picked⇒ [⇑pane]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">frame flash. ⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">redbug </span><span style="font: 10pt serif">| pane<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(pane &larr; self pickedpane)⇒ [⇑pane redbug]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">show </span><span style="font: 10pt serif">| pane<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[super show.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ pane from: panes do⦂ [pane outline]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">takeCursor<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(panes◦1) takeCursor]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">title<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑title]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">yellowbug </span><span style="font: 10pt serif">| pane<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(pane &larr; self pickedpane)⇒ [⇑pane yellowbug]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Pane services</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">vanish<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self close; erase. user unschedule: self.]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Private</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">titlerect<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑frame origin - (2 ⌾ (DefaultTextStyle lineheight + 4)) rect: (frame corner x⌾frame origin y) + (2⌾0)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪PanedWindow under: &rsquo;Windows&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"BrowseWindow"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;BrowseWindow&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: PanedWindow<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;stdTemplates &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I am a five-paned window to browse through classes.  My panes are...<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">system pane: categories of classes in the system<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">class pane: classes in the selected category<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">organization pane: categories of methods in the selected class<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">selector pane: method selectors in the selected category<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">code pane: source code of the selected method, if any, else other useful info</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[stdTemplates &larr; (0⌾0 rect: 10⌾14), (10⌾0 rect: 18⌾14), (18⌾0 rect: 28⌾14), (28⌾0 rect: 36⌾14), (0⌾14 rect: 36⌾36)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">default </span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Let the user draw a five-paned window to browse through classes."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| systemPane classPane orgPane selectorPane codePane<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Create the panes."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">systemPane &larr; SystemPane new. classPane &larr; ClassPane new.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">orgPane &larr; OrganizationPane new. selectorPane &larr; SelectorPane new.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">codePane &larr; CodePane new.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Acquire them."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self title: &rsquo;Classes&rsquo;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">with: (systemPane, classPane, orgPane, selectorPane, codePane)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">at: stdTemplates.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self newframe; show.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Interconnect them."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">systemPane to: classPane. classPane from: systemPane to: orgPane.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">orgPane from: classPane to: selectorPane. selectorPane from: orgPane to: codePane.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">codePane from: selectorPane.</span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Display them."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">systemPane update]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪BrowseWindow under: &rsquo;Windows&rsquo;.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">BrowseWindow classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"CodeWindow"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;CodeWindow&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: PanedWindow<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;stdTemplates &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I am a paned window with a code pane to edit a method or a file.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">class: class selector: selector para: para formerly: oldpara </span><span style="font: 10pt serif">| codePane<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[codePane &larr; CodePane new class: class selector: selector para: nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self title: class title+ &rsquo; &rsquo; + selector with: codePane inVector at: stdTemplates.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self newframe; show.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">codePane showing: para; formerly: oldpara; from: codePane]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[stdTemplates &larr; (0⌾0 rect: 36⌾36) inVector]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">editTitle </span><span style="font: 10pt serif">[titleframe window flash]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">file: file </span><span style="font: 10pt serif">| filePane<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[filePane &larr; FilePane new file: file.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self title: file name with: filePane inVector at: stdTemplates.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self newframe; show.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">filePane showing: file contents asParagraph; from: filePane]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hardcopy: p </span><span style="font: 10pt serif">| pane [for⦂ pane from: panes do⦂ [pane hardcopy: p]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪CodeWindow under: &rsquo;Windows&rsquo;.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">CodeWindow classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"InspectWindow"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;InspectWindow&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: PanedWindow<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;variables&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;stdTemplates &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I am a paned window with a variable pane that displays the fields of an object and a code pane to display their values and to evaluate in their context.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[stdTemplates &larr; (0⌾0 rect: 12⌾36), (12⌾0 rect: 36⌾36)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">of: object </span><span style="font: 10pt serif">| instanceVarPane instanceValuePane safeVec n<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[instanceVarPane &larr; VariablePane new. instanceValuePane &larr; CodePane new.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self title: object class title<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">with: (instanceVarPane, instanceValuePane) at: stdTemplates.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self newframe; show.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">instanceVarPane to: instanceValuePane.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">instanceValuePane from: instanceVarPane.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">variables &larr; (Vector new: 16) asStream.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[object class is: VariableLengthClass⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ n from: object fields do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self identifier: n]]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">object class fieldNamesInto: self].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">safeVec &larr; Vector new: 2. safeVec all &larr; object.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">instanceVarPane names: (↪(self) concat: variables contents) values: safeVec wrt: false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">show: object </span><span style="font: 10pt serif">| fixedframe instanceVarPane instanceValuePane safeVec n<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[instanceVarPane &larr; VariablePane new. instanceValuePane &larr; CodePane new.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fixedframe &larr; 400⌾450 rect: 600⌾565.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self title: object class title<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">with: (instanceVarPane, instanceValuePane) at: stdTemplates.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self frame: (self fixframe: fixedframe); show.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">instanceVarPane to: instanceValuePane.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">instanceValuePane from: instanceVarPane.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">variables &larr; (Vector new: 16) asStream.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[object class is: VariableLengthClass⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ n from: object fields do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self identifier: n]]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">object class fieldNamesInto: self].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">safeVec &larr; Vector new: 2. safeVec all &larr; object.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">instanceVarPane names: (↪(self) concat: variables contents) values: safeVec wrt: false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Private</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">comment: s</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">called by of: via Class fieldNamesInto</span><span style="font: 10pt serif">"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">contents</span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">called by of: via Class fieldNamesInto</span><span style="font: 10pt serif">"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">identifier: s</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">called by of: via Class fieldNamesInto</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[variables next &larr; s]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">separator: c</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">called by of: via Class fieldNamesInto</span><span style="font: 10pt serif">"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">trailer: s</span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">called by of: via Class fieldNamesInto</span><span style="font: 10pt serif">"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪InspectWindow under: &rsquo;Windows&rsquo;.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">InspectWindow classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"NotifyWindow"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;NotifyWindow&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: PanedWindow<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;enoughpanes&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;bigTemplates smallFrame smallTemplates &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I am a paned window with one or six panes that display the context of an error or breakpoint.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[smallTemplates &larr; (0⌾0 rect: 36⌾36) inVector.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bigTemplates &larr; (0⌾0 rect: 12⌾18), (12⌾0 rect: 36⌾18), (0⌾18 rect: 12⌾27), (12⌾18 rect: 36⌾27), (0⌾27 rect: 12⌾36), (12⌾27 rect: 36⌾36).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">smallFrame &larr; 204⌾366 rect: 404⌾402]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">of: titleString level: level interrupt: flag </span><span style="font: 10pt serif">| stackPane<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[NotifyFlag &larr; false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">stackPane &larr; StackPane new.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self title: titleString with: stackPane inVector at: smallTemplates.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">smallFrame moveto:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[level&gt;1⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[300⌾50]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(user screenrect center-(smallFrame extent/2))].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self frame: (self fixframe: smallFrame); show.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">stackPane context: false at: level instance: false code: false;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">interrupt: flag.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">stackPane of: (Top◦level) inVector. NotifyFlag &larr; true]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">of: titleString stack: stack interrupt: flag </span><span style="font: 10pt serif">| stackPane<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[NotifyFlag &larr; false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">stackPane &larr; StackPane new.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self title: titleString with: stackPane inVector at: smallTemplates.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">smallFrame moveto:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[Top currentPriority&gt;1⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[300⌾50]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(user screenrect center-(smallFrame extent/2))].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self frame: (self fixframe: smallFrame); show.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">stackPane context: false instance: false code: false; interrupt: flag.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">stackPane of: stack inVector. NotifyFlag &larr; true]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Window protocol</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">aboutToFrame<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[enoughpanes &larr; panes length = 6. super aboutToFrame]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">enter </span><span style="font: 10pt serif">| stackPane codePane contextVarPane contextValuePane instanceVarPane instanceValuePane<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[enoughpanes⇒ [super enter]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">NotifyFlag &larr; false.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Create the remaining five panes."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">stackPane &larr; panes◦1. codePane &larr; CodePane new.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">contextVarPane &larr; VariablePane new. contextValuePane &larr; CodePane new.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">instanceVarPane &larr; VariablePane new. instanceValuePane &larr; CodePane new.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Create the six-paned window."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self title: title<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">with: (stackPane, codePane, contextVarPane, contextValuePane, instanceVarPane, instanceValuePane)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">at: bigTemplates.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self frame: frame; show.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Initialize the six panes."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">stackPane context: contextVarPane instance: instanceVarPane code: codePane.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">codePane from: stackPane.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">contextVarPane to: contextValuePane. contextValuePane from: contextVarPane.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">instanceVarPane to: instanceValuePane. instanceValuePane from: instanceVarPane.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">stackPane select: 0; deselected; fill. enoughpanes &larr; NotifyFlag &larr; true]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪NotifyWindow under: &rsquo;Windows&rsquo;.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">NotifyWindow classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"ProjectWindow"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;ProjectWindow&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Window<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;userview parent changes&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;actionMenu &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>A ProjectWindow represents its userview as a window to provide access to many UserViews, each for a different "project".  Besides the state in the userview, they also carry their own hashset for changes, so that such changes can be maintained on a per-project basis.  parent specifies another ProjectWindow to which control is given when the user leaves the current userview</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Changing views</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">install</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">Establish this project and its userview as the current screen view</span><span style="font: 10pt serif">"</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[Changes&larr; changes.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(user&larr; userview) install.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self putTitle.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user restart]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">putTitle<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ [titlepara≡nil⇒[titlepara&larr; &rsquo;Top View&rsquo; asParagraph allBold]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">titleframe put: titlepara<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">centered: user screenrect extent x/3⌾8.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">titleframe outline]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">runParent</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">leave this view by installing the one above</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[parent install]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Window behavior</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">close</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"break circular links"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[userview&larr; parent&larr; nil]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">yellowbug<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[actionMenu bug=1⇒[self install]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[actionMenu &larr; Menu new string: &rsquo;enter&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"a new window"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self userview: (user copyIn: self)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">changes: HashSet init<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">parent: user projectWindow.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self newframe; show]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">userview: userview changes: changes parent: parent</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"load state"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪ProjectWindow under: &rsquo;Windows&rsquo;.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">ProjectWindow classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"SyntaxWindow"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;SyntaxWindow&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: PanedWindow<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;stdFrame stdTemplates &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I am a paned window with a stack pane and a code pane to report errors during non-interactive compilations, e.g., filin, ⓢ, understands.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[stdTemplates &larr; (0⌾0 rect: 12⌾36), (12⌾0 rect: 36⌾36).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">stdFrame &larr; 60⌾320 rect: 570⌾500]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">of: errorString at: position in: stream for: class from: context </span><span style="font: 10pt serif">| stackPane codePane<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[stackPane &larr; StackPane new.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">codePane &larr; CodePane new class: class selector: nil para: nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self title: class title with: (stackPane, codePane) at: stdTemplates.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">stdFrame moveto: (user screenrect center-(stdFrame extent/2)).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self frame: (self fixframe: stdFrame); show.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">stackPane context: false instance: false code: codePane.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">stackPane of: context inVector.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">codePane showing: stream asArray.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">codePane from: stackPane; notify: errorString at: position in: stream]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪SyntaxWindow under: &rsquo;Windows&rsquo;.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SyntaxWindow classInit</span></div>
    <div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">&rsquo;From Smalltalk 5.5k XM November 24 on 22 November 1980 at 2:57:08 am.&rsquo;<br></span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">"CodePane"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;CodePane&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Window<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;pared class selector selectorPane scrollBar&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;editmenu &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I am a Window for editing a paragraph which may include Smalltalk source code.  My selectorPane (not necessarily of class SelectorPane, and possibly even myself) compiles and doits for me.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">class: class selector: selector para: para</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[editmenu &larr; Menu new string:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;again<br>copy<br>cut<br>paste<br>doit<br>compile<br>undo<br>cancel<br>align&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">from: selectorPane</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">showing: paragraph<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pared &larr; ParagraphEditor new para: paragraph asParagraph frame: nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pared formerly: false; fixframe: frame.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self windowenter.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">scrollBar &larr; ([scrollBar≡nil⇒ [ScrollBar new] scrollBar]) on: frame from: pared]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Window protocol</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">close<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pared unselect. selectorPane &larr; pared &larr; nil. scrollBar close]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">doit </span><span style="font: 10pt serif">| s val d [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">d &larr; [user leftShiftKey⇒ [mem◦067] false].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[d⇒ [mem◦067 &larr; 58]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">scrollBar hide.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">do automatic selection (ESC) on empty selections</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(s &larr; pared selectRange) empty⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pared unselect; fintype; complement.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s &larr; pared selectRange]].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">val &larr; selectorPane execute: pared selectionAsStream for: self. <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[val≡nil or⦂ s ≠ pared selectRange⇒ ["</span><span style="font: italic 10pt serif">result is nil or error occurred</span><span style="font: 10pt serif">"]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">automatically paste result</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s&larr; s stop+1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pared Scrap &larr; [(String new: 100) asStream<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">space; print: val; contents asParagraph];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">selectRange: (s to: s); paste].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">scrollBar show.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">d⇒ [mem◦067 &larr; d]<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">eachtime </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user kbck⇒ [⇑self kbd]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">frame has: user mp⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user anybug⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user redbug⇒ [⇑self redbug]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user yellowbug⇒ [⇑self yellowbug]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user bluebug⇒ [⇑false]]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user anykeys⇒ [⇑self keyset]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self outside]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">enter<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[scrollBar show]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">frame &larr; frame<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Change my frame and that of my pared (if any)."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pared≡nil⇒ [] pared frame &larr; frame.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">scrollBar on: frame from: pared]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hardcopy: pf </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"if this is just part of a CodeWindow, then print entire Paragraph with no frame.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">unfortunately, the test for this is a kludge. otherwise, print clipped"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">selectorPane ≡ self⇒ [(PressPrinter init) press: pf; print: pared contents]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">frame hardcopy: pf thickness: 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pared hardcopy: pf]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">kbd<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pared typing]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">keyset<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑pared keyset]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">leave<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[scrollBar hide]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">outline<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[frame outline: 1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">outside<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑scrollBar startup]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">picked<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑frame has: user mp]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">redbug<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑pared selecting]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">show<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[frame outline. pared show]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">windowenter<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self outline. pared enter]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">windowleave<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pared≡nil⇒[] pared leave]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">yellowbug<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[editmenu bug<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=5⇒[self doit];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=1⇒[scrollBar hidewhile⦂ [pared again]];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=2⇒[pared copy];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=3⇒[pared cut];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=4⇒[pared paste];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=6⇒[pared formerly⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[scrollBar hidewhile⦂ [selectorPane compile: pared contents⇒ [pared formerly: false]]]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">  frame flash];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=7⇒[pared undo];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=8⇒[pared formerly⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pared Deletion &larr; pared contents.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">scrollBar hidewhile⦂ [self showing: pared formerly]] frame flash];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=9⇒[pared realign]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Browse/Notify protocol</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">compile: parag</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"as my own selectorPane"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self compile: parag in: class under: &rsquo;As yet unclassified&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">compile: parag in: defaultClass under: category<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑Generator new<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">compile: parag<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">in: [class≡nil⇒ [defaultClass] class]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">under: category<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">notifying: self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">contents<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑pared contents]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dirty<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pared formerly⇒ [⇑frame] ⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">execute: parseStream for: codePane</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"as my own selectorPane"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self execute: parseStream in: false to: nil]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">execute: parseStream in: context to: receiver<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑Generator new evaluate: parseStream in: context to: receiver notifying: self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">formerly: oldpara </span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"should not be called before &rsquo;showing:&rsquo;"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pared formerly: oldpara]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">interactive<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑true]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">notify: errorString at: position in: stream<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pared<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">fintype;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">selectRange: (position to: position);<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">replace: (&rsquo;➲&rsquo; + errorString + &rsquo;➲.&rsquo;) asParagraph;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">selectAndScroll.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">oldContents<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑pared formerly]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">reflects: selection  </span><span style="font: italic 10pt serif">"am I trying to show the code of selectorPaneⓢ selection?"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑class≡nil and⦂ selection&gt;0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">selectRange: r </span><span style="font: 10pt serif">[pared selectRange: r; selectAndScroll]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪CodePane under: &rsquo;Panes and Menus&rsquo;.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">CodePane classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"FilePane"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;FilePane&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: CodePane<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;file&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;editmenu &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>This class has not yet been commented</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>As yet unclassified</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit </span><span style="font: 10pt serif">"FilePane classInit."</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[editmenu &larr; Menu new string:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;again<br>copy<br>cut<br>paste<br>doit<br>put<br>undo<br>get<br>align&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">file: file</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">yellowbug<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[editmenu bug<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=1⇒[pared again];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=2⇒[pared copy];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=3⇒[pared cut];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=4⇒[pared paste];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=5⇒[self doit];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=6⇒[pared formerly⇒ [user displayoffwhile⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">file readwriteshorten; reset; append: pared contents; close.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pared formerly: false]]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">frame flash];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=7⇒[pared undo];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=8⇒[user displayoffwhile⦂ [scrollBar hidewhile⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self showing: file contents asParagraph]]];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=9⇒[pared realign]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪FilePane under: &rsquo;Panes and Menus&rsquo;.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">FilePane classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"ListPane"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;ListPane&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Textframe<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;list firstShown lastShown selection scrollBar&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>A list pane displays a vertical list of one-line items.  The list can be scrolled slow or fast, and any item can be selected.  When an item is selected (or deselected), a dependent pane can be told to display appropriate material.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">of: list </span><span style="font: 10pt serif">"Acquire the specified list and show me scrolled to the top"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[firstShown&larr; selection&larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self frame&larr; window.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self fill; deselected]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">revise: newlist with: sel  </span><span style="font: 10pt serif">| changing<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Acquire newlist. Do not change firstShown. Select sel if in list."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[changing &larr; list≠newlist⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[list &larr; newlist.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">firstShown &larr; firstShown min: (<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">list length+2  - (window height-4/self lineheight) max: 0).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[nil ≠ para⇒ [para &larr; para asStream]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self fill]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> selection&gt;0⇒ [changing &larr; list◦selection≠sel⇒ [self compselection]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> changing &larr; true].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">changing⇒ [selection &larr; ¬1. self select: (list find: sel)]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">select: lineNum </span><span style="font: 10pt serif">| oldSel<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Select my non-dummy displayed entry whose subscript is lineNum; highlight it; if it is different from selection, tell me to select.  If there is no such entry, set selection to 0 and if it wasnt 0 before, tell me to deselect."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">oldSel &larr; selection.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(1 max: firstShown) ≤ lineNum and⦂ lineNum ≤ (list length min: lastShown)⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[selection &larr; lineNum. self compselection. oldSel≠selection⇒ [self selected]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">selection &larr; 0. oldSel≠selection⇒ [self deselected]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Pane protocol</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">close</span><span style="font: bold italic 10pt serif"> </span><span style="font: italic 10pt serif">"Zero my selection so it wont be grayed when I close.  Break cycles."</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[selection&larr;0. scrollBar close]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">eachtime<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[window has: user mp⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user kbck⇒[⇑self kbd]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user anybug⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user redbug⇒[⇑self redbug]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user yellowbug⇒[⇑self yellowbug]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user bluebug⇒[⇑false]]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user anykeys⇒[⇑self keyset]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self outside]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">enter<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[scrollBar show]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">firsttime<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[window has: user mp⇒[self enter]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">frame &larr; window </span><span style="font: italic 10pt serif">"(Re)initialize my window"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[para &larr; nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">scrollBar &larr; ([scrollBar≡nil⇒ [ScrollBar new] scrollBar]) on: window from: self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hardcopy: pf </span><span style="font: 10pt serif">| t cr first last lasty lineNum parag left right lineheight [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">window hardcopy: pf thickness: 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[para≡nil⇒ [self makeParagraph]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">parag &larr; para asParagraph.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">t &larr; para asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">last &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">cr &larr; 015.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">left &larr; frame minX.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">right &larr; window maxX.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">lasty &larr; frame minY.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">lineheight &larr; self lineheight.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ lineNum from: firstShown to: lastShown do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">first &larr; last.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(t skipTo: cr) or⦂ lineNum = lastShown⇒ [last &larr; t position]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: &rsquo;not enough lines&rsquo;].<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[lineNum = selection and⦂ selection &gt; 0⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"outline selection; complementing doesn&rsquo;t look good"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(self selectionRect-(0⌾1) inset: 0⌾1) hardcopy: pf thickness: 1]].<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(parag copy: first+1 to: last-1) presson: pf in:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(pf transrect: (left ⌾ lasty rect: right ⌾ (lasty+lineheight+4))) style: style.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">lasty &larr; lasty + lineheight.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">kbd<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[window flash. user kbd.]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">keyset </span><span style="font: 10pt serif">| c<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"As long as any keyset keys are down, react to keys 2 and 8 down by scrolling up or down a line at a time.  If key 4 is down as well, scroll faster."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">c &larr; user currentCursor.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self scrollControl⦂ [user keyset=6⇒[2]; =12⇒[¬2]; =2⇒[1]; =8⇒[¬1] 0].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">c show]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">lasttime<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self leave]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">leave<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[scrollBar hide]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">outline<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[window outline: 1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">outside </span><span style="font: 10pt serif">[⇑scrollBar startup]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">picked<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑window has: user mp]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">redbug </span><span style="font: 10pt serif">| newSel f</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Deselect selection and select cursor item, if any"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[f &larr; self locked⇒ []<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self compselection.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">newSel &larr; (user mp y - window origin y)/self lineheight + firstShown.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">XeqCursor showwhile⦂ [self select: [newSel = selection⇒ [0] newSel]]].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ (user redbug and⦂ (window has: user mp)) do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">f⇒ [f flash. self compselection; compselection]]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">scrollPos<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[firstShown≡nil or⦂ list length=0⇒[⇑0.0]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑firstShown asFloat/list length]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">scrollTo: f | t</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self scrollControl⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t&larr; (f*list length) asInteger - firstShown.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">t&lt;0⇒[firstShown&lt;0⇒[0] t]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">lastShown&gt;list length⇒[0] t]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">windowenter </span><span style="font: italic 10pt serif">"Refresh my image.  Reaffirm selection."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self outline; fill; select: selection.]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">windowleave<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self compselection; grayselection]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">yellowbug<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[window flash]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Subclass defaults</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">deselected </span><span style="font: italic 10pt serif">"I just lost my selection.  I dont care, but my subclasses might."</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dirty </span><span style="font: italic 10pt serif">"My subclasses may want to prohibit a change of selection"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">locked </span><span style="font: italic 10pt serif">"My subclasses may want to prohibit a change of selection"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑[selection=0⇒ [false] self dirty]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">selected </span><span style="font: italic 10pt serif">"A new selection is highlighted.  I dont care, but my subclasses might"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Private</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">compselection </span><span style="font: italic 10pt serif">"If I have a selection, complement its image."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[selection≠0⇒ [self selectionRect comp]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dummy<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑&rsquo;▱▱▱▱▱▱▱&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fill </span><span style="font: 10pt serif">[self makeParagraph; show]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">grayselection<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[selection≠0⇒ [self selectionRect color: ltgray mode: oring]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self para: nil frame: nil.]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">makeParagraph </span><span style="font: 10pt serif">| i len s lines </span><span style="font: italic 10pt serif">"Given firstShown, compute lastShown."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">len &larr; list length.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">lastShown &larr; firstShown-1 + (lines &larr; window height-4/self lineheight)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">min: 1+len.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self locked⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[i &larr; (selection-lastShown max: 0) + (selection-firstShown min: 0).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">i≠0⇒ [para&larr;nil. firstShown &larr; firstShown + i. lastShown &larr; lastShown + i]]].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(frame &larr; window inset: 2) width &larr; 999.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">para is: String⇒ ["</span><span style="font: italic 10pt serif">if para is a String, refresh from it directly</span><span style="font: 10pt serif">"]<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"otherwise compute para."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s &larr; [para≡nil⇒ [(String new: 200) asStream] para].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: firstShown to: lastShown do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[0&lt;i and⦂ i≤len⇒ [lines &larr; lines-1. (list◦i) printon: s]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s append: self dummy].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s cr].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: (lines+1 min: s limit - s position) do⦂ [s cr].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">para &larr; s asArray]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">scrollBy⦂ expr copying: src into: dest showing: item in: frame direction: n<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| strm final stop pt delay chars locked t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strm &larr; Stream new. chars &larr; 2*frame width/self lineheight. para &larr; String new: chars.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pt &larr; dest origin. final &larr; [n&lt;0⇒ [0] list length+1].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">stop &larr; [locked&larr;self locked⇒ [0 max: (list length+1 min: (lastShown - firstShown * n sign + selection))] final].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ item≠stop do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[firstShown &larr; firstShown + n. lastShown &larr; lastShown + n. item &larr; item + n.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm of: para from: 1 to: chars.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[item≠final⇒ [(list◦item) printon: strm] self dummy copyto: strm].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm cr. src blt: pt mode: storing. self show.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(t&larr; expr eval) abs ≤1⇒ [for⦂ delay to: chars/4 do⦂ [strm myend]. para &larr; nil. ⇑self]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">t*n&lt;0⇒[⇑self]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">para &larr; nil. locked and: stop≠final⇒ [locked flash. ⇑false]]</span><span style="font: bold 10pt serif"><br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">scrollControl⦂ expr<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| dY onlyFirst butFirst onlyLast butLast x1 x2 y1 y2 y3 y4 k<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Selection is highlighted.  Unhighlight it.  Invalidate my saved para if I scroll.  Then reselect selection, or deselect if it is no longer displayed."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self compselection. dY &larr; self lineheight.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">x1 &larr; window origin x. x2 &larr; window corner x.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">y1 &larr; window origin y+2. y4 &larr; window height-4 |dY + y1. y2&larr;y1+dY. y3&larr;y4-dY.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">onlyFirst &larr; x1+2⌾y1 rect: 2000⌾y2. butFirst &larr; x1⌾y2 rect: x2⌾y4.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">onlyLast &larr; x1+2⌾y3 rect: 2000⌾y4. butLast &larr; x1⌾y1 rect: x2⌾y3.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ (k&larr;expr eval)≠0 do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[k&gt;0⇒[UpCursor topage1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self scrollBy⦂ expr eval copying: butFirst into: butLast showing: lastShown<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">in: onlyLast direction: 1⇒[] ⇑self select: selection]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">DownCursor topage1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self scrollBy⦂ expr eval copying: butLast into: butFirst showing: firstShown<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">in: onlyFirst direction: ¬1⇒[] ⇑self select: selection].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self select: selection]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">scrollUp: n </span><span style="font: 10pt serif">| c<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[c &larr; window origin x-20.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self scrollControl⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user buttons=4⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user mp x &gt; c⇒[2] ¬2]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">0]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">selectionRect </span><span style="font: 10pt serif">| h w<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"I have a selection.  Return its highlighting rectangle."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(w &larr; window inset: 2) height &larr; h &larr; self lineheight. <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑w + (0⌾(selection-firstShown *h))]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪ListPane under: &rsquo;Panes and Menus&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"ClassPane"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;ClassPane&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: ListPane<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;systemPane organizationPane&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;editmenu &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I am a list pane that displays the names of all the classes of a category</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[editmenu &larr; Menu new string: &rsquo;filout<br>print<br>forget&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">from: systemPane to: organizationPane</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Window protocol</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">close<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[systemPane &larr; nil. super close]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">yellowbug<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">If there is a selection, let the user choose a command from the menu.</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">selection=0⇒ [window flash]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">editmenu bug<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=1⇒ ["</span><span style="font: italic 10pt serif">filout</span><span style="font: 10pt serif">" (Smalltalk◦(list◦selection)) filout];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=2⇒ ["</span><span style="font: italic 10pt serif">print</span><span style="font: 10pt serif">" (Smalltalk◦(list◦selection)) printout];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=3⇒ ["</span><span style="font: italic 10pt serif">forget</span><span style="font: 10pt serif">" systemPane forget: list◦selection]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>ListPane protocol</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">deselected<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"I just lost my selection.  Tell organizationPane to display nothing."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">organizationPane class: nil.]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">selected<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"My selection just changed.  Tell organizationPane to display the categories of my newly selected Class."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">organizationPane class: Smalltalk◦(list◦selection).]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Browser protocol</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">compile: parag<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[systemPane compile: parag]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dirty<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑organizationPane dirty]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">noCode<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[selection=0⇒ [⇑systemPane noCode] ⇑&rsquo;&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪ClassPane under: &rsquo;Panes and Menus&rsquo;.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">ClassPane classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"Menu"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;Menu&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;str text thisline frame&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I am a list of text lines one of which can be selected with the pointing device</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">rescan </span><span style="font: italic 10pt serif">" | each. Menu allInstances notNil transform⦂ each to⦂ each rescan."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self string: str]</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"rescan (for new fonts, lineheight)"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">string: str </span><span style="font: 10pt serif">|  i pt tpara<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[str last≠13⇒[str&larr;str+&rsquo;<br>&rsquo;]].</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"make sure str ends with CR"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">text &larr; Textframe new para: (tpara &larr; str asParagraph)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">frame:  (Rectangle new origin: (pt &larr;  0 ⌾ 0)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">corner: 1000 ⌾ 1000).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pt &larr; text maxx: str length+1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">text frame growto: pt + (4 ⌾ 0).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tpara center.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">frame &larr; text frame inset: ¬2  ⌾ ¬2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">thisline &larr; Rectangle new origin: text frame origin<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">corner: text frame corner x ⌾ text lineheight]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">stringFromVector: v </span><span style="font: 10pt serif">| s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["DW classInit"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s &larr; Stream default.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ v from: v do⦂ [s append: v; cr].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self string: s contents]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>User interactions</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">bug </span><span style="font: 10pt serif">| index bits<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[bits &larr; self movingsetup.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"set up and save background"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">index &larr; self bugit.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"get the index"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">frame bitsFromString: bits.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"restore background"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ index</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"return index"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">clear<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[frame clear]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fbug </span><span style="font: 10pt serif">| index<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"for fixed menus"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">index &larr; self bugit.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"get the index"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ index</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"return index"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">frame<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑ frame]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">has: pt<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑ text frame has: pt]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">moveto: pt<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self clear.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">frame moveto: pt.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">text frame moveto: pt+2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">thisline moveto: pt+2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">rebug<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user waitbug. </span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"wait for button down again"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑</span><span style="font: italic 10pt serif">"bugcursor showwhile⦂"</span><span style="font: 10pt serif"> self bug]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">show<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[frame clear: black. text show.]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">wbug </span><span style="font: 10pt serif">| index bits [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"save background, display menu"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bits &larr; self movingsetup.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"wait until a mouse button is down"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ user anybug do⦂ [].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"get selection (possibly 0)"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">index &larr; self bugit.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"restore background"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">frame bitsFromString: bits.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ index<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">zbug </span><span style="font: 10pt serif">| index bits<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[bits &larr; self movingsetup.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ (index &larr; self bugit) = 0 do⦂ [].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">frame bitsFromString: bits.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ index<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Internal</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">bugit </span><span style="font: 10pt serif">| pt bits<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user nobug ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑0]</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"accidental bug returns 0"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">thisline comp.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ true do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[text frame has: (pt &larr; user mp) ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user anybug⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[thisline has: pt⇒[]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pt &larr; text ptofpt: pt.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">thisline comp.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"selection follows mouse"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">thisline moveto: text frame origin x  ⌾ pt y.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">thisline comp]<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑1+ (thisline origin y-text frame origin y<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">/ text lineheight)</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"return index"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">thisline comp. </span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"he left the menu"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ [text frame has: user mp] do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user nobug⇒[⇑0]] </span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"return 0 for abort"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">thisline comp]</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"he came back"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">movingsetup </span><span style="font: 10pt serif">| pt bits<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pt &larr; user mp - thisline center.</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"center prev item on mouse"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">text frame moveby: pt. thisline moveby: pt.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">frame moveby: pt.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bits &larr; frame bitsIntoString.</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"save background"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">frame clear: black. text show.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ bits<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪Menu under: &rsquo;Panes and Menus&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"OrganizationPane"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;OrganizationPane&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: ListPane<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;classPane selectorPane class&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;editmenu &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I am a list pane that displays the selector categories of a class.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">class: class<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self of: (self listFor: class)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[editmenu &larr; Menu new string: &rsquo;filout<br>print&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">from: classPane to: selectorPane</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">listFor: class<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑[class≡nil⇒ [Vector new: 0]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">↪(ClassDefinition ClassOrganization) concat: class organization categories]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Window protocol</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">close<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[classPane &larr; nil. super close]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">yellowbug<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["If there is a selection, let the user choose a command from the menu."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">selection≤1⇒ [window flash]</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"Can&rsquo;t filout or print definition by itself"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">editmenu bug<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=1⇒ ["filout the selected category"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">selection=2⇒ [class filoutOrganization]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">class filoutCategory: list◦selection];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=2⇒ ["print the selected category"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">selection=2⇒ [window flash]</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"Can&rsquo;t print organization"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">class printoutCategory: list◦selection]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>ListPane protocol</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">deselected<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"I just lost my selection.  Tell selectorPane to display nothing."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">selectorPane of: (Vector new: 0)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">selected<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[selectorPane of: [selection≤2⇒ [Vector new: 0] class organization category: list◦selection]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Browser protocol</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">code: selector<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑class code: selector]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">compile: parag<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| sel cat<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[class≡nil or⦂ selection=1⇒ [classPane compile: parag] </span><span style="font: italic 10pt serif">"new definition"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">selection=2⇒ [class organization fromParagraph: parag. self class: class] </span><span style="font: italic 10pt serif">"new organization"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">cat &larr; [selection=0⇒ [&rsquo;As yet unclassified&rsquo;] list◦selection].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sel &larr; selectorPane compile: parag in: class under: cat⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self revise: (self listFor: class) with: cat.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">selection≠0⇒ [selectorPane revise: (class organization category: cat) with: sel]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dirty<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑selectorPane dirty]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">execute: parag<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑classⓢ parag]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">forget: selector </span><span style="font: 10pt serif">| cat<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[class derstands: selector.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">cat &larr; list◦selection.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self revise: (self listFor: class) with: cat.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">selection&gt;0⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[selectorPane revise: (class organization category: cat) with: selector]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">noCode<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[class≡nil⇒ [⇑classPane noCode]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">selection=0⇒ [⇑&rsquo;&rsquo;]; =1⇒ [⇑class definition]; =2⇒ [⇑class organization]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑&rsquo;Message name and Arguments | Temporary variables "short comment"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["long comment if necessary"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Smalltalk<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Statements]&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">spawn: selector with: parag formerly: oldparag<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[selectorPane compselection; select: 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">class edit: selector para: parag formerly: oldparag]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪OrganizationPane under: &rsquo;Panes and Menus&rsquo;.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">OrganizationPane classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"ScrollBar"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;ScrollBar&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;rect bitstr owner position&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;DownCursor UpCursor JumpCursor &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I am a bar to the left of an awake window.  With the cursor in me I can make that window scroll.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[UpCursor &larr; Cursor new fromtext: &rsquo;<br>1000000000000000<br>1100000000000000<br>1110000000000000<br>1111000000000000<br>1111100000000000<br>1111110000000000<br>1100000000000000<br>1100000000000000<br>1100000000000000<br>1100000000000000<br>1100000000000000<br>1100000000000000<br>1100000000000000<br>1100000000000000<br>1100000000000000<br>1100000000000000&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DownCursor &larr; Cursor new fromtext: &rsquo;<br>1100000000000000<br>1100000000000000<br>1100000000000000<br>1100000000000000<br>1100000000000000<br>1100000000000000<br>1100000000000000<br>1100000000000000<br>1100000000000000<br>1100000000000000<br>1111110000000000<br>1111100000000000<br>1111000000000000<br>1110000000000000<br>1100000000000000<br>1000000000000000&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">JumpCursor &larr; Cursor new fromtext: &rsquo;<br>0111000000000000<br>1111100000000000<br>1111100000000000<br>0111000000000000<br>0000000000000000<br>0000000000000000<br>0000000000000000<br>0000000000000000<br>0000000000000000<br>0000000000000000<br>0000000000000000<br>0000000000000000<br>0000000000000000<br>0000000000000000<br>0000000000000000<br>0000000000000000&rsquo; offset: 2⌾1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">on: f from: o<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self on: f from: o at: o scrollPos]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">on: frame from: owner at: f<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[rect &larr; Rectangle new<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">origin: frame origin-(32⌾2)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">extent: 32⌾(frame height+4).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">position &larr; Rectangle new<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">origin: rect origin+(9⌾4)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">extent: 16⌾8.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self boxPosition&larr; f]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Scheduling</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">close<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[owner&larr;nil]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">eachtime </span><span style="font: 10pt serif">| p cx r</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">This needs to be restructured</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[rect has: (p&larr; user mp)⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[cx &larr; rect center x - 2.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">p x &lt; cx⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[r &larr; Rectangle new origin: rect origin corner: cx⌾rect maxY.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">DownCursor showwhile⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[while⦂ (r has: (p&larr;user mp)) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self slide: p⇒[owner scrollTo: (position minY-rect minY-4) asFloat/(rect height-12)]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user redbug⇒[self reposition⦂[owner scrollUp: rect origin y - p y]]]]]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">r &larr; Rectangle new origin: cx⌾rect minY corner: rect corner.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">UpCursor showwhile⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[while⦂ (r has: (p&larr;user mp)) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self slide: p⇒[owner scrollTo: (position minY-rect minY-4) asFloat/(rect height-12)]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user redbug⇒[self reposition⦂[owner scrollUp: p y - rect origin y]]]]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">firsttime</span><span class="tab" val="79"></span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑rect has: user mp]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">lasttime</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">slide: p </span><span style="font: 10pt serif">| bug<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[position has: p⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[JumpCursor showwhile⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[bug &larr; false.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ ((position has: user mp) and⦂ bug≡false) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user redbug⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[bug &larr; true.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ user redbug do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self reshow⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[position moveto: position origin x⌾<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">((user mp y max: rect origin y+4) min: rect corner y-12)]]]]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑bug]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Image</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">boxPosition&larr; f<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[position moveto: rect origin+<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(9⌾(4+(([f&lt;0.0⇒[0.0]; &gt;1.0⇒[1.0] f])*(rect height-16))))]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hide </span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">restore background</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[bitstr≡nil⇒ [user notify: &rsquo;Attempt to hide unshown scrollbar&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rect bitsFromString: bitstr.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitstr &larr; nil]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hidewhile⦂ expr  </span><span style="font: 10pt serif">| v<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self hide. v &larr; expr eval. self show. ⇑v]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">reposition⦂ expr<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self reshow⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[expr eval.  self boxPosition&larr; owner scrollPos]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">reshow⦂ expr </span><span style="font: 10pt serif">| r<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[r &larr; position inset: ¬2.  expr eval.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">r clear: white.  position outline]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">show</span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">Save background and turn gray</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[bitstr &larr; rect bitsIntoString.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rect clear: black.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(rect inset: 2⌾2 and: 1⌾2) clear: white.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">position outline]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪ScrollBar under: &rsquo;Panes and Menus&rsquo;.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">ScrollBar classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"SelectorPane"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;SelectorPane&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: ListPane<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;organizationPane codePane&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;editmenu &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I am a ListPane whose entries are the message selectors of a category within a class.  Only organizationPane knows what the class and category are.  I make codePane display the code of my selected selector, if any.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[editmenu &larr; Menu new string:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;spawn<br>forget&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">from: organizationPane to: codePane</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Window protocol</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">close<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[organizationPane &larr; nil. super close]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">yellowbug<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[selection=0⇒ [window flash]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">scrollBar hidewhile⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[editmenu bug<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=1⇒ [organizationPane spawn: list◦selection with: codePane contents<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">formerly: codePane oldContents];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=2⇒ [organizationPane forget: list◦selection]]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>ListPane protocol</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">deselected<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[codePane showing: organizationPane noCode]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">selected<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[codePane showing: (organizationPane code: list◦selection)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Browser protocol</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">compile: parag<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑organizationPane compile: parag]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">compile: parag in: class under: heading<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑codePane compile: parag in: class under: heading]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dirty<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑codePane dirty]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">execute: parseStream for: codePane<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑codePane execute: parseStream in: false to: nil]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪SelectorPane under: &rsquo;Panes and Menus&rsquo;.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SelectorPane classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"StackPane"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;StackPane&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: ListPane<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;contextVarPane instanceVarPane codePane variables proceed&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;stackmenu &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I am a list pane that displays one or all of the stack below a context in a notify window.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[stackmenu &larr; Menu new string:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;stack<br>spawn<br>proceed<br>restart&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">context: contextVarPane at: level instance: instanceVarPane code: codePane<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[variables &larr; (Vector new: 16) asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> proceed≡nil⇒[proceed &larr; (false, nil, level)]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">context: contextVarPane instance: instanceVarPane code: codePane<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[variables &larr; (Vector new: 16) asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> proceed≡nil⇒[proceed &larr; (false, nil, Top currentPriority)]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">interrupt: flag<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[proceed◦1 &larr; flag]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Window protocol</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">close<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[Top enable: proceed◦3. super close. list⇒ [(list◦1) releaseFully]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">yellowbug<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[scrollBar hidewhile⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[stackmenu bug<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=1⇒ [</span><span style="font: italic 10pt serif">"show a full backtrace"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self revise: (list◦1) stack with: [selection=0⇒ [nil] list◦selection]];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=2⇒ [</span><span style="font: italic 10pt serif">"spawn a code editor"</span><span style="font: 10pt serif"> self spawn];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=3⇒ [</span><span style="font: italic 10pt serif">"return to selected context"</span><span style="font: 10pt serif"> self continue: false];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=4⇒ [</span><span style="font: italic 10pt serif">"restart selected context"</span><span style="font: 10pt serif"> self continue: true]]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>ListPane protocol</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">deselected<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[contextVarPane ≡ false⇒ []<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">codePane showing: &rsquo;&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">contextVarPane names: (Vector new: 0) values: ↪(nil) wrt: false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">instanceVarPane names: (Vector new: 0) values: ↪(nil) wrt: false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">locked<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑contextVarPane and⦂ (selection&gt;0 and⦂ self dirty)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">selected </span><span style="font: 10pt serif">| context instance code safeVec<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[contextVarPane ≡ false⇒ []<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">context &larr; list◦selection. instance &larr; context receiver.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Decompiler new findPC: context pc.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">code &larr; self code.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">codePane showing: [code⇒ [code] &rsquo;&rsquo;].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">codePane selectRange: Decompiler new highlight.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">variables reset. context variableNamesInto: self with: nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[code⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[contextVarPane names: (↪(thisContext) concat: variables contents)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">values: (context, context tempframe) wrt: context.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> context tempframe≡nil⇒ [user notify: &rsquo;NIL TEMPFRAME&rsquo;]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> contextVarPane names: ↪(thisContext) values: context inVector wrt: context].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">variables reset. instance class fieldNamesInto: self.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">safeVec &larr; Vector new: 2. safeVec all &larr; instance.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">instanceVarPane names: (↪(self) concat: variables contents) values: safeVec wrt: context.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">contextVarPane select: 1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>NotifyWindow protocol</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">compile: parseStream </span><span style="font: 10pt serif">| ctxt selector method mcl<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ctxt &larr; list◦(selection max: 1). mcl &larr; ctxt mclass.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> proceed◦2 &larr; selector &larr;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">codePane compile: parseStream in: mcl under: &rsquo;As yet unclassified&rsquo;⇒<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> </span><span class="tab" val="79"></span><span style="font: 10pt serif">[codePane reflects: selection⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[method &larr; mcl md methodorfalse: selector⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self releaseAboveSelection.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> </span><span class="tab" val="79"></span><span style="font: 10pt serif">ctxt restartWith: method. proceed◦1 &larr; true.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> </span><span class="tab" val="79"></span><span style="font: 10pt serif">self of: list◦(selection to: list length) copy; select: 1]]]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dirty<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑codePane and⦂ codePane dirty]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">execute: parseStream for: codePane<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑proceed◦2 &larr;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">codePane execute: parseStream in: [selection=0⇒ [false] list◦selection] to: nil]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Private</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">code </span><span style="font: 10pt serif">| mclass selector </span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"code of my selected context"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[mclass &larr; (list ◦ selection) mclass.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">selector &larr; self selector.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑(mclass canunderstand: selector) and⦂ (mclass code: selector)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">comment: s</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"called by selected via Class fieldNamesInto"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">contents</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"called by selected via Class fieldNamesInto"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">continue: restarting </span><span style="font: 10pt serif">| ctxt<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Close my window and resume my selected context, if any, else my first context.  If interrupted (proceed◦1) or restarting or a recompiled method, don&rsquo;t return a value; otherwise, return proceed◦2."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user leftShiftKey ⇒[mem◦067 &larr; 58 "turn display off"]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[selection=0⇒ [selection&larr;1]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ctxt &larr; list◦selection.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self releaseAboveSelection.</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"release abandoned contexts"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[restarting⇒ [ctxt restart]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> proceed◦1 and: selection=1⇒ [</span><span style="font: italic 10pt serif">"resume after interrupt"</span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ctxt push: proceed◦2].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">list &larr; false. </span><span style="font: italic 10pt serif">"Inhibit me closing."</span><span style="font: 10pt serif"> user topWindow vanish.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">list &larr; nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[proceed◦3=1⇒[thisContext sender release]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Top run: ctxt at: proceed◦3.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Top enable: proceed◦3.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Top wakeup: proceed◦3.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Top resetCurrent]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">declaration: dummy1 name: string asArg: dummy2<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[variables next &larr; string]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">identifier: s</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"called by selected via Class fieldNamesInto"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[variables next &larr; s]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">notify: msg </span><span style="font: italic 10pt serif">"selected context doesnt know its variables"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">releaseAboveSelection<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[selection&gt;1⇒ [(list◦(selection-1)) sender &larr; nil. (list◦1) release</span><span style="font: italic 10pt serif">"Fully"</span><span style="font: 10pt serif">]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(list◦(selection max: 1)) verifyFrames]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">selector </span><span style="font: 10pt serif">| context<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[context &larr; list◦(selection max: 1).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑[context sender≡nil⇒ [false] context selector]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">separator: c</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"called by selected via Class fieldNamesInto"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">spawn </span><span style="font: 10pt serif">| mclass selector parag oldparag<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[mclass &larr; (list◦(selection max: 1)) mclass.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">selector &larr; self selector.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">parag &larr; [codePane⇒ [codePane contents] mclass canunderstand: selector⇒ [mclass code: selector] &rsquo;&rsquo;].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">oldparag &larr; [codePane⇒ [codePane oldContents] false].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self compselection; select: 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">mclass edit: selector para: parag formerly: oldparag]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">terminate </span><span style="font: italic 10pt serif">"called by parser close during initialization"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">trailer: s</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"called by selected via Class fieldNamesInto"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪StackPane under: &rsquo;Panes and Menus&rsquo;.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">StackPane classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"SystemPane"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;SystemPane&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: ListPane<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;mySysOrgVersion classPane&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;sysmenu &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I am a list pane in which all the system categories are displayed.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[sysmenu &larr; Menu new string: &rsquo;filout<br>print&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">to: classPane</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">update<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self of: (↪(AllClasses SystemOrganization) concat: SystemOrganization categories). mySysOrgVersion&larr;user classNames]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Window protocol</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">enter</span><span class="tab" val="79"></span><span style="font: bold 10pt serif"> </span><span style="font: italic 10pt serif">"be sure I am up to date"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[mySysOrgVersion≡user classNames⇒ [super enter]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">window outline. self update. super enter]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">leave</span><span class="tab" val="79"></span><span style="font: bold 10pt serif"> </span><span style="font: italic 10pt serif">"I am up to date"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[mySysOrgVersion &larr; user classNames. super leave]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">yellowbug<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[selection&lt;3⇒[window flash]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">scrollBar hidewhile⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[sysmenu bug<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=1⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[SystemOrganization filoutCategory: list◦selection];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=2⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[SystemOrganization printCategory: list◦selection]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>ListPane protocol</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">deselected<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[classPane of: (Vector new: 0)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">selected<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[classPane of: self classes]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Browser protocol</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classes </span><span style="font: italic 10pt serif">"return a Vector of the classes in my selected category"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[selection</span><span class="tab" val="79"></span><span style="font: 10pt serif">=1⇒ [⇑user classNames];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">≤2⇒ [⇑Vector new: 0]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑SystemOrganization category: list◦selection]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">compile: parag<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| class cat className<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[selection=2⇒ [SystemOrganization fromParagraph: parag. self update] </span><span style="font: italic 10pt serif">"new organization"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">cat &larr; [selection≤1⇒ [false] list◦selection].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">class &larr; nilⓢparag.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">class Is: Class⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[className &larr; class title unique.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[cat⇒ [SystemOrganization classify: className under: cat]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">mySysOrgVersion≡user classNames⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[selection&gt;0⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[classPane of: [cat⇒ [SystemOrganization category: cat] user classNames]]]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self update]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dirty<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑classPane dirty]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">forget: className<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user notify: &rsquo;Class &rsquo;+className+&rsquo; will disappear if you proceed...&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(Smalltalk◦className) noChanges; obsolete. Smalltalk delete: className.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">SystemOrganization delete: className.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">AllClassNames &larr; AllClassNames delete: className.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">classPane revise: self classes with: className]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">noCode<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[selection=0⇒ [⇑&rsquo;&rsquo;]; =2⇒ [⇑SystemOrganization]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑&rsquo;Class new title: &rsquo;&rsquo;NameOfClass&rsquo;&rsquo;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fields: &rsquo;&rsquo;names of fields&rsquo;&rsquo;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">declare: &rsquo;&rsquo;names of class variables&rsquo;&rsquo;&rsquo; copy]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪SystemPane under: &rsquo;Panes and Menus&rsquo;.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemPane classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"VariablePane"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;VariablePane&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: ListPane<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;valuePane values context&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;varmenu &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I am a list pane that displays the names of variables in a context or instance.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[varmenu &larr; Menu new string: &rsquo;inspect&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">names: vars values: values wrt: context<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self of: vars]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">to: valuePane<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Window protocol</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">yellowbug<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[selection=0⇒ [window flash]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">scrollBar hidewhile⦂ [varmenu bug =1⇒ [self value inspect]]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>ListPane protocol</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">deselected<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[valuePane showing: &rsquo;&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">selected<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[valuePane showing: self value asString]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Notify/Inspect protocol</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">compile: parag<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[window flash. ⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">execute: parseStream for: valuePane<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑valuePane execute: parseStream in: context to: values◦1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Private</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">value<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[selection=1⇒ [⇑values◦1] ⇑(values◦2) inspectfield: selection-1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪VariablePane under: &rsquo;Panes and Menus&rsquo;.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">VariablePane classInit</span></div>
    <div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">&rsquo;From Smalltalk 5.5k XM November 24 on 22 November 1980 at 2:57:08 am.&rsquo;<br></span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">"File"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;File&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Dict<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;directory type name serialNumber pageReaders pageBuffer lastpn error&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sharing: FilePool;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>A collection of FilePages usually on some device external to the virtual memory, which can be viewed and modified. File is a generalization: some examples are AltoFile and WoodstockFile. FilePage and FileDirectory are related classes. FileStream provides Stream access to Files.<br><br>Subclasses should override any superclass message implemented as [self subError]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Documentation</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">help </span><span style="font: 10pt serif">"<br><br>A common way to access a </span><span style="font: bold 10pt serif">File</span><span style="font: 10pt serif"> is through a </span><span style="font: bold 10pt serif">FileStream</span><span style="font: 10pt serif">.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">to create a FileStream on either an old or new file:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&lt;FileStream&gt; &larr; &lt;FileDirectory&gt; </span><span style="font: bold 10pt serif">file:</span><span style="font: 10pt serif"> &lt;String&gt;. (see also </span><span style="font: bold 10pt serif">oldFile:</span><span style="font: 10pt serif"> and </span><span style="font: bold 10pt serif">newFile:</span><span style="font: 10pt serif">)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">e.g. f &larr; dp0 file: &rsquo;test&rsquo;.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">The default access mode (</span><span style="font: bold 10pt serif">readwriteshorten</span><span style="font: 10pt serif">) allows you to read or write, and<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">automatically shorten a File (to its current position) upon closing).  If you want to<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">only read a file, </span><span style="font: bold 10pt serif">readonly</span><span style="font: 10pt serif"> mode is faster and safer.<br><br>Some common ways to access a FileStream (see </span><span style="font: bold 10pt serif">Stream</span><span style="font: 10pt serif"> and </span><span style="font: bold 10pt serif">FileStream</span><span style="font: 10pt serif">):<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">reading a character (an Integer between 0 and 255)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 10pt serif">next, ◦</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">reading a String of characters<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 10pt serif">upto:</span><span class="tab" val="79"></span><span style="font: bold 10pt serif">, next:, nextString, contents</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">reading other kinds of objects<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 10pt serif">nextword, word:, nextNumber:, nextParagraph</span><span style="font: 10pt serif"><br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">writing characters<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 10pt serif">next&larr;, ◦&larr;</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">writing a String of characters<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 10pt serif">append:, nextString&larr;</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">writing other kinds of objects<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 10pt serif">nextword, word:&larr;, print:</span><span style="font: 10pt serif"><br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">finding position<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 10pt serif">position, wordposition, length, end, positionSize:</span><span style="font: 10pt serif"><br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">changing position (besides reading/writing)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 10pt serif">position&larr;, skip:, skipTo:, reset, settoend, wordposition&larr;, position:size:<br></span><span style="font: 10pt serif"><br>When finished with a FileStream, &lt;FileStream&gt; </span><span style="font: bold 10pt serif">close</span><span style="font: 10pt serif">.<br><br>For information about using or creating other views of file organizations (</span><span style="font: bold 10pt serif">Btree</span><span style="font: 10pt serif">, file-based object dictionaries, Findit), about WFS and Juniper files, and general file problems, see Steve Weyer.<br>"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Dictionary</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">close</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">entryClass </span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">a subclass of FilePage</span><span style="font: 10pt serif">" self subError]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">Find: page </span><span style="font: 10pt serif">[⇑page pageNumber ≤ lastpn]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">found: page </span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">read an existing page</span><span style="font: 10pt serif">" self subError]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">makeEntry: page </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">page is: self entryClass⇒ [page init; serialNumber: serialNumber. ⇑page]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑[(self entryClass new) dictionary: self;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">init; pageNumber: page; serialNumber: serialNumber]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">open </span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">compute lastpn</span><span style="font: 10pt serif">" self findLastPage]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">release</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">reopen </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self sameFile⇒ []<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">init and directory access</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">directory get: self init].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self open]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>DictionaryEntry</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dictionary </span><span style="font: 10pt serif">[⇑directory]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dictionary: directory</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init </span><span style="font: 10pt serif">[lastpn &larr; false. error &larr; nullString. serialNumber &larr; String new: 4]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">match: entry </span><span style="font: 10pt serif">[⇑self name match: entry name]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">name </span><span style="font: 10pt serif">[⇑name]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">name: name</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm </span><span style="font: 10pt serif">[strm append: name]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialize</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">subclasses of File may want to share variables in pools.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">execute before filin:</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">Smalltalk declare: ↪XFilePool as: (SymbolTable new init: 16).<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">in classInit:</span><span style="font: 10pt serif"> XFilePool declare: ↪() as: ↪()"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">FilePool declare: ↪(read write shorten) as: ↪(1 2 4)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sameFile </span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">is File&rsquo;s current internal representation the same as what is stored externally? if so, usually can avoid some initialization, directory lookup</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Name</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">serialNumber </span><span style="font: 10pt serif">[⇑serialNumber]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">serialNumber: s </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">stored as a String of 4 characters rather than as various Numbers</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s is: String⇒ [serialNumber &larr; s]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s is: Substring⇒ [serialNumber &larr; s copy]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s is: Integer⇒ [serialNumber word: 1 &larr; 0; word: 2 &larr; s]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">Vector of Integers</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">serialNumber word: 1 &larr; s◦1; word: 2 &larr; s◦2]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>FileDirectory</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">delete </span><span style="font: 10pt serif">[⇑directory delete: self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">directory </span><span style="font: 10pt serif">[⇑directory]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">directory: directory</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">rename: newName </span><span style="font: 10pt serif">[⇑directory rename: self newName: newName]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">type </span><span style="font: 10pt serif">[⇑type]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">type: type </span><span style="font: 10pt serif">"used by different Files in different ways, e.g. read/write mode"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>File Length</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">endFile: page </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">make File end with this FilePage. false means delete all of File</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self subError]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">findLastPage </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">the default definitions for </span><span style="font: bold 10pt serif">findLastPage</span><span style="font: italic 10pt serif"> and </span><span style="font: bold 10pt serif">length</span><span style="font: italic 10pt serif"> are circular.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">at least one of them must be defined by a subclass"<br></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑lastpn &larr; self pageFrom: self length]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">lastFullPage </span><span style="font: 10pt serif">[(self read: self lastPage) full⇒ [⇑lastpn] ⇑lastpn-1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">lastPage </span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">length in pages</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">lastpn⇒ [⇑lastpn] ⇑self findLastPage]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">lastPage: lastpn </span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">for those who know what they&rsquo;re doing</span><span style="font: 10pt serif">"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">length </span><span style="font: 10pt serif">| page [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">length in characters</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">page &larr; self read: self lastPage.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑lastpn-1 * page dataLength + page length]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pageFrom: len </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">compute page number for a character index</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑(len-1 / self entryClass new dataLength) asSmall+ 1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>FilePage</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">doCommand: com page: page error: s </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">execute a File command on page. if an error occurs, include<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">error &larr; &rsquo;some error message&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self error: s<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">if s is false, returns false.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">otherwise s is passed to an error routine</span><span style="font: 10pt serif">" self subError]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">error </span><span style="font: 10pt serif">[⇑error]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">error: e </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">e⇒ [e &larr; [(Stream default) append: name; append: &rsquo; in &rsquo;; append: e;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">append: &rsquo;, &rsquo;; append: error; contents].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">error &larr; nullString.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑super error: e]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">Get: page </span><span style="font: 10pt serif">| p pn [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pn &larr; page pageNumber.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">p &larr; self Read: page⇒ [⇑p]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">current last page of the file is assumed full</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ p from: lastpn+1 to: pn-1 do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">page pageNumber: p.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">page &larr; self Write: page].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">return an empty last page which is not written yet</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">page pageNumber: pn; length: 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑page]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">get: pn </span><span style="font: 10pt serif">[⇑self Get: (self makeEntry: pn)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">newPage </span><span style="font: 10pt serif">[⇑self makeEntry: 0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">newPage: pn </span><span style="font: 10pt serif">[⇑self makeEntry: pn]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">Read: page </span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">return page or false</span><span style="font: 10pt serif">" self subError]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">read: pn </span><span style="font: 10pt serif">[⇑self Read: (self makeEntry: pn)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">Write: page </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">update </span><span style="font: bold 10pt serif">lastpn</span><span style="font: italic 10pt serif">, write page and return result (maybe next page)</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self subError]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>FileStream</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asStream </span><span style="font: 10pt serif">[⇑(FileStream new) on: [self open; get: 1]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪File under: &rsquo;Files&rsquo;.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">File classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"FileDirectory"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;FileDirectory&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Dict<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;directory fileReaders&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sharing: FilePool;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>A collection of Files. FileDirectory is a generalization: some examples are AltoFileDirectory and WoodstockFileDirectory</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Dictionary</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">checkName: s </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">default behavior is to get rid of ending period.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">subclasses can do any kind of checking they want and<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">return false if name is no good</span><span style="font: 10pt serif">"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s empty or⦂ s last ≠ (&rsquo;.&rsquo;◦1)⇒ [⇑s]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑s copy: 1 to: s length-1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">close </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self obsolete⇒ []<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">externalViews delete: self.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self release]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">entryClass </span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">a subclass of File</span><span style="font: 10pt serif">" self subError]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">error: e entry: file </span><span style="font: 10pt serif">[⇑file error: e]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">Find: file </span><span style="font: 10pt serif">| name [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">name &larr; self checkName: file name⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">file name: name.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self Position &larr; file]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">file error: &rsquo;illegal name&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">insert: file </span><span style="font: 10pt serif">| old [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"note: this changes the default behavior found in Dict.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">this creates a new version rather than generating an error if the name exists"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">file &larr; self makeEntry: file.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self versionNumbers⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"ignore explicit version and directory will create a next version"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">file &larr; self makeEntry: (file name asStream upto: &rsquo;!&rsquo;◦1)]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self Find: file⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">old &larr; self makeEntry: (file name + &rsquo;$&rsquo;).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"otherwise, if the file already exists,<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">rename it to name$, deleting that file first if it exists"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self Find: old⇒ [self Delete: old]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self rename: file name newName: old name.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"reposition to original name"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self Find: file⇒ [self error: &rsquo;insert/rename ??&rsquo; entry: file]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"file didn&rsquo;t exist"].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self Insert: file.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑file]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">open </span><span style="font: 10pt serif">[externalViews insert: self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm append: [self obsolete⇒ [&rsquo;a closed &rsquo;] &rsquo;an open &rsquo;];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">append: self class title;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">append: &rsquo; on &rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self server printon: strm]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>DictionaryEntry</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dictionary </span><span style="font: 10pt serif">[⇑directory]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dictionary: directory</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialize</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">directory: directory</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>File</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">allocateSN: file </span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">allocate a new serial number for a File</span><span style="font: 10pt serif">" self subError]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">directory </span><span style="font: 10pt serif">[⇑directory]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">newPage </span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">return a dummy FilePage from a dummy File</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑(self makeEntry: nullString) newPage]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">versionNumbers </span><span style="font: 10pt serif">["generally, version numbers are not supported" ⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>FileStream</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">file: name </span><span style="font: 10pt serif">[⇑(self get: name) asStream]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">filin: s </span><span style="font: 10pt serif">[self filin: s format: 1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">filin: s format: ft </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">read Class definitions or Changes from FileStreams or PressFiles<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">ft: 1 (FileStream=Bravo), 2 (Press)</span><span style="font: 10pt serif">"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user displayoffwhile⦂ [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s is: Vector⇒ [for⦂ s from: s do⦂ [self filin: s format: ft]]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">special case for Alto and patterns</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(s is: String) and⦂ ((s has: &rsquo;*&rsquo;◦1) or⦂ (s has: &rsquo;#&rsquo;◦1))⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self filin: (self filesMatching: s) format: ft]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s is: UniqueString⇒ ["</span><span style="font: italic 10pt serif">Class name</span><span style="font: 10pt serif">" s &larr; s + [ft=1⇒ [&rsquo;.st&rsquo;] &rsquo;.press&rsquo;]]].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">([ft=1⇒ [self oldFile: s] self pressfile: s]) filin]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">newFile: name </span><span style="font: 10pt serif">[⇑(self insert: name) asStream]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">oldFile: name </span><span style="font: 10pt serif">[⇑(self find: name) asStream]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pressfile: name </span><span style="font: 10pt serif">[⇑PressFile new of: (self file: name)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pressfilin: s </span><span style="font: 10pt serif">[self filin: s format: 2]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>FTP</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asFtpDirectory </span><span style="font: 10pt serif">| ftp [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"to allow convenient (kludgey) access to file servers (e.g. phylum, dpj) via Ftp"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(ftp &larr; FtpDirectory new) server: self server; open.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ftp userName empty⇒ [ftp login: self userName password: self userPassword]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ftp]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">login: name </span><span style="font: 10pt serif">[⇑self login: name password: &rsquo;&rsquo; "</span><span style="font: italic 10pt serif">or prompt?</span><span style="font: 10pt serif">"]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">login: name password: pw </span><span style="font: 10pt serif">[self subError]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">retrieve: s </span><span style="font: 10pt serif">| t [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s is: Vector⇒ [for⦂ t from: s do⦂ [self retrieve: t as: t]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self retrieve: s as: s]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">retrieve: s1 as: s2 </span><span style="font: 10pt serif">| f [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self exists: s1⇒ [f &larr; self oldFile: s1] ⇑false].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f readonly.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">([s2 is: FileStream⇒ [s2] dp0 file: s2]) append: f; close.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f close]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">server </span><span style="font: 10pt serif">[⇑directory]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">server: directory</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">store: s </span><span style="font: 10pt serif">| t [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s is: Vector⇒ [for⦂ t from: s do⦂ [self store: t as: t]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self store: s as: s]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">store: s1 as: s2 </span><span style="font: 10pt serif">| f [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s1 is: FileStream⇒ [f &larr; s1] dp0 exists: s1⇒ [f &larr; dp0 oldFile: s1] ⇑false].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f readonly.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(self file: s2) append: f; close.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f close]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">userName </span><span style="font: 10pt serif">[⇑[currentProfile≡nil⇒ [&rsquo;&rsquo;] currentProfile userName: self server]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">userPassword </span><span style="font: 10pt serif">[⇑[currentProfile≡nil⇒ [&rsquo;&rsquo;] currentProfile userPassword: self server]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Juniper</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">closeTransaction </span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">default is to do nothing</span><span style="font: 10pt serif">"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">exceptionHandler: eh </span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">default is to do nothing</span><span style="font: 10pt serif">"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪FileDirectory under: &rsquo;Files&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"FilePage"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;FilePage&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Dict<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;file page&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sharing: FilePool;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>A block, chunk, or page of information from some collection of pages (a File).  FilePage is a generalization: some examples are AltoFilePage and WoodstockFilePage</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Dictionary</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">◦i </span><span style="font: 10pt serif">[⇑page◦(self checkIndex: i)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">◦i &larr; v </span><span style="font: 10pt serif">[⇑page◦(self checkIndex: i) &larr; v]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asStream </span><span style="font: 10pt serif">[⇑self asStream: Stream new]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">reopen </span><span style="font: 10pt serif">[file reopen; makeEntry: self "</span><span style="font: italic 10pt serif">self may have been released</span><span style="font: 10pt serif">"]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>DictionaryEntry</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dictionary </span><span style="font: 10pt serif">[⇑file]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dictionary: file</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[page≡nil⇒ ["self page:" page &larr; String new: self pageLength]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self length: 0"not sure who depends on this besides FileStream read:"]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">name: sp </span><span style="font: 10pt serif">[self init; serialNumber: sp◦1; pageNumber: sp◦2]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialize</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">file: file</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">page: page</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>File</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">doCommand: com error: s </span><span style="font: 10pt serif">[⇑file doCommand: com page: self error: s]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">endFile </span><span style="font: 10pt serif">[⇑file endFile: self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">file </span><span style="font: 10pt serif">[⇑file]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">get: pn </span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">recycle self</span><span style="font: 10pt serif">" self pageNumber: pn; length: 0. ⇑file Get: self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">read: pn </span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">recycle self</span><span style="font: 10pt serif">" self pageNumber: pn; length: 0. ⇑file Read: self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">write </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">some files, e.g. AltoFile, will return a last empty page instead of a full one</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑file Write: self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Page</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">address </span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">page address, e.g. on a disk</span><span style="font: 10pt serif">" self subError]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">address: a </span><span style="font: 10pt serif">[self subError]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asStream: s </span><span style="font: 10pt serif">| offset [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">offset &larr; self headerLength.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑s of: self dataString from: offset+1 to: offset+self length "self dataEnd"]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">checkIndex: i </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &gt; 0 and⦂ i ≤ self length⇒ [⇑i + self headerLength]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self error: &rsquo;illegal index&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dataBeginning </span><span style="font: 10pt serif">[⇑self headerLength]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dataEnd </span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">logical end of data in page</span><span style="font: 10pt serif">" ⇑self headerLength + self length]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dataEnd: pos </span><span style="font: 10pt serif">[self length: pos - self headerLength]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dataLength </span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">physical length of data in page. default</span><span style="font: 10pt serif">" ⇑512]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dataMaxEnd </span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">physical end of data in page</span><span style="font: 10pt serif">" ⇑self headerLength + self dataLength]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dataString </span><span style="font: 10pt serif">[⇑page]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">full </span><span style="font: 10pt serif">[⇑self length = self dataLength]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">header: n </span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">return n-th header word</span><span style="font: 10pt serif">" ⇑page word: n]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">header: n &larr; v </span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">set and return n-th header word</span><span style="font: 10pt serif">" ⇑page word: n &larr; v]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">headerLength </span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">length of stuff before data begins in page</span><span style="font: 10pt serif">" ⇑0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">lastPage </span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">is this last page in file?</span><span style="font: 10pt serif">" ⇑self pageNumber ≥ file lastPage]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">length </span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">logical length of data in page</span><span style="font: 10pt serif">" self subError]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">length: len </span><span style="font: 10pt serif">[self subError]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">page </span><span style="font: 10pt serif">[⇑page]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pageLength </span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">physical size of page</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self headerLength + self dataLength + self trailerLength]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pageNumber </span><span style="font: 10pt serif">[self subError]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pageNumber: pn </span><span style="font: 10pt serif">[self subError]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">serialNumber </span><span style="font: 10pt serif">[⇑file serialNumber]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">serialNumber: sn </span><span style="font: 10pt serif">[self subError]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">trailerLength </span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">length of stuff after data ends in page</span><span style="font: 10pt serif">" ⇑0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">word: i </span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">no bounds checking</span><span style="font: 10pt serif">" ⇑page word: self headerLength/2 + i]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">word: i &larr; v </span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">no bounds checking</span><span style="font: 10pt serif">" ⇑page word: self headerLength/2 + i &larr; v]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪FilePage under: &rsquo;Files&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"EtherFilePage"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;EtherFilePage&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: FilePage<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>A FilePage which consists of an ethernet packet (Pacbuf) containing network information, header info and data</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>FilePage</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dataString </span><span style="font: 10pt serif">[⇑page pupString]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">header: n </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">for accessing information after pup header, e.g. file commands and parameters.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">n = 1 to (self headerLength-24)/2</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑page word: 12+n]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">header: n &larr; v </span><span style="font: 10pt serif">[⇑page word: 12+n &larr; v]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">headerLength </span><span style="font: 10pt serif">[⇑44 "</span><span style="font: italic 10pt serif">ethernet encap.(4), pup header(20), file label (20=default)</span><span style="font: 10pt serif">"]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[page≡nil⇒ ["self page:" page &larr; file allocatePage]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self length: 0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">length </span><span style="font: 10pt serif">[⇑page pupLength - (self headerLength - 2)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">length: len </span><span style="font: 10pt serif">[page pupLength &larr; len + self headerLength - 2]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">trailerLength </span><span style="font: 10pt serif">[⇑2 "</span><span style="font: italic 10pt serif">checksum</span><span style="font: 10pt serif">"]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Ether</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">packet </span><span style="font: 10pt serif">[⇑page]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pupType </span><span style="font: 10pt serif">[⇑page pupType]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pupType&larr; p </span><span style="font: 10pt serif">[⇑page pupType&larr; p]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪EtherFilePage under: &rsquo;Files&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"FileStream"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;FileStream&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Stream<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;page dirty rwmode&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sharing: FilePool;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>A Stream which windows a File. see File example</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Dictionary</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">close </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self obsolete⇒ []<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self writing⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">rwmode anymask: shorten⇒ [self shorten]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self flush]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"self release (sort of)"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dirty &larr; limit &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self file close.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">externalViews delete: self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">file </span><span style="font: 10pt serif">[⇑page file]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">obsolete </span><span style="font: 10pt serif">[⇑dirty]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">release </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self obsolete⇒ []<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dirty &larr; limit &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self file release]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">reopen </span><span style="font: 10pt serif">| pos [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dirty "self obsolete"⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">reopen to current position</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pos &larr; position.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self read: page pageNumber⇒ [position &larr; pos min: limit]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">if that page doesn&rsquo;t exist, go to last one that does.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">note that settoend would be recursive</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self read: (self file lastPage)⇒ [position &larr; limit]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self error: &rsquo;cannot reopen or settoend&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialize</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">on: page </span><span style="font: italic 10pt serif">"some page from a File, usually page 1, or another FileStream</span><span style="font: 10pt serif">" [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[page is: FileStream⇒ [page &larr; page page]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">page asStream: self.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">externalViews insert: self.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"obsolete flag"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dirty &larr; false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Access Modes</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">readonly </span><span style="font: 10pt serif">[self setMode: read]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">readwrite </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">allow read and write but don&rsquo;t automatically shorten</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self setMode: read + write]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">readwriteshorten </span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">allow read and write and shorten File upon closing</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self setMode: read+write+shorten]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">setMode: m </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rwmode = m⇒ []<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">don&rsquo;t flush if first time or not write mode or continuing write mode</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[rwmode≡nil or⦂ ((rwmode nomask: write) or⦂ (m anymask: write))⇒ []<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self flush].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rwmode &larr; m]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">writeshorten </span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">allow write and shorten File upon closing. in general, this would be faster for overwriting Files since pages might not have to be read first. at present, treated same as </span><span style="font: bold 10pt serif">readwriteshorten</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self setMode: write+shorten]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">writing </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rwmode≡nil⇒ ["</span><span style="font: italic 10pt serif">default mode. true</span><span style="font: 10pt serif">" ⇑self readwriteshorten]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑(rwmode land: write) = write]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Stream</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">◦i </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self position &larr; i-1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self next]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">◦i &larr; v </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self position &larr; i-1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self next &larr; v]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">append: s </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"try to make some special cases go much faster"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s is: String⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s length &gt; 80⇒ [self writeString: s from: 1 to: s length. ⇑s]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s is: Stream⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(s limit - s position &gt; 80) and⦂ (s asArray is: String)⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self writeString: s asArray from: s position+1 to: s limit. ⇑s]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s is: FileStream⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self writeFile: s for: nil. ⇑s]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑super append: s]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">contents </span><span style="font: 10pt serif">| s ["</span><span style="font: italic 10pt serif">read all of a File</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self readonly; reset.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s &larr; self next: self length.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self close.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑s]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">end </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self reopen.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">position &lt; limit⇒ [⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self read: page pageNumber+1⇒ [⇑"page empty" position = limit]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑true]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">into: s endError: err </span><span style="font: 10pt serif">| charsRead len t [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">len &larr; s  length.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[len &gt; 80⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">charsRead &larr; len - (self readString: s from: 1 to: len)]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"in line: super into: s endError: err"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">charsRead &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"read until count or stream is exhausted"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ (charsRead &lt; len and⦂ (t &larr; self next)) do⦂ [s◦(charsRead &larr; charsRead+1) &larr;t]].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">err⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">charsRead = len⇒ [⇑s]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: &rsquo;only read first &rsquo; + charsRead asString]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑charsRead]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">length </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">page lastPage⇒ [⇑page pageNumber-1 * page dataLength + page length]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self file length]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">next: n from: strm </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">n &gt; 80 and⦂ (strm is: FileStream)⇒ [self writeFile: strm for: n]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑super next: n from: strm]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pastend </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self reopen or⦂ (page lastPage≡false and⦂ self nextPage)⇒ [⇑self next]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pastend&larr; v </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self writing⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self reopen⇒ [⇑self next &larr; v]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[limit &lt; page dataMaxEnd or⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self nextPage⇒ [position=limit]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self error: &rsquo;could not get page&rsquo;]⇒ [limit &larr; page dataMaxEnd]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self next&larr; v]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self error: &rsquo;no writing allowed&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">position </span><span style="font: 10pt serif">[⇑self positionSize: 1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">position&larr; p </span><span style="font: 10pt serif">[⇑self position: p size: 1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">super printon: strm.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm append: &rsquo; on &rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self file printon: strm]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">reset </span><span style="font: 10pt serif">["self position &larr; 0"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self read: 1⇒ []<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self error: &rsquo;reset&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">settoend </span><span style="font: 10pt serif">["self position &larr; self length"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">make sure file is open so lastPage is correct</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self reopen.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">when writing on the last page, lastPage may be too small</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self read: (self file lastPage max: page pageNumber)⇒ [position &larr; limit]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self error: &rsquo;settoend???&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">skip: n </span><span style="font: 10pt serif">| p plen [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">n=0⇒ []<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self reopen.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">p &larr; position + n.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[n &gt; 0⇒ [p ≥ limit]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self fixEnd "</span><span style="font: italic 10pt serif">important on last page</span><span style="font: 10pt serif">".<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">p &lt; page dataBeginning]⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">simply: self position &larr; self position + n.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">however, since we are incurable optimizers...</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">plen &larr; page dataLength.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">assume p is not Large, otherwise use intdiv:</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">p &larr; p - page dataBeginning.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self positionPage: (page pageNumber + [n &lt; 0⇒ [(p+1)/plen - 1] p/plen])<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">character: p \ plen⇒ []<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self error: &rsquo;cannot skip &rsquo; + n asString]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">same page</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">position &larr; p]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">word: i </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self wordposition &larr; i-1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self nextword]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">word: i &larr; v </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self wordposition &larr; i-1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self nextword &larr; v]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">wordposition </span><span style="font: 10pt serif">[⇑self positionSize: 2]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">wordposition&larr; w </span><span style="font: 10pt serif">[⇑self position: w size: 2]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>File</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">directory </span><span style="font: 10pt serif">[⇑self file directory]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fixEnd </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self writing and⦂ position &gt; page dataEnd⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">fix the end of page</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">page dataEnd: (limit &larr; position)]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">flush </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self obsolete⇒ [⇑page]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self fixEnd.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑page write]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">name </span><span style="font: 10pt serif">[⇑self file name]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">nextPage </span><span style="font: 10pt serif">[⇑self read: page pageNumber+1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pad: size </span><span style="font: 10pt serif">| rem [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"skip to next boundary of size and return how many characters skipped"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rem &larr; (([page dataLength \ size = 0⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">position - page dataBeginning] self position]) \ size) asSmall.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rem = 0⇒ [⇑0]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self skip: size - rem.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑size - rem]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pad: size with: val </span><span style="font: 10pt serif">| rem [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"pad to next boundary of size and return how many characters padded"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rem &larr; (([page dataLength \ size = 0⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">position - page dataBeginning] self position]) \ size) asSmall.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rem = 0⇒ [⇑0]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self next: size - rem &larr; val.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑size - rem]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">page </span><span style="font: 10pt serif">[⇑page]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">position: objpos size: size </span><span style="font: 10pt serif">| len pn c pos [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">set the current character position and the current page<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">from the position of an object of a given size (see </span><span style="font: bold 10pt serif">positionSize:</span><span style="font: italic 10pt serif">)</span><span style="font: 10pt serif">"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">len &larr; page dataLength.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[size = len⇒ ["</span><span style="font: italic 10pt serif">page size</span><span style="font: 10pt serif">" pn &larr; objpos+1. c &larr; 0]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pos &larr; objpos.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[size = 1⇒ []<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">len \ size = 0⇒ ["</span><span style="font: italic 10pt serif">page length is a multiple of size</span><span style="font: 10pt serif">" len &larr; len / size]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pos &larr; objpos * size.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">size &larr; 1].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">obtain quotient (page) and remainder (position)</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pos &larr; pos intdiv: len.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pn &larr; 1 + (pos◦1) asSmall.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">c &larr; size * (pos◦2) asSmall].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self positionPage: pn character: c⇒ [⇑objpos]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self error: &rsquo;cannot read page &rsquo; + pn asString]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">positionPage: pn character: c </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">normally accessed by </span><span style="font: bold 10pt serif">position:size:, skip:</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self read: pn⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">c assumed between 0 and page dataLength. position, limit were set in </span><span style="font: bold 10pt serif">on:</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">position &larr; position + c.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">position ≤ limit or⦂ self writing⇒ [⇑true]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">position &larr; limit.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">c=0⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">try end of previous page</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self positionPage: pn-1 character: page dataLength]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">positionSize: size </span><span style="font: 10pt serif">| len pos [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">compute the position for an object of a given size,<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">e.g. characters (1), words (2), fixed length (n),<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">from the current character position and the current page</span><span style="font: 10pt serif">"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">len &larr; page dataLength.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">size = 1 or⦂ len \ size ≠ 0⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pos &larr; page pageNumber-1 * len + (position - page dataBeginning).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">size=1⇒ [⇑pos]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑pos / size]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">page length is a multiple of size</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑page pageNumber-1 * (len/size) + <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(position - page dataBeginning / size)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">read: pn </span><span style="font: 10pt serif">| p [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">normally accessed by </span><span style="font: bold 10pt serif">nextPage, position:size:, reopen, reset, settoend</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pn &lt; 1⇒ [⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self obsolete⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">reopen the file, (re)read the page</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">page reopen.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">p &larr; page read: pn⇒ [self on: p]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pn = page pageNumber and⦂ (page length &gt; 0 or⦂ position &gt; page dataBeginning)⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self fixEnd.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">page asStream: self]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">current page has wrong page number or is empty (possibly from error)</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self writing⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[pn &gt; page pageNumber and⦂ page full≡false⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">fill up last page when positioning past it</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">position &larr; page dataMaxEnd]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">otherwise, fixEnd</span><span style="font: 10pt serif">" position &gt; page dataEnd]⇒ [page dataEnd: (limit &larr; position)]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">write current page</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">p &larr; page write.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">p pageNumber = pn⇒ ["</span><span style="font: italic 10pt serif">already have next page, e.g. at end of AltoFile</span><span style="font: 10pt serif">"]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">read it or create it</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">p &larr; page get: pn]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">p &larr; page read: pn].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">p⇒ [(page &larr; p) asStream: self]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">settopage: p char: c </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">mainly for compatibility, since page sizes may vary.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">in general, use </span><span style="font: bold 10pt serif">position&larr;, wordposition&larr;</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self read: p asSmall⇒ [self skip: c asSmall]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self error: &rsquo;no page&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">shorten </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">normally called by </span><span style="font: bold 10pt serif">close</span><span style="font: italic 10pt serif"> and not directly by user</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self on: [page dataEnd: (limit &larr; position); endFile].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">position &larr; limit]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Filin/Filout</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asParagraphPrinter </span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">default format for filout etc.</span><span style="font: 10pt serif">" ⇑BravoPrinter init of: self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">backup </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">assume ivy open</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self directory≡dp0⇒ [ivy replace: self name]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">filin </span><span style="font: 10pt serif">| p [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user cr.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self readonly.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self end⇒ [self file error: &rsquo;empty file&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ (p &larr; self nextParagraph) do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">FilinSource &larr; self.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user print: nilⓢ p text; space].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self close.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">FilinSource &larr; nil]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">filout </span><span style="font: 10pt serif">[self filout: Changes contents sort]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">filout: source </span><span style="font: 10pt serif">[(self asParagraphPrinter) stamp; printchanges: source; close]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">filoutclass: class </span><span style="font: 10pt serif">[(self asParagraphPrinter) stamp; printclass: class; close]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">nextParagraph </span><span style="font: 10pt serif">| text [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">Bravo format paragraph (or self contents if no trailer)</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self end⇒ [⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">text &larr; self upto: 032 "</span><span style="font: italic 10pt serif">ctrl-z</span><span style="font: 10pt serif">".<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑text asParagraph applyBravo: self at: 1 to: text length]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Print</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asPressPrinter </span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">default format for printt etc.</span><span style="font: 10pt serif">" ⇑PressPrinter init of: self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printout: source </span><span style="font: 10pt serif">[(self asPressPrinter) stamp; printchanges: source; close; toPrinter]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printoutclass: class </span><span style="font: 10pt serif">[(self asPressPrinter) stamp; printclass: class; close; toPrinter]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">toPrinter </span><span style="font: 10pt serif">| pp p [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">print an unformatted or Bravo file as a press file</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user displayoffwhile⦂ [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pp &larr; (self directory file: self name + &rsquo;Press&rsquo;) asPressPrinter.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self readonly.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ (p &larr; self nextParagraph) do⦂ [pp print: p].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self close].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pp close; toPrinter]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>CodePane Editor</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">edit </span><span style="font: 10pt serif">[user restartup: (CodeWindow new file: self)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Fast Access</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">readPages: n </span><span style="font: 10pt serif">| charsLeft len s [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">read n pages of characters</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">len &larr; n * page dataLength.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s &larr; String new: len.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"charsRead &larr; self into: s endError: false."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">charsLeft &larr; self readString: s from: 1 to: len.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">charsLeft = 0⇒ ["</span><span style="font: italic 10pt serif">read len chars</span><span style="font: 10pt serif">" ⇑s]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">return characters read only before end of file</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑s copy: 1 to: len - charsLeft]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">readString: s from: start to: stop </span><span style="font: 10pt serif">| len charsLeft [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">for reading a subrange of a large String from a file (quickly, if BitBlt is used);<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">called by </span><span style="font: bold 10pt serif">FileStream into:endError:</span><span style="font: 10pt serif">"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self readonly; reopen.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">start &larr; start - 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">charsLeft &larr; stop - start.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">keep going until all of the requested characters are copied or<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">until end of file. if end of current page only, next page is read.</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ (charsLeft &gt; 0 and⦂ self end ≡ false) do⦂ [<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">len = # characters of current page that will fit in String</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">len &larr; limit - position min: charsLeft.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">charsLeft &larr; charsLeft - len.<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">copy subrange of page into String</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s copy: start+1 to: start+len<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">with: array from: position+1 to: position+len.<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">update source and destination pointers</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">position &larr; position+ len.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">start &larr; start + len.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">return the number of characters not read</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑charsLeft]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">streamPosition </span><span style="font: 10pt serif">[⇑position]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">streamPosition&larr;position </span><span style="font: 10pt serif">[⇑position]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">writeFile: fs for: charsLeft </span><span style="font: 10pt serif">| start len maxLimit [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">for copying part or all of one file to another (quickly, if BitBlt is used);<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">charsLeft ≡ nil means copy until end, otherwise a number of characters.</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">called by </span><span style="font: bold 10pt serif">FileStream append:, next:from:</span><span style="font: 10pt serif">"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self writing⇒ [] self error: &rsquo;read only!&rsquo;].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self reopen.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fs readonly; reopen.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">maxLimit &larr; page dataMaxEnd.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">keep going until all of the requested characters are copied or<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">until end of file. if end of current page only, next page is read.</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ ((charsLeft≡nil or⦂ charsLeft &gt; 0) and⦂ fs end ≡ false) do⦂ [<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">end of current destination page?</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[position = maxLimit⇒ [self nextPage]].<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">len = # characters of source page that will fit in destination page</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">start &larr; fs streamPosition.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">len &larr; maxLimit - position min: fs limit - start.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[charsLeft≡nil⇒ []<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">len &larr; len min: charsLeft.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">charsLeft &larr; charsLeft - len].<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">copy subrange of source page into destination page</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">array copy: position+1 to: position+len<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">with: fs asArray from: start+1 to: start+len.<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">update source and destination pointers</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">fs streamPosition &larr; start + len.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">position &larr; position + len.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">position &gt; limit⇒ [limit &larr; position]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">return the number of characters not read</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑[charsLeft ≡ nil⇒ [0] charsLeft]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">writeString: s from: start to: stop </span><span style="font: 10pt serif">| len charsLeft maxLimit [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">for writing a subrange of a large String onto a file (quickly, if BitBlt is used);<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">called by </span><span style="font: bold 10pt serif">FileStream</span><span style="font: italic 10pt serif"> </span><span style="font: bold 10pt serif">append:</span><span style="font: 10pt serif">"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self writing⇒ [] self error: &rsquo;read only!&rsquo;].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self reopen.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">start &larr; start - 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">charsLeft &larr; stop - start.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">maxLimit &larr; page dataMaxEnd.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">keep going until all of the requested characters are copied</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ charsLeft &gt; 0 do⦂ [<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">end of current page?</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[position = maxLimit⇒ [self nextPage]].<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">len = # characters of String that will fit in current page</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">len &larr; maxLimit - position min: charsLeft.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">charsLeft &larr; charsLeft - len.<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">copy subrange of String into page</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">array copy: position+1 to: position+len<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">with: s from: start+1 to: start+len.<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">update source and destination pointers</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">start &larr; start + len.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">position &larr; position + len.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">position &gt; limit⇒ [limit &larr; position]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑s]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪FileStream under: &rsquo;Files&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"FtpDirectory"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;FtpDirectory&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: FileDirectory<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;command&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>an interim(?) substitute for our own ftp server</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>FileDirectory</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">close </span><span style="font: 10pt serif">[self closeThen: &rsquo;Resume. Small.Boot&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">closeThen: s </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">command append: &rsquo;; &rsquo;; append: s.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user quitThen: command contents.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self open]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">commands </span><span style="font: 10pt serif">[⇑command contents]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">connect: name password: pw </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">command append: &rsquo; Connect/C &rsquo;; append: name; space; append: pw]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">delete: name </span><span style="font: 10pt serif">[command append: &rsquo; Delete/C &rsquo;; append: (self checkName: name)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">directoryName: name </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"this message should be directory:, but until rewriting..."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">command append: &rsquo; Directory/C &rsquo;; append: name]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">login: name password: pw </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">name empty⇒ []<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">command append: &rsquo; Login/C &rsquo;; append: name; space; append: pw]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">open </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">command &larr; Stream new of: (String new: 100).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">command append: &rsquo;Ftp &rsquo;; append: directory.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self login: self userName password: self userPassword]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">rename: oldName newName: newName </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">command append: &rsquo; Rename/C &rsquo;;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">append: (self checkName: oldName); space; append: (self checkName: newName)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">replace: name </span><span style="font: 10pt serif">| s [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s &larr; self checkName: name.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(directory compare: &rsquo;maxc&rsquo;) = 2⇒ [self delete: s; store: s]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">store as highest version (ifs only)</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">command append: &rsquo; Store/S &rsquo;; append: s; space; append: s; append: &rsquo;!H&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">retrieve: s </span><span style="font: 10pt serif">| t [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s is: Vector⇒ [for⦂ t from: s do⦂ [self retrieve: t]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">command append: &rsquo; Retrieve/C &rsquo;; append: (self checkName: s)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">retrieve: remote as: local </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">command append: &rsquo; Retrieve/S &rsquo;;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">append: (self checkName: remote); space; append: (self checkName: local)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">store: s </span><span style="font: 10pt serif">| t [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s is: Vector⇒ [for⦂ t from: s do⦂ [self store: t]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">command append: &rsquo; Store/C &rsquo;; append: (self checkName: s)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">store: local as: remote </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">command append: &rsquo; Store/S &rsquo;;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">append: (self checkName: local); space; append: (self checkName: remote)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪FtpDirectory under: &rsquo;Files&rsquo;.</span></div>
    <div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">&rsquo;From Smalltalk 5.5k XM November 24 on 22 November 1980 at 2:57:08 am.&rsquo;<br></span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">"AltoFile"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;AltoFile&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: File<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;leader pageAddresses&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sharing: AltoFilePool;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>A File found on an Alto Model 31(44) disk</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Dictionary</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">close </span><span style="font: 10pt serif">["to look at at reopen" type &larr; self updateLeader: (self read: 0)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">entryClass </span><span style="font: 10pt serif">[⇑AltoFilePage]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">open </span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">don&rsquo;t find last page immediately.  for later close</span><span style="font: 10pt serif">" type &larr; read]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>DictionaryEntry</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fileSize </span><span style="font: 10pt serif">["sn, version, fn, leader, name" ⇑11 + (name length lor: 1)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init </span><span style="font: 10pt serif">[super init.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pageAddresses &larr; AltoFileAddressTable new]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">readFrom: s </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"read file description from SysDir"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">serialNumber &larr; s next: 4.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s skip: 4 "self version: s nextword. s skip: 2".<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">leader &larr; directory virtualToReal: s nextword.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">name &larr; s nextString.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s padNext]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">storeOn: s </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s append: serialNumber;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextword &larr; 1; nextword &larr; 0;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextword &larr; (directory realToVirtual: leader);<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextString &larr; name; padNext &larr; 0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>File</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">before filing in:</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">Smalltalk declare: ↪AltoFilePool as: (SymbolTable new init: 32)"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">AltoFilePool<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">declare: ↪(CRR CCR CCW CWW "</span><span style="font: italic 10pt serif">disk commands</span><span style="font: 10pt serif">")<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">as: ↪(044100 044120 044130 044150);<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">declare: ↪(<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">dfmask "</span><span style="font: italic 10pt serif">bit means active directory entry</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">boffset "</span><span style="font: italic 10pt serif">byte offset of bit table in DiskDescriptor</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">dirname) as: ↪(02000 040 &rsquo;SysDir.&rsquo; );<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">declare: ↪(nextp backp numch pagen vn) as: ↪(1 2 4 5 6)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">doCommand: com page: page error: e </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">error &larr; nullString.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self dskprim: directory diskNumber address: page address command: com<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">page: page page⇒ [⇑page]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">error &larr; self errorString: error "</span><span style="font: italic 10pt serif">set by </span><span style="font: bold 10pt serif">dskprim:...</span><span style="font: 10pt serif">".<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self error: e]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">endFile: page </span><span style="font: 10pt serif">| nextPage pn [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[page≡false⇒ ["</span><span style="font: italic 10pt serif">free all of file</span><span style="font: 10pt serif">" pn &larr; ¬1]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[page full⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextPage &larr; self Write: page.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">if page was a full last page, next is an empty (and now last) page</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextPage lastPage⇒ [⇑nextPage]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">page &larr; self read: page pageNumber+1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">page empty⇒ [⇑page]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">page length: 0]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">write last page</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">page header: nextp &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self Write: page.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">free rest of file</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pn &larr; page pageNumber].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">lastpn &larr; false "</span><span style="font: italic 10pt serif">reset by readPage:</span><span style="font: 10pt serif">".<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ (lastpn≡false and⦂ (nextPage &larr; self read: (pn &larr; pn+1))) do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextPage init; freePage;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">doCommand: CWW error: &rsquo;endFile:&rsquo;.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">directory deallocate: nextPage].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[page⇒ [pageAddresses position &larr; (lastpn &larr; page pageNumber)]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑page]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">findLastPage </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self read: 20000.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑lastpn]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">Get: page </span><span style="font: 10pt serif">| p pn [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pn &larr; page pageNumber.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self Read: page⇒ [⇑page]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">page now contains last page</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ p from: lastpn to: pn-1 do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">page pageNumber: p; length: page dataLength.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">this writes current and allocates next (empty) page</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">page &larr; self Write: page].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑page]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">Read: page </span><span style="font: 10pt serif">| pn p palen [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pn &larr; page pageNumber.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pageAddresses⇒ [palen &larr; pageAddresses length]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pn = 0⇒ [palen &larr; 0]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ p from: (palen min: pn) to: pn do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">set up page for checking</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">page<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">zeroed by machine code</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">header: nextp &larr; [p &lt; palen⇒ [pageAddresses◦(p+1)] 0];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">header: backp &larr; [p=0⇒ [0]; =1⇒[leader] pageAddresses◦(p-1)];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">length: [p &lt; palen⇒ [page dataLength] 0];"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pageNumber: p;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">address: [p=0⇒ [leader] pageAddresses◦p];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">doCommand: CCR error: &rsquo;readPage:&rsquo;.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">page lastPage⇒ [(lastpn &larr; p) &lt; pn⇒ [⇑false]]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">p ≥ palen and⦂ pageAddresses⇒[pageAddresses◦(p+1) &larr; page header: nextp]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">no need to store if already known or no page table</span><span style="font: 10pt serif">"].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑page]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sameFile </span><span style="font: 10pt serif">| page s [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(page &larr; self newPage: 0) address: leader.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">if any of following  tests fail, File will be reinitialized</span><span style="font: 10pt serif">"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑("</span><span style="font: italic 10pt serif">serial number match</span><span style="font: 10pt serif">" (page doCommand: CCR error: false) and⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">correct page number</span><span style="font: 10pt serif">" page pageNumber = 0) and⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s &larr; page asStream.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">last write was by us</span><span style="font: 10pt serif">" type = (s next: 4) and⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s skip: 8.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">same name</span><span style="font: 10pt serif">" (name compare: s nextString) = 2]]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">Write: page </span><span style="font: 10pt serif">| nextPage labelDirty returnPage [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(labelDirty &larr; page lastPage) and⦂ page full⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">last page can&rsquo;t be full, so glue on another page</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">returnPage &larr; nextPage &larr; self newPage.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">directory allocate: nextPage after: (directory realToVirtual: page address).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextPage init;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">header: backp &larr; page address;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pageNumber: (lastpn &larr; page pageNumber+1);<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">serialNumber: serialNumber;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">doCommand: CWW error: &rsquo;writePage: (allocate)&rsquo;.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">link to current page</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">page header: nextp &larr; nextPage address.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pageAddresses⇒ [pageAddresses◦lastpn &larr; nextPage address]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: bold 10pt serif">growSmalltalkBy:</span><span style="font: 10pt serif">"]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">returnPage &larr; page].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">whenever a last (or second last) page is written, write label also</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self doCommand: [labelDirty⇒ [CWW] CCW] page: page error: &rsquo;writePage:&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">type &larr; read+write.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑returnPage]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Alto</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dskprim: diskNumber </span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">0/1</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: bold 10pt serif">address: a</span><span style="font: 10pt serif"> "</span><span style="font: italic 10pt serif">starting Alto disk address</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: bold 10pt serif">command: com</span><span style="font: 10pt serif"> "</span><span style="font: italic 10pt serif">disk command (usually CCR, CCW, CWW)</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: bold 10pt serif">page: string</span><span style="font: 10pt serif"> "</span><span style="font: italic 10pt serif">string containing label and data</span><span style="font: 10pt serif">"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">if disk routine encounters an error,</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">error &larr; (DCB status, to be interpreted by </span><span style="font: bold 10pt serif">errorString:</span><span style="font: 10pt serif">).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">if other error occurs, e.g. nil instead of Integer...</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">error &larr; ¬1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false] primitive: 80</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">errorString: status </span><span style="font: 10pt serif">| t s [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">see Alto hardware manual for details on error word format</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">status=¬1⇒ [⇑&rsquo;primitive failure, bad args?&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s &larr; Stream default.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s append: ↪(&rsquo;&rsquo;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;hardware error or sector overflow&rsquo;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;check error&rsquo;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;disk command specified illegal sector&rsquo;)◦(1 + (status land: 3)).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ t to: 6 do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">status allmask: (0200 lshift: 1-t)⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s space; append: ↪(<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;seek failed, possible illegal track&rsquo;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;seek in progress&rsquo;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;disk unit not ready&rsquo;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;hardware late&rsquo;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;hardware not transferring&rsquo;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;checksum&rsquo;)◦t]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s space; append: status base8.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑s contents]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">leader </span><span style="font: 10pt serif">[⇑leader]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">leader: leader</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pageAddresses: pageAddresses</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">updateLeader: page </span><span style="font: 10pt serif">| s time lastwrite [ <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">see &lt;Alto&gt;AltoFileSys.D, (p.3 leader page) for further info</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">time &larr; user timewords.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s &larr; page asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[type anymask: write ⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">set creation/write read date and name</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">directory flush.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">lastwrite &larr; time.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s append: time; append: time; append: time.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">name empty⇒ []<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s nextString&larr; name]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">lastwrite &larr; s next: 4.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s skip: 4; append: time].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self Write: page.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑lastwrite]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪AltoFile under: &rsquo;Alto File System&rsquo;.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">AltoFile classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"AltoFileAddressTable"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;AltoFileAddressTable&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: RunVector<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>This class converts to virtual disk addrs which tend to come in consecutive<br>runs, and can thus use the compact representation of its superclass.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Reading and writing</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">◦i </span><span style="font: 10pt serif">| base [base&larr; super◦i. ⇑dp0 virtualToReal: base+offset]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">◦i&larr; val </span><span style="font: 10pt serif">| virt [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">virt&larr; dp0 realToVirtual: val.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">starts ≡ nil⇒[super◦i&larr; virt. ⇑val]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">super◦i&larr; virt-i+(starts last).</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"superclass tries for constant runs"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">offset&gt;0⇒[⇑val]</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"OK if same run"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">values last&larr; virt. ⇑val]</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"else fix new run value base"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">position&larr; p </span><span style="font: 10pt serif">| l</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"shortens (for file shorten)"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[p&gt;max⇒[user notify: &rsquo;invalid extension&rsquo;] max&larr; p.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(l&larr; starts findSorted: max)&lt;starts length⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[starts&larr; starts copy: 1 to: l.  values&larr; values copy: 1 to: l]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪AltoFileAddressTable under: &rsquo;Alto File System&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"AltoFileDirectory"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;AltoFileDirectory&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: FileDirectory<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;dirFile bitsFile closed diskPages totalPages nSectors&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sharing: AltoFilePool;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Dictionary</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">close </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self obsolete⇒ []<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dirFile close.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[bitsFile ≡ nil⇒ ["an interrupted open?"] bitsFile close].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">super close]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">Delete: file </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(self deleteEntry: file) open; endFile: false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitsFile flush]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">entryClass </span><span style="font: 10pt serif">[⇑AltoFile]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">entrySize: file </span><span style="font: 10pt serif">["entry size in words" ⇑1 + (file fileSize / 2)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">Insert: file </span><span style="font: 10pt serif">| sn page [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">file serialNumber: (sn &larr; self allocateSN: file).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">allocate a new page (more success after O.S. stuff, bittable etc.)</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self allocate: (page &larr; file newPage) after: 800.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">write 0th -- leader, in the process filling it in and then creating first page</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">page init; serialNumber: sn; length: page dataLength.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">file leader: page address; type: write; updateLeader: page.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self addEntry: file]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">nextEntry: file </span><span style="font: 10pt serif">| s elen [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dirFile≡nil⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(file name compare: dirname) = 2⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">return system directory file. known serialNumber and leader</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">file serialNumber: 0100000, 0144; leader: 010000.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑file]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self error: &rsquo;directory not open&rsquo;]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">return the next file entry, ignore deleted entries,<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">and leave dirFile positioned before next entry</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ (s &larr; dirFile nextword) do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">elen &larr; s land: dfmask-1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s allmask: dfmask⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">file readFrom: dirFile.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">dirFile skip: elen*2 - (file fileSize + 2).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑file]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">deleted entry, again</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">dirFile skipwords: elen-1].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">obsolete </span><span style="font: 10pt serif">[⇑dirFile≡nil]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">open </span><span style="font: 10pt serif">| f s a page len elen type [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nil ≠ dirFile⇒ []<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">assume some defaults in case DSHAPE is not in SysDir leader page.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">these should only be needed if the disk is old (and not scavenged).<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">they will not work if a 14 sector system is missing DSHAPE (unlikely) since addresses of first page of directory and of DiskDescriptor might be computed incorrectly.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">in a Smalltalk-76 system, nSectors, diskPages had better eventually match:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">| a. a &larr; Vmem specialLocs◦13. mem◦(a+5), (mem◦(a+6))<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nSectors &larr; 12.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">diskPages &larr; 812*nSectors.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">totalPages &larr; 2*diskPages.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">read SysDir leader page to find out file system configuration.  see AltoFileSys.D</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f &larr; self find: dirname.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">to prevent address of page 1 from being stored</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f pageAddresses: false.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">length of property list, in words</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">page &larr; f read: 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">len &larr; page◦494.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[len ≠ 210⇒ []<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">scan file properties for DSHAPE</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s &larr; page asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s skipwords: page◦493.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ len &gt; 0 do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">type &larr; s next.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">type = 0⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">0 terminates list.  property not found. try to read if from DiskDescriptor"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">len &larr; 0]<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">elen &larr; s next.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">type = 1 and⦂ elen = 5⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">DSHAPE. read property</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self configure: s.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">set flags so configure and loop are not done again</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s &larr; false. len &larr; 0]<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">skip over other property</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">len &larr; len - elen.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s skipwords: elen-1]].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">now, with the correct (or default) file system configuration,<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">store the virtual address of next page (1), and create a FileStream on SysDir</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">a &larr; AltoFileAddressTable new.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">a◦1 &larr; page header: nextp.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f pageAddresses: a.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(dirFile &larr; f asStream) readonly.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(bitsFile &larr; self oldFile: &rsquo;DiskDescriptor&rsquo;) readwrite.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">configuration not read from SysDir. this will work for 12 sector systems.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">14 sector systems should have had the DSHAPE property</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self configure: bitsFile]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">super open.<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">Position &larr; entry </span><span style="font: 10pt serif">| name elen s holepos holesize entrysize nlen sk [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">entry format<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">1</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">n (length in words, including this one) + undeleted bit (dfmask)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">2-3</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">serialNumber<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">4</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">version<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">5</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">0?<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">6</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">virtual address of page 0<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">7-n name as Bcpl string (extra 0 if length even)</span><span style="font: 10pt serif">"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">name &larr; entry name.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dirFile≡nil and⦂ (name compare: dirname) = 2⇒ [⇑true]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self reset.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">holepos &larr; false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">holesize &larr; dfmask.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nlen &larr; name length.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">entrysize &larr; self entrySize: entry "</span><span style="font: italic 10pt serif">desired entry size</span><span style="font: 10pt serif">".<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ (s &larr; dirFile nextword) do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">entry length in words</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">elen &larr; s land: dfmask-1.<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[entrysize &gt; elen⇒ ["</span><span style="font: italic 10pt serif">entry too small</span><span style="font: 10pt serif">" sk &larr; ¬2]<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s = elen⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">deleted entry. check hole size for later inserting or renaming</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">sk &larr; ¬2.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">elen &lt; holesize⇒[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">hole is the smallest so far</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">holesize &larr; elen. holepos &larr; dirFile position]]<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">normal entry, big enough</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">dirFile skip: 10.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nlen ≠ dirFile next⇒ ["</span><span style="font: italic 10pt serif">name wrong size</span><span style="font: 10pt serif">" sk &larr; ¬13]<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">sk &larr; ¬13 - nlen.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(name compare: (dirFile next: nlen)) = 2⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">name match, position back to beginning of entry</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">dirFile skip: sk.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑entry]].<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">sk is the character offset from the entry header word to the next entry</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">dirFile skip: elen*2 + sk].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[holepos⇒ [dirFile position &larr; holepos-2] "</span><span style="font: italic 10pt serif">at end of dirFile</span><span style="font: 10pt serif">"].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">release </span><span style="font: 10pt serif">[dirFile &larr; bitsFile &larr; nil]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">reset </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self obsolete⇒ [self open] self flush].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dirFile readonly; reset]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>FileDirectory</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">allocateSN: file </span><span style="font: 10pt serif">| sn [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitsFile position &larr; 010.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sn &larr; bitsFile next: 4.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(sn word: 2 &larr; (sn word: 2) + 1) = 0⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">overflow</span><span style="font: 10pt serif">" sn word: 1 &larr; (sn word: 1) + 1]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitsFile skip: ¬4; append: sn.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑sn]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">checkName: s </span><span style="font: 10pt serif">[⇑self checkName: s fixing: false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">realToVirtual: adr </span><span style="font: 10pt serif">["see </span><span style="font: bold 10pt serif">virtualToReal:</span><span style="font: 10pt serif">.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Alto address format is<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">bits<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">0-3</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">sector number (0 - 015, i.e. 12 or 14 sectors)<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">4-12</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">cylinder number (0 - 0312, Model 31; 0-0625, Model 44)<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">13</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">head number (0-1)<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">14</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">disk number</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">(0-1)<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">15</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">restore bit.<br><br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">in a system with two separable disks, addresses on disk 1 have a 0 disk bit, which is complemented by the disk primitive</span><span style="font: 10pt serif">"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑"vadr &larr;" ("</span><span style="font: italic 10pt serif">sector: field</span><span style="font: 10pt serif">" adr lshift: ¬12) +<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">("</span><span style="font: italic 10pt serif">cylinder and head: field*</span><span style="font: 10pt serif">" nSectors * ((adr land: 07774) lshift: ¬2)) +<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">("</span><span style="font: italic 10pt serif">disk: field*pages per disk</span><span style="font: 10pt serif">" [(adr land: 2) = 2⇒ [diskPages] 0]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"diskPages*(adr land: 2)/2")<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"vadr &lt; 0 or⦂ vadr ≥ totalPages⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self error: &rsquo;illegal disk address&rsquo;]"]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">rename: file newName: newName </span><span style="font: 10pt serif">| holesize pos [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[newName &larr; self checkName: newName⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self position &larr; newName⇒ [self error: &rsquo;new name already exists: &rsquo; + newName]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">a possible insertion place</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pos &larr; dirFile position]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self error: &rsquo;illegal new name: &rsquo; + newName].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self Find: (file &larr; self makeEntry: file)⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">holesize &larr; dirFile nextword land: dfmask-1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">dirFile skip: ¬2.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">file name: newName.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(self entrySize: file "</span><span style="font: italic 10pt serif">new size of entry</span><span style="font: 10pt serif">") ≤ holesize⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">new entry will fit in current entry</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pos &larr; dirFile position.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">read and save entry</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self nextEntry: file]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">delete and save entry</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self deleteEntry: file].<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">position to same entry or hole discovered earlier</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">dirFile position &larr; pos.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self addEntry: (file name: newName).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">file type is: Integer⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"file is open. defer leader page change until someone closes it"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">file type: write]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"close file: updating name in leader page" file type: write; close]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">file error: &rsquo;rename: old name does not exist&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">virtualToReal: vadr </span><span style="font: 10pt serif">| t2 d ["</span><span style="font: italic 10pt serif">inverse of </span><span style="font: bold 10pt serif">realToVirtual:</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"vadr &lt; 0 or⦂ vadr ≥ totalPages⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self error: &rsquo;illegal virtual address&rsquo;]"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"faster to do /\ for normal Integers"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"t &larr; vadr intdiv: diskPages.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sec &larr; t◦2 intdiv: nSectors"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[vadr &lt; diskPages⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">d &larr; 0.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">t2 &larr; vadr]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">d &larr; 2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">t2 &larr; vadr \ diskPages].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑("</span><span style="font: italic 10pt serif">sector</span><span style="font: 10pt serif">" (t2 \ nSectors) lshift: 12) +<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">("</span><span style="font: italic 10pt serif">cylinder & head</span><span style="font: 10pt serif">" (t2 / nSectors) lshift: 2) +<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">("</span><span style="font: italic 10pt serif">disk</span><span style="font: 10pt serif">" d "(vadr / diskPages) lshift: 1")]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Alto</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">addEntry: file </span><span style="font: 10pt serif">| entrysize holesize [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">called only by </span><span style="font: bold 10pt serif">Insert:</span><span style="font: italic 10pt serif"> and </span><span style="font: bold 10pt serif">rename:newName:</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[holesize &larr; dirFile nextword⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">either a deleted entry or rename entry</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">holesize &larr; holesize land: dfmask-1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">dirFile skip: ¬2]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">at end</span><span style="font: 10pt serif">"].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">entrysize &larr; self entrySize: file.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dirFile readwrite;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextword &larr; entrysize + dfmask.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">file storeOn: dirFile.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[holesize and⦂ entrysize &lt; holesize⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">mark remaining hole</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">dirFile nextword &larr; holesize-entrysize]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dirFile readonly.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitsFile flush]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">allocate: nextPage after: address </span><span style="font: 10pt serif">| index stop ch m vadr [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">index &larr; false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ true do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">go around bittable from address to end, and beginning to address.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">we start over again if the table appears full or bitsFile is out of sync</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[index and⦂ stop ≥ totalPages⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"wrap around to where we started"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">stop &larr; address.</span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">index &larr; 0]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[index ≡ false⇒ ["</span><span style="font: italic 10pt serif">first time or bitsFile out of sync</span><span style="font: 10pt serif">"]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">disk probabbly full</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user quitThen:<br>&rsquo;//   YOUR DISK IS FULL - Please make some space available.<br>//   Then resume Smalltalk and interrupt or continue as desired...&rsquo;].<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self open.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">index by bits rather than bytes? close enough for now</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">index &larr; address land: 0177770.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">stop &larr; totalPages].<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitsFile position &larr; index/8 + boffset.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ (index and⦂ (index &larr; index+8) ≤ stop) do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(ch &larr; bitsFile next) = 0377⇒ ["</span><span style="font: italic 10pt serif">8 full</span><span style="font: 10pt serif">"]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">check that bitsFile position is correct --<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">possibly out of sync with index if  growSmalltalkBy: occurred?</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitsFile position ≠ (index/8 + boffset)⇒ [index &larr; false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">m &larr; 0200.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ vadr from: index-8 to: index-1 do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(ch land: "nomask:" m) = 0⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">page appears free. first update DiskDescriptor</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitsFile skip: ¬1; next &larr; ch &larr; ch lor: m.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"then check if page is really free"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">vadr=0⇒ ["</span><span style="font: italic 10pt serif">O.S. boot</span><span style="font: 10pt serif">"]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">([nextPage init; freePage;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">address: (self virtualToReal: vadr);<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">doCommand: CCR error: false])⇒ [⇑vadr]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">page not really free</span><span style="font: 10pt serif">"]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">page not free according to bit</span><span style="font: 10pt serif">"].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">m &larr; m lshift: ¬1].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">checkName: fname fixing: fixing </span><span style="font: 10pt serif">| x copy special [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fname empty⇒[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">fixing⇒ [⇑&rsquo;$&rsquo;]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"empty name" ⇑false]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[fname length &gt; 38⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[fixing⇒ [fname &larr; fname◦(1 to: 38)]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"name too long" ⇑false]].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">copy &larr; (String new: fname length+1) asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">special &larr; &rsquo;.-+$!?&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ x from: fname do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"check characters: alphanumeric or 6 special"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">x isletter or⦂ ((special has: x) or⦂ x isdigit) ⇒ [copy next &larr; x]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">fixing⇒ [copy next &larr; special◦2]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"illegal character" ⇑false].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[fixing⇒ [fname last = (special◦1)⇒ [copy skip: ¬1]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fname last ≠ (special◦1)⇒ [copy next &larr;  special◦1]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑copy contents]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">configure: s </span><span style="font: 10pt serif">| nDisks nHeads nTracks [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"read disk configuration from a Stream:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">either leader page of SysDir or beginning of DiskDescriptor"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nDisks &larr; s nextword.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nTracks &larr; s nextword.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nHeads &larr; s nextword.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nSectors &larr; s nextword.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">diskPages &larr; nTracks * nHeads * nSectors.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">totalPages &larr; nDisks * diskPages]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">deallocate: page </span><span style="font: 10pt serif">| index ch m [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[dirFile≡nil⇒ [self open]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">index &larr; self realToVirtual: page address.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">character position</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitsFile position &larr; index/8 + boffset.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ch &larr; bitsFile next.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">bit position</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">m &larr; 0200 lshift: 0-(index land: 7).<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"make page free by turning off bit in DiskDescriptor"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(ch land: m) = m⇒ [bitsFile skip: ¬1; next&larr; ch - m]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user cr; show: &rsquo;page already free (dealloc:)&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">deleteEntry: file </span><span style="font: 10pt serif">| p [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">called only by </span><span style="font: bold 10pt serif">Delete:</span><span style="font: italic 10pt serif"> and </span><span style="font: bold 10pt serif">rename:newName:</span><span style="font: italic 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">read and save</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">p &larr; dirFile position.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self nextEntry: file.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dirFile position &larr; p.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">delete it from directory (turn off bit in entry length word)</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">p &larr; dirFile nextword land: dfmask-1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dirFile skip: ¬2; readwrite; nextword &larr; p; readonly; skip: ¬2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑file]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">diskID </span><span style="font: 10pt serif">| f u [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">return user name and disk name installed in O.S.</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(f &larr; self oldFile: &rsquo;sys.boot&rsquo;) readonly; position &larr; 512.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">u &larr; f nextString.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f padNext.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">u &larr; u, f nextString.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f close.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑u]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">diskNumber </span><span style="font: 10pt serif">["directory is: Integer⇒ [" ⇑directory "] ⇑directory diskNumber"]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">filesMatching: pattern </span><span style="font: 10pt serif">| files v i [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">files &larr; self match: [pattern last = (&rsquo;.&rsquo;◦1)⇒ [pattern] pattern + &rsquo;.&rsquo;].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">v &larr; Vector new: files length.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: v length do⦂ [v◦i &larr; (files◦i) name].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑v]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">flush </span><span style="font: 10pt serif">[bitsFile≡nil⇒ [] bitsFile flush]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">freePages </span><span style="font: 10pt serif">| npages ch i [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self open.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitsFile position &larr; boffset.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">npages &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: 1 to: totalPages by: 8 do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(ch &larr; bitsFile next) =0377⇒ ["</span><span style="font: italic 10pt serif">all used</span><span style="font: 10pt serif">"]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">possibly up to 8 unused</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">npages &larr; npages+8.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ ch = 0 do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">npages &larr; npages - (ch land: 1).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">ch &larr; ch lshift: ¬1]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑npages]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">growSmalltalkBy: n </span><span style="font: 10pt serif">| zfpt i file page a zlen ["dp0 growSmalltalkBy: 100."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">find and read last page of small.boot, then extend file</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; 1. zlen&larr; 96.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">zfpt &larr; CoreLocs new base: (Vmem specialLocs◦7) length: zlen*2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ zfpt◦(i+zlen) = 0 do⦂ [i &larr; i+1].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">a &larr; (zfpt◦(i+zlen-1)) + (zfpt◦i) - (zfpt◦(i-1)) - 1.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self open.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">file &larr; self makeEntry: &rsquo;small.boot.&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">page &larr; file newPage.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">page address: (self virtualToReal: a);<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">doCommand: CRR error: &rsquo;cannot read last page. growSmalltalkBy:&rsquo;.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">bypass reading file and creating random access table, just extend it</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">page lastPage⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">file serialNumber: page serialNumber;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">lastPage: page pageNumber;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pageAddresses: false "</span><span style="font: bold 10pt serif">Read:, Write:</span><span style="font: italic 10pt serif"> check this</span><span style="font: 10pt serif">";<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">Get: (page pageNumber: page pageNumber+n).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user space; print: self freePages; show: &rsquo; pages left.&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self error: &rsquo;growSmalltalkBy:. last page not last or 2 successive user grows&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">stampBoot </span><span style="font: 10pt serif">| a file page ["dp0 stampBoot."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"update the time stamps in leader page of current boot file"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"find SafeId for current boot file"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">a &larr; Vmem specialLocs◦13.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">file &larr; self makeEntry: &rsquo;&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">file serialNumber: mem◦a, (mem◦(a+1)).<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"read page one of the boot file to find out the leader address"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">page &larr; file makeEntry: 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">page address: mem◦(a+4).<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"then set leader address and dirty flag, and close file<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">thereby updating create/write/read dates, but not name"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">file doCommand: CCR page: page error: &rsquo;cannot read page 1 of boot file&rsquo;;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">leader: (page header: backp);<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">type: write;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">close]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪AltoFileDirectory under: &rsquo;Alto File System&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"AltoFilePage"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;AltoFilePage&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: FilePage<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;address&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sharing: AltoFilePool;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>A FilePage from an AltoFile consists of a header (2 words), a label (8 words) and data (512 characters)</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>FilePage</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">address </span><span style="font: 10pt serif">[⇑address]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">address: address</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">headerLength </span><span style="font: 10pt serif">[⇑16]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">page ≡ nil⇒ [super init]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">nextp, backp, lnused, numch, pn</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">page fill: 1 to: 10 with: 0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">lastPage </span><span style="font: 10pt serif">[⇑("self header:" page word: nextp) = 0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">length </span><span style="font: 10pt serif">[⇑"self header:" page word: numch]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">length: len </span><span style="font: 10pt serif">["self header:" page word: numch &larr; len]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pageNumber </span><span style="font: 10pt serif">[⇑"self header:" page word: pagen]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pageNumber: pn </span><span style="font: 10pt serif">["self header:" page word: pagen &larr; pn]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">serialNumber </span><span style="font: 10pt serif">[⇑page◦(13 to: 16)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">serialNumber: sn </span><span style="font: 10pt serif">["page◦(13 to: 16) &larr; sn"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">page copy: 13 to: 16 with: sn from: 1 to: 4.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"self header:" page word: vn &larr; 1 "fixed version"]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Alto</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">freePage </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">label for a free page: version, sn1, sn2 = ¬1</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">page fill: 11 to: 16 with: 0377]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪AltoFilePage under: &rsquo;Alto File System&rsquo;.</span></div>
    <div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">&rsquo;From Smalltalk 5.5k XM November 24 on 22 November 1980 at 2:57:08 am.&rsquo;<br></span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">"ILFile"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;ILFile&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: File<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sharing: ILFilePool;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>An IFS file accessed through the Leaf protocol, 12/79</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Dictionary</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">entryClass </span><span style="font: 10pt serif">[⇑ILFilePage]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>File</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit </span><span style="font: 10pt serif">| i sym names ["ILFile classInit."<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ILFilePool declare: ↪NotFound as: &rsquo;207&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">names &larr; ↪(<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">1011 (BadLeafHandle)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">02000 (AnswerBit)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">0176000 (RequestBits)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">0260 (LeafType)<br>"5-bit operations for left field command block word"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">0 (Error Open Close Delete)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">6 (Read Write Reset)<br><br>"read/write modes"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">0140 (SetEof "no holes, set eof")<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">0200 (NoExtend "don&rsquo;t extend file on read or write")<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">0100 (NoHoles "for writing past end")<br><br>"open file modes"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">0163400 (WriteOld "read, write, extend, any explicit, highest")<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">0103400 (ReadOld "read, any explicit, highest")<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">0167600 (CreateNew "read, write, extend, create, any explicit, next")<br><br>"control codes for left half of pupID1 field"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">0 (Data Ack Noop)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">5 (OpenConnection "if Reset")<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">9 (DestroyConnection Dally Quit BrokenConnection)) asStream.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: names do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ sym from: names next do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">ILFilePool declare: sym as: i.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; i+1]]]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">close </span><span style="font: 10pt serif">["ignore errors if file was readonly" self close: [type = read⇒ [false] &rsquo;close&rsquo;]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">close: e </span><span style="font: 10pt serif">| p ["close file, possibly ignoring errors"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"for next open"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">type &larr; read.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"shorten header block to first 2 words: command&length,  file handle"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">p &larr; self newPage.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">p length: ¬6.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self doCommand: Close page: p error: e]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">doCommand: com page: page error: e </span><span style="font: 10pt serif">| in ecode [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">page command: com.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ true do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"make sure connection is open"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">directory open.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">error &larr; nullString.<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[in &larr; directory socket sendPacket: page packet⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">in◦11 = BrokenConnection⇒ [ecode &larr; ¬1]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"turn packet into a ILFilePage"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">in &larr; [(self entryClass new) dictionary: self; page: in].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"check if answer is of same type as request"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">((page header: 1) land: RequestBits) + AnswerBit =<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">((in header: 1) land: RequestBits)⇒ [⇑in]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">ecode &larr; in header: 2]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"no response?"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">ecode &larr; false].<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"some kind of problem"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">com = Quit⇒ ["ignore" ⇑false]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ecode ≡ false or⦂ ecode = ¬1⇒ ["make new connection" directory release]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">ecode = ¬1 or⦂ ecode = 1011⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"try again after some reinitializing"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"reopen file"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self reopen.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"init page with new handle only -- don&rsquo;t lose mode, length, etc."<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">page serialNumber: serialNumber]<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">error &larr; [ecode⇒ [e⇒ [self errorString: ecode] ecode asString]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">directory directory + &rsquo; not responding&rsquo;].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">e⇒ [self error: e "proceeding tries again"]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">endFile: page </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"make sure we can write"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self writeMode: page.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"update length. this will end file with this page"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">lastpn &larr; page pageNumber.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self Write: page]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">errorString: errorCode </span><span style="font: 10pt serif">| ef ename errorString notfound dollar cr [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[errorCode is: String⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">errorString &larr; errorCode.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">errorCode &larr; [(errorString◦1) isdigit⇒ [errorString asInteger] 0]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">errorString &larr; errorCode asString].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ename &larr; &rsquo;&lt;System&gt;Ifs.Errors&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(self name compare: ename) = 2⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"recursion" ⇑errorString + &rsquo; (cannot access Ifs.Errors !!!)&rsquo;]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">notfound &larr; errorString + &rsquo;</span><span class="tab" val="79"></span><span style="font: 10pt serif">(error code not found)&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">errorCode ≤ 0⇒ [⇑notfound]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dollar &larr; &rsquo;$&rsquo;◦1. cr &larr; 015.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ef &larr; directory oldFile: ename.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ef readonly.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">errorString &larr; false.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"scan through the errors file looking for lines of the form:<br>$$nn</span><span class="tab" val="79"></span><span style="font: 10pt serif">some message<br>"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ errorString do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">ef skipTo: dollar⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">ef next = dollar⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"valid line"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">ef integerScan<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&gt; errorCode⇒ ["since errors are ordered" errorString &larr; notfound];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">= errorCode⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">errorString &larr; (String new: 200) asStream.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">errorString print: errorCode.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ (ef peek = dollar or⦂ ef peek = cr) do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">errorString append: (ef upto: cr); space].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">errorString &larr; errorString contents]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"end of file"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">errorString &larr; notfound].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ef close.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑errorString]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">findLastPage </span><span style="font: 10pt serif">["already known from open" ⇑lastpn]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">open </span><span style="font: 10pt serif">"do nothing. lastpn set by </span><span style="font: bold 10pt serif">ILFileDirectory Find:</span><span style="font: 10pt serif">"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">Read: page </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">page pageNumber &gt; lastpn⇒ ["no page" ⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"don&rsquo;t extend beyond eof. length of page is 0, but request is for 512 bytes"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">page mode: NoExtend; header: 5 &larr; 512 "self dataLength".<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self doCommand: Read page: page error: &rsquo;Read:&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">release </span><span style="font: 10pt serif">[self close: false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">Write: page </span><span style="font: 10pt serif">| pn [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(pn &larr; page pageNumber) &gt; (lastpn+1)⇒ [self error: &rsquo;illegal page number&rsquo;]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"make sure we can write"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self writeMode: page.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">page mode: [pn ≥ lastpn⇒ [SetEof] NoHoles].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self doCommand: Write page: page error: &rsquo;Write:&rsquo;.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"file possibly extended"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pn = (lastpn+1)⇒ [lastpn &larr; pn]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑page]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">writeMode: page </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"make sure we can write on file"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">type = write⇒ []<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"turn on writing by closing and reopening file. eventually there might be<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">a simpler way to change file mode"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self close.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">type &larr; write.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">directory Find: self⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"file handle changed"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">page serialNumber: serialNumber]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self error: &rsquo;file failed to reopen&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>IFS</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">allocatePage </span><span style="font: 10pt serif">[⇑directory allocatePage]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪ILFile under: &rsquo;IFS File System&rsquo;.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">ILFile classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"ILFileDirectory"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;ILFileDirectory&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: FileDirectory<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;userName userPassword isocket&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sharing: ILFilePool;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>IFS directory, 12/79</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Dictionary</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">Delete: file </span><span style="font: 10pt serif">["delete a file (highest version)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">shorten header block to 2 words: command&length,  file handle"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(file newPage) length: ¬6; doCommand: Delete error: &rsquo;Delete:&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">entryClass </span><span style="font: 10pt serif">[⇑ILFile]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">Find: file </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"since there can be many readers but only one writer, default mode is for<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">read only. writing will cause file to be closed and reopened for writing"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self openFile: file mode: [file type = write⇒ [WriteOld] ReadOld]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">Insert: file </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">file type: write.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self openFile: file mode: CreateNew⇒ [⇑file]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">file error: &rsquo;Insert: cannot create&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">obsolete </span><span style="font: 10pt serif">[⇑isocket ≡ nil]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">open </span><span style="font: 10pt serif">| page [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">isocket ≡ nil "self obsolete"⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[isocket &larr; ILSocket new hostName: directory "name of IFS/Leaf server"⇒ []<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">isocket &larr; nil.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: directory + &rsquo; (name not found)&rsquo;].<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">super open.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">page &larr; self newPage.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"treat packet in page as a parameter block"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(ILParameterBlock new)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">packet &larr; page packet;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextword &larr; 0; "host number (0 = this, ¬1 = all)"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextString &larr; self userName;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextString  &larr; self userPassword.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">page doCommand: Reset error: false⇒ []<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">isocket &larr; nil.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: &rsquo;open (reset)&rsquo;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">release </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self obsolete⇒ []<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"shorten header block to 0 words.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DestroyConnection. after this the connection is gone"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(self newPage) length: ¬10; doCommand: Quit error: false.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">isocket close.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">isocket &larr; nil]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">versionNumbers </span><span style="font: 10pt serif">[⇑true]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>IFS</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">allocatePage </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[isocket≡nil⇒ [self open]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"return a packet to be used by ILFilePage"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑isocket freePacket]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">name: userName password: userPassword</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">noAck </span><span style="font: 10pt serif">["an optimization for intense ether activity" isocket noAck]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">openFile: file mode: m </span><span style="font: 10pt serif">| page [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"open bit modes<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">read<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">write<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">extend<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">multiple (0)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">create name<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">explicit version in name (2b)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">no, old, next or old, any<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">default (if no version specified) (2b)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">no, lowest, highest, next<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">unused (7b)"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self open.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">page &larr; file newPage.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"treat packet in page as a parameter block"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(ILParameterBlock new)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">packet &larr; page packet;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextword &larr; 0; "file handle"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextword &larr; m; "modes"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextString &larr; self userName;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextString  &larr; self userPassword;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextString &larr; &rsquo;&rsquo;; "connect name"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextString &larr; &rsquo;&rsquo;; "connect password"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextString &larr; self checkName: file name.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"answer bits (in page header: 5)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">same (5b)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">version (4b)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">bad, default lowest, default highest, default next, !*, !L, !H, !N, explicit old, explicit lowest, explicit highest, explicit next, explicit new, explicit-less, explicit between, explicit greater"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">page &larr; file doCommand: Open page: page error: false⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">file serialNumber: page serialNumber.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"open returns file length"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">file lastPage: (page pageNumber - [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">((page header: 4) land: 0777) =0⇒ ["full last page" 1] 0] max: 1)]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">file error = NotFound⇒ [⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑file error: &rsquo;open &rsquo; + (file errorString: file error)<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">socket </span><span style="font: 10pt serif">[⇑isocket]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">userName </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">userName ≡ nil or⦂ userName empty⇒ [⇑super userName]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑userName]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">userPassword </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">userPassword ≡ nil or⦂ userPassword empty⇒ [⇑super userPassword]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑userPassword]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪ILFileDirectory under: &rsquo;IFS File System&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"ILFilePage"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;ILFilePage&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: EtherFilePage<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sharing: ILFilePool;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>12/79, SAW.<br>Format of header is generally (for read/write)<br>1 operation (5 bits opcode, 1 bits request/answer, 10 bits inclusive byte length of block<br>2 file handle<br>3&4 byte address (mode in high 5 bits)<br>5 byte length</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>FilePage</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">headerLength </span><span style="font: 10pt serif">[⇑34 "4+20+10"]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">length </span><span style="font: 10pt serif">["valid for read or write" ⇑self header: 5]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">length: len </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"10 bytes in a normal header block. ILParameterBlock can change things.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">also negative lengths can shorten it and change pupLength"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"length of command block, including data"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self header: 1 &larr; 10 + len.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"number of data bytes to read/write"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self header: 5 &larr; len.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"set pupLength"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">super length: len]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pageNumber </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"extract page number from 27-bit byte address. ignore high 5 mode bits.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dividing byte adress (which may be a LargeInteger) by self dataLength (512)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">is the correct but slow way to do this. byte address 0 = page 1"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑(((self header: 3) land: 03777) * 0200 "lshift: 7, maybe large") +<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">((self header: 4) lshift: ¬9) + 1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pageNumber: pn </span><span style="font: 10pt serif">["inverse of </span><span style="font: bold 10pt serif">pageNumber</span><span style="font: 10pt serif">. set 5 mode bits to 0"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pn &larr; pn-1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self header: 3 &larr; pn / 0200 "lshift: ¬7, except for large pn".<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self header: 4 &larr; pn lshift: 9]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">serialNumber </span><span style="font: 10pt serif">| sn [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sn &larr; String new: 4.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sn◦1 &larr; sn◦2 &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sn word: 2 &larr; self header: 2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑sn]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">serialNumber: sn </span><span style="font: 10pt serif">[self header: 2 &larr; sn word: 2]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>IFS</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">command: com </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"operation word (header 1)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">0-4<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">opcode<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">5<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">0 request<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">1 answer<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">6-15<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">inclusive byte length of operation block"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">page pupType &larr; LeafType.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"make operation a request, preserve length set earlier"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">page◦25 &larr; (page◦25 land: 3) + (com lshift: 3).<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"left half pupID1"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">page◦11 &larr; [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">com = Reset⇒ [OpenConnection]; = Quit⇒ [DestroyConnection] Data]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">mode: m </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">current meaning of 5 read/write bits (from high to low):<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">0-1<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">0 read or write anywhere<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">1 no holes (read or write) zeros past end<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">2 don&rsquo;t extend on read or write<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">3 check extend (Error)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">2<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">1 set eof<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">3-4<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">0 undefined</span><span style="font: 10pt serif">"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"m is a byte which is already shifted"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">page◦29 &larr; (page◦29 land: 7) + m]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪ILFilePage under: &rsquo;IFS File System&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"ILParameterBlock"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;ILParameterBlock&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;packet position&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sharing: ILFilePool;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>for passing parameters to IFS. primarily used by ILFileDirectory open & openFile:</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">packet &larr; packet </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"default is an empty (data) packet, except first header word"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self position: 26]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Changing values</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">nextString &larr; s </span><span style="font: 10pt serif">| strm [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm &larr; packet pupString asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm skip: position; nextword &larr; s length; append: s; padNext &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self position: strm position]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">nextword &larr; w </span><span style="font: 10pt serif">| strm [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm &larr; packet pupString asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm skip: position; nextword &larr; w.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self position: strm position]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">position: position </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"changing length of data in packet"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">packet pupLength &larr; position - 2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"set inclusive byte length in first command word; rest set later"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">packet word: 13 &larr; position - 24]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪ILParameterBlock under: &rsquo;IFS File System&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"ILSocket"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;ILSocket&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: RetransmitSocket<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;seqNum outPac result abortTransfer outAck&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sharing: ILFilePool;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>for communicating with a Leaf socket on an IFS server, 12/79</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Socket</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">net: n host: h </span><span style="font: 10pt serif">["usually called by </span><span style="font: bold 10pt serif">hostName:</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">seqNum &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">super net: n host: h soc: 043 asInt32.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self retransmit: 8 every: [n = NETNUM⇒ ["same net" 400] 1800].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self setAck]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">noAck </span><span style="font: 10pt serif">["if acknowledgements are not needed" outAck &larr; false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sendPacket: outPac </span><span style="font: 10pt serif">| nseq [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"send a packet, wait for result, and acknowledge.<br></span><span class="tab" val="79"></span><span style="font: bold 10pt serif">RetransmitSocket setAddressesAndComplete:</span><span style="font: 10pt serif"> sets timer<br></span><span class="tab" val="79"></span><span style="font: bold 10pt serif">ILSocket socProcess:</span><span style="font: 10pt serif"> receives answers<br></span><span class="tab" val="79"></span><span style="font: bold 10pt serif">ILSocket timerFired</span><span style="font: 10pt serif"> handles retransmissions"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">result &larr; abortTransfer &larr; false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"alloc, receiver seq"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outPac pupID0 &larr; <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"command, send seq"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outPac◦12 &larr; "pupID1 &larr; (outPac pupID1 land: 0177400) +" seqNum.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self setAddressesAndComplete: outPac.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"while waiting for packet to arrive, set up ack"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nseq &larr; (seqNum +1) \ 256.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[outPac◦11 = DestroyConnection⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"assume reply will be Dally. send Quit to shut down connection a little faster"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[outAck⇒ []<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"create ack"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self setAck.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">outAck pupID0 &larr; outAck◦12 &larr; seqNum].<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">outAck◦11 &larr; Quit.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">retransMax &larr; 0.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"same sequence numbers as previous"]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outAck⇒ ["acknowledgement for Open & Data"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">outAck pupID0 &larr; outAck◦12 &larr; nseq]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"in rapid interchanges, the next request is an implicit ack, so it&rsquo;s faster not to send one. however, packets unacknowledged for ~5 secs. at the server end can cause degraded performance"].<br> <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"now wait for </span><span style="font: bold 10pt serif">socProcess:</span><span style="font: 10pt serif"> to set result, or </span><span style="font: bold 10pt serif">timerFired</span><span style="font: 10pt serif"> to set abortTransfer"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ (result or⦂ abortTransfer) do⦂ [].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[result⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">seqNum &larr; nseq.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">outAck⇒ ["send ack" self completePup: outAck]]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑result]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">setAck </span><span style="font: 10pt serif">["create acknowledgement packet"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outAck &larr; self freePacket.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outAck pupType &larr; LeafType.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outAck dataString &larr; &rsquo;&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"control code"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outAck◦11 &larr; Ack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self setAddresses: outAck]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">socProcess: Ipac </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"check if this is a packet we want. normally left half of pupID1 = Data (0).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">in case of DestroyConnection, control code might be Dallying (10)"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Ipac◦12 "pupID1" = seqNum and⦂ Ipac pupType = LeafType⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"turn off timer, save result"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self timerOff.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">result &larr; Ipac]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"recycle packet"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self freePacket: Ipac]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">timerFired </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"timer has fired -- retransmit or abort"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">result or⦂ abortTransfer⇒ ["bug?--timer may not have been disabled yet"]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self timerOn⇒ ["retransmit" self completePup: outPac]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"abort"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">abortTransfer &larr; true]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪ILSocket under: &rsquo;IFS File System&rsquo;.</span></div>
    <div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">&rsquo;From Smalltalk 5.5k XM November 24 on 22 November 1980 at 2:57:08 am.&rsquo;<br></span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">"EventQueue"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;EventQueue&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Queue<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;primitivequeue readwriteelapsed time&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;read elapsed write &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>The EventQueue (Events) is a subclass of class Queue.  It contains a regular queue which is filled from a block of memory (currently 128 words long), updated during the 60HZ interrupt.  This block of memory is called the primitivequeue, and is unpacked into the regular queue when events are available upon receiving the message peek or next.  The fundamental difference between peek and next is that next dequeues the current event and peek does not.  Furthermore peek will return false when the queue is empty, and next, when the queue is empty, will create a time elapsed event and return that.  An event will be of class UserEvent as created by the primitiveDequeue and next  messages. The machine code thinks of events as a 4-word structure as follows:<br><br>Word 1:<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Left Byte:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">1 = Key down.  0 = Key up.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Right Byte:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">8-bit Ascii value.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Mouse Buttons:</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Left/Top</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">=</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">0<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Middle</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">=</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">1<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Right/Bottom</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">=</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">2<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Keyset:</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Leftmost</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">=</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">3<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">=</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">4<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">=</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">5<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">=</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">6<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Rightmost</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">=</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">7<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Values 8 - 255, keyboard decodings as expected by rawkbd.<br><br>Word 2:</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Time (sixtieths of a second since last event).<br><br>Word 3:</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Cursor x coordinate (UserView htab accounted for).<br><br>Word 4:</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Cursor y coordinate (UserView vtab accounted for)..<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 10pt serif"> </span><span style="font: italic 10pt serif">"sets up system wide event queue -- only one from the present"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"***BEWARE, USED ONLY AT TIME OF SYSTEM GENERATION***"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">primitivequeue &larr; CoreLocs new base: (mem◦0114) length: (mem◦0115).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">readwriteelapsed &larr; CoreLocs new base: 0111 length: 3.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">read &larr; 0. write &larr; 1. elapsed &larr; 2.</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"offsets of read, write and elapsed pointers"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">time &larr; 0.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"start time at 0"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">super of: (Vector new: 4). </span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"initialize Smalltalk queue"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Public Access</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">elapsedtime </span><span style="font: 10pt serif">[⇑readwriteelapsed◦elapsed] </span><span style="font: italic 10pt serif">"return elapsed time"</span><span style="font: 10pt serif"><br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">next </span><span style="font: 10pt serif">| event elapsedtime </span><span style="font: italic 10pt serif">"return event from queue unless both queues empty,  when return null event"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[event &larr; self dequeue ⇒ [⇑event]</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Queue not empty?"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">event &larr; self primitiveDequeue ⇒ [⇑event]</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"primitivequeue not empty?"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">elapsedtime &larr; readwriteelapsed◦elapsed.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑UserEvent new</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"when empty return null event"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">x:</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user x</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"event x"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">y:</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user y</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"event y"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">type:</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">0</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"2=up, 1=down, 0=null, only time passed"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">stroke:</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">0</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"0 stroke for null event"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">elapsed:</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">elapsedtime</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"1-32767 sixtieths of a sec -- since last event"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">time:</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(time + elapsedtime) asSmall</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"time since timer reset"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">peek </span><span style="font: 10pt serif">| event </span><span style="font: italic 10pt serif">"unless both queues empty, return event from queue, but dont dequeue"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[event &larr; super peek ⇒[ ⇑event]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">event &larr; self primitiveDequeue ⇒ [⇑self next &larr; event]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false</span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">reset </span><span style="font: italic 10pt serif">"for the present, just reset time to 0"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[time &larr; 0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">time </span><span style="font: 10pt serif">[⇑time]</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> </span><span style="font: italic 10pt serif">"return time"</span><span style="font: 10pt serif"><br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">time &larr; time</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 10pt serif"> </span><span style="font: italic 10pt serif">"reset time"</span><span style="font: 10pt serif"><br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Private</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">primitiveDequeue </span><span style="font: 10pt serif">| rp tands nrp event elapsedtime<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"unless empty, return event from primitivequeue"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(readwriteelapsed◦read) = (readwriteelapsed◦write) ⇒ </span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑false].</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"primitivequeue empty?"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"Build event from primitive queue and return it."<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"first word has type and stroke packed"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">tands &larr; primitivequeue◦(rp &larr; readwriteelapsed◦read).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">elapsedtime &larr; primitivequeue◦(rp + 1).</span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">event &larr; UserEvent new<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">x:</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">primitivequeue◦(rp + 2)</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"event x"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">y:</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">primitivequeue◦(rp + 3)</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"event y"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">type:</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[tands &lt; 0 ⇒ [2] 1]</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"2=up, 1=down"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">stroke:</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[tands &gt; 0 ⇒ [tands] 0 - tands]</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"1-336"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">elapsed:</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">elapsedtime</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"1-32767 sixtieths of a second"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">time:</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(time &larr; (time + elapsedtime) asSmall).<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nrp &larr; rp + 4.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"set bumped read pointer"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[nrp ≥ (primitivequeue length) ⇒ [nrp &larr; 1]].</span><span class="tab" val="79"></span><span style="font: 10pt serif">"Wrap-around?"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">readwriteelapsed◦read &larr; nrp.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"bump read pointer"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑event</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"Return event"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪EventQueue under: &rsquo;Events&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"MessageTally"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;MessageTally&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;class method tally rcvrs&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;timer &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>The following statement analyzes the evaluation of &rsquo;user restore&rsquo;.  It checks every 10 sixtieths of a second to see what method is being executed.  It prints the analysis on file &rsquo;restore.spy&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">spy every: 10; on⦂ [user restore]; report: &rsquo;restore.spy&rsquo;; close.<br>Read further to learn of more flexible ways to use message tallies.<br><br>A message tally is a tally of how many times, according to some authority, a certain method or any of that method&rsquo;s callees has been invoked.  Message tallies for the callees are listed in the vector, rcvrs; thus, each message tally is a node in a tree.  The root of that tree is called the &rsquo;root tally&rsquo;; its method the &rsquo;root method&rsquo;; and the context that was running that method the &rsquo;root context&rsquo;.  Contexts that do not have the root context on their stack are tallied as if the root context were at the bottom of their stack.<br><br>The authority informs the root tally of invocations in either of two ways: &rsquo;explicitly&rsquo; or by &rsquo;spying&rsquo;.<br><br>To explicitly create the tallies from a root context, rc, a root tally is created with:<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">mt &larr; MessageTally new from: rc<br>and is informed of the invocation of each context c with:<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">mt tally: c<br><br>To spy on (periodically sample) the execution of a statement sequence, ss, every t sixtieths of a second (t&gt;1), a root tally is created with:<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">mt &larr; MessageTally new every: t<br>and is informed of invocations with:<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">valOfSS &larr; mt on⦂ [ss].<br>The context that executes the latter statement is the root context.  Its method should not be called recursively by ss.  Only one spying operation can be in progress at a time, and all spies share the most recently specified time interval.  Thus, there may as well be only one spying message tally in existence, and the global variable &rsquo;spy&rsquo; is predefined as such.<br><br>Spying typically adds 1/4 second per probe to execution.  Ctrl-shift-esc can be used to abort a spying operation.<br><br>Tallies can be printed by:<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">mt report: &rsquo;filename.spy&rsquo;<br>which prints two tables of invocations sorted by tally, with tallies expressed as percentages and with methods described in terms of their defining class and selector.  In the first table, &rsquo;Leaves&rsquo;, tallies do not include time spent in submethods (this is like the spy in Swat).  In the second table, &rsquo;Tree&rsquo;, the percentages do include time spent in submethods, and those submethods are displayed indented.  In both tables, entries below a &rsquo;cutoff&rsquo; of 2 per cent are suppressed.<br><br>Different cutoffs can be specified for each table.  To cut off Leaves at 7.5 per cent and Tree at 3 per cent, use:<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">mt report: &rsquo;filename.spy&rsquo; cutoff: 7.5,3<br>A cutoff of 100 or greater suppresses printing of that table completely.  To output to a specified stream, use the message &rsquo;fullprinton:cutoff:&rsquo;.<br><br>To release the storage occupied by the tally tree, use the message &rsquo;close&rsquo;.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Public Tallying</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">abort<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[timer is: Timer⇒ [timer disable]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[Smalltalk define: ↪spy as: (MessageTally new every: 10)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">close </span><span style="font: italic 10pt serif">"release storage"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[class &larr; method &larr; tally &larr; rcvrs &larr; nil]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">every: sixtieths</span><span class="tab" val="79"></span><span style="font: bold 10pt serif">  </span><span style="font: italic 10pt serif">"Create a spy that samples with the specified period"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self abort. timer &larr; Timer new for: sixtieths action⦂ [self tally: Top◦1. timer reset]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">from: context  </span><span style="font: italic 10pt serif">"Create a tallier from the specified root"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self class: context receiver class method: context method]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">moreon⦂ remote </span><span style="font: 10pt serif">| val  </span><span style="font: italic 10pt serif">"Spy on the specified evaluation without resetting"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["use as follows:<br></span><span style="font: bold 10pt serif">eachtime  <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[spy every: 10.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑spy moreon⦂ [super eachtime].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">class &larr; remote receiver class.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">method &larr; remote method. <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">timer reset. val &larr; remote eval. timer disable. ⇑val]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">on⦂ remote </span><span style="font: 10pt serif">| val  </span><span style="font: italic 10pt serif">"Spy on the specified evaluation"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self from: remote. timer reset. val &larr; remote eval. timer disable. ⇑val]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">reset<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["reset stats"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tally &larr; 0. rcvrs &larr; Vector new: 0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">tally: context </span><span style="font: 10pt serif">| root  </span><span style="font: italic 10pt serif">"Explicitly tally the specified context and its stack"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[context method≡method⇒ [⇑self bump]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(root &larr; context sender)≡nil⇒[⇑self bump tallyPath: context]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑(self tally: root) tallyPath: context]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Public Reporting</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fullprinton: s cutoff: pct </span><span style="font: 10pt serif">| set mt i t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user displayoffwhile⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s print: tally; append: &rsquo; tallies&rsquo;; cr. tally=0⇒ []<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s cr; cr. [pct is: Vector⇒ [] pct &larr; pct, pct].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pct◦1&lt;100⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s append: &rsquo;**Leaves**&rsquo;; cr. t &larr; ((pct◦1)*(tally-1)/100) asInteger.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">set &larr; HashSet new init: 128. self leaves: set.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self cumprinton: s from: set total: tally over: t. s next&larr;12; cr.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">set &larr; nil]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pct◦2&lt;100⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s append: &rsquo;**Tree**&rsquo;; cr. t &larr; ((pct◦2)*(tally-1)/100) asInteger.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self treeprinton: s tab: 0 total: tally over: t. s next&larr;12; cr]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s skip: ¬2]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[class≡nil⇒ [super printon: s] self printon: s total: 100]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">report: filename<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self report: filename cutoff: 2]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">report: filename cutoff: pct </span><span style="font: 10pt serif">| f  </span><span style="font: italic 10pt serif">"pct=(leaves,roots,tree) or one number for all"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[f &larr; dp0 file: filename. f append: filename; space.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self fullprinton: f cutoff: pct. f close]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Private Tallying</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">bump<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[tally &larr; tally+1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">tallyPath: context </span><span style="font: 10pt serif">| m path mt c<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[m &larr; context method. path&larr;false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ mt from: rcvrs do⦂ [mt method≡m⇒ [path&larr;mt]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[path≡false⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[path &larr; MessageTally new class: context receiver class method: m. rcvrs &larr; rcvrs, path]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑path bump]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Private Reporting</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">&lt; mt<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑tally &gt; mt tally]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">= mt<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑mt method≡method]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">&gt; mt<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑tally &lt; mt tally]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">breakdown </span><span style="font: 10pt serif">| n b mt<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[b &larr; rcvrs. b≡nil or⦂ b length=0⇒ [⇑↪()]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">n &larr; tally. for⦂ mt from: b do⦂ [n &larr; n - mt tally].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[n&gt;0⇒ [b &larr; b, [MessageTally new class: class method: method; primitives: n]]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑b]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">bump: n<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[tally &larr; tally+n]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">cumprinton: s from: set total: total over: threshold </span><span style="font: 10pt serif">| mt<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ mt from: set contents sort do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[mt tally&gt;threshold⇒ [mt printon: s total: total. s cr] ⇑self]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hash<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑method asOop]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">into: set </span><span style="font: 10pt serif">| mt i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[i &larr; set find: self⇒ [mt &larr; set objects◦i]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">set insert: (mt &larr; MessageTally new class: class method: method)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">mt bump: tally]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">leaves: ldict </span><span style="font: 10pt serif">| b mt<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[b &larr; self breakdown. b length=0⇒ [self into: ldict] for⦂ mt from: b do⦂ [mt leaves: ldict]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">primitives: tally<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[rcvrs &larr; nil]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: s total: total </span><span style="font: 10pt serif">| i v<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[v &larr; (0.0+tally/total*1000.0+0.5) asInteger asString. i &larr; v length.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s append: &rsquo;  &rsquo;◦(i to: 2); append: v◦(1 to: i-1); append: &rsquo;.&rsquo;; next&larr;v◦i; space.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rcvrs≡nil⇒ [s append: &rsquo;primitives&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">class describe: method on: s]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">tally<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑tally]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">treeprinton: s tab: tab total: total over: threshold </span><span style="font: 10pt serif">| i mt<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[tally≤threshold⇒ []<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[tab&gt;0⇒ [for⦂ i to: tab-1 do⦂ [s append: &rsquo;  |&rsquo;]. self printon: s total: total. s cr]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ mt from: self breakdown sort do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[mt treeprinton: s tab: tab+1 total: total over: threshold]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Private Common</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">class: class method: method<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[tally &larr; 0. rcvrs &larr; Vector new: 0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">method<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑method]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪MessageTally under: &rsquo;Events&rsquo;.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">MessageTally classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"PriorityInterrupt"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;PriorityInterrupt&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;scheduler priority&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>PriorityInterrupts fill the need for (sched, level) pairs.  Most messages are simply passed on to the scheduler with the priority as an argument</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">from: scheduler at: priority</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Level numbers</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">+ arg<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑priority + arg]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Scheduling</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">deepsleep<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[scheduler deepsleep: priority]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">disable<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[scheduler disable: priority]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">enable<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[scheduler enable: priority]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">reset<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[scheduler reset: priority]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">restart<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[scheduler restart: priority]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">run: newContext<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[scheduler run: newContext at: priority] primitive: 87</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sleep<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[scheduler sleep: priority]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">swap: newContext<br></span><span class="tab" val="79"></span><span style="font: bold 10pt serif"> with: fieldReference<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[scheduler<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">swap: newContext<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">at: priority<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">with: fieldReference] primitive: 88</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">terminate<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[scheduler terminate: priority]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">wakeup<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[scheduler wakeup: priority]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪PriorityInterrupt under: &rsquo;Events&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"PriorityScheduler"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;PriorityScheduler&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;</span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sourceIndirect<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">"an indirect reference to the source of power,<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">ie the source from which this scheduler was spawned,<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">and who therefore holds the suspension if it is suspended."<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">suspendedContexts<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">"&lt;Vector of Contexts&gt; the suspended processes"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">initialContexts<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">"&lt;Vector of Contexts&gt; root processes for restarting"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">enabledPriorities<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">"&lt;Integer&gt; priorities which can receive control"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">awakePriorities<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">"&lt;Integer&gt; priorities which are requesting control"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">interruptedPriorities<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">"&lt;Integer&gt; new priorities which are requesting control"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">currentPriority<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">"&lt;Integer&gt; priority which currently has control"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">usedPriorities<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">"&lt;Integer&gt; priorities which have processes installed"&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;TimeInt CtlCDisp UserInt GRODSK CtlShftEscInt CtlCInt &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sharing: BitMasks;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>The underlying machine has a pointer to the top-level scheduler (Top), so that physical interrupts can also cause interrupts in Smalltalk.  This they do by calling their own copy of wakeup and reselect.  This copy is also invoked (primitive 65) when reselect is sent to the top-level scheduler, since its source is the virtual machine itself.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">◦ priority<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑suspendedContexts◦priority]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">currentPriority </span><span style="font: 10pt serif">[⇑currentPriority]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fromSource: sourceIndirect<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Initialize a scheduler having 16 spaces for processes"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> suspendedContexts &larr; Vector new: 16.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> initialContexts &larr; Vector new: 16.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> enabledPriorities &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> awakePriorities &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> interruptedPriorities &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> usedPriorities &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> currentPriority &larr; 0.]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">replaceUser: stack<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[UserInt run: stack]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Install and Terminate</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">install⦂ newContext above: priority </span><span style="font: 10pt serif">| i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Install a process in the next empty level above &lt;priority&gt; which is initialized from &lt;newContext&gt; (a remote Context). If there is no empty level above that priority, tell the user and return false"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> newContext sender &larr; nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> for⦂ i from: (priority+1 to: 16) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(usedPriorities land: biton◦i) = 0⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">INSTALL⦂ [while⦂ true do⦂ [newContext cleancopy eval]]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">AT: i]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> user show:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;PriorityScheduler unable to install above level &rsquo;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">+priority asString<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">+&rsquo;. false returned&rsquo;. ⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">install⦂ newContext at: priority<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Install a process at level &lt;priority&gt; which is initialized from &lt;newContext&gt; (a remote Context). If there is already a process at that priority, tell the user and return false"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> newContext sender &larr; nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> (usedPriorities land: biton◦priority) = 0⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">INSTALL⦂ [while⦂ true do⦂ [newContext cleancopy eval]]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">AT: priority]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> user show:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;PriorityScheduler unable to install at level &rsquo;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">+priority asString<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">+&rsquo;. false returned&rsquo;. ⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">run: newContext<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 10pt serif"> at: priority<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"replace the process at &lt;priority&gt; with &lt;newContext&gt;. If that is the currently running priority, abandon what is running and start from &lt;newContext&gt;"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> priority = currentPriority⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[sourceIndirect run: newContext]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> suspendedContexts◦priority &larr; newContext]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">swap: newContext<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 10pt serif"> at: priority<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 10pt serif"> with: fieldReference<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"replace the process at &lt;priority&gt; with &lt;newContext&gt; and place the old contents in the field referred to by &lt;fieldReference&gt;"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> priority = currentPriority⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[sourceIndirect<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">swap: newContext<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">with: fieldReference]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> fieldReference value&larr; suspendedContexts◦priority.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> suspendedContexts◦priority &larr; newContext]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">terminate: priority<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Remove a process from the scheduler, allowing that level to be reused"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> enabledPriorities &larr; enabledPriorities land: bitoff◦priority.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> [suspendedContexts◦priority≠nil⇒[(suspendedContexts◦priority) releaseFully]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> [initialContexts◦priority≠nil⇒[(initialContexts◦priority) releaseFully]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> suspendedContexts◦priority &larr; initialContexts◦priority &larr; nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> awakePriorities &larr; awakePriorities land: bitoff◦priority.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> interruptedPriorities &larr; interruptedPriorities land: bitoff◦priority.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> usedPriorities &larr; usedPriorities land: bitoff◦priority.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self reselect]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Enable and Disable</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">disable: priority<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Prevent the process at &lt;priority&gt; from being activated by a wakeup. Turn off the corresponding bit in enabledPriorities and check if that changes who should run"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> enabledPriorities &larr; enabledPriorities land: bitoff◦priority.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self reselect]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">enable: priority<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Allow the process at &lt;priority&gt; to be activated by a wakeup. Turn on the corresponding bit in enabledPriorities and check if that changes who should run"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> enabledPriorities &larr; enabledPriorities lor: biton◦priority.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self reselect]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Wakeup and Sleep</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">deepsleep: priority<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Request the process at &lt;priority&gt; to cease running and ignore any new wakeups. Turn off the corresponding bit in awakePriorities and interruptedPriorities and check if that changes who should run"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> awakePriorities &larr; awakePriorities land: bitoff◦priority.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> interruptedPriorities &larr; interruptedPriorities land: bitoff◦priority.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self reselect]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">errorReset<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"There has been an error. Initialize the state of the process that was running.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">  If it was not the user process (priority 1), request it to cease running and<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">  prevent its further running (i.e. disable it)"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> currentPriority=1⇒[self init: currentPriority]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> awakePriorities &larr; awakePriorities land: bitoff◦currentPriority.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> enabledPriorities &larr; enabledPriorities land: bitoff◦currentPriority.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self init: currentPriority]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">reselect<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 10pt serif"> </span><span style="font: 10pt serif">| newPriority oldPriority newContext tempenabled tempinterrupts<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Switch to the highest priority enabled process"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> tempenabled &larr; self disable.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> tempinterrupts &larr; interruptedPriorities land: awakePriorities.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> awakePriorities &larr; interruptedPriorities lor: awakePriorities.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> interruptedPriorities &larr; tempinterrupts.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> newPriority &larr; (awakePriorities land: tempenabled) hibit.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> newPriority = 0⇒[enabledPriorities &larr; tempenabled. ⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> newPriority = currentPriority⇒[enabledPriorities &larr; tempenabled]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> newContext &larr; suspendedContexts◦newPriority.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> suspendedContexts◦newPriority &larr; nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> oldPriority &larr; currentPriority.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> currentPriority &larr; newPriority.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> enabledPriorities &larr; tempenabled.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> sourceIndirect<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">swap: newContext<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">with: (suspendedContexts ref: oldPriority)]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">primitive: 65</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">reset: priority<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Initialize the state of the process at &lt;priority&gt; and request it to cease running"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> awakePriorities &larr; awakePriorities land: bitoff◦priority.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self init: priority]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">resetCurrent<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Initialize the state of the process that is running. If it is not the<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">  user process (priority 1), request it to cease running"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> currentPriority=1⇒[self init: currentPriority]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> awakePriorities &larr; awakePriorities land: bitoff◦currentPriority.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self init: currentPriority]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">restart: priority<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Initialize the state of a suspended process and request it to run"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> interruptedPriorities &larr; interruptedPriorities lor: biton◦priority.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self init: priority]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sleep: priority<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Request the process at &lt;priority&gt; to cease running, if a new wakeup has arrived the process will be reawakened. Turn off the corresponding bit in awakePriorities and check if that changes who should run"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> awakePriorities &larr; awakePriorities land: bitoff◦priority.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self reselect]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">wakeup: priority<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Request the process at &lt;priority&gt; to run. Turn on the corresponding bit in interruptedPriorities and check if that changes who should run"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> interruptedPriorities &larr; interruptedPriorities lor: biton◦priority.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self reselect]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Top level</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init1<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[UserInt &larr; Top<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">install⦂ [user restart]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">at: 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> UserInt enable wakeup]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init11</span><span class="tab" val="79"></span><span style="font: 10pt serif">" Top terminate: 11; init11. "</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[GRODSK &larr; Top<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">install⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user displayoffwhile⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user show: &rsquo;<br>Smalltalk needs more space.<br>Just a moment...&rsquo;.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">dp0 growSmalltalkBy: 100.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user show: &rsquo;  Done.&rsquo;; cr].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">GRODSK deepsleep]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">at: 11.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">GRODSK enable]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init8 </span><span style="font: 10pt serif">| nw<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[CtlCInt &larr; Top<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">install⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[nw &larr; user notifier: &rsquo;Control c Interrupt&rsquo; level: 1 interrupt: true.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[nw⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user schedule: nw.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> </span><span class="tab" val="79"></span><span style="font: 10pt serif">nw takeCursor.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nw &larr; nil.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> </span><span class="tab" val="79"></span><span style="font: 10pt serif">UserInt restart]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">CtlCInt sleep]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">at: 8.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> CtlCInt enable]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init9  </span><span style="font: 10pt serif">"Top terminate: 9; init9."</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[CtlShftEscInt &larr; Top<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">install⦂ [spy abort. user restoredisplay. <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user buttons=7⇒["dont release possible garbage"] (Top◦1) releaseFully].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">UserInt restart. CtlShftEscInt sleep]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">at: 9.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> CtlShftEscInt enable]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">initsched<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[Top &larr; self fromSource: (PriorityInterrupt new).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self init1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self init11.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self init8.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self init9.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> Top top]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">top<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Make this scheduler the top level one. It will receive all physical (non-Smalltalk) interrupts"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> enabledPriorities &larr; enabledPriorities lor: biton◦1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> awakePriorities &larr; awakePriorities lor: biton◦1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> currentPriority &larr; 1] primitive: 61</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Critical sections</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">critical⦂ expr</span><span style="font: 10pt serif">| t v<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Execute &lt;expr&gt; without allowing it to be interrupted"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> t &larr; self disable.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> v &larr; expr eval.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> enabledPriorities &larr; t.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self reselect. ⇑v]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Private</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">disable </span><span style="font: 10pt serif">| t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"This message should deffinitely be protected. Zero all the enabled flags and return the previous value of them"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> t &larr; enabledPriorities. enabledPriorities &larr; 0. ⇑t] primitive: 66</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init: priority<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 10pt serif"> </span><span style="font: 10pt serif">| newPriority oldPriority newContext tempenabled tempinterrupts<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"This message should be protected. It is used by reset: and restart: to actually switch suspended processes"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> tempenabled &larr; self disable.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> tempinterrupts &larr; interruptedPriorities land: awakePriorities.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> awakePriorities &larr; interruptedPriorities lor: awakePriorities.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> interruptedPriorities &larr; tempinterrupts.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> newPriority &larr; (awakePriorities land: tempenabled) hibit max: 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> (newPriority = currentPriority)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">and: (currentPriority = priority)⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[enabledPriorities &larr; tempenabled.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> sourceIndirect run: (initialContexts◦priority) cleancopy]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> suspendedContexts◦priority &larr; (initialContexts◦priority) cleancopy.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> newPriority = currentPriority⇒[enabledPriorities &larr; tempenabled.]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> newContext &larr; suspendedContexts◦newPriority.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> suspendedContexts◦newPriority &larr; nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> oldPriority &larr; currentPriority.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> currentPriority &larr; newPriority.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> enabledPriorities &larr; tempenabled.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> oldPriority = priority⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[sourceIndirect run: newContext]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> sourceIndirect<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">swap: newContext<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">with: (suspendedContexts ref: oldPriority)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">INSTALL⦂ newContext AT: priority<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"This message should be protected, it is used by install:at: and install:above: to do the actual initialization of the process"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> newContext sender &larr; nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> usedPriorities &larr; usedPriorities lor: biton◦priority.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> initialContexts◦priority &larr; newContext.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> suspendedContexts◦priority &larr; newContext cleancopy.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ⇑PriorityInterrupt new from: self at: priority]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: s </span><span style="font: 10pt serif">| i b2 j<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[super printon: s.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: 5 do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s cr.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">b2&larr; (usedPriorities, enabledPriorities, awakePriorities,<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">interruptedPriorities, (1 lshift: currentPriority-1))◦i base: 2.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ j to: 16-b2 length do⦂ [s next&larr; &rsquo;0&rsquo;◦1].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s append: b2; space;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">append: ↪(&rsquo;used&rsquo; &rsquo;enabled&rsquo; &rsquo;awake&rsquo; &rsquo;interrupted&rsquo; &rsquo;current&rsquo;)◦i]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Reclamation</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪PriorityScheduler under: &rsquo;Events&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"Timer"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;Timer&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;</span><span class="tab" val="79"></span><span style="font: bold 12pt serif">activeTime</span><span class="tab" val="79"></span><span style="font: bold 12pt serif">"how long this Timer will be the active one"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">nextTimer</span><span class="tab" val="79"></span><span style="font: bold 12pt serif">"the Timer which will fire after this one"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">lastTimer</span><span class="tab" val="79"></span><span style="font: bold 12pt serif">"the Timer which will fire before this one"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">delay</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">"how long between setting and firing"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">action</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">"what happens when this timer fires"&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;currentTimer timerActions &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>A Timer is an object which causes an action after an interval of time. The time interval is measured in units of a sixtieth of a second from when the instance was initialized with the message &lt;for: {time interval} action⦂ [{code for action}]&gt;. When the interval is over the Timer fires by placing the action on a queue to be evaluated before processing at the user level continues. There is no need to mantain a name for a Timer while it is active, but a named timer may be disabled or reused. The Timers waiting to fire form a doubly linked list whose first link is referred to by the class variable currentTimer. Each Timer knows how long it should run after the preceding Timer has fired</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Initialize the processes used by the Timers"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[timerActions &larr; Queue new of: (Vector new: 4).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self init16.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self init12]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">for: delay action⦂ action<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Initialize a new Timer"</span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init12 </span><span style="font: 10pt serif">| nextAction</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Initialize the process which evals Timer actions"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[Top install⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[while⦂ true do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[while⦂ (nextAction &larr; timerActions next) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[nextAction eval].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> Top sleep: 12]] at: 12.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> Top enable: 12]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init16</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Initialize the process wakened by a Timer timing out"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[Top install⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[while⦂ true do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[currentTimer fire.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> Top sleep: 16]] at: 16.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> Top enable: 16]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">reset </span><span style="font: 10pt serif">| nextTimeout foundit<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Set up this Timer to add &lt;action&gt; to the Queue of remote Contexts to be evaled after an interval of &lt;delay&gt; sixtieths of a second. Find the proper place in the doubly linked list and calculate the amount of time to run after the preceeding timer fires"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> Top critical⦂ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[activeTime≡nil⇒[]self disable].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> activeTime &larr; delay. nextTimer &larr; currentTimer. lastTimer &larr; nil.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> foundit &larr; false.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> until⦂ foundit do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[nextTimer≡nil⇒[foundit &larr; true].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> (nextTimeout &larr; nextTimer activetime) &gt; activeTime⇒[foundit &larr; true].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> activeTime &larr; activeTime - nextTimeout.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> lastTimer &larr; nextTimer.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> nextTimer &larr; lastTimer nexttimer].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> [nextTimer≡nil⇒[] nextTimer insertlast: self].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> lastTimer≡nil⇒[self startup] lastTimer insertnext: self]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>List Behavior</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">deletelast<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Delete the Timer before this one. When deleting a Timer, the activeTime of the Timer after it must be increased by its activeTime"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> activeTime &larr; activeTime + lastTimer activetime.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> (lastTimer &larr; lastTimer lasttimer)≡nil⇒[self startup]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">deletenext<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Delete the Timer after this one"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> nextTimer &larr; nextTimer nexttimer]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">insertlast: lastTimer<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Insert a new Timer before this one. When inserting a Timer in front of another, the activeTime of the later one must be reduced so it is the amount of time after the new Timers firing"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> activeTime &larr; self activetime - lastTimer activetime]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">insertnext: nextTimer</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">lasttimer<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑lastTimer]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">nexttimer<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑nextTimer]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">release </span><span style="font: 10pt serif">[lastTimer &larr; nil. nextTimer &larr; nil. action &larr; nil]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Timing Behavior</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">activetime<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"If this is the current Timer return the time until it fires, otherwise return activeTime"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ⇑activeTime] primitive: 96</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">disable</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Remove this timer from the list"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[Top critical⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[self≡currentTimer and⦂ nextTimer≡nil⇒[self shutoff. Top deepsleep: 16]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> [lastTimer≡nil⇒[] lastTimer deletenext].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> [nextTimer≡nil⇒[] nextTimer deletelast].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> activeTime &larr; nil. lastTimer &larr; nil. nextTimer &larr; nil]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fire</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Time is up, add the action to the Queue to be evaled"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[timerActions next&larr; action.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> Top wakeup: 12.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> activeTime &larr; nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> lastTimer &larr; nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> nextTimer≡nil⇒[self shutoff]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> nextTimer startup.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> nextTimer &larr; nil]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">primstartup<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"this message informs the virtual machine that this is the next Timer to fire"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[] primitive: 95</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">shutoff<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"this message informs the virtual machine and class Timer that there are no more Timers to fire"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> currentTimer &larr; nil] primitive: 97</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">startup<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"make this the next Timer to fire"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> lastTimer &larr; nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> currentTimer &larr; self.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self primstartup]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪Timer under: &rsquo;Events&rsquo;.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">Timer classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"UserEvent"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;UserEvent&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Point<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;type stroke elapsed time&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>This class is used by the Events queue (updated in the 60HZ interrupt routine) to package up and return an event every time the queue is popped.  The class provides easy access to various parts of the event.  Users may create their own events by pushing onto the Events queue, which is why the Initialization here is classified as private.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">x: x y: y type: type stroke: stroke elapsed: elapsed time: time <br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"make an event, usually called from EventQueue"</span><span style="font: 10pt serif"><br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Public Access</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">elapsed </span><span style="font: italic 10pt serif">"return an event stroke"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"1 - 32767 sixtieths of second since previous non-time-elapsed event recorded"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑elapsed]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">isKbdDown<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["if stroke a down stroke and not keyset or mouse button, return it,<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">otherwise return false"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">type ≠ 1 ⇒ [⇑false] ⇑stroke &gt; 16]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">stroke </span><span style="font: italic 10pt serif">"return an event stroke"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"0-2 = top,middle,bottom mouse buttons, 3-7 = keyset left to right, 8-255 = keyboard"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑stroke]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">time </span><span style="font: italic 10pt serif">"return an event stroke"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"1 - 32767 sixtieths of second since Events time reset"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑time]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">type </span><span style="font: italic 10pt serif">"return event type"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"2 = upstroke event, 1 = downstroke event, 0 = time-elapsed event"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑type]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪UserEvent under: &rsquo;Events&rsquo;.</span></div>
    <div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">&rsquo;From Smalltalk 5.5k XM November 24 on 22 November 1980 at 2:57:08 am.&rsquo;<br></span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">"BitBlt"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;BitBlt&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;function color destbase destraster destx desty<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">width height sourcebase sourceraster sourcex sourcey<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sstrike dstrike &rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;pageOneCursor &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>BitBlt copies bits from one rectangle to another in core.  x, y, width and height are in bits, raster is in words, and base is a core address.  Mode is storing, oring, xoring or erasing.  If source or destination is a Smalltalk object, then you have to lock it, as in copyToString, below.  The primitive does no bounds checking, so watch out.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Access to Parts</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">color  </span><span style="font: 10pt serif">[⇑color]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">color &larr; color</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">destbase  </span><span style="font: 10pt serif">[⇑destbase]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">destbase &larr; destbase</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">destraster  </span><span style="font: 10pt serif">[⇑destraster]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">destraster &larr; destraster</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">destx  </span><span style="font: 10pt serif">[⇑destx]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">destx &larr; destx</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">desty  </span><span style="font: 10pt serif">[⇑desty]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">desty &larr; desty</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dest &larr; pt </span><span style="font: 10pt serif">[destx&larr; pt x.  desty &larr; pt y]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dstrike </span><span style="font: 10pt serif">[⇑dstrike]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dstrike &larr; dstrike<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">extent &larr; pt </span><span style="font: 10pt serif">[width &larr; pt x.  height &larr; pt y]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">function  </span><span style="font: 10pt serif">[⇑function]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">function &larr; function</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">height  </span><span style="font: 10pt serif">[⇑height]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">height &larr; height</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sourcebase  </span><span style="font: 10pt serif">[⇑sourcebase]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sourcebase &larr; sourcebase</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sourceraster  </span><span style="font: 10pt serif">[⇑sourceraster]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sourceraster &larr; sourceraster</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sourcex  </span><span style="font: 10pt serif">[⇑sourcex]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sourcex &larr; sourcex</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sourcey  </span><span style="font: 10pt serif">[⇑sourcey]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sourcey &larr; sourcey</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">source &larr; pt </span><span style="font: 10pt serif">[sourcex&larr; pt x.  sourcey &larr; pt y]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sstrike </span><span style="font: 10pt serif">[⇑sstrike]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sstrike &larr; sstrike<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">width  </span><span style="font: 10pt serif">[⇑width]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">width &larr; width</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Setup</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pageOneCursor &larr; 0431. "location of hardware cursor"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">forCursor<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[function&larr; color&larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">destbase&larr; sourcebase&larr; 0431.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">width&larr; height&larr; 16. destraster&larr; sourceraster&larr; 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">destx&larr; desty&larr; sourcex&larr; sourcey&larr; 0. sstrike &larr; dstrike &larr; false<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[function &larr; color &larr; destbase &larr; destraster &larr; destx &larr; desty &larr; width &larr;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">height &larr; sourcebase &larr; sourceraster &larr; sourcex &larr; sourcey &larr; 0. sstrike &larr; dstrike &larr; false<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Operations</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">callBLT<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user croak]  primitive: 33</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">checksandcall </span><span style="font: 10pt serif">| destlocked sourcelocked</span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"checks if either base a string and/or strike and locks accordingly"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">function &larr; function land: 017.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"set up function to add XM stuff"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[destbase class ≡ String ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[destbase◦1 &larr; destbase◦1.  "set the dirty bit"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">destlocked &larr; destbase.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">destbase &larr; ([dstrike ⇒ [((destlocked lock) + 9)]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">destlocked lock</span><span class="tab" val="79"></span><span style="font: 10pt serif"> </span><span style="font: italic 10pt serif">"strike header"</span><span style="font: 10pt serif">])<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[destbase ≠ pageOneCursor ⇒<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[function &larr; function + 020. </span><span style="font: italic 10pt serif">"dest not string, then must be in display"</span><span style="font: 10pt serif">]</span><span style="font: italic 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"unless doing cursor work in page one location"</span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[sourcebase class ≡ String ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[sourcelocked &larr; sourcebase.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">sourcebase &larr; ([sstrike ⇒ [((sourcelocked lock) + 9)]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">sourcelocked lock</span><span class="tab" val="79"></span><span style="font: 10pt serif"> </span><span style="font: italic 10pt serif">"strike header"</span><span style="font: 10pt serif">])<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[sourcebase ≠ pageOneCursor ⇒<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[function &larr; function + 040. </span><span style="font: italic 10pt serif">"source not string, then must be in display"</span><span style="font: 10pt serif">]</span><span style="font: italic 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"unless doing cursor work in page one location"</span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self callBLT.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[destlocked ≡ nil ⇒ [] destbase &larr; destlocked unlock].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[sourcelocked ≡ nil ⇒ [] sourcebase &larr; sourcelocked unlock].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">copy: mode <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[function &larr; mode land: 3. self checksandcall]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">copycomp: mode <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[function &larr; 4 + (mode land: 3). self checksandcall]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fill: mode color: color <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[function &larr; 12 + (mode land: 3). self checksandcall]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">paint: mode <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[function &larr; 8 + (mode land: 3). self checksandcall]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">stringCopy: deststring from: start to: stop with: replacement from: rstart to: rstop<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["copies equal subranges from one string to another.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">works for BitBlt parameters up to 4096. maybe too much set up for short strings.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">currently, called by </span><span style="font: bold 10pt serif">String copy:to:with:from:to:</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">width &larr; 1+stop-start.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">width = 0⇒ [⇑deststring]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(start &gt; 4096 or⦂ rstart &gt; 4096) or⦂ width ≥ 4096⇒ [⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(width &lt; 0 or⦂ width ≠ (1+rstop-rstart)) or⦂ (<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(start &lt; 1 or⦂ stop &gt; deststring length) or⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(rstart &lt; 1 or⦂ rstop &gt; replacement length))⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: &rsquo;illegal range or subscript&rsquo;]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"self init."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">function &larr; color &larr; destraster &larr; desty &larr; sourceraster &larr; sourcey &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sstrike &larr; dstrike &larr; false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">height &larr; 1.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">width &larr; width*8.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">destbase &larr; deststring lock. <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">destx &larr; (start - 1) * 8.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sourcebase &larr; replacement lock.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sourcex &larr; (rstart - 1) * 8.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self callBLT.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">replacement unlock.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"mark dirty"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">deststring◦1 &larr; deststring◦1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">deststring unlock.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑deststring<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">stringReplace: deststring with: sourcestring from: start to: stop and: replacement from: rstart to: rstop </span><span style="font: 10pt serif">| slock [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"works for BitBlt parameters less than 4096. replaces a subrange of a string.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">called only by </span><span style="font: bold 10pt serif">String replace:to:by:from:to:</span><span style="font: 10pt serif">.  concatenates into deststring:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">sourcestring◦(1 to: start-1)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">replacement◦(rstart to: rstop)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">sourcestring◦(stop+1 to: sourcestring length).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">assumes String arguments"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">deststring length = 0⇒ [⇑deststring]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(replacement is: String)≡false⇒[⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(stop ≥ 4096 or⦂ sourcestring length - stop ≥ 4096) or⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(start+rstop-rstart ≥ 4096 or⦂ rstart &gt; 4096)⇒ [⇑false]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(start &lt; 1 or⦂ stop &gt; sourcestring length) or⦂<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(rstart &lt; 1 or⦂ rstop &gt; replacement length)⇒ [user notify: &rsquo;illegal subscript&rsquo;]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"self init."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">function &larr; color &larr; destraster &larr; desty &larr; sourceraster &larr; sourcey &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sstrike &larr; dstrike &larr; false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">height &larr; 1.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">destbase &larr; deststring lock. <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sourcebase &larr; slock &larr; sourcestring lock.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">width &larr; (start - 1) * 8.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[width = 0⇒ []<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sourcex &larr; destx &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self callBLT].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">destx &larr; width.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">width &larr; (1+rstop-rstart)*8.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[width = 0⇒ []<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sourcex &larr; (rstart - 1) * 8.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sourcebase &larr; replacement lock.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self callBLT.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">replacement unlock].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">destx &larr; destx+ width.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">width &larr; (sourcestring length - stop) * 8.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[width = 0⇒ []<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sourcebase &larr; slock.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sourcex &larr; stop * 8.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self callBLT].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">deststring◦1 &larr; deststring◦1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sourcestring unlock. deststring unlock.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑deststring<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪BitBlt under: &rsquo;Primitive Access&rsquo;.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">BitBlt classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"CoreLocs"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;CoreLocs&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Array<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;base length&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I am an array mapping a section of Alto memory</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">base: base length: length</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Reading and Writing</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">◦ x </span><span style="font: 10pt serif">[x isLarge⇒[⇑self◦(x asSmall)] user croak] primitive: 42</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">◦ x &larr; val </span><span style="font: 10pt serif">[x isLarge⇒[⇑self◦(x asSmall) &larr; val] user croak] primitive: 43</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">base </span><span style="font: 10pt serif">[⇑base]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">length </span><span style="font: 10pt serif">[⇑length]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪CoreLocs under: &rsquo;Primitive Access&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"VirtualMemory"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;VirtualMemory&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;map "Pclass Map"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">premap "block before map"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">FirstContextOop "oop of FirstContext"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">SpecialOopsOop "oop of SpecialOops"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">zip  "Zone Index of Pages"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">prezip  "block before zip"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">zadd   "file info"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">vmemfile "file for vmem" &rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;ZHB RCI PIN zfused zfree zjmpt pmint num00 pmend ZN zflen pmatm zlong PCL ZVPN CPT BSC ISC ZJMP zend &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>A model of the OOZE virtual memory</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Pclass Map</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">CPT: oop </span><span style="font: 10pt serif">| poma<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[poma &larr; 2*(oop field: PCL) +1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑map◦poma field: CPT]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">freelist: object  </span><span style="font: 10pt serif">| a<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"one-order index into freelists."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">object class is: Class ⇒[⇑1]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">a &larr; self ISC: object asOop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">a &lt; 024 ⇒[⇑1+a] ⇑1+ a-013]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">freelistOffset: len </span><span style="font: italic 10pt serif">"offset of freelist for this length in a variable length class"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑Class instsize + [len &lt; 9 ⇒[len] (len-1) log2 + 6]]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">highpm0: oop gets: val </span><span style="font: 10pt serif">| poma<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[premap◦pmatm &larr; premap◦pmatm min: (oop field: PIN &larr; 0).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">poma &larr; 2*(oop field: PCL) +1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">map◦poma &larr; val]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">highPM: oop </span><span style="font: 10pt serif">| pcl a<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pcl &larr; oop field: PCL.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">a &larr; premap◦pmatm field: PCL.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pcl &lt; a ⇒[⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑map◦(2*pcl +1)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">ISC: oop </span><span style="font: 10pt serif">| poma<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[poma &larr; 2*(oop field: PCL) +1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑map◦poma field: ISC]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">lowPM: oop </span><span style="font: 10pt serif">| pcl a<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pcl &larr; oop field: PCL.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">a &larr; premap◦pmend field: PCL.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pcl ≥ a ⇒[⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑map◦(2*pcl +1)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">newHighPM&larr; pm0 </span><span style="font: 10pt serif">| pcl a<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[a &larr; premap◦pmatm.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">premap◦pmatm &larr; (a &larr; a-0200).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pcl &larr; a field: PCL.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">map◦(2*pcl +1) &larr; pm0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑a]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">newLowPM&larr; pm0 </span><span style="font: 10pt serif">| poma a<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[map◦1 = pm0 ⇒[</span><span style="font: italic 10pt serif">"reserved pclasses for Class"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">map◦3 = 0 ⇒[map◦3 &larr; pm0. ⇑0200]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">map◦5 = 0 ⇒[map◦5 &larr; pm0. ⇑0400] ]<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"normal case"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">a &larr; premap◦pmend.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">premap◦pmend &larr; a+0200.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">poma &larr; (a field: PCL) *2 +1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">map◦poma ≠ 0 ⇒[</span><span style="font: italic 10pt serif">"skip over already filled"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self newLowPM&larr; pm0]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">map◦poma &larr; pm0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑a]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">newZN: oop <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self ZN: oop gets: self newZone]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pclassesOf: cls </span><span style="font: 10pt serif">| i clsoop n z p </span><span style="font: italic 10pt serif">"find pclasses of this class (in order of ZHB)"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"ignore small integers and nil"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">p &larr; (Vector new: 1) asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">z &larr; (Vector new: 1) asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">clsoop &larr; cls asOop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: (1 to: 2*(0174000 field: PCL) by: 2) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[map◦i = 0 ⇒[]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(map◦i field: RCI) = clsoop ⇒[p next&larr; i/2. z next&larr; (map◦(i+1) field: ZHB)]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">p &larr; p contents. z &larr; z contents.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">n &larr; p copy.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: z length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[n◦(z◦i +1) &larr; p◦i].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑n]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pclassesOf: cls length: len </span><span style="font: 10pt serif">| i clsoop n z p isc pm0 </span><span style="font: italic 10pt serif">"find pclasses of this class and length (in order of ZHB)"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"ignore small integers and nil"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">p &larr; (Vector new: 1) asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">z &larr; (Vector new: 1) asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">isc &larr; [len &lt; 9 ⇒[len] (len-1) log2 + 17].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">clsoop &larr; cls asOop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: (1 to: 2*(0174000 field: PCL) by: 2) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(pm0 &larr; map◦i) = 0 ⇒[]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(pm0 field: RCI) ≠ clsoop ⇒[]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(pm0 field: ISC) = isc ⇒[p next&larr; i/2. z next&larr; (map◦(i+1) field: ZHB)]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">p &larr; p contents. z &larr; z contents.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">n &larr; p copy.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: z length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[n◦(z◦i +1) &larr; p◦i].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑n]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pmatm </span><span style="font: 10pt serif">[⇑premap◦pmatm]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">ZHB: oop </span><span style="font: 10pt serif">| poma<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[poma &larr; 2*(oop field: PCL) +1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑map◦(1+poma) field: ZHB]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">ZHB: oop gets: val </span><span style="font: 10pt serif">| poma i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[poma &larr; 2*(oop field: PCL) +1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; map◦(1+poma).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">map◦(1+poma) &larr; (i field: ZHB &larr; val)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">ZN: oop </span><span style="font: 10pt serif">| poma<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[poma &larr; 2*(oop field: PCL) +1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑map◦(1+poma) field: ZN]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">ZN: oop gets: val </span><span style="font: 10pt serif">| poma i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[poma &larr; 2*(oop field: PCL) +1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; map◦(1+poma).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">map◦(1+poma) &larr; (i field: ZN &larr; val)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Writing and Reading</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">obwiz: oop </span><span style="font: 10pt serif">| poma pm0 pm1 isc bsc i len zz pin zhb<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"find (zn, zp, zw, dlen)"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">zz &larr; Vector new: 4.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">poma &larr; (oop field: PCL)*2 +1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(pm0 &larr; map◦poma) = 0 ⇒ [user notify: &rsquo;bad oop&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pm1 &larr; map◦(1+poma).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">isc &larr; pm0 field: ISC.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bsc &larr; pm0 field: BSC.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">zhb &larr; pm1 field: ZHB.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[isc &lt; 024 ⇒[len &larr; ((isc max: 1)+ 1-bsc) / (2-bsc)]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">len &larr; 8. i &larr; isc+bsc.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ 024 = i do⦂ [i &larr; i-1. len &larr; len*2]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">len &larr; len+1 </span><span style="font: italic 10pt serif">"length word"</span><span style="font: 10pt serif"> ].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">zz◦4 &larr; len &larr; len+1. </span><span style="font: italic 10pt serif">"dlen with refct"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"w &larr; (dlen*128*zhb) +dlen*pin"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pin &larr; oop field: PIN.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">zz◦2 </span><span style="font: italic 10pt serif">"zp"</span><span style="font: 10pt serif"> &larr; (zhb/2 *len) +(len/256 *pin).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">zz◦3 </span><span style="font: italic 10pt serif">"zw"</span><span style="font: 10pt serif"> &larr; (zhb\2 *128 *len) +(len\256 *pin).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">zhb\2 * len ≥ 512 ⇒[user notify: &rsquo;address overflow&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">zz◦2 </span><span style="font: italic 10pt serif">"zp"</span><span style="font: 10pt serif"> &larr; zz◦2 + (zz◦3 field: 136 </span><span style="font: italic 10pt serif">"highbyte"</span><span style="font: 10pt serif">).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">zz◦3 </span><span style="font: italic 10pt serif">"zw"</span><span style="font: 10pt serif"> &larr; zz◦3 field: 128 </span><span style="font: italic 10pt serif">"lowbyte"</span><span style="font: 10pt serif">.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">zz◦1 &larr; pm1 field: ZN.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑zz]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">readin: oop </span><span style="font: 10pt serif">| zinfo<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[zinfo &larr; self obwiz: oop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self read: zinfo◦4 at: zinfo]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">systemNoHistory </span><span style="font: 10pt serif">[] primitive: 82</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">writeout: oop with: image </span><span style="font: 10pt serif">| zinfo<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[zinfo &larr; self obwiz: oop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[zinfo◦4 ≥ (image length /2) ⇒[]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: &rsquo;bad image length&rsquo;].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self write: image at: zinfo<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Init</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">AComment<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"VirtualMemory models the Pclass Map of Ooze.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Vmem is one with CoreLocs on real system.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">(VirtualMemory new) thisvmem.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Pmap is new one we are building.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">(VirtualMemory new) fakevmem.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">map is 1-order addressing.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">In init, set pmatm by searching PM for<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">highest 0. (No LMAT)<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">map RCI field is old class oop. only convert to <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">new with mapPM at end.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Atoms may not cover more than half of the<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">address space. (highpm0:gets:)<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">(VirtualMemory new) giveBirth.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Zone Index of Pages. works for both vector zip<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">and corelocs of real zip.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">zip, zadd are one-order.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">zfree is 1-order in fake, core addr in this.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">zlong = 512.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">zend is not used (0 fake, core addr in this) <br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"</span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fakevmem: vmemfile<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"this instance is a model of a new vmem, which is built on another file"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self init.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">map &larr; Vector new: 1024.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">map all &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">premap &larr; (0176000, 0174000, 0, 0).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"num00, pmint, pmatm, pmend"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">prezip &larr; (3, 01244, 0). </span><span style="font: italic 10pt serif">"zfree, zlong, zend"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">zip &larr; Vector new: prezip◦zlong.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">zip all &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">zadd &larr; (1, 1).  </span><span style="font: italic 10pt serif">"zfused, zflen"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">vmemfile readwrite.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Smalltalk define: ↪Pmap as: self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init  </span><span style="font: italic 10pt serif">"common to both real and fake vmem"</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"field descriptors and indicies in tables"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">num00 &larr; 1. pmint &larr; 2. pmatm &larr; 3. pmend &larr; 4.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">RCI &larr; 151. CPT &larr; 22. BSC &larr; 21. ISC &larr; 80.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ZHB &larr; 136. ZN &larr; 128. <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">PCL &larr; 151. PIN &larr; 112.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ZJMP &larr; 76. ZVPN &larr; 16*12.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">zfree &larr; 1. zlong &larr; 2. zend &larr; 3.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">zfused &larr; 1. zflen &larr; 2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">zjmpt &larr; (603, 570, 471, 410, 353, 300, 253, <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">210, 169, 132, 101, 72, 49, 30, 13)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">premap </span><span style="font: 10pt serif">[⇑premap] </span><span style="font: italic 10pt serif">"array of limits in Pclass Map"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">thisvmem </span><span style="font: 10pt serif">| c m "create Vmem, a VirtualMemory viewing this very system"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[c &larr; self specialLocs.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">map &larr; CoreLocs new base: c◦2 -1 length: 1025.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">premap &larr; CoreLocs new base: c◦2 -5 length: 5.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Smalltalk define: ↪Vmem  as: self.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self init.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">m &larr; 1023.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ (map◦m = 0) do⦂ [m &larr; m-2].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">premap◦pmatm &larr; (0 field: PCL &larr; m/2 +1).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">prezip &larr; CoreLocs new base: c◦3 -4 length: 4.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">zip &larr; CoreLocs new base: c◦3 -1 length: prezip◦zlong+1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">zadd &larr; CoreLocs new base: c◦12 -3 length: 3.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(vmemfile &larr; dp0 oldFile: &rsquo;small.boot&rsquo;) readonly.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">FirstContext &larr; Context new sender: nil <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">receiver: user<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">method: (m &larr; UserView md method: ↪restart) <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">tempframe: (Vector new: (m◦3 max: m◦4)) pc: m◦6<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">stackptr: m◦5 -1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">SpecialOops◦1 &larr; Object md method: ↪error.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">FirstContextOop &larr; FirstContext asOop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">SpecialOopsOop &larr; SpecialOops asOop]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Vmem Writing</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">afterBirth </span><span style="font: 10pt serif">[MethodKeeperKeeper &larr; nil]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">giveBirth </span><span style="font: 10pt serif">| pm0 vm </span><span style="font: italic 10pt serif">"initialize map for early pclasses"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self preBirth.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"small Integer, 16 pclasses, oops 0174000-0177777"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pm0 &larr; Vmem highPM: 0176000. </span><span style="font: italic 10pt serif">"size, class info for Integer"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ (Pmap newHighPM&larr; pm0) = 0174000 do⦂ []. <br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"first UniqueString"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(vm &larr; Vmapper new) object: (0173600 asObject); touchoop.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Class oops 0-0177"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">vm object: Class; touchoop.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"more Class oops 0200-0577"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">Pmap newLowPM&larr; 0; newLowPM&larr; 0.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"VariableLengthClass oops 0600-0777"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">vm object: Vector; touchoop.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"skip over some oops"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ (Pmap newLowPM&larr; 0) = 01600 do⦂ [].<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Object oops 02000-02177, false=02000"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(vm object: false) map ≠ 02000 ⇒[user notify: &rsquo;bad false oop&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"set pointer back to oops skipped over"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">Pmap premap ◦ pmend &larr; 01000<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">giveBirth2 </span><span style="font: 10pt serif">| vm<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[vm &larr; Vmapper new.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">vm object: (Smalltalk ref: ↪FirstContext).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">FirstContextOop &larr; (vm readin word: 2). </span><span style="font: italic 10pt serif">"new oop of FirstContext"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">vm reset; object: (Smalltalk ref: ↪SpecialOops).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">SpecialOopsOop &larr; (vm readin word: 2). </span><span style="font: italic 10pt serif">"new oop of SpecialOops"</span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">giveBirth3 </span><span style="font: 10pt serif">| vm p [</span><span style="font: italic 10pt serif">"create a new Small.boot<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Write out all objects rooted at Smalltalk.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Do not write the stack (rooted in R76, the current context).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">Pmap file close. Pmap &larr; nil.<br><br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">*** Below is the commmand to start a Vmem write on a Dorado<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">(or Alto -- double disk O.S.).  edit and recompile the method if you don&rsquo;t<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">want to use old UniqueStrings, or if newsmall.boot, smalltalk.run,<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">smalltalk.syms, byterp.mb are not located on dp0i,<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">i.e. dp1 oldFile: &rsquo;small.boot&rsquo; instead of dp0 oldFile: &rsquo;newsmall.boot&rsquo;.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">also delete rename: commands at the end.<br></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user displayoffwhile⦂ [(VirtualMemory new) giveBirth3]. user quit.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">***"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user releaseExternalViews.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[E≡nil⇒ [] E kill].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Flushed&larr; false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(Vmapper new) init; UseOldUniqueStrings: true.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user show: &rsquo;init &rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(VirtualMemory new) thisvmem.  </span><span style="font: italic 10pt serif">"define Vmem, Pmap"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(VirtualMemory new) fakevmem: (dp0 oldFile: &rsquo;newsmall.boot&rsquo;).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self giveBirth.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">vm &larr; Vmapper new.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user show: &rsquo;run &rsquo;. vm object: Smalltalk; map.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user show: &rsquo;USTable &rsquo;. vm arefsRectify.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user show: &rsquo;freelist &rsquo;. vm writefreelists.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user show: &rsquo;mrefs &rsquo;. vm mrefsRectify.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user show: &rsquo;PM &rsquo;. Pmap mapPM; giveBirth2.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">These work as many times as needed on dp0 or dp1</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user show: &rsquo;surgery &rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Pmap surgery: (dp0 oldFile: &rsquo;Smalltalk.Run&rsquo;).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user show: &rsquo;ram &rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Pmap ramwrite: (dp0 oldFile: &rsquo;Byterp.Mb&rsquo;).<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">adjust size of new file</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">p &larr; Pmap pagesUsed + 264 "</span><span style="font: italic 10pt serif">boot & ram</span><span style="font: 10pt serif">" + 250 "</span><span style="font: italic 10pt serif">extra</span><span style="font: 10pt serif">".<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user show: &rsquo;pages reclaimed &rsquo;; print: (Pmap file) file lastPage - p.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(Pmap file) readwriteshorten; settopage: p char: 0; close; readwrite.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"rename files so that new file is small.boot"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(Vmem file) file rename: &rsquo;oldsmall.boot&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(Pmap file) file rename: &rsquo;small.boot&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">mapPM </span><span style="font: 10pt serif">| c i v rci ctrans  </span><span style="font: italic 10pt serif">"convert to new RCI"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ctrans &larr; (Vmapper new) classtrans.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ c from: (1 to: 1023 by: 2) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(i &larr; map◦c) = 0 ⇒[]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">rci &larr; i field: RCI.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(v &larr; ctrans lookup: rci) ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[map◦c &larr; (i field: RCI &larr; v◦1)]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: &rsquo;class not mapped&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">preBirth </span><span style="font: 10pt serif">| v<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[MethodKeeperKeeper &larr; MessageDict new.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">MethodKeeperKeeper init: (v &larr; MethodKeeper contents) length *2; holdMethods: v]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">ramwrite: source </span><span style="font: 10pt serif">| s </span><span style="font: italic 10pt serif">"write 8 pages of ram image into small.boot</span><span style="font: 10pt serif">" [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s &larr; source name.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">source readonly.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[source directory ≡ dp0 ⇒[]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(dp0 file: s) append: source; close "</span><span style="font: italic 10pt serif">copy onto dp0</span><span style="font: 10pt serif">"].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">source close.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">cleanup vmem file before quit</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">vmemfile close.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">go out to OS, packram, and come back</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s &larr; s◦(1 to: s length-4) concat: &rsquo;.br.&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user quitThen: [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(Stream default) append: &rsquo;Packmu &rsquo;;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">append: source name; space; append: s;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">append: &rsquo;; Resume &rsquo;; append: Vmem file name;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">contents].  <br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">skip .br stuff and constants</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(s &larr; dp0 oldFile: s) readonly; skipwords: 0421.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">now write in ram image (8 pages of 512)</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">vmemfile settopage: 0400 char: 0; readwrite; next: 4096 from: s.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s close.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self ≡ Vmem ⇒[vmemfile readonly "</span><span style="font: italic 10pt serif">does flush</span><span style="font: 10pt serif">"]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">vmemfile flush]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Surgery</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dynaLocs: guide </span><span style="font: 10pt serif">| l locs keys v i "Surgery - add core location and value pairs to guide dictionary to test after flush"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[l &larr; self specialLocs.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">locs &larr; (premap base +pmend, (l◦11 -1), (l◦12 -2), (l◦4 +1)).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">keys &larr; (↪premaptest, ↪purgetest, ↪zaddtest, ↪loxtest).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: 1 to: keys length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[v &larr; locs◦i, (mem◦(locs◦i)).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">guide insert: keys◦i with: v].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(guide lookup: ↪loxtest)◦2 &larr; ¬1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">runLocs: f </span><span style="font: 10pt serif">| guide i v locs keys offsets "Surgery - create dictionary of locations of key system tables in Smalltalk.run"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[i &larr; f name.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(v &larr; f directory oldFile: (i◦(1 to: i length-5) concat: &rsquo;.syms.&rsquo;)) readonly.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">locs &larr; self symsFind: (&rsquo;PMBASE&rsquo;, &rsquo;ZIP&rsquo;, &rsquo;ZADD&rsquo;, &rsquo;INITIALIZE&rsquo;, &rsquo;OOZIN&rsquo;, &rsquo;SAFID&rsquo;) on: v.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">v close.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">keys &larr; ↪(maprun ziprun zaddrun initrun zfps safid).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">offsets &larr; ↪(¬1 ¬1 ¬3 ¬3 ¬2 ¬1). "words offset"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">guide &larr; Dictionary new init: 16.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: 1 to: locs length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[v &larr; (locs◦i lshift: ¬8), ((locs◦i land: 0377) -19 *2). "page, byte"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"magic fudge factor of 19 words for .run file"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">v◦2 &larr; v◦2 +(offsets◦i *2). "bytes offset"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">guide insert: keys◦i with: v].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">v &larr; (guide lookup: ↪maprun) copy.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">v◦2 &larr; v◦2 +(¬4 *2).  "offset ¬5 total"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">guide insert: ↪premaprun with: v.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">v &larr; (guide lookup: ↪ziprun) copy.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">v◦2 &larr; v◦2 +(¬3 *2).  "offset ¬4 total"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">guide insert: ↪preziprun with: v.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑guide]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">specialLocs </span><span style="font: 10pt serif">[] primitive: 84<br>"returns a vector containing the core addresses of:<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">1 ROTBASE (the Resident Object Table)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">2 PMBASE (the Pclass Map)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">3 ZIP (the Zone Index of Pages)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">4 LOX (the table of LOcked objeX)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">5 FULL (loc of lowest addr used for resident data)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">6 ULIM (loc of highest addr used for resident data)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">7 ZFPT (the zone file Page Table)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">8 OVTAB (the Table of OVerflow ref counts)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">9 PURGE (a code label)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">10 DISPGLBS (Table of Display Globals)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">11 BACPUR (a code label)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">12 ZADD (.-2 has #pages req&rsquo;d, .-1 has #pages in boot file; add 264 for real file length)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">13 SAFID (loc of file id (5-word block) for the .boot file)<br>"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">staticTest: guide on: f </span><span style="font: 10pt serif">| l locs offsets values names i v "Surgery - test known static constants in thisvmem and in smalltalk.run"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[offsets &larr; (pmint, 2, 0, 0).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">values &larr; (0174000, 01244, 96, 031415).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">names &larr; (↪premaprun, ↪preziprun, ↪zaddrun, ↪initrun).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: names length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[v &larr; guide lookup: names◦i.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">f settopage: v◦1 char: v◦2 +(offsets◦i *2).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">f nextword ≠ (values◦i)⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user notify: &rsquo;bad .run loc&rsquo;]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self ≡ Vmem ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[l &larr; self specialLocs.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">offsets◦4 &larr; 0.  values◦4 &larr; 014764.</span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">locs &larr; (premap base, prezip base, zadd base, (l◦11) "bacpur").<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: 1 to: locs length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[values◦i ≠ (mem◦(locs◦i +(offsets◦i)))⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user notify: &rsquo;bad system loc&rsquo;]]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">surgery: f </span><span style="font: 10pt serif">| guide Etemp i v keys [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">write virtual memory tables into Smalltalk.run using Smalltalk.syms.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user displayoffwhile⦂ [Vmem ramwrite: (dp0 oldFile: &rsquo;byterp.mb&rsquo;)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user displayoffwhile⦂ [Vmem surgery: (dp0 oldFile: &rsquo;Smalltalk.run&rsquo;)]. "<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">vmemfile close.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user releaseExternalViews.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[E ≡ nil ⇒[] E kill].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self ≡ Vmem ⇒[self thisvmem.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">Flushed &larr; true. Etemp &larr; Events]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f readwrite.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">guide &larr; self runLocs: f.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self staticTest: guide on: f.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self ≡ Vmem ⇒[user clearshow: &rsquo;Wait for the safe light to flash, then hit any key&rsquo;.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ user kbck do⦂ []. user kbd.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self dynaLocs: guide.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user clearshow: &rsquo;Dont forget user systemStartup. in the new system to enable interrupts and get the display set up. &rsquo;.<br>]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self tablewrt: guide on: f. "</span><span style="font: italic 10pt serif">write in Smalltalk.run</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f close.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self ≡ Vmem ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[keys &larr; (↪premaptest, ↪purgetest, ↪zaddtest, ↪loxtest).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: keys length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[v &larr; guide lookup: keys◦i.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">v◦2 ≠ (mem◦(v◦1))⇒[user notify: &rsquo;please surgery again&rsquo;]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">Events &larr; nil. self systemVmemOut.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">Events &larr; Etemp.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">vmemfile close.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user quit]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">symsFind: strs on: f1 </span><span style="font: 10pt serif">| f2 S N L offset val str j i "find initial values of SRELs in smalltalk.syms"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["S is start of string space (words)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">N is start of symbol table "<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(f2 &larr; f1 directory oldFile: f1 name) readonly.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f1 wordposition &larr; 2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">S &larr; f1 nextword.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">N &larr; f1 nextword.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f1 wordposition &larr; N.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">L &larr; f1 nextword.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: L do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[offset &larr; f1 nextword. "next offset"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">f1 skip: 4.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">val &larr; f1 nextword.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">f2 wordposition &larr; S+offset.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">str &larr; f2 next: f2 next.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ j to: strs length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(strs◦j) class ≡ String ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strs◦j = str ⇒[strs◦j &larr; val]]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f2 close.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ j to: strs length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(strs◦j) class ≡ String ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user notify: &rsquo;symbol not found&rsquo;]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑strs]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">systemVmemOut </span><span style="font: 10pt serif">[] primitive: 83</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">tablewrt: guide on: f </span><span style="font: 10pt serif">| i v vfile "copy tables from self to .run file"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[v &larr; guide lookup: ↪premaprun.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f settopage: v◦1 char: v◦2 +(2*pmatm).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f nextword&larr; premap◦pmatm.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f nextword&larr; premap◦pmend.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: 1024 do⦂ [f nextword&larr; map◦i].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">v &larr; guide lookup: ↪preziprun.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f settopage: v◦1 char: v◦2 +(2*1 "zfree").<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; [self ≡ Vmem ⇒ [¬1-zip base "relative indexing"]¬1 "</span><span style="font: italic 10pt serif">make 0-order"</span><span style="font: 10pt serif">] .</span><span style="font: italic 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f nextword&larr; prezip ◦1 +i. "zfree"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">v &larr; guide lookup: ↪zaddrun.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f settopage: v◦1 char: v◦2 +(2*1 "zfused").<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f nextword&larr; zadd ◦1. </span><span style="font: italic 10pt serif">" zfused "</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">v &larr; guide lookup: ↪ziprun.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f settopage: v◦1 char: v◦2 +(2*1).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: prezip◦zlong do⦂ [f nextword&larr; zip◦i]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">v &larr; guide lookup: ↪initrun.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f settopage: v◦1 char: v◦2 +(2*1 "SpecialOops").<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f nextword&larr; SpecialOopsOop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f nextword&larr; FirstContextOop.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"disk address of start of virtual memory"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">vfile &larr; vmemfile file.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">v &larr; guide lookup: ↪zfps.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f settopage: v◦1 char: v◦2 +(2*1).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f nextword&larr; (vfile read: 0410) address.<br></span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"swat file id of vmem file"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">v &larr; guide lookup: ↪safid.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f settopage: v◦1 char: v◦2 + (2*1).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f append: vfile serialNumber; skip: 4; nextword &larr; (vfile read: 1) address.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Zone Pages</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">cover: zz </span><span style="font: 10pt serif">| pp zrp lpir zjmp vpn olpir<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pp &larr; zz◦2 + 1. "zp 1-order"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">lpir &larr; 1. olpir &larr; 0. zrp &larr; zz◦1 *2 +1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ lpir ≥ pp do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">0 = (zjmp &larr; zip◦zrp field: ZJMP) ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self run: [lpir ≥ 32 ⇒[32] lpir +1] after: zrp.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self cover: zz]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">zrp &larr; (zjmpt◦zjmp + zrp -1)\ (prezip◦zlong) +1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">olpir &larr; lpir.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">lpir &larr; lpir + [lpir ≥ 32 ⇒[32] lpir +1] ].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">vpn &larr; (zip◦zrp field: ZVPN) +pp -(olpir +1).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">0 = vpn ⇒[user notify: &rsquo;pclass has no zone&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">vpn &larr; vpn + 0407.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">vmemfile settopage: vpn char: zz◦3 *2]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">file </span><span style="font: 10pt serif">[⇑vmemfile]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">getpages: i </span><span style="font: 10pt serif">| vpn<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[zadd◦zflen &lt; (zadd◦zfused + i) ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[zadd◦zflen &larr; zadd◦zflen + (i max: 20).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">vmemfile settopage: zadd◦zflen + 0407 char: 0]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">vpn &larr; zadd◦zfused.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">zadd◦zfused &larr; vpn+i.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑vpn]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">newZone </span><span style="font: 10pt serif">| zrp<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[zip is: Vector ⇒[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">zrp &larr; prezip◦zfree.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ zip◦zrp = 0 do⦂ [zrp &gt; (prezip◦zlong) ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user notify: &rsquo;zip overflow&rsquo;]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">zrp &larr; zrp+2].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">prezip◦zfree &larr; 2+zrp.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">zip◦zrp &larr; self getpages: 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑zrp/2]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pagesUsed </span><span style="font: 10pt serif">[⇑zadd◦zfused]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">read: len at: zz </span><span style="font: 10pt serif">| i str<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[i &larr; 256 - (zz◦3) "zw" min: len.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self cover: zz.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">str &larr; vmemfile next: 2*i.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i=len ⇒[⇑str]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">zz◦2 &larr; zz◦2 +1. "zp"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">zz◦3 &larr; 0. "zw"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑str concat: (self read: len-i at: zz)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">run: n after: zrp </span><span style="font: 10pt serif">| i j<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ i to: 15 do⦂ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[j &larr; zjmpt◦i +zrp -1 \ (prezip◦zlong) +1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">zip◦j = 0 ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[zip◦zrp &larr; zip◦zrp field: ZJMP &larr; i.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">zip◦j &larr; self getpages: n. ⇑zrp]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: &rsquo;new zip is full&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">write: str at: zz </span><span style="font: 10pt serif">| i len<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[len &larr; str length /2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; 256 - (zz◦3) "zw" min: len.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i = len ⇒[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self cover: zz.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">vmemfile append: str]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self write: str from: 1 at: zz]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">write: str from: pos at: zz </span><span style="font: 10pt serif">| i len<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[len &larr; str length +1 -pos.  "bytes yet to write"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; len min: (256 - (zz◦3) "zw")*2.  "bytes in page"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self cover: zz.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">vmemfile append: str◦(pos to: i+pos-1).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i=len ⇒[]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">zz◦2 &larr; zz◦2 +1. "zp"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">zz◦3 &larr; 0. "zw"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self write: str from: i+pos at: zz]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪VirtualMemory under: &rsquo;Primitive Access&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"Vmapper"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;Vmapper&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;object oop noop image&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;classtrans PCL mapqueue clamp stopcount USTableOop mrefs arefs count UseOldUniqueStrings &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>This class has not yet been commented</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Mapping</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">map </span><span style="font: 10pt serif">| i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(i &larr; mrefs lookup: oop) ⇒[i◦1 &larr; i◦1 -1. ⇑i◦2]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user kbck ⇒ [user kbd; ev] self bump].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">object class = Integer ⇒[⇑self mapInteger];<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">= UniqueString ⇒[⇑self mapUniqueString];<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">= Vector ⇒[⇑self mapVector];<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">= Float ⇒[⇑self mapFloat];<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">= MessageDict ⇒[⇑self mapMdict]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">object Is: HashSet ⇒[⇑self mapHashSet]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">object Is: String ⇒[⇑self mapString]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">object class = Class ⇒[⇑self mapClass];<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">= VariableLengthClass ⇒[⇑self mapClass];<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">= Vmapper ⇒[⇑¬1]; </span><span style="font: italic 10pt serif">"avoid recursion in writing"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">= VirtualMemory ⇒[⇑self mapVmem]; </span><span style="font: italic 10pt serif">"avoid recursion in writing"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"put any fixed octave class here"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">= Object ⇒[⇑self mapObject]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self mapNormal]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">mapClass </span><span style="font: 10pt serif">| nlen oadd i refs vm j<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[clamp find: object ⇒[⇑¬1 "don&rsquo;t write this class"]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nlen &larr; 1 + object class instsize. </span><span style="font: italic 10pt serif">"refct + normal fields"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; [object is: Class ⇒[oadd &larr; 0. 1] oadd &larr; 1. 20].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">noop &larr; self newoop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(vm &larr; classtrans lookup: oop) ⇒[vm◦1 &larr; noop]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">vm &larr; Vector new: i+1. vm◦1 &larr; noop.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">classtrans insert: oop with: vm].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nlen &larr; nlen + i + oadd.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image &larr; String new: 2*nlen.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(refs &larr; object refct) = 2 ⇒[</span><span style="font: italic 10pt serif">"exactly one reference"</span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">mrefs insert: oop with: (refs-2, noop)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: 1 &larr; refs -2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[oadd=1 ⇒[image word: 2 &larr; nlen-2]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ j from: (2+oadd to: nlen-i) do⦂ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[vm &larr; Vmapper new object: (object instfield: j-1-oadd).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: j &larr; vm map].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self writeout.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑noop]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">mapFloat </span><span style="font: 10pt serif">| refs i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[image &larr; String new: 8.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">noop &larr; self newoop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(refs &larr; object refct) = 2 ⇒[</span><span style="font: italic 10pt serif">"exactly one reference"</span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">mrefs insert: oop with: (refs-2, noop)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: 1 &larr; refs-2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: 3 do⦂ [image word: (i+1) &larr; object instfield: i].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self writeout.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑noop]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">mapHashObs  </span><span style="font: 10pt serif">| nlen oadd i refs vm trans ob<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[nlen &larr; object length. </span><span style="font: italic 10pt serif">"in words"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">oadd &larr; [nlen≤8⇒[0]1].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nlen &larr; oadd +1 +nlen.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image &larr; String new: 2*nlen.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(refs &larr; object refct) = 2 </span><span style="font: italic 10pt serif">"exactly one ref"</span><span style="font: 10pt serif"> ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[noop &larr; self newoop]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(i &larr; mrefs lookup: oop) ⇒[i◦1 &larr; i◦1 -1. noop &larr; i◦2]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">noop &larr; self newoop.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">mrefs insert: oop with: (refs-2, noop)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: 1 &larr; refs -2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[oadd=1⇒[image word: 2 &larr; object length]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ob &larr; (trans &larr; self permHashSet) objects.  </span><span style="font: italic 10pt serif">"translation dictionary"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: (2+oadd to: nlen) do⦂ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[vm &larr; ob◦(i-1-oadd).  </span><span style="font: italic 10pt serif">"integer noops"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">vm ≡ nil ⇒[] image word: i &larr; vm].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self writeout.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑noop, trans values]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">mapHashSet </span><span style="font: 10pt serif">| nlen i refs vm perm  </span><span style="font: italic 10pt serif">"all subclass on HashSet except Mdict"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[mrefs asOop = oop ⇒[⇑¬1] </span><span style="font: italic 10pt serif">"do not map"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">arefs asOop = oop ⇒[⇑¬1] </span><span style="font: italic 10pt serif">"do not map"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nlen &larr; 1 + (object class instsize). </span><span style="font: italic 10pt serif">"refct + fields"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image &larr; String new: 2*nlen.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">noop &larr; self newoop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(refs &larr; object refct) = 2 ⇒[</span><span style="font: italic 10pt serif">"exactly one reference"</span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">mrefs insert: oop with: (refs-2, noop)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: 1 &larr; refs -2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">vm &larr; Vmapper new object: (object instfield: 1).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; vm mapHashObs.  </span><span style="font: italic 10pt serif">"(oop, perm)"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: 2 &larr; i◦1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">perm &larr; i◦2.  </span><span style="font: italic 10pt serif">"permutation of other parts"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: (3 to: nlen) do⦂ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[vm &larr; Vmapper new object: (object instfield: i-1).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: i &larr; (vm mapHashVals: perm)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self writeout.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑noop]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">mapHashVals: perm </span><span style="font: 10pt serif">| nlen oadd i refs vm  </span><span style="font: italic 10pt serif">"values vec of dictionary"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[oop = ¬1 ⇒[⇑¬1]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nlen &larr; object length. </span><span style="font: italic 10pt serif">"in words"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">oadd &larr; [nlen≤8⇒[0]1].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nlen &larr; oadd +1 +nlen.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image &larr; String new: 2*nlen.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(refs &larr; object refct) = 2 </span><span style="font: italic 10pt serif">"exactly one ref"</span><span style="font: 10pt serif"> ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[noop &larr; self newoop]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(i &larr; mrefs lookup: oop) ⇒[i◦1 &larr; i◦1 -1. noop &larr; i◦2]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">noop &larr; self newoop.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">mrefs insert: oop with: (refs-2, noop)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: 1 &larr; refs -2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[oadd=1⇒[image word: 2 &larr; object length]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">object &larr; object◦perm.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: (2+oadd to: nlen) do⦂ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(vm &larr; Vmapper new) object: object◦ (i-1-oadd).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: i &larr; vm map].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self writeout.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑noop]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">mapInteger </span><span style="font: 10pt serif">| refs<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[¬02000 ≤ object and: object &lt; 01777 ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑oop </span><span style="font: italic 10pt serif">"small integer"</span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image &larr; String new: 4.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">noop &larr; self newoop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(refs &larr; object refct) = 2 ⇒[</span><span style="font: italic 10pt serif">"exactly one reference"</span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">mrefs insert: oop with: (refs-2, noop)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: 1 &larr; refs-2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: 2 &larr; object.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self writeout.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑noop]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">mapMdict </span><span style="font: 10pt serif">| i refs vm perm  </span><span style="font: italic 10pt serif">" maps MessageDict instance "</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[image &larr; String new: 12.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">noop &larr; self newoop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(refs &larr; object refct) = 2 ⇒[</span><span style="font: italic 10pt serif">"exactly one reference"</span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">mrefs insert: oop with: (refs-2, noop)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: 1 &larr; refs -2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(vm &larr; Vmapper new) object: (object instfield: 1).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; vm mapHashObs.  </span><span style="font: italic 10pt serif">"(oop, perm)"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: 2 &larr; i◦1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">perm &larr; i◦2.  </span><span style="font: italic 10pt serif">"permutation of other parts"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: (3 to: 6) do⦂ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(vm &larr; Vmapper new) object: (object instfield: i-1).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">i = 3 ⇒[image word: 3 &larr; (vm mapMethodVec: perm)]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: i &larr; (vm mapHashVals: perm)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self writeout.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑noop]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">mapMethod </span><span style="font: 10pt serif">| nlen oadd refs i a vm b<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[oop = ¬1 ⇒[⇑¬1]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nlen &larr; object length. </span><span style="font: italic 10pt serif">"in bytes!!"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">oadd &larr; [nlen≤8⇒[0]1].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nlen &larr; 2*oadd +2 +nlen.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image &larr; String new: nlen+1 |2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(refs &larr; object refct) = 2 </span><span style="font: italic 10pt serif">"exactly one ref"</span><span style="font: 10pt serif"> ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[noop &larr; self newoop]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(i &larr; mrefs lookup: oop) ⇒[i◦1 &larr; i◦1 -1. noop &larr; i◦2]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">noop &larr; self newoop.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">mrefs insert: oop with: (refs-2, noop)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: 1 &larr; refs -2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[oadd=1⇒[image word: 2 &larr; object length]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[nlen ≤ 8 or⦂ object◦6 = 6 ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[image◦(2*oadd +3 to: nlen) &larr; object]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">a &larr; 2*oadd +3. b &larr; object◦6.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">image◦(a to: a+5) &larr; object◦(1 to: 6).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: (4 to: b /2) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(vm &larr; Vmapper new) object: (object word: i) asObject.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: (i+1+oadd) &larr; vm map].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">image◦(a+b to: nlen) &larr; object◦(b+1 to: object length)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self writeout.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑noop]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">mapMethodVec: perm </span><span style="font: 10pt serif">| nlen oadd i refs vm<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[oop = ¬1 ⇒[⇑¬1]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nlen &larr; object length. </span><span style="font: italic 10pt serif">"in words"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">oadd &larr; [nlen≤8⇒[0]1].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nlen &larr; oadd +1 +nlen.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image &larr; String new: 2*nlen.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(refs &larr; object refct) = 2 </span><span style="font: italic 10pt serif">"exactly one ref"</span><span style="font: 10pt serif"> ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[noop &larr; self newoop]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(i &larr; mrefs lookup: oop) ⇒[i◦1 &larr; i◦1 -1. noop &larr; i◦2]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">noop &larr; self newoop.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">mrefs insert: oop with: (refs-2, noop)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: 1 &larr; refs -2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[oadd=1⇒[image word: 2 &larr; object length]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">object &larr; object◦perm.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: (2+oadd to: nlen) do⦂ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(vm &larr; Vmapper new) object: object◦ (i-1-oadd).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: i &larr; vm mapMethod].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self writeout.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑noop]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">mapNormal </span><span style="font: 10pt serif">| nlen i refs vm oadd </span><span style="font: italic 10pt serif">"all fixed, pointer type classes"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[clamp find: object class ⇒[⇑¬1 "don&rsquo;t write the instance"]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nlen &larr; object class instsize.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">oadd &larr; [nlen≤19⇒[0]1].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nlen &larr; oadd+1 +nlen.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image &larr; String new: 2*nlen.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">noop &larr; self newoop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(refs &larr; object refct) = 2 ⇒[</span><span style="font: italic 10pt serif">"exactly one reference"</span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">mrefs insert: oop with: (refs-2, noop)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: 1 &larr; refs-2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[oadd=1⇒[image word: 2 &larr; nlen-oadd-1]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: (2+oadd to: nlen) do⦂ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[vm &larr; Vmapper new object: (object instfield: i-oadd-1).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: i &larr; vm map].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self writeout.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑noop]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">mapObject </span><span style="font: 10pt serif">| refs  </span><span style="font: italic 10pt serif">"nil, false, true"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[object≡nil ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[mrefs insert: ¬1 with: (500, ¬1). </span><span style="font: italic 10pt serif">"for speed of<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">catching nil. watch out on cleanup"</span><span style="font: 10pt serif"> ⇑¬1]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image &larr; String new: 4.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">noop &larr; self newoop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">noop\128&gt;1 ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user notify: &rsquo;Unidentified flying Object&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(refs &larr; object refct) = 2 ⇒[</span><span style="font: italic 10pt serif">"exactly one reference"</span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">mrefs insert: oop with: (refs-2, noop)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: 1 &larr; refs -2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self writeout.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑noop]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">mapString </span><span style="font: 10pt serif">| nlen oadd refs<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[nlen &larr; object length. </span><span style="font: italic 10pt serif">"in bytes!!"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">oadd &larr; [nlen≤8⇒[0]1].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nlen &larr; 2*oadd +2 +nlen.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image &larr; String new: nlen+1 |2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">noop &larr; self newoop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(refs &larr; object refct) = 2 ⇒[</span><span style="font: italic 10pt serif">"exactly one reference"</span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">mrefs insert: oop with: (refs-2, noop)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: 1 &larr; refs -2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[oadd=1⇒[image word: 2 &larr; object length]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image◦((2*oadd +3) to: nlen) &larr; object.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self writeout.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑noop]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">mapUniqueString </span><span style="font: 10pt serif">| nlen oadd refs<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[UseOldUniqueStrings ⇒[self UniStroop. noop &larr; oop]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(refs &larr; arefs lookup: oop) ⇒[⇑refs]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">noop &larr; self newoop.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">arefs insert: oop with: noop].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nlen &larr; object length. </span><span style="font: italic 10pt serif">"in bytes!!"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">oadd &larr; [nlen≤8⇒[0]1].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nlen &larr; 2*oadd +2 +nlen.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image &larr; String new: nlen+1 |2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: 1 &larr; 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[oadd=1⇒[image word: 2 &larr; object length]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image◦((2*oadd +3) to: nlen) &larr; object.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self writeout.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑noop]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">mapVector </span><span style="font: 10pt serif">| nlen oadd i refs vm<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[UseOldUniqueStrings ⇒[] USTableOop = oop ⇒[⇑¬1]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"do not map since new atom Oops"</span><span style="font: 10pt serif">]. <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nlen &larr; object length. </span><span style="font: italic 10pt serif">"in words"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">oadd &larr; [nlen≤8⇒[0]1].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nlen &larr; oadd +1 +nlen.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image &larr; String new: 2*nlen.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">noop &larr; self newoop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(refs &larr; object refct) = 2 ⇒[</span><span style="font: italic 10pt serif">"exactly one reference"</span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">mrefs insert: oop with: (refs-2, noop)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: 1 &larr; refs-2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[oadd=1⇒[image word: 2 &larr; object length]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: (2+oadd to: nlen) do⦂ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[vm &larr; Vmapper new object: (object◦ (i-1-oadd)).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: i &larr; vm map].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self writeout.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑noop]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">mapVmem </span><span style="font: 10pt serif">| nlen i refs vm  "VirtualMemory, Vmem and Pmap"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[nlen &larr; 1 + (object class instsize). "refct + fields"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image &larr; String new: 2*nlen.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">noop &larr; self newoop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(refs &larr; object refct) = 2 ⇒["exactly one reference"]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">mrefs insert: oop with: (refs-2, noop)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: 1 &larr; refs -2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: (2 to: nlen) do⦂ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[image word: i &larr; ¬1]. "Vmem needed for purgealittle"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self writeout.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑noop]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">permHashSet </span><span style="font: 10pt serif">| ob i bb nili vm   </span><span style="font: italic 10pt serif">"gets new atoms, returns dict of objects and permutation"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[bb &larr; Dictionary new init: object length.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; 1. while⦂ (object◦i ≡ nil and: i ≠ object length) do⦂ [i &larr; i+1].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[((object◦i) class) ≡ Integer ⇒[false]; ≡ String ⇒[false] true] ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ i to: object length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[object◦i ≡ nil ⇒[nili &larr; i]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">vm &larr; Vmapper new object: object◦i.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">bb insert: vm map with: i].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">ob &larr; bb values.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: ob length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ob◦i ≡ nil ⇒[ob◦i &larr; nili] ].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑bb]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ob &larr; bb objects.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: ob length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[vm &larr; Vmapper new object: object◦i.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">ob◦i &larr; vm map].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ob &larr; bb values.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: ob length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ob◦i &larr; i].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑bb]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Writing Out</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">method: sel </span><span style="font: 10pt serif">| v str a j i   </span><span style="font: italic 10pt serif">"object is a class. find this method and construct vmapper"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(v &larr; classtrans lookup: oop) ≡ false ⇒[user notify: &rsquo;object not a class&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">str &larr; Pmap readin: v◦1. </span><span style="font: italic 10pt serif">"class image"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; Pmap readin: (str word: 1+4+(oop/0200)). </span><span style="font: italic 10pt serif">"mdict image"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">str &larr; Pmap readin: (i word: 1+1). </span><span style="font: italic 10pt serif">"objects vector image"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">a &larr; String new: 2. a word: 1 &larr; sel asOop. </span><span style="font: italic 10pt serif">"selector"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">j &larr; str find: a◦2. <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">a◦1 ≠ (str◦(j-1)) ⇒[user notify: &rsquo;can not find&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; Pmap readin: (i word: 1+2). </span><span style="font: italic 10pt serif">"methods vector image"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">v &larr; Vmapper new object: (object md method: sel).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">v noop: (i word: (j/2)). v readin.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑v]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">newoop </span><span style="font: 10pt serif">| v a i indx o </span><span style="font: italic 10pt serif">"see if classtrans can help find new oop"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(v &larr; classtrans lookup: (i &larr; object class) asOop) ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[indx &larr; 1 + (Vmem freelist: object).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> [i ≡ Class ⇒[oop ≤ 027 ⇒[⇑oop] </span><span style="font: italic 10pt serif">"touchoop set it up"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">v◦indx ≤ 027 ⇒[v◦indx &larr; 027+1] ];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">≡ VariableLengthClass ⇒[o &larr; v◦indx. </span><span style="font: italic 10pt serif">"in case pclass changes"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">v◦indx &larr; o max: o|128 +(oop\128) +1. <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ o|128 +(oop\128)] ].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">a &larr; self nextfree: v◦indx.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">v◦indx &larr; a◦2. ⇑a◦1]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> a &larr; [i is: Class ⇒[1] 20].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> v &larr; Vector new: a+1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> classtrans insert: (object class) asOop with: v.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ⇑self newoop]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">newpcl: n </span><span style="font: 10pt serif">| a pm0<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"object class = Foo ⇒[an exception]"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pm0 &larr; Vmem lowPM: oop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">a &larr; [pm0 ⇒[Pmap newLowPM&larr; pm0]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">Pmap newHighPM&larr; (Vmem highPM: oop)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">n=¬1 ⇒[Pmap newZN: a. Pmap ZHB: a gets: 0. ⇑a]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Pmap ZN: a gets: (Pmap ZN: n).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Pmap ZHB: a gets: 1 + (Pmap ZHB: n).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑a]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">nextfree: n </span><span style="font: 10pt serif">| a<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[n≡nil ⇒[n &larr; self newpcl: ¬1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑(n, (n+1))]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">n\0200 = 0177 ⇒[a &larr; self newpcl: n.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑(n, a)]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑(n, (n+1))]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">object: object<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[oop &larr; object asOop]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">readin </span><span style="font: 10pt serif">| v  </span><span style="font: italic 10pt serif">"read object off vmemfile and return image"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[noop ≡ nil ⇒[(v &larr; mrefs lookup: oop) ⇒[noop &larr; v◦2] <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: &rsquo;can not find new oop&rsquo;]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑image &larr; Pmap readin: noop]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">writeout<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"write image of object on file"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Pmap writeout: noop with: image]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Init and Exceptions</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">Acomment<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Vmapper writes objects out.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">watch out for abnormally high refcts.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">we trust map to catch all special cases (especially<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">fixed octave classes (VariableLengthClass)).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Vmapper edit: ↪mapObject.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Vmem is VirtualMemory of this system.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Pmap is VirtualMemory of new system.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">refct in mrefs is 1-order (0 = all done)<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">mrefs - a Dictionary<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">old oop  -&gt;  (remaining refct, new oop)<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">classtrans - a Dictionary<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">old class oop  -&gt;  (new oop, freelist oop)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">-&gt;  (new oop, 20 freelist oops)<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">sequence of foreign object:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">map (put in mrefs) <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">newoop (classtrans lookup old class)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">not there⇒ create pclass, get zone, zip entry<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">enter freelist, no new class in classtrans<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">put nop in mrefs, write object out<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">later: map class, fill in classtrans new class<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">later: pass over PM, convert RCI<br><br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">To remap atoms:</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">To only copy atoms:<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">giveBirth3 - arefsRectify</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">- don&rsquo;t call<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">mapUniqueString -uniStrOop</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">-newoop, arefs<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">mapVector - filter USTable</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">-don&rsquo;t<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">writefreelists - don&rsquo;t freelistRectify</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">-call it<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">(Speed only below)<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">permHashSet - test objects</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">-force fail on test<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Now above done by setting UseOldUniqueStrings in giveBirth3.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"</span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">arefsRectify </span><span style="font: 10pt serif">| i ustable vm </span><span style="font: italic 10pt serif">"create USTable and write out"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[UseOldUniqueStrings ⇒[⇑nil </span><span style="font: italic 10pt serif">"dont create if using old atoms"</span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ustable &larr; Vector new: USTable length.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: ustable length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ustable◦i &larr; Vector new: 2].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; ustable.  ustable &larr; USTable. USTable &larr; i.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: arefs objects do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[i ≡ nil ⇒[]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">↪a intern: i asObject].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; ustable.  ustable &larr; USTable. USTable &larr; i.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">vm &larr; Vmapper new.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">vm object: ustable.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self reset; object: (Smalltalk ref: ↪USTable); readin.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: 2 &larr; vm map. </span><span style="font: italic 10pt serif">"ref new table"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self writeout; reset]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">bump  </span><span style="font: italic 10pt serif">"count objects mapped, print"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[count &larr; count + 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">count\ 100 = 0 ⇒[user clearshow: count asString; space;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">show: oop base8; cr.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">count = stopcount ⇒[user ev; show: stopcount asOop base8]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">freelistRectify </span><span style="font: 10pt serif">| i v  </span><span style="font: italic 10pt serif">"fix bad atom freelist"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[UseOldUniqueStrings ⇒[] ⇑nil].  </span><span style="font: italic 10pt serif">"dont rectify if new atom names created"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: (Vmem pmatm to: 0174000 - 0200 by: 0200) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(Vmapper new object: i asObject) UniStroop].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">v &larr; classtrans lookup: 0602.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: (2 to: 21) do⦂ [v◦i ≡ nil ⇒[]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">v◦i &larr; v◦i + 1]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init   </span><span style="font: italic 10pt serif">"set up class variables"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[PCL &larr; 151.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">classtrans &larr; Dictionary new init: 32.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">mrefs &larr; Dictionary new init: 64.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">arefs &larr; Dictionary new init: 64.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">count &larr; 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">stopcount &larr; 5 </span><span style="font: italic 10pt serif">"no stopping"</span><span style="font: 10pt serif">.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">clamp &larr; HashSet new init: 8. <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"clamp insertall: (ClassA, ClassB, ClassC...).""ones to get rid of"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">USTableOop &larr; USTable asOop.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"override this in VirtualMemory giveBirth3"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">UseOldUniqueStrings &larr; true]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">mrefsRectify </span><span style="font: 10pt serif">| v zz<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ v from: mrefs values do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[v ≡ nil ⇒[]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">v◦1 = 0 ⇒[</span><span style="font: italic 10pt serif">"refct ok"</span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">v◦2 = ¬1 ⇒[</span><span style="font: italic 10pt serif">"nil not on disk"</span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">zz &larr; Pmap obwiz: v◦2.  </span><span style="font: italic 10pt serif">"noop"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">image &larr; Pmap read: 2 at: zz.  </span><span style="font: italic 10pt serif">"2 words"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: 1 &larr; (image word: 1) - (v◦1).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">Pmap writeout: v◦2 with: image.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self reset]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">noop: noop </span><span style="font: italic 10pt serif">"give it noop for readin"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">reset </span><span style="font: 10pt serif">[noop &larr; image &larr; nil]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">touchoop </span><span style="font: 10pt serif">| v a i indx </span><span style="font: italic 10pt serif">"claim pclass, zone, classtrans"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(v &larr; classtrans lookup: (object class) asOop) ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[indx &larr; 1 +(Vmem freelist: object).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">a &larr; self nextfree: v◦indx.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">v◦indx &larr; a◦1. </span><span style="font: italic 10pt serif">"not take it"</span><span style="font: 10pt serif"> ⇑a◦1]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> i &larr; [object class is: Class ⇒[1] 20].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> v &larr; Vector new: i+1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> classtrans insert: (object class) asOop with: v.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ⇑self touchoop]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">UniStroop </span><span style="font: 10pt serif">| pm0 v indx<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Unique Strings must get same oop and pclass"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">v &larr; classtrans lookup: 0602.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">indx &larr; 1+ (Vmem freelist: object).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pm0 &larr; Pmap highPM: oop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pm0 and⦂ 0 ≠ pm0 ⇒[</span><span style="font: italic 10pt serif">"test for new max freelist"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(oop field: PCL) = (v◦indx field: PCL) ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[v◦indx &larr; v◦indx max: oop]] <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Pmap highpm0: oop gets: (Vmem highPM: oop).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Pmap ZHB: oop gets: (Vmem ZHB: oop).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">v◦indx ≡ nil ⇒[Pmap newZN: oop.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">v◦indx &larr; oop]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Pmap ZN: oop gets: (Pmap ZN: v◦indx).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">v◦indx &larr; oop min: v◦indx<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">UseOldUniqueStrings: a </span><span style="font: 10pt serif">[UseOldUniqueStrings &larr; a] </span><span style="font: italic 10pt serif">"true if do not want atoms remapped"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">writefreelists </span><span style="font: 10pt serif">| v oadd i nlen str<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self freelistRectify.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nlen &larr; 1 + Class instsize. oadd &larr; 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">str &larr; String new: 4. <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">str word: 1 &larr; 1. str word: 2 &larr; ¬1. </span><span style="font: italic 10pt serif">"refct=1, link = nil"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ v from: classtrans values do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[v ≡ nil ⇒[]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">image &larr; Pmap readin: v◦1.  </span><span style="font: italic 10pt serif">"noop"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[v length = 2 ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"a Class"</span><span style="font: 10pt serif"> v◦2 ≡ nil ⇒[]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: (1+nlen) &larr; v◦2.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">Pmap writeout: v◦2 with: str]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"a Variable Length Class"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: 20 do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[v◦(1+i) ≡ nil ⇒ []<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: (i+nlen+oadd) &larr; v◦(1+i).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">Pmap writeout: v◦(1+i) with: str] ].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">Pmap writeout: v◦1 with: image].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self reset]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>As yet unclassified</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">Addons<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(dp0 file: &rsquo;VmapperAdd.st&rsquo;) filout: ↪(<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">arefs  </span><span style="font: italic 10pt serif">"dictionary of UniqueString oops and noops"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑arefs]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classtrans </span><span style="font: 10pt serif">[⇑classtrans]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">image </span><span style="font: 10pt serif">[⇑image]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">mrefs </span><span style="font: italic 10pt serif">"dictionary of multiple refct oops"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑mrefs]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">noop </span><span style="font: 10pt serif">[⇑noop]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">object </span><span style="font: 10pt serif">[⇑object]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">oop </span><span style="font: 10pt serif">[⇑oop]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[oop ≡ nil ⇒[super printon: strm]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm append: &rsquo;Vmapper &rsquo;; append: oop base8]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">show </span><span style="font: 10pt serif">| i  </span><span style="font: italic 10pt serif">"show image of object in base8"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ i to: image length/2 do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user show: (image base8: i); space.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">i\3 = 0 ⇒[user cr]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪Vmapper under: &rsquo;Primitive Access&rsquo;.</span></div>
    <div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">&rsquo;From Smalltalk 5.5k XM November 24 on 22 November 1980 at 2:57:08 am.&rsquo;<br></span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">"ParagraphScanner"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;ParagraphScanner&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;para "&lt;Paragraph&gt;"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">style "&lt;TextStyle&gt;"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">press "&lt;PressFile&gt; for output"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">runstrm "&lt;Stream&gt; of paragraph runs"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">textstrm "&lt;Stream&gt; of paragraph text"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">font "&lt;WidthTable&gt; current font"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">ascent "&lt;Integer&gt; max ascent"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">descent "&lt;Integer&gt; negative max descent"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">width "&lt;Integer&gt; total width"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">spaces "&lt;Integer&gt; number of spaces"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">rect "&lt;Rectangle&gt; for printing"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">tabpos "&lt;Stream&gt; (text position, new X position) of tabs"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>Scans through a paragraph computing the dimensions of a partial line of text.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">in: rect</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ascent &larr; descent &larr; width &larr; spaces &larr; 0. tabpos reset]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">of: para to: press style: style<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[textstrm &larr; &rsquo;&rsquo; asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">runstrm &larr; para runs asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tabpos &larr; (Vector new: 10) asStream]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Access</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">position </span><span style="font: 10pt serif">[⇑textstrm position]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">width </span><span style="font: 10pt serif">[⇑width]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Scanning</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">backup<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[textstrm skip: ¬1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">scan </span><span style="font: italic 10pt serif">"Scan up to a zero-width character, back up to last blank if width exceeded"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| maxw sp char t<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"Save state" spos slim srunpos sasc sdesc swidth ssp sfont stpos<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[textstrm end and⦂ self newrun≡false⇒ [⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">maxw &larr; rect width.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ascent &larr; ascent max: font ascent.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">descent &larr; descent max: font descent.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">sp &larr; font space.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">t &larr; font scan: textstrm until: width exceeds: maxw.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(char &larr; t◦1) ≡ true⇒ [] width &larr; t◦2].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">char = 040] do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">["Save state"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">spos &larr; textstrm position. slim &larr; textstrm limit.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">srunpos &larr; runstrm position. stpos &larr; tabpos position.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">sasc &larr; ascent. sdesc &larr; descent.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">swidth &larr; width. ssp &larr; spaces. sfont &larr; font.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">spaces &larr; spaces+1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">width &larr; width+sp].<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">char⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(char≡true and⦂ nil≠spos) and⦂ (2*ascent ≤ rect height)⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"Back up to just past last blank (if another line fits)"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">textstrm of: para text from: spos+1 to: slim.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">runstrm position &larr; srunpos. tabpos position &larr; stpos.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">ascent &larr; sasc. descent &larr; sdesc.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">width &larr; swidth. spaces &larr; ssp. font &larr; sfont.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑040]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑char]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self newrun]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> do⦂ [].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">tab<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[spaces &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tabpos next &larr; textstrm position;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">next &larr; (width &larr; width + font tab | font tab)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Printing</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printfrom: charpos aligned: align skip: n </span><span style="font: italic 10pt serif">"Returns false if goes below bottom"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| ybot a b ix iy px xs sp rs len tpos ts ntab rval ifont w ps [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">this code basically writes the EL (entity list) for a line</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"bottom of character -- ascent not really ascent but height"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(ybot &larr; rect corner y - ascent) &lt; rect origin y ⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">won&rsquo;t fit</span><span style="font: 10pt serif">" ⇑false]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">a &larr; charpos + 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">b &larr; textstrm position - n.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[a &gt; b ⇒ [</span><span style="font: italic 10pt serif">"No text"</span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ts &larr; tabpos viewer.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tpos &larr; ts next.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">px &larr; false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">xs &larr; rect width - width.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ix &larr; rect minX + ["</span><span style="font: italic 10pt serif">left margin offset</span><span style="font: 10pt serif">" align=2⇒ [xs/2]; =4⇒[xs] 0].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">set baseline of character.  do setx before showchars</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">press sety: (iy &larr; ybot + descent).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sp &larr; font space "kludge?".<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[align=1⇒ ["</span><span style="font: italic 10pt serif">do setspacex before showchars</span><span style="font: 10pt serif">"] press setspacex: sp].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rs &larr; (para run: a to: b) asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ (len &larr; rs next) do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">press selectfont: (press fontindex: (rval &larr; rs next) style: style) - 1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">b &larr; a+len.<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(rval land: 4) = 0⇒ ["no underlining"]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"unfortunately, we must rescan this part of line to find out how wide it is"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">ifont &larr; press codefont: rval style: style "a WidthTable".<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">ps &larr; (para◦(a to: b-1)) asStream.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">w &larr; true, 0.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ w◦1 do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">w &larr; ifont scan: ps until: w◦2 exceeds: rect width.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">w◦1 = 040⇒ [w◦2 &larr; w◦2 + ifont space];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=011⇒ [w◦2 &larr; w◦2 + ifont tab | ifont tab]].<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[px⇒ ["use current x position"] press setx: ix].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"change y position to show rectangle, then change y back again"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">press sety: iy-40; showrectwidth: w◦2 height: 30; sety: iy].<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">ntab &larr; 0.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ (tpos and⦂ tpos&lt;b) do⦂ [</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Put out tabs"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[tpos = a⇒ ["</span><span style="font: italic 10pt serif">no text between this tab and last</span><span style="font: 10pt serif">"]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">put out accumulated tabs or initial x</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ntab&gt; 0⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">press skipchars: ntab; setx: px.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">ntab &larr; 0]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">px⇒ []<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">press setx: (px &larr; ix)].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">press showchars: tpos-a].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">ntab &larr; ntab+1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">px &larr; ix + ts next.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">a &larr; tpos+1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">tpos &larr; ts next].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ntab&gt; 0⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">press skipchars: ntab;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">setx: px]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">px⇒ []<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">press setx: (px &larr; ix)].<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[align=1 and⦂ tpos≡false ⇒</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Reset space width"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[spaces=0⇒ [] press setspacex: xs/spaces+sp].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">align &larr; 0]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">rs end⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">for more compactness, maybe</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">press showchars: b-a skip: n.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ybot]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">press showchars: b-a.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">a &larr; b]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[n &gt; 0⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">skip over ending blank or carriage return</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">press skipchars: n]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ybot]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Private scanning</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">newrun </span><span style="font: 10pt serif">| len pos [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">len &larr; runstrm next⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pos &larr; textstrm position.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">textstrm of: para text from: pos+1 to: pos+len.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">font &larr; press codefont: (runstrm next) style: style]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪ParagraphScanner under: &rsquo;Press File Support&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"PressFile"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;PressFile&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;DL "&lt;File&gt; stores data list"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">EL "&lt;Set&gt; accumulates entity list"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">parts "&lt;Set&gt; accumulates part directory"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">DLstart "&lt;Integer&gt; position of current entity in DL"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">ELstart "&lt;Integer&gt; word position of current entity in EL"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">Pstart "&lt;Integer&gt; record position of current page in DL"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">eorigin "&lt;Point&gt;"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">scale "&lt;Integer&gt; micas per Alto screen dot"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">boundbox "&lt;Rectangle&gt; bounding box for current page"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fontcodes "&lt;Vector&gt; of run codes corresponding to current fonts"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fontdefs "&lt;Vector of WidthTables&gt; corresponding to fontcodes"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">estate "&lt;Vector&gt; of some entity state"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">FL "&lt;Set&gt; accumulates strings for Ext. File part" &rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;prevstyle SMentity recordsize printers printerMenu &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>There are two levels of code in this class: the low-level Press commands and the high level user commands.  At the moment, only text, lines and bitmaps are supported (see Paragraph presson:in: and class ParagraphScanner for the former).  ignores bounding box stuff. limited reading.<br><br>see &lt;GR-DOCS&gt;PressFormat.Press and PressFormat-figure.Press for more details</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">of: DL </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">EL &larr; Set new string: 200.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">FL &larr; Set new string: 40.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">parts &larr; Set new string: 40.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fontcodes &larr; Vector new: 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fontdefs &larr; Vector new: 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">estate &larr; Vector new: 3 "font, spacex, spacey, ...".<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">prevstyle&larr; nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self scale: PressScale;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">startPage]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">reset </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DL readwriteshorten; reset.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self of: DL]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">scale: scale</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Aspects</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">defaultPrinterName </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑[currentProfile ≡ nil⇒ [PrinterName] currentProfile printerName]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">name </span><span style="font: 10pt serif">[⇑DL name]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">scale </span><span style="font: 10pt serif">[⇑scale]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Entity/Page/File Commands</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">box: rect hue: hue sat: sat bright: bright containing⦂ expr | w r</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self entity: (self transrect: (w&larr; rect inset: ¬2)) containing⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ r from: (w minus: rect) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self showrect: r color: 0].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ColorPrint⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self hue: hue; saturation: sat;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">showrect: rect color: bright; brightness: 0]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">expr eval]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">clip: boundingbox</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">close </span><span style="font: 10pt serif">| p i font [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DL writing≡false⇒ [DL close]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self closePage.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">parts≡false or⦂ parts empty⇒ []<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"if present, include the external file part  --- added Sept 80"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[FL empty⇒[]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self part⦂ [DL append: FL] code: 2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">FL reset.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self padpage].<br><br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"put font names and descriptions into font directory (part)"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self part⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: fontdefs length do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">font &larr; fontdefs ◦ i.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">DL nextword&larr; 16; nextword&larr; i-1;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">next &larr; font min; next &larr; font max.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self Bcpl: font name pad: 20.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">DL next &larr; font face; next &larr; font min;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextword &larr; font pointsize; nextword&larr; 0]]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">code: 1.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">write part directory. Pstart is current page position</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DL append: parts asReadStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self padpage.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">p &larr; self recordnum.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">document directory</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DL nextword&larr; 27183; </span><span style="font: italic 10pt serif">"press password"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextword&larr; p + 1 </span><span style="font: italic 10pt serif">"number of records"</span><span style="font: 10pt serif">;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextword&larr; parts position / 8 </span><span style="font: italic 10pt serif">"number of parts"</span><span style="font: 10pt serif">;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextword&larr; Pstart; </span><span style="font: italic 10pt serif">"part dir and length"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextword&larr; p - Pstart;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextword&larr; ¬1; "</span><span style="font: italic 10pt serif">backpointer to obsolete doc dir</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">append: user timewords; "2 time words"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextword&larr; 1; </span><span style="font: italic 10pt serif">"first and last copies"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextword&larr; 1;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextword&larr; ¬1; </span><span style="font: italic 10pt serif">"first and last pages"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextword &larr; ¬1;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextword &larr; &rsquo;S&rsquo;◦1 "</span><span style="font: italic 10pt serif">solid color (looked at by color printers)</span><span style="font: 10pt serif">";<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">next: 2*(0177-12) &larr; 0377.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">p &larr; user now.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self Bcpl: self name pad: 52;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">Bcpl: [currentProfile≡nil⇒ [dp0 diskID◦1] currentProfile printedBy] pad: 32;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">Bcpl: [((String new: 40) asStream) print: p◦1; space; print: p◦2; contents] pad: 40;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">padpage.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DL close.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">parts reset]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">entity: box containing⦂ expr </span><span style="font: 10pt serif">| v [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self startEntity.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">boundbox &larr; box.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">v &larr; expr eval.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self closeEntity.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑v]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">entityorigin: eorigin</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">page </span><span style="font: 10pt serif">[self closePage]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pictureinit </span><span style="font: 10pt serif">[self pictureinit: user screenrect scale: PressScale]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pictureinit: rect scale: scale<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[boundbox &larr; boundbox include: (self transrect: rect).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self somefont]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">screenout: rect scale: scale<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"puts a bit map image onto the PressFile.  The standard<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">scaling is 32 micas per Alto dot.  22 looks better, Dover only<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">works with 32"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user displayoffwhile⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self somefont; setp: (self transrect: rect) origin; bitmap: rect bits: false; close]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">selectPrinter </span><span style="font: 10pt serif">[⇑self selectPrinter: self defaultPrinterName]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">selectPrinter: oldName </span><span style="font: 10pt serif">| t [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user cr; show: &rsquo;select a printer (currently &rsquo;;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">show: [oldName≡false or⦂ oldName empty⇒ [&rsquo;none&rsquo;] oldName]; show: &rsquo;)&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user cursorloc &larr; user screenrect center; restoredisplay.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">t &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ t = 0 do⦂ [t &larr; printerMenu wbug].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑[t ≤ printers length⇒ [printers◦t]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">t = (printers length+1)⇒ ["same" oldName] "none" false]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">toPrinter </span><span style="font: 10pt serif">[self toPrinter: self defaultPrinterName]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">toPrinter: ndest </span><span style="font: 10pt serif">"a printer name" | psocket dest np t perr [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ndest ≡ false⇒ ["don&rsquo;t try to print" ⇑false]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">E ≡ nil⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"use O.S. if Smalltalk ethercode not alive"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">t &larr; (String new: 100) asStream.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">t append: &rsquo;Empress. &rsquo;; append: self name.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ndest length &gt; 0⇒ [t space; append: ndest; append: &rsquo;/H&rsquo;]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">t append: &rsquo;; Resume.~ Small.Boot&rsquo;.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user quitThen: t asReadStream]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dest &larr; &rsquo;&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">perr &larr; psocket &larr; false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">np &larr; printers length+1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DL readonly.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ ndest do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">perr or⦂ ndest empty⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">perr &larr; false.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">ndest &larr; self selectPrinter: dest]<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[dest = ndest⇒ ["to same printer"]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">dest &larr; ndest.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"close previous socket"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">psocket⇒ [psocket close. psocket &larr; false]].<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[psocket⇒ []<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"create new socket"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">psocket &larr; EFTPSender new hostName: dest⇒ [psocket wakeup]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user cr; show: &rsquo;name lookup failure&rsquo;].<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"send file"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">psocket and⦂ (user displayoffwhile⦂ [psocket send: DL reset])⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"success--stop" ndest &larr; false]<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"failure--switch servers?"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">perr &larr; true].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"cleanup after success or abort"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DL close.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">psocket⇒ [psocket close]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Fonts</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">codefont: code style: style<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑fontdefs◦(self fontindex: code style: style)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fontindex: code style: style </span><span style="font: 10pt serif">| ix font n<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"return index if in font dictionary"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">code &larr; code land: 0363.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Remove underline and strikeout"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[style=prevstyle⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(ix &larr; fontcodes find: code) &gt; 0 ⇒ [⇑ix]]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">fontcodes all&larr; nil. "invalid across style change"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">prevstyle&larr; style].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">n &larr; code / 16 + 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">font &larr; (WidthTable new<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">named: (style fontfamily: n)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pointsize: (style fontsize: n)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">face: (code / 2 land: 1) + (code * 2 land: 2))<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> lookup.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(ix&larr; fontdefs find: font)&gt;0⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[fontcodes◦ix&larr; code. ⇑ix]<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"add entry to font dictionary"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fontdefs length=16⇒[user notify: &rsquo;too many fonts&rsquo;. ⇑1]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fontcodes &larr; fontcodes, code.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fontdefs &larr; fontdefs, font.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑fontcodes length]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">selectfont: f </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">estate◦1 = f⇒ []<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">EL next &larr; 0160 + (estate◦1 &larr; f)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">somefont</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"fool self into writing non-empty fontdir"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self fontindex: 5*16 style: DefaultTextStyle]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Transformations</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">transpt: p<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑ Point new x: (p x * scale) asInteger y: (25400 - (p y * scale)) asInteger]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">transrect: rect<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑ Rectangle new<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">origin: (self transpt: rect minX ⌾ rect maxY)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">corner: (self transpt: rect maxX ⌾ rect minY)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>EL commands</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">brightness: b </span><span style="font: 10pt serif">[EL next&larr; 0370; next&larr; b]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hue: b </span><span style="font: 10pt serif">[EL next&larr; 0371; next&larr; b]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">onlyoncopy: n </span><span style="font: 10pt serif">[EL next &larr; 0355; next &larr; n]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">resetspace </span><span style="font: 10pt serif">[EL next &larr; 0366]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">saturation: s </span><span style="font: 10pt serif">[EL next&larr; 0372; next&larr; s]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">setp: p </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"self setx: p x; sety: p y"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">EL next &larr; 0356; nextword &larr; p x;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">next &larr; 0357; nextword &larr; p y]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">setspacex: x </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">estate◦2 = x⇒ []<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">estate◦2 &larr; x.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">x ≥ 0 and⦂ x ≤ 2047⇒ ["</span><span style="font: italic 10pt serif">short form</span><span style="font: 10pt serif">" EL nextword &larr; 060000 + x]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">EL next &larr; 0364; nextword &larr; x]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">setspacey: y </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">estate◦3 = y⇒ []<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">estate◦3 &larr; y.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">y ≥ 0 and⦂ y ≤ 2047⇒ ["</span><span style="font: italic 10pt serif">short form</span><span style="font: 10pt serif">" EL nextword &larr; 064000 + y]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">EL next &larr; 0365; nextword &larr; y]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">setx: x </span><span style="font: 10pt serif">[EL next &larr; 0356; nextword &larr; x]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sety: y </span><span style="font: 10pt serif">[EL next &larr; 0357; nextword &larr; y]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">showchar: char </span><span style="font: 10pt serif">["immediate" EL next &larr; 0363; next &larr; char]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">showchars: n </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">n=0⇒ []<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">n ≥ 1 and⦂ n ≤ 32⇒ ["</span><span style="font: italic 10pt serif">short form</span><span style="font: 10pt serif">" EL next &larr; n-1]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">EL next &larr; 0360; next &larr; n]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">showchars: n skip: t </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">t=1 and⦂ (n ≥ 1 and⦂ n ≤ 32)⇒ [EL next &larr; 0100 + n-1]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self showchars: n; skipchars: t]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">showdots: nwords </span><span style="font: 10pt serif">[EL next &larr; 0374; nextNumber: 4 &larr; nwords]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">showdotsopaque: nwords </span><span style="font: 10pt serif">[EL next &larr; 0375; nextNumber: 4 &larr; nwords]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">showrect: rect </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self setp: rect origin.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">EL next &larr; 0376;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextword &larr; rect width;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextword &larr; rect height]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">showrect: rect color: c </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ColorPrint⇒ [self brightness: c]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self showrect: (self transrect: rect)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">showrectwidth: w height: h </span><span style="font: 10pt serif">[EL next &larr; 0376; nextword &larr; w; nextword &larr; h]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">skipchars: n </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">n=0⇒ []<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">n ≥ 1 and⦂ n ≤ 32⇒ ["</span><span style="font: italic 10pt serif">short form</span><span style="font: 10pt serif">" EL next  &larr; 040 + n-1]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">EL next &larr; 0361; next &larr; n]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">skipcontrol: n </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"immediate"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">EL next &larr; 0353; next &larr; n.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"now put n bytes in EL"]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">skipcontrol: n type: t </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"n bytes have been put in DL"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">EL next &larr; 0362; nextword &larr; n; next &larr; t]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">space </span><span style="font: 10pt serif">[EL next &larr; 0367]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Bitmaps/Dots</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">AIS: file width: w height: h croprect: r at: pt scale: s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self setp: (self transpt: pt); dots⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self setcoding: 8 "byte samples" dots: w lines: h;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">setmode: 3 "to right and to bottom of page";<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">setsizewidth: (s*r width*scale) asInteger height: (s*r height*scale) asInteger;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">setwindowwidth: r width height: r height skipdots: r minX skiplines: r minY;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">dotsfromAIS: file]]<br>"<br>(dp0 pressfile: &rsquo;pix.press&rsquo;) somefont; AIS: &rsquo;girl.ais&rsquo; width: 512 height: 512 croprect: (50⌾50 rect: 500⌾500) at: 36⌾80 scale: 0.65; close.<br>"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">bitmap: rect bits: bits </span><span style="font: 10pt serif">| w w16 h</span><span style="font: italic 10pt serif"> </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">some pecularities of spruce:<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">scale must be 32, and multiples of 16 for width (maybe extra stuff prints)</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">w &larr; rect width.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">w16 &larr; w + 15 | 16 "</span><span style="font: italic 10pt serif">width to next word boundary</span><span style="font: 10pt serif">".<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">h &larr; rect height.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">origin should be set earlier</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self dots⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self setcoding: 0 "</span><span style="font: italic 10pt serif">bitmap</span><span style="font: 10pt serif">" dots: w16 lines: h;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">setmode: 3 "</span><span style="font: italic 10pt serif">to right and to bottom of page</span><span style="font: 10pt serif">";<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">setsizewidth: scale * w16 height: scale * h;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">setwindowwidth: [ColorPrint⇒ [w] w16] height: h;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">dotsfollow.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">bits⇒["</span><span style="font: italic 10pt serif">bits supplied</span><span style="font: 10pt serif">" DL append: bits]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">else from screen</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">rect bitsOntoStream: DL]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dots⦂ exp </span><span style="font: 10pt serif">| dlpos [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dlpos &larr; self padword.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">exp eval.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self showdots: DL wordposition - dlpos]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dotsfollow </span><span style="font: 10pt serif">[DL nextword &larr; 3]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dotsfromAIS: file </span><span style="font: 10pt serif">| f<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[f&larr;file length inString+file+[file length even⇒[&rsquo; &rsquo;]&rsquo;&rsquo;]. "BCPLize"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DL nextword &larr; 4; nextword &larr; 4; append: f. FL append: f]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">setcoding: c dots: d lines: l </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DL next &larr; 1; next &larr; c;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextword &larr; d; nextword &larr; l]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">setmode: m </span><span style="font: 10pt serif">[DL next &larr; 2; next &larr; m]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">setsizewidth: w height: h </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DL nextword &larr; 2; nextword &larr; w; nextword &larr; h]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">setwindowwidth: w height: h </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self setwindowwidth: w height: h skipdots: 0 skiplines: 0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">setwindowwidth: w height: h skipdots: sd skiplines: sl<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[DL nextword &larr; 1;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextword &larr; sd; nextword &larr; w;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextword &larr; sl; nextword &larr; h]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Lines/Objects</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">drawcurve: v </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">v length ≠ 12⇒ [user notify: &rsquo;illegal drawcurve&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DL nextword &larr; 2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ v from: v do⦂ [DL nextword &larr; v]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">drawdiscat: pt radius: radius | dx dy i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[radius ≤ 16 ⇒ []<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> dx &larr; ↪(5 4 3 1 ¬1 ¬3 ¬4 ¬5 ¬5 ¬4 ¬3 ¬1 1 3 4 5).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> dy &larr; ↪(1 3 4 5 5 4 3 1 ¬1 ¬3 ¬4 ¬5 ¬5 ¬4 ¬3 ¬1).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self showobject⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self moveto: pt + ((dx◦16*radius/5) ⌾ (dy◦16*radius/5)).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> </span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: 16 do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self drawto: pt + ((dx◦i*radius/5) ⌾ (dy◦i*radius/5))]]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">drawlinefrom: p1 to: p2 width: width | d length t1 t2<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[(d &larr; p2-p1) = (0⌾0) ⇒ []<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">d x&larr; d x asFloat. d y&larr; d y asFloat. width &larr; width asFloat.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">length &larr; ((d x*d x)+(d y*d y)) sqrt.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">d x&larr; (d x*width/length) asInteger.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">d y&larr; (d y*width/length) asInteger.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">t1 &larr; d y ⌾ (0 - d x).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">t2 &larr; 0 - d y ⌾ d x.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self showobject⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self moveto: p1 + t1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self drawto: p2 + t1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self drawto:  p2 + t2.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self drawto:  p1 + t2.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self drawto:  p1 + t1]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self drawdiscat: p2 radius: width]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">drawlinefromscreen: p1 to: p2 width: width<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self drawlinefrom: (self transpt: p1) to: (self transpt: p2) width: (width*scale)] </span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">drawto: p </span><span style="font: 10pt serif">[DL nextword &larr; 1; nextPoint &larr; p]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">moveto: p </span><span style="font: 10pt serif">[DL nextword &larr; 0; nextPoint &larr; p]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">object⦂ expr atScreen: p <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self showobject⦂ [self objectGotoScreen: p pen: 0. expr eval]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">objectGotoScreen: p pen: pen </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DL nextword&larr; pen; nextPoint &larr; (self transpt: p)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">showobject⦂ exp </span><span style="font: 10pt serif">| p [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">p &larr; self padword.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"expression containing moveto, drawto, drawcurve"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">exp eval.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">EL next &larr; 0373; nextword &larr; DL wordposition - p]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Private</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">append: x<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑DL append: x]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">Bcpl: s pad: n </span><span style="font: 10pt serif">| slen [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">write a Bcpl string and padding to fill n bytes (used by close)</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">slen &larr; s length min: n-1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DL next &larr; slen; append: s◦(1 to: slen); next: n-(slen+1) &larr; 0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit </span><span style="font: 10pt serif">| a p ["PressFile classInit."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Smalltalk declare: ↪PressScale as: 32.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">recordsize &larr; 512.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">SMentity &larr; 5.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">a &larr; (String new: 250) asStream.<br>"from [Maxc1]&lt;Altodocs&gt;NetTopology.Press, October 1980. in order of net number"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">printers &larr; ↪(<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"net #"</span><span class="tab" val="79"></span><span style="font: 10pt serif">"printer names"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">" 1"</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;Navajo&rsquo;</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"HENRIETTA"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">" 3"</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;Menlo&rsquo; &rsquo;Clover&rsquo; &rsquo;Lilac&rsquo; "PARC: BLDG 35, FLOOR 2"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">" 5"</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;Kanji&rsquo;</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"PARC:  BLDG 34"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">" 6"</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;Wonder&rsquo; &rsquo;Quake&rsquo;</span><span class="tab" val="79"></span><span style="font: 10pt serif">"PARC: BLDG 35, FLOOR 1&3"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"10"</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;Puff&rsquo;</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"A&E"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"12"</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;White&rsquo; &rsquo;Colorado&rsquo;</span><span class="tab" val="79"></span><span style="font: 10pt serif">"PASADENA"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"14"</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;Niagara&rsquo; &rsquo;Tioga&rsquo;</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"WEBSTER"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"20"</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;Yoda&rsquo;</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"PARC: BLDG 32"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"21"</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;Lily&rsquo; </span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"SPG"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"23"</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;Ranger&rsquo;</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"DALLAS"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"26"</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;Windfall&rsquo;</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"DC"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"27"</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;Genesee&rsquo;</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"WEBSTER"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"33"</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;Amarok&rsquo;</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"TORONTO"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"34"</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;Yankee&rsquo;</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"STAMFORD"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"36"</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;Cyclops&rsquo;</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"LEESBURG"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"54"</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;Rover&rsquo;</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"A&E"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"55"</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;SPGEng&rsquo; &rsquo;Emperor&rsquo;</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"A&E"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"56"</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;Thud&rsquo;</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"A&E"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"60"</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;Adelie&rsquo; &rsquo;Daisy&rsquo; &rsquo;RockHopper&rsquo; </span><span class="tab" val="79"></span><span style="font: 10pt serif">"BAYHILL"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"62"</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;Bud&rsquo;</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"?"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ p from: printers do⦂ [a append: p; cr].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">a append: &rsquo;same printer&rsquo;; cr; append: &rsquo;no printer&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">printerMenu &larr; Menu new string: a contents]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">closeEntity </span><span style="font: 10pt serif">[self closeEntity: SMentity]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">closeEntity: etype </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">EL wordposition = ELstart⇒ []<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Put a trailer into the EL"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">EL</span><span class="tab" val="79"></span><span style="font: 10pt serif">padNext &larr; 0377;</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"word-pad EL with &lt;Nop&gt;"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">next &larr; etype;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">next&larr; 0; </span><span style="font: italic 10pt serif">"fontset"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"dlstart relative to DL location in file"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextNumber: 4 &larr; DLstart - (Pstart*recordsize);<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextNumber: 4 &larr; DL position - DLstart;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextPoint&larr; eorigin; </span><span style="font: italic 10pt serif">"entity origin"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextPoint&larr; boundbox origin;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextPoint&larr; boundbox extent.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">EL nextword &larr; EL wordposition - ELstart + 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self startEntity]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">closePage </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self closeEntity.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">EL empty⇒ []<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DL</span><span class="tab" val="79"></span><span style="font: 10pt serif">padNext &larr; 0;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextword &larr; 0;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">append: EL asReadStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self part: 0 start: Pstart]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">data </span><span style="font: 10pt serif">["slightly dangerous" ⇑DL]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">padpage </span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">words of padding to end of page</span><span style="font: 10pt serif">" ⇑(DL pad: recordsize with: 0) / 2]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">padword </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"make object (lines or dots) start on word boundary"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[DL padNext &larr; 0⇒ [self skipchars: 1]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑DL wordposition]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">part⦂ exp code: c </span><span style="font: 10pt serif">| fp [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self closePage.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fp &larr; self recordnum.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">exp eval.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self part: c start: fp]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">part: type start: start </span><span style="font: 10pt serif">| padding</span><span style="font: bold 10pt serif"> </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">padding &larr; self padpage.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">parts nextword &larr; type;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextword &larr; start;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextword &larr; self recordnum - start;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextword &larr; padding.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self startPage]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">recordnum </span><span style="font: 10pt serif">[⇑DL positionSize: recordsize]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">skipcode: code data: s </span><span style="font: 10pt serif">| t [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">called by </span><span style="font: bold 10pt serif">hidePress:complete:</span><span style="font: italic 10pt serif">. s is a String</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(t &larr; s length+1) &lt; 256⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">immediate, in EL</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self skipcontrol: t.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">EL next &larr; code; append: s]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">in DL</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DL next &larr; code; append: s.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self skipcontrol: t type: SMentity]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">startEntity </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DLstart &larr; DL position.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ELstart &larr; EL wordposition.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">boundbox &larr; 0 asRectangle.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">eorigin &larr; 0⌾0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">estate all &larr; ¬1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">estate◦1 &larr; 0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">startPage </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">EL reset.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Pstart &larr; self recordnum.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self startEntity]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Reading</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">filin </span><span style="font: 10pt serif">| p [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self open.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ (p &larr; self nextParagraph) do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">FilinSource &larr; self.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user print: nilⓢ p text; space].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">FilinSource &larr; nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self close]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">nextControl </span><span style="font: 10pt serif">| command t entity [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">return the next skip-control information</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">command &larr; nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ true do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(estate and⦂ command)≡false⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">either or both false. get next entity</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">t &larr; EL next⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">estate &larr; EL next viewer. command &larr; nil.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">t◦1 ≠ SMentity⇒ ["ignore this entity" estate &larr; false]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">DLstart &larr; (t◦(3 to: 6)) asStream nextNumber: 4.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">DL position &larr; Pstart*recordsize + DLstart]<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">no more entities on current part (page)</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self readPart⇒ []<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">no more pages</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">entity &larr; estate.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ (command &larr; entity next) do⦂ [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">some stuff arranged by probable frequency</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">command<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">&lt; 0100⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: bold 10pt serif">show-characters-short</span><span style="font: 10pt serif"> (0-037)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 10pt serif">skip-characters-short</span><span style="font: 10pt serif"> (040-077)"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">DL skip: (command land: 037) +1];<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">= 0356⇒ ["</span><span style="font: bold 10pt serif">set-x"</span><span style="font: 10pt serif"> entity nextword];<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">= 0357⇒ ["</span><span style="font: bold 10pt serif">set-y</span><span style="font: 10pt serif">" entity nextword];<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">&lt; 0140⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: bold 10pt serif">show-characters-and-skip</span><span style="font: 10pt serif"> (0100-0137)"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">DL skip: (command land: 037) +2];<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">&lt; 0160⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: bold 10pt serif">set-space-x-short</span><span style="font: 10pt serif"> (0140-0147)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 10pt serif">set-space-y-short</span><span style="font: 10pt serif">  (0150-0157)"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"(command land: 7)*256 +" entity next];<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">&lt; 0200⇒ ["</span><span style="font: bold 10pt serif">font</span><span style="font: 10pt serif">" "command land: 017"];<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">= 0362⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: bold 10pt serif">skip-control-bytes</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">t &larr; entity nextword.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">entity next≠SMentity⇒ ["ignore" DL skip: t]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑DL next: t];<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">= 0360⇒ ["</span><span style="font: bold 10pt serif">show-characters</span><span style="font: 10pt serif">" DL skip: entity next];<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">= 0377⇒ ["</span><span style="font: bold 10pt serif">nop</span><span style="font: 10pt serif">"];<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">&lt; 0353⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: bold 10pt serif">available</span><span style="font: 10pt serif"> (0200-0237)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 10pt serif">spare</span><span style="font: 10pt serif"> (0240-0352)"];<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">= 0353⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: bold 10pt serif">skip-control-bytes-immediate</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑entity next: entity next];<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">= 0354⇒ ["</span><span style="font: bold 10pt serif">alternative</span><span style="font: 10pt serif">" entity skipwords: 5];<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">= 0355⇒ ["</span><span style="font: bold 10pt serif">only-on-copy</span><span style="font: 10pt serif">" entity next];<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">= 0361⇒ ["</span><span style="font: bold 10pt serif">skip characters</span><span style="font: 10pt serif">" DL skip: entity next];<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">= 0363⇒ ["</span><span style="font: bold 10pt serif">show-character-immediate</span><span style="font: 10pt serif">" entity next];<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">&lt; 0366⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: bold 10pt serif">set-space-x</span><span style="font: 10pt serif"> (0364)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 10pt serif">set-space-y</span><span style="font: 10pt serif"> (0365)" entity nextword];<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">&lt; 0370⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: bold 10pt serif">reset-space</span><span style="font: 10pt serif"> (0366)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 10pt serif">space</span><span style="font: 10pt serif"> (0367)" ];<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">&lt; 0373⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: bold 10pt serif">set-brightness</span><span style="font: 10pt serif"> (0370)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 10pt serif">set-hue</span><span style="font: 10pt serif"> (0371)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 10pt serif">set-saturation</span><span style="font: 10pt serif"> (0372)" entity next];<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">= 0373⇒ ["</span><span style="font: bold 10pt serif">show-object</span><span style="font: 10pt serif">" DL skipwords: entity nextword];<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">&lt; 0376⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: bold 10pt serif">show-dots</span><span style="font: 10pt serif"> (0374)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 10pt serif">show-dots-opaque</span><span style="font: 10pt serif"> (0375)"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">DL skipwords: (entity nextNumber: 4)];<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">= 0376⇒ ["</span><span style="font: bold 10pt serif">show-rectangle</span><span style="font: 10pt serif">" entity skipwords: 2]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">nextParagraph </span><span style="font: 10pt serif">| s p [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s &larr; self nextControl⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s &larr; s asStream.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">p &larr; Paragraph new.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s next = p pressCode⇒ [⇑p fromPress: self value: s]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">open </span><span style="font: 10pt serif">| t [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">read the parts (and font directory?)</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DL readonly; "reopen?" settoend; skip: 0 - recordsize.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DL nextword = 27183 and⦂ DL nextword = (self recordnum + 1)⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">t &larr; DL nextword.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">DL position: DL nextword size: recordsize.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">parts &larr; (DL next: t*8) viewer.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self readPart]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self error: &rsquo;not a press file&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">readPart </span><span style="font: 10pt serif">| t [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">read parts until we find a printed page or end</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">estate &larr; false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ (t &larr; parts nextword) do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">Pstart &larr; parts nextword.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">t ≠ 0⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">not a printed page</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">parts skip: 4.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">t&gt; 0⇒ ["font or other part"]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">a non-standard part. let document (estate?) interpret</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"DL position &larr; Pstart*recordsize.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">estate fromPress: self name: t value: DL"]<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">go to end of last record of entity list, ignoring padding</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">t &larr; parts nextword "</span><span style="font: italic 10pt serif">length</span><span style="font: 10pt serif">".<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">DL position &larr; Pstart+t * recordsize - ((1 + parts nextword) * 2).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">EL &larr; Set new vector: 50.<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">scan backwards for beginning of entity list, reading entities</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ (t &larr; DL nextword) &gt; 0 do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">t &lt; 12⇒ [user notify: &rsquo;illegal entity&rsquo;]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">DL skipwords: 0-t.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">read entity and trailer (last 12 words of entity)</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">EL next &larr; DL next: t-12 *2.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">EL next &larr; DL next: 24.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">DL skipwords: ¬1 - t].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">now reverse:  trailer, entity (1st), ... (last)</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑EL &larr; (EL asArray◦(EL length to: 1 by: ¬1)) asStream]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪PressFile under: &rsquo;Press File Support&rsquo;.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">PressFile classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"WidthTable"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;WidthTable&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;name "&lt;String&gt; name of font family"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">pointsize "&lt;Integer&gt; size in points"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">face "&lt;Integer&gt; Press face code"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">min "&lt;Integer&gt; min character code in font"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">max "&lt;integer&gt; max character code in font"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">"Ascent, descent, and width are in micas"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">ascent "&lt;Integer&gt; max ascent of characters in font"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">descent "&lt;Integer&gt; NEGATIVE max descent of characters in font"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">widths "&lt;Vector of Integers&gt; widths of characters"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;tab WidthDict &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>Holds font parameters and width table for a Press font.  It knows how to load itself from FONTS.WIDTHS.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[WidthDict &larr; Dictionary init.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tab &larr; 500]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">lookup </span><span style="font: 10pt serif">| key font i [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">key &larr; name + pointsize asString + (↪(&rsquo;&rsquo; &rsquo;I&rsquo; &rsquo;B&rsquo; &rsquo;BI&rsquo;)◦(face+1)).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">font &larr; WidthDict lookup: key⇒ [⇑font]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self fontfrom: (dp0 oldFile: &rsquo;Fonts.Widths&rsquo;) readonly.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: ↪(011 015 040) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[i ≥ min and⦂ i ≤ max ⇒ [widths◦(i-min+1) &larr; 0]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">WidthDict insert: key with: self.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">named: name pointsize: pointsize face: face</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Access</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">ascent </span><span style="font: 10pt serif">[⇑ascent]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">descent </span><span style="font: 10pt serif">[⇑descent]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">face </span><span style="font: 10pt serif">[⇑face]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">max </span><span style="font: 10pt serif">[⇑max]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">min </span><span style="font: 10pt serif">[⇑min]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">name </span><span style="font: 10pt serif">[⇑name]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pointsize </span><span style="font: 10pt serif">[⇑pointsize]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">scan: strm until: width exceeds: maxw </span><span style="font: 10pt serif">| char w [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ (char &larr; strm next) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[char &lt; min ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[char=040 or⦂ (char=015 or⦂ char=011) ⇒ [⇑char, width]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: &rsquo;char too low&rsquo;]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">char &gt; max ⇒ [user notify: &rsquo;char too high&rsquo;]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(w &larr; widths◦(char+1-min)) = 0 ⇒ [⇑char, width]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(width &larr; width + w) &gt; maxw ⇒ [⇑true, width]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false, width]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">space </span><span style="font: 10pt serif">[⇑150]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">tab </span><span style="font: 10pt serif">[⇑tab]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">tab &larr; t </span><span style="font: 10pt serif">[tab &larr; t]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Reading FONTS.WIDTHS</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">findfield: n on: file </span><span style="font: 10pt serif">| IXH [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">IXH &larr; file nextword.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(IXH bits: (0 to: 3)) "type"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">= 0 ⇒ [user notify: &rsquo;field not found&rsquo;];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">≠ n]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[file skipwords: (IXH land: 07777 "length") - 1]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fontfrom: file </span><span style="font: 10pt serif">| i code fam fmin fmax start len found w scale<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"find code for font family"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">file reset. fam &larr; &rsquo;&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ (fam = name) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self findfield: 1 on: file.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">code &larr; file nextword.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">fam &larr; file next: (len &larr; file next).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">file skip: 19 - len].<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"now search for proper face"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">found &larr; false.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Convert from points to micas"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">scale &larr; (pointsize asFloat * 2540 / 72) asInteger.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ found do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self findfield: 4 on: file.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">found &larr; [file next = code].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[file next ≠ face ⇒ [found &larr; false]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">fmin &larr; file next.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">fmax &larr; file next.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; file nextword. [i ≠ scale and: i ≠ 0 ⇒ [found &larr; false]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">file skip: 4. start &larr; file nextword. file skip: 4].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">scale &larr; [i ≠ 0 ⇒ [1 </span><span style="font: italic 10pt serif">"don&rsquo;t need to scale"</span><span style="font: 10pt serif">] pointsize asFloat * 254 / 7200].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">min &larr; fmin. max &larr; fmax.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"get bb and x-tables"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">file wordposition&larr; start+1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">descent &larr; 0 - (scale * file nextword) asInteger.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">file nextword.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ascent &larr; (scale * file nextword) asInteger.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">file nextword.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">widths &larr; Vector new: (max - min + 1).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: widths length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[w &larr; file nextword.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">widths◦i &larr; [w &gt; 0 ⇒ [(scale * w) asInteger] 0]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">file close]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪WidthTable under: &rsquo;Press File Support&rsquo;.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">WidthTable classInit</span></div>
    <div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">&rsquo;From Smalltalk 5.5k XM November 24 on 22 November 1980 at 2:57:08 am.&rsquo;<br></span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">"Decompiler"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;Decompiler&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;method temps instvars literals stack isReference literalNames&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;breakPC highlight &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sharing: ByteCodes;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>This class has not yet been commented</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">decompile: sel class: class </span><span style="font: 10pt serif">| strm block ignore p<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[method &larr; class method: sel.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">method length&lt;8⇒[⇑self quickCode: sel class: class]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self initSymbols: class.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">stack &larr; (Vector new: (method◦3)-(method◦5)) asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">block &larr; self block: method◦6+1 to: method length<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pc⦂ ignore hasValue⦂ ignore.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">stack empty≡false⇒[user notify: &rsquo;stack not empty&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self convertMacros: block sel: sel.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm &larr; Stream default.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self printPattern: sel on: strm.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm crtab: 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">block printon: strm indent: 1 precedence: 0 forValue: false decompiler: self.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(p&larr;method word: 1)≠0⇒[strm append: &rsquo; primitive: &rsquo;; print: p]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑strm contents asParagraph makeBoldPattern]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">findPC: x </span><span style="font: 10pt serif">[breakPC&larr; x. highlight&larr; 1 to: 1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">highlight </span><span style="font: 10pt serif">[⇑highlight]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">highlight: x </span><span style="font: 10pt serif">[⇑highlight&larr; x]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Symbols</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">initSymbols: class </span><span style="font: 10pt serif">| i lit env<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">Init temps with made-up names</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">temps &larr; Vector new: method◦5.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: temps length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[temps◦i &larr; &rsquo;t&rsquo; + i asString].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">instvars &larr; class instvars.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">literals &larr; MessageDict new literalsIn: method.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">literalNames &larr; Vector new: literals length.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">env &larr; class wholeEnvironment, Smalltalk, Undeclared.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: literals length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[lit &larr; literals◦i.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">literalNames◦i &larr;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[lit is: UniqueString⇒[lit]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">lit is: ObjectReference⇒[self invertRef: lit environment: env]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">lit≡FieldReference⇒[&rsquo;&rsquo;]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">lit asString]]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">instvar: i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑instvars◦(i-codeLoadField+1)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">invertRef: ref environment: env </span><span style="font: 10pt serif">| table n<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ table from: env do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[n&larr;table invertRef: ref⇒[⇑n]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑&rsquo;unknown&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">literal: i </span><span style="font: 10pt serif">| index lit str<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[index &larr; i-codeLoadLit+1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">lit &larr; literals◦index.  str &larr; literalNames◦index.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">lit is: ObjectReference⇒[⇑str]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(lit is: UniqueString) or⦂ (lit is: Vector)⇒[⇑&rsquo;↪&rsquo; + str]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑str]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">literalIndirect: i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑literalNames◦(i-codeLoadLitInd+1)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">selector: i <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[i&gt;166 and⦂ i&lt;208⇒[⇑SpecialOops◦(i-166)]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑literalNames◦(i-codeSendLit+1)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">temp: i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑temps◦(i-codeLoadTemp+1)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Byte Interpretation</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">block: start to: end pc⦂ pc hasValue⦂ v<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| block code byte j stackPos t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["Decompile the method from start to end into a ParsedBlock and return the<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">instance of ParsedBlock.  Assign to pc the value of the pc after leaving<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">the block.  If at run time this block will leave a value on the stack,<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">set hasValue to true."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">block &larr; ParsedBlock default. pc value&larr; end+1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">stackPos &larr; stack position.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">code &larr; Stream new of: method from: start to: end.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ byte from: code do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[byte&lt;0200⇒[self loadByte: byte code: code]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">byte&lt;0210⇒[self controlByte: byte code: code block: block]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">byte&lt;0214⇒[self loadByte: byte code: code  "extended loads"]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">byte=0214⇒[self selectorByte: byte code: code at: code position  "extended selector"]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">byte&lt;0260⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[j&larr;self jumpByte: byte code: code block: block.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">code end⇒[pc value&larr;j]]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self selectorByte: byte code: code at: code position]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"If there is an additional item on the stack, it will be the value<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">of this block"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">stack position&gt;stackPos⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t&larr;stack pop.  v value&larr;true.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">block empty and⦂ (t is: ParsedBlock)⇒[⇑t]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">block next&larr; t.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑block]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">v value&larr;false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[block empty⇒[block next&larr; nil]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"pretend that returns jump to end of method"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[block returns or⦂ (block◦block position) returns⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pc value&larr; method length+1]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑block]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">checkForRemoteCode: jump code: code block: block </span><span style="font: 10pt serif">| m ignore t j b<br>"</span><span style="font: italic 10pt serif">Check if this is a jump around remote code.</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[jump&gt;code limit⇒[⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">remote code should terminate with a </span><span style="font: italic 10pt serif; text-decoration: underline">toEnd</span><span style="font: italic 10pt serif">, and then a jump back</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">method◦(jump-3)≠toEnd⇒[⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">t &larr; method◦(jump-2).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">t&lt;0240 or⦂ t&gt;0243⇒[⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">j &larr; t-0244*256+(method◦(jump-1)).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">jump+j ≠ (code position+1) ⇒[⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">m &larr; stack pop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">((m isnt: ParsedMessage) or⦂ m rcvr≡toLoadThisCtxt≡false) or⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(self selector: m op)≠↪remoteCopy⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[stack next&larr; m.  ⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">it&rsquo;s a piece of remote code</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">b &larr; self block: code position+1 to: jump-4<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pc⦂ ignore hasValue⦂ ignore.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">stack next&larr; ParsedRemote new expr: b.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">code position&larr; jump-1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">conditionalJump: elseStart code: code block: block<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| cond ifExpr thenExpr elseExpr thenJump elseJump ignore newBlock<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">hasValue last<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ifExpr &larr; stack pop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">thenExpr &larr; self block: code position+1 to: elseStart-1<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pc⦂ thenJump hasValue⦂ hasValue.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">ensure jump is within block (in case thenExpr returns)</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">thenJump &larr; thenJump min: code limit+1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">if jump goes back, then it&rsquo;s a loop</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">thenJump&lt;elseStart⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self loop: thenJump whileExpr: ifExpr doExpr: thenExpr<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">code: code block: block doSize: elseStart-code position-1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">code position&larr; elseStart-1]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">elseExpr &larr; self block: elseStart to: thenJump-1<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pc⦂ elseJump hasValue⦂ ignore.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">if </span><span style="font: italic 10pt serif; text-decoration: underline">elseJump</span><span style="font: italic 10pt serif"> is backwards, it is not part of the elseExpr</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[elseJump&lt;code position⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[code position&larr; thenJump-3.  last&larr;true] <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">code position&larr; thenJump-1].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[thenJump+1=code limit  "</span><span style="font: italic 10pt serif">still might be last</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">and⦂ (method◦thenJump≥0240 and⦂ method◦thenJump≤0247)⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[last&larr;true]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[thenJump=code limit<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">and⦂ (method◦thenJump≥0220 and⦂ method◦thenJump≤0227)⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[last&larr;true]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">check for and⦂ or or⦂</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">hasValue and⦂ (thenExpr position=1 and⦂ thenExpr◦1≡toLoadTrue)⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[stack next&larr; ParsedDisjunct new left: ifExpr right:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[elseExpr position=1⇒[elseExpr◦1] elseExpr] ]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">hasValue and⦂ (elseExpr position=1 and⦂ elseExpr◦1≡toLoadFalse)⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[stack next&larr; ParsedConjunct new left: ifExpr right:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[thenExpr position=1⇒[thenExpr◦1] thenExpr] ]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">it&rsquo;s an if statement</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">cond &larr; ParsedConditional new<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">ifExpr: ifExpr thenExpr: thenExpr elseExpr: elseExpr.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">If the then part has a value, put the conditional in a block, and put the<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">block on the stack.  (If the compiler is working right the else part will<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">leave a value, too ... this is not checked).</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">hasValue⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[newBlock&larr;ParsedBlock default.  newBlock next&larr; cond.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">stack next&larr; newBlock]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">If the thenExpr jumps to the end of the current block,<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">or to a jump backwards at the end of the current block,<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">or to a ⇑self at the end of the method,<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">append the cond<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">to the current block.  Otherwise, embed it in a new block.</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(code end or⦂ last≡true) or⦂<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(thenJump+1=method length and⦂ method◦thenJump=toLoadSelf)⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[block next&larr; cond]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">newBlock&larr;ParsedBlock default.  newBlock next&larr; cond.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">block next&larr; newBlock]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">controlByte: byte code: code block: block </span><span style="font: 10pt serif">| var t strm<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[byte=toSmashPop⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[var &larr; self makeLoad: code next code: code.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">block next&larr; ParsedAssignment new var: var expr: stack pop]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">byte=toSmash⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">smash no pop at the end of a block will require the next byte<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">to be fetched from after the limit of the block</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">code end⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strm &larr; Stream new of: method from: code limit+1 to: method length.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">var &larr; self makeLoad: strm next code: strm.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">block next&larr; ParsedAssignment new var: var expr: stack pop]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">var &larr; self makeLoad: code next code: code.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">block next&larr; ParsedAssignment new var: var expr: stack pop.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">uncascade assignment statements</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">stack next&larr; var]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">byte=toPop⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[block next&larr; stack pop]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">byte=toReturn⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t &larr; stack pop.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">stack empty≡false⇒[user notify: &rsquo;stack not empty&rsquo;]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">elide final ⇑self</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">t≡toLoadSelf and⦂ code position=method length⇒[]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">block doesReturn.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">block next&larr; t]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">byte=toEnd⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user notify: &rsquo;unexpected&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">byte=toLoadThisCtxt⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[stack next&larr; byte]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">byte=toSuper⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[stack pop.  "</span><span style="font: italic 10pt serif">delete ref to self</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">stack next&larr; byte]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: &rsquo;unknown control byte&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">jumpByte: byte code: code block: block </span><span style="font: 10pt serif">| offset j<br>"</span><span style="font: italic 10pt serif">If this is an unconditional jump, return the position in the method to which it jumps.  If this is a conditional jump forward, parse a conditional statement.  Conditional jumps backward are not produced by the current compiler.</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[byte&lt;0230⇒["</span><span style="font: italic 10pt serif">short unconditional jump forward</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑byte-0220+code position+2]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">byte&lt;0240⇒["</span><span style="font: italic 10pt serif">short conditional jump forward</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self conditionalJump: byte-0230+code position+2 code: code block: block.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑code position+1]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">byte&lt;0250⇒["</span><span style="font: italic 10pt serif">long unconditional jump</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">offset &larr;  code next.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">j &larr; byte-0244*256+offset+code position+1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self checkForRemoteCode: j code: code block: block.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑j]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">byte&lt;0254⇒[code skip: 1.  "long conditional jump backward"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: &rsquo;conditional jump backward not expected&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">byte&lt;0260⇒["</span><span style="font: italic 10pt serif">long conditional jump forward</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">offset &larr; code next.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self conditionalJump: byte-0254*256+offset+code position+1<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">code: code block: block.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑code position+1]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: &rsquo;not a jump byte&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">loadByte: byte code: code </span><span style="font: 10pt serif">| t lit<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t &larr; self makeLoad: byte code: code.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">t≥codeLoadLit and⦂ t&lt;codeLoadLitInd⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[lit &larr; literals◦(t-codeLoadLit+1).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">lit≡FieldReference⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self remoteReference: code]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">lit is: ObjectReference⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[stack next&larr; ParsedObjectReference new var: t]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">stack next&larr; t]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">stack next&larr; t]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">loop: jumpBack whileExpr: whileExpr doExpr: doExpr code: code block: block<br>doSize: doSize<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| n b ignore<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">jumpBack will jump to the beginning of whileExpr.  In the case of for statements or while&rsquo;s with a block in the condition, the whileExpr should include more than just the last expression.  Kludge: find all the statements needed by re-decompiling.</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">n &larr; code position-doSize jmpSize.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">b &larr; self block: jumpBack to: n pc⦂ ignore hasValue⦂ ignore.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">discard unwanted statements from block</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">block skip: 1-b position.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">block next&larr; ParsedLoop new <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">whileExpr: [b position=1⇒[whileExpr] b] doExpr: doExpr]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">makeLoad: byte code: code </span><span style="font: 10pt serif">| offset<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">check for extended loads</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">byte≥0210 and⦂ byte≤0213⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">extended reference codes:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">0210 - extended inst<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">0211 - extended temp<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">0212 - extended literal<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">0213 - extended literal indirect"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">offset&larr;256*(byte-0207).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑code next+offset]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ⇑byte asCompilerCode]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">remoteReference: code </span><span style="font: 10pt serif">| i obj offset var<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[i &larr; stack pop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">offset &larr; [i≤124⇒[↪(0 1 2 10)◦(i-120)] literals◦(i-codeLoadLit+1)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">obj &larr; stack pop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">code skip: 2.  "</span><span style="font: italic 10pt serif">skip </span><span style="font: italic 10pt serif; text-decoration: underline">new</span><span style="font: italic 10pt serif"> </span><span style="font: italic 10pt serif; text-decoration: underline">object:offset:</span><span style="font: italic 10pt serif"> </span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">var &larr; [obj=toLoadTempframe⇒[codeLoadTemp+offset-1]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">obj=toLoadSelf⇒[codeLoadField+offset-1]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: &rsquo;bad remote reference&rsquo;].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">stack next&larr; ParsedFieldReference new var: var]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">selectorByte: byte code: code at: p </span><span style="font: 10pt serif">| op sel i nArgs args rcvr<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["check for extended selector codes"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">op &larr; [byte=toSendLitLong⇒[code next+codeSendLit] byte asCompilerCode].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"find the corresponding selector and the number of args it expects"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sel &larr; self selector: op.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nArgs &larr; sel numArgs.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rcvr &larr; stack pop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[nArgs=0⇒[args&larr;false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> nArgs=1⇒[args&larr;stack pop]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> args &larr; Vector new: nArgs.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> for⦂ i from: nArgs to: 1 by: ¬1 do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[args◦i &larr; stack pop]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">stack next&larr; ParsedMessage new rcvr: rcvr op: op args: args.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">p=breakPC⇒[stack last hasPC]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Macros</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">convertMacros: block sel: sel </span><span style="font: 10pt serif">| macros compilerTemps vec loc i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">replace statement patterns with corresponding macros when possible</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">macros &larr; (Vector new: 10) asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">for each temp, compilerTemps is false if it is a user temp, true if it is a<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">compiler temp, and nil if not yet known</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">compilerTemps &larr; Vector new: temps length.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: sel numArgs do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[compilerTemps◦i &larr; false].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">block findMacros: macros compilerTemps: compilerTemps.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">insert macros in reverse order to keep indices from being messed up</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">vec &larr; macros contents.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: vec length-1 to: 1 by: ¬2 do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[vec◦i≡nil⇒[]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">vec◦i insertMacro: vec◦(i+1) decompiler: self].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">set names of compiler temps to empty string</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: temps length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[compilerTemps◦i≡true⇒[temps◦i &larr; &rsquo;&rsquo;]]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Printing</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printPattern: sel on: strm </span><span style="font: 10pt serif">| i n keywords<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[n&larr;sel numArgs.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[n=0⇒[strm append: sel; space  "</span><span style="font: italic 10pt serif">unary</span><span style="font: 10pt serif">"]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> keywords&larr;sel keywords.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> for⦂ i to: keywords length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strm append: keywords◦i; space; append: temps◦i; space]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">n=(method◦5)⇒[]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm append: &rsquo;| &rsquo;.   "</span><span style="font: italic 10pt serif">temps beyond args</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: n+1 to: method◦5 do⦂ [strm append: temps◦i; space]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">quickCode: sel class: class </span><span style="font: 10pt serif">| t strm<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[method length=2⇒[⇑sel asParagraph makeBoldPattern]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">method length=5⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t &larr; method◦5.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm &larr; Stream default.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm append: sel; append: &rsquo; [⇑&rsquo;; append: class instvars◦(t+1); append: &rsquo;]&rsquo;.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑strm contents asParagraph makeBoldPattern]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑&rsquo;undeciperable method&rsquo; asParagraph]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪Decompiler under: &rsquo;Compiler&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"Generator"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;Generator&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;literals nTemps maxTemp local environment parser supered root requestor sourceStream sourceParagraph&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sharing: ByteCodes;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I generate code parsed by parser.  The symbol tables I use are local and environment.  The run-time needs of the code are recorded in literals, nTemps, and maxTemp.  If a message was passed to super, then supered is true.  I remember my root context to abort in case of error.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Services</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">compile: sourceParagraph in: class under: category notifying: requestor </span><span style="font: 10pt serif">| selector<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user displayoffwhile⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[sourceStream &larr; sourceParagraph asStream.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">selector &larr; self compileIn: class⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[class organization classify: selector under: category]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑selector]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">evaluate: sourceStream in: context to: receiver notifying: requestor<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| method nvars value tframe<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[method &larr; user displayoffwhile⦂ [self evaluateIn: context to: receiver].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">root≡true≡false⇒ [⇑method] </span><span style="font: italic 10pt serif">"compilation failed, return false or corrected value"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nvars &larr; nTemps.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">context⇒ </span><span style="font: italic 10pt serif">"frame copy here because interpret loses control"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[tframe &larr; context tempframe◦(1 to: nvars) copyto: (Vector new: method◦3).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">value &larr; context interpret: method with: tframe.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">tframe◦(1 to: nvars) copyto: context tempframe.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑value]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑Context new have: receiver interpret: method]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Errors</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">abortWith: errorString </span><span style="font: 10pt serif">| mySender<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[WhatFlag⇒ [user notify: errorString]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">mySender &larr; thisContext swapSender: root sender.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">root sender &larr; nil. root &larr; nil. parser terminate.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">mySender release. mySender &larr; nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user restoredisplay.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑requestor notify: errorString at: sourceStream position in: sourceStream]<br></span><span style="font: italic 10pt serif">"Parser notify"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">notify: errorString<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[parser notify: errorString]<br></span><span style="font: italic 10pt serif">"ParsedObjectReference remote"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">terminate<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[root &larr; nil]<br></span><span style="font: italic 10pt serif">"Parser terminate"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Code generation</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">compileIn: class<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| block method nargs selector primitive<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[parser &larr; Parser new. root &larr; thisContext. parser from: sourceStream to: self.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self initSymbols: class.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">block &larr; ParsedBlock default.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">selector &larr; parser pattern: block. nargs &larr; nTemps.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">parser temporaries: block. primitive &larr; parser body: block.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">parser mustBeDone. parser &larr; nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">block mustReturn: true </span><span style="font: italic 10pt serif">"defaults to ⇑self"</span><span style="font: 10pt serif">.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[method &larr; [primitive=0 and⦂ nargs=0⇒ [block quickCode] false]⇒ []<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">method &larr; self generate: block in: class.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">method◦2 &larr; primitive; ◦4 &larr; nargs].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">class install: selector method: method literals: literals<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">code: [sourceParagraph is: Paragraph⇒ [sourceParagraph]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">sourceStream asArray] backpointers: nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[HuhFlag⇒ [Huh&larr;nil. Huh &larr; (self decompile: method onto: Stream default) contents. HuhFlag&larr;false]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑selector]<br></span><span style="font: italic 10pt serif">"compile"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">decompile: method onto: s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[method length&lt;6⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s append: &rsquo;Quick code: &rsquo;; append: method asBytes. ⇑s]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s print: method◦4; append: &rsquo; args; &rsquo;;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">print: method◦5; append: &rsquo; temps; &rsquo;;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">print: (method◦3) - (method◦5); append: &rsquo; stack; &rsquo;;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">print: (method◦6) -6 /2; append: &rsquo; literals; &rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(method◦2) &gt; 0⇒ [s append: &rsquo; primitive: &rsquo;; print: method◦2; append: &rsquo;;&rsquo;]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s print: method length; append: &rsquo; bytes total.&rsquo;; cr.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">method◦2 = 40⇒ [⇑s]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self decompileBytes: method onto: s]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">decompileBytes: method onto: s<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| dict x i c m t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[dict &larr; Dictionary new init: 64.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dict insertall: ((128 to: 131) copy, 125 concat: (144 to: 175) copy)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">with: ↪(<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;&larr;&uarr;&rsquo; &rsquo;&larr;&rsquo; &rsquo;&uarr;&rsquo; &rsquo;⇑&rsquo; &rsquo;end&rsquo;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;jmp1&rsquo; &rsquo;jmp2&rsquo; &rsquo;jmp3 &rsquo; &rsquo;jmp4&rsquo; &rsquo;jmp5&rsquo; &rsquo;jmp6&rsquo; &rsquo;jmp7&rsquo; &rsquo;jmp8&rsquo;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;bfp1&rsquo; &rsquo;bfp2&rsquo; &rsquo;bfp3 &rsquo; &rsquo;bfp4&rsquo; &rsquo;bfp5&rsquo; &rsquo;bfp6&rsquo; &rsquo;bfp7&rsquo; &rsquo;bfp8&rsquo;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;jmp&rsquo; &rsquo;jmp&rsquo; &rsquo;jmp&rsquo; &rsquo;jmp&rsquo; &rsquo;jmp&rsquo; &rsquo;jmp&rsquo; &rsquo;jmp&rsquo; &rsquo;jmp&rsquo;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;bfp&rsquo; &rsquo;bfp&rsquo; &rsquo;bfp&rsquo; &rsquo;bfp&rsquo; &rsquo;bfp&rsquo; &rsquo;bfp&rsquo; &rsquo;bfp&rsquo; &rsquo;bfp&rsquo;).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ x from: local contents do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[i&larr;local◦x. t &larr; i land: 255.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[i&gt;255 and⦂ t&lt;16⇒ [i&larr;((i lshift: ¬8)-1 lshift: 4) + t]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">dict insert: i with: x].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ x from: stdSelectors contents do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[dict insert: stdSelectors◦x with: [x is: Integer⇒ [x inString] x]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: 5 do⦂ [dict insert: toLoadConst+i-1 with: ↪(&rsquo;¬1&rsquo; &rsquo;0&rsquo; &rsquo;1&rsquo; &rsquo;2&rsquo; &rsquo;10&rsquo;)◦i].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ t from: (m &larr; (method◦(method◦6 +1 to: method length)) asStream) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[t≥toLoadFieldLong and⦂ t≤toSendLitLong⇒ [t&larr;((t-0207) lshift: 8)+ m next]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> [c &larr; dict lookup: t⇒ [s append: c] s append: &rsquo;#&rsquo;. s append: t base8].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> s space.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> t &lt; toLongJmp⇒ [] t ≥ 0260⇒ []<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> s print: t\8 -4 *256 + m next; space].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s cr.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑s]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">evaluateIn: context to: receiver<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| block method class nvars<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ </span><span style="font: italic 10pt serif">"If context is false, receiver will evaluate in top level"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">block &larr; ParsedBlock default.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">parser &larr; Parser new. root &larr; thisContext.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">parser from: sourceStream to: self.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[context⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self initSymbols: (class &larr; context mclass).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">context variableNamesInto: self with: ParsedBlock default.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nvars &larr; nTemps.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">root &larr; thisContext. </span><span style="font: italic 10pt serif">"because variableNamesInto nil&rsquo;ed it"</span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self initSymbols: (class &larr; receiver class)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">parser temporaries: block; statements: block; mustBeDone. parser &larr; nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">block mustReturn: false </span><span style="font: italic 10pt serif">"returns last value"</span><span style="font: 10pt serif">.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">method &larr; self generate: block in: class.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[HuhFlag⇒ [Huh&larr;nil. Huh &larr; (self decompile: method onto: Stream default) contents. HuhFlag&larr;false]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">root &larr; true. </span><span style="font: italic 10pt serif">"to signify success"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nTemps &larr; nvars.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑method]<br></span><span style="font: italic 10pt serif">"evaluate"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">generate: block in: class<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| header method code lit stack<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[(lit &larr; literals find: nil)&gt;0⇒ [literals &larr; (literals◦(1 to: lit-1)) copy]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[supered⇒ [literals &larr; literals, (Smalltalk ref: class title unique)]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">header &larr; 6 + (2* literals length).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">code &larr; (method &larr; String new: header + block sizeForValue) asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">code<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">next &larr; 0; next &larr; 0; next &larr; 0;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">next &larr; 0; next &larr; maxTemp; next &larr; header.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ lit from: literals do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[code next &larr; lit PTR lshift: ¬8; next &larr; lit PTR land: 0377].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">stack &larr; ParseStack init.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">block emitForValue: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[stack position≠1⇒ [user notify: &rsquo;Compiler stack discrepancy&rsquo;]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[code position≠method length⇒ [user notify: &rsquo;Compiler code size discrepancy&rsquo;]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">method◦3 &larr; maxTemp + stack length.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑method] </span><span style="font: italic 10pt serif">"compile|evaluate"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Parse tree</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">assignment: var expr: expr<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑ParsedAssignment new var: var expr: expr]<br></span><span style="font: italic 10pt serif">"Parser expression"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">block<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑ParsedBlock default]<br></span><span style="font: italic 10pt serif">"Parser primary|Parser alternatives"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">evalKeyword: arg<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑arg]<br></span><span style="font: italic 10pt serif">"Parser keywordMessage"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">ifExpr: ifExpr thenExpr: thenExpr elseExpr: elseExpr<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑ParsedConditional new ifExpr: ifExpr thenExpr: thenExpr elseExpr: elseExpr]<br></span><span style="font: italic 10pt serif">"ifthen...|Parser alternatives"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">keywordMessage: rcvr selector: sel args: args<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[sel=&rsquo;and⦂&rsquo;⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑ParsedConjunct new left: rcvr right: args local];<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">  = &rsquo;or⦂&rsquo;⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑ParsedDisjunct new left: rcvr right: args local]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self rcvr: rcvr selector: sel args: (args remote: self)]<br></span><span style="font: italic 10pt serif">"Parser keywordMessage"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">noEvalKeyword: arg<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑arg asRemoteCode: self]<br></span><span style="font: italic 10pt serif">"Parser keywordMessage"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">nullStatement: block<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[block next &larr; toLoadNil. ⇑block]<br></span><span style="font: italic 10pt serif">"ifthen|Parser statements"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">rcvr: rcvr selector: sel args: args<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[rcvr≡toSuper⇒ [supered&larr;true]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ParsedMessage new rcvr: rcvr op: (self encodeSel: sel) args: args]<br></span><span style="font: italic 10pt serif">"loop|keywordMessage|Parser binaryMessage|Parser unaryMessage"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">receivingVar: expr </span><span style="font: 10pt serif">| rcvr var </span><span style="font: italic 10pt serif">"who in expr is cascade recipient"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[rcvr &larr; expr emittedReceiver⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[var &larr; rcvr emittedVariable⇒ [⇑var]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">var &larr; self newTemp. </span><span style="font: italic 10pt serif">"if a non-variable, compute it just once"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">expr emittedReceiver &larr; ParsedAssignment new var: var expr: rcvr.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑var]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">parser notify: &rsquo;MAY ONLY FOLLOW A MESSAGE&rsquo;]<br></span><span style="font: italic 10pt serif">"Parser cascade"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">variable: name<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| var global ref unq<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[var &larr; local lookup: name⇒ [⇑var]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[unq &larr; name hasBeenUniqued⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ global from: environment do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ref &larr; global lookupRef: unq⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑codeLoadLitInd + (self litIndex: ref)]]]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">requestor interactive⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[parser notify: &rsquo;➲Smalltalk declare: ↪&rsquo; + name + &rsquo; as: nil➲TO DECLARE GLOBAL&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user show: &rsquo; (&rsquo; + name + &rsquo; is Undeclared) &rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">unq &larr; name unique.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Undeclared declare: unq.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑codeLoadLitInd + (self litIndex: (Undeclared ref: unq))]<br></span><span style="font: italic 10pt serif">"Parser expression|Parser primary"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Macros</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">for: var from: startMinus1 to: stop do: ritual on: block </span><span style="font: 10pt serif">| temp<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[temp &larr; self newTempForMacro.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"temp&larr;stop. var&larr;startMinus1. while⦂ temp≥(var &larr; 1+var) do⦂ ritual"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">block next &larr; ParsedAssignment new var: temp expr: stop;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">next &larr; ParsedAssignment new var: var expr: startMinus1;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">next &larr; ParsedLoop new<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">whileExpr:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(ParsedMessage new rcvr: temp op: toGeq args:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(ParsedAssignment new var: var<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">expr: (ParsedMessage new rcvr: toLoad1 op: toPlus args: var)))<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">doExpr: ritual]<br></span><span style="font: italic 10pt serif">"for...todoargs"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">forfromdo: block args: args </span><span style="font: 10pt serif">| var sequence ritual strm<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[var &larr; (args◦1) local. sequence &larr; args◦2. ritual &larr; (args◦3) local.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm &larr; self newTempForMacro.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"strm &larr; sequence asStream. while⦂ (var &larr; strm next) do⦂ ritual"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">block next &larr; ParsedAssignment new var: strm<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">expr: (ParsedMessage new rcvr: sequence op: toAsStream args: false);<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">next &larr; ParsedLoop new<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">whileExpr:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(ParsedAssignment new var: var<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">expr: (ParsedMessage new rcvr: strm op: toNext args: false))<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">doExpr: ritual]<br></span><span style="font: italic 10pt serif">"macro (perform)"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">forfromtobydo: block args: args<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"for⦂ var from: (start to: stop by: step) do⦂ ritual"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">args◦2 &larr; self rcvr: args◦2 selector: &rsquo;to:by:&rsquo; args: (args◦(3 to: 4)) copy.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self forfromdo: block args: (args◦↪(1 2 5)) copy]<br></span><span style="font: italic 10pt serif">"macro (perform)"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">forfromtodo: block args: args<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self for: (args◦1) local<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">from: (ParsedMessage new rcvr: args◦2 op: toMinus args: toLoad1)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">to: args◦3<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">do: (args◦4) local<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">on: block]<br></span><span style="font: italic 10pt serif">"macro (perform)"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fortodo: block args: args<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self for: (args◦1) local<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">from: toLoad0<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">to: args◦2<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">do: (args◦3) local<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">on: block]<br></span><span style="font: italic 10pt serif">"macro (perform)"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">ifthen: block args: args<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[block next &larr; self ifExpr: (args◦1) local thenExpr: (args◦2) local elseExpr: (self nullStatement: ParsedBlock default)]<br></span><span style="font: italic 10pt serif">"macro (perform)"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">ifthenelse: block args: args<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[block next &larr; self ifExpr: (args◦1) local thenExpr: (args◦2) local elseExpr: (args◦3) local]<br></span><span style="font: italic 10pt serif">"macro (perform)"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">macro: block selector: sel args: args<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| special<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[special &larr; inLineMsgs lookup: sel⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self perform: special with: block with: args]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Context canunderstand: sel unique⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[block next &larr; self rcvr: toLoadThisCtxt selector: sel args: (args remote: self)]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]<br></span><span style="font: italic 10pt serif">"Parser keywordMessage"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">untildo: block args: args<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[block next &larr; ParsedLoop new whileExpr: (ParsedNegation new rcvr: (args◦1) local op: toEq args: toLoadFalse) doExpr: (args◦2) local]<br></span><span style="font: italic 10pt serif">"macro (perform)"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">whiledo: block args: args<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[block next &larr; ParsedLoop new whileExpr: (args◦1) local doExpr: (args◦2) local]<br></span><span style="font: italic 10pt serif">"macro (perform)"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Table maintenance</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">balance<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑nTemps]<br></span><span style="font: italic 10pt serif">"Parser cascade"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">comment: s<br></span><span style="font: italic 10pt serif">"Class fieldNamesInto"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">contents<br></span><span style="font: italic 10pt serif">"Class fieldNamesInto"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">declaration: block name: name asArg: asArg<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| permVar tempVar<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[tempVar &larr; self newTemp.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">permVar &larr; local lookup: name ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[asArg and⦂ permVar isField⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[block next &larr; ParsedAssignment new var: permVar expr: tempVar]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">parser notify: &rsquo;NAME ALREADY IN USE&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">local insert: name with: tempVar]<br></span><span style="font: italic 10pt serif">"Parser declaration|temporaries"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">encodeSel: sel<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| code<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[code &larr; stdSelectors lookup: sel⇒ [⇑code]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑codeSendLit+ (self litIndex: [sel class≡Integer⇒ [UST1◦(sel+1)] sel unique])]<br></span><span style="font: italic 10pt serif">"rcvr|ParsedFieldReference remote|ParsedRemote remote"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">identifier: s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[local insert: s with: (nTemps &larr; nTemps + 1)]<br></span><span style="font: italic 10pt serif">"Class fieldNamesInto"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">initSymbols: class | s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[environment &larr; class wholeEnvironment, Smalltalk.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">local &larr; Dictionary new copyfrom: stdPrimaries.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nTemps &larr; codeLoadField-1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ s from: class instvars do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[local insert: s with: (nTemps &larr; nTemps + 1)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nTemps &larr; maxTemp &larr; 0. literals &larr; Vector new: 123. supered &larr; false]<br></span><span style="font: italic 10pt serif">"compile|evaluate"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">juggle </span><span style="font: 10pt serif">| oldTemps<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[oldTemps &larr; maxTemp. maxTemp &larr; nTemps. ⇑oldTemps]<br></span><span style="font: italic 10pt serif">"Parser macro"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">literal: x  </span><span style="font: 10pt serif">| i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[x class≡Integer⇒ [0≠(i&larr;↪(¬1 0 1 2 10) find: x)⇒ [⇑toLoadConst+i-1]]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑codeLoadLit + (self litIndex: x)]<br></span><span style="font: italic 10pt serif">"Parser primary|ParsedFieldReference remote"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">litIndex: oop  </span><span style="font: 10pt serif">| i t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ i to: 123 do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(t &larr; literals◦i)≡nil⇒ [literals◦i&larr;oop. ⇑i-1]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">t class≡oop class⇒ [t sameAs: oop⇒ [⇑i-1]]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">parser notify: &rsquo;MORE THAN 123 LITERALS REFERENCED&rsquo;]<br></span><span style="font: italic 10pt serif">"encodeSel|literal"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">newTemp<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(nTemps &larr; nTemps+1) &gt; maxTemp and⦂ (maxTemp &larr; nTemps) &gt; 256⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[parser notify: &rsquo;MORE THAN 256 TEMPS REQUIRED&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑codeLoadTemp + nTemps-1]<br></span><span style="font: italic 10pt serif">"receivingVar|declaration"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">newTempForMacro </span><span style="font: italic 10pt serif">"juggle arranged that maxTemp are needed by args of macro"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[nTemps &larr; maxTemp. ⇑self newTemp]<br></span><span style="font: italic 10pt serif">"forfromdo|forfromtodo"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">separator: c<br></span><span style="font: italic 10pt serif">"Class fieldNamesInto"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">trailer: s<br></span><span style="font: italic 10pt serif">"Class fieldNamesInto"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">unbalance: nTemps<br></span><span style="font: italic 10pt serif">"Parser cascade"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">unjuggle: oldTemps<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[maxTemp &larr; oldTemps max: maxTemp]<br></span><span style="font: italic 10pt serif">"Parser macro"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪Generator under: &rsquo;Compiler&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"ParsedAssignment"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;ParsedAssignment&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;var expr elide&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sharing: ByteCodes;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I am a node in a compiler parse tree.  I represent an assignment of an expression to a variable.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">var: var expr: expr</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Code generation</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emitForEffect: code on: stack<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[expr emitForValue: code on: stack. stack pop: 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">elide⇒ [</span><span style="font: italic 10pt serif">"var begins the next statement"</span><span style="font: 10pt serif"> code next &larr; toSmash]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">code next &larr; toSmashPop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">var emitBytes: code]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emitForValue: code on: stack<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[expr emitForValue: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">code next &larr; toSmash.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">var emitBytes: code]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emittedVariable<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑var]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">firstPush<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑expr firstPush]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sizeForEffect: nextPush<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑expr sizeForValue + 1 + [elide &larr; nextPush≡var⇒ [0] var sizeForValue]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sizeForValue<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑expr sizeForValue + 1 + var sizeForValue]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Miscellaneous</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s append: &rsquo;(&rsquo;; print: var; append: &rsquo;&larr;&rsquo;; print: expr; append: &rsquo;)&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Decompiling</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">expr </span><span style="font: 10pt serif">[⇑expr]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">findMacros: macros compilerTemps: compilerTemps<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[var findMacros: macros compilerTemps: compilerTemps.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">expr findMacros: macros compilerTemps: compilerTemps]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">isForFromInit: loop </span><span style="font: 10pt serif">| cond b nextMess<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">return true if I could be the first initialization statement for a <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif; text-decoration: underline">for⦂ from:</span><span style="font: italic 10pt serif"> loop.</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(expr isnt: ParsedMessage) or⦂ expr op≠toAsStream⇒[⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">loop isnt: ParsedLoop⇒[⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">b &larr; loop whileExpr.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(b isnt: ParsedBlock) or⦂ b position≠2⇒[⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">b◦1 isnt: ParsedAssignment⇒[⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextMess &larr; (b◦1) expr.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextMess isnt: ParsedMessage⇒[⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextMess rcvr≠var or⦂ nextMess op≠toNext⇒[⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑true]</span><span class="tab" val="79"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">isForFromToInit: start loop: loop </span><span style="font: 10pt serif">| b incr test<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">return true if I could be the first initialization statement for a <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif; text-decoration: underline">for⦂ to: do⦂</span><span style="font: italic 10pt serif"> or a </span><span style="font: italic 10pt serif; text-decoration: underline">for⦂ from: to: do⦂</span><span style="font: italic 10pt serif"> loop</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">I should set the upper bound, start should set the var to start-1</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(start isnt: ParsedAssignment) or⦂ (loop isnt: ParsedLoop)⇒[⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> [start expr≡toLoad0⇒[]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">start expr isnt: ParsedMessage⇒[⇑false]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">start expr op≠toMinus or⦂ start expr args≠toLoad1⇒[⇑false]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">the loop condition should increment the var and compare it with the <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">upper bound</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">b &larr; loop whileExpr.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(b isnt: ParsedBlock) or⦂ b position≠2⇒[⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">incr &larr; b◦1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">incr isnt: ParsedAssignment⇒[⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">incr var≠start var⇒[⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(incr expr isnt: ParsedMessage) or⦂ incr expr op≠toPlus⇒[⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">incr expr rcvr≠toLoad1 or⦂ incr expr args≠start var⇒[⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">test &larr; b◦2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">test isnt: ParsedMessage⇒[⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(test rcvr≠var or⦂ test op≠toGeq) or⦂ test args≠incr var⇒[⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑true]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm indent: level precedence: p forValue: v decompiler: decompiler<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ [p&gt;1⇒[strm append: &rsquo;(&rsquo;]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">var printon: strm indent: level precedence: 1<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">forValue: true decompiler: decompiler.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm append: &rsquo; &larr; &rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">expr printon: strm indent: level+2 precedence: 1<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">forValue: true decompiler: decompiler.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">p&gt;1⇒[strm append: &rsquo;)&rsquo;]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">var </span><span style="font: 10pt serif">[⇑var]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪ParsedAssignment under: &rsquo;Compiler&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"ParsedBlock"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;ParsedBlock&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Stream<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;returns&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sharing: ByteCodes;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I am a stream to collect the statements of a block and then to become a node in a compiler parse tree.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">default<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[limit &larr; 1. array &larr; Vector new: 1. position &larr; 0. returns &larr; false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">doesReturn<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[returns &larr; true]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">mustReturn: fromMethod<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[returns⇒ []<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[fromMethod⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[position&gt;0 and⦂ (array◦position) emitsLoad⇒ [array◦position &larr; toLoadSelf] self next &larr; toLoadSelf]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self doesReturn]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Code generation</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emitForEffect: code on: stack<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[returns⇒ [self emitForValue: code on: stack. stack pop: 1]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self emitExceptLast: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(array◦position) emitForEffect: code on: stack]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emitForValue: code on: stack<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self emitExceptLast: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(array◦position) emitForValue: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">returns⇒ [code next &larr; toReturn]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">firstPush<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑(array◦1) firstPush]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sizeForEffect: nextPush<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[returns⇒ [⇑self sizeForValue]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self sizeExceptLast + ((array◦position) sizeForEffect: nextPush)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sizeForTruth: trueSkip falsity: falseSkip<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[returns⇒ [⇑self sizeForValue]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self sizeExceptLast + (array◦position sizeForTruth: trueSkip falsity: falseSkip)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sizeForValue<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self sizeExceptLast + (array◦position) sizeForValue + [returns⇒ [1] 0]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Miscellaneous</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: s </span><span style="font: 10pt serif">| i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s append: &rsquo;[&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: position-1 do⦂ [s print: (array◦i); append: &rsquo;. &rsquo;].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[returns⇒ [s append: &rsquo;⇑&rsquo;]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[position&gt;0⇒ [s print: (array◦position)]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s append: &rsquo;]&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">quickCode </span><span style="font: 10pt serif">| t v<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[position=1 and⦂ (returns and⦂ (v&larr;array◦1) emitsLoad)⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[v=toLoadSelf⇒ [t &larr; String new: 2. t◦1&larr;0; ◦2&larr;1. ⇑t]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">v isField⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t &larr; String new: 5. t◦1&larr;0; ◦2&larr;40; ◦3&larr;0; ◦4&larr;0; ◦5&larr;v. ⇑t]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">returns<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑returns]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Private</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emitExceptLast: code on: stack<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ i to: position-1 do⦂ [(array◦i) emitForEffect: code on: stack]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sizeExceptLast<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| i next nextPush size<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[size &larr; 0. next &larr; array◦position.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: position-1 do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[nextPush &larr; next firstPush. next &larr; array◦(position-i).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">size &larr; size + (next sizeForEffect: nextPush)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑size]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Decompiling</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">findMacros: macros compilerTemps: compilerTemps </span><span style="font: 10pt serif">| i s t<br>"</span><span style="font: italic 10pt serif">Look for </span><span style="font: italic 10pt serif; text-decoration: underline">for</span><span style="font: italic 10pt serif"> statements.  If one of my statements is the init statement for a </span><span style="font: italic 10pt serif; text-decoration: underline">for</span><span style="font: italic 10pt serif">, append myself and the index of that statement to the stream </span><span style="font: italic 10pt serif; text-decoration: underline">macros</span><span style="font: italic 10pt serif">.  Mark its compiler-generated temp.  If the temp is subsequently used before being re-assigned, the pattern can&rsquo;t be a </span><span style="font: italic 10pt serif; text-decoration: underline">for</span><span style="font: italic 10pt serif"> after all, and will be deleted from </span><span style="font: italic 10pt serif; text-decoration: underline">macros</span><span style="font: italic 10pt serif">.</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ i to: position do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s &larr; array◦i.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(s isnt: ParsedAssignment) or⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(s var&lt;codeLoadTemp or⦂ s var&gt;(codeLoadTemp+255))⇒  "</span><span style="font: italic 10pt serif">not a </span><span style="font: italic 10pt serif; text-decoration: underline">for</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s findMacros: macros compilerTemps: compilerTemps]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">t &larr; s var-codeLoadTemp+1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">i≤(position-2) and⦂ (s isForFromToInit: array◦(i+1) loop: array◦(i+2))⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[macros next&larr; self; next&larr; i.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">compilerTemps◦t &larr; true.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">check other parts of the for</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s expr findMacros: macros compilerTemps: compilerTemps.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">array◦(i+1) findMacros: macros compilerTemps: compilerTemps.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(array◦(i+2)) doExpr findMacros: macros compilerTemps: compilerTemps.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; i+2]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">i≤(position-1) and⦂ (array◦i isForFromInit: array◦(i+1))⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[macros next&larr; self; next&larr; i.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">compilerTemps◦t &larr; true.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s expr findMacros: macros compilerTemps: compilerTemps.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(array◦(i+1)) doExpr findMacros: macros compilerTemps: compilerTemps.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; i+1]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s findMacros: macros compilerTemps: compilerTemps]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">insertMacro: loc decompiler: decompiler </span><span style="font: 10pt serif">| macro n i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">create a parsed for loop, and replace the old statements by it</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">macro &larr; ParsedForLoop new block: self loc: loc decompiler: decompiler.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">array◦loc &larr; macro.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">n &larr; macro nStatements.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: loc+n to: position do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[array◦(i-n+1) &larr; array◦i].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">position &larr; position-n+1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm indent: level precedence: p forValue: v decompiler: decompiler </span><span style="font: 10pt serif">| i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">ignore precedence, since the block is enclosed in brackets</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">position=0⇒[strm append: &rsquo;[]&rsquo; ]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm append: &rsquo;[&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: position-1 do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[array◦i printon: strm indent: level precedence: 0<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">forValue: false decompiler: decompiler.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm append: &rsquo;.&rsquo;; crtab: level].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> [returns⇒[strm append: &rsquo;⇑&rsquo;]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">array◦position printon: strm indent: level precedence: 0<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">forValue: (returns or⦂ v) decompiler: decompiler.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm append: &rsquo;]&rsquo; ]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>As yet unclassified</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emitForTruth: trueSkip falsity: falseSkip into: code on: stack<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[returns⇒ [self emitForValue: code on: stack]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self emitExceptLast: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(array◦position) emitForTruth: trueSkip falsity: falseSkip into: code on: stack]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪ParsedBlock under: &rsquo;Compiler&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"ParsedConditional"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;ParsedConditional&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;ifExpr thenExpr elseExpr thenSize elseSize jmpSize&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I am a node in a compiler parse tree.  I represent a condition and two alternatives.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">ifExpr: ifExpr thenExpr: thenExpr elseExpr: elseExpr</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Code generation</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emitForEffect: code on: stack<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ifExpr emitForValue: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">thenSize emitBfp: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">thenExpr emitForEffect: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[jmpSize&gt;0⇒ [elseSize emitJmp: code on: stack]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">elseExpr emitForEffect: code on: stack]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emitForValue: code on: stack<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ifExpr emitForValue: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">thenSize emitBfp: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">thenExpr emitForValue: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">stack pop: 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[jmpSize&gt;0⇒ [elseSize emitJmp: code on: stack]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">elseExpr emitForValue: code on: stack]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">firstPush<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑ifExpr firstPush]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sizeForEffect: nextPush<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[elseSize &larr; elseExpr sizeForEffect: nextPush.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">jmpSize &larr; [thenExpr returns⇒ [0] elseSize jmpSize].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">thenSize &larr; (thenExpr sizeForEffect: ¬1) + jmpSize.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ifExpr sizeForValue + thenSize bfpSize + thenSize + elseSize]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sizeForValue<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[elseSize &larr; elseExpr sizeForValue.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">jmpSize &larr; [thenExpr returns⇒ [0] elseSize jmpSize].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">thenSize &larr; thenExpr sizeForValue + jmpSize.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ifExpr sizeForValue + thenSize bfpSize + thenSize + elseSize]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Miscellaneous</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s append: &rsquo;if⦂ &rsquo;; print: ifExpr; append: &rsquo;then⦂ &rsquo;; print: thenExpr; append: &rsquo;else⦂ &rsquo;; print: elseExpr]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">returns<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑thenExpr returns and⦂ elseExpr returns]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Decompiling</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">findMacros: macros compilerTemps: compilerTemps<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ifExpr findMacros: macros compilerTemps: compilerTemps.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">thenExpr findMacros: macros compilerTemps: compilerTemps.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">elseExpr findMacros: macros compilerTemps: compilerTemps]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm indent: level precedence: p forValue: v decompiler: decompiler<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| pos char<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ifExpr printon: strm indent: level precedence: 0 <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">forValue: true decompiler: decompiler.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm append: &rsquo; ⇒&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[thenExpr position&gt;1 or⦂ (thenExpr◦1 is: ParsedConditional)⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strm crtab: level+1] strm space].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">thenExpr printon: strm indent: level+1 precedence: 0 <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">forValue: v decompiler: decompiler.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">elseExpr position=1 and⦂ elseExpr last≡nil⇒[]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm crtab: level.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">Kludge!! Delete brackets around else block</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pos&larr;strm position.  char&larr;strm pop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">elseExpr printon: strm indent: level precedence: 0 <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">forValue: v decompiler: decompiler.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm skip: ¬1.  strm◦pos&larr;char]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪ParsedConditional under: &rsquo;Compiler&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"ParsedConjunct"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;ParsedConjunct&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;left right rightSize&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sharing: ByteCodes;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I am a node in a compiler parse tree.  I represent (left and⦂ right) and try to optimize the code generation thereof.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">left: left right: right</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Code generation</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emitForEffect: code on: stack<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[left emitForValue: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rightSize emitBfp: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">right emitForEffect: code on: stack]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emitForTruth: trueSkip falsity: falseSkip into: code on: stack<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[left emitForTruth: 0 falsity: rightSize+falseSkip into: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">right emitForTruth: trueSkip falsity: falseSkip into: code on: stack]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emitForValue: code on: stack<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[left emitForValue: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rightSize emitBfp: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">right emitForValue: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">1 emitJmp: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">code next &larr; toLoadFalse]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">firstPush<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑left firstPush]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sizeForEffect: nextPush<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[rightSize &larr; right sizeForEffect: ¬1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑left sizeForValue + rightSize bfpSize + rightSize]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sizeForTruth: trueSkip falsity: falseSkip<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[rightSize &larr; right sizeForTruth: trueSkip falsity: falseSkip.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑(left sizeForTruth: 0 falsity: rightSize+falseSkip) + rightSize]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sizeForValue<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[rightSize &larr; right sizeForValue + 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑left sizeForValue + rightSize bfpSize + rightSize + 1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Miscellaneous</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emittedReceiver<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑left]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emittedReceiver &larr; left</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s append: &rsquo;(&rsquo;; print: left; append:  &rsquo; and⦂ &rsquo;; print: right; append: &rsquo;)&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Decompiling</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">findMacros: macros compilerTemps: compilerTemps<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[left findMacros: macros compilerTemps: compilerTemps.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">right findMacros: macros compilerTemps: compilerTemps]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm indent: level precedence: p forValue: v decompiler: decompiler<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ [p≥2⇒[strm append: &rsquo;(&rsquo;]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">left printon: strm indent: level precedence: 2<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">forValue: true decompiler: decompiler.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm append: &rsquo; and⦂ &rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">right printon: strm indent: level precedence: 2<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">forValue: v decompiler: decompiler.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">p≥2⇒[strm append: &rsquo;)&rsquo;]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪ParsedConjunct under: &rsquo;Compiler&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"ParsedDisjunct"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;ParsedDisjunct&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;left right rightSize&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sharing: ByteCodes;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I am a node in a compiler parse tree.  I represent (left or⦂ right) and try to optimize the code generation thereof.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">left: left right: right</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Code generation</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emitForEffect: code on: stack<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[left emitForValue: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rightSize jmpSize emitBfp: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rightSize emitJmp: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">right emitForEffect: code on: stack]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emitForTruth: trueSkip falsity: falseSkip into: code on: stack<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[left emitForTruth: rightSize+trueSkip falsity: 0 into: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">right emitForTruth: trueSkip falsity: falseSkip into: code on: stack]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emitForValue: code on: stack<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[left emitForValue: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(1 + rightSize jmpSize) emitBfp: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">code next &larr; toLoadTrue.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rightSize emitJmp: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">right emitForValue: code on: stack]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">firstPush<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑left firstPush]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sizeForEffect: nextPush<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[rightSize &larr; right sizeForEffect: ¬1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑left sizeForValue + 1 + rightSize jmpSize + rightSize]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sizeForTruth: trueSkip falsity: falseSkip<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[rightSize &larr; right sizeForTruth: trueSkip falsity: falseSkip.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑(left sizeForTruth: rightSize+trueSkip falsity: 0) + rightSize]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sizeForValue<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[rightSize &larr; right sizeForValue.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑left sizeForValue + 2 + rightSize jmpSize + rightSize]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Miscellaneous</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emittedReceiver<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑left]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emittedReceiver &larr; left</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s append: &rsquo;(&rsquo;; print: left; append: &rsquo; or⦂ &rsquo;; print: right; append: &rsquo;)&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Decompiling</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">findMacros: macros compilerTemps: compilerTemps<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[left findMacros: macros compilerTemps: compilerTemps.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">right findMacros: macros compilerTemps: compilerTemps]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm indent: level precedence: p forValue: v decompiler: decompiler<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ [p≥2⇒[strm append: &rsquo;(&rsquo;]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">left printon: strm indent: level precedence: 2<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">forValue: true decompiler: decompiler.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm append: &rsquo; or⦂ &rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">right printon: strm indent: level precedence: 2<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">forValue: v decompiler: decompiler.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">p≥2⇒[strm append: &rsquo;)&rsquo;]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪ParsedDisjunct under: &rsquo;Compiler&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"ParsedFieldReference"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;ParsedFieldReference&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;var toLoadVar toLoadFieldReference toObjectOffset&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sharing: ByteCodes;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I am a node in a compiler parse tree.  I represent a remote argument which is a reference to a method or instance variable.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">var: var</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Code generation</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emitForValue: code on: stack<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[([var isField⇒ [toLoadSelf] toLoadTempframe]) emitForValue: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">toLoadVar emitForValue: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">toLoadFieldReference emitForValue: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">code next &larr; toNew. toObjectOffset emitBytes: code..<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">stack pop: 2]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">local<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑var]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">remote: generator<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[toLoadVar &larr; generator literal: (var land: 0177)+1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">toLoadFieldReference &larr; generator literal: FieldReference.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">toObjectOffset &larr; generator encodeSel: ↪object:offset:]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sizeForValue<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑ 2 + toLoadVar sizeForValue +<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">toLoadFieldReference sizeForValue + toObjectOffset sizeForValue]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Miscellaneous</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s append: &rsquo;FLD=&gt; &rsquo;; print: var]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Decompiling</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">findMacros: macros compilerTemps: compilerTemps<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[var findMacros: macros compilerTemps: compilerTemps]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm indent: level precedence: p forValue: v decompiler: decompiler<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[var printon: strm indent: level precedence: p<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">forValue: true decompiler: decompiler]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪ParsedFieldReference under: &rsquo;Compiler&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"ParsedForLoop"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;ParsedForLoop&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;var source start stop step doExpr nStatements&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sharing: ByteCodes;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I represent a for loop.  I am used only by the decompiler, not the compiler.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Decompiling</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">block: block loc: loc decompiler: decompiler </span><span style="font: 10pt serif">| init1 init2 loop s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">loc should point to the initialization statement for a </span><span style="font: italic 10pt serif; text-decoration: underline">for</span><span style="font: italic 10pt serif"> loop in block</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">init1 &larr; block◦loc.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">block◦(loc+1) is: ParsedLoop⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[nStatements &larr; 2.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">loop &larr; block◦(loc+1).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">var &larr; loop whileExpr◦2.  doExpr &larr; loop doExpr.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">init statement creates a stream ... see if its an interval</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s &larr; init1 expr rcvr.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(s is: ParsedMessage) and⦂ (decompiler selector: s op)≡↪to:by: ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[start &larr; s rcvr.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">stop &larr; s args◦1.  step &larr; s args◦2]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">source &larr; s]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">must be a for⦂from:to:do⦂.  </span><span style="font: italic 10pt serif; text-decoration: underline">init1</span><span style="font: italic 10pt serif"> will set up the limit, and </span><span style="font: italic 10pt serif; text-decoration: underline">init2</span><span style="font: italic 10pt serif"> will<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">initialize </span><span style="font: italic 10pt serif; text-decoration: underline">var</span><span style="font: italic 10pt serif"> to start-1</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nStatements &larr; 3.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">init2 &larr; block◦(loc+1).  loop &larr; block◦(loc+2).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">var &larr; init2 var.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">start &larr; [init2 expr≡toLoad0</span><span class="tab" val="79"></span><span style="font: 10pt serif">⇒[toLoad1] init2 expr rcvr].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">stop &larr; init1 expr.  step &larr; toLoad1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">doExpr &larr; loop doExpr]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">nStatements<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">return the number of statements in my expanded form</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑nStatements]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm indent: level precedence: p forValue: v decompiler: decompiler<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[source≡nil⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strm append: &rsquo;for⦂ &rsquo;.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">var printon: strm indent: level precedence: 2<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">forValue: true decompiler: decompiler.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> [start≡toLoad1⇒[] strm append: &rsquo; from: &rsquo;.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">start printon: strm indent: level precedence: 2<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">forValue: true decompiler: decompiler].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm append: &rsquo; to: &rsquo;.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">stop printon: strm indent: level precedence: 2<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">forValue: true decompiler: decompiler.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> [step≡toLoad1⇒[] strm append: &rsquo; by: &rsquo;.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">step printon: strm indent: level precedence: 2<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">forValue: true decompiler: decompiler].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm append: &rsquo; do⦂&rsquo;; crtab: level+1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">doExpr printon: strm indent: level+1 precedence: 0 <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">forValue: false decompiler: decompiler]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">source is a stream</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm append: &rsquo;for⦂ &rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">var printon: strm indent: level precedence: 2<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">forValue: true decompiler: decompiler.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm append: &rsquo; from: &rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">source printon: strm indent: level precedence: 2<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">forValue: true decompiler: decompiler.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm append: &rsquo; do⦂&rsquo;; crtab: level+1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">doExpr printon: strm indent: level+1 precedence: 0 <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">forValue: false decompiler: decompiler]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪ParsedForLoop under: &rsquo;Compiler&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"ParsedLoop"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;ParsedLoop&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;whileExpr doExpr whileSize doSize&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sharing: ByteCodes;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I am a node in a compiler parse tree.  I represent that part of an in-line loop statement that can be expressed in the while-do form.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">whileExpr: whileExpr doExpr: doExpr</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Code generation</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emitForEffect: code on: stack<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">optimization removed to make things easier for decompiler --<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">whileExpr emitForTruth: 0 falsity: doSize into: code on: stack.</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">whileExpr emitForValue: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">doSize emitBfp: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">doExpr emitForEffect: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">0 - doSize - whileSize - doSize jmpSize emitJmp: code on: stack]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emitForValue: code on: stack<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self emitForEffect: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">toLoadNil emitForValue: code on: stack]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">firstPush<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑whileExpr firstPush]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sizeForEffect: nextPush<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[doSize &larr; (doExpr sizeForEffect: ¬1) + 2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">whileSize &larr; whileExpr sizeForTruth: 0 falsity: doSize.</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">whileSize &larr; whileExpr  sizeForValue.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑whileSize + doSize + doSize jmpSize]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sizeForValue<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑(self sizeForEffect: ¬1) + 1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Miscellaneous</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s append: &rsquo;while⦂ &rsquo;; print: whileExpr; append: &rsquo;do⦂ &rsquo;; print: doExpr]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Decompiling</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">doExpr </span><span style="font: 10pt serif">[⇑doExpr]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">findMacros: macros compilerTemps: compilerTemps<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[whileExpr findMacros: macros compilerTemps: compilerTemps.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">doExpr findMacros: macros compilerTemps: compilerTemps]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm indent: level precedence: p forValue: v decompiler: decompiler<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[whileExpr is: ParsedNegation⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strm append: &rsquo;until⦂ &rsquo;.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">whileExpr negated printon: strm indent: level precedence: 2<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">forValue: true decompiler: decompiler]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> strm append: &rsquo;while⦂ &rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> whileExpr printon: strm indent: level precedence: 2<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">forValue: true decompiler: decompiler].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm append: &rsquo; do⦂&rsquo;; crtab: level+1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">doExpr printon: strm indent: level+1 precedence: 0 <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">forValue: false decompiler: decompiler]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">whileExpr </span><span style="font: 10pt serif">[⇑whileExpr]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪ParsedLoop under: &rsquo;Compiler&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"ParsedMessage"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;ParsedMessage&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;rcvr op args "false if no args, Vector if many args" hasPC&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sharing: ByteCodes;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I am a node in a compiler parse tree.  I represent an expression consisting of a receiver (rcvr), a selector byte code (op), and an argument list (args) which is false for no arguments, a vector of parse trees for 2 or more arguments, or the argument parse tree for one argument.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hasPC </span><span style="font: 10pt serif">[hasPC&larr; true]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">rcvr: rcvr op: op args: args<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[hasPC&larr; false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">op=toEq and⦂ ((toLoadFalse≡rcvr) or⦂ (toLoadFalse≡args))⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑ParsedNegation new rcvr: rcvr op: op args: args]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Code generation</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emitForEffect: code on: stack<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self emitForValue: code on: stack. code next &larr; toPop. stack pop: 1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emitForValue: code on: stack<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[args emitForValue: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rcvr emitForValue: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[rcvr≡toSuper⇒ [code next&larr;rcvr]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">op emitBytes: code. args argsOff: stack]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">firstPush<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑([args⇒ [args] rcvr]) firstPush]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sizeForEffect: nextPush<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self sizeForValue+1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sizeForValue<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑args sizeForValue + rcvr sizeForValue + op sizeForValue + [rcvr≡toSuper⇒ [1] 0]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Miscellaneous</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">args </span><span style="font: 10pt serif">[⇑args]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">args&larr;args</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emittedReceiver<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑rcvr]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emittedReceiver &larr; rcvr</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">op </span><span style="font: 10pt serif">[⇑op]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s append: &rsquo;(&rsquo;; print: rcvr; space; print: op.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[args⇒ [s space; print: args]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s append: &rsquo;)&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">rcvr </span><span style="font: 10pt serif">[⇑rcvr]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Decompiling</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">findMacros: macros compilerTemps: compilerTemps </span><span style="font: 10pt serif">| vec a<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[vec &larr; [args≡nil⇒[↪()] args is: Vector⇒[args] args inVector].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ a from: vec do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[a findMacros: macros compilerTemps: compilerTemps].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rcvr findMacros: macros compilerTemps: compilerTemps]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm indent: level precedence: p forValue: v decompiler: decompiler<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| sel keywords i parens myP vec char1<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[sel &larr; decompiler selector: op.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">myP &larr; [sel isinfix⇒[3]; iskeyword⇒[2]; isarrow⇒[1] 4].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"check if parens are needed"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">parens &larr; [myP&lt;p or⦂ (p=2 and⦂ myP=2)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> [parens⇒[strm append: &rsquo;(&rsquo;]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">char1&larr; strm position.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rcvr printon: strm indent: level precedence: myP<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">forValue: true decompiler: decompiler.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> [myP=4⇒[strm space; append: sel  "unary selector"]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> keywords &larr; sel keywords.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">vec &larr; [args≡nil⇒[↪()] args is: Vector⇒[args] args inVector].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> for⦂ i to: keywords length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strm space; append: keywords◦i; space.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">vec◦i printon: strm indent: level <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">precedence: [myP=3⇒[4] myP]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">forValue: true decompiler: decompiler]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[hasPC⇒[decompiler highlight: (char1+1 to: strm position+1)]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">parens⇒[strm append: &rsquo;)&rsquo;]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪ParsedMessage under: &rsquo;Compiler&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"ParsedNegation"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;ParsedNegation&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: ParsedMessage<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sharing: ByteCodes;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I am a node in a compiler parse tree.  I am a parsed messsage in which the selector is ≡ and one of the participants is false.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">rcvr: rcvr op: op args: args</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Code generation</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emitForTruth: trueSkip falsity: falseSkip into: code on: stack<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[([toLoadFalse≡rcvr⇒ [args] rcvr]) emitForTruth: falseSkip falsity: trueSkip into: code on: stack]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sizeForTruth: trueSkip falsity: falseSkip<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑([toLoadFalse≡rcvr⇒ [args] rcvr]) sizeForTruth: falseSkip falsity: trueSkip]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Miscellaneous</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">negated </span><span style="font: 10pt serif">[toLoadFalse≡rcvr⇒[⇑args] ⇑rcvr]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s append: &rsquo;(negation)&rsquo;. super printon: s]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪ParsedNegation under: &rsquo;Compiler&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"ParsedObjectReference"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;ParsedObjectReference&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;var&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sharing: ByteCodes;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I am a node in a compiler parse tree.  I represent a remote argument which is a reference to a class or pool variable.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">var: var</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Code generation</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emitForValue: code on: stack  </span><span style="font: italic 10pt serif">"Turn literal indirect into literal direct"</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(var-256) emitForValue: code on: stack]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">local<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑var]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">remote: generator</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sizeForValue<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑(var-256) sizeForValue]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Miscellaneous</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s append: &rsquo;OBJ=&gt; &rsquo;; print: var]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Decompiling</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">findMacros: macros compilerTemps: compilerTemps<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[var findMacros: macros compilerTemps: compilerTemps]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm indent: level precedence: p forValue: v decompiler: decompiler<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strm append: (decompiler literal: var)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪ParsedObjectReference under: &rsquo;Compiler&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"ParsedRemote"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;ParsedRemote&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;expr esize toRemoteCopy&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sharing: ByteCodes;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I am a node in a compiler parse tree.  I represent an argument that is to be passed unevaluated.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">expr: expr</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Code generation</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">emitForValue: code on: stack<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[toLoadThisCtxt emitForValue: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">toRemoteCopy emitBytes: code.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">code emitLong: toLongJmp by: esize.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">expr emitForValue: code on: stack.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">code next &larr; toEnd. stack pop: 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(0-esize) emitJmp: code on: stack]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">local<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑expr]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">remote: generator<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[toRemoteCopy &larr; generator encodeSel: ↪remoteCopy]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sizeForValue<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[esize &larr; expr sizeForValue + 3.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑esize + toRemoteCopy sizeForValue + 3]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Miscellaneous</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s append: &rsquo;⦂&rsquo;; print: expr]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Decompiling</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">findMacros: macros compilerTemps: compilerTemps<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[expr findMacros: macros compilerTemps: compilerTemps]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm indent: level precedence: p forValue: v decompiler: decompiler<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[(expr is: ParsedBlock) and⦂ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(expr position&gt;1 or⦂ (expr◦1 is: ParsedConditional))⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strm crtab: level+1]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">expr printon: strm indent: level+1 precedence: p<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">forValue: true decompiler: decompiler]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪ParsedRemote under: &rsquo;Compiler&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"Parser"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;Parser&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;source dest oppositeCourt type token mark keep&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sharing: TokenCodes;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I parse tokens from source (a stream).  I report each parse node to dest (e.g., a code generator).  When an error occurs, I back up source to mark and notify dest.  I have two kinds of methods, token suppliers and token consumers, which coroutine with each other.  The coroutine that is not in control is suspended in the context, oppositeCourt.  Token suppliers are driven by an instance of class Reader that scans source and classifies each token by type.  Token consumers analyze the syntax and report it to dest.  The variable "keep" is no longer used.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">from: source to: dest<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[oppositeCourt &larr; thisContext.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">mark &larr; source position. type &larr; 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(Reader new of: source) readInto: self]<br></span><span style="font: italic 10pt serif">"Generator compile|Generator evaluate"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Token suppliers</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">comment: s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[mark &larr; source position]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">contents<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[type &larr; 0. mark &larr; source position + 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">thisContext sender &larr; nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ true do⦂ [self resume. self notify: &rsquo;MORE EXPECTED&rsquo;]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">float: i fraction: f exp: e<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[token &larr; (i+&rsquo;.&rsquo;+f+&rsquo;e&rsquo;+e) asFloat.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">type &larr; aNumber. self resume]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">identifier: token<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[type &larr; aWord. self resume]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">integer: s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[token &larr; s asInteger.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">type &larr; aNumber. self resume]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">keyword: token<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[type &larr; aKeyword. self resume]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">leftparen<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[type &larr; aLeftPar. self resume]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">onechar: token<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[type &larr;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[token=056⇒ [aPeriod];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=0133⇒ [aLeftBrack];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=0135⇒ [aRightBrack];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=033⇒ [aCondArrow];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=0137⇒ [aLeftArrow];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=021⇒ [aReturnArrow];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=073⇒ [aSemicolon];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=017⇒ [aHand]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">aBinary].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self resume]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">otheratom: token<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[type &larr; aGibberish. self resume]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">rightparen<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[type &larr; aRightPar. self resume]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">separator: c</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">string: token<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[type &larr; aString. self resume]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">trailer: s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[mark &larr; source position]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Method syntax</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">body: block  </span><span style="font: 10pt serif">| p  </span><span style="font: italic 10pt serif">"return the primitive number, or 0"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[type=aLeftBrack⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self block: block.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">type=aKeyword and⦂ token=&rsquo;primitive:&rsquo;⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self advance. type=aNumber⇒ [p &larr; token. self advance. ⇑p]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self notify: &rsquo;EXPECTED A NUMBER&rsquo;]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑0]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑0]<br></span><span style="font: italic 10pt serif">"Generator compile"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">declaration: block<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[type≠aWord⇒ [self notify: &rsquo;EXPECTED AN ARGUMENT NAME&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dest declaration: block name: token asArg: true.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self advance]<br></span><span style="font: italic 10pt serif">"pattern"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pattern: block<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| selector<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[selector &larr; Stream default.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[type=aWord⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[selector append: token. self advance];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=aBinary⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[selector append: (UST1◦(token+1)). self advance; declaration: block]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ type = aKeyword do⦂ [selector append: token. self advance; declaration: block].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">selector empty⇒ [self notify: &rsquo;EXPECTED A SELECTOR&rsquo;]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[type=aLeftArrow⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[selector append: &rsquo;&larr;&rsquo;. self advance; declaration: block]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑selector contents unique]<br></span><span style="font: italic 10pt serif">"Generator compile|Context variableNamesInto"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">temporaries: block<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[type=aBinary and⦂ token=0174⇒ </span><span style="font: italic 10pt serif">"|"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self advance.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ type=aWord do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[dest declaration: block name: token asArg: false. self advance]]]<br></span><span style="font: italic 10pt serif">"Generator compile|Context variableNamesInto"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Statement syntax</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">alternatives: ifExpr </span><span style="font: italic 10pt serif">"⇒ [..] ..."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| thenExpr elseExpr<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self advance.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">type≠aLeftBrack⇒ [self notify: &rsquo;EXPECTED A [BLOCK]&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">thenExpr &larr; self block: dest block. elseExpr &larr; dest block.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[type=aSemicolon⇒ [self cascade: elseExpr after: ifExpr] self statements: elseExpr].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑dest ifExpr: ifExpr thenExpr: thenExpr elseExpr: elseExpr]<br></span><span style="font: italic 10pt serif">"cascade"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">block: block<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self advance; statements: block.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">type=aRightBrack⇒ [self advance. ⇑block]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self notify: &rsquo;PERIOD OR RIGHT BRACKET WAS EXPECTED&rsquo;]<br></span><span style="font: italic 10pt serif">"body|alternatives|expression|keywordMessage|binaryMessage"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">cascade: block after: expr  </span><span style="font: 10pt serif">| val var oldTemps<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[var &larr; dest receivingVar: expr.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">oldTemps &larr; dest balance.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ type=aSemicolon do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self advance.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(val &larr; self messageChain: var)≡var⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self notify: &rsquo;MESSAGE EXPECTED&rsquo;].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">type=aCondArrow⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[block next &larr; self alternatives: val. dest unbalance: oldTemps. ⇑self]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">block next &larr; val].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dest unbalance: oldTemps]<br></span><span style="font: italic 10pt serif">"statement|alternatives"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">loopStmt: block  </span><span style="font: 10pt serif">| oldMark<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[oldMark &larr; mark. self keywordMessage: false loop: block⇒ [⇑self]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">mark &larr; oldMark. self notify: &rsquo;UNKNOWN CONTROL MESSAGE&rsquo;]<br></span><span style="font: italic 10pt serif">"statement"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">macro: block  </span><span style="font: 10pt serif">| oldMark oldTemps val<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[oldMark &larr; mark. oldTemps &larr; dest juggle.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">val &larr; self keywordMessage: false macro: block.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dest unjuggle: oldTemps.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">val⇒ [⇑block]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">mark &larr; oldMark. self notify: &rsquo;UNKNOWN CONTROL MESSAGE&rsquo;]<br></span><span style="font: italic 10pt serif">"statement"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">statement: block </span><span style="font: 10pt serif">| expr<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[type=aReturnArrow⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self advance. block next &larr; self expression. block doesReturn.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[type=aPeriod⇒ [self advance]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">type≠aRightBrack⇒ [self notify:&rsquo;SHOULDN&rsquo;&rsquo;T FOLLOW RETURN&rsquo;]];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">= aKeyword⇒ [self macro: block. type&gt;aPeriod⇒ [self statement: block]];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">≤aPeriod⇒ [dest nullStatement: block] </span><span style="font: italic 10pt serif">"doit eof aRightBrack aPeriod"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">expr &larr; self expression.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">type=aCondArrow⇒ [block next &larr; self alternatives: expr]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">block next &larr; expr.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">type=aSemicolon⇒ [self cascade: block after: expr]]<br></span><span style="font: italic 10pt serif">"statements"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">statements: block<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self statement: block.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ type=aPeriod do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self advance. self statement: block]]<br></span><span style="font: italic 10pt serif">"alternatives|block|Generator evaluate"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Expression syntax</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">binaryMessage: rcvr assign: assign </span><span style="font: italic 10pt serif">"binarySelector ..."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| sel args<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[sel &larr; token. self advance.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">args &larr; [type=aLeftBrack⇒ [self block: dest block] self factor].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[assign and⦂ type=aLeftArrow⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self advance.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">args &larr; [(Vector new: 2)◦1&larr;args; ◦2&larr;self expression; itself].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">sel &larr; [(String new: 2)◦1&larr;sel; ◦2&larr;0137</span><span style="font: italic 10pt serif">"&larr;"</span><span style="font: 10pt serif">; itself]]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑dest rcvr: rcvr selector: sel args: args]<br></span><span style="font: italic 10pt serif">"term|messageChain"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">expression<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| var<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[type=aLeftBrack⇒ [⇑self block: dest block];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=aKeyword⇒ [⇑self macro: dest block];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">≠aWord⇒ [⇑self messageChain: self primary]<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"It begins with a variable name"</span><span style="font: 10pt serif"> var &larr; dest variable: token. self advance.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">type≠aLeftArrow⇒ [⇑self messageChain: var]<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"It is a variable assignment"</span><span style="font: 10pt serif"> self advance.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑dest assignment: var expr: self expression]<br></span><span style="font: italic 10pt serif">"unaryMessage|binaryMessage|keywordMessage|statement|subExpression"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">factor<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| expr<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[expr &larr; self primary.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ type=aWord do⦂ [expr &larr; self unaryMessage: expr assign: false].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑expr]<br></span><span style="font: italic 10pt serif">"term|binaryMessage"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">keywordMessage: rcvr macro: block </span><span style="font: italic 10pt serif">"keyword ..."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| sel args arg<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[sel &larr; Stream default. args &larr; (Vector new: 4) asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ type = aKeyword do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[sel append: token. self advance.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">arg &larr; [type=aLeftBrack⇒ [self block: dest block] self term].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">args next &larr; [sel last=03⇒ [dest noEvalKeyword: arg] dest evalKeyword: arg]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[type=aLeftArrow⇒ [sel append: &rsquo;&larr;&rsquo;. args next &larr; [self advance; expression]]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sel &larr; sel contents. args &larr; [args position=1⇒ [args last] args contents].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">block⇒ [⇑dest macro: block selector: sel args: args]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑dest keywordMessage: rcvr selector: sel args: args]<br></span><span style="font: italic 10pt serif">"macro|messageChain"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">messageChain: rcvr<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[while⦂ type=aWord do⦂ [rcvr &larr; self unaryMessage: rcvr assign: true].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ type=aBinary do⦂ [rcvr &larr; self binaryMessage: rcvr assign: true].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[type = aKeyword⇒ [rcvr &larr; self keywordMessage: rcvr macro: false]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑rcvr]<br></span><span style="font: italic 10pt serif">"cascade|expression"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">term  </span><span style="font: 10pt serif">| rcvr<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[rcvr &larr; self factor.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ type=aBinary do⦂ [rcvr &larr; self binaryMessage: rcvr assign: false].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑rcvr]<br></span><span style="font: italic 10pt serif">"keywordMessage"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">unaryMessage: rcvr assign: assign </span><span style="font: italic 10pt serif">"word ..."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| sel args<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[sel &larr; token. self advance.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">args &larr;</span><span class="tab" val="79"></span><span style="font: 10pt serif">[assign and⦂ type=aLeftArrow⇒ [sel &larr; sel + &rsquo;&larr;&rsquo;. self advance; expression] false].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑dest rcvr: rcvr selector: sel args: args]<br></span><span style="font: italic 10pt serif">"factor|messageChain"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Primary syntax</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">literal </span><span style="font: italic 10pt serif">"A Vector, UniqueString, String, or Number"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| t oldMark<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[type<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=aLeftPar⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[oldMark &larr; mark. self advance.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">t &larr; self read. type=aRightPar⇒ [self advance. ⇑t]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">mark &larr; oldMark. self notify: &rsquo;UNMATCHED&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">t &larr; [type≥aKeyword⇒ [token unique]; ≤aBinary⇒ [UST1◦(token+1)] token].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self advance. ⇑t]<br></span><span style="font: italic 10pt serif">"primary|read"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">primary<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[type<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=aWord⇒ [t &larr; dest variable: token. self advance. ⇑t];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=aLeftPar⇒ [⇑self subExpression];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=aNumber⇒ [t &larr; dest literal: token. self advance. ⇑t];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=aString⇒ [t &larr; dest literal: token. self advance. ⇑t];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=aHand⇒ [self advance.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">type=aRightPar or⦂ type=0⇒ [self notify: &rsquo;EXPECTED LITERAL&rsquo;]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑dest literal: self literal]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self notify: &rsquo;OBJECT EXPECTED&rsquo;]<br></span><span style="font: italic 10pt serif">"factor|expression"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">read </span><span style="font: italic 10pt serif">"A sequence of literals"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s &larr; (Vector new: 10) asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ (type=aRightPar or⦂ type=0) do⦂ [s next &larr; self literal].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑s contents]<br></span><span style="font: italic 10pt serif">"literal"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">subExpression </span><span style="font: italic 10pt serif">"(...)"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| expr<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self advance. expr &larr; self expression.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">type=aRightPar⇒ [self advance. ⇑expr]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self notify: &rsquo;NOT EXPECTED IN A (SUBEXPRESSION)&rsquo;]<br></span><span style="font: italic 10pt serif">"primary"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Suspension</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">advance </span><span style="font: italic 10pt serif">"Switch from the parser to the reader to obtain another token."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[mark &larr; source position- [type&gt;aBinary⇒ [1] 0].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">oppositeCourt &larr; thisContext swapSender: oppositeCourt]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">mustBeDone<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[type=0⇒ [self terminate] self notify: &rsquo;UNEXPECTED CONSTRUCT&rsquo;]<br></span><span style="font: italic 10pt serif">"Generator compile|Generator evaluate"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">notify: errorString </span><span style="font: 10pt serif">| delims<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[source skip: mark - source position.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">delims &larr; ↪(011 012  014 015 040).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ (delims has: source peek) do⦂ [source next].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[source myend≡false⇒ [source skip: 1]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dest abortWith: errorString]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">resume </span><span style="font: italic 10pt serif">"The reader has supplied another token; resume the parser."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[oppositeCourt &larr; thisContext swapSender: oppositeCourt]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">terminate<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[dest≡nil⇒ [] dest terminate. dest &larr; nil].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[oppositeCourt≡nil⇒ [] oppositeCourt release. oppositeCourt &larr; nil]]<br></span><span style="font: italic 10pt serif">"mustBeDone|Generator abortWith|Context variableNamesInto"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪Parser under: &rsquo;Compiler&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"ParseStack"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;ParseStack&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;position length&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I keep track of the current and high position of the stack that will be needed by code being compiled.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[length &larr; position &larr; 0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Changes</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pop: n<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(position &larr; position - n) &lt; 0⇒ [user notify: &rsquo;Parse stack underflow&rsquo;]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">push: n<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(position &larr; position + n) &gt; length⇒ [length &larr; position]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Results</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">length<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑length]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">position<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑position]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪ParseStack under: &rsquo;Compiler&rsquo;.</span></div>
    <div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">&rsquo;From Smalltalk 5.5k XM November 24 on 22 November 1980 at 2:57:08 am.&rsquo;<br></span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">"ParagraphPrinter"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;ParagraphPrinter&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;frame "&lt;Rectangle&gt; usable area on page"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">leading "&lt;Integer&gt; paragraph leading"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">style "&lt;TextStyle&gt; for paragraphs"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">strm "&lt;Stream&gt; for output"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;defaultframe defaultleading &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>Provides a stream-like interface for printing a succession of paragraphs on a Bravo or Press file.  The margins, leading, and style are settable instance variables.  BravoPrinter and PressPrinter each override some messages</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit </span><span style="font: 10pt serif">| inch<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[inch &larr; 2540.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"1 inch in micas"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">defaultframe &larr;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(0.75*inch) asInteger⌾(1*inch) rect: (7.75*inch) asInteger⌾(10*inch).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">defaultleading &larr; 0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self frame &larr; self defaultframe.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self leading &larr; defaultleading.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self style &larr; DefaultTextStyle]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">of: strm</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Access to state</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">defaultframe </span><span style="font: 10pt serif">[⇑defaultframe]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">defaultleading </span><span style="font: 10pt serif">[⇑defaultleading]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">frame </span><span style="font: 10pt serif">[⇑frame]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">frame &larr; frame</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">leading &larr; leading</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">style &larr; style</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Writing</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">print: para</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"A dummy, subclasses will override"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strm append: para text]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Class stuff</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printchanges: lis </span><span style="font: 10pt serif">| selector class heading old mes s delFlg<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">prints Changes format:</span><span style="font: 10pt serif"> (&rsquo;class message&rsquo; &rsquo;class message&rsquo; ...)<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">or alternate format:</span><span style="font: 10pt serif"> (class (message ...) class () ...) </span><span style="font: italic 10pt serif">or both<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">If an element appears in the list of the form &rsquo;~class message&rsquo;, this puts out a <br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">line causing the system to forget that method.  These come after any additons,<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">owing to the sort on Changes"</span><span style="font: 10pt serif"><br>  [lis empty⇒ [⇑lis]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user displayoffwhile⦂ [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">lis &larr; lis asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">old &larr; mes &larr; false.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ class do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">get next class, selector pair</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[delFlg&larr; false.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">mes and⦂ (selector &larr; mes next)⇒ ["</span><span style="font: italic 10pt serif">more of alternate form</span><span style="font: 10pt serif">"]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s &larr; lis next⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s is: UniqueString⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">class &larr; Smalltalk lookup: s.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">mes &larr; lis next asStream.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">selector &larr; mes next]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">Changes format</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s &larr; s asStream.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s peek=126 "~"⇒[s next. "take it off stream" delFlg&larr; true]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">class &larr; Smalltalk◦(s upto: 040) unique.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">selector &larr; s upto: 040.]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">class &larr; false].<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">delFlg⇒[self printForget: selector class: class]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"same, different or no class"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[old ≡ class⇒ []<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[old⇒ [old endCategoryOn: self; endChangesOn: self]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">class ≡ false⇒ ["</span><span style="font: italic 10pt serif">finished</span><span style="font: 10pt serif">"]<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user cr; show: class title.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">old &larr; class.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">class startChangesOn: self.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">heading &larr; &rsquo;As yet unclassified&rsquo;].<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">class≡false⇒ []<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user space; show: selector.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s &larr; class organization invert: (selector &larr; selector unique).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s⇒[[s ≠ heading⇒[class startCategory: (heading &larr; s) on: self]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">class printMethod: selector on: self]]]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printclass: class </span><span style="font: 10pt serif">| c first [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">class is: Vector⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">first &larr; true.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ c from: class do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[first⇒ [first &larr; false] self nextpage].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self printclass: c]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user displayoffwhile⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[class is: UniqueString⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[class &larr; Smalltalk◦class]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user cr; show: class title.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">class paraprinton: self]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printForget: selector class: class<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"Print a line that causes a message to be forgotten"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user cr; show: &rsquo;~&rsquo;+class title+&rsquo; &rsquo;+selector.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self print:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(class title + &rsquo; derstands: ↪&rsquo; + selector + &rsquo;.<br>&rsquo;) asParagraph]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">stamp </span><span style="font: 10pt serif">| s t [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">t &larr; user now "date and time".<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s &larr; Stream default.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s append: &rsquo;&rsquo;&rsquo;From &rsquo;; append: user version;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">append: &rsquo; on &rsquo;; print: t◦1;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">append: &rsquo; at &rsquo;; print: t◦2;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">append: &rsquo;.&rsquo;&rsquo;&rsquo;; cr.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self print: s contents asParagraph]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Closing</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">close </span><span style="font: 10pt serif">[strm close]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪ParagraphPrinter under: &rsquo;Paragraph printing&rsquo;.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">ParagraphPrinter classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"BravoPrinter"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;BravoPrinter&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: ParagraphPrinter<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;eject "Eject page before next paragraph if true"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>Prints Paragraphs in Bravo format</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[super init.  eject &larr; false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Writing</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">eject<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strm next &larr; 014; cr]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">nextpage<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[eject⇒ [self eject] eject &larr; true]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">print: para </span><span style="font: 10pt serif">| l r<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[eject⇒ [self eject. eject &larr; false]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm append: para text; next&larr; 032.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"&uarr;Z"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">l &larr; frame origin x.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">r &larr; frame corner x.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[l≠self defaultframe origin x⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strm append: &rsquo;l&rsquo;; print: l]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[r≠self defaultframe corner x⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strm append: &rsquo;z&rsquo;; print: r]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[leading≠self defaultleading⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strm append: &rsquo;e&rsquo;; print: leading]].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"any other run info and cr"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">para bravoRuns: strm.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪BravoPrinter under: &rsquo;Paragraph printing&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"PressPrinter"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;PressPrinter&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: ParagraphPrinter<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;page "&lt;Integer&gt; current page number"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">ypos "&lt;Integer&gt; current y position on page"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">press "&lt;PressFile&gt; for output"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;defaultframe &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>Prints Paragraphs in Press format</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit </span><span style="font: 10pt serif">| inch<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[inch &larr; 2540.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"1 inch in micas"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">defaultframe &larr;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(1.1*inch) asInteger⌾(1*inch) rect: (7.75*inch) asInteger⌾(10*inch)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">defaultframe </span><span style="font: 10pt serif">[⇑defaultframe]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init </span><span style="font: 10pt serif">[super init. page &larr; 1. ypos &larr; frame maxY]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">of: strm </span><span style="font: 10pt serif">[press &larr; PressFile new of: strm]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">press: press</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Writing</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">nextpage </span><span style="font: 10pt serif">[self nextpage: true]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">nextpage: h </span><span style="font: 10pt serif">| n [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">press page.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">page &larr; page+1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ypos &larr; frame maxY.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">h⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">n &larr; page asString.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">press setp: frame maxX+800 ⌾ (ypos + 960);<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">selectfont: (press fontindex: 0 style: DefaultTextStyle) - 1;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">append: n;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">showchars: n length]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">print: para </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self print: para in: (<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">Rectangle new origin: frame origin corner: frame maxX ⌾ ypos)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">print: para in: rect </span><span style="font: 10pt serif">| result oldpara [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[rect width = 0 or⦂ rect height = 0⇒ [user notify: &rsquo;zero dimension&rsquo;]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">para is a Paragraph-like object (TextImage, Form, etc.)</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">oldpara &larr; para.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ ((result &larr; para presson: press in: rect) is: Integer) do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">rest of para goes on next page</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self nextpage.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">para &larr; result.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">rect &larr; rect minX ⌾ frame minY rect: rect maxX ⌾ ypos].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">original para can hide information. if it split across page boundaries,<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">the format may vary. other completion flags can be added later</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">oldpara hidePress: press complete: [oldpara≡para⇒ [0] 1].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ypos &larr; result]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Closing</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">close<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[press close]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">toPrinter </span><span style="font: 10pt serif">[press toPrinter]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Projector behavior</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪PressPrinter under: &rsquo;Paragraph printing&rsquo;.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">PressPrinter classInit</span></div>
    <div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">&rsquo;From Smalltalk 5.5k XM November 24 on 22 November 1980 at 2:57:08 am.&rsquo;<br></span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">"BitRect"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;BitRect&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Rectangle<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;title  "&lt;String&gt; title of picture"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">stripheight  "&lt;Integer&gt; scan lines in a buffer (private)"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">data  "&lt;Vector&gt; of Strings.  Saves the bits in the Rectangle"&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;defaultpic &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>BitRect is a Rectangle that remembers the bits within it.<br>To create and edit one, say:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">BitRect new fromuser edit.<br>This installs a BitRectEditor in the scheduler and starts it up.<br>The editor is explained in BitRectEditor.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">the default picture is a gray rectangle</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">defaultpic &larr; BitRect new filin: &rsquo;defaultpic&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">default </span><span style="font: 10pt serif">[⇑defaultpic recopy]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fromuser<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self title: &rsquo;BitRect&rsquo; in: Rectangle new fromuser.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self saveScreenBits]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">origin: origin corner: corner title: title stripheight: stripheight data: data</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">title: title in: rect </span><span style="font: 10pt serif">| nStrips i strips<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[origin&larr;rect origin.  corner&larr;rect corner.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">the strip height is chosen so that each bitstring is about 2048 bytes</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">stripheight&larr;1023/((self extent x + 15)/16).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nStrips&larr;(self extent y+stripheight-1)/stripheight.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">data&larr;Vector new: nStrips.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strips&larr;self strips.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: nStrips do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[data◦i&larr;String new: (strips◦i) bitStringLength]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Access to parts</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">data </span><span style="font: 10pt serif">[⇑data]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">title </span><span style="font: 10pt serif">[⇑title]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Rectangle Protocol</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">= x </span><span style="font: 10pt serif">[⇑self≡x]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">bitsOntoStream: strm </span><span style="font: 10pt serif">| bits<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ bits from: data do⦂ [strm append: bits]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">corner&larr;x </span><span style="font: 10pt serif">[self growby: x-corner]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">extent&larr;x </span><span style="font: 10pt serif">[self growby: x-self extent]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">growby: change </span><span style="font: 10pt serif">| old<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[old&larr;BitRect new origin: origin corner: corner title: title<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">stripheight: stripheight data: data.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self title: title in: (origin rect: corner+change).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self copyBitsFrom: old]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">growto: x </span><span style="font: 10pt serif">[self growby: x-corner]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hash </span><span style="font: 10pt serif">[user croak] primitive: 46</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">height&larr;h </span><span style="font: 10pt serif">[self growby: 0⌾(h-self extent y)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strm append: &rsquo;a BitRect&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">width&larr;w </span><span style="font: 10pt serif">[self growby: (w-self extent x)⌾0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Editing</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">copyBitsFrom: other<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| clippedStrip i j myStrips otherStrips myStrip otherStrip<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">copy all bits from </span><span style="font: italic 10pt serif; text-decoration: underline">other</span><span style="font: italic 10pt serif"> that are within my area</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">myStrips&larr;self strips.  otherStrips&larr;other strips.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: myStrips length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ j to: otherStrips length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[myStrip&larr;myStrips◦i.  otherStrip&larr;otherStrips◦j.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">clippedStrip&larr;myStrip intersect: otherStrip.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">clippedStrip empty⇒[]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">BitBlt init function&larr;0;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">destbase&larr;data◦i;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">destraster&larr;myStrip width+15/16;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">dest&larr;clippedStrip origin-myStrip origin;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">extent&larr;clippedStrip extent;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">sourcebase&larr;other data◦j;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">sourceraster&larr;otherStrip width+15/16;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">source&larr;clippedStrip origin-otherStrip origin;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">checksandcall]]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">edit </span><span style="font: 10pt serif">| a<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user leaveTop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">a&larr;BitRectEditor new picture: self.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">a takeCursor; enter.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user restartup: a]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Showing</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">saveScreenBits </span><span style="font: 10pt serif">| strips i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strips&larr;self strips.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: strips length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strips◦i bitsIntoString: data◦i mode: storing clippedBy: nil]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">show </span><span style="font: 10pt serif">| strips i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strips&larr;self strips.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: strips length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strips◦i bitsFromString: data◦i]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">strips   </span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">return a vector of strips (Rectangles)</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| nStrips strips stripOrigin stripExtent i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(nStrips&larr;data length)=1⇒[⇑self inVector]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strips&larr;Vector new: nStrips.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">stripOrigin&larr;origin.  stripExtent&larr;self width⌾stripheight.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: nStrips-1 do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strips◦i&larr;Rectangle new origin: stripOrigin extent: stripExtent.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">stripOrigin&larr;stripOrigin+(0⌾stripheight)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strips◦nStrips&larr;Rectangle new origin: stripOrigin corner: corner.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑strips]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Filin and filout</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">filin: title </span><span style="font: 10pt serif">| f i x y rect strips  </span><span style="font: italic 10pt serif">"read bits from a file"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[f&larr;dp0 oldFile: (title concat: &rsquo;.pic.&rsquo;).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f readonly.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f end⇒[f close. user notify: &rsquo;no data&rsquo;]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">x&larr;f nextword.  y&larr;f nextword.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rect&larr;Rectangle new origin: [origin is: Point⇒[origin] 0⌾0] extent: x⌾y.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self title: title in: rect.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">stripheight≠f nextword⇒[user notify: &rsquo;strip heights dont match&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strips &larr; self strips.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: strips length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[f into: data◦i].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f close]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">filout </span><span style="font: 10pt serif">| f i  "</span><span style="font: italic 10pt serif">write bits on a file</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[f &larr; dp0 file: (title concat: &rsquo;.pic.&rsquo;).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f nextword &larr; self extent x.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f nextword &larr; self extent y.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f nextword &larr; stripheight.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: data do⦂ [f append: i].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f close]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Press</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">length </span><span style="font: 10pt serif">[⇑self bitStringLength]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">presson: press in: r </span><span style="font: 10pt serif">| w h hs scale w16 y [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">scale &larr; press scale.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">h &larr; self height.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(hs  &larr; scale*h) &gt; r height⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"not enough room left on current page.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">assume for now that it will at least fit on an entire page"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">w &larr; self width.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">w16 &larr; w + 15 | 16 "width to next word boundary".<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"with w, prints on viola but not on spruce.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">with w16, prints on spruce with garbage on end"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">press setp: 0⌾(y &larr; r corner y - hs);<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">dots⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">press setcoding: 1 "bitmap" dots: w16 lines: h;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">setmode: 3 "to right and to bottom";<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">setsizewidth: scale*w16 height: hs;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">setwindowwidth: w16 height: h;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">dotsfollow.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self bitsOntoStream: press data].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑y]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪BitRect under: &rsquo;Picture Editor&rsquo;.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">BitRect classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"BitRectEditor"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;BitRectEditor&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Window<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;tool  "&lt;BitRectTool&gt; the current tool"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">picture  "&lt;BitRect&gt; the picture we are working on"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">dirty  "false if picture has not been modified"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">saveActionPic saveToolPic  "buffers for saving background" &rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;tools toolpic actionbuttons actionpic windowmenu &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>BitRectEditor edits BitRects.<br>To create, say:<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">BitRect new fromuser edit.<br>This installs a BitRectEditor in the scheduler and starts it up.<br>The editing tools are to the left of the picture.  (The first one looks like a doodle).  They are: draw-thin, erase, straightedge, gray-block, paintbrush, magnifier.  The actions for the tools are displayed above the picture.<br>See BitRectTool for explanations of the actions.<br><br>CAUTION: this ordering is arbitrary.  It is currently possible to set a new action for any of the tools, so that if you are not careful, the straightedge will start being a magnifier or whatever.  This should get fixed eventually.<br><br>tools = a RadioButtons. Each button owns a BitRectTool (the active one is held in tool).<br>actionbuttons = a Vector of RadioButtons.  The groups of buttons are: action, mode, pen width, gray, and grid.<br>toolpic = BitRect of icons for the tools (at side of picture).<br>actionpic = BitRect of icons for the parts of a tool (above picture)<br>windowmenu = menu for bluebug.<br><br>To edit a copy of the tool picture, say<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">newpic&larr;(BitRectEditor◦↪toolpic) recopy.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">newpic edit.<br>To install this copy as the menu picture, say<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">BitRectEditor new toolpic: newpic recopy.<br>Do the analogous thing to edit the action picture.<br>Caution: the editor blows up if you edit the tool picture itself and not a copy.<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">actionpic: a </span><span style="font: 10pt serif">[actionpic &larr; a]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit </span><span style="font: 10pt serif">| t i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t &larr; Vector new: 6.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: t length do⦂ [t◦i &larr; BitRectTool new init].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tools &larr; (RadioButtons new) vec: t at: 0⌾0 width: 20.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">windowmenu &larr; Menu new string: &rsquo;under<br>move<br>grow<br>close<br>filout<br>printbits&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">actionpic&larr;BitRect new filin: &rsquo;actionpic&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">toolpic&larr;BitRect new filin: &rsquo;toolpic&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self initmenu1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">initmenu1 </span><span style="font: 10pt serif">| s z<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s &larr; Vector new: 5. z &larr; 20.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s◦1 &larr; (RadioButtons new) vec: ↪(setbrush paint block draw line blowup) at: 0⌾0 height: z. "</span><span style="font: italic 10pt serif">action</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s◦2 &larr; (RadioButtons new) vec: (black, dkgray, gray, ltgray, white) at: 0⌾0 height: z. "</span><span style="font: italic 10pt serif">tone</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s◦3 &larr; (RadioButtons new) vec: (0, 1, 2, 3) at: 0⌾0 height: z. "</span><span style="font: italic 10pt serif">mode</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s◦4 &larr; (RadioButtons new) vec: (1, 2, 4, 8) at: 0⌾0 height: z. "</span><span style="font: italic 10pt serif">width</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s◦5 &larr; (RadioButtons new) vec: (1, 2, 4, 8, 16, 32) at: 0⌾0 height: z. "</span><span style="font: italic 10pt serif">grid</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">actionbuttons &larr; s.]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">picture: picture<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[tool &larr; tools push: 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self frame: (picture origin rect: picture corner)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">toolpic: a </span><span style="font: 10pt serif">[toolpic &larr; a]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Window protocol</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">bluebug </span><span style="font: 10pt serif">| <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">picture is: BitImage⇒ [ ⇑ picture fromrectangle: (picture rectangle)]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">windowmenu bug<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> =1 ⇒[self leave. ⇑exitflag &larr; false];  "</span><span style="font: italic 10pt serif">under</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">=2 ⇒[self leave; newframe; enter];  "</span><span style="font: italic 10pt serif">move</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">=3 ⇒[self grow  "</span><span style="font: italic 10pt serif">grow</span><span style="font: 10pt serif">"];<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">=4 ⇒[self leave; erase.   "</span><span style="font: italic 10pt serif">close</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> user unschedule: self. ⇑false];<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">=5 ⇒[self leave. picture filout. self enter];  "</span><span style="font: italic 10pt serif">filout</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">=6 ⇒[self print]</span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">press file</span><span style="font: 10pt serif">"]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">enter </span><span style="font: 10pt serif">| start pt b<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">Periodically check if the mouse is still in the frame.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">If not, stop showing the picture</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">super show.  self lostMouse⇒[⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">picture show.  dirty&larr;false.  self lostMouse⇒[⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ b from: actionbuttons do⦂ [b reset].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">show action menu above the picture</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">start&larr;frame origin-1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pt &larr; start-(0⌾actionpic extent y).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">actionpic moveto: pt.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">saveActionPic&larr;actionpic bitsIntoString.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self lostMouse⇒[⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">last point I can return before having to restore bits under menus</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">actionpic show.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pt &larr; actionbuttons◦1 moveto: pt. "</span><span style="font: italic 10pt serif">action</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pt &larr; actionbuttons◦3 moveto: pt. "</span><span style="font: italic 10pt serif">mode</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pt &larr; actionbuttons◦4 moveto: pt. "</span><span style="font: italic 10pt serif">width</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">show the next bank of action buttons</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pt &larr; start-(0⌾(actionpic extent y+1/2)).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pt &larr; actionbuttons◦2 moveto: pt.  "</span><span style="font: italic 10pt serif">tone</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pt &larr; actionbuttons◦5 moveto: pt.  "</span><span style="font: italic 10pt serif">grid</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tool brushpt: (pt &larr; pt+(7⌾7)).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(tool brush) moveto: pt; show.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"show the tool pic"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pt &larr; start-(toolpic extent x⌾0).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">toolpic moveto: pt.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">saveToolPic &larr; toolpic bitsIntoString.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">toolpic show.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tools moveto: pt;  setvalue: tool.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tool frame: frame; showon: actionbuttons.]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fixframe: r<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[picture moveto: r origin.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">r corner&larr;picture corner.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑r]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">grow </span><span style="font: 10pt serif">| oldframe newframe pt r<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self leave.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">newframe&larr;picture origin rect: picture corner.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">CornerCursor showwhile⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pt&larr;user mp+16.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ user nobug do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[newframe corner&larr;pt.  newframe comp.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pt&larr;user mp+16.  newframe comp].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ user anybug do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[newframe corner&larr;pt.  newframe comp.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pt&larr;user mp+16.  newframe comp]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">clear unused areas from old picture to background,<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">and clear new picture areas to white</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">oldframe&larr;picture inset: ¬2⌾¬2.  "</span><span style="font: italic 10pt serif">¬2 is for erasing old border</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ r from: (oldframe minus: newframe) do⦂ [r clear: background].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ r from: (newframe minus: picture) do⦂ [r clear: white].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">picture title: picture title in: newframe; saveScreenBits.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self frame: newframe; show; takeCursor; enter]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">leave<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[nil≡saveActionPic⇒[]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> actionpic bitsFromString: saveActionPic.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> saveActionPic &larr; nil.].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> [nil≡ saveToolPic⇒[]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> toolpic bitsFromString: saveToolPic.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> saveToolPic&larr;nil].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[dirty⇒[picture saveScreenBits. dirty &larr; false]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">frame border: 3 color: white]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">lostMouse </span><span style="font: 10pt serif">[⇑(frame has: user mp)≡false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">outside </span><span style="font: 10pt serif">| pt<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[toolpic has: (pt&larr;user mp)⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user redbug⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[tool&larr;tools bug: pt. tool frame: frame; showon: actionbuttons]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">actionpic has: pt⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user redbug⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[tool setfrom: actionbuttons]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">redbug </span><span style="font: 10pt serif">[dirty&larr;true.  tool redbug]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">showtitle   </span><span style="font: italic 10pt serif">"The BitRectEditor have a menu where the title used to be"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">title </span><span style="font: 10pt serif">[⇑picture title]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">tool </span><span style="font: 10pt serif">[⇑ tool]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">yellowbug<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[picture is: BitImage⇒ [ picture yellowbug] <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪BitRectEditor under: &rsquo;Picture Editor&rsquo;.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">BitRectEditor classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"BitRectTool"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;BitRectTool&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;action "&lt;UniqueString&gt; the current action"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">pencil  "&lt;Turtle&gt; used for draw or straight-edge"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">brush  "&lt;BitRect&gt; source for painting"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">mode  "&lt;Integer&gt; how brush combines with the destination"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">tone  "&lt;Integer&gt; a spatial half-tone color (4 bits by 4 bits)"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">grid  "&lt;Integer&gt; all mouse points are rounded to this"&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;blowupScale graypens brushpt &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>A BitRectTool paints on the screen.<br>A tool is a combination of action, mode, pen-width, gray, and grid.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">action is one of: make-brush, paint, block-of-gray, draw, straight-edge, magnify.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">mode is one of: store, or, xor, and.  (how tool is combined with picture)<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">pen-width is 1, 2, 4, or 8.  (width of the pen)<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">gray is one of: black, darkgray, gray, lightgray, white.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">grid is one of: 1, 2, 4, 8, 16, 32.   (minimum spacing of mouse points)<br>Menus for each part of a tool appear above the picture (in the same order).<br>Some actions do not use certain of the other parts of a tool.<br>(example: Block-of-gray does not use pen-width.)<br><br>brushpt = Point in the menu where brush is shown.<br>graypens = Vector of Strings of bits in pens.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Tool action</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">block </span><span style="font: 10pt serif">[self getRectangle color: tone mode: mode]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">blowup </span><span style="font: 10pt serif">| smallRect bigRectFrame<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[smallRect&larr;self getRectangle.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bigRectFrame &larr; Rectangle new origin: smallRect corner<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">extent: 4⌾4 + (smallRect  extent*blowupScale).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">smallRect empty or⦂ bigRectFrame bitStringLength&gt;4000⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pencil frame flash.  ⇑nil].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user screenrect has: bigRectFrame corner⇒[] <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">bigRectFrame moveto: smallRect origin-bigRectFrame extent.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user screenrect has: bigRectFrame origin⇒[]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">can&rsquo;t find a space for blown up image</span><span style="font: 10pt serif">"</span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pencil frame flash.  ⇑nil].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self blowup: smallRect to: bigRectFrame]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">blowup: smallRect to: bigRectFrame<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| bigRect box pt i turt flag bits<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[bits &larr; bigRectFrame bitsIntoString.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bigRect &larr; bigRectFrame inset: 2⌾2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">smallRect blowup: bigRect origin by: blowupScale.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">turt&larr;Turtle init.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">box &larr; 0⌾0 rect: (blowupScale-1)⌾(blowupScale-1).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">keep editing in blowup mode until the user presses a button<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">outside the big rect</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ flag do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[bigRect has: (pt &larr; user mp)⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[box moveto: bigRect origin + (i &larr; pt-bigRect origin|blowupScale).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">turt place: smallRect origin + (i/blowupScale).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user redbug⇒[box color: black mode: storing. <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">turt black; go: 0]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user yellowbug⇒[box color: white mode: storing. <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">turt white; go: 0]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user bluebug⇒[bigRect flash]]</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user anybug ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(bigRect inset: ¬5⌾¬5) has: pt⇒[bigRect flash]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">quit</span><span style="font: 10pt serif">" flag&larr;false]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bigRectFrame bitsFromString: bits]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">brush </span><span style="font: 10pt serif">[⇑brush]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">brush: sourceRect   </span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">use the bits in the BitRect </span><span style="font: italic 10pt serif; text-decoration: underline">sourceRect</span><span style="font: italic 10pt serif"> as a brush</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| minpt maxpt pt offset<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">The inner painting loop should be fast - all the extra foliage below<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">is to move tests outside of the inner loop</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sourceRect moveto: brushpt; show.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">minpt&larr;self frame origin.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">maxpt&larr;self frame corner-sourceRect extent.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">offset&larr;sourceRect extent/2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">If mode is storing or oring, use brush command, otherwise blt.</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Use the unclipped form of brushing  and grid=1 when possible</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[mode&lt;xoring and⦂ grid=1⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[while⦂ user redbug do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[minpt≤(pt&larr;user mp-offset) and⦂ pt≤maxpt⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[sourceRect brush: pt mode: mode color: tone]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">sourceRect brush: pt mode: mode color: tone clippedBy: self frame]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> mode≥xoring and⦂ grid=1⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[while⦂ user redbug do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[minpt≤(pt&larr;user mp-offset) and⦂ pt≤maxpt⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[sourceRect blt: pt mode: mode]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">sourceRect blt: pt mode: mode clippedBy: self frame]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> mode&lt;xoring⇒   "</span><span style="font: italic 10pt serif">grid is &gt; 1</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[while⦂ user redbug do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[minpt≤(pt&larr;self mpOnGrid-offset) and⦂ pt≤maxpt⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[sourceRect brush: pt mode: mode color: tone]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">sourceRect brush: pt mode: mode color: tone clippedBy: self frame]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> "</span><span style="font: italic 10pt serif">grid is &gt; 1 and mode≥xoring</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ user redbug do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[minpt≤(pt&larr;self mpOnGrid-offset) and⦂ pt≤maxpt⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[sourceRect blt: pt mode: mode]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">sourceRect blt: pt mode: mode clippedBy: self frame]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">draw<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[tone=white or⦂ tone=black⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pencil place: self mpOnGrid-pencil frame origin.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">grid=1⇒</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">make drawing with grid 1 fast</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[while⦂ user redbug do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pencil goto: user mp-pencil frame origin]]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ user redbug do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pencil goto: self mpOnGrid-pencil frame origin]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self brush: graypens◦pencil width]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">getRectangle </span><span style="font: 10pt serif">| rect newrect start t   </span><span style="font: italic 10pt serif">"rect must be in my frame"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">the rect-newrect stuff is so that the complementing stays<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">on for a while</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">start&larr;self mpOnGrid.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rect&larr;newrect&larr;(Rectangle new origin: start corner: start)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">intersect: self frame.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">move the cursor slightly so that the user will notice the rectangle<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">being complemented</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user cursorloc&larr;start+4.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ user anybug do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[rect&larr;newrect.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">rect comp.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">t&larr;self mpOnGrid.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">newrect&larr;(Rectangle new origin: (start min: t) corner: (start max: t))<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">intersect: self frame.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">rect comp].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑rect]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">line </span><span style="font: 10pt serif">| start end width</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[start&larr;end&larr;self mpOnGrid-pencil frame origin.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">width&larr;pencil width.  pencil xor; width: 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ user redbug do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[end&larr;self mpOnGrid-pencil frame origin.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pencil xor; place: start; goto: end; place: start; goto: end].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[tone=white⇒[pencil white] pencil black].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pencil width: width; place: start; goto: end]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">mode<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑ mode]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">mpOnGrid   </span><span style="font: italic 10pt serif">"return mouse point rounded to </span><span style="font: italic 10pt serif; text-decoration: underline">grid</span><span style="font: italic 10pt serif">"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑user mp+(grid/2) | grid]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">paint<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self brush: brush]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">redbug </span><span style="font: 10pt serif">[self perform: action]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">setbrush </span><span style="font: 10pt serif">| rect<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[rect&larr;self getRectangle.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rect empty or⦂ 50⌾50&lt;rect extent⇒[pencil frame flash].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">brush color: white mode: storing.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">brush title: &rsquo;brush&rsquo; in: rect; saveScreenBits.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">brush moveto: brushpt; show.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">action &larr; ↪paint]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">shade </span><span style="font: 10pt serif">| p1 p2 a b t p r vs "down on redbug is black place.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">up on redbug is white place.  Subsequent redbugs<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">paint a shade of gray depending on position between<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">black and white (and beyond white to black again).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Yellow or blue bug terminates."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[until⦂ user redbug do⦂ [p1 &larr; user mp]. "black"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ user nobug do⦂ [p2 &larr; user mp]. "white"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">vs &larr; ↪( ¬1  ¬1025  ¬1089  ¬585  ¬4681  ¬6731  ¬22058  ¬27031   ¬26986  ¬31191  ¬32108   5160  5128  8321  1025 01 0).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">r &larr; 0⌾0 rect: 10⌾10.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">b&larr;(p1-p2). b &larr; b x asFloat ⌾ b y asFloat.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">a &larr; b x * b x + (b y * b y) /16.0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ (user yellowbug or⦂ user bluebug) do⦂<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user redbug ⇒[p&larr;user mp.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">t &larr; b* (p-p2).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">t &larr; (t x + t y /a) asInteger abs min: 16.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">brush brush: p mode: mode color: vs◦(17-t)]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">tone<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑ tone]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Tool selection</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">brushpt: pt  </span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">set the point at which the current brush will be shown</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[brushpt&larr;pt]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">frame </span><span style="font: 10pt serif">[⇑pencil frame]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">frame: f </span><span style="font: 10pt serif">[pencil frame: f]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">setfrom: butvec </span><span style="font: 10pt serif">| pt<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[butvec◦1 has: (pt &larr; user mp) ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[action &larr; butvec◦1 bug: pt]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">butvec◦2 has: pt ⇒[tone &larr; butvec◦2 bug: pt.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">tone=white ⇒[pencil white] pencil black]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">butvec◦3 has: pt ⇒[mode &larr; butvec◦3 bug: pt]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">butvec◦4 has: pt ⇒[pencil width: (butvec◦4 bug: pt)]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">butvec◦5 has: pt ⇒[grid &larr; butvec◦5 bug: pt]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">showon: butvec<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[butvec◦1 setvalue: action.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">butvec◦2 setvalue: tone.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">butvec◦3 setvalue: mode.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">butvec◦4 setvalue: pencil width.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">butvec◦5 setvalue: grid]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Class initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit </span><span style="font: 10pt serif">| rect saveBits t i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[blowupScale&larr;4.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"make a vector of gray pens"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rect &larr; 0⌾0 rect: 9⌾9.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">saveBits&larr;rect bitsIntoString.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">t &larr; Turtle init.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">graypens &larr; Vector new: 8.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: 8 do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t width: i.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">rect clear: white. <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">t place: 4⌾4; go: 0. <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">graypens◦i &larr; BitRect new title: &rsquo;graypen&rsquo; in: rect.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(graypens◦i) saveScreenBits].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rect bitsFromString: saveBits]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(pencil &larr; Turtle new) init; black; width: 2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(brush &larr; BitRect new) title: &rsquo;brush&rsquo; in: (0⌾0 rect: 16⌾16).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tone &larr; black. mode &larr; 0. grid &larr; 1. action &larr; ↪draw]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪BitRectTool under: &rsquo;Picture Editor&rsquo;.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">BitRectTool classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"RadioButtons"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;RadioButtons&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;vec  "&lt;Vector&gt; values corresponding to the buttons"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">cur  "&lt;Integer&gt; button currently selected"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">rect  "&lt;Rectangle&gt; contains all the buttons"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">size  "&lt;Integer&gt; width or height of a button"&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>A RadioButtons is a row or column of square regions ("buttons") on the display screen.  There is always exactly one button pushed.  (RadioButtons is a model of the station selection buttons on a car radio.)  The pushed button has a black box around it.  Each button has a value associated with it, which is returned when the button is pressed.  RadioButtons will not destroy a menu picture (BitRect) displayed in its area, but the RadioButtons has no knowledge of the picture.<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Pushing a Button</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">bug: pt </span><span style="font: 10pt serif">| r a<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[r &larr; (pt - rect origin - (1⌾1)) / size.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">a &larr; r x + r y + 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self push: a]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">push: a<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self release: cur thenPush: a.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑vec◦(cur &larr; a)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">setvalue: v </span><span style="font: 10pt serif">| i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"if value has been lost, set self to 1"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i&larr;(vec find: v) max: 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self push: i.  ⇑i]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Init and State</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">has: pt </span><span style="font: 10pt serif">[⇑rect has: pt]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">moveto: pt<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[rect moveto: pt.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">cur &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑rect corner x ⌾ rect origin y]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">reset </span><span style="font: 10pt serif">[cur&larr;0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">value </span><span style="font: 10pt serif">[⇑vec◦cur]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">vec </span><span style="font: 10pt serif">[⇑vec]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">vec: vec at: r height: size<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[rect &larr; r rect: r+ ((vec length ⌾ 1)*size).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">cur &larr; 0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">vec: vec at: r width: size<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[rect &larr; r rect: r+ ((1 ⌾ vec length)*size).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">cur &larr; 0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Private</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">release: a thenPush: b </span><span style="font: 10pt serif">| boxer offset<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[a=b⇒[]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">offset &larr; [size=rect extent y⇒[size⌾0] 0⌾size].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[a≠0⇒[boxer &larr; Rectangle new origin: (offset*(a-1)+rect origin+1)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">extent: size⌾size-1.  boxer comp.  (boxer inset: 1⌾1) comp]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">b≠0⇒[boxer &larr; Rectangle new origin: (offset*(b-1)+rect origin+1)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">extent: size⌾size-1.  boxer comp.  (boxer inset: 1⌾1) comp]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪RadioButtons under: &rsquo;Picture Editor&rsquo;.</span></div>
    <div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">&rsquo;From Smalltalk 5.5k XM November 24 on 22 November 1980 at 2:57:08 am.&rsquo;<br></span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">"Etherworld"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;Etherworld&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sharing: EtherPool;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>This is, of course, the class that controls all of the basic ethernet operations.  There should not be more than one EtherWorld, and one, E, has to be defined for the system to work.    <br><br>In this implementation, and due to timing considerations, it is expected that the transmitter will post quite quickly;  thus, we disable interrupts and busy wait for its completion.<br><br>In general, the interrupt is only armed when we have started the receiver.  The Etherworld currently uses these input processes in the PrioityScheduler: <br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">IntProc, at IntProcLevel (14)  -- awakened when the device interrupts<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">InputProc, at InputProcLevel (13) -- distributes packets to sockets, <br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">allowing each  socket to then run.<br><br>Note that some of the timers may be on other levels.<br><br>The ethernet can be in one of several states:<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">if E ≡ nil, there is nothing<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">if E ~≡ nil, etherState can be ethAwake, ethAsleep, ethDead.<br><br>ethDead means E created, and classInit done, but nothing else.<br>ethAsleep means all data structures created, but no attempt to start.<br>ethAwake means it is up and running.<br><br>The messages wakeup,  sleep and kill move to one of those states.<br>Other messages are used for single transitions from adjacent states.<br><br>If you just want to temporarily prevent the device from running use etherStop and etherStart.<br>Should go to ethAsleep (use E sleep) if you quit, since may come up on a different machine.<br><br>The lights on the right side of the screen are Etherworld signals.  They mean  Etherworld awakened; packet addressed to the Alto received; packet being processed; output being sent; and input rejected.<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization/Termination</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit <br></span><span style="font: 10pt serif">[<br>"if this needs to be filed in again, execute this first<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Smalltalk declare: ↪EtherPool as: (SymbolTable new init: 32).<br><br>access variables from outside with (for example) with EtherPool◦↪ethAwake"<br><br>Smalltalk declare: ↪(E).<br><br>EtherPool declare: ↪( ethInPacNext checkIncomingCS  <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">IntProcLevel InputProcLevel ethIntBits<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">etherState ethAwake ethAsleep ethDead)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">as: (false,false,14,13,020,0,3,1,0).<br><br>EtherPool declare: ↪(  <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">NETNUM ALTONUM <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">freeQ justArrivedQ   <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sockeTable routingTable routingHopCount routingUpdateUser<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">IntProc InputProc broadcastFilter <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">IntLight InputLight OutputLight )]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">etherStart </span><span style="font: 10pt serif">"allows ether to start running again"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"makes sure the interrupt is on, and kicks the device"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">etherState=ethAwake ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[mem◦0601=0⇒ [mem◦0601&larr;ethIntBits]]. <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self SIO: 3.   "forces it to wake up again"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self notify: &rsquo;Attempt to etherStart when not awake!!.&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">etherStop </span><span style="font: 10pt serif">"temporarily shuts off the ether stuff"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">Top critical⦂ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">mem◦0601&larr;0.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self SIO: 3.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">mem◦0600 &larr; 0.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">Init </span><span style="font: 10pt serif">| i "</span><span style="font: italic 10pt serif">move from state ethDead to ethAsleep</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">if we were already running, bring it all down, just in case!!</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[etherState=ethDead ⇒ [] self kill]. "</span><span style="font: italic 10pt serif">now sure we are ethDead</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">NETNUM &larr; ALTONUM&larr;0.  "may get reset later"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self setLights.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(justArrivedQ&larr;(SafeQ new) of: (Vector new: 20)) enable.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[freeQ⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(freeQ&larr; (SafeQ new) of: (Vector new: 20)) enable.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: 10 do⦂ [freeQ next&larr; Pacbuf init]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">justArrivedQ disable].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ethInPacNext&larr; self freePacket.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sockeTable&larr; Dictionary new init: 10. <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">routingTable&larr; String new: 255.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">routingTable all &larr; 0. "1-255, 0 is special"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">routingHopCount &larr; String new: 255.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">routingHopCount all &larr; 8.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">routingUpdateUser &larr; RoutingUpdater init.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self installIntProc.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self installInputProc.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">IntProc enable.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">InputProc enable.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">etherState &larr; ethAsleep.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"we are still asleep, must do a wakeup to get numbers, start, etc."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">kill | socket </span><span style="font: 10pt serif">"shuts down ethernet and PUP world completely"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"Should free up all of the storage, etc.....<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">Would need to wakeup or Init, to get started again.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">Device may have been running"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">etherState=ethDead⇒[] "do nothing"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[etherState=ethAwake ⇒ [self sleep]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"everything now shut down"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ socket from: (sockeTable values) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[socket≡nil⇒[] socket kill]. <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">Top terminate: IntProcLevel; terminate: InputProcLevel.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">ethInPacNext⇒ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">ethInPacNext≡nil⇒ []<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">ethInPacNext locked⇒[ethInPacNext unlock]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">ethInPacNext &larr; false.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"Release the PQueues to avoid circular data structures"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[freeQ and⦂ freeQ≠nil⇒[freeQ release. freeQ &larr; nil]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[justArrivedQ≠nil⇒[justArrivedQ release. justArrivedQ &larr; nil]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[routingUpdateUser≡ nil⇒ [] routingUpdateUser release].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">routingUpdateUser &larr; routingTable &larr; routingHopCount &larr; nil.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">etherState &larr; ethDead.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">setLights<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[IntLight&larr; Rectangle new origin: 576⌾0 extent: 16⌾16.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">InputLight&larr; Rectangle new origin: 592⌾0 extent: 16⌾16.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">OutputLight&larr;Rectangle new origin: 576⌾16 extent: 16⌾16]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sleep </span><span style="font: 10pt serif">| socket "be sure to do this before a user quit" <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">etherState=ethDead ⇒ [self Init] "that is, go from dead to asleep"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">etherState=ethAsleep ⇒ [] "already asleep"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">etherState=ethAwake ⇒ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">["try to shut down gracefully"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ socket from: (sockeTable values) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[socket≡nil⇒[] socket sleep]. "warn the sockets, leaves them in table"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self etherStop.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">etherState&larr;ethAsleep.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"when next we wake up, may be on a new machine/net"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"when next we wake up, may be on a new machine/net"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">wakeup </span><span style="font: 10pt serif">| socket "Try to get everything up and running" <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">etherState=ethAwake ⇒ [self etherStart] "do nothing, kick the receiver".<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[etherState=ethDead ⇒ [self sleep]]. "that is, go from dead to asleep"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">etherState=ethAsleep ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">["this is the tricky one, need to get our machine # and routing table.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">may have come up on a different network and host, assume the worst"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">ALTONUM &larr; self getMachineID.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self setMachineID: ALTONUM.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">NETNUM &larr; 0.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ socket from: sockeTable values do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">socket≡nil⇒ [] socket setOutAddBlock].<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">etherState &larr; ethAwake.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self etherStart.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">routingUpdateUser update.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">NETNUM = 0⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">etherState &larr; ethAsleep.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: &rsquo;no routing tables&rsquo;]<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"tell leftover sockets current net&host, and that we are awake again"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ socket from: (sockeTable values) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[socket≡nil⇒[] socket setOutAddBlock; wakeup]. <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self notify: &rsquo;In wakeup, found Ethernet in some unknown state.&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Input Interrupt Routines</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">copyinput: string </span><span style="font: 10pt serif">[user croak] primitive: 108</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">installInputProc </span><span style="font: 10pt serif">| inBuf destSoc [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">InputProc &larr; Top install⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ [true] do⦂ [  "</span><span style="font: italic 10pt serif">infinite loop for process in scheduler</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">InputLight comp. <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ [inBuf&larr;justArrivedQ next] do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">process each incoming buffer, know it&rsquo;s a PUP</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">verify the incoming checksum</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">checkIncomingCS and⦂ (inBuf checksumOK)≡false⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">reject it, done</span><span style="font: 10pt serif">" self freePacket: inBuf]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">To be honest, we should check the destNet and destHost,<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">but they generally have to be OK.....<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">OK to pass the packet on</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(destSoc &larr; sockeTable lookup: inBuf destSocNum) ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ destSoc acceptPacbuf: inBuf].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">couldn&rsquo;t find a socket for it, done</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self freePacket: inBuf]. <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">InputLight comp. <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">InputProc sleep   "</span><span style="font: italic 10pt serif">last action in the loop</span><span style="font: 10pt serif">"]] <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">at: InputProcLevel]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">installIntProc  </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">IntProc &larr; Top install⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ [true] do⦂ [  "</span><span style="font: italic 10pt serif">infinite loop for process in scheduler.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Interrupt just happened, running at a high level, interface off.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Something just happened, do the common cases first.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Input is wired down below; only comes here if OK.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Note: we can only come here if last action was to start the rec!!</span><span style="font: 10pt serif">"<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">IntLight comp. <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">copy out the packet first</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ethInPacNext ⇒[self copyinput: ethInPacNext pupString]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"user cr; show: &rsquo;warning, no packet pre-fetched. tell John&rsquo;."<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">ethInPacNext &larr; self freePacket⇒ [self copyinput: ethInPacNext pupString]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"user cr; show: &rsquo;input lost&rsquo;"].<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">start the receiver</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self SIO: 2.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ethInPacNext⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">now process this input</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">justArrivedQ next&larr; ethInPacNext. <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">ethInPacNext &larr; self freePacket.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">Top wakeup: InputProcLevel.  "</span><span style="font: italic 10pt serif">all done</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]].<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">IntLight comp. <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">IntProc sleep    "</span><span style="font: italic 10pt serif">last action in the loop</span><span style="font: 10pt serif">"]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">at: IntProcLevel]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Output Routines</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">doOutput: string </span><span style="font: 10pt serif">[] primitive: 100</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sendOutput: ethOutPac </span><span style="font: 10pt serif">| post<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">This is the one and only place from which we  send output.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Only one packet gets passed in to us at a time.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">For performance, we wait here for the transmitter to post!!!!<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Nominally, we are running at level 0;  thus, this must be run<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">at a Top critical, to protect from multiple calls.</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[etherState≠ethAwake ⇒ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self wakeup. user show: &rsquo;starting Ethernet...&rsquo;]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">Top critical⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">OutputLight comp. <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">mem◦0606&larr; (ethOutPac totLengthWords)."EthOutCntLoc"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(post &larr; self doOutput: ethOutPac pupString) ≠ 0777 ⇒ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user cr; show: &rsquo;Warning, bad output post: &rsquo;+ post base8]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">OutputLight comp. <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]. "end of the critical part"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>User messages</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">awake </span><span style="font: 10pt serif">[⇑etherState = ethAwake]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">broadcastFilter: val<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[val ⇒ [broadcastFilter&larr;true. self broadcastFilterSet: 1] <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">broadcastFilter &larr; false.  self broadcastFilterSet: 0.]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">broadcastFilterSet: val<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user croak ] primitive: 107</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">freePacket </span><span style="font: 10pt serif">| p [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">get a packet</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">freeQ⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(p &larr; freeQ next) ⇒ [⇑p]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user show: &rsquo;Warning, empty freeQ, in Etherworld&rsquo;.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑Pacbuf new init]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">freePacket: p </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">put a used packet into free queue</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[freeQ and⦂ p⇒ [freeQ next &larr; p]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Utility messages</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">error: str </span><span style="font: 10pt serif">[user cr. user show: str]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fill </span><span style="font: 10pt serif">| "I want to replenish the freeQ" outstanding [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">freeQ≡false or⦂ freeQ≡nil⇒ []<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outstanding &larr; (Pacbuf howMany) - (freeQ length).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user cr; show: (outstanding asString)+&rsquo; packets outstanding&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ [freeQ length=10] do⦂ [freeQ next &larr; Pacbuf init].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">getMachineID  </span><span style="font: 10pt serif">[⇑ (self SIO: 0) \ 256]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">notify: strng </span><span style="font: 10pt serif">| "turn off the Ethernet before doing a user notify" <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self etherStop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user show: &rsquo; Etherworld stopped&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> [Top currentPriority ≠ 1⇒[user cr; show: &rsquo;priority is &rsquo; + (Top currentPriority) asString.  ]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> user notify: strng]<br></span><span class="tab" val="79"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: s </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">etherState = ethDead ⇒ [s append: &rsquo;Etherworld,  etherState = ethDead.&rsquo;].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s append: &rsquo;Etherworld running on &rsquo;; print: NETNUM;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">append: &rsquo;#&rsquo;+(ALTONUM base8)+&rsquo;#&rsquo; ; cr.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[freeQ⇒ [s print: freeQ length; append: &rsquo; Pacbufs in freeQ&rsquo;]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s append: &rsquo;no freeQ&rsquo;].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s cr; append: &rsquo;etherState = &rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">etherState = ethAsleep ⇒ [s append: &rsquo;etherAsleep&rsquo;].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">etherState = ethAwake ⇒ [s append: &rsquo;etherAwake&rsquo;].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s print: etherState.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printRoutingTable </span><span style="font: 10pt serif">| </span><span style="font: bold 10pt serif">i </span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: 1 to: 255 do⦂ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">routingTable◦i ≠ 0 ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user cr.  user show: &rsquo;To net &rsquo; + i asString + <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo; via host &rsquo; + (routingTable◦i) asString + &rsquo;, hop count = &rsquo; +<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(routingHopCount◦i) asString.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user cr.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">] </span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printSocketTable </span><span style="font: 10pt serif">| i [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sockeTable≡nil⇒[user cr; show: &rsquo;no socketTable&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: sockeTable objects do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">i≡nil⇒[]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user cr; print: i; show: &rsquo;, &rsquo;; print: sockeTable◦i<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">setMachineID: ID </span><span style="font: 10pt serif">[mem◦0610 &larr; ID]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">SIO: sioArg </span><span style="font: 10pt serif">[] primitive: 91</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪Etherworld under: &rsquo;Ethernet Control&rsquo;.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">Etherworld classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"Int32"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;Int32&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Number<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;high low&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>This class should probably be part of Number rather than Etherworld.<br>NOTE THAT + AND - SHOULD BE FIXED TO RETURN TO SMALLTALK IF TYPE OF ARG IS NOT INT32</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asInteger </span><span style="font: 10pt serif">[high = 0 ⇒ [⇑ low] ⇑high*65536 + low]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">high: high low: low</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Info about self</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hash </span><span style="font: 10pt serif">[⇑ low]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">high </span><span style="font: 10pt serif">[⇑ high]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">low </span><span style="font: 10pt serif">[⇑ low]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[high printon: strm base: 8. strm append: &rsquo;|&rsquo;. low printon: strm base: 8 ]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Arithmetic</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">≠ arg </span><span style="font: 10pt serif">[⇑ low ≠ arg low or⦂ high ≠ arg high]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">+ arg </span><span style="font: 10pt serif">[⇑self + arg asInt32] primitive: 93</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">- arg </span><span style="font: 10pt serif">[⇑self - arg asInt32] primitive: 92</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">&lt; arg </span><span style="font: italic 10pt serif">"revised M. Dolbec 6/25/80"</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[high = arg high⇒ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[low &lt; 0 ⇒ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[arg low &lt; 0 ⇒ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑low &gt; arg low]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">arg low &gt; 0 ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑low &lt; arg low] <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑true]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑high &lt; arg high]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">= arg </span><span style="font: 10pt serif">[⇑low = arg low and⦂ high = arg high]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">&gt; arg </span><span style="font: italic 10pt serif">"revised M. Dolbec 6/25/80"</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑arg &lt; self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪Int32 under: &rsquo;Ethernet Control&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"Pacbuf"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;Pacbuf&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;pupString locked&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>This is the basic unit for building and interpreting packets for the ethernet.<br>It contains the messages that allow fields of a packet to be filled and read.<br>Most users will prefer to use the socket mechanisms</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pupString &larr; String new: 558.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">locked &larr; false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Ethernet header</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">ethType </span><span style="font: 10pt serif">[⇑pupString word: 2]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">ethType&larr; eT </span><span style="font: 10pt serif">[pupString word: 2 &larr; eT]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">imEthDestHost </span><span style="font: 10pt serif">[⇑pupString◦1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">imEthDestHost&larr; iEDH </span><span style="font: 10pt serif">[pupString◦1 &larr; iEDH]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">imEthSrcHost </span><span style="font: 10pt serif">[⇑pupString◦2]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">imEthSrcHost&larr; iESH </span><span style="font: 10pt serif">[pupString◦2 &larr; iESH]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>PUP Header</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">addressBlock </span><span style="font: 10pt serif">[⇑pupString◦(13 to: 24) ]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">addressBlock&larr; addBlock </span><span style="font: 10pt serif">"for quickly setting the 6 fields" [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"pupString◦(13 to: 24) &larr; addBlock"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pupString copy: 13 to: 24 with: addBlock from: 1 to: 12]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">destHost </span><span style="font: 10pt serif">[⇑pupString◦14]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">destHost&larr; dH </span><span style="font: 10pt serif">[pupString◦14 &larr; dH]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">destNet </span><span style="font: 10pt serif">[⇑pupString◦13]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">destNet&larr; dN </span><span style="font: 10pt serif">[pupString◦13 &larr;  dN]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">destSoc0 </span><span style="font: 10pt serif">[⇑pupString word: 8]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">destSoc0&larr; i </span><span style="font: 10pt serif">[⇑pupString word: 8&larr;i]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">destSoc1 </span><span style="font: 10pt serif">[⇑pupString word: 9]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">destSoc1&larr; i </span><span style="font: 10pt serif">[⇑pupString word: 9&larr;i]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">destSocNum </span><span style="font: 10pt serif">[⇑Int32 new high: (pupString word: 8) low: (pupString word: 9) ]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">destSocNum&larr; dSN </span><span style="font: 10pt serif">[pupString word: 8 &larr; dSN high.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> pupString word: 9 &larr; dSN low]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pupID </span><span style="font: 10pt serif">[⇑Int32 new high: (pupString word: 5) low: (pupString word: 6) ]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pupID0 </span><span style="font: 10pt serif">[⇑pupString word: 5 ]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pupID0&larr; pID </span><span style="font: 10pt serif">[⇑pupString word: 5 &larr; pID ]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pupID1 </span><span style="font: 10pt serif">[⇑pupString word: 6 ]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pupID1&larr; pID </span><span style="font: 10pt serif">[⇑pupString word: 6 &larr; pID ]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pupID&larr; pID </span><span style="font: 10pt serif">[pupString word: 5 &larr; pID high.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> pupString word: 6 &larr; pID low]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pupLength </span><span style="font: 10pt serif">[⇑pupString word: 3]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pupLength&larr; pL </span><span style="font: 10pt serif">[⇑pupString word: 3 &larr; pL]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pupType </span><span style="font: 10pt serif">[⇑pupString◦8]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pupType&larr; pT </span><span style="font: 10pt serif">[pupString◦8 &larr; pT]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sourceHost </span><span style="font: 10pt serif">[⇑pupString◦20]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sourceHost&larr; sH </span><span style="font: 10pt serif">[pupString◦20 &larr; sH]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sourceNet </span><span style="font: 10pt serif">[⇑pupString◦19]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sourceNet&larr; sN </span><span style="font: 10pt serif">[pupString◦19 &larr; sN]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sourceSoc0 </span><span style="font: 10pt serif">[⇑pupString word: 11]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sourceSoc0&larr; i </span><span style="font: 10pt serif">[⇑pupString word: 11&larr;i]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sourceSoc1 </span><span style="font: 10pt serif">[⇑pupString word: 12]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sourceSoc1&larr; i </span><span style="font: 10pt serif">[⇑pupString word: 12&larr;i]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sourceSocNum </span><span style="font: 10pt serif">[⇑Int32 new high: (pupString word: 11) low: (pupString word: 12)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sourceSocNum&larr; sSN </span><span style="font: 10pt serif">[pupString word: 11 &larr; sSN high.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> pupString word: 12 &larr; sSN low]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">swapPorts </span><span style="font: 10pt serif">| i [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: 13 to: 18 do⦂ [pupString swap: i with: i+6]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">totLengthWords </span><span style="font: 10pt serif">[⇑((self pupLength)+5)/2]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">transportControl </span><span style="font: 10pt serif">[⇑pupString◦7]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">transportControl&larr; tC </span><span style="font: 10pt serif">[pupString◦7 &larr; tC]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>PUP Checksum</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">checksum  </span><span style="font: 10pt serif">[⇑pupString word: ((self pupLength+1)/2)+2]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">checksumOK </span><span style="font: 10pt serif">"Boolean, returns true or false"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["just look at the current packet"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self checksum = self doChecksum]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">checksum&larr;  cs <br></span><span class="tab" val="79"></span><span style="font: bold 10pt serif"> </span><span style="font: 10pt serif">[pupString word: (((self pupLength+1)/2)+2) &larr; </span><span style="font: bold 10pt serif">cs</span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">doChecksum </span><span style="font: 10pt serif">| i cs <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">cs &larr; 0. <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: (3 to: (((self length + 1)/2)+2)) do⦂ "does not work"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[cs&larr;cs+(pupString word: i). </span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">   "for packets with carries"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[cs &lt;0⇒[cs &larr; (cs lshift: 1)+1] cs &larr; cs lshift: 1]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[cs=¬1⇒[cs &larr; 0]]. <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑cs<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">] primitive: 94 </span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Data </span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dataLength </span><span style="font: 10pt serif">[⇑(pupString word: 3) "self pupLength" - 22]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dataLength&larr; len </span><span style="font: 10pt serif">[⇑pupString word: 3 "self pupLength" &larr; len + 22]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dataString </span><span style="font: 10pt serif">[⇑pupString copy: 25 to: 24+self dataLength]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dataString&larr; str </span><span style="font: 10pt serif">| i [</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; str length.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &gt; 532 ⇒ [user notify: &rsquo;Data string too big for single PUP&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pupString copy: 25 to: 24 + i with: str from: 1 to: i.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self dataLength &larr; i.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑str]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dataWord: i </span><span style="font: 10pt serif">[⇑pupString word: i + 12]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dataWord: i &larr; v </span><span style="font: 10pt serif">[⇑pupString word: i + 12 &larr; v]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Etc</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">◦ i </span><span style="font: 10pt serif">[⇑pupString◦i]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">◦ i &larr; v </span><span style="font: 10pt serif">[⇑pupString◦i &larr; v]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">header </span><span style="font: 10pt serif">[⇑pupString◦(1 to: 24) ]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">lock </span><span style="font: 10pt serif">[locked⇒[E notify: &rsquo;trying to lock a buffer already locked&rsquo;]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">locked&larr;true. ⇑pupString lock]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">locked </span><span style="font: 10pt serif">[⇑locked]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">lockwith: string </span><span style="font: 10pt serif">[locked⇒[E notify: &rsquo;trying to lock a buffer already locked&rsquo;]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">locked&larr;string. ⇑pupString lock]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pupString  </span><span style="font: 10pt serif">[⇑pupString]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pupString &larr; pupString </span><span style="font: 10pt serif">[⇑pupString]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">unlock </span><span style="font: 10pt serif">[locked⇒[locked&larr;false.  pupString unlock]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: &rsquo;trying to unlock a buffer not locked&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">word: i </span><span style="font: 10pt serif">[⇑pupString word: i]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">word: i &larr; v </span><span style="font: 10pt serif">[⇑pupString word: i &larr; v]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪Pacbuf under: &rsquo;Ethernet Control&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"SafeQ"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;SafeQ&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: PQueue<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;enabled&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>checks all objects enqueued, to be sure not there already</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>As yet unclassified</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">disable </span><span style="font: 10pt serif">[enabled &larr; false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">enable </span><span style="font: 10pt serif">[enabled &larr; true]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">length </span><span style="font: 10pt serif">[⇑position - readposition]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">next &larr; arg </span><span style="font: 10pt serif">| i "short comment" [[enabled⇒<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: (readposition+1) to: position do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(array◦i)≡arg⇒[E notify: &rsquo;putting same guy on Q twice&rsquo;]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">arg locked⇒[E notify: &rsquo;putting locked Pacbuf on Q&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">super next &larr; arg<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">status </span><span style="font: 10pt serif">[⇑enabled]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪SafeQ under: &rsquo;Ethernet Control&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"Socket"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;Socket&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;socNumber computeOutgoingCS filterInput outAddBlock<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">lclSocNum frnNet frnHost frnSocNum&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sharing: EtherPool;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>Sockets are used to do all communication through the net.  <br>It is expected that a specialized server or process can have<br>its own subclass of Socket with its own definitions of the<br>&rsquo;Overwrite by Subclass&rsquo; operations.  Note that subclasses will<br>have to access some global variables. <br><br>Each socket is identified by a 32-bit lclSocNum, which really<br>defines who we are.<br>In addition, aspects of the lcl and frn addresses are used  to make<br>decisions about accepting<br>incoming packets, addressing outgoing packets, defaulting fields, etc.<br><br>The input distributor assures that an input was destined for our net<br>(not trying to<br>find a gateway) and our host (either explicitly or as broadcast, <br>if not filtered), and found us by socket number.  Input need NOT be<br>filtered by the socket according to source, since the client may want<br>to see error messages from an intermediate address.<br><br>As a convenience, however, the socket can be asked to filterInput,<br>so it only accepts things which match the frnPort.<br>Thus, local and foreign attributes are primarily used to default<br>fields of an outgoing  packet.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">default <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["default local socket number and leave frn port open"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self net: 0 host: 0 soc: (Int32 new high: 0 low: 0)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">from: lclSocNum  <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["set lcl soc number, leave frnPort open -- useful for creating<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">a well-known socket as a listener"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self from: lclSocNum net: 0 host: 0 soc: (Int32 new high: 0 low: 0)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">from: lclSocNum net: frnNet host: frnHost soc: frnSocNum <br></span><span class="tab" val="79"></span><span style="font: bold 10pt serif"> </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"this is the most general initialization, both lcl soc# and frnPort given"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outAddBlock &larr; String new: 12.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self setOutAddBlock.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">computeOutgoingCS &larr; filterInput &larr; false. <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sockeTable insert: lclSocNum with: self.  "put me in socket table"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self doMoreInit<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hostName: name </span><span style="font: 10pt serif">| a nh [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">lookup name, then set net and host numbers (maybe socket?)</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">a &larr; NameUser init.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nh &larr; a getAddressBlock: name.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">since this socket may get many responses,<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">make sure socket is not half deleted from sockeTable after first response</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Top critical⦂ [a close].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nh⇒ [self net: nh◦1 host: nh◦2]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"invalid name?"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">net: frnNet host: frnHost soc: frnSocNum </span><span style="font: 10pt serif">[</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"default the local socket number:<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">use some memory dependent info (space) for the high word so that no two<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">sockets (instances) can be the same, also non-zero.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">use time for low word, so that same instance will not usually have the<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">same socket number (odds = 1/65536)"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">lclSocNum &larr; Int32 new high: self nail low: user ticks.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self unNail; from: lclSocNum net: frnNet host: frnHost soc: frnSocNum<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">setOutAddBlock<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outAddBlock◦1 &larr; frnNet. outAddBlock◦2 &larr; frnHost.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outAddBlock word: 2 &larr; frnSocNum high.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outAddBlock word: 3 &larr; frnSocNum low.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outAddBlock◦7 &larr; NETNUM. outAddBlock◦8 &larr; ALTONUM.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outAddBlock word: 5 &larr; lclSocNum high.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outAddBlock word: 6 &larr; lclSocNum low.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">to: h </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">convenient default if on my net</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self net: NETNUM host: h]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">wakeup </span><span style="font: 10pt serif">| "when E goes from ethAsleep to ethAwak" <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[  ]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Process incoming packet</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">acceptPacbuf: Ipac </span><span style="font: 10pt serif">| temp<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["if we get here, we know that the input distributer has verified the<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">PUP dest as being us (or a broadcast, if broadcast filter is off).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">We do not have responsibility for verifying incoming checksum.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">First, check if we&rsquo;ve been asked to filter by source:"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">filterInput and⦂ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(</span><span class="tab" val="79"></span><span style="font: 10pt serif">(frnNet ≠ Ipac sourceNet) or⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">  ((frnHost ≠ Ipac sourceHost) or⦂ (frnSocNum ≠ Ipac sourceSocNum))<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ⇒ [⇑self socDispose: Ipac]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"It&rsquo;s good, take it..."<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self socProcess: Ipac<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Process outgoing packet</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">broadcast: packet to: socNumber</span><span style="font: 10pt serif">| "I want to broadcast this packet" [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self setAddresses: packet.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">packet<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">destHost&larr;0;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">destNet&larr;0;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">destSoc0&larr;socNumber high;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">destSoc1&larr;socNumber low.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"I assume that the length and type have been done"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self completePup: packet.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">completePup: pac </span><span style="font: 10pt serif">| </span><span style="font: bold 10pt serif">t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"the user must have set all 6 address fields,ID, length, and type"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"Now route the packet appropriately, assuming we have Ethernet..."<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">NETNUM =  pac destNet ⇒  [pac imEthDestHost &larr;pac destHost] <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"most common case"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">0 = pac destNet ⇒ [pac imEthDestHost &larr; 0] "broadcast"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">0 = (t &larr; routingTable◦(pac destNet)) ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user show: &rsquo;<br>Inaccessible destination net: &rsquo; + pac destNet asString+ &rsquo;, packet not sent.&rsquo;.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑pac.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pac imEthDestHost &larr; t.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pac imEthSrcHost &larr; ALTONUM.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pac ethType &larr; 01000.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pac transportControl&larr; 0. <br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"as a socket we have an option about computing outgoing checksums"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pac checksum &larr; [computeOutgoingCS⇒[pac doChecksum] ¬1].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"Fix this up later......"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">E sendOutput: pac.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑pac<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">defaultAddresses: pac   </span><span style="font: 10pt serif">"overwrites any fields which are 0"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pac destNet = 0 ⇒ [pac destNet &larr; frnNet]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pac destHost = 0 ⇒ [pac destHost &larr; frnHost]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(pac destSoc0 = 0) and: (pac destSoc1=0) ⇒ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pac destSocNum &larr; frnSocNum]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pac sourceNet = 0 ⇒ [pac sourceNet &larr; NETNUM]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pac sourceHost = 0 ⇒ [pac sourceHost &larr; ALTONUM]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(pac sourceSoc0 = 0) and: (pac sourceSoc1 = 0) ⇒ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pac sourceSocNum &larr; lclSocNum]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">defaultAndComplete: pac<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self defaultAddresses: pac.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self completePup: pac.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">setAddresses: pac </span><span style="font: 10pt serif">[pac addressBlock &larr; outAddBlock]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">setAddressesAndComplete: pac <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pac addressBlock &larr; outAddBlock.  self completePup: pac]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Access to Parts</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">close </span><span style="font: 10pt serif">[self release.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sockeTable lookup: lclSocNum⇒[sockeTable delete: lclSocNum]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">computeOutgoingCS </span><span style="font: 10pt serif">[⇑</span><span style="font: bold 10pt serif">computeOutgoingCS</span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">computeOutgoingCS&larr; computeOutgoingCS </span><span style="font: 10pt serif">[⇑</span><span style="font: bold 10pt serif">computeOutgoingCS</span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">disable  </span><span class="tab" val="79"></span><span style="font: 10pt serif">["left for compatibility" user show: &rsquo;unnecessary disable&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self close.]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">enable </span><span style="font: 10pt serif">["now a no-op" user show: &rsquo;someone did unnecessary enable&rsquo;. self print]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">filterInput  </span><span style="font: 10pt serif">[⇑filterInput]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">filterInput&larr; filterInput </span><span style="font: 10pt serif">[⇑filterInput ]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">freePacket </span><span style="font: 10pt serif">| p [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">get a packet</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">freeQ⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(p &larr; freeQ next)⇒ [⇑p]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user show: &rsquo;Warning, empty freeQ, in Socket&rsquo;.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑Pacbuf new init]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">freePacket: p </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">put a used packet into free queue</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[freeQ and⦂ p⇒ [freeQ next &larr; p]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">frnHost </span><span style="font: 10pt serif">[⇑frnHost]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">frnHost&larr; frnHost </span><span style="font: 10pt serif">[⇑frnHost]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">frnNet </span><span style="font: 10pt serif">[⇑frnNet]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">frnNet&larr; frnNet </span><span style="font: 10pt serif">[⇑frnNet]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">frnSocNum </span><span style="font: 10pt serif">[⇑frnSocNum]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">frnSocNum&larr; frnSocNum </span><span style="font: 10pt serif">[⇑frnSocNum]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">lclSocNum </span><span style="font: 10pt serif">[⇑lclSocNum]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">lclSocNum&larr; lclSocNum </span><span style="font: 10pt serif">[⇑lclSocNum]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Overwrite by Subclasses</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">doMoreInit</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">kill </span><span style="font: 10pt serif">["whole world about to go.  I don&rsquo;t care, but my subclasses might"]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">release </span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">disable Timers, undo circular structures etc.</span><span style="font: 10pt serif">"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sleep </span><span style="font: 10pt serif">["the user is quitting.  I don&rsquo;t care, but my subclasses might"]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">socDispose: Ipac </span><span style="font: 10pt serif">[self freePacket: Ipac]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">socProcess: Ipac </span><span style="font: 10pt serif">[self freePacket: Ipac]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪Socket under: &rsquo;Ethernet Control&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"RetransmitSocket"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;RetransmitSocket&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Socket<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;retransTimer retransMax retransCount&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>An abstract socket for handling retransmission behavior</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Socket</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">release </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">retransTimer≡nil⇒ []<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">release circular structure</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">retransTimer disable. retransTimer &larr; nil]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">setAddressesAndComplete: pac </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">this may need to be bracketed as critical?</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pac addressBlock &larr; outAddBlock.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">start timer</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">retransCount &larr; 0. retransTimer reset.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self completePup: pac<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"self startTimer.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">super setAddressesAndComplete: pac"]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Timer</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">retransmit: retransMax every: delay </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">retransTimer &larr; Timer new.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">retransTimer for: delay action⦂ [self timerFired]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">startTimer </span><span style="font: 10pt serif">[retransCount &larr; 0. retransTimer reset]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">timerOff </span><span style="font: 10pt serif">[retransTimer≡nil⇒ [] retransTimer disable]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">timerOn </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">turn on timer if retry count has not been reached</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(retransCount &larr; retransCount + 1) ≤ retransMax ⇒ [retransTimer reset]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Subclass</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">timerFired </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">subclass should redefine this</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self timerOn⇒ ["</span><span style="font: italic 10pt serif">again, e.g. self completePup: pac"</span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">done</span><span style="font: 10pt serif">"]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪RetransmitSocket under: &rsquo;Ethernet Control&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"NameUser"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;NameUser&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: RetransmitSocket<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;resultType resultSet result outPac&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>Typical use: <br>   foo &larr; NameUser init.<br>   foo getAddressBlock: string.  --- returns 6-byte string<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">foo getAddressString.  --- returns string like 2#2#0<br>   foo close.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["create a NameUser, to socket 4, from a default local socket number"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">E wakeup.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self net: 0 host: 0 soc: 4 asInt32.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self retransmit: 2 every: 300]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Output requests</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">getAddressBlock: str </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">returns a string, 6 bytes: net/host/socket</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">result &larr; resultSet &larr; false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outPac &larr; self freePacket.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outPac pupType&larr; 0220; dataString&larr; str.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self setAddressesAndComplete: outPac.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ resultSet do⦂ [].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑result]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">getAddressString: str </span><span style="font: 10pt serif">| temp  "return string representation"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">temp &larr; self getAddressBlock: str ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑(temp◦1) base8 + &rsquo;#&rsquo; + (temp◦2) base8 + &rsquo;#&rsquo; +<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(temp word: 2) base8 + &rsquo;|&rsquo; +  (temp word: 3) base8.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">getName: str </span><span style="font: 10pt serif">| "convert string address back to host name"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["not implemented yet"]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Handle input</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">socProcess: Ipac </span><span style="font: 10pt serif">| i j best bestHops "overwrite from Socket"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"called from Ether stuff, running at a very high level"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["dummy block"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">resultSet ⇒ ["we are not waiting!!"]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"must be the answer, or an error"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self timerOff.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">resultSet &larr; true.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">0222 = Ipac pupType ⇒ "error"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">["user show: (Ipac dataString). "].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">0221 ≠ Ipac pupType ⇒ "error"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">["user show: &rsquo;unknown pup received by name user.&rsquo;"].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"an answer arrived"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">result &larr; Ipac dataString. "1 or more 6 byte blocks"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">result length = 6 ⇒ ["all done"].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"more than one, find the nearest address"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">best &larr; 1.  bestHops &larr; 16.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: 1 to: (result length) by: 6 do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">NETNUM = (result◦i) ⇒ [best &larr; i.  bestHops &larr; 0].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">j&larr; routingHopCount◦(result◦i).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">j &lt; bestHops ⇒ [best&larr;i. bestHops&larr;j].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">result &larr; result copy: best to: (best+5).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]"dummy block".<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"all done"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self freePacket: Ipac.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">timerFired  </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self timerOn⇒ [self completePup: outPac]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">resultSet &larr; true]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪NameUser under: &rsquo;Ethernet Control&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"RoutingUpdater"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;RoutingUpdater&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: RetransmitSocket<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;outPac resultSet&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>A specialized sub-class of Socket, designed to send out requests<br>for the current routing info, and update the routing table.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"create a new local soc number, broadcast to socket 2"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">super net: 0 host: 0 soc: 2 asInt32.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outPac &larr; self freePacket.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outPac pupType &larr; 0200.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outPac dataString &larr; &rsquo;&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self retransmit: 3 every: 300.<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Sending</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">update </span><span style="font: 10pt serif">| i <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: 255 do⦂ [routingTable◦i &larr; 0. routingHopCount◦i&larr;8].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">resultSet &larr; false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self setAddressesAndComplete: outPac.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ resultSet do⦂ []]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Overwrite from Socket</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">socProcess: pac </span><span style="font: 10pt serif">| block gateway net count i <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">an input has arrived, we are running at a higher level.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Check the packet type</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">if⦂ pac pupType = 0201 then⦂ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self timerOff.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">resultSet &larr; NETNUM &larr; pac sourceNet.<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">block &larr; pac pupString.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">gateway &larr; pac sourceHost.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: 25 to: 24+pac dataLength by: 4 do⦂ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">net &larr; block◦i. <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">count &larr; block◦(i+3) + 1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">count &lt; (routingHopCount◦net) ⇒ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[routingTable◦net &larr; gateway. routingHopCount◦net &larr; count]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self freePacket: pac<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">timerFired </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self timerOn⇒ [self completePup: outPac]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">resultSet &larr; true]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪RoutingUpdater under: &rsquo;Ethernet Control&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"RPPSocket"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;RPPSocket&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: RetransmitSocket<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;seqNum outPac ackOK abortTransfer inQ ackType transaction myStream eof&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I establish a reliable packet protocol for communication.<br>This is a sub-class of Socket, and uses many of its messages.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Intialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self retransmit: 10 every: 180.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">seqNum &larr; transaction &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outPac &larr; ackOK  &larr; false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">abortTransfer &larr; true. "stop an old timer from perhaps firing"]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Termination</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">release </span><span style="font: 10pt serif">[self reset. inQ &larr; false. super release]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">reset </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outPac &larr; self freePacket: outPac.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self timerOff]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Sending Data</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">send: myStream <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"Sends a whole stream, and an end sequence.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">let the caller hand in a stream, or a file already opened</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[outPac ⇒ [] outPac &larr; self freePacket].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">seqNum &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">abortTransfer &larr; eof &larr; false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ [eof or⦂ abortTransfer] do⦂ [self sendData].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">abortTransfer ⇒ [self reset. ⇑false]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"We hit the end of file, do the end sequence and close the connection"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self sendEndSequence ⇒ [⇑myStream] ⇑false.  "all done!"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sendBlock: str <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"Take the data from a string (1-532 bytes), send it out; uses outPac"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">outPac dataString &larr; str.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self sendPacket.  "tries to do it reliably"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">abortTransfer⇒[⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sendData </span><span style="font: 10pt serif">| i t buf len [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"send one packet of data from myStream"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">buf &larr; outPac pupString.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; 24.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"data bytes are 1-512, 25-536"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[myStream is: FileStream⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"read characters faster (should work especially well for the usual case:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">FileStreams starting on a page boundary, with page sizes of 512)"<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">len &larr; 512 - (myStream readString: buf from: i+1 to: i+512)]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"fill the buffer the slow, careful way"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ (i &lt; 536 and⦂ (t &larr; myStream next)) do⦂ [buf◦(i &larr;i+1) &larr; t]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">len &larr; i-24].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">eof &larr; len &lt; 512.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">len = 0⇒ ["empty packet. don&rsquo;t send"]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outPac pupType &larr; 030. "Data"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"set the packet length"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outPac dataLength &larr; len.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"send packet reliably or abort, then return"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self sendPacket. <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sendEndSequence<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"This will do the 3-way handshake, and close the connection.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">send end, wait for ack"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">outPac pupType &larr; 032. "end"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"set the packet length"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">outPac pupLength &larr; 22.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self sendPacket. "gets sent reliably, we hope"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">abortTransfer⇒[self reset. ⇑false].<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"send the last gratuitous end, do not try to retransmit"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self sendPacketOnce.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self reset.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑true.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sendPacket </span><span style="font: 10pt serif">| <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"general routine to send the outPac packet, maybe retransmit, get ack" <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ackOK &larr; abortTransfer &larr; false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outPac pupID1 &larr; seqNum. <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outPac pupID0 &larr; transaction. "pupID0 can be used by one of my subclasses"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self setAddressesAndComplete: outPac.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ [abortTransfer or⦂ ackOK] do⦂ [].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">seqNum &larr; seqNum + 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sendPacketOnce </span><span style="font: 10pt serif">| <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"special routine to send the outPac packet, no retransmission" <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outPac pupID1 &larr; seqNum. <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outPac pupID0 &larr; transaction. "pupID0 can be used by one of my subclasses"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self setAddressesAndComplete: outPac; timerOff.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Receiving Data</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Handle Input</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">process: packet </span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">my subclasses use this</span><span style="font: 10pt serif">" self freePacket: packet]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">socProcess: Ipac </span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">I have received a packet</span><span style="font: 10pt serif">" [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Ipac pupType = ackType ⇒[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[Ipac pupID1 = seqNum and⦂ Ipac pupID0 = transaction⇒[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">a legal acknowledgement</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self timerOff.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">ackOK &larr; true]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">an old acknowledgement</span><span style="font: 10pt serif">"].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self freePacket: Ipac]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">must be a trasmission started elsewhere</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self process: Ipac.]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Timer Interupts</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">timerFired </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"This piece of code only runs when a Timer fires;  <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Don&rsquo;t do an active return"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ackOK or⦂ abortTransfer⇒ ["This transaction has been terminated"]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self timerOn⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"retransmit"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self completePup: outPac]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user show: &rsquo;Excessive retransmits in RPP retransmit&rsquo; .<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">abortTransfer &larr; true]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪RPPSocket under: &rsquo;Ethernet Control&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"EFTPSender"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;EFTPSender&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: RPPSocket<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo; &rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>A specialized sub-class of RPPSocket, designed to send files to an<br>EFTP receiver.  By convention, the receiver will be on socket 020<br>There can only be one outstanding packet at a time, called outPac.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">net: n host: h<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"Each instance of an EFTPSender has a unique lclSocket, but<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">always goes to socket 020 of the receiver"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">super net: n host: h soc: (Int32 new high: 0 low: 020).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"unlike plain sockets, we only want acks from this dest."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">filterInput &larr; true.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self retransmit: 5 every: 180.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outPac &larr; false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">transaction &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ackType &larr; 031.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Receiving</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">process: packet </span><span style="font: 10pt serif">| error "The printer is trying to tell me something" [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">packet pupType = 033⇒[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"error 33!!!" error &larr; packet dataString.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self freePacket: packet.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user show: &rsquo;remote server aborted: &rsquo;; show: error◦(3 to: error length).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">abortTransfer&larr;true]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪EFTPSender under: &rsquo;Ethernet Control&rsquo;.</span></div>
    <div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">&rsquo;From Smalltalk 5.5k XM November 24 on 22 November 1980 at 2:57:08 am.&rsquo;<br></span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">"Form"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;Form&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;extent bits offset figure ground&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;brush aurora black white aurorarunning SPARE color formmenu under reverse blankcursor over dotsetter &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>This class is a virtual bit map represented as a smalltalk String</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>INIT</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["sets up colors and effects for BITBLT."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">black &larr; 0-1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">white &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">over &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">under &larr; 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">reverse &larr; 2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">brush &larr; Form new extent: 5⌾5. brush black.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">color &larr; 1.<br>formmenu &larr; Menu new string:<br>&rsquo;brush<br>black<br>white<br>line<br>arc<br>erase<br>size<br>figure<br>ground<br>&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dotsetter &larr; BitBlt new init." a BitBlt for pattern access."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dotsetter width &larr; 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dotsetter height &larr; 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">aurorarunning &larr; false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">aurora &larr; "Aurora new" nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">close<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">extent: extent<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["creates a virtual bit map with width = (extent x) and height = (extent y) with the bits all 1."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self extent: extent figure: 0 ground: 1 offset: (0⌾0).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">extent: extent figure: figure ground: ground offset: offset<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["creates a virtual bit map with width = (extent x) and height = (extent y) with the bits all 1."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bits&larr; String new: 2*(extent y)*( ((extent x) +15) /16).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fromImage: image <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["creates a virtual bit map with width = (image width) and height = (image height) with the bits in image."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self extent: image extent.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bits&larr; (image rectangle) bitsIntoString<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fromrectangle: r <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["creates a virtual bit map with width = (r width) and height = (r height) with the bits in r."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self extent: r extent.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bits&larr; r bitsIntoString<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span class="tab" val="79"></span><span style="font: bold 10pt serif">fromuser  | r<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["create a new Form whose rectangle is specified by the user. "<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">r &larr; Rectangle new fromuser.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self extent: r extent.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bits&larr; r bitsIntoString<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fromuserevenword  | r<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["create a new Form whose rectangle is specified by the user,<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">truncated to nearest multiple of 16 (for Spruce printing). "<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">r &larr; Rectangle new fromuserevenword.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self extent: r extent.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bits&larr; r bitsIntoString<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>PATTERN ACCESS</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">bits <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["return the string containing the bits)"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ bits<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">bits: bits <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["reset the string containing the bits)"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">black </span><span style="font: 10pt serif">| i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["sets all bits in the form to black ( to ones)"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: bits length do⦂ [ bits◦i &larr; 0-1]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">black: pt <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["sets the bit at pt in the  form to black ( to one)"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(((0⌾0) ≤ pt) and⦂ (pt ≤ extent)) ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">dotsetter destbase &larr; bits.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">dotsetter destraster &larr; (extent x +15)/16.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">dotsetter destx &larr; pt x.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">dotsetter desty &larr; pt y.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">dotsetter fill: storing color: black<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">gray </span><span style="font: 10pt serif">| i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["sets all bits in the form to gray ( to gray)"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: bits length do⦂ [ bits◦i &larr; 025252]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">white </span><span style="font: 10pt serif">| i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["sets all bits in the form to white ( to zeros)"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: bits length do⦂ [ bits◦i &larr; 0]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>MODULE ACCESS</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">extent<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["return the extent (width⌾height) of the Form"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ extent<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">figure<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["return the figure( color assiciated with black) for the form "<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ figure<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">figure: figure <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["set the figure ( color assiciated with black) for the form "<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">ground <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["return the ground ( color assiciated with white) for the form "<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ ground<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">ground: ground <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["set the ground ( color assiciated with white) for the form "<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">height <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["return the height of the Form"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ extent y<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">length </span><span style="font: 10pt serif">[ ⇑ bits length]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">offset <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["return the offset of the Form"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ offset<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">offset: offset <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["set the offset of the form "<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ self<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">width <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["return the width of the Form"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ extent x<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>FILING</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">read: filename </span><span style="font: 10pt serif">| f strip w h form stripheight leftoverlines i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["Reads the Form from the disk in the format width,height,bits."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f&larr; (dp0 oldFile: filename).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f readonly.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">w &larr; (f nextword).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">h &larr;(f nextword).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">extent &larr; w⌾h.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">w*h &lt; 64000⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[bits &larr; (Form new extent: extent) bits.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">f into: bits.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">f close.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f close.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: &rsquo;too many bits to be a Form&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">write: filename<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">Saves the Form in the format width,height,bits.</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(dp0 file: filename)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextword&larr; (self width);<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextword&larr; (self height);<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">append: bits;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">close.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>DISPLAY</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">displayat:  path effect: effect clippedBy: cliprect</span><span style="font: 10pt serif">| r i clippedrect<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["basic form display primitive"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">path is: Point ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ r &larr; Rectangle new origin:  path extent: (self extent).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">r bitsFromString: bits mode: effect clippedBy: cliprect.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">aurorarunning⇒ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user displayoffwhile⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">clippedrect &larr; r intersect: (user screenrect).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">aurora destination: clippedrect ; source: clippedrect ;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">figure: figure ; ground: ground ;  function: 002117 "AoverB" ;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> doit; function: 0 ; doit.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">] </span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"><br> </span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">path is: Path ⇒ [for⦂ i to: path length do⦂ [ self displayat: path◦i<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">effect: effect clippedBy: cliprect] ]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>SYSTEM</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asInstance </span><span style="font: 10pt serif">| s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s &larr; Stream new default.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s nextPoint&larr; extent.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s nextPoint&larr; offset.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s nextword &larr; figure.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s nextword &larr; ground.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s nextString &larr; bits.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ s contents <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">copy </span><span style="font: 10pt serif">| t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["return a copy of myself"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">t &larr; Form new extent: extent.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">t bits: bits copy.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fromInstance: file <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">extent &larr;  file nextPoint.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">offset &larr;  file nextPoint.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">figure &larr; file nextword.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ground &larr; file nextword.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bits &larr; file nextString.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ self <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fromPress: press value: s </span><span style="font: 10pt serif">| nbytes [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">extent&larr; s nextPoint.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">offset&larr; s nextPoint.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">figure &larr; s nextword.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ground &larr; s nextword.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nbytes &larr; 2*(extent y)*((extent x + 15)/16).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(press data) skip: 0-nbytes.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bits &larr; (press data) next: nbytes]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hideData: complete </span><span style="font: 10pt serif">| s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">a Form does not split across page boundaries</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Stream new of: (s &larr; String new: 12);<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextPoint&larr; extent;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextPoint&larr; offset;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextword &larr; figure;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextword &larr; ground.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ s]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hidePress: press complete: c </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">press skipcode: self pressCode data: (self hideData: c)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pressCode </span><span style="font: 10pt serif">[⇑5]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">presson: press in: r </span><span style="font: 10pt serif">| hs y [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(hs  &larr; press scale*self height) &gt; r height⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"not enough room left on current page.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">assume for now that it will at least fit on an entire page"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">press setp: (r origin x)⌾(y &larr; r corner y - hs);<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmap: self bits: bits.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑y]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>EDITING</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">arc: parentimage </span><span style="font: 10pt serif">| pt1 pt2 pt3 path pt<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["arc tool for forms."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">BlankCursor topage1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ user redbug do⦂</span><span class="tab" val="79"></span><span style="font: 10pt serif">[ pt1 &larr; self blinkbrush: parentimage].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">brush displayat: pt1 effect: color clippedBy: user screenrect.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ user nobug do⦂</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ pt2 &larr; self blinkbrush: parentimage].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">brush displayat: pt2 effect: color clippedBy: user screenrect.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ user redbug do⦂</span><span class="tab" val="79"></span><span style="font: 10pt serif">[ pt3 &larr; self blinkbrush: parentimage].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">brush displayat: pt3 effect: color clippedBy: user screenrect.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">path &larr; Path new init.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">path addarcfrom: pt1 via: pt2 to: pt3.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ pt from: path do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ brush displayat: pt effect: color clippedBy: user screenrect].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">NormalCursor topage1<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">blinkbrush: parentimage </span><span style="font: 10pt serif">| pt <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["to show current position of brush in the form."<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pt &larr; parentimage mp.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">brush displayat: (parentimage rectangle origin)+ pt<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">effect: 2 clippedBy: user screenrect.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">brush displayat: (parentimage rectangle origin)+ pt<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">effect: 2 clippedBy: user screenrect.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ (parentimage rectangle origin)+ pt<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">edit: parentimage </span><span style="font: 10pt serif">| pt f c file<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["Simple Form editor for now."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ false do⦂ "forever for now"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pt &larr; parentimage mp." blink the current brush"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">BlankCursor topage1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self blinkbrush: parentimage.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user redbug ⇒ </span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ parentimage contains:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(pt &larr; self blinkbrush: parentimage)⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[brush displayat: pt effect: color<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">clippedBy: parentimage rectangle.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ user redbug do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[brush displayat:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(self blinkbrush: parentimage) effect: color<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">clippedBy: parentimage rectangle.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">] <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">NormalCursor topage1. <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">bits&larr; (parentimage rectangle) bitsIntoString.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ self.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">] <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user kbck⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">c &larr; user kbd. <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">c = 120⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ user clearshow: &rsquo;x gridding is &rsquo;. parentimage xgrid print.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user cr.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">parentimage xgrid:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(user request: &rsquo;x gridding . . . &rsquo;) asInteger.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">] <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">c = 121⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ user clearshow: &rsquo;y gridding is &rsquo;. parentimage ygrid print.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user cr.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">parentimage ygrid:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(user request: &rsquo;y gridding . . . &rsquo;) asInteger.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">] <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">c = 114⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">file &larr;(user request: &rsquo;filename of Form . . .&rsquo;) .<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">brush &larr;Form new read: file. brush figure: 1  ; ground: 0.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">] <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user yellowbug ⇒</span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">NormalCursor topage1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">formmenu bug<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=1⇒</span><span class="tab" val="79"></span><span style="font: 10pt serif">[self newbrush: parentimage ]; "get a new brush"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=2⇒</span><span class="tab" val="79"></span><span style="font: 10pt serif">[color &larr; 1.]; "set the color of the brush to black"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=3⇒</span><span class="tab" val="79"></span><span style="font: 10pt serif">[color &larr; 3.]; "set the color of the brush to white"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=4⇒</span><span class="tab" val="79"></span><span style="font: 10pt serif">[self line: parentimage];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=5⇒</span><span class="tab" val="79"></span><span style="font: 10pt serif">[self arc: parentimage];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=6⇒</span><span class="tab" val="79"></span><span style="font: 10pt serif">[self white. parentimage display];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"erase the whole form"<br> </span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=7⇒</span><span class="tab" val="79"></span><span style="font: 10pt serif">[self resize: parentimage<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]; "change size"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=8⇒</span><span class="tab" val="79"></span><span style="font: 10pt serif">[self setfigure: parentimage];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=9⇒</span><span class="tab" val="79"></span><span style="font: 10pt serif">[self setground: parentimage]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user bluebug ⇒ </span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[bits&larr; (parentimage rectangle) bitsIntoString.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">NormalCursor topage1. ⇑ self.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">] "exit back to the parentimage"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">line: parentimage </span><span style="font: 10pt serif">| pt1 pt2 path pt<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["line tool for forms."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">BlankCursor topage1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ user redbug do⦂</span><span class="tab" val="79"></span><span style="font: 10pt serif">[ pt1 &larr; self blinkbrush: parentimage].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">brush displayat: pt1 effect: color clippedBy: user screenrect.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ user nobug do⦂</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ pt2 &larr; self blinkbrush: parentimage].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">brush displayat: pt2 effect: color clippedBy: user screenrect.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">path &larr; Path new init.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">path addlinefrom: pt1 to: pt2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ pt from: path do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ brush displayat: pt effect: color clippedBy: user screenrect].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">NormalCursor topage1<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">newbrush: superimage </span><span style="font: 10pt serif">|  pt rect<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">OriginCursor topage1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user waitbug.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pt &larr; ( superimage mp)+ superimage rectangle origin.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rect &larr; pt rect: pt.</span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">CornerCursor topage1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ user nobug do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[rect reverse.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">rect reverse.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pt &larr; <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">( superimage mp)+ superimage rectangle origin.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">rect corner &larr; (rect origin) max: pt.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br> </span><span class="tab" val="79"></span><span style="font: 10pt serif">brush &larr; Form new fromrectangle: rect.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">NormalCursor topage1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">resize: superimage </span><span style="font: 10pt serif">|  pt f<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[superimage boxcomp.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">CornerCursor topage1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user waitbug. <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ user nobug do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[superimage reverse.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">superimage reverse.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">( pt &larr; <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">((superimage superimage) mp)+<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">((superimage superimage) rectangle origin)).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">superimage corner&larr; pt max: ((superimage origin) + (16⌾16)).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br> </span><span class="tab" val="79"></span><span style="font: 10pt serif">f&larr;Form new fromrectangle: superimage rectangle.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bits &larr; f bits.<br> </span><span class="tab" val="79"></span><span style="font: 10pt serif">extent&larr; f extent .<br> </span><span class="tab" val="79"></span><span style="font: 10pt serif">offset &larr; 0⌾0.<br> </span><span class="tab" val="79"></span><span style="font: 10pt serif">superimage white ;<br> </span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">resize ; display ; boxcomp.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">NormalCursor topage1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">setfigure: parentimage </span><span style="font: 10pt serif">| <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"for now just increment the figure color by 1 \ 14"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">figure &larr; (figure +1 ) \ 14.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self displayat: (parentimage origin) effect: 0 clippedBy: user screenrect.<br>]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">setground: parentimage </span><span style="font: 10pt serif">| <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"for now just increment the ground color by 1 \ 14"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ground &larr; (ground +1 ) \ 14.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self displayat: (parentimage origin) effect: 0 clippedBy: user screenrect.<br>]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪Form under: &rsquo;Form Path Image&rsquo;.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">Form classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"FormSet"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;FormSet&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;space spaceorigin image strike style styleindex formindex offsettable&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;imageindex bitmover &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>An object for holding sets of forms.  The most conventional use will be as a repository of a set of forms typically identified as characters when seen on the display or on paper.  The forms will be ascessible by passing a one-character<br>string or a number.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>ACCESS</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asForm: formindex</span><span class="tab" val="79"></span><span style="font: bold 10pt serif">  </span><span style="font: 10pt serif">| f<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"returns the form indexed by formindex ."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self checkindex.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f &larr; Form new extent: (self width) ⌾ (self height) . <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover destraster &larr; (f width + 15 / 16).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover destx &larr; 0. bitmover desty &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover sourcex &larr; (self originx). bitmover sourcey &larr;  0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover width &larr; (self width).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover height &larr; (self ascent) + (self descent).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover sourceraster &larr; (self wordwidth).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover destbase &larr; (f bits).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover sourcebase &larr; strike.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover dstrike &larr; false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover sstrike &larr; true.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover copy: storing.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ f<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">changeascentto: newascent</span><span class="tab" val="79"></span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"new ascent for FormSet"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self deltaascent: (newascent - (self ascent))<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">changedescentto: newdescent</span><span class="tab" val="79"></span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"new ascent for FormSet"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self deltadescent: (newdescent - (self descent))<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">changewidthof: formindex to: width</span><span class="tab" val="79"></span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"new width for form at index"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self checkindex. self deltawidthof: formindex by: (width - (self width))<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Just initialize the bitmover for now."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover &larr; BitBlt init</span><span style="font: italic 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">copy: formindex</span><span class="tab" val="79"></span><span style="font: bold 10pt serif"> to: pt </span><span style="font: 10pt serif">| f<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"copies the form indexed by formindex to pt."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self checkindex.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"f &larr; Image new size: (self width) ⌾ (self height) at: pt."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover destraster &larr; ((user screenrect) width + 15 / 16).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover destx &larr; pt x. bitmover desty &larr; pt y.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover sourcex &larr; (self originx). bitmover sourcey &larr;  0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover width &larr; (self width).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover height &larr; (self ascent) + (self descent).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover sourceraster &larr; (self wordwidth).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover destbase &larr; (mem◦ 066).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover sourcebase &larr; strike.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover strike &larr; true.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover copy: oring.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ self widthof: formindex<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">copy: formindex</span><span class="tab" val="79"></span><span style="font: bold 10pt serif"> to: pt effect: effect </span><span style="font: 10pt serif">| f<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"copies the form indexed by formindex to pt."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self checkindex.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"f &larr; Image new size: (self width) ⌾ (self height) at: pt."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover destraster &larr; ((user screenrect) width + 15 / 16).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover destx &larr; pt x. bitmover desty &larr; pt y.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover sourcex &larr; (self originx). bitmover sourcey &larr;  0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover width &larr; (self width).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover height &larr; (self ascent) + (self descent).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover sourceraster &larr; (self wordwidth).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover destbase &larr; (mem◦ 066).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover sourcebase &larr; strike.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover strike &larr; true.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover copy: effect.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">copyrange: start to: stop from: sourceset startingat: deststart<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| savebackground savebits i f<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"copy a range of forms from one set to another"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user displayoffwhile⦂<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[sourceset is: FormSet ⇒ []<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">sourceset is: String ⇒ [sourceset &larr; FormSet new from: sourceset]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: &rsquo;Illegal sourceset -- not String or Formset.&rsquo;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">savebackground &larr;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">Form new size: (sourceset maxwidth) by: (sourceset height).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">savebackground translate: 0⌾0; scale: 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">savebits &larr; savebackground bitsIntoString.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: start to: stop do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[f &larr; sourceset copy: i to: 0⌾0. self include: deststart with: f.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">deststart &larr; deststart + 1].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">savebackground bitsFromString: savebits.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">currentformindex<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"return index of form last touched"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ formindex<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">currentformorigin |</span><span style="font: 10pt serif"> imageindex</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"return index in image of form last touched"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> imageindex &larr; image find: formindex.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ space ptofchar: imageindex.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">from: strike<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Make a formset out of string in strike format"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self classInit. self install: strike<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">from: first to: last ascent: ascent descent: descent<br></span><span class="tab" val="79"></span><span style="font: bold 10pt serif">style: style styleindex: styleindex name: name<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Make an empty formset."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self classInit.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">offsettable &larr; String new: (last - first + 3) * 2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">offsettable all &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">offsettable word: (last - first + 3) &larr; 4.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"width of illegal form"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strike &larr;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">String new: (9 </span><span style="font: italic 10pt serif">"header"</span><span style="font: 10pt serif"> + ascent + descent </span><span style="font: italic 10pt serif">"space for illegal form"</span><span style="font: 10pt serif">) * 2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strike all &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self type: 0100000.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"for the outside world"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self first: first.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self last: last.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self wordwidth: 1.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"only illegal form"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self ascent: ascent.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self descent: descent.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self maxwidth: 4.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"width of illegal form"</span><span style="font: 10pt serif"><br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strike &larr; strike concat: offsettable ◦ (1 to: offsettable length).<br><br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"mash in bits of illegal form"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"leftside"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover destraster &larr; (self wordwidth).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover destx &larr; 0. bitmover desty &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover width &larr; 1. bitmover height &larr; (self ascent) + (self descent).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover destbase &larr; strike.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover dstrike &larr; true.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover fill: storing color: black.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"rightside"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover destx &larr; 3.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover dstrike &larr; true.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover fill: storing color: black.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"top"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover width &larr; 4. bitmover height &larr; 1. bitmover destx &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover dstrike &larr; true.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover fill: storing color: black.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"bottom"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover desty &larr; (self ascent) + (self descent) - 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover dstrike &larr; true.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover fill: storing color: black.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self install: strike.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self updateseglength.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[style ≡ nil ⇒ []<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">style setfont: styleindex name: name fromstring: strike]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fromspace: pt to: dest<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"get form selected from space"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">formindex &larr; image ◦ ((space charofpt: pt) min: 256).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ (self copy: formindex to: dest).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fromstyle: style styleindex: styleindex<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Make a formset out of string in strike format"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self classInit. self install: style fonts◦(styleindex+1)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">height<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"return height of fromset"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self ascent + self descent<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">include: formindex with: form </span><span style="font: 10pt serif">| newoffsettable newstrike i j<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Put a form into the formset"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(formindex &gt; (self first)) and:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(formindex &lt; (self last)) ⇒ [ self replace: formindex with: form]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">formindex &lt; 0 ⇒ [user notify: &rsquo;Formindex &lt; 0 illegal for formset.&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">formindex &gt; 255 ⇒ [user notify: &rsquo;Formindex &gt; 255 illegal for formset.&rsquo;]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[formindex &lt; (self first) ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[newoffsettable &larr;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">String new: ((self first) - formindex + (self abslength)) * 2.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">newoffsettable all &larr; 0.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">j &larr; (self first) - formindex + 1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i  from: j to: ((newoffsettable length) / 2) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[newoffsettable word: i &larr; strike word: offsettable + (i-j)].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">newoffsettable &larr;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">String new: ((self abslength) + formindex - (self last)) * 2.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">newoffsettable all &larr; 0.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: 0 to: ((self length) - 1) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[newoffsettable word: (i+1) &larr; strike word: offsettable + i].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: (self length) to: ((newoffsettable length) / 2) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[newoffsettable word: i &larr; strike word: offsettable + self length].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">newoffsettable word: ((newoffsettable length) / 2) &larr;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">strike word: (offsettable + self length + 1).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">newstrike &larr; String new: (9 </span><span style="font: italic 10pt serif">"header"</span><span style="font: 10pt serif"> + ((self wordwidth) *<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">((self ascent + self descent)) </span><span style="font: italic 10pt serif">"bits"</span><span style="font: 10pt serif">)) * 2.</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"new space for bits"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: 9 do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[newstrike word: i &larr; strike word: i].</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"fill in header of new font"</span><span style="font: 10pt serif"><br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover destraster &larr; (self wordwidth).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover destx &larr; 0. bitmover desty &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover sourcex &larr; 0. bitmover sourcey &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover width &larr; (self strikerightx).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover height &larr; (self ascent) + (self descent).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover sourceraster &larr; (self wordwidth).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover destbase &larr; newstrike.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover sourcebase &larr; strike.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover strike &larr; true.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover copy: storing.<br><br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"copy the xtable"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">newstrike &larr;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">newstrike concat:  newoffsettable ◦(1 to: newoffsettable length).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self install: newstrike.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[formindex &lt; (self first)  ⇒ [self first: formindex] self last: formindex].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self replace: formindex with: form.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">initspaceat: spaceorigin </span><span style="font: 10pt serif">| i run para<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"make a space for formset viewing"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image &larr; String new: 256.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image all &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: ((self first) to: (self last)+1)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">do⦂ [image◦(i+1) &larr; i].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">run &larr; String new: 2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">run word: 1 &larr;  16 * (styleindex) + 0177400.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">para &larr;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Paragraph new text: image runs: run alignment: 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[space ≡ nil ⇒ [] space erase].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">space&larr; Textframe new para: para<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">frame: (Rectangle new origin: spaceorigin extent:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">((self last) - (self first) * (self maxwidth) / 8)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⌾<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">((self ascent) + (self descent) * 6))<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">style: style.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">makecu: name scale: scale<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| f i iform bits drast srast<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Put out strike in Carnegie-Mellon format.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">A typical call might look like:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">yourset &larr;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">FormSet new style: DefaultTextStyle styleindex: 0.<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">yourset makecu: &rsquo;cream12&rsquo; scale: 1.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user  displayoffwhile⦂<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f &larr; (dp0 file: name + &rsquo;.cu.&rsquo;).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f nextword &larr; self height * scale.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f nextword &larr; self maxwidth * scale + 15 / 16.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bits &larr; String new:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">((self height * scale) * ((self maxwidth * scale + 15)/16))<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">* 2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">drast &larr; self maxwidth * scale + 15 / 16.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">srast &larr; (user screenrect width) + 15/16.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: ((self first) to: (self last) by: 1) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[iform &larr; "self copy: i to: 0⌾0" self asForm: i. <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">iform displayat: (0⌾0) effect: 0 clippedBy: user screenrect.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[scale &gt; 1 ⇒ [iform blowup: 0⌾0 by: scale]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">f nextword &larr; i. f nextword &larr; self width*scale.<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover destbase &larr; bits.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover destraster &larr; drast.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover destx &larr; 0. bitmover desty &larr; 0.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover sourcebase &larr; mem◦066.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover sourceraster &larr; srast.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover sourcex &larr; 0. bitmover sourcey &larr; 0.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover dstrike &larr; false.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover sstrike &larr; true.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover width &larr; (iform width) * scale.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover height &larr; (iform height) * scale.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">bits all &larr; 0.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover copy: storing.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">f append: bits].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f close.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">newspace<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"let user reshape/position space"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">space frame &larr; Rectangle new fromuser. self show.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">replace: formindex with: form<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Replace form in set.  Check incoming form for compatibility with formset,<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">and insert form into formset."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self checkindex.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[form width ≠ self width ⇒ [self changewidthof: formindex to: form width]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">form displayat: (0⌾0) effect: 0 clippedBy: user screenrect.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"copy bits of form into formset"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover destraster &larr; (self wordwidth).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover destx &larr; (self originx). bitmover desty &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover sourcex &larr; 0. bitmover sourcey &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover width &larr; (self width).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover height &larr; (self ascent) + (self descent).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover sourceraster &larr; ((user screenrect) width + 15 / 16).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover destbase &larr; strike.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover sourcebase &larr; (mem ◦ 066).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover dstrike &larr; true.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover copy: storing.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">show<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"show all the forms in the set"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">space outline. space show<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">space<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"return textframe that is space of formset"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ space <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">spaceframe<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"return frame of space"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑(space frame)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">spaceorigin: spaceorigin<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"reposition the space"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">space erase. (space frame) origin &larr; spaceorigin. self show.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">widthof: formindex<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"return width of from at formindex"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self width<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>INTERNAL</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">abslength<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Return absolute length of formset, i.e. number of forms in set<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">plus space for illegal character and its rightx"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ ((self last) - (self first) + 3)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">checkindex<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"check formindex for legality and make into number if necessary"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[formindex is: String ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[formindex length &gt; 1 ⇒ [user notify: &rsquo;formindex out of range for FormSet.&rsquo;]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">formindex &larr; formindex◦1]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(formindex &lt; (self first)) or: (formindex &gt; (self last+1)) ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user notify: &rsquo;formindex out of range for this FormSet.&rsquo;]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">deltaascent: delta </span><span style="font: 10pt serif">| newstrike<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"ascent delta"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(self ascent) + delta &lt; 0 ⇒[delta &larr; 0 - (self ascent)]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[delta &gt; 0 ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"grow"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">newstrike &larr; String new: (2 * (self wordwidth) * delta).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">newstrike all &larr;  0.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"fill with white"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">newstrike &larr;</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"add oldfont header and new space together"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(strike◦(1 to: 18) concat: newstrike◦(1 to: newstrike length)).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">newstrike &larr;</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"now add on rest of old font"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(newstrike concat: strike◦(19 to: strike length)).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"shrink"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">newstrike &larr; (strike◦(1 to: 18) concat:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">strike◦((19 + (0 - (2 * (self wordwidth) * delta)))<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">to: strike length)).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">newstrike word: 6 &larr; ((self ascent) + delta).</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"reset ascent word in font"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self install: newstrike.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"newstrike now font of interest"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self updateseglength.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[style ≡ nil ⇒ [ ]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(style maxascent) &lt; (self ascent) ⇒ [style maxascent: (self ascent)]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">deltadescent: delta </span><span style="font: 10pt serif">| newstrike somespace<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"descent delta"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(self descent) + delta &lt; 0 ⇒ [ delta &larr; 0 - (self descent)]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[delta &gt; 0 ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[somespace &larr; String new: 2 * (self wordwidth) * delta.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">somespace all &larr; 0.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">newstrike &larr;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(strike ◦ (1 to: offsettable - 1 * 2) concat: somespace).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">newstrike &larr;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(strike ◦ (1 to: ((offsettable - 1 * 2)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">+ ((self wordwidth) * delta * 2)))).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"copy the xtable"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">newstrike &larr;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">newstrike concat: strike ◦ ((offsettable * 2 - 1) to: strike length).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">newstrike word: 7 &larr;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">((self descent) + delta).</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"reset descent word in font"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self install: newstrike.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"updatedfont now font of interest"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self updatemaxwidth.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self updateseglength.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[style ≡ nil ⇒ [ ]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(style maxdescent) &lt; (self descent) ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[style maxdescent: (self descent)]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">deltawidthof: index by: delta<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">| newwordwidth newoffsettable newstrike normalizedindex normalizedlast i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"change width of form at index"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[delta &lt; 0 ⇒ [(delta abs) &gt; (self width) ⇒ [delta &larr; 0-(self width)]]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">newwordwidth &larr;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[((self strikerightx) + 15 / 16) ≠<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(i &larr; ((self strikerightx) + delta + 15 / 16)) ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ i ]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(self wordwidth)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">newoffsettable &larr; newwordwidth *<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">((self ascent + self descent)) </span><span style="font: italic 10pt serif">"height"</span><span style="font: 10pt serif"> + 9 </span><span style="font: italic 10pt serif">"header"</span><span style="font: 10pt serif"> + 1 </span><span style="font: italic 10pt serif">"for 0 addressing"</span><span style="font: 10pt serif">.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">XeqCursor showwhile⦂ <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">newstrike &larr; String new: (9 </span><span style="font: italic 10pt serif">"header"</span><span style="font: 10pt serif"> + (newwordwidth *<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">((self ascent + self descent)) </span><span style="font: italic 10pt serif">"bits"</span><span style="font: 10pt serif">)) * 2.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"grow/shrink the bits"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">newstrike all &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: 8 do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[newstrike word: i &larr; strike word: i].</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"fill in header of new font"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">newstrike word: 9 &larr; newwordwidth.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"set raster in new font"</span><span style="font: 10pt serif"><br><br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"copy the xtable"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">newstrike &larr; newstrike concat: strike◦((offsettable * 2 - 1) to: strike length).<br><br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"set up to copy up to old bits of form in formset"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover destraster &larr; newwordwidth.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover destx &larr; 0. bitmover desty &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover sourcex &larr; 0. bitmover sourcey &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover width &larr; (self originx) + (self width).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover height &larr; (self ascent) + (self descent).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover sourceraster &larr; (self wordwidth).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover destbase &larr; newstrike.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover sourcebase &larr; strike.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover sstrike &larr; true.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover dstrike &larr; true.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover copy: storing.<br><br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"now copy remainder of font"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover destx &larr; (self originx) + (self width) + delta.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover width &larr; (self strikerightx) - (self originx) - (self width).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover sourcex &larr; (self originx) + (self width).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitmover copy: storing.<br><br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"shift x-vals"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">normalizedindex &larr; formindex - (self first).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">normalizedlast &larr; (self last) - (self first).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: ((normalizedindex + 1) to: (normalizedlast + 2 </span><span style="font: italic 10pt serif">"max"</span><span style="font: 10pt serif">)) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[newstrike word: (newoffsettable+i) &larr;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">delta + (newstrike word: (newoffsettable+i))].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self install: newstrike.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"set up the updated copy of the formset"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self updatemaxwidth.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self updateseglength. <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">install: strike<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"set up a new or refreshed strike"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[style ≡ nil ⇒ [] style fonts ◦ (styleindex + 1) &larr; strike].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">offsettable &larr; (self wordwidth) *<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">((self ascent) + (self descent)) + 9 </span><span style="font: italic 10pt serif">"header"</span><span style="font: 10pt serif"> + 1 </span><span style="font: italic 10pt serif">"for 0 addressing"</span><span style="font: 10pt serif">.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ strike]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">length<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Return length of formset, i.e. number of forms in set"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ ((self last) - (self first) + 1)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">originx<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Return origin x  of form at formindex"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ (strike word: (offsettable + formindex - (self first)))]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">updatemaxwidth </span><span style="font: 10pt serif">| newmaxwidth i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"update max width"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">newmaxwidth &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(offsettable to: offsettable + ((self last) - (self first) + 1))<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[newmaxwidth &larr;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(newmaxwidth<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">max: ((strike word: i+1) - (strike word: i)))].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self maxwidth: newmaxwidth.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">updateseglength<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"compute new segment length for formset"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strike word: 5 &larr;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(5</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"length, ascent, descent, kern, and raster"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">+ ((self wordwidth) * ((self ascent) + (self descent)))</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"bits"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">+ ((self last "max") - (self first</span><span class="tab" val="79"></span><span style="font: 10pt serif">"min") + 2)</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"xtabl"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">width<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Return width of form at formindex"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ (strike word: (offsettable + (formindex - (self first)) + 1)) -<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(strike word: (offsettable + (formindex - (self first)))) ]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>PARTS</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">ascent<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"When form set treated as characters, describes distance from top of form<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">to baseline."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑(strike word: 6)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">ascent: ascent<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"When form set treated as characters, describes distance from top of form<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">to baseline."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strike word: 6 &larr; ascent.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">descent<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"When form set treated as characters, describes distance from bottom of<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">form to baseline."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑(strike word: 7)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">descent: descent<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"When form set treated as characters, describes distance from bottom of<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">form to baseline."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strike word: 7 &larr; descent.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">first<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Heritage from the world of fonts"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑(strike word: 2)</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"minimum formindex (ascii) in the strike"</span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">first: first<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Heritage from the world of fonts"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strike word: 2 &larr; first.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"minimum formindex (ascii) in the strike"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">kern<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"When form set treated as characters, describes distance this form is<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">to intrude into space of preceding character."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑(strike word: 8)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">last<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Heritage from the world of fonts"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑(strike word: 3)</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"maximum formindex (ascii) in the strike"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">last: last<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Heritage from the world of fonts"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strike word: 3 &larr; last.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"maximum formindex (ascii) in the strike"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">maxwidth<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"All forms in this set ≤ to this value"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑(strike word: 4)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">maxwidth: maxwidth<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"All forms in this set ≤ to this value"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strike word: 4 &larr; maxwidth.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">segmentlength<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Amount of space allocated for form set - 4"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑(strike word: 5)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">strikerightx<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["Corner x of last form in form set"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑(strike word: (offsettable + ((self last) - (self first)) + 2)).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">type<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"**BEWARE -- outside world has ideas about this value."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑(strike word: 1)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">type: type<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"**BEWARE -- outside world has ideas about this value."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strike word: 1 &larr; type.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">wordwidth<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Also know as the raster of the formset.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">The width in alto words of the bits of the formset.  When the display of a <br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">form is desired, the word and bit address of the bits of the form must<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">be discovered.  Adding the wordwidth to the word portion of that value,<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">produces the word address of the second line of the bits of the form, and<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">so on until the height of the form is spanned."</span><span style="font: 10pt serif"><br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑(strike word: 9)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">wordwidth: wordwidth<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Also know as the raster of the formset.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">The width in alto words of the bits of the formset.  When the display of a <br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">form is desired, the word and bit address of the bits of the form must<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">be discovered.  Adding the wordwidth to the word portion of that value,<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">produces the word address of the second line of the bits of the form, and<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">so on until the height of the form is spanned."</span><span style="font: 10pt serif"><br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strike word: 9 &larr; wordwidth.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪FormSet under: &rsquo;Form Path Image&rsquo;.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">FormSet classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"Image"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;Image&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Set<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo; origin rectangle path form superimage xgrid ygrid figure ground&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;aurora under black screen reverse white over aurorarunning &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>This class has not yet been commented</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>INIT</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">blink: form </span><span style="font: 10pt serif">| pt <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["to show current gridded position of the form... returns abs position."<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pt &larr; self mp.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">form displayat: ( rectangle origin)+ pt<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">effect: 2 clippedBy: user screenrect.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">form displayat: ( rectangle origin)+ pt<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">effect: 2 clippedBy: user screenrect.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ (self rectangle origin)+ pt<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["sets up black and white as colors and over ,under and reverse as modes<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">also initializes the name screen as an image the size of the display"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">black &larr; 0-1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">white &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">over &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">under &larr; 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">reverse &larr; 2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">screen &larr; Image new origin: user screenrect origin extent: user screenrect extent.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">aurora &larr; "Aurora new" nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">aurorarunning &larr; false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fromuser<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["create a new Image whose rectangle is specified by the user. "<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rectangle &larr; Rectangle new fromuser.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self origin: (rectangle origin) rectangle: rectangle<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">path: (rectangle origin) form: (Form new fromrectangle: rectangle)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">figure: 1 ground: 0 xgrid: 1 ygrid: 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">origin: origin extent: extent <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["create a new Image at origin with extent (width⌾height). "<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self origin: (origin copy)  rectangle: (Rectangle new origin: origin extent: extent)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> path: nil form: nil figure: 1 ground: 0 xgrid: 1 ygrid: 1<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">origin: origin rectangle: rectangle path: path form: form<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["basic message to create a new instance."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self origin: origin rectangle: rectangle path: path form: form<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">figure: 1 ground: 0 xgrid: 1 ygrid: 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">origin: origin rectangle: rectangle path: path form: form figure: figure ground: ground xgrid: xgrid ygrid: ygrid<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["basic message to create a new instance."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self default]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">rectanglefromuser | f pt r<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["create a  Rectangle  specified by the user and origin and corner are gridded. "<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">r &larr; Rectangle new.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f &larr; Form new extent: xgrid⌾ygrid. f black.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user waitnobug.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ user anybug do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">r origin &larr; self blink: f.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ user nobug do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">r corner &larr; (self mp + rectangle origin) max: (r origin + f extent).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">r reverse ; reverse.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ r.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>BUILDING IMAGES</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">add: p and: i | s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["add p (set or point) and i ( Image or Form ) and expand the<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> bounding rectangle of this image."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rectangle &larr;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">rectangle include:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">((Rectangle new origin: (p origin)+ origin extent: i size)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">include: (Rectangle new origin: (p corner)+ origin extent: i size)).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s &larr; Set default. s add: p ; add: i .<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self add: s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">addform: f andpath: p | r<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["add p (set or point) and f ( Form ) and expand the<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> bounding rectangle of this image."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self addpath: p andform: f<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">addimage: i  | r<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["add the Image i (as a subimage) and expand the<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> bounding rectangle of this image."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rectangle &larr;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">rectangle<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">include:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(Rectangle new origin: (i origin)+ origin extent: i extent).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self add: i.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">addpath: p andform: f | r<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["add p (set or point) and f ( Form ) and expand the<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> bounding rectangle of this image."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rectangle &larr;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">rectangle<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">include:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(r &larr; ((Rectangle new origin: (p origin)"+ origin" extent: f extent)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">include:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(Rectangle new origin: ((p corner) - (1⌾1))"+ origin" extent: f extent))).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self add: (Image new origin: 0⌾0 rectangle: r path: p form: f<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">figure: 1 ground: 0 xgrid: 1 ygrid: 1).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>CHANGING IMAGES</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">appendimage: newimage after: image </span><span style="font: 10pt serif">| i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["append newimage into the image after image."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; self findbyrect: image.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self insertI: (i+1) value: newimage.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">comment<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["see class Set for operations (deletion,replacement,insertion etc.) on subimages ( elements)."]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">deleteimage: i | subimage<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["delete the i th subimage and recompute the bounding rectangle of the Image"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">subimage &larr; self◦i.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self deleteI: i.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">( subimage rectangle) isWithin: rectangle⇒ [] self resize "recompute bounding rectangle"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">deletesubimage: i <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["delete the ith subimage."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self deleteindex: i.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">edit: superimage | </span><span style="font: 10pt serif">blackdot pt indexofsubimage subimage</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["eventually a general Image manipulator for now<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">just passes control to its subimages."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nil≡ form ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user waitnobug.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ (1 = 2) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> "until bug occurs outside rectangle"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">((false = (rectangle has: (user mp))) and: (user anybug))⇒[⇑ self ]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user kbck ⇒ [ self kbd ]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user redbug⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[indexofsubimage &larr; self smallestsubimageat:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">( (user mp) - self rectangle origin).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">indexofsubimage⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ subimage &larr; self◦indexofsubimage.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">subimage translate: self origin .<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">subimage edit: self.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">subimage translate: ((0⌾0)-self origin).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user yellowbug⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self yellowbug<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">form &larr; form edit: self.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[form is: Form⇒ [] "origin &larr;  (form origin) copy." rectangle &larr; (form frame) copy].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ self <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">findbyrect: image </span><span style="font: 10pt serif">| i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: position do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(array◦i) rectangle = image rectangle ⇒ [⇑i]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">highlite  | r i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["reverse the ith subimage ."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: position do⦂ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">r &larr; Rectangle new origin: (self origin+ (self◦i) origin)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">extent: (self◦i) extent.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">r comp<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">indexofsubimageat: pt | i subimage <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["return the index of the subimage which contains pt(relative to self origin)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">otherwise return false."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: self length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[subimage &larr; (self◦i).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(subimage rectangle) has: pt⇒ [ ⇑ i]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ false<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">indexofsubimagebelow: yvalue | i subimage <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["return the index of the first subimage below yvalue otherwise return false."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: self length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ ((self◦i) top ≥ yvalue) ⇒ [ ⇑ i]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ false<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">outlinesubimage: i  | r<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["draw an outline(reversed boarder 2 units thick) about the ith subimage ."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">r &larr; Rectangle new origin: (self origin+ (self◦i) origin)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">extent: (self◦i) extent.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">r comp<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">replaceimage: image with: newimage </span><span style="font: 10pt serif">| i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["replace image with newimage in self."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; self findbyrect: image.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self replaceI: i value: newimage.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">smallestsubimageat: pt | i smallest slf sml<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["return the index of the smallest subimage which contains pt(relative to self origin)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">otherwise return false."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">smallest &larr; false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: self length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">((self◦i) rectangle) has: pt⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">smallest⇒[ slf&larr;((self◦i) rectangle).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">sml&larr;((self◦smallest) rectangle).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(slf area &lt; sml area) ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[smallest &larr; i]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">  ]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">smallest &larr; i<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">smallest⇒[⇑ self◦smallest]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ smallest</span><span style="font: bold italic 10pt serif"> </span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">subimage: i | sub s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["return the ith subimage."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sub &larr; (self◦i)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s &larr; Image new at: (self origin) + (sub◦1) origin. s add: (0⌾0) and: sub◦2. <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">subimageat: pt | i <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["return the  subimage which contains pt (relative to self origin)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">otherwise return false."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; self indexofsubimageat: pt.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i ⇒ [ ⇑ self◦ i]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ false<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">subimageswithin: rect | image topleft fittedimage t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["return an image containing my subimages that are within rect, </span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">otherwise return false."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image &larr; Image new origin: rect origin extent: rect extent.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ t from: self do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(t rectangle) isWithin: rect⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">image addimage: (t translate: (0⌾0)-(rect origin))<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image length = 0⇒[⇑ false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">topleft &larr; (image◦1) rectangle origin.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ t from: image do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(t rectangle origin) &lt; topleft⇒ [topleft &larr; (t rectangle origin)]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fittedimage &larr; Image new origin: (topleft+rect origin) extent: (1⌾1).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ t from: image do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ fittedimage addimage: (t translate: (0⌾0)-topleft)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ fittedimage</span><span style="font: bold italic 10pt serif"> </span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">substitute: form1 for: form2 </span><span style="font: 10pt serif">| i <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["everywhere in the imagesubstitute form1 for form2"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: self length do⦂ [ (self◦i)◦2 ≡ form2 ⇒  [ (self◦i)◦2 &larr; form1]]  <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>DISPLAY</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">blink <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["blink the image" <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self display: 2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self display: 2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">display <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["display all of the forms in the image on the screen "<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self displayat: 0⌾0 effect: 0 clippedBy: user screenrect.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">display: effect  <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["display all of the forms in the image on the screen <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">effect = 0 ⇒ store<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">effect = 1 ⇒ or<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">effect = 2 ⇒ xor<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">effect = 3 ⇒ and complement<br>"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self displayat: 0⌾0 effect: effect clippedBy: user screenrect.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">displayat: pt effect: effect clippedBy: cliprect </span><span style="font: 10pt serif">| i <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["display all of the subimages in this image "<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[nil≡ form</span><span class="tab" val="79"></span><span style="font: 10pt serif">⇒ []<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">form displayat: (path + pt+ origin) effect: effect clippedBy: cliprect].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: self length  do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ (self◦i) displayat: (pt +  origin) effect: effect clippedBy: cliprect<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">quickDisplayAt: pt scale: scal offset: delta </span><span style="font: 10pt serif">| i rect x1 y1 x2 y2<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["outline me and all of the subimages in this image in given scale"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">x1&larr; (scal*(rectangle minX + pt x) + delta x) asInteger.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">y1&larr; (scal*(rectangle minY + pt y) + delta y) asInteger.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">x2&larr; (scal*(rectangle maxX + pt x) + delta x) asInteger.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">y2&larr; (scal*(rectangle maxY + pt y) + delta y) asInteger.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rect &larr; x1⌾y1 rect: x2⌾y2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rect outline.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pt &larr; pt+origin.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: self length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[rect &larr; (self◦i) rectangle.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">x1&larr; (scal*(rect minX + pt x) + delta x) asInteger.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">y1&larr; (scal*(rect minY + pt y) + delta y) asInteger.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">x2&larr; (scal*(rect maxX + pt x) + delta x) asInteger.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">y2&larr; (scal*(rect maxY + pt y) + delta y) asInteger.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">rect &larr; x1⌾y1 rect: x2⌾y2.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">rect color: gray mode: oring.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>MODULE ACCESS</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">= image<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑(rectangle = (image rectangle))<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">bottom<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["return the bottom y of the bounding rectangle of theImage."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ rectangle corner y.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">center<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["return the center of the Image."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ rectangle center.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">contains: pt <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["return true if the  bounding rectangle for the Image contains pt.."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ rectangle has: pt<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">corner<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["return the corner of the Image."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ rectangle corner.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">corner&larr; pt<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["modify the corner of the Image."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> rectangle corner&larr; pt.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">extent <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["return the extent (width,height) of the Image."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ rectangle extent<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">height<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["return the height of the Image."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ rectangle extent y.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">leftside<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["return the leftmost x of the bounding rectangle of theImage."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ rectangle origin x.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">origin<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["return the origin of the image."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ origin<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">origin: origin<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["change the origin of the image."]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">rectangle <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["return the rectangle that bounds the Image."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ rectangle<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">rectangle: r <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["redefine rectangle that bounds the Image."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rectangle&larr; r<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">resize | i <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[" Recompute the bounding rectangle of the Image"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[nil≡ form</span><span class="tab" val="79"></span><span style="font: 10pt serif">⇒ [rectangle &larr; Rectangle new origin: origin extent: 1⌾1]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">rectangle &larr; Rectangle new origin: origin extent: form extent].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: self length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ rectangle  &larr; rectangle include: ((self◦i) rectangle) ]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">rightside<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["return the rightmost x of the bounding rectangle of theImage."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ rectangle corner x.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">superimage<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["return the superimage (Image containing) of this Image."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ superimage<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">top<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["return the top y of the bounding rectangle of theImage."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ rectangle origin y.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">width<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["return the width of the Image."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ rectangle extent x.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>PATTERN ACCESS</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">black<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["black out the image"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self color: black effect: 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">boxcomp <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["border without disturbing the interior."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rectangle comp<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">color: color effect: effect <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["basic rectangle call to blt."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rectangle color: color mode: effect .<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">aurorarunning⇒</span><span class="tab" val="79"></span><span style="font: 10pt serif">[user displayoffwhile⦂ [aurora destination: rectangle ; source: rectangle ;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">figure: figure ; ground: ground ;  function: 002117 "AoverB" ; doit<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]]<br> ]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">gray<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["gray out the image"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self color: gray effect: storing<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">reverse<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["reverse  the image (black to white and white to black)"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self color: black effect: 2<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">white <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["white out the image"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">form is: BorderedText⇒ [ (rectangle inset: (¬1⌾¬1) and: (¬1⌾¬1)) clear: 0]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self color: white effect: over.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>TRANSFORMATIONS</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">griddedpoint: pt <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑ ((pt x)| xgrid) ⌾ ((pt y)| ygrid) ]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">normalize | delta i <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["recompute origin, rectangle and path so that: path origin = 0⌾0."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[nil ≡ path ⇒ [] delta &larr; (path origin) copy. path normalize. origin translate: delta]. </span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: self length do⦂ [ (self◦i) normalize ].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">translate: delta <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["translate the origin and bounding rectangle of the Image."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rectangle &larr; rectangle translate: delta.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">origin translate: delta.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">translateto: pt <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["move the Image to pt."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self translate: pt - origin.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>SYSTEM</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">copy </span><span style="font: 10pt serif">| im i<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">im &larr; Image new origin: origin copy rectangle: rectangle copy path: path copy form: form copy figure: figure copy ground: ground copy xgrid: xgrid copy  ygrid: ygrid copy.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: self length do⦂ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[im add: (self◦i) copy].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ im<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fromPress: press value: s </span><span style="font: 10pt serif">| numberofsubimages i code t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">retrieves and builds an instance of class Image from a press file</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self default. <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">numberofsubimages&larr; s nextword.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">origin &larr; s nextPoint.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; s nextPoint.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rectangle &larr; i rect: s nextPoint.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">xgrid &larr; s nextword.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ygrid &larr; s nextword.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">figure &larr; s nextword.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ground &larr; s nextword.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">form &larr; s next.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">path &larr; s next.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: numberofsubimages do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s &larr; press nextControl asStream.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">code &larr; s next.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">t &larr; Image new.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">code = t pressCode⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self addimage: (t fromPress: press value: s)]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: &rsquo;subimage not Image&rsquo;].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[form=0⇒ [form &larr; nil]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s &larr; press nextControl asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">code &larr; s next.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">form &larr; [code = 4⇒ [TextImage new]; =5⇒ [Form new]; = 6 ⇒[BorderedText new] false].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">form and⦂ code = form pressCode⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[code=4⇒ [form frame &larr; rectangle copy]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[code=6⇒ [form frame &larr; rectangle copy]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">form fromPress: press value: s]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: &rsquo;illegal form&rsquo;].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[path=0⇒ [path &larr; nil]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s &larr; press nextControl asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">code &larr; s next.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">path &larr; [code = 6⇒ [Path new]; =7⇒ [Point new] false].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">path and⦂ code = path pressCode⇒ [path fromPress: press value: s]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: &rsquo;illegal path&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hideData: complete </span><span style="font: 10pt serif">| s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">stores an instance of class Image on a press file. ignore complete</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Stream new of: (s &larr; String new: 24);<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextword&larr; self length; "</span><span style="font: italic 10pt serif">number of subimages</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextPoint&larr; origin;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextPoint&larr; rectangle origin;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextPoint&larr; rectangle corner;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextword&larr; xgrid;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextword &larr; ygrid;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextword &larr; figure;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextword &larr; ground;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">next &larr; [form≡nil ⇒ [0] 1];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">next &larr; [path≡nil⇒ [0] 1].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ s]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hidePress: press complete: c </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">c ≥ 0⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">called from </span><span style="font: bold 10pt serif">PressPrinter print:in:</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[form≡nil⇒ ["</span><span style="font: italic 10pt serif">already done</span><span style="font: 10pt serif">"]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">form hidePress: press complete: c].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">path≡nil⇒ []<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">path hidePress: press complete: c]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">¬1. called from </span><span style="font: bold 10pt serif">Image presson:in:</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">press skipcode: self pressCode data: (self hideData: c)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">kbd | <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[" default response for Images."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user kbd.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self reverse ; reverse.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">mp | p<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[" returns a gridded point relative to my rectangle."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">p &larr; user mp.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">p x&larr; ((p x) - rectangle origin x) | xgrid. <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">p y&larr; ((p y) - rectangle origin y) | ygrid.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ p<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pressCode </span><span style="font: 10pt serif">[⇑1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">presson: press in: r </span><span style="font: 10pt serif">| yvalue t h rect [</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self length &gt; 0 and⦂ r height &lt; (h &larr; press scale * self height)⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">try on next page</span><span style="font: 10pt serif">" ⇑self]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self hidePress: press complete: ¬1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ t from: self do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">yvalue &larr;  t presson: press in: r.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">if subimage didn&rsquo;t fit, print version will be clipped,<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">but entire subimage will be stored</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">t hidePress: press complete: [yvalue is: Integer⇒ [0] 1]].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">form≡nil⇒ [⇑r corner y - h]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rect &larr; r copy.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rect corner y &larr; rect corner y - (( path y)*(press scale)).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">form will be hidden by Image presson:in: or PressPrinter print:in:</span><span style="font: 10pt serif">".<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑form presson: press in: rect]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm </span><span style="font: 10pt serif">| t [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm append: &rsquo;an Image: &rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">array is: String⇒ [strm space append: self]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ t from: self do⦂ [strm space print: t]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>ACCESS TO PARTS</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">figure<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["return the figure color (color associated with black) for this Image"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ figure<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">figure: figure <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["change the figure color (color associated with black) for this Image"]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">form <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["return the form for this Image"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ form<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">form: form <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["change the form for this Image"]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">ground<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["return the ground color (color associated with white) for this Image"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ ground<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">ground: ground <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["change the ground color (color associated with white) for this Image"]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hash </span><span style="font: 10pt serif">[⇑rectangle hash]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">path <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["return the path for this Image"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ path<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">path: path<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["change the path for this Image"]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">superimage: superimage </span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">xgrid <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["return the x gridding module for this Image"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ xgrid<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">xgrid: xgrid <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["set the x gridding module for this Image"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">ygrid <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["return the y gridding module for this Image"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ ygrid<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">ygrid: ygrid <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["set the y gridding module for this Image"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Fist and last</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">close<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">| im<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[array≡nil<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇒[]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ im  from: self asArray notNil do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[im close]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">superimage&larr;nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">form&larr;nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self vector: 0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪Image under: &rsquo;Form Path Image&rsquo;.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">Image classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"Path"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;Path&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Set<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>This class has not yet been commented</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>INIT</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["must be executed for each new instance."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self default.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>BUILDING PATHS</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">comment <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["see Set for these ... add:, append:, and ◦&larr; are the main ones"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>ACCESSING PATHS</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pointnearestto: p </span><span style="font: 10pt serif">| distance i nearest d<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["return the index of the point  in the path nearest (manhatten norm) to p."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">distance &larr; p dist: self◦1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nearest &larr; 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: position do⦂ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span class="tab" val="79"></span><span style="font: 10pt serif">d &larr;  p dist: self◦i .<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">d&lt; distance⇒ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ nearest&larr; i. distance &larr; d.]  <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ nearest<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>MODIFYING PATHS</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">deleteindex: i </span><span style="font: 10pt serif">| r [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">r &larr; array◦( i+1 to: position).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">position &larr; i-1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self append: r.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">array◦(position+1) &larr; nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">insert: pt atindex: index </span><span style="font: 10pt serif">| r <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"insert pt at index in the path"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">index &gt; position⇒ [self next &larr; pt]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">r &larr; [position = limit⇒ [self grow] self growby: 0].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">position &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self append: (r ◦ 1 to: index-1);<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">next &larr; pt;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">append: r◦(index to: r length).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>SPECIAL PATHS</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">addarcfrom: p1 via: p2 to: p3 </span><span style="font: 10pt serif">| pa pb i k s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Kaehler method for Flegal curve"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s&larr; Path new init. <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s add: p1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pa&larr; p2-p1. pb&larr; p3-p2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">k&larr; 5 max: (pa x abs + pa y abs + pb x abs + pb y abs)/20.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: k do⦂</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"k is a guess how many segments are appropriate"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s add: (pa*i/k+p1*(k-i)) + (pb*(i-1)/k+p2*(i-1)) / (k-1)]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s add: p3 .<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: (s length-1) do⦂ [  self addlinefrom: s◦i to: s◦(i+1) ] <br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">addlinefrom: p1 to: p2 |</span><span style="font: 10pt serif"> x1 y1 dx dy yinc x0 y0 cdl i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"for now just add points to the space at alto resolution between p1 and p2<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">inclusive"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dx&larr; ( p2 x) - (p1 x).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dy&larr; ( p2 y) - (p1 y).<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[dx &lt; 0 ⇒ [dx &larr; 0-dx. dy &larr; 0-dy. x0&larr; p2 x. y0 &larr; p2 y]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">x0 &larr; p1 x. y0 &larr; p1 y].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[dy ≥ 0 ⇒ [yinc&larr;1] yinc &larr; 0-1 . dy &larr; 0-dy].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> dx≥dy⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[cdl &larr; ( dx/2).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: 0 to: dx do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self add: (x0⌾y0). cdl &larr; cdl + dy.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">x0 &larr; x0+1. <br> </span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">cdl &gt; dx⇒ [cdl &larr; cdl - dx. y0 &larr; y0 + yinc]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br><br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"y is fastest mover"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">cdl &larr; (dy/2).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: 0 to: dy do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self add: (x0⌾y0) . cdl &larr; cdl+ dx.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">y0 &larr; y0 + yinc.  <br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> cdl &gt; dy ⇒ [cdl &larr; cdl - dy. x0&larr; x0+1]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]. <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>TRANSFORMATIONS</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">+ delta </span><span style="font: 10pt serif">| i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ "add delta to every point in the path"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ (self copy) translate: delta<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">normalize </span><span style="font: 10pt serif">| delta i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ "subtract the origin of the path from every point in the path"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">delta &larr; self origin.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: self length  do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ self◦i &larr; self◦i - delta<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">scale: factor </span><span style="font: 10pt serif">| i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ "scale every point in the path by factor"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: self length  do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ self◦i &larr; self◦i * factor<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">translate: delta </span><span style="font: 10pt serif">| i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ "add delta to every point in the path"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: self length  do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ self◦i &larr; self◦i + delta<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>MEASURING</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">corner <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["return the corner of the bounding rectangle that includes all the points in the path."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ (self rectangle) corner<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">extent <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["return the extent of the bounding rectangle that includes all the points in the path."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ (self rectangle) extent]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">height <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["return the height of the bounding rectangle that includes all the points in the path."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ self size y]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">origin <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["return the origin of the bounding rectangle that includes all the points in the path."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ (self rectangle) origin<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">rectangle | r  i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["return the bounding rectangle that includes all the points in the path."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">r &larr; Rectangle new origin: self◦1 extent: 1⌾1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: self length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ r &larr; r include: self◦i</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ r<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">size <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["return the extent of the bounding rectangle that includes all the points in the path."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ (self rectangle) extent]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">width <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["return the width of the bounding rectangle that includes all the points in the path."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ self size x]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>SYSTEM</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">copy  | t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["returns a new instance of Path that is a copy "<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">t &larr; Path new init.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">t append: (array◦(1 to: position)) copy.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ t]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pressCode </span><span style="font: 10pt serif">[⇑6]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm </span><span style="font: 10pt serif">| t [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm append: &rsquo;a Path: &rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">array is: String⇒ [strm space append: self]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ t from: self do⦂ [strm space print: t]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪Path under: &rsquo;Form Path Image&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"Point"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;Point&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;x y&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I am an x-y pair of numbers usually designating a location on the screen</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">copy <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑ (x⌾y)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">x: x y: y</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Arithmetic</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">≤ pt </span><span style="font: 10pt serif">[⇑ x≤pt x and⦂ y≤pt y]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">≥ pt </span><span style="font: 10pt serif">[⇑ x≥pt x and⦂ y≥pt y]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">* scale<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Return a Point that is the product of me and scale (which is a Point or Number)"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑Point new x: (x * scale asPtX) y: (y * scale asPtY)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">+ delta<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Return a Point that is the sum of me and delta (which is a Point or Number)"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑Point new x: (x + delta asPtX) y: (y + delta asPtY)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">- delta<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Return a Point that is the difference of me and delta (which is a Point or Number)"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑Point new x: (x - delta asPtX) y: (y - delta asPtY)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">/ scale<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Return a Point that is the quotient of me and scale (which is a Point or Number)"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑Point new x: (x / scale asPtX) y: (y / scale asPtY)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">&lt; pt </span><span style="font: 10pt serif">[⇑ x&lt;pt x and⦂ y&lt;pt y]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">= pt </span><span style="font: 10pt serif">[⇑x=pt x and⦂ y=pt y]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">&gt; pt </span><span style="font: 10pt serif">[⇑x&gt;pt x and⦂ y&gt;pt y]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">abs</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"absolute value of a point"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑Point new x: (x abs) y: (y abs)</span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dist: pt </span><span style="font: 10pt serif">| t</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"distance (Manhattan norm) between pt and self"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t &larr; (pt - self) abs.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑(t x) + (t y)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">length<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑((x asFloat*x asFloat)+(y asFloat*y asFloat)) sqrt]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">max: t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑Point new x: (x max: t x) y: (y max: t y)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">min: t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑Point new x: (x min: t x) y: (y min: t y)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">normal </span><span style="font: 10pt serif">| n</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"unit vector rotated 90 deg clockwise"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[n&larr; y asFloat neg ⌾ x asFloat.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑n/n length]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">normalize <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"set selt to zero"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self x &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self y &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">translate:  delta<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"increment self by delta"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">x &larr; x + delta x.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">y &larr; y + delta y.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">| grid<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑Point new x: x|grid y: y|grid]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Conversion</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asPoint<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Return self."</span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asPtX<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑x]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asPtY<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑y ]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asRectangle<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Return a Rectangle with me as both origin and corner."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self rect: self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asRectCorner </span><span style="font: italic 10pt serif">"pretend to be a Rectangle for Rectangle +-*/"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asRectOrigin </span><span style="font: italic 10pt serif">"pretend to be a Rectangle for Rectangle +-*/"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">corner<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑ self+ (1⌾1)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">extent<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑ (1⌾1)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">extent: p</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"infix creation of rectangles"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑Rectangle new origin: self extent: p]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">height<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑ 1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">origin<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑ self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strm print: x; append: &rsquo;⌾&rsquo;; print: y]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">rect: p</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"infix creation of rectangles"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑Rectangle new origin: self corner: p]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">width<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑ 1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Access to parts</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hash </span><span style="font: 10pt serif">[⇑(x lshift: 2) lxor: y]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">theta </span><span style="font: 10pt serif">| tan theta "return the angle the point makes with origin.  right is 0; down is 90."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[x=0 ⇒ [y≥0 ⇒ [⇑ 90.0] ⇑ 270.0].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> tan &larr; y asFloat/x asFloat.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> theta &larr; tan arctan.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> x≥0 ⇒ [y≥0 ⇒[⇑ theta] ⇑360.0 + theta].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ⇑ 180.0 + theta]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">x</span><span class="tab" val="79"></span><span style="font: bold 10pt serif"> </span><span style="font: 10pt serif">[⇑x]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">x &larr; x</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">y </span><span style="font: 10pt serif">[⇑y]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">y &larr; y</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>SYSTEM</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fromPress: press value: s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ x &larr; s nextword. y &larr; s nextword]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hideData: complete </span><span style="font: 10pt serif">| s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[Stream new of: (s &larr; String new: 4); nextPoint&larr; self.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ s]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hidePress: press complete: c<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[press skipcode: self pressCode data: (self hideData: c)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pressCode </span><span style="font: 10pt serif">[⇑7]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪Point under: &rsquo;Form Path Image&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"Rectangle"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;Rectangle&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;origin corner&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I am a pair of points, usually representing a rectangular area on the screen</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">copy  <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["new rectangle"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ (origin copy) rect: (corner copy)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fromuser </span><span style="font: 10pt serif">| t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Show the origin cursor until the user presses a mouse button,<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">then get my origin"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">origin&larr;OriginCursor showwhile⦂ [user waitbug].<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Show the corner cursor and complement me until the user presses<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">a button again.  The loop is arranged so <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">that complementing stays on for a little while."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">t&larr;origin.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">CornerCursor showwhile⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[while⦂ [corner&larr;t.  t &larr; user mpnext] do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self comp.  t &larr; t max: origin.  self comp]]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fromuserevenword </span><span style="font: 10pt serif">| t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Show the origin cursor until the user presses a mouse button,<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">then get my origin"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">origin&larr;OriginCursor showwhile⦂ [user waitbug].<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Show the corner cursor and complement me until the user presses<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">a button again.  The loop is arranged so <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">that complementing stays on for a little while."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">t&larr;origin.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">CornerCursor showwhile⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[while⦂ [corner &larr; t.  t &larr; user mpnext] do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self comp.  t &larr; (((t x) + 15 | 16) ⌾ t y) max: origin.  self comp]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">origin: origin corner: corner</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">origin: origin extent: extent<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[corner &larr; origin+extent]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Aspects</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">area </span><span style="font: 10pt serif">[⇑(self width)*(self height)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">bottom </span><span style="font: 10pt serif">[⇑corner y]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">corner </span><span style="font: 10pt serif">[⇑corner]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">corners </span><span style="font: 10pt serif">| v<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[v&larr; Vector new: 4.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">v◦1&larr; origin. v◦2&larr; corner x⌾ origin y.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">v◦3&larr; corner. v◦4&larr; origin x⌾corner y.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑v]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">corner &larr; corner</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">edge: side </span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">Returns one side as a number.</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">Sides are numbered 0-3.  +1 goes counterclockwise.  lxor: 2 gets opposite side.</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[side<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=0⇒["top" ⇑origin y];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=1⇒["left" ⇑origin x];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=2⇒["bottom" ⇑corner y];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=3⇒["right" ⇑corner x].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: &rsquo;Invalid side&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">extent<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑corner-origin]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">extent &larr; extent<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[corner &larr; origin+extent. ⇑extent]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hash </span><span style="font: 10pt serif">[⇑(origin lshift: 1) lxor: corner]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">height<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑corner y - origin y]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">height &larr; h </span><span style="font: italic 10pt serif">"change my bottom y to make my height h"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[corner y &larr; origin y + h]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">leftside </span><span style="font: 10pt serif">[⇑origin x]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">maxX </span><span style="font: 10pt serif">[⇑corner x]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">maxY </span><span style="font: 10pt serif">[⇑corner y]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">minX </span><span style="font: 10pt serif">[⇑origin x]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">minY </span><span style="font: 10pt serif">[⇑origin y]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">origin </span><span style="font: 10pt serif">[⇑origin]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">origin &larr; origin</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">rightside </span><span style="font: 10pt serif">[⇑corner x]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">side: side </span><span style="font: italic 10pt serif">"Returns one side as a rectangle."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Sides are numbered 0-3.  +1 goes counterclockwise.  Xor: 2 gets opposite side."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[side<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=0⇒[</span><span style="font: italic 10pt serif">"top"</span><span style="font: 10pt serif"> ⇑origin rect: corner x⌾origin y];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=1⇒[</span><span style="font: italic 10pt serif">"left"</span><span style="font: 10pt serif"> ⇑origin rect: origin x⌾corner y];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=2⇒[</span><span style="font: italic 10pt serif">"bottom"</span><span style="font: 10pt serif"> ⇑origin x⌾corner y rect: corner];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=3⇒[</span><span style="font: italic 10pt serif">"right"</span><span style="font: 10pt serif"> ⇑corner x⌾origin y rect: corner].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: &rsquo;Invalid side&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">size<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑corner-origin]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">top </span><span style="font: 10pt serif">[⇑origin y]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">width<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑corner x - origin x]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">width &larr; w </span><span style="font: italic 10pt serif">"change my right x to make my width w"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[corner x &larr; origin x + w]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">withEdge: side at: coord </span><span style="font: 10pt serif">"Returns a rectangle with one side moved."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[side<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=0⇒ [⇑origin x⌾coord rect: corner];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=1⇒ [⇑coord⌾origin y rect: corner];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=2⇒ [⇑origin rect: corner x⌾coord];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=3⇒ [⇑origin rect: coord⌾corner y].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: &rsquo;Invalid side&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">withSide: side at: pt </span><span style="font: italic 10pt serif">"Returns a rectangle with one side moved."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[side<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=0⇒ [⇑origin x⌾pt y rect: corner];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=1⇒ [⇑pt x⌾origin y rect: corner];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=2⇒ [⇑origin rect: corner x⌾pt y];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=3⇒ [⇑origin rect: pt x⌾corner y].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: &rsquo;Invalid side&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Arithmetic</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">* scale </span><span style="font: 10pt serif">[<br></span><span style="font: italic 10pt serif">"Return a Rectangle which is the product of me and scale (which is a Rectangle, Point, or Number)"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑Rectangle new origin: origin * scale asRectOrigin corner: corner * scale asRectCorner]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">+ delta </span><span style="font: 10pt serif">[<br>"</span><span style="font: italic 10pt serif">Return a Rectangle which is the sum of me and delta (which is a Rectangle, Point, or Number)"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑Rectangle new origin: origin + delta asRectOrigin corner: corner + delta asRectCorner]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">- delta </span><span style="font: 10pt serif">[<br></span><span style="font: italic 10pt serif">"Return a Rectangle which is the difference of me and delta (which is a Rectangle, Point, or Number)"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑Rectangle new origin: origin - delta asRectOrigin corner: corner - delta asRectCorner]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">/ scale </span><span style="font: 10pt serif">[<br></span><span style="font: italic 10pt serif">"Return a Rectangle which is the quotient of me and scale (which is a Rectangle, Point, or Number)"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑Rectangle new origin: origin / scale asRectOrigin corner: corner / scale asRectCorner]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">= r<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑origin = r origin and: corner = r corner]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">center<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑origin+corner/2]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">empty<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑(origin &lt; corner)≡false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">has: pt </span><span style="font: 10pt serif">[⇑origin ≤ pt and⦂ pt &lt; corner]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">include: r </span><span style="font: italic 10pt serif">"Returns the merge with an adjacent rectangle."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑(origin min: r origin) rect: (corner max: r corner)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">inset: p1<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑origin+p1 rect: corner-p1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">inset: p1 and: p2<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑origin+p1 rect: corner-p2]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">intersect: r </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑Rectangle new origin: (origin max: r origin)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">corner: (corner min: r corner)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">intersects: r<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑(origin max: r origin) &lt; (corner min: r corner)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">isWithin: rect</span><span style="font: bold italic 10pt serif">  </span><span style="font: italic 10pt serif">"am I equal to or contained within rect"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑origin ≥ rect origin and⦂ corner ≤ rect corner]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">max: rect<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑Rectangle new<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">origin: (origin min: rect origin)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">corner: (corner max: rect corner)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">minus: r </span><span style="font: 10pt serif">| s yorg ycor</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"return Vector of Rectangles comprising<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">the part of me not intersecting r "</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Make sure the intersection is non-empty"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[origin≤r corner and⦂ r origin≤corner⇒ [] ⇑self inVector].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s &larr; (Vector new: 4) asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[r origin y&gt;origin y⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s next &larr; origin rect: corner x⌾(yorg &larr; r origin y)]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> yorg &larr; origin y].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[r corner y&lt;corner y⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s next &larr; origin x⌾(ycor &larr; r corner y) rect: corner]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ycor &larr; corner y].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[r origin x&gt;origin x⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s next &larr; origin x⌾yorg rect: r origin x⌾ycor]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[r corner x&lt;corner x⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s next &larr; r corner x⌾yorg rect: corner x⌾ycor]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑s contents]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">nearest: pt<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑((origin x max: pt x) min: corner x) ⌾<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">((origin y max: pt y) min: corner y)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">side: side distanceTo: pt<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[side<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=0⇒ [⇑pt y-origin y];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=1⇒ [⇑pt x-origin x];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=2⇒ [⇑corner y-pt y];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=3⇒ [⇑corner x-pt x].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: &rsquo;Invalid side&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sideNearest: pt </span><span style="font: 10pt serif">| d dmin i imin<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[dmin &larr; 077777.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: (0 to: 3) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[dmin&gt;(d &larr; self side: i distanceTo: pt) abs⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[dmin &larr; d.  imin &larr; i]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑imin]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Altering</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dragto: dest </span><span style="font: 10pt serif">| v i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self blt: dest mode: storing.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">v &larr; dest rect: dest+self extent.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: (self minus: v) do⦂ [i clear].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">origin &larr; dest. corner &larr; v corner]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">growby: pt<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[corner &larr; corner + pt]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">growto: corner </span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">maxstretch: bound </span><span style="font: 10pt serif">| bx by boundr selfr<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[bx&larr;(bound corner-origin) x. by&larr;(bound corner-origin) y.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">boundr&larr;bx asFloat/by. selfr&larr;self width asFloat/self height.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">selfr&gt;boundr⇒[self extent&larr;(bx⌾(bx asFloat/selfr) asInteger)]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self extent&larr;((by asFloat*selfr) asInteger⌾by)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">moveby: pt<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[origin &larr; origin+pt. corner &larr; corner+pt]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">moveto: pt<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[corner &larr; corner+pt-origin. origin&larr;pt]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">translate: pt<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[origin &larr; origin+pt. corner &larr; corner+pt]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">translateto: pt <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self translate:  pt - origin. ]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">usermove <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self usermove: user screenrect]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">usermove: bound </span><span style="font: 10pt serif">| m lim<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[lim&larr;bound corner-self extent. self bordercomp. m&larr;user mp.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ true do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[user redbug⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self bordercomp; moveto: (bound origin max: ((m&larr;user mp) min: lim)); bordercomp]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ (user anybug and⦂ m=user mp) do⦂ [].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user bluebug⇒[user waitnobug. ⇑self bordercomp]]]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">usersize <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self usersize: user screenrect]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">usersize: bound </span><span style="font: 10pt serif">| m lim<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[self origin≡nil⇒[origin&larr;user mp. self extent&larr;16]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self bordercomp. m&larr;user mp.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ true do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[lim&larr;bound corner-self extent.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user redbug⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self bordercomp; moveto: (bound origin max: ((m&larr;user mp) min: lim)); bordercomp]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user yellowbug⇒[self bordercomp.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">corner&larr;m&larr;(user mp min: bound corner) max: origin. self bordercomp]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ (user anybug and⦂ m=user mp) do⦂ [].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user bluebug⇒[user waitnobug. ⇑self bordercomp]]]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Conversion</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asRectangle<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Return self."</span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asRectCorner<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑corner ]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">asRectOrigin<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑origin ]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">bitsFromStream: strm </span><span style="font: 10pt serif">| rec s [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rec &larr; origin rect: origin + (self width ⌾ (16 min: self height)).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s&larr; String new: rec bitStringLength.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ rec maxY ≤ corner y do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strm into: s.  rec bitsFromString: s; moveby: 0⌾16].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rec minY &lt; corner y⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[rec corner y&larr; corner y.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s&larr; nil. s&larr; String new: rec bitStringLength.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm into: s.  rec bitsFromString: s]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">bitsFromString: str<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"default stores bits onto display"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self bitsFromString: str mode: storing]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">bitsFromString: str mode: mode </span><span style="font: 10pt serif">[user croak] primitive: 52</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">bitsFromString: str mode: mode clippedBy: clipRect<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| destRect <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">Load the screen bits within my area from those stored in </span><span style="font: italic 10pt serif; text-decoration: underline">str</span><span style="font: italic 10pt serif">.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">If </span><span style="font: italic 10pt serif; text-decoration: underline">clipRect</span><span style="font: italic 10pt serif"> is not nil, then load only those bits within both<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">myself and </span><span style="font: italic 10pt serif; text-decoration: underline">clipRect</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self bitStringLength≠str length⇒[user notify: &rsquo;wrong bit string length&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">destRect&larr;self intersect: user screenrect.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[nil≡clipRect⇒[] destRect&larr;destRect intersect: clipRect].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">BitBlt init destbase&larr;mem◦066;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">destraster&larr;user screenrect width/16|2;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dest&larr;destRect origin;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">extent&larr;destRect extent;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sourceraster&larr;corner x-origin x+15/16;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">source&larr;destRect origin-origin;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sourcebase &larr; str ; copy: mode]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">bitsIntoString </span><span style="font: 10pt serif">| str [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">str &larr; String new: self bitStringLength.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self  bitsIntoString: str mode: storing.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑str]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">bitsIntoString: str<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"default stores bits into the string"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self bitsIntoString: str mode: storing]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">bitsIntoString: str mode: mode </span><span style="font: 10pt serif">[user croak] primitive: 51</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">bitsIntoString: str mode: mode clippedBy: clipRect<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| sourceRect <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">Store the screen bits within my area into </span><span style="font: italic 10pt serif; text-decoration: underline">str</span><span style="font: italic 10pt serif">.  If </span><span style="font: italic 10pt serif; text-decoration: underline">clipRect</span><span style="font: italic 10pt serif"> is not nil,<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">then store only those bits within both myself and </span><span style="font: italic 10pt serif; text-decoration: underline">clipRect</span><span style="font: italic 10pt serif">,<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">leaving alone the other bits in </span><span style="font: italic 10pt serif; text-decoration: underline">str</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self bitStringLength≠str length⇒[user notify: &rsquo;wrong bit string length&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sourceRect&larr;self intersect: user screenrect.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[clipRect≡nil⇒[] sourceRect&larr;sourceRect intersect: clipRect].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">BitBlt init destraster&larr;corner x-origin x+15/16;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dest&larr;sourceRect origin-origin;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">extent&larr;sourceRect extent;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sourcebase&larr;mem◦066;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sourceraster&larr;user screenrect width/16|2;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">source&larr;sourceRect origin;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">destbase &larr; str ; copy: mode]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">bitsOntoStream: strm </span><span style="font: 10pt serif">| rec s [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rec &larr; origin rect: origin + (self width ⌾ (16 min: self height)).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s&larr; (String new: rec bitStringLength) all&larr;0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ rec maxY ≤ corner y do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[rec bitsIntoString: s; moveby: 0⌾16.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm append: s].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rec minY &lt; corner y⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[rec bitsIntoString: s.  strm append:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s◦(1 to: s length/rec height*(corner y-rec minY))]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">bitStringLength </span><span style="font: 10pt serif">| extent [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">extent &larr; corner - origin.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ 2 * extent y* (extent x +15/16)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hardcopy: pf </span><span style="font: 10pt serif">[self hardcopy: pf thickness: 2]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hardcopy: pf thickness: th </span><span style="font: 10pt serif">| r [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ r from: ((self inset: 0-th) minus: self) do⦂ [pf showrect: r color: 0]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strm print: origin; append: &rsquo; rect: &rsquo;; print: corner]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Image</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">blowup: at by: scale </span><span style="font: 10pt serif">| z dest<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[dest &larr; Rectangle new origin: at extent: self extent*scale.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(dest has: origin) or: (dest has: corner) ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[z &larr; self bitsIntoString. dest outline.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self moveto: dest origin. self bitsFromString: z]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">dest outline].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self blowup: at by: scale spacing: 1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">blowup: at by: scale spacing: spacing<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| extent z inc sinc slice width height dest i j spread<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[extent &larr; self extent.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">scale &larr; scale asPoint.  spacing &larr; spacing asPoint.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dest &larr; Rectangle new origin: at extent: extent*scale.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">z &larr; 1⌾0. width &larr; extent x. height &larr;  0⌾extent y.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">spread &larr; (scale-spacing) x.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: 2 do⦂</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"first do horiz, then vert"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[inc &larr; z * ¬1. sinc &larr; z * scale.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">slice &larr; Rectangle new<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">origin: (z * width) + [i = 1 ⇒[self origin] at]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">extent: z + height.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">dest &larr; at + (z * (scale * width)).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ j to: width do⦂</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"slice it up"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[dest &larr; dest - sinc.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">slice moveby: inc.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">slice blt: dest mode: storing]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">slice &larr; Rectangle new origin: at + z<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">extent: height+(z*(scale-1)).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ j to: width do⦂</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"clear slice source"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[slice clear: white. slice moveby: sinc]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">slice &larr; Rectangle new origin: at<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">extent: height + (z * ((scale*width)-1)).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ j to: spread - 1 do⦂</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"spread it out"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[slice blt: at + z mode: oring]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">z &larr; 0⌾1.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"flip to do vertical"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">width &larr; extent y. height &larr; (scale*extent) x⌾0.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">spread &larr; (scale-spacing) y]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">blt: dest mode: mode </span><span style="font: 10pt serif">[user croak] primitive: 47</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">blt: dest mode: mode clippedBy: clipRect<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| destRect clippedSource<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">Copy the screen bits within my area to the rectangle whose<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">origin is </span><span style="font: italic 10pt serif; text-decoration: underline">dest</span><span style="font: italic 10pt serif"> and whose extent is the same as mine.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">If </span><span style="font: italic 10pt serif; text-decoration: underline">clipRect</span><span style="font: italic 10pt serif"> is not nil, then copy only those bits within both<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">the destination rectangle and </span><span style="font: italic 10pt serif; text-decoration: underline">clipRect</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">destRect&larr;(Rectangle new origin: dest extent: self extent)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">intersect: user screenrect.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[nil≡clipRect⇒[] destRect&larr;destRect intersect: clipRect].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">find the source for the bits after clipping</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">clippedSource&larr;origin+destRect origin-dest.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">BitBlt init<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">destbase&larr;mem◦066;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">destraster&larr;user screenrect width/16|2;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">dest&larr;destRect origin;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">extent&larr;destRect extent;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">sourcebase&larr;mem◦066;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">sourceraster&larr;user screenrect width/16|2;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">source&larr;clippedSource;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">copy: mode]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">bltcomp: dest mode: mode </span><span style="font: 10pt serif">[user croak] primitive: 48</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">brush: dest mode: mode color: color </span><span style="font: 10pt serif">[user croak] primitive: 49</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">brush: dest mode: mode color: color clippedBy: clipRect<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| destRect clippedSource<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">Brush the screen bits within my area to the rectangle whose<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">origin is </span><span style="font: italic 10pt serif; text-decoration: underline">dest</span><span style="font: italic 10pt serif"> and whose extent is the same as mine.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">If </span><span style="font: italic 10pt serif; text-decoration: underline">clipRect</span><span style="font: italic 10pt serif"> is not nil, then brush only those bits within both<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">the destination rectangle and </span><span style="font: italic 10pt serif; text-decoration: underline">clipRect</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">destRect&larr;(Rectangle new origin: dest extent: self extent)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">intersect: user screenrect.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[nil≡clipRect⇒[] destRect&larr;destRect intersect: clipRect].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">find the source for the bits after clipping</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">clippedSource&larr;origin+destRect origin-dest.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">BitBlt init<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">color&larr;color;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">destbase&larr;mem◦066;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">destraster&larr;user screenrect width/16|2;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">dest&larr;destRect origin;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">extent&larr;destRect extent;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">sourcebase&larr;mem◦066;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">sourceraster&larr;user screenrect width/16|2;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">source&larr;clippedSource;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">paint: mode]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">clear</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"default is backround"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self color: background mode: storing]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">clear: color<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self color: color mode: storing]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">color: color mode: mode </span><span style="font: 10pt serif">[user croak] primitive: 50</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">comp<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self color: black mode: xoring]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">comp: color<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self color: color mode: xoring]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fillin: color mode: mode </span><span style="font: 10pt serif">| T bits p s dirs i which</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"Rectangle new fromuser fillin: gray"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[T &larr; Turtle init.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">p&larr; origin + (self width⌾0).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s&larr; Rectangle new origin: p extent: self extent.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dirs&larr;((1⌾0), (¬1⌾0), (0⌾1), (0⌾¬1)).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bits&larr; s bitsIntoString.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self blt: p mode: storing.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"s &larr; self"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user waitbug. T place: user mp; pendn.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ user anybug do⦂</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"draw seed in self"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[T goto: user mp].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self blt: p mode: xoring.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"s &larr; seed only"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s blt: origin mode: xoring.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"take seed out of self"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user waitbug.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ user anybug do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ which from: 0 to: 2 by: 2 do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: 2 do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s blt: dirs◦(which+i)+p mode: oring]</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"smear seed around"<br> </span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self blt: p mode: erasing]]</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"then clip to outline"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s brush: origin mode: mode color: color.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"paint it in"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s bitsFromString: bits]</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"restore background to s"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">flash </span><span style="font: 10pt serif">[self comp; comp]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">reverse<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self color: black mode: xoring]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">rotate</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"(0⌾0 rect: 128⌾128) rotate."<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">| size maskr spt mpt tpt data temp atab btab i unit<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[size &larr; self extent x. spt &larr; size⌾size.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"size must be a power of 2"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">data &larr; Rectangle new origin: origin extent: spt.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">maskr &larr; Rectangle new origin: (mpt&larr; origin + (0⌾size)) extent: spt.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">temp &larr; Rectangle new origin: (tpt&larr; mpt + (size⌾0)) extent: spt.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">atab &larr; (0⌾0),(1⌾0),(0⌾0),(0⌾1),(1⌾1),(0⌾1),(1⌾0),(¬1⌾0),(1⌾0).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">btab &larr; (0⌾0),(1⌾1),(0⌾0),(1⌾1),(¬1⌾¬1),(1⌾1).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">unit &larr; size/2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">maskr clear: white.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(Rectangle new origin: mpt extent: unit⌾unit) clear: black.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ unit&lt;1 do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ i to: 3 do⦂</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"flip left and right halves"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[temp clear: white.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">maskr blt: atab◦i*unit + tpt mode: storing.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">maskr blt: atab◦(3+i)*unit + tpt mode: oring.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">data bltcomp: tpt mode: erasing.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">temp blt: atab◦(6+i)*unit + origin mode: xoring].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: 3 do⦂</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"flip diagonals"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[temp clear: white.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">maskr blt: btab◦i*unit + tpt mode: storing.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">data bltcomp: tpt mode: erasing.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">temp blt: btab◦(3+i)*unit + origin mode: xoring].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(unit&larr; unit/2)&lt;1⇒[]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">maskr blt: (0⌾unit)+mpt mode: erasing.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">maskr blt: (unit⌾0)+mpt mode: erasing.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">maskr blt: (unit*2⌾0)+mpt mode: oring.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">maskr blt: (0⌾(2*unit))+mpt mode: oring]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Border</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">border: thick color: color</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"paints a border withoud disturbing interior"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(Rectangle new<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">origin: origin-(thick⌾thick) corner: (corner x+thick)⌾origin y)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">clear: color;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">moveto: (origin x-thick)⌾corner y; clear: color;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">origin &larr; corner x⌾(origin y-thick); clear: color;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">moveto: origin-(thick⌾thick); clear: color]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">boxcomp</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"paints a border withoud disturbing interior"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(Rectangle new<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">origin: origin-(2⌾2) corner: (corner x+2)⌾origin y)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">color: black mode: xoring;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">moveto: (origin x-2)⌾corner y; color: black mode: xoring;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">origin &larr; corner x⌾(origin y-2); color: black mode: xoring;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">moveto: origin-(2⌾2); color: black mode: xoring]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">outline </span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"default border is two thick"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self outline: 2]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">outline: thick </span><span style="font: 10pt serif">| t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t &larr; (¬1⌾¬1)*thick.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(self inset: t) clear: black.  self clear: white]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪Rectangle under: &rsquo;Form Path Image&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"TextImage"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;TextImage&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Textframe<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;c1 c2 begintypein superimage figure ground&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;cut esc paste aurora Scrap scrap bs Deletion aurorarunning paragraphmenu ctlw &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>This class has not yet been commented</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>INIT</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit <br></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bs &larr; 8. ctlw &larr; 145. esc &larr; 160. cut &larr; 173. paste &larr; 158.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Scrap &larr; Deletion &larr; nullString.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">paragraphmenu &larr; Menu new string:<br>&rsquo;resize<br>fit<br>cut<br>paste<br>copy<br>align<br>figure<br>ground<br>&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">aurora &larr; "Aurora new" nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">aurorarunning &larr; false.<br>]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">close<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[superimage&larr;nil]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">paragraph: para frame: frame style: style<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self paragraph: para frame: frame style: style figure: 1 ground: 0<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">paragraph: para frame: frame style: style figure: figure ground: ground<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[nil≡ para ⇒ [ para &larr; nullString ]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">c1 &larr; c2 &larr; begintypein&larr; 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self para: para frame: frame style: style<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">text: t width: w | run r<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">c1 &larr; c2 &larr; begintypein&larr; 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">run &larr; String new: 2. run word: 1 &larr;  16 * 7 + 0177400.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">r &larr; Rectangle new origin: 0⌾0 extent: w⌾(DefaultTextStyle lineheight+2).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self paragraph: (Paragraph new text: t runs: run  alignment: 2) frame: r style: DefaultTextStyle.<br><br> ]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>EDITING</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">align<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[para alignment &larr; ↪(1 2 4 0 0)◦(1+para alignment).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self show.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self reversefrom: c1 to: c2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">checklooks </span><span style="font: 10pt serif">| t val mask [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"see ParagraphEditor checklooks.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">substitute c1 for loc1, c2 for loc2, oldEntity for oldpara, entity for para"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">t &larr; ↪(166 150 137 151   230 214 201 215<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">135 159 144 143 128 127 129 131 180 149<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">199 223 208 207 192 191 240 226) find: user kbck.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">t=0⇒[⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user kbd.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">t=25⇒[self toBravo]; "ctl-T" <br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> =26⇒[self fromBravo]. "ctl-F" <br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"[oldEntity⇒[] oldEntity &larr; entity recopy]."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">val &larr; ↪(1 2 4 256   ¬1 ¬2 ¬4 256  "ctl-b i - x   B I ¬ X"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">0 16 32 48 64 80 96 112 128 144  "ctl-0 1 ... 9"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">160 176 192 208 224 240)◦t.  "ctl-shift-0 1 ... 5"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[val=256⇒[mask&larr; 0377.  val&larr; 0]</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"reset all"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">val&lt;0⇒[mask&larr; 0-val.  val&larr; 0]</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"reset emphasis"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">val&gt;0 and⦂ val&lt;16⇒[mask&larr; val]</span><span class="tab" val="79"></span><span style="font: 10pt serif">"set emphasis"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">mask&larr; 0360].</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"set font"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">para maskrun: c1 to: c2-1 under: mask to: val]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">copyselection <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["copy the current selection and store it in the Scrap."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Scrap &larr; para copy: c1 to: c2-1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">cut <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["cut out the current selection and redisplay the paragraph."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Scrap &larr; para copy: c1 to: c2-1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self reversefrom: c1 to: c2.</span><span class="tab" val="79"></span><span style="font: 10pt serif">"deselect old selection"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">para replace: c1 to: c2-1 by: nullString.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">c2 &larr; c1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">begintypein &larr; false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self show.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self reversefrom: c1 to: c2.</span><span class="tab" val="79"></span><span style="font: 10pt serif">"show new selection"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">edit: superimage </span><span style="font: 10pt serif">| pt charindex<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"eventually a general paragraph manipulator for now just a hack."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self show ; reversefrom: c1 to: c2." show current selection"user waitnobug.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ 1=2 do⦂ "forever for now"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user kbck⇒ [self kbd]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user yellowbug⇒ [paragraphmenu bug<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=1⇒</span><span class="tab" val="79"></span><span style="font: 10pt serif">[self resize ]; "resize"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=2⇒</span><span class="tab" val="79"></span><span style="font: 10pt serif">[self fit]; "include all of the text in the current selection"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=3⇒</span><span class="tab" val="79"></span><span style="font: 10pt serif">[self cut]; "delete the current selection"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=4⇒</span><span class="tab" val="79"></span><span style="font: 10pt serif">[self paste]; "paste the Scrap over the selection"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=5⇒</span><span class="tab" val="79"></span><span style="font: 10pt serif">[self copyselection]; "copy current selection"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=6⇒</span><span class="tab" val="79"></span><span style="font: 10pt serif">[self align]; "change the alignment of the paragraph"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=7⇒</span><span class="tab" val="79"></span><span style="font: 10pt serif">[self setfigure]; "set color corrisponding to 1"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=8⇒</span><span class="tab" val="79"></span><span style="font: 10pt serif">[self setground] "set color corrisponding to 1"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user redbug⇒ [self reversefrom: c1 to: c2. frame has: (pt &larr; user mp)⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self select: pt]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self.]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user tabletbug⇒ [frame has: (pt &larr; user mp)⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self tabletBug]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self reversefrom: c1 to: c2. ⇑self.]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user bluebug⇒ [self reversefrom: c1 to: c2. "erase current selection"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self.] "and exit back to the document"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fintype<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[begintypein⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span class="tab" val="79"></span><span style="font: 10pt serif">[begintypein&lt;c1⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[Scrap &larr; para copy: begintypein to: c1-1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">c1 &larr; begintypein]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">begintypein &larr; false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fit</span><span style="font: 10pt serif">| t <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"make the bounding rectangle of the TextImage contain all the textwhile not changing the width of the TextImage."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self white.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">frame extent&larr; ((frame width)⌾ 1000).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">t &larr; self rectofchar: (para length+1).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">frame extent&larr; (frame width)⌾((t corner y) - (frame origin y)).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self show. frame border: 1 color: ¬1. self reversefrom: c1 to: c2.<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">kbd </span><span style="font: 10pt serif">| more char  "key struck on the keyboard"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[c1&lt;c2 and⦂ self checklooks⇒[⇑ self show reversefrom: c1 to: c2]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">more &larr; Set new string: 16.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[begintypein⇒[] Deletion &larr; para copy: c1 to: c2-1. begintypein &larr; c1].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ (char &larr; user kbdnext) do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">char<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=bs⇒ ["backspace"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">more empty⇒ [begintypein &larr; begintypein min: (c1 &larr; 1 max: c1-1)]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">more skip: ¬1];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=cut⇒ [⇑self cut];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=paste⇒ [⇑self paste];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=ctlw⇒ ["ctl-w for backspace word"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">more reset.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">c1 &larr; 1 max: c1-1.</span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ [c1&gt;1 and⦂ (para◦(c1-1)) tokenish] do⦂ [c1 &larr; c1-1].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">begintypein &larr; begintypein min: c1];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=esc⇒ ["</span><span style="font: italic 10pt serif">select previous type-in</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[more empty⇒[self reversefrom: c1 to: c2]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">para replace: c1 to: c2-1 by:  more. c1 &larr; c2].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self fintype.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">c1 &larr; c2-Scrap length.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self reversefrom: c1 to: c2]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"just a normal character"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">more next&larr; char].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">para replace: c1 to: c2-1 by:  more. c2 &larr; c1 + more length. c1 &larr; c2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self show. self reversefrom: c1 to: c2]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">paste <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["paste the Scrap over the current selection and redisplay the paragraph."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self fintype.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self reversefrom: c1 to: c2.</span><span class="tab" val="79"></span><span style="font: 10pt serif">"deselect current selection"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">para replace: c1 to: c2-1 by: Scrap.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">c2 &larr; c1 + Scrap length.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self show.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self reversefrom: c1 to: c2.</span><span class="tab" val="79"></span><span style="font: 10pt serif">"highlight new selection"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">resize </span><span style="font: 10pt serif">| t pt xgrid ygrid<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Show the origin cursor until the user presses a mouse button,<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">then get my origin"<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Show the corner cursor and show me until  user nobug<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">t&larr;frame origin.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">CornerCursor topage1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user waitbug. self white.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">frame corner&larr; frame origin.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ user nobug do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self white.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">( pt &larr; <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">((superimage superimage) mp)+<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">((superimage superimage) rectangle origin)).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">frame corner&larr; pt max: frame origin+ (16⌾(style lineheight)).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self displayat: frame origin effect: 0 clippedBy: frame.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">NormalCursor topage1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self show. frame boxcomp. self reversefrom: c1 to: c2.<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">setfigure </span><span style="font: 10pt serif">| <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"for now just increment the figure color by 1 \ 14"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">figure &larr; (figure +1 ) \ 14.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self displayat: (self frame origin) effect: 0 clippedBy: user screenrect.<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">setground </span><span style="font: 10pt serif">| <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"for now just increment the figure color by 1 \ 14"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ground &larr; (ground +1 ) \ 14.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self displayat: (self frame origin) effect: 0 clippedBy: user screenrect.<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">white <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["white out the image"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(frame inset: (¬2⌾¬2)) clear: 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>SELECTION</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">complementfrom: hair1 to: hair2 </span><span style="font: 10pt serif">| temprect<br>["Complement the screen dots corresponding to the lines and part-lines of the paragraph between hair1 inclusive and hair2 exclusive.  If hair1 = hair2, this is a no-op.  If hair1 &gt; hair2, they are reversed. This complementing happens in three parts, A, B, and C, between points 1 and 2, according to the following illustration:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">1AAA<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">BBBB<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">BBBB<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">BBBB<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">CCC2<br>unless there is just one line involved, as in:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">1DD2<br>"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"one line case"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">hair1 minY = hair2 minY⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[((([hair1 minX ≤ hair2 minX⇒ [hair1 origin rect: hair2 corner]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">hair2 origin rect: hair1 corner]) intersect: frame) intersect: window) comp]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[hair1 minY &gt; hair2 minY⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">temprect &larr; hair1. hair1 &larr; hair2. hair2 &larr; temprect]].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">temprect &larr; (frame minX ⌾ hair1 maxY) rect: (frame maxX ⌾ hair2 minY).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(((hair1 origin rect: (temprect maxX ⌾ temprect minY)) intersect: frame) intersect: window)  comp.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">((temprect intersect: frame) intersect: window)  comp.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">((((temprect minX ⌾ temprect maxY) rect: hair2 corner) intersect: frame) intersect: window)  comp.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">reversefrom: char1 to: char2</span><span style="font: 10pt serif">| h1 h2<br>["Complement the dots corresponding to the the lines and part-lines of the paragraph between the left edge of char1 and the left edge of char2.  If char1 = char2, this is sort of a no-op.  If char1 &gt; char2, this is undefined."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self ptofchar: char1. h1 &larr; reply1 rect: reply2.<br> </span><span class="tab" val="79"></span><span style="font: 10pt serif">[char2=char1⇒[h2 &larr; h1+ (1⌾0)] self ptofchar: char2. h2 &larr; reply1 rect: reply2.].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self complementfrom: h1 to: h2]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">select: pt </span><span style="font: 10pt serif">| h1 h2 c h drag2 selection<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"draw out and record ( c1 and c2) a selection"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">c1 &larr; c2 &larr; self charofpt: pt.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">h1 &larr; reply1 rect: reply2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">h2 &larr; h1 + (1⌾0).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self complementfrom: h1 to: h2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">selection &larr; true.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ (pt &larr; user mpnext) do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">c &larr; self charofpt: pt.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">h &larr; "proj screenHairBeforeThatChar" reply1 rect: reply2.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[c1 = c2⇒ [drag2 &larr; c ≥ c2]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[drag2⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[c &lt; c1⇒ [h &larr; self ptofchar: (c &larr; c1). h &larr; reply1 rect: reply2.]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self complementfrom: h to: h2.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">c2 &larr; c. h2 &larr; h]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[c &gt; c2⇒ [h &larr; self ptofchar: (c &larr; c2). h &larr; reply1 rect: reply2.]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self complementfrom: h1 to: h.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">c1 &larr; c. h1 &larr; h].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">h1 = h2⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self complementfrom: h1 to: (h2 &larr; h1 + (1⌾0))]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">drag2⇒ []<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"get rid of extra line in backwards select"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self complementfrom: h2 - (1⌾0) to: h2]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>SYSTEM</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">copy | t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">t &larr;  TextImage new paragraph: para copy frame: (frame copy) style: style copy.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">t c1&larr; c1 ; c2&larr; c2 ; begintypein &larr; begintypein.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fromPress: press value: s </span><span style="font: 10pt serif">[</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">frame set by Image</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">para &larr; Paragraph new fromPress: press value: s.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">figure &larr; s nextword.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self paragraph: para frame: frame style: DefaultTextStyle<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">figure: figure ground: s nextword]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hideData: complete </span><span style="font: 10pt serif">| s p [ <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">p &larr; para hideData: complete.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Stream new of: (s &larr; String new: p length+4);<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">append: p;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextword &larr; figure;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextword &larr; ground.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑s]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hidePress: press complete: c </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">press skipcode: self pressCode data: (self hideData: c)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pressCode </span><span style="font: 10pt serif">[⇑4]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">presson: press in: r <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ para presson: press in: r.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">show | </span><span style="font: 10pt serif">lastvisible</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["display text and expand the frame in y to include all of<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">the text if the textimage is too small"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">super show.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">lastvisible &larr; self rectofchar: para length.</span><span class="tab" val="79"></span><span style="font: 10pt serif">"see if lastvisible out of frame"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">lastvisible bottom &gt; frame bottom ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[frame corner y&larr; lastvisible corner y.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">super show.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>ACCESS TO PARTS</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">begintypein&larr; begintypein </span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">c1&larr; c1 </span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">c2&larr; c2 </span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">figure <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["return the figure color (color associated with black) for this TextImage"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ figure<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">figure: figure <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["change the figure color (color associated with black) for this TextImage"]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">ground <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["return the ground color (color associated with white) for this TextImage"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ ground<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">ground: ground <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["change the ground color (color associated with white) for this TextImage"]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">leftflush<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ (self para) flushleft]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">rectangle<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["Return rectangle (frame of Textframe) for compatibility with Image calls -- <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">needed in findbyrect: in Document"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑frame]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">text<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑ self para text]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>DISPLAY</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">displayat: pt effect: effect clippedBy: cliprect | clippedrect<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["display text "<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">super displayat: pt effect: effect clippedBy: cliprect.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">aurorarunning⇒ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user displayoffwhile⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[clippedrect &larr; (super frame) intersect: (user screenrect).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">aurora destination: clippedrect ; source: clippedrect ;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">figure: figure ; ground: ground ;  function: 002117 "AoverB" ;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> doit; function: 0 ; doit.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪TextImage under: &rsquo;Form Path Image&rsquo;.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">TextImage classInit</span></div>
    <div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">&rsquo;From Smalltalk 5.5k XM November 24 on 22 November 1980 at 2:57:08 am.&rsquo;<br></span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">"BitImage"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;BitImage&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Image<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;strips nstrips&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;brush aurora stripheightSPARE stripheight black white bitimagemenu erase SPARE color formmenu under reverse blankcursor over dotsetter &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>This class is a virtual bit map represented as a smalltalk String</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>INIT</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["sets up colors and effects for BITBLT."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">black &larr; 0-1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">white &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">over &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">under &larr; 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">reverse &larr; 2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">erase &larr; 3.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">brush &larr; Form new extent: 5⌾5. brush black.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">color &larr; 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">stripheight &larr; 20.<br>bitimagemenu &larr; Menu new string:<br>&rsquo;size<br>figure<br>ground<br>newform<br>pasteform<br>arc<br>areafill<br>shade<br>vertical<br>horizontal<br>rotate<br>&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">aurora &larr; "Aurora new" nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fromImage: image <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["creates a virtual bit map with width = (image width) and height = (image height) with the bits in image."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self fromrectangle: image rectangle.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fromrectangle: rect </span><span style="font: 10pt serif">| </span><span style="font: bold 10pt serif">r i leftover image yposition<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["creates a virtual bit map with width = (r width) , height = (r height)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> and the bits in rect. The Image is  made up of forms that are stripheight high."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">super origin: rect origin extent: rect extent.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nstrips &larr; (rect height + (stripheight -1))/stripheight.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">yposition &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">leftover &larr; rect height \ stripheight.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ (leftover = 0) ⇒ [leftover &larr; stripheight]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">r &larr; Rectangle new origin: rect origin extent: (rect width)⌾stripheight.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: nstrips do⦂ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ i = nstrips ⇒ [ r extent &larr; ((rect width)⌾leftover)]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">image &larr; Image new origin: (0⌾0) extent: rect extent.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">image form: (Form new fromrectangle: r) ; path: (0⌾yposition).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self addimage: image.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">yposition &larr; yposition + stripheight.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">r translate: (0⌾stripheight).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"><br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span class="tab" val="79"></span><span style="font: bold 10pt serif">fromuser  | r<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["create a new Form whose rectangle is specified by the user. "<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">r &larr; Rectangle new fromuser.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self fromrectangle: r<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fromuserevenword  | r<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["create a new BitImage whose rectangle is specified by the user,<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">truncated to nearest multiple of 16 (for Spruce printing). "<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">r &larr; Rectangle new fromuserevenword.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self fromrectangle: r.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>PATTERN ACCESS</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">erase </span><span style="font: 10pt serif">| i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["sets all bits in the BitImage to white ( to zeros)"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: nstrips do⦂ [ (strips◦i) white]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">nstrips<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ nstrips <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">nstrips: nstrips <br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">saveScreenBits<br></span><span style="font: 10pt serif">[<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">strips <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["return the set of Forms making up this BitImage)"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ strips<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">strips: strips <br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>MODULE ACCESS</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">comment <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["see class Image"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">frame </span><span style="font: 10pt serif">[ ⇑ rectangle]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">moveto: pt  <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self translateto: pt<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>FILING</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">read: filename </span><span style="font: 10pt serif">| file subimage strip yposition i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["Reads the Image in the format nstrips , Form(1) , Form(2) , Form(3) . . .<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">Form(nstips). Where each Form is saved as width,height then bits.  "<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self origin: 0⌾0 extent: 1⌾1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">yposition &larr; 0.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">file&larr; (dp0 oldFile: filename) readonly.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nstrips &larr; file nextword.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: nstrips do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">strip &larr; Form new fromInstance: file.  <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self addform: strip andpath: (0⌾yposition).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">yposition&larr; yposition+ strip height.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">file close.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">write: filename </span><span style="font: 10pt serif">| file subimage<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["Saves the Form in the format nstrips , Form(1) , Form(2) , Form(3) . . .<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">Form(nstips). Where each Form is saved as width,height then bits.  "<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">file &larr; (dp0 file: filename).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">file nextword&larr; nstrips.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ subimage from: self do⦂ [ file append: (subimage form) asInstance. ]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">file close.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>DISPLAY</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">displayat:  path effect: effect clippedBy: cliprect<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">super displayat: path effect: effect clippedBy: cliprect<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">show<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">super displayat: (0⌾0) effect: 0 clippedBy: user screenrect<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>SYSTEM</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">copy </span><span style="font: 10pt serif">| t i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["return a copy of myself"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">t &larr; BitImage new origin: (origin copy) extent: (self extent) copy.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: self length do⦂ [ t add: (self◦i) copy].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pressCode </span><span style="font: 10pt serif">[⇑3]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm </span><span style="font: 10pt serif">| t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm append: &rsquo;a Bitmage: &rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">title <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ &rsquo;&rsquo;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>EDITING</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">arc </span><span style="font: 10pt serif">| pt1 pt2 pt3 p pt<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["arc tool for forms."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">BlankCursor topage1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user clear; print: &rsquo;Redbug 3 points&rsquo;; cr; print: &rsquo;Paints using current brush.&rsquo; .<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user waitnobug.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ user redbug do⦂</span><span class="tab" val="79"></span><span style="font: 10pt serif">[ pt1 &larr; self blinkbrush].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">brush displayat: pt1 effect: color clippedBy: user screenrect.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user waitnobug.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ user redbug do⦂</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ pt2 &larr; self blinkbrush].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">brush displayat: pt2 effect: color clippedBy: user screenrect.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user waitnobug.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ user redbug do⦂</span><span class="tab" val="79"></span><span style="font: 10pt serif">[ pt3 &larr; self blinkbrush].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">brush displayat: pt3 effect: color clippedBy: user screenrect.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">XeqCursor show.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">p &larr; Path new init.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">p addarcfrom: pt1 via: pt2 to: pt3.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ pt from: p do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ brush displayat: pt effect: color clippedBy: user screenrect].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">NormalCursor show<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">blinkbrush </span><span style="font: 10pt serif">| pt <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["to show current position of brush in the BitImage."<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pt &larr; self mp + rectangle origin.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">brush displayat: pt<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">effect: 2 clippedBy: user screenrect.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">brush displayat: pt<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">effect: 2 clippedBy: user screenrect.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ pt<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">edit: superimage | bits <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["uses the BitRect toolbox editor"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">XeqCursor show.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dotsetter &larr; BitRectEditor new picture: self.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dotsetter firsttime.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">NormalCursor show.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ true do⦂ "forever"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(dotsetter lostMouse and: (user anybug)) ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span class="tab" val="79"></span><span style="font: 10pt serif">dotsetter outside⇒ []<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">XeqCursor show.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">dotsetter lasttime.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">bits &larr; self fromrectangle: rectangle.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">NormalCursor show.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ bits<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">dotsetter eachtime<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">grayEdit </span><span style="font: 10pt serif">| a b c i d p r v bits "edit up a gray pattern and return it"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["first a rectangle for it.  Then redbug is black, yellow is white,<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">blue terminates"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">r &larr; Rectangle new fromuser. bits&larr;0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">a &larr; r extent. a&larr; (a x max:  a y) | 4. a &larr; a⌾a.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">b &larr; r origin. r extent&larr; a; color: white mode: storing; moveby: 0⌾(0-a y).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">c &larr; a/4.  d &larr; b rect: b+c.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ user bluebug do⦂ [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user redbug ⇒[p &larr; user mp -b /c.  i &larr; p y *4 +p x +1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">i&lt;1 or⦂ i&gt;16 ⇒[r flash]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">d moveto: b+(c*p); color: black mode: storing.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">bits &larr; bits lor: (1 lshift: 16-i).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">r color: bits mode: storing. user waitnobug]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user yellowbug ⇒[p &larr; user mp -b /c.  i &larr; p y *4 +p x +1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">i&lt;1 or⦂ i&gt;16 ⇒[r flash]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">d moveto: b+(c*p); color: white mode: storing.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">bits &larr; (¬1 lxor:(1 lshift: 16-i)) land: bits.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">r color: bits mode: storing. user waitnobug]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">] ⇑bits]<br>"aa grayEdit base8 ."</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">horizontalsymmetry </span><span style="font: 10pt serif">| r f i <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["horizontal symmetry tool"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user clear; show: &rsquo;Define rectangle. Reflection will be around lower edge&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">r &larr; Rectangle new fromuser.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">XeqCursor show.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: ( r height) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">f &larr; Form new fromrectangle: (Rectangle new origin: ((r origin x)⌾((r bottom)-i)) extent: ((r width)⌾1)).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">f displayat: (r origin x)⌾((r bottom) +i) effect: 0 clippedBy: user screenrect.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">NormalCursor show.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">line </span><span style="font: 10pt serif">| pt1 pt2 p pt<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["line tool for forms."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">BlankCursor topage1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ user redbug do⦂</span><span class="tab" val="79"></span><span style="font: 10pt serif">[ pt1 &larr; self blinkbrush].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">brush displayat: pt1 effect: color clippedBy: user screenrect.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ user nobug do⦂</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ pt2 &larr; self blinkbrush].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">brush displayat: pt2 effect: color clippedBy: user screenrect.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">p &larr; Path new init.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">p addlinefrom: pt1 to: pt2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ pt from: p do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ brush displayat: pt effect: color clippedBy: user screenrect].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">NormalCursor topage1<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">newbrush </span><span style="font: 10pt serif">|  pt rect<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">OriginCursor topage1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user waitbug.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pt &larr; ( self mp)+ rectangle origin.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rect &larr; pt rect: pt.</span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">CornerCursor topage1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ user nobug do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[rect reverse.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">rect reverse.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pt &larr; <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">( self mp)+ rectangle origin.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">rect corner &larr; (rect origin) max: pt.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br> </span><span class="tab" val="79"></span><span style="font: 10pt serif">brush &larr; Form new fromrectangle: rect.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">NormalCursor topage1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pastebrush </span><span style="font: 10pt serif">| pt1 <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["one-copy tool for forms."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user waitnobug.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">OriginCursor show.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user waitbug.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ user redbug do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ pt1 &larr; self blinkbrush].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">XeqCursor show.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">brush displayat: pt1 effect: (dotsetter tool mode) clippedBy: user screenrect.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">NormalCursor show]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">resize: superimage </span><span style="font: 10pt serif">|  pt f<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[dotsetter leave.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">CornerCursor topage1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user waitbug. <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ user nobug do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self reverse.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self reverse.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">( pt &larr; <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(superimage  mp)+<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> superimage rectangle origin).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self corner&larr; pt max: ((self origin) + (16⌾16)).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br> </span><span class="tab" val="79"></span><span style="font: 10pt serif">self fromrectangle: rectangle.<br> </span><span class="tab" val="79"></span><span style="font: 10pt serif">self white ; display.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">NormalCursor topage1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self edit: superimage<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">rotate </span><span style="font: 10pt serif">| r f i j<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["90 degree rotation tool"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">r &larr; Rectangle new fromuser.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: ( r width) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ j to: ( r height) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">f &larr; Form new fromrectangle: (Rectangle new origin: (((r origin x)+i)⌾(r top+j)) extent: (1⌾1)).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">f displayat: (((r corner x)+j))⌾((r top)+i) effect: 0 clippedBy: user screenrect.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">setfigure </span><span style="font: 10pt serif">| t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"for now just increment the figure color by 1 \ 12"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">figure &larr; (figure +1 ) \ 12.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ t from: self do⦂ [ (t form) figure: figure].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self display<br>]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">setground </span><span style="font: 10pt serif">| t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"for now just increment the ground color by 1 \ 12"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ground &larr; (ground +1 ) \ 12.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ t from: self do⦂ [ (t form) ground: ground].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self display<br>]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">verticalsymmetry </span><span style="font: 10pt serif">| r f i <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["vertical symmetry tool"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user clear; show: &rsquo;Define rectangle. Reflection will be around right-hand edge&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">r &larr; Rectangle new fromuser.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">XeqCursor show.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: ( r width) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">f &larr; Form new fromrectangle: (Rectangle new origin: (((r origin x)+(r width)-i)⌾(r top)) extent: (1⌾(r height))).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">f displayat: ((r corner x) + i)⌾(r top) effect: 0 clippedBy: user screenrect.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">NormalCursor show.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">yellowbug </span><span style="font: 10pt serif">| <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitimagemenu bug<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=1⇒</span><span class="tab" val="79"></span><span style="font: 10pt serif">[self resize: superimage<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]; "change size"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=2⇒</span><span class="tab" val="79"></span><span style="font: 10pt serif">[self setfigure];</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=3⇒</span><span class="tab" val="79"></span><span style="font: 10pt serif">[self setground];</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=4⇒</span><span class="tab" val="79"></span><span style="font: 10pt serif">[self newbrush];</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=5⇒</span><span class="tab" val="79"></span><span style="font: 10pt serif">[self pastebrush];</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=6⇒</span><span class="tab" val="79"></span><span style="font: 10pt serif">[self arc ];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=7⇒</span><span class="tab" val="79"></span><span style="font: 10pt serif">[Rectangle new fromuser fillin: ((dotsetter tool) tone)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">mode: ((dotsetter tool) mode) ];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=8⇒  [(dotsetter tool) shade];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=9⇒  [self verticalsymmetry];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=10⇒  [self horizontalsymmetry];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=11⇒  [self rotate]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪BitImage under: &rsquo;FPI Packages&rsquo;.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">BitImage classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"BorderedText"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;BorderedText&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: TextImage<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>This class has not yet been commented</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>DISPLAY</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">displayat: pt effect: effect clippedBy: cliprect | origin corner<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["display text and border around it "<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">super displayat: pt effect: effect clippedBy: cliprect.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">origin &larr; frame origin.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">corner &larr; frame corner.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(Rectangle new<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">origin: origin-(1⌾1) corner: (corner x+1)⌾origin y)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">color: ¬1 mode: effect;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">moveto: (origin x-1)⌾corner y; color: ¬1 mode: effect;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">origin &larr; corner x⌾(origin y-1); color: ¬1 mode: effect;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">moveto: origin-(1⌾1); color: ¬1 mode: effect<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>SYSTEM</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">copy </span><span style="font: 10pt serif">| t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">t &larr;  BorderedText new paragraph: para copy frame: (frame copy) style: style copy.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">t c1&larr; c1 ; c2&larr; c2 ; begintypein &larr; begintypein.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pressCode </span><span style="font: 10pt serif">[⇑6]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">presson: press in: r | scale<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">scale &larr; press scale.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">press setp: (r origin x- scale)⌾(r corner y-(3*scale)) ;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">showrectwidth: (scale*(2+self width)) height: scale.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">press setp: (r origin x- scale)⌾(r corner y-((self height+5)*scale)) ;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">showrectwidth: (scale*(2+self width)) height: scale.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">press setp: (r origin x- scale)⌾(r corner y-(scale*(self height+4))) ;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">showrectwidth: scale height: (scale*(self height+2)).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">press setp: (r origin x+(scale*(self width)))⌾(r corner y-(scale*(self height+4))) ;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">showrectwidth: scale height: (scale*(self height+2)).<br><br>⇑ para presson: press in: r.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪BorderedText under: &rsquo;FPI Packages&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"Document"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;Document&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Image<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;displayorder style&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;leading micasperinch &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>basic document class</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>EDITING</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">bubbledelete: image </span><span style="font: 10pt serif">| delta i k<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["delete image from the document  and subtracting images extent y from all subimages below it."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; self find: image.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self deleteI: i .<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">delta &larr; image extent y.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ k from: i to: self length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(self◦k) translate: (0⌾(0-delta))<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">bubbleinsert: image </span><span style="font: 10pt serif">| delta i k<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["insert image into the document keeping the document y-sorted and adding images extent y to all subimages below it."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; self findindex: image.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self insertI: i value: image.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">delta &larr; image extent y.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ k from: i+1 to: self length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(self◦k) translate: (0⌾delta)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">delete: image </span><span style="font: 10pt serif">|  i <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["delete image from the document and leave its space. "<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; self find: image.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i⇒ [ self deleteI: i.]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">edit <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["Documents are edited with a DocumentEditor"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">DocumentEditor new init: self.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">findindex: image </span><span style="font: 10pt serif">| y guess top bottom<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["binary search on the origins of the rectangles surrounding my subimages<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">returns the index of the subimage just below image."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">position = 0 ⇒ [ ⇑ 1]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">top &larr; 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bottom &larr; position.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">y&larr; image rectangle origin y.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">y ≤ ((self◦1) rectangle origin y) ⇒ [ ⇑ 1].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">y ≥ ((self◦position) rectangle origin y) ⇒ [ ⇑ position+1]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">guess &larr; position/2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂  bottom = (top+1) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[((self◦guess) rectangle origin y) ≥ y ⇒ [ bottom &larr; guess ] top &larr; guess].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">guess &larr; (bottom + top) /2<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ bottom<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">insert: image </span><span style="font: 10pt serif">| i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["insert image into the document keeping the document y-sorted."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; self findindex: image.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self insertI: i value: image.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">resize </span><span style="font: 10pt serif">| delta t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["make sure the document does not have subimages that have negative y values and resize the document"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[position ≥ 1 ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(delta &larr; (self◦1) top) ≤ 0 ⇒ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ t from: self do⦂ [ t translate: (0⌾(0-delta)) ] <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">super resize<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>INIT</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">micasperinch &larr; 2540.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">name<br>[ ⇑  displayorder </span><span style="font: 10pt serif">"returns the name of the document ( displayorder is currently used for name... note that name is a string."<br></span><span style="font: bold 10pt serif"> ] <br></span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">name: displayorder <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["sets the name of the document ( displayorder is currently used for name... note that name is a string."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>SYSTEM</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">copy </span><span style="font: 10pt serif">| im i<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">im &larr; Document new origin: origin copy rectangle: rectangle copy path: path copy form: form copy figure: figure copy ground: ground copy xgrid: xgrid copy  ygrid: ygrid copy.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: self length do⦂ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[im add: (self◦i) copy].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">im name: (self name) copy.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ im<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fromPress: displayorder </span><span style="font: 10pt serif">| press s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">retrieves an instance of class Document from a press file</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user displayoffwhile⦂ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self default.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> press &larr; (dp0 pressfile: </span><span style="font: bold 10pt serif">displayorder</span><span style="font: 10pt serif">). press open.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s &larr; (press nextControl) asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s next = self pressCode ⇒ [self fromPress: press value: s]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: &rsquo;error in pressfile&rsquo;.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fromPress: press value:  s </span><span style="font: 10pt serif">| numberofsubimages t t1 i code <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["builds an instance of class Document from a press file"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">numberofsubimages&larr; s nextword.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">origin &larr; s nextPoint.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">t &larr; s nextPoint.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">t1 &larr; s nextPoint.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rectangle &larr; t rect: t1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">xgrid &larr; s nextword.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ygrid &larr; s nextword.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">displayorder&larr; s nextString.</span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: numberofsubimages do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s &larr; (press nextControl) asStream.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">code &larr; s next. <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">t &larr; [code = 1⇒ [Image new]; = 2⇒ [Heading new];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">= 3⇒ [BitImage new] false].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">t and⦂ code = t pressCode⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self addimage: (t fromPress: press value: s)]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: &rsquo;illegal code or code mismatch&rsquo;]</span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ self<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hardcopy </span><span style="font: 10pt serif">|</span><span class="tab" val="79"></span><span style="font: 10pt serif">p i press bottoms rect pressscale pageheight pagewidth  lastrect </span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">currentrect oldytop oldybottom <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">oldytop &larr; 11*micasperinch.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pageheight &larr; 11*micasperinch.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pagewidth&larr; 8*micasperinch.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user displayoffwhile⦂ <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">press &larr; dp0 pressfile: (displayorder + &rsquo;.doc&rsquo;).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pressscale &larr; press scale.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self hidePress: press complete: ¬1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">p &larr; PressPrinter init.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">p press: press;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">frame &larr;  ("in micas"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">((1*micasperinch)⌾(1*micasperinch)) rect:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">((pagewidth-micasperinch)⌾(pageheight-micasperinch))).<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">lastrect &larr; ((self◦1) rectangle)*pressscale.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rect &larr; ((lastrect leftside)⌾(1*micasperinch))<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rect: ((lastrect rightside) ⌾(pageheight - (lastrect top))).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">oldybottom &larr; p print: self◦1 in: rect.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: (2 to: self length) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[oldybottom &gt; oldytop⇒ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">["page break" oldytop &larr; pageheight-micasperinch.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">currentrect&larr; ((self◦i) rectangle) * pressscale.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(currentrect top &gt; lastrect bottom)⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[oldytop &larr; oldybottom+(lastrect bottom-currentrect top)"no overlap"]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">oldytop &larr; (oldytop+(lastrect top-currentrect top))"overlap"].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">rect &larr; ((currentrect leftside)⌾(1*micasperinch))<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">rect: ((currentrect rightside) ⌾(oldytop)).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">oldybottom &larr; p print: (self◦i) in: rect.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">lastrect &larr; ((self◦i) rectangle)*pressscale.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">press close; toPrinter "send over ethernet to printer"]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hideData: complete </span><span style="font: 10pt serif">| s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["stores an instance of class Document from a press file"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s &larr; Stream new of: (String new: 100).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s nextword&larr; self length; "number of subimages"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextPoint&larr; origin;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextPoint&larr; rectangle origin;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextPoint&larr; rectangle corner;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextword&larr; xgrid;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextword&larr; ygrid;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextString&larr; displayorder.</span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ s contents]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pressCode </span><span style="font: 10pt serif">[⇑0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm </span><span style="font: 10pt serif">| t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm append: &rsquo;a Document &rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪Document under: &rsquo;FPI Packages&rsquo;.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">Document classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"DocumentEditor"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;DocumentEditor&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Window<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;document documentwindow screenimage firstindex lastindex<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">indexofselection selection &rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;jumpcursor documentmenu scrap blankcursor &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>This class has not yet been commented</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>INIT</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">buildscreenimage |</span><span style="font: 10pt serif"> i r delta  <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["This function copies the subimages intersecting the document window<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">into the screen image."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">screenimage &larr; Image new origin: self frame origin extent: self frame extent.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">screenimage  xgrid: (document xgrid) ; ygrid: (document ygrid).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">delta &larr; documentwindow origin y.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">firstindex &larr; 1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">" find the index of the first subimage that intersects the document window."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ ((firstindex≥(document length)) or⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">((((document◦firstindex) rectangle) bottom) &gt; (documentwindow top))) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[firstindex &larr; firstindex+1].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">lastindex &larr; firstindex.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: (firstindex to: document length) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">((((document◦i) rectangle) top) &lt; (documentwindow bottom))⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[lastindex &larr; i. screenimage add: (((document◦i) "copy")<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">translate: 0⌾0 - (0⌾delta))<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">] ⇑ lastindex<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"><br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit <br></span><span style="font: italic 10pt serif">"  DocumentEditor classInit.    "<br></span><span style="font: 10pt serif">[</span><span class="tab" val="79"></span><span style="font: 10pt serif">documentmenu &larr; Menu new string:<br>&rsquo;move<br>erase<br>place<br>cut<br>paste<br>copy<br>top<br>bottom<br>jump<br>addspace<br>deletespace<br>show<br>&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">jumpcursor &larr; Cursor new fromtext: &rsquo;<br>1111111111111111<br>1111111111111111<br>0000000000000000<br>0000000000000000<br>0000000000000000<br>0000000000000000<br>0000001110000000<br>0000011111000000<br>0000011111000000<br>0000001110000000<br>0000000000000000<br>0000000000000000<br>0000000000000000<br>0000000000000000<br>1111111111111111<br>1111111111111111&rsquo; offset: 2⌾1.<br>]<br><br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">defaultdocument <br></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self defaultdocument: &rsquo;document&rsquo;<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">defaultdocument: name </span><span style="font: 10pt serif">| defaultdocument run r textimage f im dot heading head text char b image row<br>[" name is a string"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">defaultdocument &larr; Document new origin: 0⌾0<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">extent: (user screenrect) extent.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">defaultdocument name: name.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">defaultdocument xgrid: DefaultTextStyle tab.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">defaultdocument ygrid: DefaultTextStyle lineheight.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">textimage &larr; BorderedText new.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">textimage text: &rsquo;Text that is bordered&rsquo; width: 200.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">defaultdocument addform: textimage andpath: 0⌾0.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">textimage &larr; TextImage new.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">textimage text: &rsquo;This is a paragraph&rsquo; width: 600.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">defaultdocument addform: textimage andpath: 0⌾0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">b &larr; BitImage new fromrectangle:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(Rectangle new origin: 0⌾200 extent: 100⌾100).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">defaultdocument insert: b.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">head &larr; Set new default.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">text &larr; &rsquo;HEADING&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ char from: text do⦂ [ head add: char ].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">heading &larr; Heading new origin: 0⌾400 index: 9 charactercodes: head<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">currentcharacter: 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">defaultdocument insert: heading.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"defaultdocument insert: CurveIdiom new init."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self init: defaultdocument.<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init: document </span><span style="font: 10pt serif">| i <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["This is the paragraph (subimage) level document editor."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self fixedwidthfromuser: document width.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">documentwindow &larr; Rectangle new origin: document rectangle origin<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">extent: (document width) ⌾ (self frame height).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self buildscreenimage.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">selection &larr; false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user topWindow leave.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self takeCursor; enter.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user restartup: self<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>DEFAULT EVENT RESPONSES</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">close<br></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">XeqCursor show.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">document close.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">document &larr; nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">screenimage &larr; Vector new: 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">NormalCursor show<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">enter </span><span style="font: 10pt serif">[selection &larr; false. self show]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hardcopy<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["write a press file and hardcopy this document"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self leave.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self top.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">document hardcopy<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">kbd | c x y<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">   c &larr; user kbd. <br> </span><span class="tab" val="79"></span><span style="font: 10pt serif">c = 120⇒<br> </span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ user clearshow: &rsquo;x gridding is &rsquo;. document xgrid print.<br> </span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user cr.<br> </span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">document xgrid: (x&larr;<br> </span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(user request: &rsquo;x gridding . . . &rsquo;) asInteger).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">screenimage xgrid: x. <br> </span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">] <br> </span><span class="tab" val="79"></span><span style="font: 10pt serif">c = 121⇒<br> </span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ user clearshow: &rsquo;y gridding is &rsquo;. document ygrid print.<br> </span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user cr.<br> </span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">document ygrid: (y&larr;<br> </span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(user request: &rsquo;y gridding . . . &rsquo;) asInteger).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">screenimage ygrid: y.<br> </span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">] <br>]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">leave<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">document ≡ nil ⇒ []<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[selection⇒ [ selection highlite]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self update ; buildscreenimage.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">selection &larr; false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">print <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["write a press file and hardcopy this document"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">document hardcopy<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">redbug | pt rect newrect start t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pt &larr; user mp.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">start&larr;pt.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rect&larr;newrect&larr;(Rectangle new origin: start corner: start).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[selection⇒ [selection highlite. self deselect. selection &larr; false.]]. <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ user anybug do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[rect&larr;newrect.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">rect comp.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">t&larr;user mp.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">newrect&larr;(Rectangle new origin: (start min: t) corner: (start max: t)).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">rect comp].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(rect width &lt; 10) ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">selection &larr;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">screenimage smallestsubimageat:  pt- screenimage origin.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">selection⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">selection  translate: screenimage origin.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">selection edit: screenimage.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">selection translate: ((0⌾0) - screenimage origin).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">selection &larr; false.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">rect origin &larr; screenimage griddedpoint: (rect origin).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">selection &larr; screenimage subimageswithin: <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(rect translate: ((0⌾0)- screenimage origin)).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">selection ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[selection translate: screenimage origin ; highlite]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">yellowbug | pt<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">documentmenu bug<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=1⇒[self move];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=2⇒[self delete];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=3⇒[self place];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=4⇒[self cut];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=5⇒[self paste];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=6⇒[self copyselection];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=7⇒[self top];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=8⇒[self bottom];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=9⇒[self jump];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=10⇒[self addspace];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=11⇒[self deletespace];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=12⇒[self deselect. selection &larr; false. self show]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>FRAMING</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">newframe<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self update.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self fixedwidthfromuser: document width.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self buildscreenimage ; show.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">show </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">XeqCursor show.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self outline .<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">growing⇒[]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">titleframe put: (Paragraph new text: self title runs: titlerun alignment: 0)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">at: frame origin+titleloc; window outline; show.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">screenimage  white.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">screenimage displayat: 0⌾0 effect: 1 clippedBy: self frame.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">selection ⇒ [ selection boxcomp].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">NormalCursor show<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">title </span><span style="font: 10pt serif">[ ⇑ document name] </span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>EDITING</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">addspace </span><span style="font: 10pt serif">| image i k r delta<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["add whitespace to the document  ."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self update. selection &larr; false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">r &larr; document rectanglefromuser.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; (document indexofsubimagebelow: (r top- screenimage top) + documentwindow top).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[i⇒ </span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">delta &larr; r height.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ k from: i to: document length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(document◦k) translate: (0⌾(delta))<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">document resize<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self buildscreenimage ; show.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">bottom </span><span style="font: 10pt serif">|  i delta <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["translate the current selection to the bottom of the window and update the document to reflect any changes in the subimages which are scrolled out of the screenimage."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">selection⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">delta &larr; (selection rectangle corner - screenimage rectangle corner).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self update. selection &larr; false.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">documentwindow translate: (0⌾ (delta y)). "move window on document"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self buildscreenimage ; show. <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"reconstruct screen image, including reestablishing  first and last indices"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self update.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">documentwindow &larr; Rectangle new origin:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(document rectangle corner-self frame height)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">extent: (document width) ⌾ (self frame height).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self buildscreenimage ; show.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">closeScrap<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">scrap ≡ nil⇒ []<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">scrap close<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">copy </span><span style="font: 10pt serif">| <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["copy the selection and put it in scrap"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self copyselection<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">copyselection </span><span style="font: 10pt serif">| <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["copy the selection and put it in scrap"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">selection⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">XeqCursor show.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self closeScrap.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">scrap &larr; selection copy.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">NormalCursor show<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">frame flash<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">cut </span><span style="font: 10pt serif">| t <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["delete subimage (paragraph) from the screenimage and save it in the scrap"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">selection⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">XeqCursor show.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self closeScrap.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">scrap &larr; selection.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self update.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ t from: selection do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">document bubbledelete: t.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">selection &larr; false.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self buildscreenimage ; show.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">NormalCursor show<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">frame flash<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">delete | t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["delete subimage (paragraph) from the screenimage and save it in the scrap"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">selection⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">XeqCursor show.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self closeScrap.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">scrap &larr; selection.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">selection highlite ;  display: 3.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ t from: selection do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[screenimage delete: t<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]. <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">selection &larr; false.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">NormalCursor show.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">frame flash<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">deletespace </span><span style="font: 10pt serif">| image i k r delta<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["delete whitespace from the document  ."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self update. selection &larr; false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">r &larr; document rectanglefromuser.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; (document indexofsubimagebelow: (r top - screenimage top) + documentwindow top).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[i⇒ </span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">delta &larr; r height.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ k from: i to: document length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(document◦k) translate: (0⌾(0-delta))<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">document resize<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self buildscreenimage ; show.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">deselect </span><span style="font: 10pt serif">| t<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[selection⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">selection translate: ((0⌾0) - screenimage origin).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ t from: selection do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[t translate: selection origin<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">] </span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">editTitle<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[titlepara&larr;document name asParagraph.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">super editTitle.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">document name: titlepara text]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">jump<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">|  y deltay yprime deltayprime rect pt newY scal r<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user waitnobug.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">XeqCursor show.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self update.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">y &larr; document height.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">yprime &larr; frame height.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">deltay &larr; (documentwindow origin y) - (document  origin y).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">scal&larr;yprime asFloat/y.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">deltayprime &larr; (scal*deltay) asInteger.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pt &larr; ((screenimage leftside+((1.0-scal)*frame width/2))⌾((screenimage top) + deltayprime)).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">document quickDisplayAt: 0⌾0 scale: scal offset: (frame minX + ((1.0-scal)*frame width/2))⌾frame minY.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rect&larr;0⌾0 rect: 1⌾1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rect origin &larr; pt.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rect corner x&larr;pt x +(scal*frame width) asInteger.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rect corner y&larr;pt y + (scal*frame height) asInteger.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user cursorloc&larr;pt.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">OriginCursor show.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user waitbug.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user redbug<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇒</span><span class="tab" val="79"></span><span style="font: 10pt serif">[rect comp.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ user redbug do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[r&larr;rect copy.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">newY&larr;user mp y.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[newY&lt;(frame minY- rect height) ⇒ [newY&larr;frame minY-rect height]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[newY&gt;frame maxY ⇒ [newY&larr;frame maxY]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">rect translateto: pt x⌾newY.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">r comp.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">rect comp].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">rect comp.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">XeqCursor show.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">deltayprime &larr; newY - (frame origin y).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">deltay &larr; y*deltayprime/yprime.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">documentwindow translateto: (0⌾deltay).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">selection &larr; false]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self buildscreenimage.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self show.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">NormalCursor show]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">move </span><span style="font: 10pt serif">| pt t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["used to place subimages (paragraphs) in the Image."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">selection<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇒</span><span class="tab" val="79"></span><span style="font: 10pt serif">[user waitnobug.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">OriginCursor show.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user waitbug. <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">selection highlite ; displayat: 0⌾0 effect: 3 clippedBy: frame.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ user redbug do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pt &larr;screenimage mp + screenimage rectangle origin.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">selection translateto: pt.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">selection blink].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">XeqCursor show.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">selection displayat: 0⌾0 effect: 1 clippedBy: frame .<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self deselect.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">selection &larr; false.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">NormalCursor show]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">frame flash]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">paste </span><span style="font: 10pt serif">| </span><span style="font: bold 10pt serif">pt t</span><span style="font: 10pt serif"><br><br>["add the subimage (paragraph) in the scrap to the screenimage."<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">selection⇒ [selection highlite]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self update.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">selection &larr; scrap copy.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">OriginCursor showwhile⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user waitbug.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ user nobug do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pt &larr;screenimage mp + screenimage rectangle origin.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">selection  translateto: pt ; blink<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">selection displayat: 0⌾0 effect: 1 clippedBy: self frame .<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self deselect.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ t from: selection do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">document bubbleinsert: (t translate: documentwindow origin).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">selection &larr; false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self buildscreenimage ; show.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">place </span><span style="font: 10pt serif">| pt tempimage t<br><br>["add the image in the scrap to the screenimage."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[selection⇒[selection highlite]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self deselect.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">selection &larr; scrap copy.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">OriginCursor showwhile⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user waitbug.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ user nobug do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pt &larr;screenimage mp + screenimage rectangle origin.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">selection translateto: pt ; blink<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">selection  displayat: 0⌾0 effect: 1 clippedBy: self frame.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self deselect.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ t from: selection do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">screenimage add: t.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">selection &larr; false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">top </span><span style="font: 10pt serif">|  i delta <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["translate the current selection to the top of the window and update the document to reflect any changes in the subimages which are scrolled out of the screenimage."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">selection⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">delta &larr; (selection rectangle origin - screenimage rectangle origin).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self update. selection &larr; false.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">documentwindow translate: (0⌾ (delta y)). "move window on document"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self buildscreenimage ; show. <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"reconstruct screen image, including reestablishing  first and last indices"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self update.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">documentwindow &larr; Rectangle new origin: document rectangle origin<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">extent: (document width) ⌾ (self frame height).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self buildscreenimage ; show.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">update </span><span style="font: 10pt serif">|  i <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["update the document to reflect any changes in the subimages ."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">XeqCursor topage1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[selection⇒</span><span class="tab" val="79"></span><span style="font: 10pt serif">[self deselect]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">document deleteI: firstindex to: lastindex. "update document"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: screenimage length  do⦂ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[document insert: <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(screenimage◦i translate: (0⌾documentwindow origin y)).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">document resize.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">NormalCursor topage1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪DocumentEditor under: &rsquo;FPI Packages&rsquo;.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">DocumentEditor classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"Heading"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;Heading&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Image<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;formset index charactercodes currentcharacter&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;headingmenu &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>This class has not yet been commented</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>INIT</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["menu for the Heading edits."<br><br>headingmenu &larr; Menu new string:<br>&rsquo;right<br>left<br>up<br>down<br>font<br>&rsquo;.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">origin: origin formset: formset currentcharacter: currentcharacter<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["initilization of a Heading (used in copy)"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[formset is: Integer⇒ [ formset &larr; FormSet new fromstyle:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">DefaultTextStyle styleindex: formset.]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self origin: origin extent: (200⌾formset height).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">origin: origin index: index charactercodes: charactercodes<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 10pt serif">currentcharacter: currentcharacter | char w delta<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["initilization of a Heading (used in copy)"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">formset &larr; FormSet new fromstyle:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">DefaultTextStyle styleindex: index.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ nil ≡ charactercodes ⇒ [ charactercodes &larr; Set new default]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self origin: origin extent: (200⌾formset height).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">w &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">delta &larr; origin copy.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self translate: (0⌾0 - delta).</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ char from: charactercodes do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span class="tab" val="79"></span><span style="font: 10pt serif">char &larr; formset asForm: char.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self addpath: w⌾0 andform: char.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">w &larr; w + char width.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self translate: delta.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ self<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>EDIT</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">down | delta<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["move the current character down one bit."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self boxcomp.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(self◦currentcharacter) translate: (0⌾1).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">delta &larr; origin copy.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self translate: (0⌾0 - delta) ; resize ; translate: delta.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self white ; display: 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self boxcomp.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">edit: parentimage </span><span style="font: 10pt serif">| pt <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["Simple Heading (line) editor for now."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self display: 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ 1=2 do⦂ "forever for now"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user kbck⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ self typein ]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user yellowbug ⇒</span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">headingmenu bug<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=1⇒</span><span class="tab" val="79"></span><span style="font: 10pt serif">[self right]; "move current character right one bit"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=2⇒</span><span class="tab" val="79"></span><span style="font: 10pt serif">[self left]; "move current character left one bit"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=3⇒</span><span class="tab" val="79"></span><span style="font: 10pt serif">[self up]; "move current character up one bit"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=4⇒</span><span class="tab" val="79"></span><span style="font: 10pt serif">[self down]; "move current character down one bit"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">=5⇒</span><span class="tab" val="79"></span><span style="font: 10pt serif">[self newfont] "change fonts"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user redbug ⇒ </span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(rectangle has: (pt&larr; user mp))⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pt &larr; pt - (rectangle origin).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">currentcharacter&larr; self indexofsubimageat: pt.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">currentcharacter⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self◦currentcharacter displayat: self origin<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">effect: 2 clippedBy: user screenrect.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self◦currentcharacter displayat: self origin<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">effect: 2 clippedBy: user screenrect.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ self<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user bluebug ⇒ </span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ self.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">] "exit back to the parentimage" <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">left | i delta<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["move the current character and all those to the right of it to the left one bit."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self boxcomp.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: (currentcharacter to: self length) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ (self◦i) translate: (0⌾0) -(1⌾0) ].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">delta &larr; origin copy.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self translate: (0⌾0 - delta) ; resize ; translate: delta.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self white ; display: 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self boxcomp.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">newfont </span><span style="font: 10pt serif">| w char charcount delta i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">index &larr;(user request: &rsquo;index of new font . .  &rsquo; ) asInteger.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">formset &larr; FormSet new fromstyle: DefaultTextStyle styleindex: index.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self white.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: position do⦂ [ self◦i &larr; nil ].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">position &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">w &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">charcount &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">delta &larr; origin copy.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self translate: (0⌾0 - delta).</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ char from: charactercodes do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[nil≡ char ⇒ []<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">char &larr; formset asForm: char.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">char displayat: delta+ (w⌾0) effect: 0 clippedBy: user screenrect.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self addpath: w⌾0 andform: char.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">w &larr; w + char width.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">charcount &larr; charcount+1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self resize.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self translate: delta.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ self<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">right | i delta<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["move the current character and all those to the right of it to the right one bit."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self boxcomp.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: (currentcharacter to: self length) do⦂ [ (self◦i) translate: (1⌾0) ].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">delta &larr; origin copy.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self translate: (0⌾0 - delta) ; resize ; translate: delta.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self white ; display: 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self boxcomp.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">typein </span><span style="font: 10pt serif">| w char charcount delta i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self white.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: position do⦂ [ self◦i &larr; nil ].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">position &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">w &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">charcount &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">charactercodes &larr; Set new default.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">delta &larr; origin copy.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self translate: (0⌾0 - delta).</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ (char &larr; user kbd) = 13 do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(char = 8) ⇒"back space" <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[charcount ≠  0 ⇒ [ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> </span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">w &larr; w - ( (self◦charcount) width).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(self◦charcount) white.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self deleteimage: charcount.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">charactercodes deleteI: charcount.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">charcount &larr; charcount -1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">charactercodes add: char.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">char &larr; formset asForm: char.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">char displayat: delta+ (w⌾0) effect: 0 clippedBy: user screenrect.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self addpath: w⌾0 andform: char.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">w &larr; w + char width.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">charcount &larr; charcount+1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self resize.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self translate: delta.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ self<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">up | delta<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["move the current character up one bit."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self boxcomp.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(self◦currentcharacter) translate: (0⌾0) - (0⌾1).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">delta &larr; origin copy.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self translate: (0⌾0 - delta) ; resize ; translate: delta.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self white ; display: 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self boxcomp.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>SYSTEM</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">copy </span><span style="font: 10pt serif">| h i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">h&larr; Heading new origin: (rectangle origin) copy index: index charactercodes: (charactercodes copy)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">currentcharacter: currentcharacter copy.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">h rectangle: rectangle copy.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: self length do⦂ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">h add: (self◦i) copy <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ h<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fromPress: press value:  s </span><span style="font: 10pt serif">| numberofcharacters  i <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["retrieves and builds an instance of class Heading from a press file"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">numberofcharacters&larr; s nextword.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">origin &larr; s nextPoint.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">index &larr; s nextword.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">charactercodes &larr; Set new default.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: numberofcharacters do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ charactercodes add: s nextword ]</span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ self origin: origin index: index charactercodes: charactercodes<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">currentcharacter: 1<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hideData: complete </span><span style="font: 10pt serif">| s i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["stores an instance of class Heading on a press file"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s &larr; Stream new of: (String new: 100).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s nextword&larr; self length; "number of characters"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextPoint&larr; origin;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextword &larr; index.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: self length do⦂ [s nextword &larr; charactercodes◦i].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ s contents]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pressCode </span><span style="font: 10pt serif">[⇑2]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">presson: press in: r </span><span style="font: 10pt serif">| hs y t i pressscale [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(hs  &larr; press scale*self height) &gt; r height⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"not enough room left on current page.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">assume for now that it will at least fit on an entire page"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ self]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self hidePress: press complete: ¬1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pressscale &larr; press scale.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">press selectfont: (press fontindex: 16*index style: DefaultTextStyle) - 1.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: self length  do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">press setx:  r leftside + ((self◦i) leftside*pressscale).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">press sety: r bottom - ((self◦i) top*pressscale).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">press showchar: (charactercodes◦i)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ r bottom - ((self height)*pressscale)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm </span><span style="font: 10pt serif">| t [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm append: &rsquo;a Heading &rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪Heading under: &rsquo;FPI Packages&rsquo;.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">Heading classInit</span></div>
    <div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">&rsquo;From Smalltalk 5.5k XM November 24 on 22 November 1980 at 2:57:08 am.&rsquo;<br></span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">"JuniperFileController"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;JuniperFileController&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: File<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fLongFileHandle<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fShortFileHandle<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sharing: gJuniperConstants;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>JUNIPER FILE CONTROLLER</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>DOCUMENTATION</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">implementationNotes<br></span><span style="font: 10pt serif">[<br>"<br>FIELDS<br></span><span style="font: bold 10pt serif">fLongFileHandle</span><span style="font: 10pt serif"> : a LongInteger representing the unique identifier for the file.<br></span><span style="font: bold 10pt serif">fShortFileHandle</span><span style="font: 10pt serif"> : an Integer representing the identifier for the file during a particular transaction.<br>"<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>FILE REDEFINITIONS (restricted)</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">allocatePage<br></span><span style="font: 10pt serif">"...returns a new packet (Pacbuf) to be used as the data buffer in a JuniperPageBuffer."</span><span style="font: bold 10pt serif"><br></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ ((self interface) newPacket)<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">close<br></span><span style="font: 10pt serif">"...closes the file on the Juniper file system."</span><span style="font: bold 10pt serif"><br></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self doAction: sCloseFile requestPrs: nil.<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">endFile: pPageBuffer<br></span><span style="font: 10pt serif">"...adjusts the file length, writes pPageBuffer (a JuniperPageBuffer) on the file, and returns pPageBuffer."<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self length: ( ((pPageBuffer pageNumber)-1)*(pPageBuffer dataLength)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">+ pPageBuffer length<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ).  "1"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self writePage: pPageBuffer.  "2"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ pPageBuffer<br>]<br>"<br>1. Set the file length to the total number of bytes in the file.<br>2. Write the page on Juniper.<br>"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">entryClass<br></span><span style="font: 10pt serif">"...returns the class of objects managed by JuniperFileController objects."</span><span style="font: bold 10pt serif"><br></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ JuniperPageBuffer<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">Get: pPageBuffer<br></span><span style="font: 10pt serif">"...reads the data from the page whose number is that specified by pPageBuffer (a JuniperPageBuffer) if such a page exists.  Otherwise pPageBuffer should contains data to be written on the file at the appropriate place."</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">| tNextPageNumber tNewPageNumber i<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tNewPageNumber &larr; pPageBuffer pageNumber.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tNewPageNumber ≤ lastpn and⦂ (<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">lastpn &gt; 1 or⦂ self length &gt; 0)⇒ [ ⇑ (self Read: pPageBuffer) ]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tNextPageNumber &larr; lastpn + 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ tNewPageNumber = tNextPageNumber ⇒ [ ]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self length: (tNewPageNumber-1) * (pPageBuffer dataLength).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: tNextPageNumber to: (tNewPageNumber-1) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ pPageBuffer pageNumber: i.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pPageBuffer &larr; self writePage: pPageBuffer.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pPageBuffer pageNumber: tNewPageNumber.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pPageBuffer length: 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ pPageBuffer<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">lastFullPage </span><span style="font: 10pt serif">[⇑self length / self entryClass new dataLength]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">length<br></span><span style="font: 10pt serif">"...returns the number of bytes (an Integer) in the file."</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">| tResult</span><span style="font: bold 10pt serif"><br></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tResult &larr; self doAction: sReadLength requestPrs: nil.  "1"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ (tResult longInteger: 1)  "2"<br>]<br>"<br>1. Issue a &rsquo;read length&rsquo; command to Juniper.<br>2. Return the length from the result parameter block.<br>"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">length: pLength<br></span><span style="font: 10pt serif">"...sets the number of bytes in the file to the integer pLength (an Integer)."</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">| tRequest</span><span style="font: bold 10pt serif"><br></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tRequest &larr; self newRequestParameterBlock.  "1"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tRequest longInteger: 1 &larr; pLength.  "2"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self doAction: sSetLength requestPrs: tRequest.  "3"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">lastpn &larr; self pageFrom: pLength.  "4"<br>]<br>"<br>1. Create a new request parameter block.<br>2. Set the length parameter to pLength.<br>3. Issue a &rsquo;set length&rsquo; command to Juniper.<br>4. Determine the number of the last page of the file and assign it to the superClass field lastpn.<br>"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">open<br></span><span style="font: 10pt serif">"...opens the file on the Juniper file system."</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">| tRequest tResult<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tRequest &larr; self newRequestParameterBlock.  "1"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tRequest nextDataBlockString &larr; fLongFileHandle.  "2"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tResult &larr; (self interface) doAction: sOpenFile requestPrs: tRequest.  "3"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fShortFileHandle &larr; tResult parameter: 1.  "4"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self findLastPage.  "5"<br>]<br>"<br>1. Create a new request parameter block.<br>2. Set the long file handle parameter.<br>3. Issue an &rsquo;open file&rsquo; command to Juniper.<br>4. Set the superClass field serialNumber to the short file handle returned by Juniper in the result parameter block.<br>5. Set the number of the last page of the file.<br>"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">Read: pPageBuffer<br></span><span style="font: 10pt serif">"...returns false if the page number of pPageBuffer (a JuniperPageBuffer) is greater than the page number of the last page of the file; otherwise, the data for that page is read from the Juniper file system into the packet of pPageBuffer."</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">| tRequest tResult pn</span><span style="font: bold 10pt serif"><br></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ (pn &larr; pPageBuffer pageNumber) &gt; lastpn  ⇒  [ ⇑ false ]  "1"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">lastpn=1 and⦂ self empty⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pPageBuffer length: 0. "⇑ self Get: pPageBuffer" ]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">tRequest &larr; self newRequestParameterBlock.  "2"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">tRequest parameter: 1 &larr; (pn - 1).  "3"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">tResult &larr; self doAction: sReadPage requestPrs: tRequest.  "4"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pPageBuffer page: (tResult packet).  "5"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pPageBuffer length: (tResult parameter: 1).  "6"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ pPageBuffer  "7"<br>]<br>"<br>1. Return false if the page number of pPageBuffer is greater than that of the last page of the file.<br>2. Create a new request parameter block.<br>3. Set the page number parameter to that of pPageBuffer less 1.  Juniper page numbers start at 0.<br>4. Issue a &rsquo;read page&rsquo; request.<br>5. Set the pPageBuffer packet to that of the result parameter block.<br>6. Set the length of pPageBuffer to that returned in the result parameter block.<br>7. Return pPageBuffer modified.<br>"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">Write: pPageBuffer<br></span><span style="font: 10pt serif">"...adjusts the length of the file if pPageBuffer is the last page, sends the data buffered in pPageBuffer (a JuniperPageBuffer) to the Juniper file system, and returns pPageBuffer."</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">| tPageNumber<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tPageNumber &larr; pPageBuffer pageNumber.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ tPageNumber &lt; lastpn ⇒ [ ]  "1"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ tPageNumber &gt; (lastpn+1) ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ ⇑ self error: &rsquo;invalid page number&rsquo; ]  "2"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self length:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">( (tPageNumber-1)*(pPageBuffer dataLength)+(pPageBuffer length)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">).  "3"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self writePage: pPageBuffer.  "4"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ pPageBuffer  "5"<br>]<br>"<br>1. If the page number of pPageBuffer is less than the last page number of the file, do not readjust the file length.<br>2. If the page number of pPageBuffer is greater than the next available page number for the file, invoke error handling.<br>3. If pPageBuffer is the last page of the file or will immediately follow the last page of the file, adjust the file length.<br>4. Send the data to Juniper.<br>5. Return pPageBuffer unmodified.<br>"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">writePage: pPageBuffer<br></span><span style="font: 10pt serif">"...sends the data buffered in pPageBuffer (a JuniperPageBuffer) to the Juniper file system provided the buffer is not empty."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">| tRequest<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ (pPageBuffer length = 0) ⇒ [ ]  "1"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">tRequest &larr; JuniperRequestParameterBlock new.  "2"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">tRequest<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">packet &larr; pPageBuffer page;  "3"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">leader: 1 &larr; 0;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">leader: 2 &larr; 0;  "4"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">parameter: 1 &larr; ((pPageBuffer pageNumber) - 1).  "5"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self doAction: sWritePage requestPrs: tRequest.  "6"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br>]<br>"<br>1. If there is no data in pPageBuffer do nothing.<br>2. Create a new request parameter block.<br>3. Set the packet to that of pPageBuffer.  This contains the data to be written on the Juniper file.<br>4. Set the authentication key and reserved word to 0.<br>5. Set the page number parameter to that of pPageBuffer less 1.  Juniper page numbers start at 0.<br>6. Issue a &rsquo;write page&rsquo; request.<br>"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>MISC (internal)</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">doAction: pAction requestPrs: pRequest<br></span><span style="font: 10pt serif">"...the specified request, pAction, (selected from gJuniperConstants) with its corresponding request parameter block, pRequest ( a JuniperRequestParameter Block), is issued to the Juniper file server (through the file interface).  If no errors are found, a JuniperResultParameterBlock is returned; otherwise, error handling is invoked.  If no request parameters are required, pRequest can be specified as nil."</span><span style="font: bold 10pt serif"><br></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ pRequest ≡ nil ⇒ [ pRequest &larr; self newRequestParameterBlock. ]  "1"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pRequest shortFileHandle &larr; fShortFileHandle.  "2"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ ((self interface) doAction: pAction requestPrs: pRequest)  "3"<br>]<br>"<br>1. Create a new request parameter block if one is not specified.<br>2. Set the short file handle parameter.<br>3. Issue the request to the Juniper interface and return the result parameter block.<br>"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">interface<br></span><span style="font: 10pt serif">"...returns the JuniperInterface controlling the file."</span><span style="font: bold 10pt serif"><br></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ directory<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">longFileHandle: pLongFileHandle<br></span><span style="font: 10pt serif">"...sets the file&rsquo;s long file handle."</span><span style="font: bold 10pt serif"><br></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fLongFileHandle &larr; pLongFileHandle.<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">newRequestParameterBlock<br></span><span style="font: 10pt serif">"...initializes and returns a new JuniperRequestParameterBlock."</span><span style="font: bold 10pt serif"><br></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ ((self interface) newRequestParameterBlock)<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪JuniperFileController under: &rsquo;Juniper&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"JuniperInterface"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;JuniperInterface&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: FileDirectory<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo; <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fName<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fPassword<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fDefaultDirectory<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fJuniperSocket<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fTimer<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fExceptionHandler<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fSpecialError<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fOpenIndicator<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sharing: gJuniperConstants;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>JUNIPER INTERFACE</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>DOCUMENTATION</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">implementationNotes<br></span><span style="font: 10pt serif">[<br>"<br>FIELDS<br></span><span style="font: bold 10pt serif">fName </span><span style="font: 10pt serif">:</span><span style="font: bold 10pt serif"> </span><span style="font: 10pt serif">a String representing the name of an account on the Juniper file system.<br></span><span style="font: bold 10pt serif">fPassword </span><span style="font: 10pt serif">: a String representing the password of the same account.<br></span><span style="font: bold 10pt serif">fDefaultDirectory</span><span style="font: 10pt serif"> : a String representing the directory to be used as the default if one is not specified as part of a file name.<br></span><span style="font: bold 10pt serif">fJuniperSocket</span><span style="font: 10pt serif"> : a JuniperSocket used to interface to the etherWorld mechanism.<br></span><span style="font: bold 10pt serif">fTimer</span><span style="font: 10pt serif"> : a Timer used to periodically send noop commands when the interface is open to prevent timeout.<br></span><span style="font: bold 10pt serif">fExceptionHandler</span><span style="font: 10pt serif"> : an ExceptionHandler to invoke when a transaction is aborted.<br></span><span style="font: bold 10pt serif">fSpecialError</span><span style="font: 10pt serif"> : an error code to ignore on a command request.<br></span><span style="font: bold 10pt serif">fOpenIndicator</span><span style="font: 10pt serif"> : the interface status: true means open; nil means not open.<br>"<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>USER CALLABLE</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">close<br></span><span style="font: 10pt serif">"...ends the current transaction and closes the interface."</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">|  tResult</span><span style="font: bold 10pt serif"><br></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ fOpenIndicator ≡ nil ⇒ [ ]  "1"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">tResult &larr; self doAction: sLogout requestPrs: nil.  "2"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">cr;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">show: (tResult nextDataBlockString).  "3"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">super close.  "4"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br>]<br>"<br>1. If the interface is not open, do nothing.<br>2. Issue a logout command.<br>3. Display the logout message returned by Juniper.<br>4. delete self from externalViews, Release timers, fields, etc.<br>"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">closeTransaction<br></span><span style="font: 10pt serif">"...closes the current transaction leaving the user logged in with all open files still open, and all read and write locks still in effect."</span><span style="font: bold 10pt serif"><br></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self doAction: sCloseTransaction requestPrs: nil.<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">directory: pDirectory<br></span><span style="font: 10pt serif">"...specifies the directory name to be added to any file name that does not begin with a directory name."</span><span style="font: bold 10pt serif"><br></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fDefaultDirectory &larr; pDirectory.<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">exceptionHandler: pExceptionHandler<br></span><span style="font: 10pt serif">"...specifies an exception handler to be invoked if any subsequent request discovers that the expected transaction has been closed.  If no exception handler is set, a notify window is displayed."</span><span style="font: bold 10pt serif"><br></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fExceptionHandler &larr; pExceptionHandler.<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">name: pName password: pPassword<br></span><span style="font: 10pt serif">"...specifies the name and password of an account on the Juniper file system.  This account will be logged into whenever the interface is opened."</span><span style="font: bold 10pt serif"><br></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fName &larr; pName.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fPassword &larr; pPassword.<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">obsolete </span><span style="font: 10pt serif">[⇑fOpenIndicator ≡ nil]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">open<br></span><span style="font: 10pt serif">"...opens the interface allowing access to files on the Juniper file system.  A new transaction is started."</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">| tResult</span><span style="font: bold 10pt serif"><br></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ fOpenIndicator ≡ true  ⇒ [ ]  "1"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">E wakeup.  "2"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self release.  "3"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">fJuniperSocket &larr; JuniperSocket new hostName: self server.  "4"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">tResult &larr; self login: (self userName) password: (self userPassword).  "5"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">cr;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">show: (tResult nextDataBlockString).  "6"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self timerOn.  "7"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">super open.  "8"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">fOpenIndicator &larr; true.  "9"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br>]<br>"<br>1. If the interface is already open, do nothing.<br>2. Make sure that the EtherWorld mechanism is in a valid state.<br>3. Release the interface to insure a valid initial state.  (An invalid state can occur from  an error on some statement in a previous invocation of &rsquo;open&rsquo;).<br>4. Create and initialize a JuniperSocket (parameterize server name?).<br>5. Issue a login command.<br>6. Display the login message that is returned by Juniper.<br>7. Turn on a timer to issue periodic noop commands to prevent timeout.<br>8. Do predefined open operations.<br>9. Set the interface status to &rsquo;open&rsquo;.<br>"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">release<br></span><span style="font: 10pt serif">"...leaves the interface in a valid state after an error."<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fOpenIndicator &larr; nil.  "1"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self timerOff.  "2"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ fJuniperSocket ≡ nil ⇒ [ ]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">fJuniperSocket close.  "3"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">fJuniperSocket &larr; nil.  "4"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br>]<br>"<br>1. Set the interface status to &rsquo;not open&rsquo;.<br>2. Turn off the timer.<br>3. Close the JuniperSocket if it exists.<br>4. Release the JuniperSocket field.<br>"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">versionNumbers </span><span style="font: 10pt serif">[⇑true]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>FILE DIRECTORY (restricted)</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">Delete: pFile<br></span><span style="font: 10pt serif">"...deletes from the Juniper file system the file whose file name is specified by pFile (a JuniperFileController)."</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">| tRequest</span><span style="font: bold 10pt serif"><br></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tRequest &larr; self newRequestParameterBlock.  "1"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tRequest nextDataBlockString &larr; (self checkDirectory: (pFile name)).  "2"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self doAction: sDestroyFile requestPrs: tRequest.  "3"<br>]<br>"<br>1. Create a new request parameter block.<br>2. Get the file name from pFile, add the default directory name to it if necessary, and write it in the request parameter block.<br>3. Issue a &rsquo;destroy file&rsquo; request.<br>"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">entryClass<br></span><span style="font: 10pt serif">"...returns the file class handled by the JuniperInterface."</span><span style="font: bold 10pt serif"><br></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ JuniperFileController<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">Find: pFile<br></span><span style="font: 10pt serif">"...sends a &rsquo;look up file&rsquo; request to the Juniper file server.  If the file is found, its name and long file handle are set in pFile (a JuniperFileController). Otherwise false is returned."</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">| tRequest tResult</span><span style="font: bold 10pt serif"><br></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fSpecialError &larr; sFileNotFound.  "1"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tRequest &larr; self newRequestParameterBlock.  "2"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tRequest nextDataBlockString &larr; (self checkDirectory: (pFile name)).  "3"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tResult &larr; self doAction: sLookupFile requestPrs: tRequest.  "4"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ fSpecialError ≡ true ⇒ [ fSpecialError &larr; nil.  ⇑ false ]  "5"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">fSpecialError &larr; nil.  "6"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pFile<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">longFileHandle: tResult nextDataBlockString;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">name: tResult nextDataBlockString.  "7"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br>]<br>"<br>1. Set the error handling mechanism to ignore a &rsquo;file not found&rsquo; error.<br>2. Create a new request parameter block.<br>3. Get the file name from pFile, add the default directory name to it if necessary, and write it in the request parameter block.<br>4. Issue a &rsquo;look up file&rsquo; request and get the result parameter block.<br>5. If a &rsquo;file not found&rsquo; error was encountered, reset the error handling mechanism and return false.<br>6. (no error encountered) Reset the error handling mechanism.<br>7. Set the long file handle and name (from the result parameter block) in pFile.<br>"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">Insert: pFile<br></span><span style="font: 10pt serif">"...issues a &rsquo;create file&rsquo; request to the Juniper file server and sets the returned long file handle and name in pFile (a JuniperFileController)."</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">| tRequest tResult</span><span style="font: bold 10pt serif"><br></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tRequest &larr; self newRequestParameterBlock.  "1"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tRequest longInteger: 2 &larr; 0 "user rawtotalsecs".  "1.5"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tRequest nextDataBlockString &larr; (self checkDirectory: (pFile name)).  "2"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tRequest nextDataBlockString &larr; &rsquo;&rsquo;.  "3"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tResult &larr; self doAction: sCreateFile requestPrs: tRequest.  "4"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pFile<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">longFileHandle: tResult nextDataBlockString;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">name: tResult nextDataBlockString.  "5"<br>]<br>"<br>1. Create a new request parameter block.<br>1.5 Set creation date (to default (current) -- later some specific date&time?)<br>2. Get the file name from pFile, add the default directory name to it if necessary, and write it in the request parameter block.<br>3. Blank the file server field of the request parameter block.<br>4. Issue a &rsquo;create file&rsquo; request and get the result parameter block.<br>5. Set the long file handle and name (from the result parameter block) in pFile.<br>" </span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">Match: entries to: strm </span><span style="font: 10pt serif">| entry pat ents name i p lastname [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"search for Files matching patterns"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ pat from: entries do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">name &larr; self checkDirectory: pat name.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; name find: &rsquo;*&rsquo;◦1. p &larr; name find: &rsquo;#&rsquo;◦1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; [p=0⇒ [i] i=0⇒ [p] i min: p].<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">i=0⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(self Find: pat)⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"exact name found"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm next &larr; pat]]<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"pattern match over range of first to last possible matches"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pat &larr; self makeEntry: name.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">entry &larr; self makeEntry: (name copy: 1 to: i-1).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">lastname &larr; name copy: 1 to: i.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">lastname◦i &larr; 0377.<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ ((entry &larr; self nextFile: entry) and⦂ entry name &lt; lastname) do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pat match: entry⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm next &larr; entry.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"copy entry since nextFile smashes into it"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">entry &larr; self makeEntry: entry name]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">nextFile: pFile<br></span><span style="font: 10pt serif">"same as LookupFile (Find:), but it pertains to the file whose name is lexically next after the fileName specified in the request.  If the file is found, its name and long file handle are set in pFile (a JuniperFileController). Otherwise (no next file) false is returned."</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">| tRequest tResult</span><span style="font: bold 10pt serif"><br></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fSpecialError &larr; sFileNotFound.  "1"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tRequest &larr; self newRequestParameterBlock.  "2"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tRequest nextDataBlockString &larr; (self checkDirectory: (pFile name)).  "3"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tResult &larr; self doAction: sNextFile requestPrs: tRequest.  "4"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ fSpecialError ≡ true ⇒ [ fSpecialError &larr; nil.  ⇑ false ]  "5"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">fSpecialError &larr; nil.  "6"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pFile<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">longFileHandle: tResult nextDataBlockString;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">name: tResult nextDataBlockString.  "7"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑pFile<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">Rename: oldFile from: newFile<br></span><span style="font: 10pt serif">"renames a file on Juniper"</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">| tRequest newName</span><span style="font: bold 10pt serif"><br></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tRequest &larr; self newRequestParameterBlock.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tRequest nextDataBlockString &larr; oldFile name.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tRequest nextDataBlockString &larr; (newName &larr; self checkDirectory: newFile name).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self doAction: sRenameFile requestPrs: tRequest.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">oldFile name: newName.<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">server </span><span style="font: 10pt serif">["should be an instance variable?" ⇑&rsquo;Juniper&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>JUNIPER COMMAND INTERFACE (restricted)</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">checkResult: pResult<br></span><span style="font: 10pt serif">"...is sent by doAction and doLogin to check the result of a Juniper request.  pResult is a result parameter block (JuniperResultParameterBlock) containing the packet (Pacbuf) returned as a result of the request."</span><span style="font: bold 10pt serif"><br></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ ((pResult packet) ≡ false or⦂ pResult pupType = 4) or⦂ (pResult resultCode = sCommandNak and⦂ (pResult parameter: 1) = sTransactionAborting) ⇒  "3"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ [ fExceptionHandler ≡ nil ⇒ [ ]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">fExceptionHandler trap.  "4"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">  ].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self error: &rsquo;No Juniper Transaction&rsquo;.  "5"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ (pResult resultCode)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">= sCommandAck ⇒ [ ⇑ true ];  "6"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">= sCommandNak ⇒  "7"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ self checkRetry: (pResult parameter: 1) ⇒ [ ⇑ false ]  "8"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ (pResult parameter: 1) = fSpecialError ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ fSpecialError &larr; true.  ⇑ true ]  "9"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self error: (pResult nextDataBlockString).  "10"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ true  "11"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br>]<br>"<br>1. JuniperSocket sendRequest: and sendLogin: return false if no response is received from Juniper.<br>2. Invoke error handling if there is no response from Juniper.<br>3. Juniper returns an error pup (packet pup type  = 4) if the transaction has been aborted.<br>4. If the transaction has been aborted and there is an exception handler, then trap to the handler.<br>5. Invoke error handling if control is returned or if there is no exception handler.<br>6. Return true if a &rsquo;command acknowledged&rsquo; was returned (this means success with no result parameters).<br>7. If a &rsquo;command not acknowledged&rsquo; was returned,  an error condition exists.<br>8. Check for a retryable error and return false if so.<br>9. If the error is the same as that specified in the special error indicator, then indicate it and return true.<br>10. If not, invoke error handling.<br>11. Return true if a &rsquo;command not acknowledged&rsquo; was not returned (this means success with result parameters).<br>"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: justify">
<span style="font: bold 10pt serif">checkRetry: pErrorCode<br></span><span style="font: 10pt serif">"...is sent by checkResult to test for a retryable error.  Returns true if so; false otherwise."</span><span style="font: bold 10pt serif"><br></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ pErrorCode<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">= sSequenceNumberGap ⇒ [ ⇑ true ];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">= sRecoveryUnderWay ⇒ [ ⇑ true ];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">= sTransactionClosing ⇒ [ ⇑ true ];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">= sCongestion ⇒ [ ⇑ true ]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ false<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">doAction: pAction requestPrs: pRequest<br></span><span style="font: 10pt serif">"...corresponds to the Pine Protocol function.  The specified request, pAction, (selected from gJuniperConstants) with its corresponding request parameter block, pRequest (a JuniperRequestParameterBlock), is issued to the Juniper file server (through JuniperSocket sendRequest:). A packet is returned and inserted into a result parameter block and checked for error conditions.  If no errors are found, the result parameter block (a JuniperResultParameterBlock) is returned; otherwise, error handling is invoked.  If no request parameters are required, pRequest can be specified as nil."</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">| tResult</span><span style="font: bold 10pt serif"><br></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ fOpenIndicator ≡ nil ⇒ [ self open. ]  "1"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ pRequest ≡ nil ⇒ [ pRequest &larr; self newRequestParameterBlock. ]  "2"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fTimer disable.  "3"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pRequest opcode &larr; pAction.  "4"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pRequest pupType &larr; sRequest.  "5"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tResult &larr; JuniperResultParameterBlock new.  "6"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tResult packet &larr; (fJuniperSocket sendRequest: (pRequest packet)).  "7"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fTimer reset.  "8"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ self checkResult: tResult ⇒ [ ⇑ tResult ]  "9"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ (self doAction: pAction requestPrs: pRequest)  "10"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br>]<br>"<br>1. Make sure the JuniperInterface is open.<br>2. Create a request parameter block if none was specified.<br>3. Disable the timer to insure that a noop command is not sent while the current request is in progress.<br>4. Set the command code in the packet.<br>5. Set the packet pup type to &rsquo;request&rsquo;.<br>6. Create a result parameter block.<br>7. Send the request to the JuniperSocket with the packet from the request parameter block; set the result packet in the result parameter block.<br>8. Reset the timer.<br>9. Check the result; if valid, return it.<br>10. If false is returned, then a retryable error was encountered so retry the command.<br>" </span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">doLogin: pRequest<br></span><span style="font: 10pt serif">"...is sent by login:password: with pRequest (a JuniperRequestParameter Block) set.  doLogin: issues a login request, checks for errors, and retries if necessary.  If no error occurs, a JuniperResultParameterBlock is returned; otherwise, error handling is invoked."</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">| tResult<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tResult &larr; JuniperResultParameterBlock new.  "1"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tResult packet &larr; (fJuniperSocket sendLogin: (pRequest packet)).  "2"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ self checkResult: tResult ⇒ [ ⇑ tResult ]  "3"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ (self doLogin: pRequest)  "4"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br>]<br>"<br>1. Create a new result parameter block.<br>2. Issue a login request and set the result packet in the result parameter block.<br>3. Check the result and return it if there is no error.<br>4. Retry the request if there is a retryable error.<br>"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">error:  pMessage<br></span><span style="font: 10pt serif">"...is sent by checkResult if an error is encountered on a Juniper request.  (pMessage is a String containing an appropriate error message.)  The error message is formed and a notify window is displayed."</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">| tMessage<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tMessage &larr; Stream default.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tMessage append: pMessage.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">super error: (tMessage contents).<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">newPacket<br></span><span style="font: 10pt serif">"...returns a new packet (Pacbuf) from the JuniperSocket."</span><span style="font: bold 10pt serif"><br></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ fJuniperSocket ≡ nil ⇒ [ self open. ]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ (fJuniperSocket freePacket)<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">newRequestParameterBlock<br></span><span style="font: 10pt serif">"...initializes and returns a new JuniperRequestParameterBlock."</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">| tRequestParameterBlock</span><span style="font: bold 10pt serif"><br></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ fJuniperSocket ≡ nil ⇒ [ self open. ]  "1"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tRequestParameterBlock &larr; JuniperRequestParameterBlock new.  "2"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tRequestParameterBlock<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">packet &larr; (fJuniperSocket freePacket);  "3"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">dataBlockLength &larr; 0;  "4"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">leader: 1 &larr; 0;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">leader: 2 &larr; 0.  "5"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ tRequestParameterBlock  "6"<br>]<br>"<br>1. Open the interface if it is not already.<br>2. Create a new request parameter block.<br>3. Create a new packet and set it in the request parameter block.<br>4. Set the data block length to 0.<br>5. Set the authentication key and reserved word to 0.<br>6. Return the initialized request parameter block.<br>"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>TIMER (internal)</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">noOp</span><span class="tab" val="79"></span><span style="font: bold 10pt serif"><br></span><span style="font: 10pt serif">"...sends a noop command to the Juniper file server.  It&rsquo;s only effect is to reset the timout mechanism of the server."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">| tPacket<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tPacket &larr; fJuniperSocket freePacket.  "1"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tPacket pupType &larr; sNoop.  "2"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tPacket dataString &larr; &rsquo;&rsquo;.  "3"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fJuniperSocket setAddressesAndComplete: tPacket; timerOff.  "4"<br>]<br>"<br>1. Get a new packet (Pacbuf).<br>2. Set packet pup type to &rsquo;noop&rsquo;.<br>3. Set the dataString to the empty string.  This has the necessary effect of setting the packet length to 0.<br>4. Send the packet.  It is necessary to bypass the normal JuniperSocket interface (sendRequest:) because no acknowledgement is returned for the noop.<br>"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">timerOff<br></span><span style="font: 10pt serif">"...disables fTimer and sets it to nil."<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ fTimer ≡ nil ⇒ [ ]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">fTimer disable.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">fTimer &larr; nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">timerOn<br></span><span style="font: 10pt serif">"...assigns fTimer to a new timer object that wakes up every 100 seconds (6000 1/60 seconds) and issues a &rsquo;noop&rsquo; command to Juniper.  This  is used to prevent Juniper from timing out during periods of inactivity."<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self timerOff.  "1"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fTimer &larr; Timer new.  "2"  <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fTimer for: 6000 action⦂ [ self noOp.  user show: &rsquo;.&rsquo;.  fTimer reset. ].  "3"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user cr.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fTimer reset.  "4"<br>]<br>"<br>1. Make sure that the current timer is released.<br>2. Create a new timer.<br>3. Set the timer interval to 100 seconds.  The action of the timer is to send a noop, show a dot in the dispFrame, and reset.<br>4. Activate the timer.<br>" </span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>MISC (internal)</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">checkDirectory: pFileName </span><span style="font: 10pt serif">| ps </span><span style="font: bold 10pt serif"><br></span><span style="font: 10pt serif">"...returns a string that has the default directory name added to the beginning of pFileName (a String) unless pFileName already begins with a directory name in which case it is returned unchanged. max length of ~58"</span><span style="font: bold 10pt serif"><br></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ps &larr; (String new: 60) asStream.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pFileName length &gt; 0 and⦂ (pFileName◦1) = (&rsquo;&lt;&rsquo;◦1)⇒ []<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ps append: &rsquo;&lt;&rsquo;; append: self directory; append: &rsquo;&gt;&rsquo;].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ps append: pFileName.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ps last = (&rsquo;.&rsquo;◦1)⇒ [ps skip: ¬1]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ps contents<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">directory<br></span><span style="font: 10pt serif">"...Returns a string specifying the default file name directory.  The default directory is fDefaultDirectory if it is not nil, otherwise it is self name"</span><span style="font: bold 10pt serif"><br></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ fDefaultDirectory ≡ nil ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ ⇑ self userName<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ fDefaultDirectory<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hash: pString<br></span><span style="font: 10pt serif">"...returns a hash value for pString (a String)."</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">| tHash1 tHash2 i<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tHash1 &larr; 0.  tHash2 &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: 1 to: (pString length) by: 2 do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ tHash1 &larr; tHash1 lxor: (UpperCase◦(pString◦i+1)).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">tHash2 &larr; tHash2 lxor:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ i = (pString length) ⇒ [ 040 ]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">UpperCase◦(pString◦(i+1)+1)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ (tHash1*256 + tHash2)<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">login: pName password: pPassword<br></span><span style="font: 10pt serif">"...sets the necessary request parameters and invokes doLogin to issue a login request.  pName (a String) specifies the name of an account on the Juniper file system.  pPassword (a String) specifies the password of the account."</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">| tRequest</span><span style="font: bold 10pt serif"><br></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tRequest &larr; self newRequestParameterBlock.  "1"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tRequest<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">leader: 3 &larr; sLogin;  "2"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">leader: 4 &larr; 512;  "3"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">leader: 5 &larr; 7;  "4"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">leader: 6 &larr; (self hash: pPassword);  "5"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextDataBlockString &larr; pName;  "6"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pupType &larr; sCustodian.  "7"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ (self doLogin: tRequest)  "8"<br>]<br>"<br>1. Create a new request parameter block.<br>2. Set the command to Login.<br>3. Set the number of bytes per page to 512.<br>4. Set the Juniper version number to 7 (Nov 80).<br>5. Set the hashed account password to pPassword hashed.<br>6. Set the account name to pName.<br>7. Set the packet pup type to custodian.<br>8. Issue the request and return the result.<br>"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">userName<br></span><span style="font: 10pt serif">"...returns the account name or a default (a String)."</span><span style="font: bold 10pt serif"><br></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ fName ≡ nil ⇒ [ ⇑ super userName ]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ fName<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">userPassword<br></span><span style="font: 10pt serif">"...returns the account password or a default (a String)."</span><span style="font: bold 10pt serif"><br></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ fPassword ≡ nil ⇒ [ ⇑ super userPassword ]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ fPassword<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>CLASS INIT</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit<br></span><span style="font: 10pt serif">"...initializes the constants in gJuniperConstants<br>(see [ivy] &lt;Juniper&gt;4.4&gt; CommonPineDefs.mesa).<br>Do the following to initialize:<br>Smalltalk declare: ↪gJuniperConstants as: (SymbolTable new init: 256).<br>JuniperInterface classInit."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">| tIndex tConstant<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ tConstant from: (self juniperConstants) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span class="tab" val="79"></span><span style="font: 10pt serif">[ tConstant is: Integer ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ tIndex &larr; tConstant. ]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">gJuniperConstants declare: tConstant as: tIndex.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">tIndex &larr; tIndex+1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">juniperConstants<br></span><span style="font: 10pt serif">"...returns the set of constants used to specify requests to and to  interpret results from the Juniper file system."<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">↪(<br>0250  "PineMsgType (Pup types)"<br>sRequest sResult sUnsolicited sCustodian sSync sPineAck sNoop<br><br>5  "DataRequest"<br>sReadPage sWritePage sSetLength sReadLength sCloseFile sDestroyAnonymousFile sReadData sWriteData sReadAttribute sWriteAttribute sSetWriteLock sSetReadLock sReleaseReadLock<br><br>32  "TransactionRequest"<br>sChangePassword sRoom sOpenFile sCreateAnonymousFile sFindFile sLockQuery sTransCompletionQuery<br><br>42  "ActivityRequest"<br>sLogout sCloseTransaction sAbortTransaction sLoginRequest<br><br>60  "DirectoryRequest"<br>sLookupFile sCreateFile sDestroyFile sRenameFile sNextFile sNextFewFiles<br><br>1  "ResultCode"<br>sCommandNak sCommandAck sHeresData sHeresEntry sHeresFileList sHeresLFH sHeresFile sHeresLength sLoginResponse sLogoutResponse sTransactionClosed sTransCompletionInfo sResourceData sHeresRoom<br><br>0  "Unsolicited Code"<br>sTransactionAborted sReadLockBroken<br><br>8  "CustodianCode"<br>sLogin sAddServer sResourceLocation<br><br>42  "PineErrorCode"<br><br>"TransTroubleCode"<br>sUnimplementedFeature sIllegalLoginAttempt sSoftwareVersionMismatch sNoSuchUser sPasswordMismatch sBytesPerPageUnacceptable sServerTooBusy sOutOfSpace sNoFilesHere sNoDirectoryHere sIllegalFileName sFileNotFound sFileAlreadyExists sTransactionAborting sNoSuchOpenFile sBigFilesNotImplemented sIllegalAttribute sReadAttributeProtectionError sUserAskedForIt sWriteAttributeProtectionError sPackNotOnDrive sTooManyOpenFiles sProtectionViolation sFileNotOnPack sPackFull sFileRefOutOfBounds sFileSizeExcessive sByteRangeExcessive sPackNotOnMachine sNoSuchTransaction sBrokenLock sInconvenientUnwind<br><br>"Retryable"<br>sSequenceNumberGap sRecoveryUnderWay sTransactionClosing sCongestion<br><br>120 "UserDetected"<br>sBlockTooLarge sNoRouteToServer sServerUnknown sBadBytesPerPage sInvalidRequest sPupGlitch sUnableToDecrypt sNoResponseToRequest sNewServerUnwilling sTransactionInUnknownState sBadTimeForRequests<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">  )<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>TEST / DIAGNOSTIC</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">test<br></span><span style="font: 10pt serif">["<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dpj &larr; nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dpj &larr; JuniperInterface new.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dpj release.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dpj open.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dpj close.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">| f  [ dpj open.  f &larr; dpj file: &rsquo;test.test&rsquo;.<br>until⦂ [ f end ] do⦂ [ user show: (f next) inString. ]. f close. dpj close. ]<br><br>JuniperSocket howMany 2 1 2 2 2  11 Timer howMany  33  NameUser howMany 1 1 1<br>"] </span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪JuniperInterface under: &rsquo;Juniper&rsquo;.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">JuniperInterface classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"JuniperPageBuffer"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;JuniperPageBuffer&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: EtherFilePage<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fLength<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fPageNumber<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fSerialNumber<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>JUNIPER PAGE BUFFER</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>DOCUMENTATION</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">implementationNotes<br></span><span style="font: 10pt serif">[<br>"<br>FIELDS<br></span><span style="font: bold 10pt serif">fLength</span><span style="font: 10pt serif"> : an Integer specifiying the number of bytes in the page buffer.<br></span><span style="font: bold 10pt serif">fPageNumber</span><span style="font: 10pt serif"> : an Integer specifying the number of the page buffer.<br></span><span style="font: bold 10pt serif">fSerialNumber</span><span style="font: 10pt serif"> : an Integer specifying the serial number of the page buffer. <br>"]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>FILE PAGE OPERATIONS</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">length<br></span><span style="font: 10pt serif">"...returns the number of bytes in the page buffer."<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ fLength<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">length: pLength<br></span><span style="font: 10pt serif">"...sets the number of bytes in the page buffer."<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fLength &larr; pLength.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">super length: pLength.<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pageNumber<br></span><span style="font: 10pt serif">"...returns the page number of the page buffer."<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ fPageNumber<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pageNumber: pPageNumber<br></span><span style="font: 10pt serif">"...sets the page number of the page buffer."<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fPageNumber &larr; pPageNumber.<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">serialNumber<br></span><span style="font: 10pt serif">"...returns the serial number of the page buffer."<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ fSerialNumber<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">serialNumber: pSerialNumber<br></span><span style="font: 10pt serif">"...sets the serial number of the page buffer."<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fSerialNumber &larr; pSerialNumber.<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪JuniperPageBuffer under: &rsquo;Juniper&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"JuniperParameterBlock"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;JuniperParameterBlock&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fPacket<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fDataBlockPosition<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>JUNIPER PARAMETER BLOCK</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>DOCUMENTATION</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">implementationNotes<br></span><span style="font: 10pt serif">[<br>"<br>FIELDS<br></span><span style="font: bold 10pt serif">fPacket</span><span style="font: 10pt serif"> : a Pacbuf for sending request commands and parameters to the Juniper file server.<br></span><span style="font: bold 10pt serif">fDataBlockPosition</span><span style="font: 10pt serif"> : an Integer specifying the current position in the data block of fPacket.<br>"<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>OPERATIONS</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dataBlockAdvance: pIncrement<br></span><span style="font: 10pt serif">"...advances the data block position by pIncrement (an Integer)."<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fDataBlockPosition &larr; fDataBlockPosition + pIncrement.<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dataBlockGet<br></span><span style="font: 10pt serif">"...returns the current data block as a Stream."<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ ( (Stream new)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">of: (fPacket pupString)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">from: fDataBlockPosition<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">to: ( 4 + (fPacket pupLength) - 2 )<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">)<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dataBlockLength<br></span><span style="font: 10pt serif">"...returns the number of bytes (an Integer) in the data block."<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ ((fPacket pupLength) - 42)<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dataBlockLength &larr; pLength<br></span><span style="font: 10pt serif">"...sets the number of bytes in the data block to pLength (an Integer)."<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fPacket pupLength &larr; pLength + 42.<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">leader: pIndex<br></span><span style="font: 10pt serif">"...returns the leader word (an Integer) specified by pIndex (an Integer) from the packet."<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ (fPacket word: (12 + pIndex))<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">leader: pIndex &larr; pValue<br></span><span style="font: 10pt serif">"...sets pValue (an Integer) in the packet at the leader word specified by pIndex (an Integer)."<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fPacket word: (12 + pIndex) &larr; pValue.<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">packet<br></span><span style="font: 10pt serif">"...returns the packet (a Pacbuf)."<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ fPacket<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">packet &larr; pPacket<br></span><span style="font: 10pt serif">"...sets the packet to pPacket (a Pacbuf) and resets the data block position."<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fPacket &larr; pPacket.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fDataBlockPosition &larr; 45.<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pupType<br></span><span style="font: 10pt serif">"...returns the pup type (an Integer) of the packet."<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ (fPacket pupType)<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pupType &larr; pPupType<br></span><span style="font: 10pt serif">"...sets the pup type of the packet to pPupType (an Integer)."<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fPacket pupType &larr; pPupType.<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪JuniperParameterBlock under: &rsquo;Juniper&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"JuniperRequestParameterBlock"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;JuniperRequestParameterBlock&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: JuniperParameterBlock<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>JUNIPER REQUEST PARAMETER BLOCK</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>OPERATIONS</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">longInteger: pPosition &larr; pValue<br></span><span style="font: 10pt serif">"...sets pValue (4 bytes of long integer) in the packet at the parameter position specified by pPosition (an Integer)."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">| tString tPosition<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tString &larr; fPacket pupString.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tPosition &larr; (pPosition + 16)*2 - 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">( (Stream new) of: tString from: tPosition to: (tPosition+3)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">) nextNumber: 4 &larr; pValue.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tString<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">swap: tPosition with: tPosition+2;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">swap: tPosition+1 with: tPosition+3.<br>]<br>"<br>1. the two words of a Juniper long integers are stored in reverse order from those in Smalltalk.<br>"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">nextDataBlockString &larr; pString<br></span><span style="font: 10pt serif">"...sets pString (a String) in the data block at the current position and advances the position."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">| tDataBlock tString tLength tMaxLength<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fPacket pupLength &larr; 554.  "1"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tDataBlock &larr; self dataBlockGet.  "2"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tLength &larr; pString length.  "3"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tMaxLength &larr; (tLength+1) land: 0177776.  "4"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tDataBlock<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextword &larr; tLength;  "5"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextword &larr; tMaxLength;  "6"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">append: pString;  "7"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">next: (tMaxLength - tLength) &larr; 0.  "8"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self dataBlockAdvance: (4 + tMaxLength).  "9"<br>]<br>"<br>1. Set the length of the packet to the maximum size.  The length of each string in the data block is specified in the data block itself.<br>2. Get the data block (as a Stream) from the current position to the end.<br>3. Get the length of pString.<br>4. Determine the length of pString including padding needed to make its length even.<br>5. Set the length of pString in the data block (2 bytes).<br>6. Set the length of pString with padding in the data block (2 bytes).<br>7. Set pString in the data block.<br>8. Add padding in the data block.<br>9. Advance the current data block position past length, maximum length, and pString.<br>"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">opcode &larr; pOpcode<br></span><span style="font: 10pt serif">"...sets the request opcode field in the packet to pOpcode (an Integer)."<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fPacket word: 16 &larr; pOpcode.<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">parameter: pIndex &larr; pValue<br></span><span style="font: 10pt serif">"...sets pValue (an Integer) in the packet at the request parameter field specified by pIndex (an Integer)."<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fPacket word: (16+pIndex) &larr; pValue.<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">shortFileHandle &larr; pShortFileHandle<br></span><span style="font: 10pt serif">"...sets the request short file handle field in the packet to pShortFileHandle (an Integer)."<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fPacket word: 15 &larr; pShortFileHandle.<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪JuniperRequestParameterBlock under: &rsquo;Juniper&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"JuniperResultParameterBlock"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;JuniperResultParameterBlock&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: JuniperParameterBlock<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>JUNIPER RESULT PARAMETER BLOCK</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>OPERATIONS</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">longInteger: pPosition<br></span><span style="font: 10pt serif">"...returns the 4 bytes of long integer in the packet at the parameter position specified by pPosition (an Integer)."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">| tArray tPosition<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tPosition &larr; (pPosition + 15)*2 - 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tArray &larr;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">( (Stream new)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">of: (fPacket pupString) from: tPosition to: (tPosition+3)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">) next: 4.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tArray<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">swap: 1 with: 3;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">swap: 2 with: 4.  "1"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ ((tArray asStream) nextNumber: 4)<br>]<br>"<br>1. Juniper long integers are stored in reverse order from those in Smalltalk.<br>"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">nextDataBlockString<br></span><span style="font: 10pt serif">"...returns the string in the data block at the current position and advances the position."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">| tDataBlock tString tLength tMaxLength<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tDataBlock &larr; self dataBlockGet.  "1"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tLength &larr; tDataBlock nextword.  "2"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tMaxLength &larr; tDataBlock nextword.  "3"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tString &larr; tDataBlock next: tLength.  "4"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self dataBlockAdvance: (4 + tMaxLength).  "5"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ tString  "6"<br>]<br>"<br>1. Get the data block (as a Stream) from the current position to the end.<br>2. Get the length of the next string.<br>3. Get the length of the string including possible padding.<br>4. Get the next string from the data block.<br>5. Position the data block past the length, maximum length, string, and padding.<br>6. Return the string.<br>"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">parameter: pIndex<br></span><span style="font: 10pt serif">"...returns from the packet the result parameter (an Integer) specified by pIndex (an Integer)."<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ (fPacket word: (15+pIndex))<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">resultCode<br></span><span style="font: 10pt serif">"...returns the result code (an Integer) from the result packet."<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ (fPacket word: 15)<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪JuniperResultParameterBlock under: &rsquo;Juniper&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"JuniperSocket"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;JuniperSocket&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: RetransmitSocket<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;seqNum outPac loginPending notWaiting result outAck&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>A Socket for communicating with the Juniper File Server. <br>Derived from the class WSocket, jfs, 2/79.<br>see Classes WoodstockFile, WoodstockFilePage, and WoodstockFileDirectory</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization/Termination</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">net: pNet host: pHost <br></span><span style="font: 10pt serif">"start with the well known Juniper listener, leave filterInput false"</span><span style="font: bold 10pt serif"><br></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">super net: pNet host: pHost soc: 0100 asInt32.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self retransmit: 3 every: 500.  "8 sec"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outAck &larr; self freePacket.  "for the outgoing pineAck"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outAck pupType &larr; 0255.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outAck pupID1 &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outAck dataString &larr; &rsquo;&rsquo;.  "also sets length; need to set addresses later"<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Socket</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sendLogin: outPac <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">Special routine to send login, wait for ack, retransmit.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Need to reset seqNum, and get new Juniper socket number.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Will return the Juniper response packet, or else a false.</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">frnSocNum high: 0 low: 0100.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self setOutAddBlock.  filterInput &larr; false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outPac pupID0 &larr; 0. outPac pupID1 &larr; seqNum &larr; 0.  <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">notWaiting &larr; false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">loginPending &larr; true.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self setAddressesAndComplete: outPac.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ [notWaiting] do⦂ [ ].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"all done"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑result.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sendRequest: outPac <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">General routine to send request packets, wait for ack, retransmit.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Will return the Juniper response packet, or else a false.</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">notWaiting &larr; false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">outPac pupID0 &larr; (seqNum &larr; seqNum + 1).  <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self setAddressesAndComplete: outPac.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ [notWaiting] do⦂ [ ].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"all done"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑result.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">socProcess: Ipac | temp<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">Juniper has responded, we&rsquo;re running at a high level"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">loginPending ⇒ "handle this special case"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">["watch out, src has not been checked"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">((frnNet ≠ Ipac sourceNet) or⦂ (frnHost ≠ Ipac sourceHost)) or⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">((0251 ≠ Ipac pupType) or⦂ (0 ≠ Ipac pupID0)) ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">["discard it"  "Ipac &larr; self freePacket: Ipac"]<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"this must be it!"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">frnSocNum high: Ipac sourceSoc0 low: Ipac sourceSoc1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self setOutAddBlock. self setAddresses: outAck.  "for later use"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"generate an ack" outAck pupID0 &larr; 0.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self completePup: outAck.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">loginPending&larr;false.  notWaiting &larr; filterInput &larr; true.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">result &larr; Ipac.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"src. and dest. should have been checked ??)"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Ipac pupType = 0251⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"might be a retransmission of a previous Juniper response or what we want.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">acknowledge in either case then see whether we want to keep the result"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">outAck pupID0 &larr; Ipac pupID0.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self completePup: outAck.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">notWaiting or⦂ seqNum ≠ Ipac pupID0⇒ ["Ipac &larr; self freePacket: Ipac"]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">notWaiting&larr;true.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">result &larr; Ipac]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"Ipac pupType = 0255 ⇒ [Ipac&larr;self freePacket: Ipac]" "discard pineack"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">notWaiting≡false and⦂ ((Ipac pupType = 4) and⦂ (Ipac word: 23) = 2) ⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"no socket at Juniper"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self timerOff.  notWaiting&larr;true.   result&larr;Ipac. ].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"Ipac &larr; self freePacket: Ipac."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">timerFired  <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">This piece of code only runs when a timer fires!<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Thus, there is mutual exclusion between this and other timer code.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Runs below the ethernet input.   Don&rsquo;t do an active return<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Timer sometimes fires even though its been disabled!</span><span style="font: 10pt serif">"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">notWaiting⇒ [] <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self timerOn⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">go ahead and retransmit.....</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self completePup: outPac<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">notWaiting &larr; true. result &larr; false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪JuniperSocket under: &rsquo;Juniper&rsquo;.</span></div>
    <div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">&rsquo;From Smalltalk 5.5k XM November 24 on 22 November 1980 at 2:57:08 am.&rsquo;<br></span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">"ExceptionHandler"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;ExceptionHandler&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo; <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fDoContext<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fCode<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fTrapCode<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fTrapCondition<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fResult<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fPostTrapIndicator<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fStatusIndicator<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>EXCEPTION HANDLER  J.C. Althoff  7/79</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>DOCUMENTATION</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: justify">
<span style="font: bold 10pt serif">description<br></span><span style="font: 10pt serif">[<br>"</span><span style="font: 10pt monospace"><br>This class provides some exception handling capabilities that can be used in a variety of applications.  It is intended to be used in the following way:<br><br>1. An ExceptionHandler object is created to supervise the execution of a block of statements.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">EH &larr; ExceptionHandler new.</span><span style="font: 10pt monospace"><br>2. Each object that is capable of detecting an exception is informed of the existence of the ExceptionHandler object.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dpj exceptionHandler: EH.</span><span style="font: 10pt monospace"><br>3. The ExceptionHandler object is then sent the message </span><span style="font: 10pt serif">&rsquo;do⦂ pCode onTrapDo⦂ pTrapCode&rsquo;</span><span style="font: 10pt monospace">.  The parameter </span><span style="font: 10pt serif">pCode</span><span style="font: 10pt monospace"> is a block of statements that is to be supervised by the ExceptionHandler object.  The parameter </span><span style="font: 10pt serif">pTrapCode</span><span style="font: 10pt monospace"> is a block of statements that is to be executed whenever an exception is detected.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">EH do⦂ [ ... ] onTrapDo⦂ [ ... ].</span><span style="font: 10pt monospace"><br>4. When an exception is detected during the execution of one of the statements in </span><span style="font: 10pt serif">pCode</span><span style="font: 10pt monospace"> the message </span><span style="font: 10pt serif">&rsquo;trap&rsquo;</span><span style="font: 10pt monospace"> can be sent to the ExceptionHandler object which will then take control.  If information about the exception is available, it can be relayed by sending the message </span><span style="font: 10pt serif">&rsquo;trap:&rsquo;</span><span style="font: 10pt monospace"> with the information specified as the parameter.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">EH trap. </span><span style="font: 10pt monospace"> (or)  </span><span style="font: 10pt serif">EH trap: information.</span><span style="font: 10pt monospace"><br>5. When the ExceptionHandler object gets control it saves the parameter if one was sent, then executes </span><span style="font: 10pt serif">pTrapCode</span><span style="font: 10pt monospace">.  The saved parameter can be retrieved by sending the message </span><span style="font: 10pt serif">&rsquo;trapCondition&rsquo;</span><span style="font: 10pt monospace">.  The statements in </span><span style="font: 10pt serif">pTrapCode</span><span style="font: 10pt monospace"> should take any actions necessary to handle the exception. Messages can be included in </span><span style="font: 10pt serif">pTrapCode</span><span style="font: 10pt monospace"> that tell the ExceptionHandler object what to do when </span><span style="font: 10pt serif">pTrapCode</span><span style="font: 10pt monospace"> completes.  The available messages are:<br></span><span class="tab" val="79"></span><span style="font: 10pt monospace">5.1 </span><span style="font: 10pt serif">&rsquo;restart&rsquo;</span><span style="font: 10pt monospace"> which restarts the execution of </span><span style="font: 10pt serif">pCode</span><span style="font: 10pt monospace">,<br></span><span class="tab" val="79"></span><span style="font: 10pt monospace">5.2 </span><span style="font: 10pt serif">&rsquo;continue&rsquo;</span><span style="font: 10pt monospace"> which continues </span><span style="font: 10pt serif">pCode</span><span style="font: 10pt monospace"> at the point at which </span><span style="font: 10pt serif">&rsquo;trap&rsquo; </span><span style="font: 10pt monospace">was sent,<br></span><span class="tab" val="79"></span><span style="font: 10pt monospace">5.3 </span><span style="font: 10pt serif">&rsquo;abort&rsquo;</span><span style="font: 10pt monospace"> which aborts the execution of </span><span style="font: 10pt serif">pCode</span><span style="font: 10pt monospace"> and returns control to the statement following </span><span style="font: 10pt serif">&rsquo;do⦂ pCode onTrapDo⦂ pTrapCode&rsquo;</span><span style="font: 10pt monospace">.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">EH restart.</span><span style="font: 10pt monospace">  (or)  </span><span style="font: 10pt serif">EH continue.</span><span style="font: 10pt monospace">  (or)  </span><span style="font: 10pt serif">EH abort.</span><span style="font: 10pt monospace"><br>6. The message </span><span style="font: 10pt serif">&rsquo;do⦂onTrapDo⦂&rsquo;</span><span style="font: 10pt monospace"> returns a result which can be specified during the execution of either  </span><span style="font: 10pt serif">pCode</span><span style="font: 10pt monospace"> or </span><span style="font: 10pt serif">pTrapCode</span><span style="font: 10pt monospace"> by the message </span><span style="font: 10pt serif">&rsquo;result &larr; pResult&rsquo;</span><span style="font: 10pt monospace">.  This result value can be retrieved anytime after it has been specified by sending the message </span><span style="font: 10pt serif">&rsquo;result&rsquo;</span><span style="font: 10pt monospace">.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">EH result &larr; true.</span><span style="font: 10pt monospace"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ EH result ⇒ [ ... ] ].</span><span style="font: 10pt monospace"><br>7. If </span><span style="font: 10pt serif">pCode</span><span style="font: 10pt monospace"> is terminated abnormally from a user notify window, the message </span><span style="font: 10pt serif">&rsquo;release&rsquo;</span><span style="font: 10pt monospace"> should be sent to return the ExceptionHandler object to its initial state.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">EH release.</span><span style="font: 10pt monospace"><br>8. Special error checking is included in the ExceptionHandler object to detect calls to </span><span style="font: 10pt serif">pTrapCode</span><span style="font: 10pt monospace"> during the execution of </span><span style="font: 10pt serif">pTrapCode</span><span style="font: 10pt monospace"> and other invalid conditions.</span><span style="font: 10pt serif"><br>"<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">implementationNotes<br></span><span style="font: 10pt serif">[<br>"<br>FIELDS<br></span><span style="font: bold 10pt serif">fDoContext</span><span style="font: 10pt serif"> : a Context that controls the execution of the message &rsquo;do⦂onTrapDo⦂&rsquo;.<br></span><span style="font: bold 10pt serif">fCode</span><span style="font: 10pt serif"> : a Context that controls the execution of the statements passed as the first parameter to &rsquo;do⦂onTrapDo⦂&rsquo;.<br></span><span style="font: bold 10pt serif">fTrapCode</span><span style="font: 10pt serif"> : a Context that controls the execution of the statements passed as the second parameter to &rsquo;do⦂onTrapDo⦂&rsquo;.<br></span><span style="font: bold 10pt serif">fTrapCondition</span><span style="font: 10pt serif"> : the object passed as the parameter to &rsquo;trap:&rsquo;.<br></span><span style="font: bold 10pt serif">fResult</span><span style="font: 10pt serif"> : the object that is the result of &rsquo;do⦂onTrapDo⦂&rsquo;.<br></span><span style="font: bold 10pt serif">fPostTrapIndicator</span><span style="font: 10pt serif"> : an Integer specifying the action to be taken after fTrapCode is executed.<br></span><span style="font: bold 10pt serif">fStatusIndicator</span><span style="font: 10pt serif"> : an Integer specifying the status of &rsquo;do⦂onTrapDo⦂&rsquo;; nil means &rsquo;do⦂onTrapDo⦂&rsquo; has not been invoked, 1 means fCode is active, 0 means fTrapCode is active.<br>"<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>CONTROL STRUCTURE</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">do⦂ pCode onTrapDo⦂ pTrapCode<br></span><span style="font: 10pt serif">"...executes the set of statements in the block pCode and, conditionally, the set of statements in the block pTrapCode.  If &rsquo;trap&rsquo; or &rsquo;trap:&rsquo; is invoked during the execution of pCode, the execution is interrupted and pTrapCode is started.  When pTrapCode completes, pCode is either continued, restarted, or aborted, depending on which of &rsquo;continue&rsquo;, &rsquo;restart&rsquo;, and &rsquo;abort&rsquo; is sent during the execution of pTrapCode.  A notify window is created if &rsquo;trap&rsquo; or &rsquo;trap:&rsquo; is sent when pCode is not active, or if &rsquo;do⦂onTrapDo⦂&rsquo; is sent again before the first invocation completes."<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ fStatusIndicator ≠ nil ⇒ [ user notify: &rsquo;ExceptionHandler is active&rsquo;. ]  "1"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fStatusIndicator &larr; 1.  "2"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fCode &larr; pCode.  "3"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fTrapCode &larr; pTrapCode.  "4"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fDoContext &larr; thisContext.  "5"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fTrapCondition &larr; nil.  "6"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fResult &larr; true.  "7"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fCode eval.  "8"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self release.  "9"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ fResult  "10"<br>]<br>"<br>1. If fStatusIndicator ≠ nil, then the previous invocation of &rsquo;do⦂onTrapDo⦂&rsquo; has not completed properly.  Create a notify window in this case.<br>2. Set fStatusIndicator to indicate pCode is active.<br>3. Save pCode for execution and restart.<br>4. Save pTrapCode for later execution.<br>5. Save the context of &rsquo;do⦂onTrapDo⦂&rsquo; for &rsquo;restart&rsquo; and &rsquo;abort&rsquo;.<br>6. Initialize the trap condition to nil.<br>7. Initialize the result of &rsquo;do⦂onTrapDo⦂ &rsquo; to true.<br>8. Execute pCode.<br>9. Set fields to nil to release saved contexts.<br>10. Return fResult (which may have been modified during the execution of pCode or pTrapCode).<br>"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>TRAP HANDLER</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">trap<br></span><span style="font: 10pt serif">"...interrupts the execution of pCode and begins pTrapCode (from &rsquo;do⦂ pCode onTrapDo⦂ pTrapCode&rsquo;)."<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self trap: nil.<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">trap: pTrapCondition<br></span><span style="font: 10pt serif">"...interrupts the execution of pCode and begins pTrapCode (from &rsquo;do⦂ pCode onTrapDo⦂ pTrapCode&rsquo;).  The trap condition is set to pTrapCondition."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">|tTrapCode i<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ fStatusIndicator<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">≡ nil ⇒ [ user notify: &rsquo;ExceptionHandler is not active&rsquo; ];  "1"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">= 0  ⇒ [ user notify: &rsquo;ExceptionHandler trap code is already active&rsquo; ]  "2"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fStatusIndicator &larr; 0.  "3"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fTrapCondition &larr; pTrapCondition.  "4"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fPostTrapIndicator &larr; 0.  "5"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tTrapCode &larr; fTrapCode cleancopy.  "6"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tTrapCode eval.  "7"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: tTrapCode totalPT do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ fTrapCode setPT: i to: (tTrapCode getPT: i). ].  "8"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fStatusIndicator &larr; 1.  "9"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ fPostTrapIndicator  "10"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">= 0 ⇒ [ self restartCode. ];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">= 1 ⇒ [ self abortCode. ];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">= 2 ⇒ [ ]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br>]<br>"<br>1. If fStatusIndicator ≡ nil, then &rsquo;do⦂onTrapDo⦂&rsquo; has not been invoked and there is no trap code to execute.<br>2. if fStatusIndicator = 0, then fTrapCode is active.  This is an invalid state.<br>3. Set fStatusIndicator to indicate fTrapCode is active.<br>4. Set the trap condition to pTrapCondition.<br>5. Set the default post trap action to &rsquo;restart&rsquo;.<br>6. Make a new copy of the context, fTrapCode.<br>7. Execute the new copy of fTrapCode.<br>8. Set the parameters and temporaries in the context, fTrapCode to those of the executed copy.  This is done so that fCode will see any changes made to these variables by fTrapCode.<br>9. Set fStatusIndicator to indicate fTrapCode is not active.<br>10. Select the terminating action from the value of fPostTrapIndicator.<br>"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>POST TRAP SPECIFICATION</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">abort<br></span><span style="font: 10pt serif">"...specifies that the code interrupted by &rsquo;trap&rsquo; or &rsquo;trap:&rsquo; will be aborted when the trap code completes.  Control will return to the statement that follows the invocation of &rsquo;do⦂onTrapDo⦂&rsquo;."<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fPostTrapIndicator &larr; 1.<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">continue<br></span><span style="font: 10pt serif">"...specifies that the code interrupted by &rsquo;trap&rsquo; or &rsquo;trap:&rsquo; will be continued when the trap code completes."<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fPostTrapIndicator &larr; 2.<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">restart<br></span><span style="font: 10pt serif">"...specifies that the code interrupted by &rsquo;trap&rsquo; or &rsquo;trap:&rsquo; will be restarted when the trap code completes."<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fPostTrapIndicator &larr; 0.<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>MISC</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">result<br></span><span style="font: 10pt serif">"...returns the result set by &rsquo;result&larr;&rsquo;."<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ fResult<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">result &larr; pResult<br></span><span style="font: 10pt serif">"...sets the result value of &rsquo;do⦂onTrapDo⦂&rsquo; to pResult."<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fResult &larr; pResult.<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">trapCondition<br></span><span style="font: 10pt serif">"...returns the condition that was passed as the parameter to &rsquo;trap:&rsquo;."<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ fTrapCondition<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>POST TRAP ACTION (internal)</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">abortCode<br></span><span style="font: 10pt serif">"...releases the context chain and returns fResult to the caller of &rsquo;do⦂onTrapDo⦂&rsquo;."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">|tDoContextCaller<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tDoContextCaller &larr; fDoContext caller.  "1"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">thisContext caller releaseTo: tDoContextCaller.  "2"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self release.  "3"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tDoContextCaller push: fResult.  "4"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Top run: tDoContextCaller at: Top currentPriority.  "5"<br>]<br>"<br>1. Get the caller of &rsquo;do⦂onTrapDo⦂&rsquo;.<br>2. Release the context chain from the caller of thisContext up to the caller of &rsquo;do⦂onTrapDo⦂&rsquo;.<br>3. Set fields to nil to clean up pointers to unwanted contexts.<br>4. Return fResult to the caller of &rsquo;do⦂onTrapDo⦂&rsquo;.<br>5. Run the caller of &rsquo;do⦂onTrapDo⦂&rsquo;.<br>"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">release<br></span><span style="font: 10pt serif">"...resets the exception handler to its initial condition."<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fCode &larr; nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fTrapCode &larr; nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fDoContext &larr; nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fStatusIndicator &larr; nil.<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">restartCode<br></span><span style="font: 10pt serif">"...releases the context chain and restarts the block of statements passed as the first parameter to &rsquo;do⦂onTrapDo⦂&rsquo;."<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">thisContext caller releaseTo: fCode.  "1"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fCode restart.  "2"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fCode push: fDoContext.  "3"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Top run: fCode at: Top currentPriority.  "4"<br>]<br>"<br>1. Release the context chain from the caller of thisContext up to fCode.<br>2. Resets the pc and stack pointer of fCode.<br>3. Push the return context of fCode onto its tempframe.<br>4. Run fCode.<br>"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>TEST AND DIAGNOSTIC</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">test  </span><span style="font: 10pt serif">"ExceptionHandler new test."</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">| guard i<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">guard &larr; ExceptionHandler new.  user clear.  i &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">guard do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ user show: i asString.  i &larr; i+1.  guard trap: i.  user show: &rsquo; end&rsquo;. ]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">onTrapDo⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ i &lt; 10 ⇒ [ guard restart ]  guard continue ].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user show: &rsquo; done.&rsquo;.  user cr.  ⇑ guard result<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">testTransaction  </span><span style="font: 10pt serif">"ExceptionHandler new testTransaction."</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">| e i max f<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">e &larr; ExceptionHandler new.  i &larr; 0.  max &larr; 5.  dpj exceptionHandler: e.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dpj open.  f &larr; dpj file: &rsquo;test.test&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">e do⦂ [f reset. until⦂ [ f end ] do⦂ [ user show: (f next) inString. ]. ]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">onTrapDo⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ user cr;  show: &rsquo;Juniper not responding&rsquo;.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">f release.  dpj release.  i &larr; i+1.  [ i &lt; max ⇒ [ e restart. ] e abort ]. ].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user cr;  show: &rsquo;done&rsquo;.  f close.  dpj close.<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>EXAMPLES</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">juniperTest  </span><span style="font: 10pt serif">"ExceptionHandler new juniperTest."</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">| e i max f<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">e &larr; ExceptionHandler new.  i &larr; 0.  max &larr; 5.  dpj exceptionHandler: e.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dpj open.  f &larr; dpj file: &rsquo;test.test&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">e do⦂ [f reset. until⦂ [ f end ] do⦂ [ user show: (f next) inString. ]. ]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">onTrapDo⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ user cr;  show: &rsquo;Juniper not responding&rsquo;.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">f release.  dpj release.  i &larr; i+1.  [ i &lt; max ⇒ [ e restart. ] e abort ]. ].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user cr;  show: &rsquo;done&rsquo;.  f close.  dpj close.<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">loopTest  </span><span style="font: 10pt serif">"ExceptionHandler new loopTest."</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">| guard i<br>[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">guard &larr; ExceptionHandler new.  user clear.  i &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">guard do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ user show: i asString.  i &larr; i+1.  guard trap: i.  user show: &rsquo; end&rsquo;. ]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">onTrapDo⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ i &lt; 10 ⇒ [ guard restart ]  guard continue ].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user show: &rsquo; done.&rsquo;.  user cr.  ⇑ guard result<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪ExceptionHandler under: &rsquo;ExceptionHandling&rsquo;.</span></div>

  </body>
</html>
