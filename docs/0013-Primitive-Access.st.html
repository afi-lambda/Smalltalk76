<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN">
<html>
  <head>
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
    <title>Smalltalk76/Primitive-Access.st</title>
  </head>
  <body>
    <div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">&rsquo;From Smalltalk 5.5k XM November 24 on 5 February 2037 at 11:10:42 pm.&rsquo;<br></span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">"BitBlt"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;BitBlt&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;function color destbase destraster destx desty<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">width height sourcebase sourceraster sourcex sourcey<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sstrike dstrike &rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;pageOneCursor &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>BitBlt copies bits from one rectangle to another in core.  x, y, width and height are in bits, raster is in words, and base is a core address.  Mode is storing, oring, xoring or erasing.  If source or destination is a Smalltalk object, then you have to lock it, as in copyToString, below.  The primitive does no bounds checking, so watch out.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Access to Parts</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">color  </span><span style="font: 10pt serif">[⇑color]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">color &larr; color</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">destbase  </span><span style="font: 10pt serif">[⇑destbase]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">destbase &larr; destbase</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">destraster  </span><span style="font: 10pt serif">[⇑destraster]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">destraster &larr; destraster</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">destx  </span><span style="font: 10pt serif">[⇑destx]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">destx &larr; destx</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">desty  </span><span style="font: 10pt serif">[⇑desty]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">desty &larr; desty</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dest &larr; pt </span><span style="font: 10pt serif">[destx&larr; pt x.  desty &larr; pt y]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dstrike </span><span style="font: 10pt serif">[⇑dstrike]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dstrike &larr; dstrike<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">extent &larr; pt </span><span style="font: 10pt serif">[width &larr; pt x.  height &larr; pt y]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">function  </span><span style="font: 10pt serif">[⇑function]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">function &larr; function</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">height  </span><span style="font: 10pt serif">[⇑height]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">height &larr; height</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sourcebase  </span><span style="font: 10pt serif">[⇑sourcebase]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sourcebase &larr; sourcebase</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sourceraster  </span><span style="font: 10pt serif">[⇑sourceraster]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sourceraster &larr; sourceraster</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sourcex  </span><span style="font: 10pt serif">[⇑sourcex]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sourcex &larr; sourcex</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sourcey  </span><span style="font: 10pt serif">[⇑sourcey]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sourcey &larr; sourcey</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">source &larr; pt </span><span style="font: 10pt serif">[sourcex&larr; pt x.  sourcey &larr; pt y]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sstrike </span><span style="font: 10pt serif">[⇑sstrike]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sstrike &larr; sstrike<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">width  </span><span style="font: 10pt serif">[⇑width]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">width &larr; width</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Setup</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pageOneCursor &larr; 0431. "location of hardware cursor"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">forCursor<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[function&larr; color&larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">destbase&larr; sourcebase&larr; 0431.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">width&larr; height&larr; 16. destraster&larr; sourceraster&larr; 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">destx&larr; desty&larr; sourcex&larr; sourcey&larr; 0. sstrike &larr; dstrike &larr; false<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[function &larr; color &larr; destbase &larr; destraster &larr; destx &larr; desty &larr; width &larr;<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">height &larr; sourcebase &larr; sourceraster &larr; sourcex &larr; sourcey &larr; 0. sstrike &larr; dstrike &larr; false<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Operations</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">callBLT<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user croak]  primitive: 33</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">checksandcall </span><span style="font: 10pt serif">| destlocked sourcelocked</span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"checks if either base a string and/or strike and locks accordingly"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">function &larr; function land: 017.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"set up function to add XM stuff"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[destbase class ≡ String ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[destbase◦1 &larr; destbase◦1.  "set the dirty bit"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">destlocked &larr; destbase.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">destbase &larr; ([dstrike ⇒ [((destlocked lock) + 9)]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">destlocked lock</span><span class="tab" val="79"></span><span style="font: 10pt serif"> </span><span style="font: italic 10pt serif">"strike header"</span><span style="font: 10pt serif">])<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[destbase ≠ pageOneCursor ⇒<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[function &larr; function + 020. </span><span style="font: italic 10pt serif">"dest not string, then must be in display"</span><span style="font: 10pt serif">]</span><span style="font: italic 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"unless doing cursor work in page one location"</span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[sourcebase class ≡ String ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[sourcelocked &larr; sourcebase.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">sourcebase &larr; ([sstrike ⇒ [((sourcelocked lock) + 9)]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">sourcelocked lock</span><span class="tab" val="79"></span><span style="font: 10pt serif"> </span><span style="font: italic 10pt serif">"strike header"</span><span style="font: 10pt serif">])<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[sourcebase ≠ pageOneCursor ⇒<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[function &larr; function + 040. </span><span style="font: italic 10pt serif">"source not string, then must be in display"</span><span style="font: 10pt serif">]</span><span style="font: italic 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"unless doing cursor work in page one location"</span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self callBLT.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[destlocked ≡ nil ⇒ [] destbase &larr; destlocked unlock].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[sourcelocked ≡ nil ⇒ [] sourcebase &larr; sourcelocked unlock].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">copy: mode <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[function &larr; mode land: 3. self checksandcall]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">copycomp: mode <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[function &larr; 4 + (mode land: 3). self checksandcall]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fill: mode color: color <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[function &larr; 12 + (mode land: 3). self checksandcall]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">paint: mode <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[function &larr; 8 + (mode land: 3). self checksandcall]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">stringCopy: deststring from: start to: stop with: replacement from: rstart to: rstop<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["copies equal subranges from one string to another.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">works for BitBlt parameters up to 4096. maybe too much set up for short strings.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">currently, called by </span><span style="font: bold 10pt serif">String copy:to:with:from:to:</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">width &larr; 1+stop-start.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">width = 0⇒ [⇑deststring]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(start &gt; 4096 or⦂ rstart &gt; 4096) or⦂ width ≥ 4096⇒ [⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(width &lt; 0 or⦂ width ≠ (1+rstop-rstart)) or⦂ (<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(start &lt; 1 or⦂ stop &gt; deststring length) or⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(rstart &lt; 1 or⦂ rstop &gt; replacement length))⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: &rsquo;illegal range or subscript&rsquo;]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"self init."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">function &larr; color &larr; destraster &larr; desty &larr; sourceraster &larr; sourcey &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sstrike &larr; dstrike &larr; false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">height &larr; 1.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">width &larr; width*8.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">destbase &larr; deststring lock. <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">destx &larr; (start - 1) * 8.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sourcebase &larr; replacement lock.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sourcex &larr; (rstart - 1) * 8.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self callBLT.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">replacement unlock.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"mark dirty"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">deststring◦1 &larr; deststring◦1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">deststring unlock.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑deststring<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">stringReplace: deststring with: sourcestring from: start to: stop and: replacement from: rstart to: rstop </span><span style="font: 10pt serif">| slock [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"works for BitBlt parameters less than 4096. replaces a subrange of a string.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">called only by </span><span style="font: bold 10pt serif">String replace:to:by:from:to:</span><span style="font: 10pt serif">.  concatenates into deststring:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">sourcestring◦(1 to: start-1)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">replacement◦(rstart to: rstop)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">sourcestring◦(stop+1 to: sourcestring length).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">assumes String arguments"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">deststring length = 0⇒ [⇑deststring]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(replacement is: String)≡false⇒[⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(stop ≥ 4096 or⦂ sourcestring length - stop ≥ 4096) or⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(start+rstop-rstart ≥ 4096 or⦂ rstart &gt; 4096)⇒ [⇑false]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(start &lt; 1 or⦂ stop &gt; sourcestring length) or⦂<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(rstart &lt; 1 or⦂ rstop &gt; replacement length)⇒ [user notify: &rsquo;illegal subscript&rsquo;]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"self init."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">function &larr; color &larr; destraster &larr; desty &larr; sourceraster &larr; sourcey &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sstrike &larr; dstrike &larr; false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">height &larr; 1.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">destbase &larr; deststring lock. <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sourcebase &larr; slock &larr; sourcestring lock.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">width &larr; (start - 1) * 8.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[width = 0⇒ []<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sourcex &larr; destx &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self callBLT].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">destx &larr; width.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">width &larr; (1+rstop-rstart)*8.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[width = 0⇒ []<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sourcex &larr; (rstart - 1) * 8.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sourcebase &larr; replacement lock.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self callBLT.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">replacement unlock].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">destx &larr; destx+ width.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">width &larr; (sourcestring length - stop) * 8.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[width = 0⇒ []<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sourcebase &larr; slock.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sourcex &larr; stop * 8.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self callBLT].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">deststring◦1 &larr; deststring◦1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sourcestring unlock. deststring unlock.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑deststring<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪BitBlt under: &rsquo;Primitive Access&rsquo;.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">BitBlt classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"CoreLocs"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;CoreLocs&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Array<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;base length&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>I am an array mapping a section of Alto memory</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">base: base length: length</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Reading and Writing</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">◦ x </span><span style="font: 10pt serif">[x isLarge⇒[⇑self◦(x asSmall)] user croak] primitive: 42</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">◦ x &larr; val </span><span style="font: 10pt serif">[x isLarge⇒[⇑self◦(x asSmall) &larr; val] user croak] primitive: 43</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">base </span><span style="font: 10pt serif">[⇑base]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">length </span><span style="font: 10pt serif">[⇑length]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪CoreLocs under: &rsquo;Primitive Access&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"VirtualMemory"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;VirtualMemory&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;map "Pclass Map"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">premap "block before map"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">FirstContextOop "oop of FirstContext"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">SpecialOopsOop "oop of SpecialOops"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">zip  "Zone Index of Pages"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">prezip  "block before zip"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">zadd   "file info"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">vmemfile "file for vmem" &rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;ZHB RCI PIN zfused zfree zjmpt pmint num00 pmend ZN zflen pmatm zlong PCL ZVPN CPT BSC ISC ZJMP zend &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>A model of the OOZE virtual memory</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Pclass Map</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">CPT: oop </span><span style="font: 10pt serif">| poma<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[poma &larr; 2*(oop field: PCL) +1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑map◦poma field: CPT]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">freelist: object  </span><span style="font: 10pt serif">| a<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"one-order index into freelists."</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">object class is: Class ⇒[⇑1]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">a &larr; self ISC: object asOop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">a &lt; 024 ⇒[⇑1+a] ⇑1+ a-013]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">freelistOffset: len </span><span style="font: italic 10pt serif">"offset of freelist for this length in a variable length class"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑Class instsize + [len &lt; 9 ⇒[len] (len-1) log2 + 6]]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">highpm0: oop gets: val </span><span style="font: 10pt serif">| poma<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[premap◦pmatm &larr; premap◦pmatm min: (oop field: PIN &larr; 0).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">poma &larr; 2*(oop field: PCL) +1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">map◦poma &larr; val]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">highPM: oop </span><span style="font: 10pt serif">| pcl a<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pcl &larr; oop field: PCL.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">a &larr; premap◦pmatm field: PCL.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pcl &lt; a ⇒[⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑map◦(2*pcl +1)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">ISC: oop </span><span style="font: 10pt serif">| poma<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[poma &larr; 2*(oop field: PCL) +1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑map◦poma field: ISC]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">lowPM: oop </span><span style="font: 10pt serif">| pcl a<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pcl &larr; oop field: PCL.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">a &larr; premap◦pmend field: PCL.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pcl ≥ a ⇒[⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑map◦(2*pcl +1)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">newHighPM&larr; pm0 </span><span style="font: 10pt serif">| pcl a<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[a &larr; premap◦pmatm.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">premap◦pmatm &larr; (a &larr; a-0200).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pcl &larr; a field: PCL.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">map◦(2*pcl +1) &larr; pm0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑a]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">newLowPM&larr; pm0 </span><span style="font: 10pt serif">| poma a<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[map◦1 = pm0 ⇒[</span><span style="font: italic 10pt serif">"reserved pclasses for Class"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">map◦3 = 0 ⇒[map◦3 &larr; pm0. ⇑0200]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">map◦5 = 0 ⇒[map◦5 &larr; pm0. ⇑0400] ]<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"normal case"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">a &larr; premap◦pmend.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">premap◦pmend &larr; a+0200.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">poma &larr; (a field: PCL) *2 +1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">map◦poma ≠ 0 ⇒[</span><span style="font: italic 10pt serif">"skip over already filled"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self newLowPM&larr; pm0]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">map◦poma &larr; pm0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑a]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">newZN: oop <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self ZN: oop gets: self newZone]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pclassesOf: cls </span><span style="font: 10pt serif">| i clsoop n z p </span><span style="font: italic 10pt serif">"find pclasses of this class (in order of ZHB)"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"ignore small integers and nil"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">p &larr; (Vector new: 1) asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">z &larr; (Vector new: 1) asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">clsoop &larr; cls asOop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: (1 to: 2*(0174000 field: PCL) by: 2) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[map◦i = 0 ⇒[]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(map◦i field: RCI) = clsoop ⇒[p next&larr; i/2. z next&larr; (map◦(i+1) field: ZHB)]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">p &larr; p contents. z &larr; z contents.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">n &larr; p copy.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: z length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[n◦(z◦i +1) &larr; p◦i].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑n]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pclassesOf: cls length: len </span><span style="font: 10pt serif">| i clsoop n z p isc pm0 </span><span style="font: italic 10pt serif">"find pclasses of this class and length (in order of ZHB)"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"ignore small integers and nil"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">p &larr; (Vector new: 1) asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">z &larr; (Vector new: 1) asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">isc &larr; [len &lt; 9 ⇒[len] (len-1) log2 + 17].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">clsoop &larr; cls asOop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: (1 to: 2*(0174000 field: PCL) by: 2) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(pm0 &larr; map◦i) = 0 ⇒[]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(pm0 field: RCI) ≠ clsoop ⇒[]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(pm0 field: ISC) = isc ⇒[p next&larr; i/2. z next&larr; (map◦(i+1) field: ZHB)]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">p &larr; p contents. z &larr; z contents.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">n &larr; p copy.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: z length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[n◦(z◦i +1) &larr; p◦i].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑n]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pmatm </span><span style="font: 10pt serif">[⇑premap◦pmatm]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">ZHB: oop </span><span style="font: 10pt serif">| poma<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[poma &larr; 2*(oop field: PCL) +1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑map◦(1+poma) field: ZHB]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">ZHB: oop gets: val </span><span style="font: 10pt serif">| poma i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[poma &larr; 2*(oop field: PCL) +1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; map◦(1+poma).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">map◦(1+poma) &larr; (i field: ZHB &larr; val)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">ZN: oop </span><span style="font: 10pt serif">| poma<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[poma &larr; 2*(oop field: PCL) +1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑map◦(1+poma) field: ZN]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">ZN: oop gets: val </span><span style="font: 10pt serif">| poma i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[poma &larr; 2*(oop field: PCL) +1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; map◦(1+poma).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">map◦(1+poma) &larr; (i field: ZN &larr; val)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Writing and Reading</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">obwiz: oop </span><span style="font: 10pt serif">| poma pm0 pm1 isc bsc i len zz pin zhb<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"find (zn, zp, zw, dlen)"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">zz &larr; Vector new: 4.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">poma &larr; (oop field: PCL)*2 +1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(pm0 &larr; map◦poma) = 0 ⇒ [user notify: &rsquo;bad oop&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pm1 &larr; map◦(1+poma).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">isc &larr; pm0 field: ISC.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bsc &larr; pm0 field: BSC.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">zhb &larr; pm1 field: ZHB.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[isc &lt; 024 ⇒[len &larr; ((isc max: 1)+ 1-bsc) / (2-bsc)]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">len &larr; 8. i &larr; isc+bsc.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ 024 = i do⦂ [i &larr; i-1. len &larr; len*2]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">len &larr; len+1 </span><span style="font: italic 10pt serif">"length word"</span><span style="font: 10pt serif"> ].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">zz◦4 &larr; len &larr; len+1. </span><span style="font: italic 10pt serif">"dlen with refct"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"w &larr; (dlen*128*zhb) +dlen*pin"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pin &larr; oop field: PIN.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">zz◦2 </span><span style="font: italic 10pt serif">"zp"</span><span style="font: 10pt serif"> &larr; (zhb/2 *len) +(len/256 *pin).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">zz◦3 </span><span style="font: italic 10pt serif">"zw"</span><span style="font: 10pt serif"> &larr; (zhb\2 *128 *len) +(len\256 *pin).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">zhb\2 * len ≥ 512 ⇒[user notify: &rsquo;address overflow&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">zz◦2 </span><span style="font: italic 10pt serif">"zp"</span><span style="font: 10pt serif"> &larr; zz◦2 + (zz◦3 field: 136 </span><span style="font: italic 10pt serif">"highbyte"</span><span style="font: 10pt serif">).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">zz◦3 </span><span style="font: italic 10pt serif">"zw"</span><span style="font: 10pt serif"> &larr; zz◦3 field: 128 </span><span style="font: italic 10pt serif">"lowbyte"</span><span style="font: 10pt serif">.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">zz◦1 &larr; pm1 field: ZN.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑zz]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">readin: oop </span><span style="font: 10pt serif">| zinfo<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[zinfo &larr; self obwiz: oop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self read: zinfo◦4 at: zinfo]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">systemNoHistory </span><span style="font: 10pt serif">[] primitive: 82</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">writeout: oop with: image </span><span style="font: 10pt serif">| zinfo<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[zinfo &larr; self obwiz: oop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[zinfo◦4 ≥ (image length /2) ⇒[]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: &rsquo;bad image length&rsquo;].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self write: image at: zinfo<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Init</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">AComment<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"VirtualMemory models the Pclass Map of Ooze.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Vmem is one with CoreLocs on real system.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">(VirtualMemory new) thisvmem.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Pmap is new one we are building.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">(VirtualMemory new) fakevmem.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">map is 1-order addressing.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">In init, set pmatm by searching PM for<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">highest 0. (No LMAT)<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">map RCI field is old class oop. only convert to <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">new with mapPM at end.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Atoms may not cover more than half of the<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">address space. (highpm0:gets:)<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">(VirtualMemory new) giveBirth.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Zone Index of Pages. works for both vector zip<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">and corelocs of real zip.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">zip, zadd are one-order.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">zfree is 1-order in fake, core addr in this.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">zlong = 512.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">zend is not used (0 fake, core addr in this) <br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"</span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fakevmem: vmemfile<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"this instance is a model of a new vmem, which is built on another file"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self init.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">map &larr; Vector new: 1024.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">map all &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">premap &larr; (0176000, 0174000, 0, 0).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"num00, pmint, pmatm, pmend"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">prezip &larr; (3, 01244, 0). </span><span style="font: italic 10pt serif">"zfree, zlong, zend"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">zip &larr; Vector new: prezip◦zlong.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">zip all &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">zadd &larr; (1, 1).  </span><span style="font: italic 10pt serif">"zfused, zflen"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">vmemfile readwrite.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Smalltalk define: ↪Pmap as: self]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init  </span><span style="font: italic 10pt serif">"common to both real and fake vmem"</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"field descriptors and indicies in tables"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">num00 &larr; 1. pmint &larr; 2. pmatm &larr; 3. pmend &larr; 4.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">RCI &larr; 151. CPT &larr; 22. BSC &larr; 21. ISC &larr; 80.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ZHB &larr; 136. ZN &larr; 128. <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">PCL &larr; 151. PIN &larr; 112.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ZJMP &larr; 76. ZVPN &larr; 16*12.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">zfree &larr; 1. zlong &larr; 2. zend &larr; 3.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">zfused &larr; 1. zflen &larr; 2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">zjmpt &larr; (603, 570, 471, 410, 353, 300, 253, <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">210, 169, 132, 101, 72, 49, 30, 13)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">premap </span><span style="font: 10pt serif">[⇑premap] </span><span style="font: italic 10pt serif">"array of limits in Pclass Map"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">thisvmem </span><span style="font: 10pt serif">| c m "create Vmem, a VirtualMemory viewing this very system"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[c &larr; self specialLocs.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">map &larr; CoreLocs new base: c◦2 -1 length: 1025.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">premap &larr; CoreLocs new base: c◦2 -5 length: 5.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Smalltalk define: ↪Vmem  as: self.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self init.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">m &larr; 1023.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ (map◦m = 0) do⦂ [m &larr; m-2].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">premap◦pmatm &larr; (0 field: PCL &larr; m/2 +1).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">prezip &larr; CoreLocs new base: c◦3 -4 length: 4.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">zip &larr; CoreLocs new base: c◦3 -1 length: prezip◦zlong+1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">zadd &larr; CoreLocs new base: c◦12 -3 length: 3.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(vmemfile &larr; dp0 oldFile: &rsquo;small.boot&rsquo;) readonly.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">FirstContext &larr; Context new sender: nil <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">receiver: user<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">method: (m &larr; UserView md method: ↪restart) <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">tempframe: (Vector new: (m◦3 max: m◦4)) pc: m◦6<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">stackptr: m◦5 -1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">SpecialOops◦1 &larr; Object md method: ↪error.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">FirstContextOop &larr; FirstContext asOop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">SpecialOopsOop &larr; SpecialOops asOop]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Vmem Writing</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">afterBirth </span><span style="font: 10pt serif">[MethodKeeperKeeper &larr; nil]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">giveBirth </span><span style="font: 10pt serif">| pm0 vm </span><span style="font: italic 10pt serif">"initialize map for early pclasses"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self preBirth.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"small Integer, 16 pclasses, oops 0174000-0177777"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pm0 &larr; Vmem highPM: 0176000. </span><span style="font: italic 10pt serif">"size, class info for Integer"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ (Pmap newHighPM&larr; pm0) = 0174000 do⦂ []. <br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"first UniqueString"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(vm &larr; Vmapper new) object: (0173600 asObject); touchoop.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Class oops 0-0177"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">vm object: Class; touchoop.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"more Class oops 0200-0577"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">Pmap newLowPM&larr; 0; newLowPM&larr; 0.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"VariableLengthClass oops 0600-0777"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">vm object: Vector; touchoop.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"skip over some oops"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ (Pmap newLowPM&larr; 0) = 01600 do⦂ [].<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Object oops 02000-02177, false=02000"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(vm object: false) map ≠ 02000 ⇒[user notify: &rsquo;bad false oop&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"set pointer back to oops skipped over"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">Pmap premap ◦ pmend &larr; 01000<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">giveBirth2 </span><span style="font: 10pt serif">| vm<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[vm &larr; Vmapper new.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">vm object: (Smalltalk ref: ↪FirstContext).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">FirstContextOop &larr; (vm readin word: 2). </span><span style="font: italic 10pt serif">"new oop of FirstContext"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">vm reset; object: (Smalltalk ref: ↪SpecialOops).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">SpecialOopsOop &larr; (vm readin word: 2). </span><span style="font: italic 10pt serif">"new oop of SpecialOops"</span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">giveBirth3 </span><span style="font: 10pt serif">| vm p [</span><span style="font: italic 10pt serif">"create a new Small.boot<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Write out all objects rooted at Smalltalk.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Do not write the stack (rooted in R76, the current context).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">Pmap file close. Pmap &larr; nil.<br><br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">*** Below is the commmand to start a Vmem write on a Dorado<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">(or Alto -- double disk O.S.).  edit and recompile the method if you don&rsquo;t<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">want to use old UniqueStrings, or if newsmall.boot, smalltalk.run,<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">smalltalk.syms, byterp.mb are not located on dp0i,<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">i.e. dp1 oldFile: &rsquo;small.boot&rsquo; instead of dp0 oldFile: &rsquo;newsmall.boot&rsquo;.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">also delete rename: commands at the end.<br></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user displayoffwhile⦂ [(VirtualMemory new) giveBirth3]. user quit.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">***"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user releaseExternalViews.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[E≡nil⇒ [] E kill].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Flushed&larr; false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(Vmapper new) init; UseOldUniqueStrings: true.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user show: &rsquo;init &rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(VirtualMemory new) thisvmem.  </span><span style="font: italic 10pt serif">"define Vmem, Pmap"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(VirtualMemory new) fakevmem: (dp0 oldFile: &rsquo;newsmall.boot&rsquo;).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self giveBirth.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">vm &larr; Vmapper new.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user show: &rsquo;run &rsquo;. vm object: Smalltalk; map.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user show: &rsquo;USTable &rsquo;. vm arefsRectify.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user show: &rsquo;freelist &rsquo;. vm writefreelists.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user show: &rsquo;mrefs &rsquo;. vm mrefsRectify.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user show: &rsquo;PM &rsquo;. Pmap mapPM; giveBirth2.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">These work as many times as needed on dp0 or dp1</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user show: &rsquo;surgery &rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Pmap surgery: (dp0 oldFile: &rsquo;Smalltalk.Run&rsquo;).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user show: &rsquo;ram &rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Pmap ramwrite: (dp0 oldFile: &rsquo;Byterp.Mb&rsquo;).<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">adjust size of new file</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">p &larr; Pmap pagesUsed + 264 "</span><span style="font: italic 10pt serif">boot & ram</span><span style="font: 10pt serif">" + 250 "</span><span style="font: italic 10pt serif">extra</span><span style="font: 10pt serif">".<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user show: &rsquo;pages reclaimed &rsquo;; print: (Pmap file) file lastPage - p.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(Pmap file) readwriteshorten; settopage: p char: 0; close; readwrite.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"rename files so that new file is small.boot"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(Vmem file) file rename: &rsquo;oldsmall.boot&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(Pmap file) file rename: &rsquo;small.boot&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">mapPM </span><span style="font: 10pt serif">| c i v rci ctrans  </span><span style="font: italic 10pt serif">"convert to new RCI"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ctrans &larr; (Vmapper new) classtrans.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ c from: (1 to: 1023 by: 2) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(i &larr; map◦c) = 0 ⇒[]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">rci &larr; i field: RCI.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(v &larr; ctrans lookup: rci) ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[map◦c &larr; (i field: RCI &larr; v◦1)]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: &rsquo;class not mapped&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">preBirth </span><span style="font: 10pt serif">| v<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[MethodKeeperKeeper &larr; MessageDict new.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">MethodKeeperKeeper init: (v &larr; MethodKeeper contents) length *2; holdMethods: v]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">ramwrite: source </span><span style="font: 10pt serif">| s </span><span style="font: italic 10pt serif">"write 8 pages of ram image into small.boot</span><span style="font: 10pt serif">" [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s &larr; source name.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">source readonly.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[source directory ≡ dp0 ⇒[]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(dp0 file: s) append: source; close "</span><span style="font: italic 10pt serif">copy onto dp0</span><span style="font: 10pt serif">"].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">source close.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">cleanup vmem file before quit</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">vmemfile close.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">go out to OS, packram, and come back</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s &larr; s◦(1 to: s length-4) concat: &rsquo;.br.&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user quitThen: [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(Stream default) append: &rsquo;Packmu &rsquo;;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">append: source name; space; append: s;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">append: &rsquo;; Resume &rsquo;; append: Vmem file name;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">contents].  <br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">skip .br stuff and constants</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(s &larr; dp0 oldFile: s) readonly; skipwords: 0421.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">now write in ram image (8 pages of 512)</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">vmemfile settopage: 0400 char: 0; readwrite; next: 4096 from: s.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s close.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self ≡ Vmem ⇒[vmemfile readonly "</span><span style="font: italic 10pt serif">does flush</span><span style="font: 10pt serif">"]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">vmemfile flush]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Surgery</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dynaLocs: guide </span><span style="font: 10pt serif">| l locs keys v i "Surgery - add core location and value pairs to guide dictionary to test after flush"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[l &larr; self specialLocs.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">locs &larr; (premap base +pmend, (l◦11 -1), (l◦12 -2), (l◦4 +1)).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">keys &larr; (↪premaptest, ↪purgetest, ↪zaddtest, ↪loxtest).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: 1 to: keys length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[v &larr; locs◦i, (mem◦(locs◦i)).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">guide insert: keys◦i with: v].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(guide lookup: ↪loxtest)◦2 &larr; ¬1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">runLocs: f </span><span style="font: 10pt serif">| guide i v locs keys offsets "Surgery - create dictionary of locations of key system tables in Smalltalk.run"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[i &larr; f name.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(v &larr; f directory oldFile: (i◦(1 to: i length-5) concat: &rsquo;.syms.&rsquo;)) readonly.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">locs &larr; self symsFind: (&rsquo;PMBASE&rsquo;, &rsquo;ZIP&rsquo;, &rsquo;ZADD&rsquo;, &rsquo;INITIALIZE&rsquo;, &rsquo;OOZIN&rsquo;, &rsquo;SAFID&rsquo;) on: v.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">v close.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">keys &larr; ↪(maprun ziprun zaddrun initrun zfps safid).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">offsets &larr; ↪(¬1 ¬1 ¬3 ¬3 ¬2 ¬1). "words offset"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">guide &larr; Dictionary new init: 16.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: 1 to: locs length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[v &larr; (locs◦i lshift: ¬8), ((locs◦i land: 0377) -19 *2). "page, byte"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"magic fudge factor of 19 words for .run file"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">v◦2 &larr; v◦2 +(offsets◦i *2). "bytes offset"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">guide insert: keys◦i with: v].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">v &larr; (guide lookup: ↪maprun) copy.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">v◦2 &larr; v◦2 +(¬4 *2).  "offset ¬5 total"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">guide insert: ↪premaprun with: v.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">v &larr; (guide lookup: ↪ziprun) copy.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">v◦2 &larr; v◦2 +(¬3 *2).  "offset ¬4 total"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">guide insert: ↪preziprun with: v.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑guide]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">specialLocs </span><span style="font: 10pt serif">[] primitive: 84<br>"returns a vector containing the core addresses of:<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">1 ROTBASE (the Resident Object Table)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">2 PMBASE (the Pclass Map)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">3 ZIP (the Zone Index of Pages)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">4 LOX (the table of LOcked objeX)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">5 FULL (loc of lowest addr used for resident data)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">6 ULIM (loc of highest addr used for resident data)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">7 ZFPT (the zone file Page Table)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">8 OVTAB (the Table of OVerflow ref counts)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">9 PURGE (a code label)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">10 DISPGLBS (Table of Display Globals)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">11 BACPUR (a code label)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">12 ZADD (.-2 has #pages req&rsquo;d, .-1 has #pages in boot file; add 264 for real file length)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">13 SAFID (loc of file id (5-word block) for the .boot file)<br>"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">staticTest: guide on: f </span><span style="font: 10pt serif">| l locs offsets values names i v "Surgery - test known static constants in thisvmem and in smalltalk.run"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[offsets &larr; (pmint, 2, 0, 0).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">values &larr; (0174000, 01244, 96, 031415).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">names &larr; (↪premaprun, ↪preziprun, ↪zaddrun, ↪initrun).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: names length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[v &larr; guide lookup: names◦i.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">f settopage: v◦1 char: v◦2 +(offsets◦i *2).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">f nextword ≠ (values◦i)⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user notify: &rsquo;bad .run loc&rsquo;]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self ≡ Vmem ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[l &larr; self specialLocs.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">offsets◦4 &larr; 0.  values◦4 &larr; 014764.</span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">locs &larr; (premap base, prezip base, zadd base, (l◦11) "bacpur").<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: 1 to: locs length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[values◦i ≠ (mem◦(locs◦i +(offsets◦i)))⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user notify: &rsquo;bad system loc&rsquo;]]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">surgery: f </span><span style="font: 10pt serif">| guide Etemp i v keys [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">write virtual memory tables into Smalltalk.run using Smalltalk.syms.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user displayoffwhile⦂ [Vmem ramwrite: (dp0 oldFile: &rsquo;byterp.mb&rsquo;)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user displayoffwhile⦂ [Vmem surgery: (dp0 oldFile: &rsquo;Smalltalk.run&rsquo;)]. "<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">vmemfile close.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user releaseExternalViews.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[E ≡ nil ⇒[] E kill].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self ≡ Vmem ⇒[self thisvmem.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">Flushed &larr; true. Etemp &larr; Events]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f readwrite.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">guide &larr; self runLocs: f.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self staticTest: guide on: f.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self ≡ Vmem ⇒[user clearshow: &rsquo;Wait for the safe light to flash, then hit any key&rsquo;.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ user kbck do⦂ []. user kbd.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self dynaLocs: guide.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user clearshow: &rsquo;Dont forget user systemStartup. in the new system to enable interrupts and get the display set up. &rsquo;.<br>]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self tablewrt: guide on: f. "</span><span style="font: italic 10pt serif">write in Smalltalk.run</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f close.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self ≡ Vmem ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[keys &larr; (↪premaptest, ↪purgetest, ↪zaddtest, ↪loxtest).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: keys length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[v &larr; guide lookup: keys◦i.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">v◦2 ≠ (mem◦(v◦1))⇒[user notify: &rsquo;please surgery again&rsquo;]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">Events &larr; nil. self systemVmemOut.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">Events &larr; Etemp.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">vmemfile close.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user quit]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">symsFind: strs on: f1 </span><span style="font: 10pt serif">| f2 S N L offset val str j i "find initial values of SRELs in smalltalk.syms"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["S is start of string space (words)<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">N is start of symbol table "<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(f2 &larr; f1 directory oldFile: f1 name) readonly.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f1 wordposition &larr; 2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">S &larr; f1 nextword.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">N &larr; f1 nextword.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f1 wordposition &larr; N.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">L &larr; f1 nextword.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: L do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[offset &larr; f1 nextword. "next offset"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">f1 skip: 4.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">val &larr; f1 nextword.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">f2 wordposition &larr; S+offset.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">str &larr; f2 next: f2 next.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ j to: strs length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(strs◦j) class ≡ String ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[strs◦j = str ⇒[strs◦j &larr; val]]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f2 close.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ j to: strs length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(strs◦j) class ≡ String ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user notify: &rsquo;symbol not found&rsquo;]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑strs]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">systemVmemOut </span><span style="font: 10pt serif">[] primitive: 83</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">tablewrt: guide on: f </span><span style="font: 10pt serif">| i v vfile "copy tables from self to .run file"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[v &larr; guide lookup: ↪premaprun.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f settopage: v◦1 char: v◦2 +(2*pmatm).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f nextword&larr; premap◦pmatm.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f nextword&larr; premap◦pmend.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: 1024 do⦂ [f nextword&larr; map◦i].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">v &larr; guide lookup: ↪preziprun.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f settopage: v◦1 char: v◦2 +(2*1 "zfree").<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; [self ≡ Vmem ⇒ [¬1-zip base "relative indexing"]¬1 "</span><span style="font: italic 10pt serif">make 0-order"</span><span style="font: 10pt serif">] .</span><span style="font: italic 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f nextword&larr; prezip ◦1 +i. "zfree"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">v &larr; guide lookup: ↪zaddrun.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f settopage: v◦1 char: v◦2 +(2*1 "zfused").<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f nextword&larr; zadd ◦1. </span><span style="font: italic 10pt serif">" zfused "</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">v &larr; guide lookup: ↪ziprun.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f settopage: v◦1 char: v◦2 +(2*1).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: prezip◦zlong do⦂ [f nextword&larr; zip◦i]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">v &larr; guide lookup: ↪initrun.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f settopage: v◦1 char: v◦2 +(2*1 "SpecialOops").<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f nextword&larr; SpecialOopsOop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f nextword&larr; FirstContextOop.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"disk address of start of virtual memory"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">vfile &larr; vmemfile file.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">v &larr; guide lookup: ↪zfps.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f settopage: v◦1 char: v◦2 +(2*1).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f nextword&larr; (vfile read: 0410) address.<br></span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"swat file id of vmem file"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">v &larr; guide lookup: ↪safid.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f settopage: v◦1 char: v◦2 + (2*1).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f append: vfile serialNumber; skip: 4; nextword &larr; (vfile read: 1) address.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Zone Pages</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">cover: zz </span><span style="font: 10pt serif">| pp zrp lpir zjmp vpn olpir<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pp &larr; zz◦2 + 1. "zp 1-order"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">lpir &larr; 1. olpir &larr; 0. zrp &larr; zz◦1 *2 +1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ lpir ≥ pp do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">0 = (zjmp &larr; zip◦zrp field: ZJMP) ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self run: [lpir ≥ 32 ⇒[32] lpir +1] after: zrp.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self cover: zz]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">zrp &larr; (zjmpt◦zjmp + zrp -1)\ (prezip◦zlong) +1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">olpir &larr; lpir.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">lpir &larr; lpir + [lpir ≥ 32 ⇒[32] lpir +1] ].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">vpn &larr; (zip◦zrp field: ZVPN) +pp -(olpir +1).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">0 = vpn ⇒[user notify: &rsquo;pclass has no zone&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">vpn &larr; vpn + 0407.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">vmemfile settopage: vpn char: zz◦3 *2]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">file </span><span style="font: 10pt serif">[⇑vmemfile]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">getpages: i </span><span style="font: 10pt serif">| vpn<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[zadd◦zflen &lt; (zadd◦zfused + i) ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[zadd◦zflen &larr; zadd◦zflen + (i max: 20).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">vmemfile settopage: zadd◦zflen + 0407 char: 0]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">vpn &larr; zadd◦zfused.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">zadd◦zfused &larr; vpn+i.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑vpn]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">newZone </span><span style="font: 10pt serif">| zrp<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[zip is: Vector ⇒[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">zrp &larr; prezip◦zfree.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ zip◦zrp = 0 do⦂ [zrp &gt; (prezip◦zlong) ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user notify: &rsquo;zip overflow&rsquo;]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">zrp &larr; zrp+2].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">prezip◦zfree &larr; 2+zrp.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">zip◦zrp &larr; self getpages: 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑zrp/2]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pagesUsed </span><span style="font: 10pt serif">[⇑zadd◦zfused]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">read: len at: zz </span><span style="font: 10pt serif">| i str<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[i &larr; 256 - (zz◦3) "zw" min: len.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self cover: zz.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">str &larr; vmemfile next: 2*i.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i=len ⇒[⇑str]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">zz◦2 &larr; zz◦2 +1. "zp"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">zz◦3 &larr; 0. "zw"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑str concat: (self read: len-i at: zz)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">run: n after: zrp </span><span style="font: 10pt serif">| i j<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ i to: 15 do⦂ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[j &larr; zjmpt◦i +zrp -1 \ (prezip◦zlong) +1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">zip◦j = 0 ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[zip◦zrp &larr; zip◦zrp field: ZJMP &larr; i.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">zip◦j &larr; self getpages: n. ⇑zrp]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: &rsquo;new zip is full&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">write: str at: zz </span><span style="font: 10pt serif">| i len<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[len &larr; str length /2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; 256 - (zz◦3) "zw" min: len.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i = len ⇒[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self cover: zz.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">vmemfile append: str]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self write: str from: 1 at: zz]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">write: str from: pos at: zz </span><span style="font: 10pt serif">| i len<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[len &larr; str length +1 -pos.  "bytes yet to write"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; len min: (256 - (zz◦3) "zw")*2.  "bytes in page"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self cover: zz.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">vmemfile append: str◦(pos to: i+pos-1).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i=len ⇒[]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">zz◦2 &larr; zz◦2 +1. "zp"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">zz◦3 &larr; 0. "zw"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self write: str from: i+pos at: zz]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪VirtualMemory under: &rsquo;Primitive Access&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"Vmapper"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;Vmapper&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;object oop noop image&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;classtrans PCL mapqueue clamp stopcount USTableOop mrefs arefs count UseOldUniqueStrings &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>This class has not yet been commented</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Mapping</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">map </span><span style="font: 10pt serif">| i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(i &larr; mrefs lookup: oop) ⇒[i◦1 &larr; i◦1 -1. ⇑i◦2]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user kbck ⇒ [user kbd; ev] self bump].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">object class = Integer ⇒[⇑self mapInteger];<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">= UniqueString ⇒[⇑self mapUniqueString];<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">= Vector ⇒[⇑self mapVector];<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">= Float ⇒[⇑self mapFloat];<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">= MessageDict ⇒[⇑self mapMdict]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">object Is: HashSet ⇒[⇑self mapHashSet]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">object Is: String ⇒[⇑self mapString]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">object class = Class ⇒[⇑self mapClass];<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">= VariableLengthClass ⇒[⇑self mapClass];<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">= Vmapper ⇒[⇑¬1]; </span><span style="font: italic 10pt serif">"avoid recursion in writing"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">= VirtualMemory ⇒[⇑self mapVmem]; </span><span style="font: italic 10pt serif">"avoid recursion in writing"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"put any fixed octave class here"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">= Object ⇒[⇑self mapObject]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self mapNormal]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">mapClass </span><span style="font: 10pt serif">| nlen oadd i refs vm j<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[clamp find: object ⇒[⇑¬1 "don&rsquo;t write this class"]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nlen &larr; 1 + object class instsize. </span><span style="font: italic 10pt serif">"refct + normal fields"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; [object is: Class ⇒[oadd &larr; 0. 1] oadd &larr; 1. 20].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">noop &larr; self newoop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(vm &larr; classtrans lookup: oop) ⇒[vm◦1 &larr; noop]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">vm &larr; Vector new: i+1. vm◦1 &larr; noop.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">classtrans insert: oop with: vm].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nlen &larr; nlen + i + oadd.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image &larr; String new: 2*nlen.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(refs &larr; object refct) = 2 ⇒[</span><span style="font: italic 10pt serif">"exactly one reference"</span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">mrefs insert: oop with: (refs-2, noop)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: 1 &larr; refs -2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[oadd=1 ⇒[image word: 2 &larr; nlen-2]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ j from: (2+oadd to: nlen-i) do⦂ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[vm &larr; Vmapper new object: (object instfield: j-1-oadd).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: j &larr; vm map].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self writeout.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑noop]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">mapFloat </span><span style="font: 10pt serif">| refs i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[image &larr; String new: 8.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">noop &larr; self newoop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(refs &larr; object refct) = 2 ⇒[</span><span style="font: italic 10pt serif">"exactly one reference"</span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">mrefs insert: oop with: (refs-2, noop)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: 1 &larr; refs-2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: 3 do⦂ [image word: (i+1) &larr; object instfield: i].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self writeout.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑noop]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">mapHashObs  </span><span style="font: 10pt serif">| nlen oadd i refs vm trans ob<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[nlen &larr; object length. </span><span style="font: italic 10pt serif">"in words"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">oadd &larr; [nlen≤8⇒[0]1].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nlen &larr; oadd +1 +nlen.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image &larr; String new: 2*nlen.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(refs &larr; object refct) = 2 </span><span style="font: italic 10pt serif">"exactly one ref"</span><span style="font: 10pt serif"> ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[noop &larr; self newoop]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(i &larr; mrefs lookup: oop) ⇒[i◦1 &larr; i◦1 -1. noop &larr; i◦2]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">noop &larr; self newoop.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">mrefs insert: oop with: (refs-2, noop)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: 1 &larr; refs -2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[oadd=1⇒[image word: 2 &larr; object length]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ob &larr; (trans &larr; self permHashSet) objects.  </span><span style="font: italic 10pt serif">"translation dictionary"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: (2+oadd to: nlen) do⦂ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[vm &larr; ob◦(i-1-oadd).  </span><span style="font: italic 10pt serif">"integer noops"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">vm ≡ nil ⇒[] image word: i &larr; vm].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self writeout.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑noop, trans values]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">mapHashSet </span><span style="font: 10pt serif">| nlen i refs vm perm  </span><span style="font: italic 10pt serif">"all subclass on HashSet except Mdict"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[mrefs asOop = oop ⇒[⇑¬1] </span><span style="font: italic 10pt serif">"do not map"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">arefs asOop = oop ⇒[⇑¬1] </span><span style="font: italic 10pt serif">"do not map"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nlen &larr; 1 + (object class instsize). </span><span style="font: italic 10pt serif">"refct + fields"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image &larr; String new: 2*nlen.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">noop &larr; self newoop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(refs &larr; object refct) = 2 ⇒[</span><span style="font: italic 10pt serif">"exactly one reference"</span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">mrefs insert: oop with: (refs-2, noop)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: 1 &larr; refs -2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">vm &larr; Vmapper new object: (object instfield: 1).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; vm mapHashObs.  </span><span style="font: italic 10pt serif">"(oop, perm)"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: 2 &larr; i◦1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">perm &larr; i◦2.  </span><span style="font: italic 10pt serif">"permutation of other parts"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: (3 to: nlen) do⦂ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[vm &larr; Vmapper new object: (object instfield: i-1).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: i &larr; (vm mapHashVals: perm)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self writeout.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑noop]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">mapHashVals: perm </span><span style="font: 10pt serif">| nlen oadd i refs vm  </span><span style="font: italic 10pt serif">"values vec of dictionary"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[oop = ¬1 ⇒[⇑¬1]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nlen &larr; object length. </span><span style="font: italic 10pt serif">"in words"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">oadd &larr; [nlen≤8⇒[0]1].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nlen &larr; oadd +1 +nlen.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image &larr; String new: 2*nlen.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(refs &larr; object refct) = 2 </span><span style="font: italic 10pt serif">"exactly one ref"</span><span style="font: 10pt serif"> ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[noop &larr; self newoop]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(i &larr; mrefs lookup: oop) ⇒[i◦1 &larr; i◦1 -1. noop &larr; i◦2]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">noop &larr; self newoop.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">mrefs insert: oop with: (refs-2, noop)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: 1 &larr; refs -2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[oadd=1⇒[image word: 2 &larr; object length]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">object &larr; object◦perm.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: (2+oadd to: nlen) do⦂ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(vm &larr; Vmapper new) object: object◦ (i-1-oadd).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: i &larr; vm map].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self writeout.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑noop]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">mapInteger </span><span style="font: 10pt serif">| refs<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[¬02000 ≤ object and: object &lt; 01777 ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑oop </span><span style="font: italic 10pt serif">"small integer"</span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image &larr; String new: 4.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">noop &larr; self newoop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(refs &larr; object refct) = 2 ⇒[</span><span style="font: italic 10pt serif">"exactly one reference"</span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">mrefs insert: oop with: (refs-2, noop)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: 1 &larr; refs-2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: 2 &larr; object.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self writeout.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑noop]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">mapMdict </span><span style="font: 10pt serif">| i refs vm perm  </span><span style="font: italic 10pt serif">" maps MessageDict instance "</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[image &larr; String new: 12.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">noop &larr; self newoop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(refs &larr; object refct) = 2 ⇒[</span><span style="font: italic 10pt serif">"exactly one reference"</span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">mrefs insert: oop with: (refs-2, noop)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: 1 &larr; refs -2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(vm &larr; Vmapper new) object: (object instfield: 1).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; vm mapHashObs.  </span><span style="font: italic 10pt serif">"(oop, perm)"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: 2 &larr; i◦1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">perm &larr; i◦2.  </span><span style="font: italic 10pt serif">"permutation of other parts"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: (3 to: 6) do⦂ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(vm &larr; Vmapper new) object: (object instfield: i-1).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">i = 3 ⇒[image word: 3 &larr; (vm mapMethodVec: perm)]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: i &larr; (vm mapHashVals: perm)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self writeout.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑noop]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">mapMethod </span><span style="font: 10pt serif">| nlen oadd refs i a vm b<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[oop = ¬1 ⇒[⇑¬1]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nlen &larr; object length. </span><span style="font: italic 10pt serif">"in bytes!!"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">oadd &larr; [nlen≤8⇒[0]1].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nlen &larr; 2*oadd +2 +nlen.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image &larr; String new: nlen+1 |2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(refs &larr; object refct) = 2 </span><span style="font: italic 10pt serif">"exactly one ref"</span><span style="font: 10pt serif"> ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[noop &larr; self newoop]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(i &larr; mrefs lookup: oop) ⇒[i◦1 &larr; i◦1 -1. noop &larr; i◦2]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">noop &larr; self newoop.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">mrefs insert: oop with: (refs-2, noop)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: 1 &larr; refs -2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[oadd=1⇒[image word: 2 &larr; object length]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[nlen ≤ 8 or⦂ object◦6 = 6 ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[image◦(2*oadd +3 to: nlen) &larr; object]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">a &larr; 2*oadd +3. b &larr; object◦6.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">image◦(a to: a+5) &larr; object◦(1 to: 6).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: (4 to: b /2) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(vm &larr; Vmapper new) object: (object word: i) asObject.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: (i+1+oadd) &larr; vm map].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">image◦(a+b to: nlen) &larr; object◦(b+1 to: object length)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self writeout.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑noop]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">mapMethodVec: perm </span><span style="font: 10pt serif">| nlen oadd i refs vm<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[oop = ¬1 ⇒[⇑¬1]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nlen &larr; object length. </span><span style="font: italic 10pt serif">"in words"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">oadd &larr; [nlen≤8⇒[0]1].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nlen &larr; oadd +1 +nlen.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image &larr; String new: 2*nlen.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(refs &larr; object refct) = 2 </span><span style="font: italic 10pt serif">"exactly one ref"</span><span style="font: 10pt serif"> ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[noop &larr; self newoop]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(i &larr; mrefs lookup: oop) ⇒[i◦1 &larr; i◦1 -1. noop &larr; i◦2]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">noop &larr; self newoop.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">mrefs insert: oop with: (refs-2, noop)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: 1 &larr; refs -2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[oadd=1⇒[image word: 2 &larr; object length]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">object &larr; object◦perm.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: (2+oadd to: nlen) do⦂ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(vm &larr; Vmapper new) object: object◦ (i-1-oadd).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: i &larr; vm mapMethod].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self writeout.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑noop]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">mapNormal </span><span style="font: 10pt serif">| nlen i refs vm oadd </span><span style="font: italic 10pt serif">"all fixed, pointer type classes"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[clamp find: object class ⇒[⇑¬1 "don&rsquo;t write the instance"]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nlen &larr; object class instsize.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">oadd &larr; [nlen≤19⇒[0]1].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nlen &larr; oadd+1 +nlen.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image &larr; String new: 2*nlen.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">noop &larr; self newoop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(refs &larr; object refct) = 2 ⇒[</span><span style="font: italic 10pt serif">"exactly one reference"</span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">mrefs insert: oop with: (refs-2, noop)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: 1 &larr; refs-2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[oadd=1⇒[image word: 2 &larr; nlen-oadd-1]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: (2+oadd to: nlen) do⦂ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[vm &larr; Vmapper new object: (object instfield: i-oadd-1).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: i &larr; vm map].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self writeout.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑noop]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">mapObject </span><span style="font: 10pt serif">| refs  </span><span style="font: italic 10pt serif">"nil, false, true"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[object≡nil ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[mrefs insert: ¬1 with: (500, ¬1). </span><span style="font: italic 10pt serif">"for speed of<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">catching nil. watch out on cleanup"</span><span style="font: 10pt serif"> ⇑¬1]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image &larr; String new: 4.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">noop &larr; self newoop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">noop\128&gt;1 ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user notify: &rsquo;Unidentified flying Object&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(refs &larr; object refct) = 2 ⇒[</span><span style="font: italic 10pt serif">"exactly one reference"</span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">mrefs insert: oop with: (refs-2, noop)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: 1 &larr; refs -2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self writeout.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑noop]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">mapString </span><span style="font: 10pt serif">| nlen oadd refs<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[nlen &larr; object length. </span><span style="font: italic 10pt serif">"in bytes!!"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">oadd &larr; [nlen≤8⇒[0]1].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nlen &larr; 2*oadd +2 +nlen.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image &larr; String new: nlen+1 |2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">noop &larr; self newoop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(refs &larr; object refct) = 2 ⇒[</span><span style="font: italic 10pt serif">"exactly one reference"</span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">mrefs insert: oop with: (refs-2, noop)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: 1 &larr; refs -2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[oadd=1⇒[image word: 2 &larr; object length]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image◦((2*oadd +3) to: nlen) &larr; object.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self writeout.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑noop]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">mapUniqueString </span><span style="font: 10pt serif">| nlen oadd refs<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[UseOldUniqueStrings ⇒[self UniStroop. noop &larr; oop]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(refs &larr; arefs lookup: oop) ⇒[⇑refs]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">noop &larr; self newoop.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">arefs insert: oop with: noop].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nlen &larr; object length. </span><span style="font: italic 10pt serif">"in bytes!!"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">oadd &larr; [nlen≤8⇒[0]1].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nlen &larr; 2*oadd +2 +nlen.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image &larr; String new: nlen+1 |2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: 1 &larr; 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[oadd=1⇒[image word: 2 &larr; object length]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image◦((2*oadd +3) to: nlen) &larr; object.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self writeout.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑noop]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">mapVector </span><span style="font: 10pt serif">| nlen oadd i refs vm<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[UseOldUniqueStrings ⇒[] USTableOop = oop ⇒[⇑¬1]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"do not map since new atom Oops"</span><span style="font: 10pt serif">]. <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nlen &larr; object length. </span><span style="font: italic 10pt serif">"in words"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">oadd &larr; [nlen≤8⇒[0]1].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nlen &larr; oadd +1 +nlen.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image &larr; String new: 2*nlen.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">noop &larr; self newoop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(refs &larr; object refct) = 2 ⇒[</span><span style="font: italic 10pt serif">"exactly one reference"</span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">mrefs insert: oop with: (refs-2, noop)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: 1 &larr; refs-2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[oadd=1⇒[image word: 2 &larr; object length]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: (2+oadd to: nlen) do⦂ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[vm &larr; Vmapper new object: (object◦ (i-1-oadd)).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: i &larr; vm map].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self writeout.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑noop]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">mapVmem </span><span style="font: 10pt serif">| nlen i refs vm  "VirtualMemory, Vmem and Pmap"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[nlen &larr; 1 + (object class instsize). "refct + fields"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image &larr; String new: 2*nlen.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">noop &larr; self newoop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(refs &larr; object refct) = 2 ⇒["exactly one reference"]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">mrefs insert: oop with: (refs-2, noop)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: 1 &larr; refs -2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: (2 to: nlen) do⦂ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[image word: i &larr; ¬1]. "Vmem needed for purgealittle"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self writeout.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑noop]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">permHashSet </span><span style="font: 10pt serif">| ob i bb nili vm   </span><span style="font: italic 10pt serif">"gets new atoms, returns dict of objects and permutation"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[bb &larr; Dictionary new init: object length.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; 1. while⦂ (object◦i ≡ nil and: i ≠ object length) do⦂ [i &larr; i+1].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[((object◦i) class) ≡ Integer ⇒[false]; ≡ String ⇒[false] true] ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ i to: object length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[object◦i ≡ nil ⇒[nili &larr; i]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">vm &larr; Vmapper new object: object◦i.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">bb insert: vm map with: i].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">ob &larr; bb values.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: ob length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ob◦i ≡ nil ⇒[ob◦i &larr; nili] ].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑bb]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ob &larr; bb objects.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: ob length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[vm &larr; Vmapper new object: object◦i.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">ob◦i &larr; vm map].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ob &larr; bb values.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: ob length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ob◦i &larr; i].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑bb]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Writing Out</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">method: sel </span><span style="font: 10pt serif">| v str a j i   </span><span style="font: italic 10pt serif">"object is a class. find this method and construct vmapper"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(v &larr; classtrans lookup: oop) ≡ false ⇒[user notify: &rsquo;object not a class&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">str &larr; Pmap readin: v◦1. </span><span style="font: italic 10pt serif">"class image"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; Pmap readin: (str word: 1+4+(oop/0200)). </span><span style="font: italic 10pt serif">"mdict image"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">str &larr; Pmap readin: (i word: 1+1). </span><span style="font: italic 10pt serif">"objects vector image"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">a &larr; String new: 2. a word: 1 &larr; sel asOop. </span><span style="font: italic 10pt serif">"selector"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">j &larr; str find: a◦2. <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">a◦1 ≠ (str◦(j-1)) ⇒[user notify: &rsquo;can not find&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; Pmap readin: (i word: 1+2). </span><span style="font: italic 10pt serif">"methods vector image"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">v &larr; Vmapper new object: (object md method: sel).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">v noop: (i word: (j/2)). v readin.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑v]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">newoop </span><span style="font: 10pt serif">| v a i indx o </span><span style="font: italic 10pt serif">"see if classtrans can help find new oop"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(v &larr; classtrans lookup: (i &larr; object class) asOop) ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[indx &larr; 1 + (Vmem freelist: object).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> [i ≡ Class ⇒[oop ≤ 027 ⇒[⇑oop] </span><span style="font: italic 10pt serif">"touchoop set it up"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">v◦indx ≤ 027 ⇒[v◦indx &larr; 027+1] ];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">≡ VariableLengthClass ⇒[o &larr; v◦indx. </span><span style="font: italic 10pt serif">"in case pclass changes"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">v◦indx &larr; o max: o|128 +(oop\128) +1. <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑ o|128 +(oop\128)] ].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">a &larr; self nextfree: v◦indx.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">v◦indx &larr; a◦2. ⇑a◦1]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> a &larr; [i is: Class ⇒[1] 20].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> v &larr; Vector new: a+1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> classtrans insert: (object class) asOop with: v.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ⇑self newoop]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">newpcl: n </span><span style="font: 10pt serif">| a pm0<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"object class = Foo ⇒[an exception]"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pm0 &larr; Vmem lowPM: oop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">a &larr; [pm0 ⇒[Pmap newLowPM&larr; pm0]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">Pmap newHighPM&larr; (Vmem highPM: oop)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">n=¬1 ⇒[Pmap newZN: a. Pmap ZHB: a gets: 0. ⇑a]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Pmap ZN: a gets: (Pmap ZN: n).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Pmap ZHB: a gets: 1 + (Pmap ZHB: n).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑a]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">nextfree: n </span><span style="font: 10pt serif">| a<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[n≡nil ⇒[n &larr; self newpcl: ¬1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑(n, (n+1))]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">n\0200 = 0177 ⇒[a &larr; self newpcl: n.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑(n, a)]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑(n, (n+1))]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">object: object<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[oop &larr; object asOop]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">readin </span><span style="font: 10pt serif">| v  </span><span style="font: italic 10pt serif">"read object off vmemfile and return image"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[noop ≡ nil ⇒[(v &larr; mrefs lookup: oop) ⇒[noop &larr; v◦2] <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user notify: &rsquo;can not find new oop&rsquo;]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑image &larr; Pmap readin: noop]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">writeout<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"write image of object on file"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Pmap writeout: noop with: image]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Init and Exceptions</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">Acomment<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Vmapper writes objects out.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">watch out for abnormally high refcts.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">we trust map to catch all special cases (especially<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">fixed octave classes (VariableLengthClass)).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Vmapper edit: ↪mapObject.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Vmem is VirtualMemory of this system.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Pmap is VirtualMemory of new system.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">refct in mrefs is 1-order (0 = all done)<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">mrefs - a Dictionary<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">old oop  -&gt;  (remaining refct, new oop)<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">classtrans - a Dictionary<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">old class oop  -&gt;  (new oop, freelist oop)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">-&gt;  (new oop, 20 freelist oops)<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">sequence of foreign object:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">map (put in mrefs) <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">newoop (classtrans lookup old class)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">not there⇒ create pclass, get zone, zip entry<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">enter freelist, no new class in classtrans<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">put nop in mrefs, write object out<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">later: map class, fill in classtrans new class<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">later: pass over PM, convert RCI<br><br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">To remap atoms:</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">To only copy atoms:<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">giveBirth3 - arefsRectify</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">- don&rsquo;t call<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">mapUniqueString -uniStrOop</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">-newoop, arefs<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">mapVector - filter USTable</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">-don&rsquo;t<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">writefreelists - don&rsquo;t freelistRectify</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">-call it<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">(Speed only below)<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">permHashSet - test objects</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">-force fail on test<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Now above done by setting UseOldUniqueStrings in giveBirth3.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"</span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">arefsRectify </span><span style="font: 10pt serif">| i ustable vm </span><span style="font: italic 10pt serif">"create USTable and write out"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[UseOldUniqueStrings ⇒[⇑nil </span><span style="font: italic 10pt serif">"dont create if using old atoms"</span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ustable &larr; Vector new: USTable length.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: ustable length do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[ustable◦i &larr; Vector new: 2].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; ustable.  ustable &larr; USTable. USTable &larr; i.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: arefs objects do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[i ≡ nil ⇒[]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">↪a intern: i asObject].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; ustable.  ustable &larr; USTable. USTable &larr; i.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">vm &larr; Vmapper new.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">vm object: ustable.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self reset; object: (Smalltalk ref: ↪USTable); readin.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: 2 &larr; vm map. </span><span style="font: italic 10pt serif">"ref new table"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self writeout; reset]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">bump  </span><span style="font: italic 10pt serif">"count objects mapped, print"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[count &larr; count + 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">count\ 100 = 0 ⇒[user clearshow: count asString; space;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">show: oop base8; cr.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">count = stopcount ⇒[user ev; show: stopcount asOop base8]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">freelistRectify </span><span style="font: 10pt serif">| i v  </span><span style="font: italic 10pt serif">"fix bad atom freelist"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[UseOldUniqueStrings ⇒[] ⇑nil].  </span><span style="font: italic 10pt serif">"dont rectify if new atom names created"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: (Vmem pmatm to: 0174000 - 0200 by: 0200) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(Vmapper new object: i asObject) UniStroop].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">v &larr; classtrans lookup: 0602.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: (2 to: 21) do⦂ [v◦i ≡ nil ⇒[]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">v◦i &larr; v◦i + 1]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init   </span><span style="font: italic 10pt serif">"set up class variables"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[PCL &larr; 151.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">classtrans &larr; Dictionary new init: 32.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">mrefs &larr; Dictionary new init: 64.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">arefs &larr; Dictionary new init: 64.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">count &larr; 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">stopcount &larr; 5 </span><span style="font: italic 10pt serif">"no stopping"</span><span style="font: 10pt serif">.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">clamp &larr; HashSet new init: 8. <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"clamp insertall: (ClassA, ClassB, ClassC...).""ones to get rid of"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">USTableOop &larr; USTable asOop.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"override this in VirtualMemory giveBirth3"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">UseOldUniqueStrings &larr; true]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">mrefsRectify </span><span style="font: 10pt serif">| v zz<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ v from: mrefs values do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[v ≡ nil ⇒[]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">v◦1 = 0 ⇒[</span><span style="font: italic 10pt serif">"refct ok"</span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">v◦2 = ¬1 ⇒[</span><span style="font: italic 10pt serif">"nil not on disk"</span><span style="font: 10pt serif">]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">zz &larr; Pmap obwiz: v◦2.  </span><span style="font: italic 10pt serif">"noop"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">image &larr; Pmap read: 2 at: zz.  </span><span style="font: italic 10pt serif">"2 words"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: 1 &larr; (image word: 1) - (v◦1).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">Pmap writeout: v◦2 with: image.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self reset]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">noop: noop </span><span style="font: italic 10pt serif">"give it noop for readin"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">reset </span><span style="font: 10pt serif">[noop &larr; image &larr; nil]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">touchoop </span><span style="font: 10pt serif">| v a i indx </span><span style="font: italic 10pt serif">"claim pclass, zone, classtrans"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(v &larr; classtrans lookup: (object class) asOop) ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[indx &larr; 1 +(Vmem freelist: object).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">a &larr; self nextfree: v◦indx.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">v◦indx &larr; a◦1. </span><span style="font: italic 10pt serif">"not take it"</span><span style="font: 10pt serif"> ⇑a◦1]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> i &larr; [object class is: Class ⇒[1] 20].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> v &larr; Vector new: i+1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> classtrans insert: (object class) asOop with: v.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ⇑self touchoop]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">UniStroop </span><span style="font: 10pt serif">| pm0 v indx<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Unique Strings must get same oop and pclass"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">v &larr; classtrans lookup: 0602.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">indx &larr; 1+ (Vmem freelist: object).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pm0 &larr; Pmap highPM: oop.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pm0 and⦂ 0 ≠ pm0 ⇒[</span><span style="font: italic 10pt serif">"test for new max freelist"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(oop field: PCL) = (v◦indx field: PCL) ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[v◦indx &larr; v◦indx max: oop]] <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Pmap highpm0: oop gets: (Vmem highPM: oop).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Pmap ZHB: oop gets: (Vmem ZHB: oop).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">v◦indx ≡ nil ⇒[Pmap newZN: oop.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">v◦indx &larr; oop]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">Pmap ZN: oop gets: (Pmap ZN: v◦indx).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">v◦indx &larr; oop min: v◦indx<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">UseOldUniqueStrings: a </span><span style="font: 10pt serif">[UseOldUniqueStrings &larr; a] </span><span style="font: italic 10pt serif">"true if do not want atoms remapped"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">writefreelists </span><span style="font: 10pt serif">| v oadd i nlen str<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self freelistRectify.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nlen &larr; 1 + Class instsize. oadd &larr; 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">str &larr; String new: 4. <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">str word: 1 &larr; 1. str word: 2 &larr; ¬1. </span><span style="font: italic 10pt serif">"refct=1, link = nil"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ v from: classtrans values do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[v ≡ nil ⇒[]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">image &larr; Pmap readin: v◦1.  </span><span style="font: italic 10pt serif">"noop"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[v length = 2 ⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"a Class"</span><span style="font: 10pt serif"> v◦2 ≡ nil ⇒[]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: (1+nlen) &larr; v◦2.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">Pmap writeout: v◦2 with: str]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"a Variable Length Class"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: 20 do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[v◦(1+i) ≡ nil ⇒ []<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">image word: (i+nlen+oadd) &larr; v◦(1+i).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">Pmap writeout: v◦(1+i) with: str] ].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">Pmap writeout: v◦1 with: image].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self reset]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>As yet unclassified</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">Addons<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(dp0 file: &rsquo;VmapperAdd.st&rsquo;) filout: ↪(<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">arefs  </span><span style="font: italic 10pt serif">"dictionary of UniqueString oops and noops"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑arefs]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classtrans </span><span style="font: 10pt serif">[⇑classtrans]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">image </span><span style="font: 10pt serif">[⇑image]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">mrefs </span><span style="font: italic 10pt serif">"dictionary of multiple refct oops"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑mrefs]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">noop </span><span style="font: 10pt serif">[⇑noop]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">object </span><span style="font: 10pt serif">[⇑object]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">oop </span><span style="font: 10pt serif">[⇑oop]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: strm<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[oop ≡ nil ⇒[super printon: strm]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">strm append: &rsquo;Vmapper &rsquo;; append: oop base8]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">show </span><span style="font: 10pt serif">| i  </span><span style="font: italic 10pt serif">"show image of object in base8"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ i to: image length/2 do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user show: (image base8: i); space.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">i\3 = 0 ⇒[user cr]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪Vmapper under: &rsquo;Primitive Access&rsquo;.</span></div>
<script>function do_tabs() { // unit = px
  var tabs = document.getElementsByClassName("tab");
  for (var i = 0; i < tabs.length; ++i) {
    var span = tabs[i];
    var val = span.getAttribute("val");
    if (val == null) console.log("Couldn't get val");
    var rect = span.getBoundingClientRect();
    var tabstop;
    if (val > 0) tabstop = Math.ceil(rect.left / val) * val;
    else tabstop = -val;
    console.log("do_tabs", val, tabstop)
    if (tabstop > 0) {
      var width = tabstop - rect.left;
      span.style.display = "inline-block";
      span.style.width = width + "px";
    }
  }
}
do_tabs();
</script>
  </body>
</html>
