<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN">
<html>
  <head>
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
    <title>Smalltalk76/Events.st</title>
  </head>
  <body>
    <div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">&rsquo;From Smalltalk 5.5k XM November 24 on 5 February 2037 at 11:08:31 pm.&rsquo;&#771;</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">"EventQueue"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;EventQueue&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Queue<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;primitivequeue readwriteelapsed time&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;read elapsed write &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows&#771;</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>The EventQueue (Events) is a subclass of class Queue.  It contains a regular queue which is filled from a block of memory (currently 128 words long), updated during the 60HZ interrupt.  This block of memory is called the primitivequeue, and is unpacked into the regular queue when events are available upon receiving the message peek or next.  The fundamental difference between peek and next is that next dequeues the current event and peek does not.  Furthermore peek will return false when the queue is empty, and next, when the queue is empty, will create a time elapsed event and return that.  An event will be of class UserEvent as created by the primitiveDequeue and next  messages. The machine code thinks of events as a 4-word structure as follows:<br><br>Word 1:<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Left Byte:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">1 = Key down.  0 = Key up.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Right Byte:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">8-bit Ascii value.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Mouse Buttons:</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Left/Top</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">=</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">0<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Middle</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">=</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">1<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Right/Bottom</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">=</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">2<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Keyset:</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Leftmost</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">=</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">3<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">=</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">4<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">=</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">5<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">=</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">6<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Rightmost</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">=</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">7<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Values 8 - 255, keyboard decodings as expected by rawkbd.<br><br>Word 2:</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Time (sixtieths of a second since last event).<br><br>Word 3:</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Cursor x coordinate (UserView htab accounted for).<br><br>Word 4:</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Cursor y coordinate (UserView vtab accounted for)..<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 10pt serif"> </span><span style="font: italic 10pt serif">"sets up system wide event queue -- only one from the present"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"***BEWARE, USED ONLY AT TIME OF SYSTEM GENERATION***"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">primitivequeue &larr; CoreLocs new base: (mem◦0114) length: (mem◦0115).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">readwriteelapsed &larr; CoreLocs new base: 0111 length: 3.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">read &larr; 0. write &larr; 1. elapsed &larr; 2.</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"offsets of read, write and elapsed pointers"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">time &larr; 0.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"start time at 0"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">super of: (Vector new: 4). </span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"initialize Smalltalk queue"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Public Access</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">elapsedtime </span><span style="font: 10pt serif">[⇑readwriteelapsed◦elapsed] </span><span style="font: italic 10pt serif">"return elapsed time"</span><span style="font: 10pt serif"><br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">next </span><span style="font: 10pt serif">| event elapsedtime </span><span style="font: italic 10pt serif">"return event from queue unless both queues empty,  when return null event"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[event &larr; self dequeue ⇒ [⇑event]</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Queue not empty?"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">event &larr; self primitiveDequeue ⇒ [⇑event]</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"primitivequeue not empty?"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">elapsedtime &larr; readwriteelapsed◦elapsed.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑UserEvent new</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"when empty return null event"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">x:</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user x</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"event x"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">y:</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user y</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"event y"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">type:</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">0</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"2=up, 1=down, 0=null, only time passed"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">stroke:</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">0</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"0 stroke for null event"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">elapsed:</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">elapsedtime</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"1-32767 sixtieths of a sec -- since last event"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">time:</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(time + elapsedtime) asSmall</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"time since timer reset"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">peek </span><span style="font: 10pt serif">| event </span><span style="font: italic 10pt serif">"unless both queues empty, return event from queue, but dont dequeue"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[event &larr; super peek ⇒[ ⇑event]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">event &larr; self primitiveDequeue ⇒ [⇑self next &larr; event]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false</span><span class="tab" val="79"></span><span style="font: 10pt serif">]<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">reset </span><span style="font: italic 10pt serif">"for the present, just reset time to 0"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[time &larr; 0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">time </span><span style="font: 10pt serif">[⇑time]</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> </span><span style="font: italic 10pt serif">"return time"</span><span style="font: 10pt serif"><br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">time &larr; time</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 10pt serif"> </span><span style="font: italic 10pt serif">"reset time"</span><span style="font: 10pt serif"><br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Private</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">primitiveDequeue </span><span style="font: 10pt serif">| rp tands nrp event elapsedtime<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"unless empty, return event from primitivequeue"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(readwriteelapsed◦read) = (readwriteelapsed◦write) ⇒ </span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑false].</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"primitivequeue empty?"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"Build event from primitive queue and return it."<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"first word has type and stroke packed"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">tands &larr; primitivequeue◦(rp &larr; readwriteelapsed◦read).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">elapsedtime &larr; primitivequeue◦(rp + 1).</span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">event &larr; UserEvent new<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">x:</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">primitivequeue◦(rp + 2)</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"event x"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">y:</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">primitivequeue◦(rp + 3)</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"event y"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">type:</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[tands &lt; 0 ⇒ [2] 1]</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"2=up, 1=down"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">stroke:</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[tands &gt; 0 ⇒ [tands] 0 - tands]</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"1-336"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">elapsed:</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">elapsedtime</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"1-32767 sixtieths of a second"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">time:</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(time &larr; (time + elapsedtime) asSmall).<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nrp &larr; rp + 4.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"set bumped read pointer"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[nrp ≥ (primitivequeue length) ⇒ [nrp &larr; 1]].</span><span class="tab" val="79"></span><span style="font: 10pt serif">"Wrap-around?"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">readwriteelapsed◦read &larr; nrp.</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"bump read pointer"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑event</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"Return event"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">&#771;</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪EventQueue under: &rsquo;Events&rsquo;.&#771;</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"MessageTally"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;MessageTally&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;class method tally rcvrs&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;timer &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows&#771;</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>The following statement analyzes the evaluation of &rsquo;user restore&rsquo;.  It checks every 10 sixtieths of a second to see what method is being executed.  It prints the analysis on file &rsquo;restore.spy&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">spy every: 10; on⦂ [user restore]; report: &rsquo;restore.spy&rsquo;; close.<br>Read further to learn of more flexible ways to use message tallies.<br><br>A message tally is a tally of how many times, according to some authority, a certain method or any of that method&rsquo;s callees has been invoked.  Message tallies for the callees are listed in the vector, rcvrs; thus, each message tally is a node in a tree.  The root of that tree is called the &rsquo;root tally&rsquo;; its method the &rsquo;root method&rsquo;; and the context that was running that method the &rsquo;root context&rsquo;.  Contexts that do not have the root context on their stack are tallied as if the root context were at the bottom of their stack.<br><br>The authority informs the root tally of invocations in either of two ways: &rsquo;explicitly&rsquo; or by &rsquo;spying&rsquo;.<br><br>To explicitly create the tallies from a root context, rc, a root tally is created with:<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">mt &larr; MessageTally new from: rc<br>and is informed of the invocation of each context c with:<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">mt tally: c<br><br>To spy on (periodically sample) the execution of a statement sequence, ss, every t sixtieths of a second (t&gt;1), a root tally is created with:<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">mt &larr; MessageTally new every: t<br>and is informed of invocations with:<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">valOfSS &larr; mt on⦂ [ss].<br>The context that executes the latter statement is the root context.  Its method should not be called recursively by ss.  Only one spying operation can be in progress at a time, and all spies share the most recently specified time interval.  Thus, there may as well be only one spying message tally in existence, and the global variable &rsquo;spy&rsquo; is predefined as such.<br><br>Spying typically adds 1/4 second per probe to execution.  Ctrl-shift-esc can be used to abort a spying operation.<br><br>Tallies can be printed by:<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">mt report: &rsquo;filename.spy&rsquo;<br>which prints two tables of invocations sorted by tally, with tallies expressed as percentages and with methods described in terms of their defining class and selector.  In the first table, &rsquo;Leaves&rsquo;, tallies do not include time spent in submethods (this is like the spy in Swat).  In the second table, &rsquo;Tree&rsquo;, the percentages do include time spent in submethods, and those submethods are displayed indented.  In both tables, entries below a &rsquo;cutoff&rsquo; of 2 per cent are suppressed.<br><br>Different cutoffs can be specified for each table.  To cut off Leaves at 7.5 per cent and Tree at 3 per cent, use:<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">mt report: &rsquo;filename.spy&rsquo; cutoff: 7.5,3<br>A cutoff of 100 or greater suppresses printing of that table completely.  To output to a specified stream, use the message &rsquo;fullprinton:cutoff:&rsquo;.<br><br>To release the storage occupied by the tally tree, use the message &rsquo;close&rsquo;.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Public Tallying</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">abort<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[timer is: Timer⇒ [timer disable]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[Smalltalk define: ↪spy as: (MessageTally new every: 10)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">close </span><span style="font: italic 10pt serif">"release storage"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[class &larr; method &larr; tally &larr; rcvrs &larr; nil]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">every: sixtieths</span><span class="tab" val="79"></span><span style="font: bold 10pt serif">  </span><span style="font: italic 10pt serif">"Create a spy that samples with the specified period"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self abort. timer &larr; Timer new for: sixtieths action⦂ [self tally: Top◦1. timer reset]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">from: context  </span><span style="font: italic 10pt serif">"Create a tallier from the specified root"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self class: context receiver class method: context method]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">moreon⦂ remote </span><span style="font: 10pt serif">| val  </span><span style="font: italic 10pt serif">"Spy on the specified evaluation without resetting"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["use as follows:<br></span><span style="font: bold 10pt serif">eachtime  <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[spy every: 10.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑spy moreon⦂ [super eachtime].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">class &larr; remote receiver class.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">method &larr; remote method. <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">timer reset. val &larr; remote eval. timer disable. ⇑val]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">on⦂ remote </span><span style="font: 10pt serif">| val  </span><span style="font: italic 10pt serif">"Spy on the specified evaluation"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self from: remote. timer reset. val &larr; remote eval. timer disable. ⇑val]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">reset<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["reset stats"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">tally &larr; 0. rcvrs &larr; Vector new: 0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">tally: context </span><span style="font: 10pt serif">| root  </span><span style="font: italic 10pt serif">"Explicitly tally the specified context and its stack"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[context method≡method⇒ [⇑self bump]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(root &larr; context sender)≡nil⇒[⇑self bump tallyPath: context]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑(self tally: root) tallyPath: context]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Public Reporting</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fullprinton: s cutoff: pct </span><span style="font: 10pt serif">| set mt i t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user displayoffwhile⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s print: tally; append: &rsquo; tallies&rsquo;; cr. tally=0⇒ []<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s cr; cr. [pct is: Vector⇒ [] pct &larr; pct, pct].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pct◦1&lt;100⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s append: &rsquo;**Leaves**&rsquo;; cr. t &larr; ((pct◦1)*(tally-1)/100) asInteger.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">set &larr; HashSet new init: 128. self leaves: set.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self cumprinton: s from: set total: tally over: t. s next&larr;12; cr.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">set &larr; nil]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pct◦2&lt;100⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s append: &rsquo;**Tree**&rsquo;; cr. t &larr; ((pct◦2)*(tally-1)/100) asInteger.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self treeprinton: s tab: 0 total: tally over: t. s next&larr;12; cr]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s skip: ¬2]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: s<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[class≡nil⇒ [super printon: s] self printon: s total: 100]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">report: filename<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self report: filename cutoff: 2]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">report: filename cutoff: pct </span><span style="font: 10pt serif">| f  </span><span style="font: italic 10pt serif">"pct=(leaves,roots,tree) or one number for all"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[f &larr; dp0 file: filename. f append: filename; space.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self fullprinton: f cutoff: pct. f close]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Private Tallying</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">bump<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[tally &larr; tally+1]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">tallyPath: context </span><span style="font: 10pt serif">| m path mt c<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[m &larr; context method. path&larr;false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ mt from: rcvrs do⦂ [mt method≡m⇒ [path&larr;mt]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[path≡false⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[path &larr; MessageTally new class: context receiver class method: m. rcvrs &larr; rcvrs, path]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑path bump]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Private Reporting</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">&lt; mt<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑tally &gt; mt tally]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">= mt<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑mt method≡method]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">&gt; mt<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑tally &lt; mt tally]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">breakdown </span><span style="font: 10pt serif">| n b mt<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[b &larr; rcvrs. b≡nil or⦂ b length=0⇒ [⇑↪()]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">n &larr; tally. for⦂ mt from: b do⦂ [n &larr; n - mt tally].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[n&gt;0⇒ [b &larr; b, [MessageTally new class: class method: method; primitives: n]]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑b]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">bump: n<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[tally &larr; tally+n]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">cumprinton: s from: set total: total over: threshold </span><span style="font: 10pt serif">| mt<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[for⦂ mt from: set contents sort do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[mt tally&gt;threshold⇒ [mt printon: s total: total. s cr] ⇑self]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">hash<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑method asOop]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">into: set </span><span style="font: 10pt serif">| mt i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[i &larr; set find: self⇒ [mt &larr; set objects◦i]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">set insert: (mt &larr; MessageTally new class: class method: method)].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">mt bump: tally]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">leaves: ldict </span><span style="font: 10pt serif">| b mt<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[b &larr; self breakdown. b length=0⇒ [self into: ldict] for⦂ mt from: b do⦂ [mt leaves: ldict]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">primitives: tally<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[rcvrs &larr; nil]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: s total: total </span><span style="font: 10pt serif">| i v<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[v &larr; (0.0+tally/total*1000.0+0.5) asInteger asString. i &larr; v length.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s append: &rsquo;  &rsquo;◦(i to: 2); append: v◦(1 to: i-1); append: &rsquo;.&rsquo;; next&larr;v◦i; space.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">rcvrs≡nil⇒ [s append: &rsquo;primitives&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">class describe: method on: s]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">tally<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑tally]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">treeprinton: s tab: tab total: total over: threshold </span><span style="font: 10pt serif">| i mt<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[tally≤threshold⇒ []<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[tab&gt;0⇒ [for⦂ i to: tab-1 do⦂ [s append: &rsquo;  |&rsquo;]. self printon: s total: total. s cr]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ mt from: self breakdown sort do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[mt treeprinton: s tab: tab+1 total: total over: threshold]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Private Common</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">class: class method: method<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[tally &larr; 0. rcvrs &larr; Vector new: 0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">method<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑method]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">&#771;</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪MessageTally under: &rsquo;Events&rsquo;.&#771;</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">MessageTally classInit&#771;</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"PriorityInterrupt"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;PriorityInterrupt&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;scheduler priority&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows&#771;</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>PriorityInterrupts fill the need for (sched, level) pairs.  Most messages are simply passed on to the scheduler with the priority as an argument</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">from: scheduler at: priority</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Level numbers</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">+ arg<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑priority + arg]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Scheduling</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">deepsleep<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[scheduler deepsleep: priority]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">disable<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[scheduler disable: priority]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">enable<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[scheduler enable: priority]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">reset<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[scheduler reset: priority]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">restart<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[scheduler restart: priority]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">run: newContext<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[scheduler run: newContext at: priority] primitive: 87</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sleep<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[scheduler sleep: priority]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">swap: newContext<br></span><span class="tab" val="79"></span><span style="font: bold 10pt serif"> with: fieldReference<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[scheduler<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">swap: newContext<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">at: priority<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">with: fieldReference] primitive: 88</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">terminate<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[scheduler terminate: priority]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">wakeup<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[scheduler wakeup: priority]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">&#771;</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪PriorityInterrupt under: &rsquo;Events&rsquo;.&#771;</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"PriorityScheduler"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;PriorityScheduler&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;</span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sourceIndirect<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">"an indirect reference to the source of power,<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">ie the source from which this scheduler was spawned,<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">and who therefore holds the suspension if it is suspended."<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">suspendedContexts<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">"&lt;Vector of Contexts&gt; the suspended processes"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">initialContexts<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">"&lt;Vector of Contexts&gt; root processes for restarting"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">enabledPriorities<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">"&lt;Integer&gt; priorities which can receive control"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">awakePriorities<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">"&lt;Integer&gt; priorities which are requesting control"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">interruptedPriorities<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">"&lt;Integer&gt; new priorities which are requesting control"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">currentPriority<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">"&lt;Integer&gt; priority which currently has control"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">usedPriorities<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">"&lt;Integer&gt; priorities which have processes installed"&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;TimeInt CtlCDisp UserInt GRODSK CtlShftEscInt CtlCInt &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sharing: BitMasks;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows&#771;</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>The underlying machine has a pointer to the top-level scheduler (Top), so that physical interrupts can also cause interrupts in Smalltalk.  This they do by calling their own copy of wakeup and reselect.  This copy is also invoked (primitive 65) when reselect is sent to the top-level scheduler, since its source is the virtual machine itself.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">◦ priority<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑suspendedContexts◦priority]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">currentPriority </span><span style="font: 10pt serif">[⇑currentPriority]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fromSource: sourceIndirect<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Initialize a scheduler having 16 spaces for processes"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> suspendedContexts &larr; Vector new: 16.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> initialContexts &larr; Vector new: 16.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> enabledPriorities &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> awakePriorities &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> interruptedPriorities &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> usedPriorities &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> currentPriority &larr; 0.]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">replaceUser: stack<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[UserInt run: stack]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Install and Terminate</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">install⦂ newContext above: priority </span><span style="font: 10pt serif">| i<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Install a process in the next empty level above &lt;priority&gt; which is initialized from &lt;newContext&gt; (a remote Context). If there is no empty level above that priority, tell the user and return false"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> newContext sender &larr; nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> for⦂ i from: (priority+1 to: 16) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(usedPriorities land: biton◦i) = 0⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">INSTALL⦂ [while⦂ true do⦂ [newContext cleancopy eval]]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">AT: i]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> user show:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;PriorityScheduler unable to install above level &rsquo;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">+priority asString<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">+&rsquo;. false returned&rsquo;. ⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">install⦂ newContext at: priority<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Install a process at level &lt;priority&gt; which is initialized from &lt;newContext&gt; (a remote Context). If there is already a process at that priority, tell the user and return false"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> newContext sender &larr; nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> (usedPriorities land: biton◦priority) = 0⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑self<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">INSTALL⦂ [while⦂ true do⦂ [newContext cleancopy eval]]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">AT: priority]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> user show:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;PriorityScheduler unable to install at level &rsquo;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">+priority asString<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">+&rsquo;. false returned&rsquo;. ⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">run: newContext<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 10pt serif"> at: priority<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"replace the process at &lt;priority&gt; with &lt;newContext&gt;. If that is the currently running priority, abandon what is running and start from &lt;newContext&gt;"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> priority = currentPriority⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[sourceIndirect run: newContext]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> suspendedContexts◦priority &larr; newContext]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">swap: newContext<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 10pt serif"> at: priority<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 10pt serif"> with: fieldReference<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"replace the process at &lt;priority&gt; with &lt;newContext&gt; and place the old contents in the field referred to by &lt;fieldReference&gt;"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> priority = currentPriority⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[sourceIndirect<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">swap: newContext<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">with: fieldReference]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> fieldReference value&larr; suspendedContexts◦priority.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> suspendedContexts◦priority &larr; newContext]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">terminate: priority<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Remove a process from the scheduler, allowing that level to be reused"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> enabledPriorities &larr; enabledPriorities land: bitoff◦priority.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> [suspendedContexts◦priority≠nil⇒[(suspendedContexts◦priority) releaseFully]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> [initialContexts◦priority≠nil⇒[(initialContexts◦priority) releaseFully]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> suspendedContexts◦priority &larr; initialContexts◦priority &larr; nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> awakePriorities &larr; awakePriorities land: bitoff◦priority.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> interruptedPriorities &larr; interruptedPriorities land: bitoff◦priority.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> usedPriorities &larr; usedPriorities land: bitoff◦priority.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self reselect]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Enable and Disable</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">disable: priority<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Prevent the process at &lt;priority&gt; from being activated by a wakeup. Turn off the corresponding bit in enabledPriorities and check if that changes who should run"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> enabledPriorities &larr; enabledPriorities land: bitoff◦priority.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self reselect]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">enable: priority<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Allow the process at &lt;priority&gt; to be activated by a wakeup. Turn on the corresponding bit in enabledPriorities and check if that changes who should run"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> enabledPriorities &larr; enabledPriorities lor: biton◦priority.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self reselect]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Wakeup and Sleep</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">deepsleep: priority<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Request the process at &lt;priority&gt; to cease running and ignore any new wakeups. Turn off the corresponding bit in awakePriorities and interruptedPriorities and check if that changes who should run"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> awakePriorities &larr; awakePriorities land: bitoff◦priority.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> interruptedPriorities &larr; interruptedPriorities land: bitoff◦priority.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self reselect]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">errorReset<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"There has been an error. Initialize the state of the process that was running.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">  If it was not the user process (priority 1), request it to cease running and<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">  prevent its further running (i.e. disable it)"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> currentPriority=1⇒[self init: currentPriority]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> awakePriorities &larr; awakePriorities land: bitoff◦currentPriority.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> enabledPriorities &larr; enabledPriorities land: bitoff◦currentPriority.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self init: currentPriority]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">reselect<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 10pt serif"> </span><span style="font: 10pt serif">| newPriority oldPriority newContext tempenabled tempinterrupts<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Switch to the highest priority enabled process"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> tempenabled &larr; self disable.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> tempinterrupts &larr; interruptedPriorities land: awakePriorities.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> awakePriorities &larr; interruptedPriorities lor: awakePriorities.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> interruptedPriorities &larr; tempinterrupts.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> newPriority &larr; (awakePriorities land: tempenabled) hibit.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> newPriority = 0⇒[enabledPriorities &larr; tempenabled. ⇑false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> newPriority = currentPriority⇒[enabledPriorities &larr; tempenabled]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> newContext &larr; suspendedContexts◦newPriority.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> suspendedContexts◦newPriority &larr; nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> oldPriority &larr; currentPriority.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> currentPriority &larr; newPriority.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> enabledPriorities &larr; tempenabled.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> sourceIndirect<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">swap: newContext<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">with: (suspendedContexts ref: oldPriority)]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">primitive: 65</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">reset: priority<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Initialize the state of the process at &lt;priority&gt; and request it to cease running"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> awakePriorities &larr; awakePriorities land: bitoff◦priority.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self init: priority]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">resetCurrent<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Initialize the state of the process that is running. If it is not the<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">  user process (priority 1), request it to cease running"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> currentPriority=1⇒[self init: currentPriority]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> awakePriorities &larr; awakePriorities land: bitoff◦currentPriority.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self init: currentPriority]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">restart: priority<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Initialize the state of a suspended process and request it to run"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> interruptedPriorities &larr; interruptedPriorities lor: biton◦priority.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self init: priority]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sleep: priority<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Request the process at &lt;priority&gt; to cease running, if a new wakeup has arrived the process will be reawakened. Turn off the corresponding bit in awakePriorities and check if that changes who should run"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> awakePriorities &larr; awakePriorities land: bitoff◦priority.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self reselect]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">wakeup: priority<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Request the process at &lt;priority&gt; to run. Turn on the corresponding bit in interruptedPriorities and check if that changes who should run"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> interruptedPriorities &larr; interruptedPriorities lor: biton◦priority.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self reselect]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Top level</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init1<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[UserInt &larr; Top<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">install⦂ [user restart]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">at: 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> UserInt enable wakeup]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init11</span><span class="tab" val="79"></span><span style="font: 10pt serif">" Top terminate: 11; init11. "</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[GRODSK &larr; Top<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">install⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user displayoffwhile⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user show: &rsquo;<br>Smalltalk needs more space.<br>Just a moment...&rsquo;.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">dp0 growSmalltalkBy: 100.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user show: &rsquo;  Done.&rsquo;; cr].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">GRODSK deepsleep]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">at: 11.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">GRODSK enable]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init8 </span><span style="font: 10pt serif">| nw<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[CtlCInt &larr; Top<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">install⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[nw &larr; user notifier: &rsquo;Control c Interrupt&rsquo; level: 1 interrupt: true.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[nw⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user schedule: nw.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> </span><span class="tab" val="79"></span><span style="font: 10pt serif">nw takeCursor.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nw &larr; nil.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> </span><span class="tab" val="79"></span><span style="font: 10pt serif">UserInt restart]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">CtlCInt sleep]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">at: 8.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> CtlCInt enable]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init9  </span><span style="font: 10pt serif">"Top terminate: 9; init9."</span><span style="font: bold 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[CtlShftEscInt &larr; Top<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">install⦂ [spy abort. user restoredisplay. <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[user buttons=7⇒["dont release possible garbage"] (Top◦1) releaseFully].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">UserInt restart. CtlShftEscInt sleep]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">at: 9.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> CtlShftEscInt enable]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">initsched<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[Top &larr; self fromSource: (PriorityInterrupt new).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self init1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self init11.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self init8.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self init9.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> Top top]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">top<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Make this scheduler the top level one. It will receive all physical (non-Smalltalk) interrupts"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> enabledPriorities &larr; enabledPriorities lor: biton◦1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> awakePriorities &larr; awakePriorities lor: biton◦1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> currentPriority &larr; 1] primitive: 61</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Critical sections</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">critical⦂ expr</span><span style="font: 10pt serif">| t v<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Execute &lt;expr&gt; without allowing it to be interrupted"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> t &larr; self disable.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> v &larr; expr eval.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> enabledPriorities &larr; t.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self reselect. ⇑v]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Private</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">disable </span><span style="font: 10pt serif">| t<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"This message should deffinitely be protected. Zero all the enabled flags and return the previous value of them"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> t &larr; enabledPriorities. enabledPriorities &larr; 0. ⇑t] primitive: 66</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init: priority<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 10pt serif"> </span><span style="font: 10pt serif">| newPriority oldPriority newContext tempenabled tempinterrupts<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"This message should be protected. It is used by reset: and restart: to actually switch suspended processes"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> tempenabled &larr; self disable.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> tempinterrupts &larr; interruptedPriorities land: awakePriorities.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> awakePriorities &larr; interruptedPriorities lor: awakePriorities.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> interruptedPriorities &larr; tempinterrupts.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> newPriority &larr; (awakePriorities land: tempenabled) hibit max: 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> (newPriority = currentPriority)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">and: (currentPriority = priority)⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[enabledPriorities &larr; tempenabled.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> sourceIndirect run: (initialContexts◦priority) cleancopy]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> suspendedContexts◦priority &larr; (initialContexts◦priority) cleancopy.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> newPriority = currentPriority⇒[enabledPriorities &larr; tempenabled.]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> newContext &larr; suspendedContexts◦newPriority.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> suspendedContexts◦newPriority &larr; nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> oldPriority &larr; currentPriority.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> currentPriority &larr; newPriority.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> enabledPriorities &larr; tempenabled.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> oldPriority = priority⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[sourceIndirect run: newContext]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> sourceIndirect<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">swap: newContext<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">with: (suspendedContexts ref: oldPriority)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">INSTALL⦂ newContext AT: priority<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"This message should be protected, it is used by install:at: and install:above: to do the actual initialization of the process"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> newContext sender &larr; nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> usedPriorities &larr; usedPriorities lor: biton◦priority.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> initialContexts◦priority &larr; newContext.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> suspendedContexts◦priority &larr; newContext cleancopy.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ⇑PriorityInterrupt new from: self at: priority]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">printon: s </span><span style="font: 10pt serif">| i b2 j<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[super printon: s.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: 5 do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s cr.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">b2&larr; (usedPriorities, enabledPriorities, awakePriorities,<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">interruptedPriorities, (1 lshift: currentPriority-1))◦i base: 2.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ j to: 16-b2 length do⦂ [s next&larr; &rsquo;0&rsquo;◦1].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s append: b2; space;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">append: ↪(&rsquo;used&rsquo; &rsquo;enabled&rsquo; &rsquo;awake&rsquo; &rsquo;interrupted&rsquo; &rsquo;current&rsquo;)◦i]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Reclamation</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">&#771;</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪PriorityScheduler under: &rsquo;Events&rsquo;.&#771;</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"Timer"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;Timer&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Object<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;</span><span class="tab" val="79"></span><span style="font: bold 12pt serif">activeTime</span><span class="tab" val="79"></span><span style="font: bold 12pt serif">"how long this Timer will be the active one"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">nextTimer</span><span class="tab" val="79"></span><span style="font: bold 12pt serif">"the Timer which will fire after this one"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">lastTimer</span><span class="tab" val="79"></span><span style="font: bold 12pt serif">"the Timer which will fire before this one"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">delay</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">"how long between setting and firing"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">action</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">"what happens when this timer fires"&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;currentTimer timerActions &rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows&#771;</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>A Timer is an object which causes an action after an interval of time. The time interval is measured in units of a sixtieth of a second from when the instance was initialized with the message &lt;for: {time interval} action⦂ [{code for action}]&gt;. When the interval is over the Timer fires by placing the action on a queue to be evaluated before processing at the user level continues. There is no need to mantain a name for a Timer while it is active, but a named timer may be disabled or reused. The Timers waiting to fire form a doubly linked list whose first link is referred to by the class variable currentTimer. Each Timer knows how long it should run after the preceding Timer has fired</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Initialize the processes used by the Timers"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[timerActions &larr; Queue new of: (Vector new: 4).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self init16.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self init12]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">for: delay action⦂ action<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Initialize a new Timer"</span><span style="font: 10pt serif">]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init12 </span><span style="font: 10pt serif">| nextAction</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Initialize the process which evals Timer actions"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[Top install⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[while⦂ true do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[while⦂ (nextAction &larr; timerActions next) do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[nextAction eval].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> Top sleep: 12]] at: 12.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> Top enable: 12]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init16</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Initialize the process wakened by a Timer timing out"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[Top install⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[while⦂ true do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[currentTimer fire.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> Top sleep: 16]] at: 16.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> Top enable: 16]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">reset </span><span style="font: 10pt serif">| nextTimeout foundit<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Set up this Timer to add &lt;action&gt; to the Queue of remote Contexts to be evaled after an interval of &lt;delay&gt; sixtieths of a second. Find the proper place in the doubly linked list and calculate the amount of time to run after the preceeding timer fires"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> Top critical⦂ <br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[activeTime≡nil⇒[]self disable].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> activeTime &larr; delay. nextTimer &larr; currentTimer. lastTimer &larr; nil.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> foundit &larr; false.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> until⦂ foundit do⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[nextTimer≡nil⇒[foundit &larr; true].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> (nextTimeout &larr; nextTimer activetime) &gt; activeTime⇒[foundit &larr; true].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> activeTime &larr; activeTime - nextTimeout.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> lastTimer &larr; nextTimer.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> nextTimer &larr; lastTimer nexttimer].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> [nextTimer≡nil⇒[] nextTimer insertlast: self].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> lastTimer≡nil⇒[self startup] lastTimer insertnext: self]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>List Behavior</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">deletelast<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Delete the Timer before this one. When deleting a Timer, the activeTime of the Timer after it must be increased by its activeTime"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> activeTime &larr; activeTime + lastTimer activetime.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> (lastTimer &larr; lastTimer lasttimer)≡nil⇒[self startup]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">deletenext<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Delete the Timer after this one"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> nextTimer &larr; nextTimer nexttimer]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">insertlast: lastTimer<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"Insert a new Timer before this one. When inserting a Timer in front of another, the activeTime of the later one must be reduced so it is the amount of time after the new Timers firing"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> activeTime &larr; self activetime - lastTimer activetime]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">insertnext: nextTimer</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">lasttimer<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑lastTimer]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">nexttimer<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[⇑nextTimer]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">release </span><span style="font: 10pt serif">[lastTimer &larr; nil. nextTimer &larr; nil. action &larr; nil]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Timing Behavior</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">activetime<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"If this is the current Timer return the time until it fires, otherwise return activeTime"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> ⇑activeTime] primitive: 96</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">disable</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Remove this timer from the list"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[Top critical⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[[self≡currentTimer and⦂ nextTimer≡nil⇒[self shutoff. Top deepsleep: 16]].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> [lastTimer≡nil⇒[] lastTimer deletenext].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> [nextTimer≡nil⇒[] nextTimer deletelast].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"> activeTime &larr; nil. lastTimer &larr; nil. nextTimer &larr; nil]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fire</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"Time is up, add the action to the Queue to be evaled"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[timerActions next&larr; action.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> Top wakeup: 12.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> activeTime &larr; nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> lastTimer &larr; nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> nextTimer≡nil⇒[self shutoff]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> nextTimer startup.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> nextTimer &larr; nil]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">primstartup<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"this message informs the virtual machine that this is the next Timer to fire"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[] primitive: 95</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">shutoff<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"this message informs the virtual machine and class Timer that there are no more Timers to fire"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> currentTimer &larr; nil] primitive: 97</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">startup<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"make this the next Timer to fire"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> lastTimer &larr; nil.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> currentTimer &larr; self.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"> self primstartup]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">&#771;</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪Timer under: &rsquo;Events&rsquo;.&#771;</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">Timer classInit&#771;</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"UserEvent"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;UserEvent&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: Point<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;type stroke elapsed time&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows&#771;</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>This class is used by the Events queue (updated in the 60HZ interrupt routine) to package up and return an event every time the queue is popped.  The class provides easy access to various parts of the event.  Users may create their own events by pushing onto the Events queue, which is why the Initialization here is classified as private.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Initialization</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">x: x y: y type: type stroke: stroke elapsed: elapsed time: time <br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"make an event, usually called from EventQueue"</span><span style="font: 10pt serif"><br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Public Access</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">elapsed </span><span style="font: italic 10pt serif">"return an event stroke"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"1 - 32767 sixtieths of second since previous non-time-elapsed event recorded"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑elapsed]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">isKbdDown<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["if stroke a down stroke and not keyset or mouse button, return it,<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">otherwise return false"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">type ≠ 1 ⇒ [⇑false] ⇑stroke &gt; 16]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">stroke </span><span style="font: italic 10pt serif">"return an event stroke"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[</span><span style="font: italic 10pt serif">"0-2 = top,middle,bottom mouse buttons, 3-7 = keys
