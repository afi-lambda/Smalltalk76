<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN">
<html>
  <head>
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
    <title>Smalltalk76/Alto-File-System.st</title>
  </head>
  <body>
    <div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">&rsquo;From Smalltalk 5.5k XM November 24 on 5 February 2037 at 11:05:45 pm.&rsquo;<br></span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">"AltoFile"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;AltoFile&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: File<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;leader pageAddresses&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sharing: AltoFilePool;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>A File found on an Alto Model 31(44) disk</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Dictionary</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">close </span><span style="font: 10pt serif">["to look at at reopen" type &larr; self updateLeader: (self read: 0)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">entryClass </span><span style="font: 10pt serif">[⇑AltoFilePage]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">open </span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">don&rsquo;t find last page immediately.  for later close</span><span style="font: 10pt serif">" type &larr; read]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>DictionaryEntry</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">fileSize </span><span style="font: 10pt serif">["sn, version, fn, leader, name" ⇑11 + (name length lor: 1)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init </span><span style="font: 10pt serif">[super init.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pageAddresses &larr; AltoFileAddressTable new]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">readFrom: s </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"read file description from SysDir"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">serialNumber &larr; s next: 4.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s skip: 4 "self version: s nextword. s skip: 2".<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">leader &larr; directory virtualToReal: s nextword.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">name &larr; s nextString.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s padNext]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">storeOn: s </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s append: serialNumber;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextword &larr; 1; nextword &larr; 0;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextword &larr; (directory realToVirtual: leader);<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextString &larr; name; padNext &larr; 0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>File</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">classInit </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">before filing in:</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">Smalltalk declare: ↪AltoFilePool as: (SymbolTable new init: 32)"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">AltoFilePool<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">declare: ↪(CRR CCR CCW CWW "</span><span style="font: italic 10pt serif">disk commands</span><span style="font: 10pt serif">")<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">as: ↪(044100 044120 044130 044150);<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">declare: ↪(<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">dfmask "</span><span style="font: italic 10pt serif">bit means active directory entry</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">boffset "</span><span style="font: italic 10pt serif">byte offset of bit table in DiskDescriptor</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">dirname) as: ↪(02000 040 &rsquo;SysDir.&rsquo; );<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">declare: ↪(nextp backp numch pagen vn) as: ↪(1 2 4 5 6)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">doCommand: com page: page error: e </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">error &larr; nullString.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self dskprim: directory diskNumber address: page address command: com<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">page: page page⇒ [⇑page]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">error &larr; self errorString: error "</span><span style="font: italic 10pt serif">set by </span><span style="font: bold 10pt serif">dskprim:...</span><span style="font: 10pt serif">".<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑self error: e]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">endFile: page </span><span style="font: 10pt serif">| nextPage pn [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[page≡false⇒ ["</span><span style="font: italic 10pt serif">free all of file</span><span style="font: 10pt serif">" pn &larr; ¬1]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[page full⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextPage &larr; self Write: page.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">if page was a full last page, next is an empty (and now last) page</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextPage lastPage⇒ [⇑nextPage]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">page &larr; self read: page pageNumber+1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">page empty⇒ [⇑page]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">page length: 0]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">write last page</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">page header: nextp &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self Write: page.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">free rest of file</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pn &larr; page pageNumber].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">lastpn &larr; false "</span><span style="font: italic 10pt serif">reset by readPage:</span><span style="font: 10pt serif">".<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ (lastpn≡false and⦂ (nextPage &larr; self read: (pn &larr; pn+1))) do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextPage init; freePage;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">doCommand: CWW error: &rsquo;endFile:&rsquo;.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">directory deallocate: nextPage].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[page⇒ [pageAddresses position &larr; (lastpn &larr; page pageNumber)]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑page]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">findLastPage </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self read: 20000.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑lastpn]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">Get: page </span><span style="font: 10pt serif">| p pn [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pn &larr; page pageNumber.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self Read: page⇒ [⇑page]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">page now contains last page</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ p from: lastpn to: pn-1 do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">page pageNumber: p; length: page dataLength.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">this writes current and allocates next (empty) page</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">page &larr; self Write: page].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑page]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">Read: page </span><span style="font: 10pt serif">| pn p palen [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pn &larr; page pageNumber.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[pageAddresses⇒ [palen &larr; pageAddresses length]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">pn = 0⇒ [palen &larr; 0]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ p from: (palen min: pn) to: pn do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">set up page for checking</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">page<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">zeroed by machine code</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">header: nextp &larr; [p &lt; palen⇒ [pageAddresses◦(p+1)] 0];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">header: backp &larr; [p=0⇒ [0]; =1⇒[leader] pageAddresses◦(p-1)];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">length: [p &lt; palen⇒ [page dataLength] 0];"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pageNumber: p;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">address: [p=0⇒ [leader] pageAddresses◦p];<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">doCommand: CCR error: &rsquo;readPage:&rsquo;.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">page lastPage⇒ [(lastpn &larr; p) &lt; pn⇒ [⇑false]]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">p ≥ palen and⦂ pageAddresses⇒[pageAddresses◦(p+1) &larr; page header: nextp]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">no need to store if already known or no page table</span><span style="font: 10pt serif">"].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑page]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">sameFile </span><span style="font: 10pt serif">| page s [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(page &larr; self newPage: 0) address: leader.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">if any of following  tests fail, File will be reinitialized</span><span style="font: 10pt serif">"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑("</span><span style="font: italic 10pt serif">serial number match</span><span style="font: 10pt serif">" (page doCommand: CCR error: false) and⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">correct page number</span><span style="font: 10pt serif">" page pageNumber = 0) and⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s &larr; page asStream.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">last write was by us</span><span style="font: 10pt serif">" type = (s next: 4) and⦂<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s skip: 8.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">same name</span><span style="font: 10pt serif">" (name compare: s nextString) = 2]]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">Write: page </span><span style="font: 10pt serif">| nextPage labelDirty returnPage [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(labelDirty &larr; page lastPage) and⦂ page full⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">last page can&rsquo;t be full, so glue on another page</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">returnPage &larr; nextPage &larr; self newPage.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">directory allocate: nextPage after: (directory realToVirtual: page address).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextPage init;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">header: backp &larr; page address;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pageNumber: (lastpn &larr; page pageNumber+1);<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">serialNumber: serialNumber;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">doCommand: CWW error: &rsquo;writePage: (allocate)&rsquo;.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">link to current page</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">page header: nextp &larr; nextPage address.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pageAddresses⇒ [pageAddresses◦lastpn &larr; nextPage address]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: bold 10pt serif">growSmalltalkBy:</span><span style="font: 10pt serif">"]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">returnPage &larr; page].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">whenever a last (or second last) page is written, write label also</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self doCommand: [labelDirty⇒ [CWW] CCW] page: page error: &rsquo;writePage:&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">type &larr; read+write.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑returnPage]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Alto</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">dskprim: diskNumber </span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">0/1</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: bold 10pt serif">address: a</span><span style="font: 10pt serif"> "</span><span style="font: italic 10pt serif">starting Alto disk address</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: bold 10pt serif">command: com</span><span style="font: 10pt serif"> "</span><span style="font: italic 10pt serif">disk command (usually CCR, CCW, CWW)</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: bold 10pt serif">page: string</span><span style="font: 10pt serif"> "</span><span style="font: italic 10pt serif">string containing label and data</span><span style="font: 10pt serif">"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">["</span><span style="font: italic 10pt serif">if disk routine encounters an error,</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">error &larr; (DCB status, to be interpreted by </span><span style="font: bold 10pt serif">errorString:</span><span style="font: 10pt serif">).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">if other error occurs, e.g. nil instead of Integer...</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">error &larr; ¬1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false] primitive: 80</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">errorString: status </span><span style="font: 10pt serif">| t s [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">see Alto hardware manual for details on error word format</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">status=¬1⇒ [⇑&rsquo;primitive failure, bad args?&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s &larr; Stream default.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s append: ↪(&rsquo;&rsquo;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;hardware error or sector overflow&rsquo;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;check error&rsquo;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;disk command specified illegal sector&rsquo;)◦(1 + (status land: 3)).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ t to: 6 do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">status allmask: (0200 lshift: 1-t)⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s space; append: ↪(<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;seek failed, possible illegal track&rsquo;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;seek in progress&rsquo;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;disk unit not ready&rsquo;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;hardware late&rsquo;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;hardware not transferring&rsquo;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">&rsquo;checksum&rsquo;)◦t]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s space; append: status base8.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑s contents]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">leader </span><span style="font: 10pt serif">[⇑leader]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">leader: leader</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pageAddresses: pageAddresses</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">updateLeader: page </span><span style="font: 10pt serif">| s time lastwrite [ <br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">see &lt;Alto&gt;AltoFileSys.D, (p.3 leader page) for further info</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">time &larr; user timewords.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s &larr; page asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[type anymask: write ⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">set creation/write read date and name</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">directory flush.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">lastwrite &larr; time.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s append: time; append: time; append: time.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">name empty⇒ []<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s nextString&larr; name]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">lastwrite &larr; s next: 4.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s skip: 4; append: time].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self Write: page.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑lastwrite]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪AltoFile under: &rsquo;Alto File System&rsquo;.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">AltoFile classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"AltoFileAddressTable"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;AltoFileAddressTable&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: RunVector<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>This class converts to virtual disk addrs which tend to come in consecutive<br>runs, and can thus use the compact representation of its superclass.</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Reading and writing</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">◦i </span><span style="font: 10pt serif">| base [base&larr; super◦i. ⇑dp0 virtualToReal: base+offset]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">◦i&larr; val </span><span style="font: 10pt serif">| virt [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">virt&larr; dp0 realToVirtual: val.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">starts ≡ nil⇒[super◦i&larr; virt. ⇑val]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">super◦i&larr; virt-i+(starts last).</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"superclass tries for constant runs"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">offset&gt;0⇒[⇑val]</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"OK if same run"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">values last&larr; virt. ⇑val]</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"else fix new run value base"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">position&larr; p </span><span style="font: 10pt serif">| l</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"shortens (for file shorten)"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[p&gt;max⇒[user notify: &rsquo;invalid extension&rsquo;] max&larr; p.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(l&larr; starts findSorted: max)&lt;starts length⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[starts&larr; starts copy: 1 to: l.  values&larr; values copy: 1 to: l]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪AltoFileAddressTable under: &rsquo;Alto File System&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"AltoFileDirectory"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;AltoFileDirectory&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: FileDirectory<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;dirFile bitsFile closed diskPages totalPages nSectors&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sharing: AltoFilePool;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Dictionary</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">close </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self obsolete⇒ []<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dirFile close.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[bitsFile ≡ nil⇒ ["an interrupted open?"] bitsFile close].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">super close]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">Delete: file </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(self deleteEntry: file) open; endFile: false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitsFile flush]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">entryClass </span><span style="font: 10pt serif">[⇑AltoFile]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">entrySize: file </span><span style="font: 10pt serif">["entry size in words" ⇑1 + (file fileSize / 2)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">Insert: file </span><span style="font: 10pt serif">| sn page [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">file serialNumber: (sn &larr; self allocateSN: file).<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">allocate a new page (more success after O.S. stuff, bittable etc.)</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self allocate: (page &larr; file newPage) after: 800.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">write 0th -- leader, in the process filling it in and then creating first page</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">page init; serialNumber: sn; length: page dataLength.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">file leader: page address; type: write; updateLeader: page.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self addEntry: file]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">nextEntry: file </span><span style="font: 10pt serif">| s elen [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dirFile≡nil⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(file name compare: dirname) = 2⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">return system directory file. known serialNumber and leader</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">file serialNumber: 0100000, 0144; leader: 010000.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑file]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self error: &rsquo;directory not open&rsquo;]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">return the next file entry, ignore deleted entries,<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">and leave dirFile positioned before next entry</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ (s &larr; dirFile nextword) do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">elen &larr; s land: dfmask-1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s allmask: dfmask⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">file readFrom: dirFile.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">dirFile skip: elen*2 - (file fileSize + 2).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑file]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">deleted entry, again</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">dirFile skipwords: elen-1].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">obsolete </span><span style="font: 10pt serif">[⇑dirFile≡nil]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">open </span><span style="font: 10pt serif">| f s a page len elen type [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nil ≠ dirFile⇒ []<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">assume some defaults in case DSHAPE is not in SysDir leader page.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">these should only be needed if the disk is old (and not scavenged).<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">they will not work if a 14 sector system is missing DSHAPE (unlikely) since addresses of first page of directory and of DiskDescriptor might be computed incorrectly.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">in a Smalltalk-76 system, nSectors, diskPages had better eventually match:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">| a. a &larr; Vmem specialLocs◦13. mem◦(a+5), (mem◦(a+6))<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nSectors &larr; 12.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">diskPages &larr; 812*nSectors.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">totalPages &larr; 2*diskPages.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">read SysDir leader page to find out file system configuration.  see AltoFileSys.D</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f &larr; self find: dirname.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">to prevent address of page 1 from being stored</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f pageAddresses: false.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">length of property list, in words</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">page &larr; f read: 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">len &larr; page◦494.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[len ≠ 210⇒ []<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">scan file properties for DSHAPE</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s &larr; page asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">s skipwords: page◦493.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ len &gt; 0 do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">type &larr; s next.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">type = 0⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">0 terminates list.  property not found. try to read if from DiskDescriptor"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">len &larr; 0]<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">elen &larr; s next.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">type = 1 and⦂ elen = 5⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">DSHAPE. read property</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self configure: s.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">set flags so configure and loop are not done again</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s &larr; false. len &larr; 0]<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">skip over other property</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">len &larr; len - elen.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s skipwords: elen-1]].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">now, with the correct (or default) file system configuration,<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">store the virtual address of next page (1), and create a FileStream on SysDir</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">a &larr; AltoFileAddressTable new.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">a◦1 &larr; page header: nextp.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f pageAddresses: a.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(dirFile &larr; f asStream) readonly.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(bitsFile &larr; self oldFile: &rsquo;DiskDescriptor&rsquo;) readwrite.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[s⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">configuration not read from SysDir. this will work for 12 sector systems.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">14 sector systems should have had the DSHAPE property</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self configure: bitsFile]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">super open.<br>]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">Position &larr; entry </span><span style="font: 10pt serif">| name elen s holepos holesize entrysize nlen sk [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">entry format<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">1</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">n (length in words, including this one) + undeleted bit (dfmask)<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">2-3</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">serialNumber<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">4</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">version<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">5</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">0?<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">6</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">virtual address of page 0<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">7-n name as Bcpl string (extra 0 if length even)</span><span style="font: 10pt serif">"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">name &larr; entry name.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dirFile≡nil and⦂ (name compare: dirname) = 2⇒ [⇑true]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self reset.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">holepos &larr; false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">holesize &larr; dfmask.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nlen &larr; name length.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">entrysize &larr; self entrySize: entry "</span><span style="font: italic 10pt serif">desired entry size</span><span style="font: 10pt serif">".<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ (s &larr; dirFile nextword) do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">entry length in words</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">elen &larr; s land: dfmask-1.<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[entrysize &gt; elen⇒ ["</span><span style="font: italic 10pt serif">entry too small</span><span style="font: 10pt serif">" sk &larr; ¬2]<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">s = elen⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">deleted entry. check hole size for later inserting or renaming</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">sk &larr; ¬2.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">elen &lt; holesize⇒[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">hole is the smallest so far</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">holesize &larr; elen. holepos &larr; dirFile position]]<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">normal entry, big enough</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">dirFile skip: 10.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nlen ≠ dirFile next⇒ ["</span><span style="font: italic 10pt serif">name wrong size</span><span style="font: 10pt serif">" sk &larr; ¬13]<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">sk &larr; ¬13 - nlen.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(name compare: (dirFile next: nlen)) = 2⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">name match, position back to beginning of entry</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">dirFile skip: sk.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑entry]].<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">sk is the character offset from the entry header word to the next entry</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">dirFile skip: elen*2 + sk].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[holepos⇒ [dirFile position &larr; holepos-2] "</span><span style="font: italic 10pt serif">at end of dirFile</span><span style="font: 10pt serif">"].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">release </span><span style="font: 10pt serif">[dirFile &larr; bitsFile &larr; nil]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">reset </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[self obsolete⇒ [self open] self flush].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dirFile readonly; reset]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>FileDirectory</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">allocateSN: file </span><span style="font: 10pt serif">| sn [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitsFile position &larr; 010.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sn &larr; bitsFile next: 4.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(sn word: 2 &larr; (sn word: 2) + 1) = 0⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">overflow</span><span style="font: 10pt serif">" sn word: 1 &larr; (sn word: 1) + 1]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitsFile skip: ¬4; append: sn.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑sn]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">checkName: s </span><span style="font: 10pt serif">[⇑self checkName: s fixing: false]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">realToVirtual: adr </span><span style="font: 10pt serif">["see </span><span style="font: bold 10pt serif">virtualToReal:</span><span style="font: 10pt serif">.<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">Alto address format is<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">bits<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">0-3</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">sector number (0 - 015, i.e. 12 or 14 sectors)<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">4-12</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">cylinder number (0 - 0312, Model 31; 0-0625, Model 44)<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">13</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">head number (0-1)<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">14</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">disk number</span><span class="tab" val="79"></span><span style="font: italic 10pt serif">(0-1)<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">15</span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">restore bit.<br><br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">in a system with two separable disks, addresses on disk 1 have a 0 disk bit, which is complemented by the disk primitive</span><span style="font: 10pt serif">"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑"vadr &larr;" ("</span><span style="font: italic 10pt serif">sector: field</span><span style="font: 10pt serif">" adr lshift: ¬12) +<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">("</span><span style="font: italic 10pt serif">cylinder and head: field*</span><span style="font: 10pt serif">" nSectors * ((adr land: 07774) lshift: ¬2)) +<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">("</span><span style="font: italic 10pt serif">disk: field*pages per disk</span><span style="font: 10pt serif">" [(adr land: 2) = 2⇒ [diskPages] 0]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"diskPages*(adr land: 2)/2")<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"vadr &lt; 0 or⦂ vadr ≥ totalPages⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self error: &rsquo;illegal disk address&rsquo;]"]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">rename: file newName: newName </span><span style="font: 10pt serif">| holesize pos [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[newName &larr; self checkName: newName⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self position &larr; newName⇒ [self error: &rsquo;new name already exists: &rsquo; + newName]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">a possible insertion place</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pos &larr; dirFile position]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self error: &rsquo;illegal new name: &rsquo; + newName].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self Find: (file &larr; self makeEntry: file)⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">holesize &larr; dirFile nextword land: dfmask-1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">dirFile skip: ¬2.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">file name: newName.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(self entrySize: file "</span><span style="font: italic 10pt serif">new size of entry</span><span style="font: 10pt serif">") ≤ holesize⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">new entry will fit in current entry</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pos &larr; dirFile position.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">read and save entry</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self nextEntry: file]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">delete and save entry</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self deleteEntry: file].<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">position to same entry or hole discovered earlier</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">dirFile position &larr; pos.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self addEntry: (file name: newName).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">file type is: Integer⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"file is open. defer leader page change until someone closes it"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">file type: write]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"close file: updating name in leader page" file type: write; close]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">file error: &rsquo;rename: old name does not exist&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">virtualToReal: vadr </span><span style="font: 10pt serif">| t2 d ["</span><span style="font: italic 10pt serif">inverse of </span><span style="font: bold 10pt serif">realToVirtual:</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"vadr &lt; 0 or⦂ vadr ≥ totalPages⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self error: &rsquo;illegal virtual address&rsquo;]"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"faster to do /\ for normal Integers"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"t &larr; vadr intdiv: diskPages.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">sec &larr; t◦2 intdiv: nSectors"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[vadr &lt; diskPages⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">d &larr; 0.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">t2 &larr; vadr]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">d &larr; 2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">t2 &larr; vadr \ diskPages].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑("</span><span style="font: italic 10pt serif">sector</span><span style="font: 10pt serif">" (t2 \ nSectors) lshift: 12) +<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">("</span><span style="font: italic 10pt serif">cylinder & head</span><span style="font: 10pt serif">" (t2 / nSectors) lshift: 2) +<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">("</span><span style="font: italic 10pt serif">disk</span><span style="font: 10pt serif">" d "(vadr / diskPages) lshift: 1")]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Alto</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">addEntry: file </span><span style="font: 10pt serif">| entrysize holesize [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">called only by </span><span style="font: bold 10pt serif">Insert:</span><span style="font: italic 10pt serif"> and </span><span style="font: bold 10pt serif">rename:newName:</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[holesize &larr; dirFile nextword⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">either a deleted entry or rename entry</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">holesize &larr; holesize land: dfmask-1.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">dirFile skip: ¬2]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">at end</span><span style="font: 10pt serif">"].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">entrysize &larr; self entrySize: file.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dirFile readwrite;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">nextword &larr; entrysize + dfmask.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">file storeOn: dirFile.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[holesize and⦂ entrysize &lt; holesize⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">mark remaining hole</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">dirFile nextword &larr; holesize-entrysize]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dirFile readonly.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitsFile flush]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">allocate: nextPage after: address </span><span style="font: 10pt serif">| index stop ch m vadr [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">index &larr; false.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ true do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">go around bittable from address to end, and beginning to address.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">we start over again if the table appears full or bitsFile is out of sync</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[index and⦂ stop ≥ totalPages⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"wrap around to where we started"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">stop &larr; address.</span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">index &larr; 0]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[index ≡ false⇒ ["</span><span style="font: italic 10pt serif">first time or bitsFile out of sync</span><span style="font: 10pt serif">"]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">disk probabbly full</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user quitThen:<br>&rsquo;//   YOUR DISK IS FULL - Please make some space available.<br>//   Then resume Smalltalk and interrupt or continue as desired...&rsquo;].<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">self open.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">index by bits rather than bytes? close enough for now</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">index &larr; address land: 0177770.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">stop &larr; totalPages].<br><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitsFile position &larr; index/8 + boffset.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">while⦂ (index and⦂ (index &larr; index+8) ≤ stop) do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(ch &larr; bitsFile next) = 0377⇒ ["</span><span style="font: italic 10pt serif">8 full</span><span style="font: 10pt serif">"]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">check that bitsFile position is correct --<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">possibly out of sync with index if  growSmalltalkBy: occurred?</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitsFile position ≠ (index/8 + boffset)⇒ [index &larr; false]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">m &larr; 0200.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ vadr from: index-8 to: index-1 do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[(ch land: "nomask:" m) = 0⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">page appears free. first update DiskDescriptor</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitsFile skip: ¬1; next &larr; ch &larr; ch lor: m.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"then check if page is really free"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">vadr=0⇒ ["</span><span style="font: italic 10pt serif">O.S. boot</span><span style="font: 10pt serif">"]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">([nextPage init; freePage;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">address: (self virtualToReal: vadr);<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">doCommand: CCR error: false])⇒ [⇑vadr]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">page not really free</span><span style="font: 10pt serif">"]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">page not free according to bit</span><span style="font: 10pt serif">"].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">m &larr; m lshift: ¬1].<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">]]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">checkName: fname fixing: fixing </span><span style="font: 10pt serif">| x copy special [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fname empty⇒[<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">fixing⇒ [⇑&rsquo;$&rsquo;]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"empty name" ⇑false]<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[fname length &gt; 38⇒<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">[fixing⇒ [fname &larr; fname◦(1 to: 38)]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"name too long" ⇑false]].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">copy &larr; (String new: fname length+1) asStream.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">special &larr; &rsquo;.-+$!?&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ x from: fname do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"check characters: alphanumeric or 6 special"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">x isletter or⦂ ((special has: x) or⦂ x isdigit) ⇒ [copy next &larr; x]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">fixing⇒ [copy next &larr; special◦2]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"illegal character" ⇑false].<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[fixing⇒ [fname last = (special◦1)⇒ [copy skip: ¬1]]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">fname last ≠ (special◦1)⇒ [copy next &larr;  special◦1]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑copy contents]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">configure: s </span><span style="font: 10pt serif">| nDisks nHeads nTracks [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"read disk configuration from a Stream:<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">either leader page of SysDir or beginning of DiskDescriptor"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nDisks &larr; s nextword.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nTracks &larr; s nextword.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nHeads &larr; s nextword.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">nSectors &larr; s nextword.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">diskPages &larr; nTracks * nHeads * nSectors.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">totalPages &larr; nDisks * diskPages]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">deallocate: page </span><span style="font: 10pt serif">| index ch m [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">[dirFile≡nil⇒ [self open]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">index &larr; self realToVirtual: page address.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">character position</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitsFile position &larr; index/8 + boffset.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">ch &larr; bitsFile next.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">bit position</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">m &larr; 0200 lshift: 0-(index land: 7).<br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">"make page free by turning off bit in DiskDescriptor"</span><span style="font: 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(ch land: m) = m⇒ [bitsFile skip: ¬1; next&larr; ch - m]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">user cr; show: &rsquo;page already free (dealloc:)&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">deleteEntry: file </span><span style="font: 10pt serif">| p [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">called only by </span><span style="font: bold 10pt serif">Delete:</span><span style="font: italic 10pt serif"> and </span><span style="font: bold 10pt serif">rename:newName:</span><span style="font: italic 10pt serif"><br></span><span class="tab" val="79"></span><span style="font: italic 10pt serif">read and save</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">p &larr; dirFile position.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self nextEntry: file.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dirFile position &larr; p.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">delete it from directory (turn off bit in entry length word)</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">p &larr; dirFile nextword land: dfmask-1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">dirFile skip: ¬2; readwrite; nextword &larr; p; readonly; skip: ¬2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑file]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">diskID </span><span style="font: 10pt serif">| f u [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">return user name and disk name installed in O.S.</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">(f &larr; self oldFile: &rsquo;sys.boot&rsquo;) readonly; position &larr; 512.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">u &larr; f nextString.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f padNext.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">u &larr; u, f nextString.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">f close.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑u]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">diskNumber </span><span style="font: 10pt serif">["directory is: Integer⇒ [" ⇑directory "] ⇑directory diskNumber"]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">filesMatching: pattern </span><span style="font: 10pt serif">| files v i [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">files &larr; self match: [pattern last = (&rsquo;.&rsquo;◦1)⇒ [pattern] pattern + &rsquo;.&rsquo;].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">v &larr; Vector new: files length.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i to: v length do⦂ [v◦i &larr; (files◦i) name].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑v]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">flush </span><span style="font: 10pt serif">[bitsFile≡nil⇒ [] bitsFile flush]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">freePages </span><span style="font: 10pt serif">| npages ch i [<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self open.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">bitsFile position &larr; boffset.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">npages &larr; 0.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">for⦂ i from: 1 to: totalPages by: 8 do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">(ch &larr; bitsFile next) =0377⇒ ["</span><span style="font: italic 10pt serif">all used</span><span style="font: 10pt serif">"]<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">possibly up to 8 unused</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">npages &larr; npages+8.<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ ch = 0 do⦂ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">npages &larr; npages - (ch land: 1).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">ch &larr; ch lshift: ¬1]].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">⇑npages]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">growSmalltalkBy: n </span><span style="font: 10pt serif">| zfpt i file page a zlen ["dp0 growSmalltalkBy: 100."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">find and read last page of small.boot, then extend file</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">i &larr; 1. zlen&larr; 96.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">zfpt &larr; CoreLocs new base: (Vmem specialLocs◦7) length: zlen*2.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">until⦂ zfpt◦(i+zlen) = 0 do⦂ [i &larr; i+1].<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">a &larr; (zfpt◦(i+zlen-1)) + (zfpt◦i) - (zfpt◦(i-1)) - 1.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self open.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">file &larr; self makeEntry: &rsquo;small.boot.&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">page &larr; file newPage.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">page address: (self virtualToReal: a);<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">doCommand: CRR error: &rsquo;cannot read last page. growSmalltalkBy:&rsquo;.<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">bypass reading file and creating random access table, just extend it</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">page lastPage⇒ [<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">file serialNumber: page serialNumber;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">lastPage: page pageNumber;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">pageAddresses: false "</span><span style="font: bold 10pt serif">Read:, Write:</span><span style="font: italic 10pt serif"> check this</span><span style="font: 10pt serif">";<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">Get: (page pageNumber: page pageNumber+n).<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">user space; print: self freePages; show: &rsquo; pages left.&rsquo;]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">self error: &rsquo;growSmalltalkBy:. last page not last or 2 successive user grows&rsquo;]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">stampBoot </span><span style="font: 10pt serif">| a file page ["dp0 stampBoot."<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"update the time stamps in leader page of current boot file"<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"find SafeId for current boot file"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">a &larr; Vmem specialLocs◦13.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">file &larr; self makeEntry: &rsquo;&rsquo;.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">file serialNumber: mem◦a, (mem◦(a+1)).<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"read page one of the boot file to find out the leader address"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">page &larr; file makeEntry: 1.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">page address: mem◦(a+4).<br><br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"then set leader address and dirty flag, and close file<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">thereby updating create/write/read dates, but not name"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">file doCommand: CCR page: page error: &rsquo;cannot read page 1 of boot file&rsquo;;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">leader: (page header: backp);<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">type: write;<br></span><span class="tab" val="79"></span><span class="tab" val="79"></span><span style="font: 10pt serif">close]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪AltoFileDirectory under: &rsquo;Alto File System&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>"AltoFilePage"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif">Class new title: &rsquo;AltoFilePage&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">subclassof: FilePage<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">fields: &rsquo;address&rsquo;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">declare: &rsquo;&rsquo;;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">sharing: AltoFilePool;<br></span><span class="tab" val="79"></span><span style="font: bold 12pt serif">asFollows</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: italic 10pt serif"><br>A FilePage from an AltoFile consists of a header (2 words), a label (8 words) and data (512 characters)</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>FilePage</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">address </span><span style="font: 10pt serif">[⇑address]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">address: address</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">headerLength </span><span style="font: 10pt serif">[⇑16]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">init </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">page ≡ nil⇒ [super init]<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">nextp, backp, lnused, numch, pn</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">page fill: 1 to: 10 with: 0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">lastPage </span><span style="font: 10pt serif">[⇑("self header:" page word: nextp) = 0]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">length </span><span style="font: 10pt serif">[⇑"self header:" page word: numch]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">length: len </span><span style="font: 10pt serif">["self header:" page word: numch &larr; len]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pageNumber </span><span style="font: 10pt serif">[⇑"self header:" page word: pagen]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">pageNumber: pn </span><span style="font: 10pt serif">["self header:" page word: pagen &larr; pn]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">serialNumber </span><span style="font: 10pt serif">[⇑page◦(13 to: 16)]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">serialNumber: sn </span><span style="font: 10pt serif">["page◦(13 to: 16) &larr; sn"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">page copy: 13 to: 16 with: sn from: 1 to: 4.<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"self header:" page word: vn &larr; 1 "fixed version"]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Alto</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 10pt serif">freePage </span><span style="font: 10pt serif">[<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">"</span><span style="font: italic 10pt serif">label for a free page: version, sn1, sn2 = ¬1</span><span style="font: 10pt serif">"<br></span><span class="tab" val="79"></span><span style="font: 10pt serif">page fill: 11 to: 16 with: 0377]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif"></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt serif">SystemOrganization classify: ↪AltoFilePage under: &rsquo;Alto File System&rsquo;.</span></div>
<script>function do_tabs() { // unit = px
  var tabs = document.getElementsByClassName("tab");
  for (var i = 0; i < tabs.length; ++i) {
    var span = tabs[i];
    var val = span.getAttribute("val");
    if (val == null) console.log("Couldn't get val");
    var rect = span.getBoundingClientRect();
    var tabstop;
    if (val > 0) tabstop = Math.ceil(rect.left / val) * val;
    else tabstop = -val;
    console.log("do_tabs", val, tabstop)
    if (tabstop > 0) {
      var width = tabstop - rect.left;
      span.style.display = "inline-block";
      span.style.width = width + "px";
    }
  }
}
do_tabs();
</script>
  </body>
</html>
