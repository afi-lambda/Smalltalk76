<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN">
<html>
  <head>
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
    <title>bootstrap2.st</title>
  </head>
  <body>
    <div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: center">
<span style="font: 10pt greek">↪</span><span style="font: bold 12pt serif">READ ROUTINE</span><span style="font: 10pt greek">↪</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt greek">Smalltalk define "Readerstuff as "Readerstuff &larr; SymbolTable new.<br>Readerstuff insertall: "(typetable scantable dot<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">separ letter digit notapos notcomnt notcr).<br></span><span style="font: bold 12pt serif"><br>Class new title: &rsquo;Reader&rsquo;;<br></span><span class="tab" val="24"></span><span style="font: bold 12pt serif">fields: &rsquo;source sink token nextchar typetbl scantbl&rsquo;</span><span style="font: 10pt serif">;<br></span><span class="tab" val="24"></span><span style="font: bold 12pt serif">sharing: &rsquo;Readerstuff&rsquo;<br></span><span style="font: 10pt greek">Reader understands: &rsquo;</span><span style="font: 10pt greek; text-decoration: underline">of:</span><span style="font: 10pt greek"> source<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">[typetbl &larr; typetable.  scantbl &larr; scantable.<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">sink &larr; (Vector new: 10) asStream. token &larr; Stream default.<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">self step]&rsquo;<br>Reader understands: &rsquo;</span><span style="font: 10pt greek; text-decoration: underline">step</span><span style="font: 10pt greek"><br></span><span class="tab" val="24"></span><span style="font: 10pt greek">[nextchar &larr; source next]&rsquo;</span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">↪</span><span style="font: italic 10pt serif">nextchar avoids backing up</span><span style="font: 10pt greek">↪<br>Reader understands: &rsquo;</span><span style="font: 10pt greek; text-decoration: underline">read</span><span style="font: 10pt greek"> | x <br></span><span class="tab" val="24"></span><span style="font: 10pt greek">[while⦂ nextchar do⦂<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">[x &larr; typetbl◦(nextchar+1).<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">x=1? [self scan: separ];</span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">↪</span><span style="font: italic 10pt serif">separators</span><span style="font: 10pt greek">↪<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">=2? [sink next &larr; (self scan: letter+digit) unique];</span><span class="tab" val="24"></span><span style="font: 10pt greek">↪</span><span style="font: italic 10pt serif">identifiers</span><span style="font: 10pt greek">↪<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">=3? [sink next &larr; (self scan: 0) unique]; ↪</span><span style="font: italic 10pt serif">1-char tokens</span><span style="font: 10pt greek">↪<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">=4? [sink next &larr; self rdnum. dot?[sink next&larr; ".]];</span><span class="tab" val="24"></span><span style="font: 10pt greek">↪</span><span style="font: italic 10pt serif">Numbers</span><span style="font: 10pt greek">↪<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">=5? [sink next &larr; self rdstr];</span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">↪</span><span style="font: italic 10pt serif">Strings</span><span style="font: 10pt greek">↪<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">=6? [self step. sink next &larr; self subread];</span><span class="tab" val="24"></span><span style="font: 10pt greek">↪</span><span style="font: italic 10pt serif">sub-Vectors</span><span style="font: 10pt greek">↪<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">=7? [self step. !sink contents];</span><span class="tab" val="24"></span><span style="font: 10pt greek">↪</span><span style="font: italic 10pt serif">close-paren</span><span style="font: 10pt greek">↪<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">=8? [self rdcom];</span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">↪</span><span style="font: italic 10pt serif">comments</span><span style="font: 10pt greek">↪<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">=9? [self scan: notcr];</span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">↪</span><span style="font: italic 10pt serif">&uarr;Z format runs</span><span style="font: 10pt greek">↪<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">=10? [!sink contents];</span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">↪</span><span style="font: italic 10pt serif">null and DOIT</span><span style="font: 10pt greek">↪<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">]<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">!sink contents]&rsquo;<br>Reader understands: &rsquo;</span><span style="font: 10pt greek; text-decoration: underline">scan:</span><span style="font: 10pt greek"> mask | x<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">[mask=0 ?[x &larr; String new: 1. x◦1 &larr; nextchar. self step. !x]<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">token reset.<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">while⦂ nextchar do⦂<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">[(mask land: scantbl◦(nextchar+1))=0? [!token contents]<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">token next &larr; nextchar. nextchar &larr; source next]<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">!token contents]&rsquo;<br>Reader understand</span><span style="font: 10pt greek; text-decoration: underline">s: &rsquo;sub</span><span style="font: 10pt greek">read | a b <br></span><span class="tab" val="24"></span><span style="font: 10pt greek">[a &larr; sink.  sink &larr; (Vector new: 10) asStream.<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">b &larr; self read.  sink &larr; a.  !b]&rsquo;<br>Reader understand</span><span style="font: 10pt greek; text-decoration: underline">s: &rsquo;r</span><span style="font: 10pt greek">dnum | sign val d <br></span><span class="tab" val="24"></span><span style="font: 10pt greek">[sign &larr; [nextchar=025? [self step. ¬1] 1</span><span style="font: italic 10pt serif">].</span><span class="tab" val="24"></span><span style="font: italic 10pt serif">↪</span><span style="font: 10pt greek">sign↪<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">d &larr; [nextchar=060? [8] 10].</span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: italic 10pt serif">↪</span><span style="font: 10pt greek">base↪<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">val &larr; self mknum: (self scan: digit) base: </span><span style="font: italic 10pt serif">d.</span><span class="tab" val="24"></span><span style="font: italic 10pt serif">↪integer </span><span style="font: 10pt greek">part↪<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">dot &larr; false.<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">nextchar=056</span><span style="font: italic 10pt serif">?</span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: italic 10pt serif">↪check for decimal p</span><span style="font: 10pt greek">oint↪<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">[self step.<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">nextchar isdigit≡false?<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">[dot &larr; true. !sign*val</span><span style="font: italic 10pt serif">]</span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: italic 10pt serif">↪was &lt;Integer</span><span style="font: 10pt greek">&gt; .  ↪<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">d &larr; self scan: digit.<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">val &larr; (self mknum: d base: 10)asFloat / (10.0 ipow: d length) + val.<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">nextchar=0145</span><span style="font: italic 10pt serif">?</span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: italic 10pt serif">↪check for e&lt;expon</span><span style="font: 10pt greek">ent&gt; ↪<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">[self step.  !val*(10.0 ipow: self rdnum)*sign]<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">!val*sign]<br> </span><span class="tab" val="24"></span><span style="font: 10pt greek">!sign*val]&rsquo;<br>Reader understand</span><span style="font: 10pt greek; text-decoration: underline">s: &rsquo;mk</span><span style="font: 10pt greek">num: </span><span style="font: 10pt greek; text-decoration: underline">str b</span><span style="font: 10pt greek">ase: base | val c <br></span><span class="tab" val="24"></span><span style="font: 10pt greek">[val &larr; [str length&gt;4? [0.0] 0].<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">for⦂ c from: str do⦂<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">[val &larr; val*base + (c-060)]<br> </span><span class="tab" val="24"></span><span style="font: 10pt greek">!val]&rsquo;<br>Reader understand</span><span style="font: 10pt greek; text-decoration: underline">s: &rsquo;r</span><span style="font: 10pt greek">dstr | a <br></span><span class="tab" val="24"></span><span style="font: 10pt greek">[self step. a &larr; self scan: notapos.<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">nextchar ≡ false? [user notify: &rsquo;&rsquo;Unmatched String quote&rsquo;&rsquo;]<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">self step.<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">nextchar=04</span><span style="font: italic 10pt serif">7?</span><span class="tab" val="24"></span><span style="font: italic 10pt serif">↪imbedded String-q</span><span style="font: 10pt greek">uote↪<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">[token next &larr; 047. a&larr; token contents<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">!a + self rdstr]<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">!a]&rsquo;<br>Reader understand</span><span style="font: 10pt greek; text-decoration: underline">s: &rsquo;r</span><span style="font: 10pt greek">dcom <br></span><span class="tab" val="24"></span><span style="font: 10pt greek">[self step.  self scan: notcomnt.<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">nextchar≡false? [user notify: &rsquo;&rsquo;Unmatched comment quote&rsquo;&rsquo;]<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">self step]&rsquo;<br><br>"Readerinit &larr; function (type bit asc1 asc2 typetbl scantbl i)</span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">↪init read tables in-line↪<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">("type &larr; :. "bit &larr; ⦂. (bit=0?() "bit &larr; Readerstuff◦bit).<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">"asc1 &larr; :. "asc2 &larr; (%to?(:) asc1).<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">"typetbl &larr; Readerstuff◦"typetable. "scantbl &larr; Readerstuff◦"scantable.<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">(type=0?() for i&larr; asc1+1 to asc2+1 do (typetbl[i]   &larr; type)).<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">for i&larr; asc1+1 to asc2+1 do<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">(scantbl[i] &larr; scantbl[i] &- bit)<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">Readerstuff◦"typetable set typetbl. Readerstuff◦"scantable set scantbl.<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">!nil).<br>Readerstuff insertall: "(separ letter digit notapos notcr notcomnt)<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">with: "(1 2 4 8 16 32).<br>Readerstuff define "typetable as string 256.<br>Readerstuff◦"typetable[1 to 256] &larr; all 3.</span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">↪1-char tokens↪<br>Readerstuff define "scantable as string 256.<br>Readerstuff◦"scantable[1 to 256] &larr; all 8+16+32.<br>Readerinit 0  notcr  015. ↪cr↪<br>Readerinit 1  separ  011  ↪separators: tab, ↪<br>Readerinit 1  separ  012  ↪ LF, ↪<br>Readerinit 1  separ  014  ↪ FF, ↪<br>Readerinit 1  separ  015  ↪ CR, ↪<br>Readerinit 1  separ  040  ↪ blank ↪<br>Readerinit 2  letter  0101 to 0132  ↪letters↪<br>Readerinit 2  letter  0141 to 0172</span><span class="tab" val="24"></span><span style="font: 10pt greek">↪lower-case↪<br>Readerinit 3  letter  072</span><span class="tab" val="24"></span><span style="font: 10pt greek">↪colon↪<br>Readerinit 3  letter  03</span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">↪open colon↪<br>Readerinit 4  digit  060 to 071  ↪digits↪<br>Readerinit 4  0  025  ↪high-minus↪<br>Readerinit 5  notapos  047  ↪String-quote↪<br>Readerinit 6  0  050  ↪left-paren↪<br>Readerinit 7  0  051  ↪close-paren↪<br>Readerinit 8  notcomnt  017  ↪comments↪<br>Readerinit 9  0  032 ↪&uarr;Z format runs↪<br>Readerinit 10  0  036  ↪null and DO</span><span style="font: 10pt serif">IT↪<br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: center">
<span style="font: 10pt serif"><br></span><span style="font: 10pt greek">↪</span><span style="font: bold 12pt serif">BYTE COMPILER</span><span style="font: 10pt greek">↪</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: 10pt greek">Smalltalk define "Compilerstuff as "Compilerstuff &larr; SymbolTable new.<br>Compilerstuff insertall: "(cdict opdict initcdict initopdict selector nargs ntemps maxtemp<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">environment literals precode stack maxstack canoptpop).<br>Compilerstuff define "trace as false<br>Compilerstuff insertall: "(instcode tempcode litcode liticode areccode constcode selfcode nilcode<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">smashpcode smashcode popcode returncode endcode curcode supercode<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">shortjmp shortbfp jmpcode bfpcode minopcode opcode)<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">with: "(0 16 32 64 112 120 113 125<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">128 129 130 131 132 133 134<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">144 152 160 168 176 208).<br></span><span style="font: bold 12pt serif"><br>Class new title: &rsquo;Compiler&rsquo;;<br></span><span class="tab" val="24"></span><span style="font: bold 12pt serif">fields: &rsquo;source code cascading stackused fixups&rsquo;</span><span style="font: 10pt serif">;<br></span><span class="tab" val="24"></span><span style="font: bold 12pt serif">sharing: &rsquo;Compilerstuff&rsquo;<br></span><span style="font: 10pt greek">Compiler understands: &rsquo;</span><span style="font: 10pt greek; text-decoration: underline">compile:</span><span style="font: 10pt greek"> b </span><span style="font: 10pt greek; text-decoration: underline">in:</span><span style="font: 10pt greek"> class | a c i t<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">[self init: class.  a &larr; b asVector asStream.<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">self compilepattern: a.</span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">↪pattern and decls↪<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">self compileblock: a. self push.</span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">↪Smalltalk code↪<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">[self nofixups?[]</span><span class="tab" val="24"></span><span style="font: 10pt greek">↪no redundant return↪<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">[stack=maxstack?[self popopt]].<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">code next&larr; selfcode. code next&larr; returncode].<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">[<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">c &larr; [a %"primitive: ?[a next] 0].</span><span class="tab" val="24"></span><span style="font: 10pt greek">↪primitive: &lt;integer&gt; clause↪<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">a&larr; self qcodeck: c ? []</span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">↪ckeck for rd/wrt accessors↪<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">a &larr; Stream default.</span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">↪now make up code object↪<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">a next&larr; 0; next&larr; c; next&larr; maxtemp+maxstack.</span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">↪header↪<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">a next&larr; nargs; next&larr; maxtemp; next&larr; 6+(2*literals length).<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">for⦂ i from: literals do⦂</span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">↪literals↪<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">[a next&larr; i PTR lshift: ¬8; next&larr; i PTR land: 0377]<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">a append: precode contents; append: code contents.</span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">↪code body↪<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">].<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">class install: selector<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">method: (code&larr;a contents) literals: [literals length&gt;0?[literals] nil]<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">code: b backpointers: nil.<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">!selector]&rsquo;<br>Compiler understands: &rsquo;</span><span style="font: 10pt greek; text-decoration: underline">qcodeck:</span><span style="font: 10pt greek"> t | a b i</span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">↪fast read/write accessors↪<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">[t≠0?[!false] code loc≠2?[!false]<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">a &larr; Stream default. a next&larr; 0.<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">code◦2≠returncode? [!false]<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">code◦1≠selfcode?<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">[code◦1&lt;tempcode?<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">[precode empty?<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">[a next&larr; 40; next&larr; 0; next&larr; 0; next&larr; code◦1. !a]</span><span class="tab" val="24"></span><span style="font: 10pt greek">↪quick !inst var↪<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">!false]<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">!false]<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">precode empty?[a next&larr; 1. !a]</span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">↪quick !self↪<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">b &larr; precode contents. nargs≠b length/3?[!false]<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">a next&larr; 41; next&larr; 0; next&larr;  b length/3.<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">for⦂ i from: (3 to: b length by: 3) do⦂<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">[b◦i&lt;tempcode?[a next&larr; b◦i] !false]</span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">↪write inst vars↪<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">!a]&rsquo;<br>Compiler understands: &rsquo;</span><span style="font: 10pt greek; text-decoration: underline">init:</span><span style="font: 10pt greek"> class | a i<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">[environment &larr; class environment.<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">[initcdict≡nil?</span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">↪initial symbol defs↪<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">[initcdict &larr; Dictionary new init: 16.<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">initcdict insertall: "(self thisContext super nil false true)<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">with: "(113 133 134 125 126 127).<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">initopdict &larr; Dictionary new init: 64.<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">initopdict insertall: "(+ - &lt; &gt; ≤ ≥ = ≠<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">* / \ | min: max: land: lor:<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">◦ '&#771;&rsquo;◦&larr;&rsquo;&rsquo;atomize) next '&#771;&rsquo;next&larr;&rsquo;&rsquo;atomize) length ≡<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">class and: or: new new: to: oneToMeAsStream asStream)<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">with: "(176 177 178 179 180 181 182 183<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">184 185 186 187 188 189 190 191<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">192 193 194 195 196 197<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">200 201 202 203 204 205 206 207)] ].<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">cdict &larr; Dictionary new copyfrom: initcdict.<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">opdict &larr; Dictionary new copyfrom: initopdict.<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">a &larr; class instvars. for⦂ i to: a length do⦂<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">[cdict insert: a◦i with: instcode+i-1].<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">stack&larr; ntemps&larr; maxtemp&larr; 0. maxstack&larr; 1.<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">precode &larr; Stream default.<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">literals &larr; Vector new: 0]&rsquo;<br><br>Compiler understands: &rsquo;</span><span style="font: 10pt greek; text-decoration: underline">compilepattern:</span><span style="font: 10pt greek"> a | c<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">[ntemps &larr; 0. selector &larr; a peek.<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">[selector iskeyword?</span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">↪selector and args↪<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">[c &larr; nullString.<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">until⦂ [a end or: a peek iskeyword ≡ false] do⦂</span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">↪keywords↪<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">[c &larr; c+ a next.<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">self compilearg: a next]<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">selector &larr; c unique]<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">a next.<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">selector isinfix?</span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">↪infix↪<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">[self compilearg: a next]<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">].<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">[a % "&larr; ?</span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">↪possible &larr; phrase↪<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">[selector &larr; (selector + &rsquo;&rsquo;&larr;&rsquo;&rsquo;) unique.<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">self compilearg: a next]<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">].<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">nargs &larr; ntemps.<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">a % "| ?</span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">↪further temp declarations↪<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">[until⦂ [a end or: "[=a peek] do⦂<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">[self compiletemp: a next]]]&rsquo;<br>Compiler understands: &rsquo;</span><span style="font: 10pt greek; text-decoration: underline">compilearg:</span><span style="font: 10pt greek"> a | b<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">[b &larr; self newtemp.<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">cdict has: a?<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">[precode next&larr; b.</span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">↪compile assignments↪<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">precode next&larr; smashpcode.</span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">↪for non-temp args↪<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">precode next&larr; cdict◦a.  maxstack &larr; 1]<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">cdict insert: a with: b]&rsquo;<br>Compiler understands: &rsquo;</span><span style="font: 10pt greek; text-decoration: underline">compiletemp:</span><span style="font: 10pt greek"> a | b<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">[b &larr; self newtemp.<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">cdict has: a?<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">[user notify: &rsquo;&rsquo;temp name used elsewhere: &rsquo;&rsquo;+a asString]<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">cdict insert: a with: b]&rsquo;<br>Compiler understands: &rsquo;</span><span style="font: 10pt greek; text-decoration: underline">newtemp</span><span style="font: 10pt greek"><br></span><span class="tab" val="24"></span><span style="font: 10pt greek">[maxtemp &larr; maxtemp max: (ntemps &larr; ntemps+1).<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">!tempcode + ntemps-1]&rsquo;<br><br>Compiler understands: &rsquo;</span><span style="font: 10pt greek; text-decoration: underline">compileblock:</span><span style="font: 10pt greek"> source | a b c inblock<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">[cascading &larr; false.<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">code &larr; Stream default. fixups &larr; (Vector new: 0) asStream.<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">source end?[!nullString] a &larr; stack.<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">[source %"[? [] <br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">user notify: &rsquo;&rsquo;[ missing before: &rsquo;&rsquo;+source peek asString].<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">while⦂ inblock do⦂<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">[source end?[user notify: &rsquo;&rsquo;unbalanced brackets&rsquo;&rsquo;]<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">source %"] ?[code next&larr; nilcode. self push. inblock &larr; false]<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">source %"! ?[code append: (self compileexpr: source). self push.<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">code next&larr; returncode. source %". . source %"] ?[inblock &larr; false]<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek"> user show:  &rsquo;&rsquo;junk following return stmt&rsquo;&rsquo;. <br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">inblock &larr; false]<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">self controlstmt ?[self uncascade. source %".]<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">canoptpop &larr; true.<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">code append: [cascading?[self compilecascade: source]<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">self compileexpr: source]. self push.<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">source %"] ?[inblock &larr; false]<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">source %"? ?[self pop. c &larr; Compiler new.<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">b &larr; c compileblock: source.<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">[source %"; ?[self cascade]<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">self uncascade. source %".].<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">c nofixups?<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">[code append: (self encodejmp: bfpcode by: b length); append: b]<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">fixups next&larr; code contents; next&larr; b. code reset]<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">[source %"; ?[self cascade]<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">self uncascade.  source %".?[]<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek"> user show: &rsquo;&rsquo;per missing before: &rsquo;&rsquo;+source peek asString ].<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">self pop. self popopt]</span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">↪period pops stack↪<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">self pop. stack≠a?[user notify: &rsquo;&rsquo;unbalanced stack&rsquo;&rsquo;]<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">fixups empty? [!code contents] canoptpop&larr;false.<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">self fixup: code contents and: fixups contents.<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">!code contents]&rsquo;<br>Compiler understands: &rsquo;</span><span style="font: 10pt greek; text-decoration: underline">popopt</span><span style="font: 10pt greek"> | t</span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">↪</span><span style="font: italic 10pt serif">append pop and optimize</span><span style="font: 10pt greek">↪<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">[2&gt;(t&larr;code loc)?[t=1?[code skip: ¬1]]<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">canoptpop≡false? [code next&larr; popcode]<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">code◦t=nilcode?</span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">↪</span><span style="font: italic 10pt serif">jmp1-nil-pop -&gt; pop</span><span style="font: 10pt greek">↪<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">[[code◦(t-1)=shortjmp?[code skip: ¬2]]. code next&larr; popcode]<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">code◦(t-1)=smashcode?<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">[code◦(t-1) &larr; smashpcode]</span><span class="tab" val="24"></span><span style="font: 10pt greek">↪</span><span style="font: italic 10pt serif">sto-var-pop -&gt; stopop var</span><span style="font: 10pt greek">↪<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">code next&larr; popcode]&rsquo;<br>Compiler understands: &rsquo;</span><span style="font: 10pt greek; text-decoration: underline">cascade</span><span style="font: 10pt greek"> | t<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">[cascading?[]</span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">↪</span><span style="font: italic 10pt serif">cascading is either false</span><span style="font: 10pt greek">↪<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">(t &larr; code◦code loc)&lt;minopcode?<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">[user notify: &rsquo;&rsquo;improper cascading [...;].&rsquo;&rsquo;]<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">code◦(code loc-1)&lt;areccode?<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">[cascading &larr; code◦(code loc-1)]</span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">↪</span><span style="font: italic 10pt serif">or = temp code for receiver</span><span style="font: 10pt greek">↪<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">code skip: ¬1. code next&larr; smashcode.</span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">↪</span><span style="font: italic 10pt serif">alloc temp if not simple</span><span style="font: 10pt greek">↪<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">code next&larr; cascading &larr; self newtemp. code next&larr; t]&rsquo;<br>Compiler understands: &rsquo;</span><span style="font: 10pt greek; text-decoration: underline">uncascade</span><span style="font: 10pt greek"><br></span><span class="tab" val="24"></span><span style="font: 10pt greek">[cascading?[cascading&lt;areccode?[cascading &larr; false]<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">ntemps &larr; ntemps-1. cascading &larr; false]]&rsquo;<br>Compiler understands: &rsquo;</span><span style="font: 10pt greek; text-decoration: underline">nofixups</span><span class="tab" val="24"></span><span style="font: 10pt greek">↪</span><span style="font: italic 10pt serif">!true if no jmpout needed</span><span style="font: 10pt greek">↪<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">[fixups empty?</span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">↪...meaning no internal branches↪<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">[code loc=0?[!false]  !code◦code loc=returncode]</span><span class="tab" val="24"></span><span style="font: 10pt greek">↪AND ends with !↪<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">!false]&rsquo;<br>Compiler understands: &rsquo;</span><span style="font: 10pt greek; text-decoration: underline">fixup:</span><span style="font: 10pt greek"> a </span><span style="font: 10pt greek; text-decoration: underline">and:</span><span style="font: 10pt greek"> b | c i t<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">↪b◦odd=main code, c◦odd &larr; bfp around consequents,<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">b◦even=consequents, c◦even &larr; jmp to end↪<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">[c &larr; Vector new: b length. t &larr; a length.<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">for⦂ i from: (b length-1 to: 1 by: ¬2) do⦂</span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">↪compute the jumps↪<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">[c◦(i+1) &larr; self encodejmp: jmpcode by: t.<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">c◦i &larr; self encodejmp: bfpcode by: ((b◦(i+1)) length+(c◦(i+1)) length).<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">t &larr; t+(b◦i) length+(b◦(i+1)) length+(c◦i) length+(c◦(i+1)) length]<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">code reset. for⦂ i to: b length do⦂</span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">↪collate all back into code↪<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">[code append: b◦i; append: c◦i]<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">code append: a]&rsquo;<br>Compiler understands: &rsquo;</span><span style="font: 10pt greek; text-decoration: underline">controlstmt</span><span style="font: 10pt greek"><br></span><span class="tab" val="24"></span><span style="font: 10pt greek">[source %"for⦂ ?[self compilefor]<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">source %"until⦂ ?[self compileuntil: true]<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">source %"while⦂ ?[self compileuntil: false]<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">!false]&rsquo;<br>Compiler understands: &rsquo;</span><span style="font: 10pt greek; text-decoration: underline">compilefactor:</span><span style="font: 10pt greek"> s [!self compilephrase: 1 from: s]&rsquo;<br>Compiler understands: &rsquo;</span><span style="font: 10pt greek; text-decoration: underline">compileterm:</span><span style="font: 10pt greek"> s [!self compilephrase: 2 from: s]&rsquo;<br>Compiler understands: &rsquo;</span><span style="font: 10pt greek; text-decoration: underline">compileexpr:</span><span style="font: 10pt greek"> s [!self compilephrase: 3 from: s]&rsquo;<br>Compiler understands: &rsquo;</span><span style="font: 10pt greek; text-decoration: underline">compilecascade:</span><span style="font: 10pt greek"> s [!self compilephrase: 4 from: s]&rsquo;<br>Compiler understands: &rsquo;</span><span style="font: 10pt greek; text-decoration: underline">compilephrase:</span><span style="font: 10pt greek"> level </span><span style="font: 10pt greek; text-decoration: underline">from:</span><span style="font: 10pt greek"> input | a b c i t stk more<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">[a &larr; Stream default.<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">[level=4? [a next&larr; cascading. level&larr;3]<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">self track⦂ (self compileprimary: input into: a level: level)?[↪no assign↪]<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">!(self compileexpr: input) + a contents].<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">stk &larr; stack. b &larr; (Vector new: 4) asStream.</span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">↪arg stack↪<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">b next&larr; a; next&larr; stackused.  a &larr; Stream default.</span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">↪operators↪<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">for⦂ i to: level do⦂<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">[more &larr; true.  while⦂ more do⦂<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">[input end?[more &larr; false] c&larr;input peek.<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">(c is: UniqueString) ≡ false?<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">[user notify: &rsquo;&rsquo;unexpected: &rsquo;&rsquo;+ c asString]<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">[i=1?[c isinfix?[more &larr; false]<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">c iskeyword?[more &larr; false]  c &larr; input next];<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">=2?[c iskeyword?[more &larr; false]<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">"( . ; ? [ ] &larr; !) has: c?[more &larr; false]<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">c &larr; input next.<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">b next&larr; self track⦂ (self compilefactor: input).<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">b next&larr; stackused];<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">=3?["(for⦂ until⦂ while⦂) has: c?[more &larr; false]<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">while⦂ [input end?[false] (c&larr;input peek) iskeyword] do⦂<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">[t &larr; [t ≡ nil?[input next] t + input next].<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">a append: [c isuneval?<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">[self remote⦂ (self compileterm: input)]<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">self compileterm: input].<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">self push]<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">t≡nil?[more &larr; false] c &larr; t unique]].<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">more≡false?[]<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">[level=3?[input %"&larr; ?</span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">↪check here for  &larr; clause↪<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">[c&larr;(c+&rsquo;&rsquo;&larr;&rsquo;&rsquo;)unique.<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">[i=2?[self exstack: b pop. a append: b pop. self push]].<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">a append: (self compileexpr: input). self push]]].<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">(b◦1) next&larr; self encodeop: c. i=3?[more &larr; false]]]<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">b◦1 &larr; (b◦1) contents.  until⦂ b empty do⦂<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">[self exstack: b pop. a append: b pop. self push]<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">stack &larr; stk. !a contents]&rsquo;<br>Compiler understands: &rsquo;</span><span style="font: 10pt greek; text-decoration: underline">compileprimary:</span><span style="font: 10pt greek"> input </span><span style="font: 10pt greek; text-decoration: underline">into:</span><span style="font: 10pt greek"> a </span><span style="font: 10pt greek; text-decoration: underline">level:</span><span style="font: 10pt greek"> n | c<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">["[ = input peek ?[c &larr; Compiler new. a append: (c compileblock: input)]<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">c &larr; input next.<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">c is: Vector?[a append: (self compileexpr: (c&larr; Stream new of: c)).<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">c end?[] user notify: &rsquo;&rsquo;extra suff in parens: &rsquo;&rsquo;+ a asString]<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">c &larr; [""=c?[self encodelit: input next] self encoderef: c]. <br></span><span class="tab" val="24"></span><span style="font: 10pt greek">[n=3?[input %"&larr; ?</span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">↪expr-level call checks for &larr; ↪<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">[c&lt;(areccode+8)?[a next&larr; smashcode; next&larr; c. !false]</span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">↪assignment↪<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">user notify: &rsquo;&rsquo;assigning into read-only field&rsquo;&rsquo;]]].<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">self exstack: 1.<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">c=supercode?[a next&larr; selfcode; next&larr; supercode] a next&larr; c]&rsquo;<br>Compiler understands: &rsquo;</span><span style="font: 10pt greek; text-decoration: underline">encoderef:</span><span style="font: 10pt greek"> a | t<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">[[trace?[user show: a asString]].<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">a is: UniqueString?<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">[t &larr; cdict lookup: a ? [!t]<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">a isinfix or: a iskeyword?<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">[user notify: &rsquo;&rsquo;missing receiver before: &rsquo;&rsquo; + a asString]<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">cdict insert: a with: (t&larr; self newref: a).  !t]<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">!self encodelit: a]&rsquo;<br>Compiler understands: &rsquo;</span><span style="font: 10pt greek; text-decoration: underline">newref:</span><span style="font: 10pt greek"> a | i<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">[for⦂ i from: environment,Undeclared  do⦂<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">[i has: a?<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">[!liticode + (self addlit: (i ref: a))]]<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">user show: a asString + &rsquo;&rsquo; is undeclared.&rsquo;&rsquo;.<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">Undeclared define: a  as: nil.<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">!liticode + (self addlit: (Undeclared ref: a))]&rsquo;<br>Compiler understands: &rsquo;</span><span style="font: 10pt greek; text-decoration: underline">encodelit:</span><span style="font: 10pt greek"> a | b i<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">[</span><span class="tab" val="24"></span><span style="font: 10pt greek">[a class≡Integer?[0≠(i&larr; "(¬1 0 1 2 10) find: a)?<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">[!constcode+i-1]<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">for⦂ i to: (32 min: literals length) do⦂<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">[literals◦i is: Integer?[literals◦i=a?[!litcode+i-1]]]];<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">≡Float?[for⦂ i to: (32 min: literals length) do⦂<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">[literals◦i is: Float?[literals◦i=a?[!litcode+i-1]]]]].<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">literals length&lt;32?[!litcode +(self addlit: a)]<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">b &larr; ObjectReference new. b value&larr; a.<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">!liticode + (self addlit: b)]&rsquo;<br>Compiler understands: &rsquo;</span><span style="font: 10pt greek; text-decoration: underline">addlit:</span><span style="font: 10pt greek"> a | b<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">[b &larr; literals length.<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">b≥48?[user notify: &rsquo;&rsquo;too many literals&rsquo;&rsquo;]<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">literals &larr; literals , a. !b]&rsquo;<br>Compiler understands: &rsquo;</span><span style="font: 10pt greek; text-decoration: underline">encodeop:</span><span style="font: 10pt greek"> a<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">[[trace?[user show: a asString]].<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">opdict has: a?[!opdict◦a]<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">opdict insert: a with: (opcode + (self addlit: a)).<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">!opdict◦a]&rsquo;<br>Compiler understands: &rsquo;</span><span style="font: 10pt greek; text-decoration: underline">remote⦂</span><span style="font: 10pt greek"> b | a t<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">[a&larr;Stream default.<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">self push. b &larr; b eval. self pop.</span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">↪</span><span style="font: italic 10pt serif">extra stack to push caller</span><span style="font: 10pt greek">↪<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">a next&larr; curcode; next&larr; self encodeop: "remoteCopy.<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">t &larr; b length+3. a next&larr; t/256+jmpcode+4; next&larr; t\256.<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">a append: b; next&larr; endcode; append: (self encodejmp: jmpcode by: 0-t).<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">!a contents]&rsquo;<br>Compiler understands: &rsquo;</span><span style="font: 10pt greek; text-decoration: underline">push</span><span style="font: 10pt greek"><br></span><span class="tab" val="24"></span><span style="font: 10pt greek">[maxstack &larr; maxstack max: (stack &larr; stack+1).<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">trace?[stack print]]&rsquo;<br>Compiler understands: &rsquo;</span><span style="font: 10pt greek; text-decoration: underline">pop</span><span style="font: 10pt greek"><br></span><span class="tab" val="24"></span><span style="font: 10pt greek">[0&gt;(stack &larr; stack-1)?[user notify: &rsquo;&rsquo;negative stack&rsquo;&rsquo;]]&rsquo;<br>Compiler understands: &rsquo;</span><span style="font: 10pt greek; text-decoration: underline">track⦂</span><span style="font: 10pt greek"> expr | a b val<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">[a&larr;maxstack.  maxstack&larr; b&larr; stack.<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">val &larr; expr eval.<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">b≠stack?[user notify: &rsquo;&rsquo;unbalanced stack&rsquo;&rsquo;]<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">stackused &larr; maxstack-stack.  maxstack &larr; a.<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">!val]&rsquo;<br>Compiler understands: &rsquo;</span><span style="font: 10pt greek; text-decoration: underline">exstack:</span><span style="font: 10pt greek"> x<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">[maxstack &larr; maxstack max: stack + x]&rsquo;<br>Compiler understands: &rsquo;</span><span style="font: 10pt greek; text-decoration: underline">encodejmp:</span><span style="font: 10pt greek"> a </span><span style="font: 10pt greek; text-decoration: underline">by:</span><span style="font: 10pt greek"> n | b<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">[1≤n and: n≤8?[b&larr;String new: 1.<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">b◦1 &larr; n+[a=bfpcode?[shortbfp] shortjmp]-1. !b]<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">[n&lt;0?[n&larr;n+1024. n&lt;0?[user notify: &rsquo;&rsquo;block too long.&rsquo;&rsquo;]]<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">a &larr; a+4. n&gt;1023?[user notify: &rsquo;&rsquo;block too long.&rsquo;&rsquo;]].<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">b &larr; String new: 2.<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">b◦1 &larr; n/256+ a.  b◦2 &larr; n\256.  !b]&rsquo;<br>Compiler understands: &rsquo;</span><span style="font: 10pt greek; text-decoration: underline">compilefor</span><span style="font: 10pt greek"> | a b<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">[a &larr; source next.<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">[cdict has: a?[cdict◦a&lt;litcode?[]<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">user show: a asString+&rsquo;&rsquo; is not local.&rsquo;&rsquo;]<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">user show: a asString+&rsquo;&rsquo; is not local.&rsquo;&rsquo;].<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">[source %"to: ?<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">[code append: (self compileterm: source). self push.<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">code next&larr; self encodeop: "oneToMeAsStream]<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">source %"from: ?<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">[code append: (self compileterm: source). self push.<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">code next&larr; self encodeop: "asStream]<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">user notify: &rsquo;&rsquo;to: or from: expected at &rsquo;&rsquo;+source peek asString].<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">code next&larr; smashcode.<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">b&larr; code loc. code next&larr; self newtemp. </span><span class="tab" val="24"></span><span style="font: 10pt greek">↪reentry point↪<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">code next&larr; self encodeop: "next; next&larr; smashcode.<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">code next&larr; self encoderef: a. self compileloop: b.<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">ntemps &larr; ntemps-1]&rsquo;<br>Compiler understands: &rsquo;compileuntil: a | b<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">[b &larr; code loc.<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">code append: (self compileterm: source). self push.<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">[a?[code next&larr; self encoderef: "false. self push.<br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">code next&larr; self encodeop: "≡. self pop]].<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">self compileloop: b]&rsquo;<br>Compiler understands: &rsquo;</span><span style="font: 10pt greek; text-decoration: underline">compileloop:</span><span style="font: 10pt greek"> b|a c<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">[self pop.<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">[source %"do⦂ ?[] <br></span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">user notify: &rsquo;&rsquo;do⦂ expected before &rsquo;&rsquo;+source peek asString].<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">c &larr; Compiler new. c compileblock: source.<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">c popopt. a &larr; c code.</span><span class="tab" val="24"></span><span class="tab" val="24"></span><span style="font: 10pt greek">↪end with pop [opt]↪<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">code append: (self encodejmp: bfpcode by: 2+a length).</span><span class="tab" val="24"></span><span style="font: 10pt greek">↪2 for jmp ¬n↪<br></span><span class="tab" val="24"></span><span style="font: 10pt greek">code append: a; append: (self encodejmp: jmpcode by: b-code loc-2)]&rsquo;<br>Compiler understands: &rsquo;</span><span style="font: 10pt greek; text-decoration: underline">code</span><span style="font: 10pt greek"> [!code contents]&rsquo;<br><br></span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: center">
<span style="font: 10pt serif"><br></span><span style="font: 10pt greek">↪</span><span style="font: bold 12pt serif">SCHEDULING</span><span style="font: 10pt greek">↪</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: left">
<span style="font: bold 12pt serif"><br>Class new title:&rsquo;PriorityScheduler&rsquo;;<br>fields: &rsquo;source</span><span class="tab" val="18"></span><span style="font: 10pt greek">↪</span><span style="font: italic 10pt serif">the source of power, ie the source from which<br></span><span class="tab" val="18"></span><span class="tab" val="18"></span><span class="tab" val="18"></span><span style="font: italic 10pt serif">this scheduler was spawned, and who therefore holds<br></span><span class="tab" val="18"></span><span class="tab" val="18"></span><span class="tab" val="18"></span><span style="font: italic 10pt serif">the suspension if it is suspended.</span><span style="font: 10pt greek">↪</span><span style="font: bold 12pt serif"><br></span><span class="tab" val="18"></span><span class="tab" val="18"></span><span style="font: bold 12pt serif">processes </span><span style="font: 10pt greek">↪</span><span style="font: italic 10pt serif">&lt;Vector of Contexts&gt; the suspended processes</span><span style="font: 10pt greek">↪</span><span style="font: bold 12pt serif"><br></span><span class="tab" val="18"></span><span class="tab" val="18"></span><span style="font: bold 12pt serif">rootprocesses </span><span style="font: 10pt greek">↪</span><span style="font: italic 10pt serif">&lt;Vector of Contexts&gt; root processes for restarting</span><span style="font: 10pt greek">↪</span><span style="font: bold 12pt serif"><br></span><span class="tab" val="18"></span><span class="tab" val="18"></span><span style="font: bold 12pt serif">enabled </span><span style="font: 10pt greek">↪</span><span style="font: italic 10pt serif">&lt;Integer&gt; bits for each level; bit0=level0=lowest prio</span><span style="font: 10pt greek">↪</span><span style="font: bold 12pt serif"><br></span><span class="tab" val="18"></span><span class="tab" val="18"></span><span style="font: bold 12pt serif">active </span><span style="font: 10pt greek">↪</span><span style="font: italic 10pt serif">&lt;Integer&gt; bits for each level; bit0=1, bit15=sign bit</span><span style="font: 10pt greek">↪</span><span style="font: bold 12pt serif"><br></span><span class="tab" val="18"></span><span class="tab" val="18"></span><span style="font: bold 12pt serif">currentlevel </span><span style="font: 10pt greek">↪</span><span style="font: italic 10pt serif">&lt;Integer&gt; this level is currently selected</span><span style="font: 10pt greek">↪</span><span style="font: bold 12pt serif">&rsquo;<br></span><span style="font: 10pt greek">↪</span><span style="font: italic 10pt serif">The underlying machine has a pointer to the top level scheduler, so that physical interrupts can also cause interrupts in Smalltalk.  This they do by calling their own copy of </span><span style="font: italic 10pt serif; text-decoration: underline">wakeup</span><span style="font: italic 10pt serif"> and </span><span style="font: italic 10pt serif; text-decoration: underline">reselect</span><span style="font: italic 10pt serif">.  This copy is also invoked (primitive 65) when </span><span style="font: italic 10pt serif; text-decoration: underline">reselect</span><span style="font: italic 10pt serif"> is sent to the top-level scheduler, since its source is the virtual machine itself.</span><span style="font: 10pt greek">↪<br>PriorityScheduler understands: &rsquo;</span><span style="font: 10pt greek; text-decoration: underline">install⦂</span><span style="font: 10pt greek"> context </span><span style="font: 10pt greek; text-decoration: underline">at:</span><span style="font: 10pt greek"> level<br></span><span class="tab" val="18"></span><span style="font: 10pt greek">[context sender &larr; nil.  rootprocesses◦level &larr; context.<br></span><span class="tab" val="18"></span><span style="font: 10pt greek">processes◦level &larr; context copy]&rsquo;<br>PriorityScheduler understands: &rsquo;</span><span style="font: 10pt greek; text-decoration: underline">enable:</span><span style="font: 10pt greek"> level<br></span><span class="tab" val="18"></span><span style="font: 10pt greek">[enabled &larr; enabled lor: biton◦level]&rsquo;<br>PriorityScheduler understands: &rsquo;</span><span style="font: 10pt greek; text-decoration: underline">disable:</span><span style="font: 10pt greek"> level<br></span><span class="tab" val="18"></span><span style="font: 10pt greek">[enabled &larr; enabled land: bitoff◦level]&rsquo;<br>PriorityScheduler understands: &rsquo;</span><span style="font: 10pt greek; text-decoration: underline">wakeup:</span><span style="font: 10pt greek"> level<br></span><span class="tab" val="18"></span><span style="font: 10pt greek">[active &larr; active lor: biton◦level.<br></span><span class="tab" val="18"></span><span style="font: 10pt greek">self reselect]&rsquo;<br>PriorityScheduler understands: &rsquo;</span><span style="font: 10pt greek; text-decoration: underline">sleep:</span><span style="font: 10pt greek"> level<br></span><span class="tab" val="18"></span><span style="font: 10pt greek">[active &larr; active land: bitoff◦level.<br></span><span class="tab" val="18"></span><span style="font: 10pt greek">self reselect]&rsquo;<br>PriorityScheduler understands: &rsquo;</span><span style="font: 10pt greek; text-decoration: underline">reset:</span><span style="font: 10pt greek"> level<br></span><span class="tab" val="18"></span><span style="font: 10pt greek">[processes◦level &larr; rootprocesses◦level copy.<br></span><span class="tab" val="18"></span><span style="font: 10pt greek">self sleep: level]&rsquo;<br>PriorityScheduler understands: &rsquo;</span><span style="font: 10pt greek; text-decoration: underline">restart:</span><span style="font: 10pt greek"> level<br></span><span class="tab" val="18"></span><span style="font: 10pt greek">[processes◦level &larr; rootprocesses◦level copy.<br></span><span class="tab" val="18"></span><span style="font: 10pt greek">self wakeup: level]&rsquo;<br>PriorityScheduler understands: &rsquo;</span><span style="font: 10pt greek; text-decoration: underline">terminate:</span><span style="font: 10pt greek"> level<br></span><span class="tab" val="18"></span><span style="font: 10pt greek">[active &larr; active land: bitoff◦level.<br></span><span class="tab" val="18"></span><span style="font: 10pt greek">processes◦level &larr; rootprocesses◦level &larr; nil.<br></span><span class="tab" val="18"></span><span style="font: 10pt greek">active &larr; active land: bitoff◦level.<br></span><span class="tab" val="18"></span><span style="font: 10pt greek">self reselect]&rsquo;<br>PriorityScheduler understands: &rsquo;</span><span style="font: 10pt greek; text-decoration: underline">reselect</span><span style="font: 10pt greek"><br></span><span class="tab" val="18"></span><span style="font: 10pt greek">[processes◦currentlevel &larr; source current.<br></span><span class="tab" val="18"></span><span style="font: 10pt greek">currentlevel &larr; (active land: enabled) hibit.<br></span><span class="tab" val="18"></span><span style="font: 10pt greek">source current &larr; processes◦currentlevel] primitive: </span><span style="font: italic 10pt serif">65</span><span style="font: 10pt greek">&rsquo;<br>PriorityScheduler understands: &rsquo;</span><span style="font: 10pt greek; text-decoration: underline">current</span><span style="font: 10pt greek"><br></span><span class="tab" val="18"></span><span style="font: 10pt greek">[!processes◦currentlevel]&rsquo;<br>PriorityScheduler understands: &rsquo;</span><span style="font: 10pt greek; text-decoration: underline">current &larr;</span><span style="font: 10pt greek"> context<br></span><span class="tab" val="18"></span><span style="font: 10pt greek">[!processes◦currentlevel &larr; context]&rsquo;<br>PriorityScheduler understands: &rsquo;</span><span style="font: 10pt greek; text-decoration: underline">critical⦂</span><span style="font: 10pt greek"> expr| t v<br></span><span class="tab" val="18"></span><span style="font: 10pt greek">[t &larr; self disable.<br></span><span class="tab" val="18"></span><span style="font: 10pt greek">v &larr; expr eval.</span><span class="tab" val="18"></span><span class="tab" val="18"></span><span class="tab" val="18"></span><span style="font: 10pt greek">↪</span><span style="font: italic 10pt serif">evaluate with no interrupts</span><span style="font: 10pt greek">↪<br></span><span class="tab" val="18"></span><span style="font: 10pt greek">enabled &larr; t. !v]&rsquo;<br>PriorityScheduler understands: &rsquo;</span><span style="font: 10pt greek; text-decoration: underline">disable</span><span style="font: 10pt greek"> | t<br></span><span class="tab" val="18"></span><span style="font: 10pt greek">[t &larr; enabled. enabled &larr; 0. !t] primitive: 66&rsquo;<br>↪remaining here:<br></span><span class="tab" val="18"></span><span style="font: 10pt greek">wakeup source on wakeup<br></span><span class="tab" val="18"></span><span style="font: 10pt greek">sleep source on sleep<br></span><span class="tab" val="18"></span><span style="font: 10pt greek">arrange to sleep or restart when a process returns<br></span><span class="tab" val="18"></span><span style="font: 10pt greek">what does an empty scheduler do↪<br></span></div>
<script>function do_tabs() { // unit = px
  var tabs = document.getElementsByClassName("tab");
  for (var i = 0; i < tabs.length; ++i) {
    var span = tabs[i];
    var val = span.getAttribute("val");
    if (val == null) console.log("Couldn't get val");
    var rect = span.getBoundingClientRect();
    var tabstop;
    if (val > 0) tabstop = Math.ceil(rect.left / val) * val;
    else tabstop = -val;
    console.log("do_tabs", val, tabstop)
    if (tabstop > 0) {
      var width = tabstop - rect.left;
      span.style.display = "inline-block";
      span.style.width = width + "px";
    }
  }
}
do_tabs();
</script>
  </body>
</html>
